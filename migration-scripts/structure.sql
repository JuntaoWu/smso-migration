SET FOREIGN_KEY_CHECKS=0;

ALTER TABLE `smso-migration-v2`.`t111` COMMENT = '\'smso.t109history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t111_backup` COMMENT = '\'smso.t109history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t112` COMMENT = '\'smso.t111history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t113` COMMENT = '\'smso.t112history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t114` COMMENT = '\'smso.t112history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t115` COMMENT = '\'smso.t114history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t116` COMMENT = '\'smso.t115history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t117` COMMENT = '\'smso.t116history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t118` COMMENT = '\'smso.t117history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t119` COMMENT = '\'smso.t118history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t120` COMMENT = '\'smso.t119history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t121` COMMENT = '\'smso.t120history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t122` COMMENT = '\'smso.t121history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t123` COMMENT = '\'smso.t122history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t124` COMMENT = '\'smso.t123history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t125` COMMENT = '\'smso.t124history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t126` COMMENT = '\'smso.t125history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t126_c` COMMENT = '\'smso.t125history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t126_updatesfz` COMMENT = '\'smso.t125history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t126_平台1535` COMMENT = '\'smso.t125history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t126_平台1541` COMMENT = '\'smso.t125history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t126_平台1544_西南石油` COMMENT = '\'smso.t125history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t126_平台1548_省医院` COMMENT = '\'smso.t125history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t126_平台1552` COMMENT = '\'smso.t125history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t126_平台1552_2` COMMENT = '\'smso.t125history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t126_平台1558` COMMENT = '\'smso.t125history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t126_平台1569` COMMENT = '\'smso.t125history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t127` COMMENT = '\'smso.t126history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t128` COMMENT = '\'smso.t127history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t129` COMMENT = '\'smso.t128history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t130` COMMENT = '\'smso.t129history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t131` COMMENT = '\'smso.t130history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t132` COMMENT = '\'smso.t131history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t133` COMMENT = '\'smso.t132history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t134` COMMENT = '\'smso.t133history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t135` COMMENT = '\'smso.t134history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t136` COMMENT = '\'smso.t135history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t137` COMMENT = '\'smso.t136history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t138` COMMENT = '\'smso.t137history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t139` COMMENT = '\'smso.t138history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t140` COMMENT = '\'smso.t139history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t141` COMMENT = '\'smso.t140history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t142` COMMENT = '\'smso.t141history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t143` COMMENT = '\'smso.t142history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t144` COMMENT = '\'smso.t143history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t145` COMMENT = '\'smso.t144history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t146` COMMENT = '\'smso.t145history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t147` COMMENT = '\'smso.t146history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t148` COMMENT = '\'smso.t147history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t149` COMMENT = '\'smso.t148history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t150` COMMENT = '\'smso.t149history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t151` COMMENT = '\'smso.t150history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t152` COMMENT = '\'smso.t151history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t153` COMMENT = '\'smso.t152history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t153_` COMMENT = '\'smso.t152history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t154` COMMENT = '\'smso.t153history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t155` COMMENT = '\'smso.t154history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t156` COMMENT = '\'smso.t155history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t157` COMMENT = '\'smso.t156history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t158` COMMENT = '\'smso.t157history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t159` COMMENT = '\'smso.t158history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t160` COMMENT = '\'smso.t159history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t161` COMMENT = '\'smso.t160history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t162` COMMENT = '\'smso.t161history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t163` COMMENT = '\'smso.t162history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t164` COMMENT = '\'smso.t163history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t165` COMMENT = '\'smso.t164history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t166` COMMENT = '\'smso.t165history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t167` COMMENT = '\'smso.t166history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t168` COMMENT = '\'smso.t167history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t169` COMMENT = '\'smso.t168history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t170` COMMENT = '\'smso.t169history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t171` COMMENT = '\'smso.t170history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t172` COMMENT = '\'smso.t171history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t173` COMMENT = '\'smso.t172history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t174` COMMENT = '\'smso.t173history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t175` COMMENT = '\'smso.t173history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t176` COMMENT = '\'smso.t173history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t177` COMMENT = '\'smso.t173history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t178` COMMENT = '\'smso.t177history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t179` COMMENT = '\'smso.t178history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t180` COMMENT = '\'smso.t179history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t181` COMMENT = '\'smso.t180history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t182` COMMENT = '\'smso.t181history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t183` COMMENT = '\'smso.t181history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t184` COMMENT = '\'smso.t181history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t185` COMMENT = '\'smso.t181history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t186` COMMENT = '\'smso.t181history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t187` COMMENT = '\'smso.t181history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t187_copy` COMMENT = '\'smso.t181history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t188` COMMENT = '\'smso.t187history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t189` COMMENT = '\'smso.t188history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`t_init_ds_result` COMMENT = '\'smso.t189history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`temp_13` COMMENT = '\'smso.t189history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`temp_13_dw` COMMENT = '\'smso.t189history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`temp_all_person` COMMENT = '\'smso.t189history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`temp_all_unit` COMMENT = '\'smso.t189history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`temp_cl_list` COMMENT = '\'smso.t189history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`temp_fund_audit` COMMENT = '\'smso.t189history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`temp_multi` COMMENT = '\'smso.t189history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`temp_nl_07` COMMENT = '\'smso.t189history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`temp_nl_12` COMMENT = '\'smso.t189history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`temp_nl_now` COMMENT = '\'smso.t189history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`temp_nl_zj` COMMENT = '\'smso.t189history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`temp_no_bd_person` COMMENT = '\'smso.t189history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`temp_person` COMMENT = '\'smso.t189history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`temp_swj_fdt` COMMENT = '\'smso.t189history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`temp_swj_fdt_result` COMMENT = '\'smso.t189history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`temp_tb_count` COMMENT = '\'smso.t189history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`temp_tb_count_ex` COMMENT = '\'smso.t189history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`temp_tb_count_lx` COMMENT = '\'smso.t189history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`temp_tb_count_normal` COMMENT = '\'smso.t189history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`temp_tb_count_ywjy` COMMENT = '\'smso.t189history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`temp_tx_13` COMMENT = '\'smso.t189history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`temp_tx_13_jsq` COMMENT = '\'smso.t189history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`temp_tx_7_12` COMMENT = '\'smso.t189history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`temp_up10` COMMENT = '\'smso.t189history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`temp_ywjy` COMMENT = '\'smso.t189history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`temp_zflxf` COMMENT = '\'smso.t189history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`test` COMMENT = '\'smso.t189history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`test1` COMMENT = '\'smso.t189history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`test11` COMMENT = '\'smso.t189history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`test2` COMMENT = '\'smso.t189history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`test3` COMMENT = '\'smso.t189history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`test4` COMMENT = '\'smso.t189history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`test_1` COMMENT = '\'smso.t189history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`test_151000000655` COMMENT = '\'smso.t189history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`test_lzg` COMMENT = '\'smso.t189history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`tfgzrylsb` COMMENT = '\'smso.t189history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`tmp_gl_record_table` COMMENT = '\'smso.t189history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`tmp_gl_table` COMMENT = '\'smso.t189history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`tmp_table` COMMENT = '\'smso.t189history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`tmptj_sydw_ry` COMMENT = '\'smso.t189history\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`workflow_data` COMMENT = '\'smso.v_t189\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`workflow_source` COMMENT = '\'smso.v_t189\' is not BASE TABLE';

ALTER TABLE `smso-migration-v2`.`xljl` COMMENT = '\'smso.v_t189\' is not BASE TABLE';

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`adjustByUnitId`(IN dwid int(11) ,in userId int(11),out resultMsg varchar(10000))
label_pro:BEGIN	


 DECLARE t_error INTEGER DEFAULT 0;
  -- 1265截断 1005创建表失败 1021硬盘剩余空间不足 1022关键字重复 1032记录不存在 1036数据表只读 
 -- 1037系统内存不足 1038用于排除的内存不足 1040数据库已达最大连接 1048字段不能为空 1054字段不存在 1065 无效的sql
 -- 1129数据库出现异常请重启数据库 1141当前用户无权访问数据库 1149sql语法错误 1062字段值重复入库失败 1169字段值重复更新失败 
 -- 1203当前用户和数据库建立的连接已达最大连接数，请增大连接或重启数据库
 -- 1205加锁超时 0147资源不足无法执行该命令 0240已取消会话
  declare continue handler for 1265,1005,1021,1022,1032,1036,1037, 1038,1040,1048,1054,1065,1129,1141,1149,1062,1169,1203,1205,0147,0240 
	set t_error=1;
 DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET t_error=1;
 -- select  '总表',14,current_timestamp(3);
delete from test1 where f2 = dwid;
delete from  adjustwage.exadjust where unitId = dwid;
delete from  adjustwage.normaladjust  where unitId = dwid;
delete from  adjustwage.adjustindex  where unitId = dwid;
delete from  adjustwage.retireadjust where unitId = dwid ;
delete from   adjustwage.ywjyadjust where unitId = dwid ;
 -- select  '总表',21,current_timestamp(3);

call adjustExByUnitId(dwid);
 if t_error = 1 then 
		delete from test1 where f2 = dwid;
		delete from  adjustwage.exadjust where unitId = dwid;
		delete from  adjustwage.normaladjust  where unitId = dwid;
		delete from  adjustwage.adjustindex  where unitId = dwid;
		delete from  adjustwage.retireadjust where unitId = dwid ;
		delete from   adjustwage.ywjyadjust where unitId = dwid ;
		set resultMsg = '设置异常人员出错';
		leave label_pro; 
 end if;
  -- select  '总表',34,current_timestamp(3);
call adjustCLByUnitId(dwid);
 if t_error = 1 then 
		delete from test1 where f2 = dwid;
		delete from  adjustwage.exadjust where unitId = dwid;
		delete from  adjustwage.normaladjust  where unitId = dwid;
		delete from  adjustwage.adjustindex  where unitId = dwid;
		delete from  adjustwage.retireadjust where unitId = dwid ;
		delete from   adjustwage.ywjyadjust where unitId = dwid ;
		set resultMsg = '设置超龄未退休人员出错';
		leave label_pro; 
 end if;
 -- select  '总表',46,current_timestamp(3);
 set @re='';
  call p_tiaobiao_ywjy(dwid,@re);

 if t_error = 1 then 
		delete from test1 where f2 = dwid;
		delete from  adjustwage.exadjust where unitId = dwid;
		delete from  adjustwage.normaladjust  where unitId = dwid;
		delete from  adjustwage.adjustindex  where unitId = dwid;
		delete from  adjustwage.retireadjust where unitId = dwid ;
		delete from   adjustwage.ywjyadjust where unitId = dwid ;
		set resultMsg = '设置义务教育人员出错';
		leave label_pro; 
 end if;
 select  '总表',60,current_timestamp(3);
call adjustNormalByUnitId(dwid);
 if t_error = 1 then 
		delete from test1 where f2 = dwid;
		delete from  adjustwage.exadjust where unitId = dwid;
		delete from  adjustwage.normaladjust  where unitId = dwid;
		delete from  adjustwage.adjustindex  where unitId = dwid;
		delete from  adjustwage.retireadjust where unitId = dwid ;
		delete from   adjustwage.ywjyadjust where unitId = dwid ;
		set resultMsg = '设置正常人员出错';
		leave label_pro; 
 end if;
call adjustFillByUnitId(dwid);
select  '总表',73,current_timestamp(3);
 if t_error = 1 then 
		delete from test1 where f2 = dwid;
		delete from  adjustwage.exadjust where unitId = dwid;
		delete from  adjustwage.normaladjust  where unitId = dwid;
		delete from  adjustwage.adjustindex  where unitId = dwid;
		delete from  adjustwage.retireadjust where unitId = dwid ;
		delete from   adjustwage.ywjyadjust where unitId = dwid ;
		set resultMsg = '设置补扣发出错';
		leave label_pro; 
 end if;
  set @re='';
 call lxSalaryAdjustBkfByUnitId(dwid,@re);
-- select  '总表',86,current_timestamp(3);
 if t_error = 1 then 
		delete from test1 where f2 = dwid;
		delete from  adjustwage.exadjust where unitId = dwid;
		delete from  adjustwage.normaladjust  where unitId = dwid;
		delete from  adjustwage.adjustindex  where unitId = dwid;
		delete from  adjustwage.retireadjust where unitId = dwid ;
		delete from   adjustwage.ywjyadjust where unitId = dwid ;
		set resultMsg = '设置离休人员出错';
		leave label_pro; 
 end if;
 -- select  '总表',97,current_timestamp(3);
		update  adjustwage.exadjust set idcard=REPLACE(idcard,'不是调出','') where unitId = dwid;
		update  adjustwage.normaladjust set idcard=REPLACE(idcard,'不是调出','')   where unitId = dwid;
		update  adjustwage.retireadjust set idcard=REPLACE(idcard,'不是调出','')  where unitId = dwid ;
		update   adjustwage.ywjyadjust set idcard=REPLACE(idcard,'不是调出','')  where unitId = dwid ;

update adjustwage.normaladjust set 
jobsalary=(case when ifnull(jobsalary,0)= 0 then  null else round(jobsalary)  end),
levelSalary=(case when ifnull(levelSalary,0)= 0 then  null else  round(levelSalary) end),
teacherNurseUp10=(case when ifnull(teacherNurseUp10,0)= 0 then  null else  round(teacherNurseUp10) end),
specialTeach=(case when ifnull(specialTeach,0)= 0 then  null  else round(specialTeach) end),
subtotal=(case when ifnull(subtotal,0)= 0 then  null  else round(subtotal) end),
jobsalaryAfter=(case when ifnull(jobsalaryAfter,0)= 0 then  null else round(jobsalaryAfter)  end),
levelSalaryAfter=(case when ifnull(levelSalaryAfter,0)= 0 then  null  else round(levelSalaryAfter) end),
teacherNurseUp10After=(case when ifnull(teacherNurseUp10After,0)= 0 then  null  else round(teacherNurseUp10After) end),
specialTeachAfter=(case when ifnull(specialTeachAfter,0)= 0 then  null  else round(specialTeachAfter) end),
subtotalAfter=(case when ifnull(subtotalAfter,0)= 0 then  null else round(subtotalAfter)  end),
fill=(case when ifnull(fill,0)= 0 then  null else  round(fill) end)
where unitId = dwid ;

update adjustwage.exadjust set 
jobsalary=(case when ifnull(jobsalary,0)= 0 then  null  else round(jobsalary) end),
levelSalary=(case when ifnull(levelSalary,0)= 0 then  null  else round(levelSalary)  end),
teacherNurseUp10=(case when ifnull(teacherNurseUp10,0)= 0 then  null  else round(teacherNurseUp10) end),
specialTeach=(case when ifnull(specialTeach,0)= 0 then  null  else round(specialTeach) end),
subtotal=(case when ifnull(subtotal,0)= 0 then  null else  round(subtotal) end)
where unitId = dwid ;



delete a from adjustwage.normaladjust a, adjustwage.normaladjust b
where a.unitid =dwid and  a.idcard = b.idcard and a.rybh!=b.rybh and ifnull(a.subtotal,0)=0 and ifnull(b.subtotal,0)!=0 ;
delete a from adjustwage.normaladjust a, adjustwage.normaladjust b
where b.unitid =dwid and  a.idcard = b.idcard and a.rybh!=b.rybh and ifnull(a.subtotal,0)=0 and ifnull(b.subtotal,0)!=0 ;

-- 删除当前单位已经减少但是在其他单位手动录入的  （这类应该放到新单位去）
-- delete a from adjustwage.normaladjust a where unitid = dwid and 
-- exists(select 1 from data_record_t126 b where c01 = concat(dwid,'') and changetype = '10831' and a.ryid =b.dataid and allAuditFlag =2)
-- and exists(select 1 from data_record_t126 b where   a.idcard =b.c07  and   changetype = '10750' and a.unitid!=b.c01 and allAuditFlag =2);

delete a from adjustwage.normaladjust a,data_record_t126 b,data_record_t126 c where a.unitid = dwid and 
b.dataid = c.dataid and b.c01 = concat(dwid,'') and b.changetype = '10831' and a.ryid =b.dataid and b.allAuditFlag =2
and b.c01!=c.c01 and a.idcard =c.c07  and   c.changetype = '10750' and a.unitid!=c.c01 and c.allAuditFlag =2 and c.id>b.id;


 select GROUP_CONCAT(rybh ) into @temp
 from ( select DISTINCT rybh from adjustwage.normaladjust where unitId =dwid  group by rybh having count(1)<6 ) aa;
  delete from adjustwage.normaladjust where 
 locate(rybh ,@temp)>0;
 
 
 delete from adjustwage.exadjust where unitid= dwid and   (rysf = '运动员' or  job like '%地勘%')  ;
 delete from adjustwage.normaladjust where unitid= dwid and  ( rysf = '运动员' or  job like '%地勘%') and ryid !=111233;
 -- select  '总表',143,current_timestamp(3);
 -- select '存在于normaladjust的人员',normaladjust.* from adjustwage.normaladjust where exists(select 1 from  adjustwage.exadjust
 -- where ryid = normaladjust.ryid);

 update adjustwage.normaladjust  set 
 jobsalary=null,
levelSalary=null,
teacherNurseUp10=null,
specialTeach=null,
subtotal=null,
jobsalaryAfter=null,
levelSalaryAfter=null,
teacherNurseUp10After=null,
specialTeachAfter=null,
subtotalAfter=null,
fill=null
where (unitId = 886 or unitId = 527) and month = 13 and rysf in ('专业技术人员','事业工人','管理人员');



 update adjustwage.exadjust  set 
 jobsalary=null,
levelSalary=null,
teacherNurseUp10=null,
specialTeach=null,
subtotal=null,
jobsalaryAfter=null,
levelSalaryAfter=null,
teacherNurseUp10After=null,
specialTeachAfter=null,
subtotalAfter=null,
fill=null
where (unitId = 886 or unitId = 527) and month = 13 and rysf in ('专业技术人员','事业工人','管理人员');





insert into adjustwage.adjustindex (unitId,unitCode,unitname,status,createTime,operator)
select t111.id,t111.c01,t111.c02,0,now() ,userId
from t111 where id = dwid and  exists(select 1 from t126 where c01 = concat(t111.id,''));

-- select  '总表',185,current_timestamp(3);



	
			
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`adjustCL`()
label_pro:BEGIN	

drop table if exists temp_cl_list; 
create table temp_cl_list as 
select t111.id 单位id,t111.c02 单位名称,t126.id 人员id, t126.c02 人员编号, t126.c04 人员姓名,
(select name from sys_s_data where id = t126.c05) 性别,(select name from sys_s_data where id = t126.c28) 人员身份,
(select c05 from t127 where id = t126.c17)  人员职级,
(select name from sys_S_data where id = t126.c03) 状态,
(select name from sys_S_data where id = t126.c40) 当前变动类型,
(select name from sys_S_data where id = t126.c46) 人员去向,
t125.c02 起薪时间,
(select (case t127.c05 
 when '一级专业技术岗位' then '正高以上'
 when '二级专业技术岗位' then '正高'
 when '三级专业技术岗位' then '正高'
 when '四级专业技术岗位' then '正高'
 when '五级专业技术岗位' then '副高'
 when '六级专业技术岗位' then '副高'
 when '七级专业技术岗位' then '副高'
 else t127.c05
end )  from t127 where id = t126.c17)  职称,
t126.c08 as 出生日期,
TIMESTAMPDIFF(YEAR,t126.c08,'2018-11-30') 11月时年龄,
0 应退休年龄
from t111, t126, t125 
where t126.c01 = concat(t111.id,'') -- 单位编号
and t125.c06 = concat(t126.id,'') -- 人员编号
and t126.c03 != '10372' -- 非离休人员
and t126.c28 != '10522' -- 非运动员
order by 职称; 


update temp_cl_list set 应退休年龄 = 60 where 人员身份 = '专业技术人员' and 性别='男';
update temp_cl_list set 应退休年龄 = 55 where 人员身份 = '专业技术人员' and 性别='女';
update temp_cl_list set 应退休年龄 = 99 where 人员身份 = '专业技术人员' and 职称 in('副高','正高','正高以上');-- 七级岗级及以上不算超龄


update temp_cl_list set 应退休年龄 = 50 where 人员身份 = '事业工人' and 性别='女';
update temp_cl_list set 应退休年龄 = 50 where 人员身份 = '机关工人' and 性别='女';

update temp_cl_list set 应退休年龄 = 60 where 人员身份 = '事业工人' and 性别='男' ;
update temp_cl_list set 应退休年龄 = 60 where 人员身份 = '机关工人' and 性别='男' ;


-- select *  from temp_cl_list where 人员身份 = '管理人员';
update temp_cl_list set 应退休年龄 = 60 where 人员身份 = '管理人员' and 性别='男';
update temp_cl_list set 应退休年龄 = 55 where 人员身份 = '管理人员' and 性别='女';

update temp_cl_list set 应退休年龄 = 60 where 人员身份 = '管理人员'   and 性别='女'
and ( 职称 like  '六级职员岗位%'
or 职称 like '五级职员岗位%'
) ;-- 女性 管理六级及以上 不超过60岁


update temp_cl_list set 应退休年龄 = 99 where 人员身份 = '管理人员'   
and ( 职称 like '四级职员岗位%'
or 职称 like '三级职员岗位%'
or 职称 like '二级职员岗位%'
or 职称 like '一级职员岗位%'
) ;-- 四级岗位及以上不限年龄

 
update temp_cl_list set 应退休年龄 = 60 where 人员身份 not in ('专业技术人员','管理人员','事业工人','机关工人','运动员') and 性别='男';
update temp_cl_list set 应退休年龄 = 55 where 人员身份 not in ('专业技术人员','管理人员','事业工人','机关工人','运动员') and 性别='女';

update  temp_cl_list set 应退休年龄 = 60 where 人员身份 not in ('专业技术人员','管理人员','事业工人','机关工人','运动员') 
and 职称 in ('二级警长','一级警长','四级高级法官','三级高级法官','二级高级法官','一级高级法官',
'四级高级检察官','三级高级检察官','二级高级检察官','一级高级检察官',
'二级法官助理','一级法官助理','高级法官助理',
'二级检察官助理','一级检察官助理','高级检察官助理',
'二级书记员','一级书记员',
'县处级副职','县处级正职','厅局级副职',
'厅局级正职','省部级副职','省部级正职',
'四级调研员','三级调研员','二级调研员','一级调研员',
'二级巡视员','一级巡视员'
)
and 性别='女';-- 女性 副处级以上、管理六级及以上、四级高级法官及以上、四级高级检察官及以上、二级警长及以上，不超过60岁

update  temp_cl_list set 应退休年龄 = 99 where 人员身份 not in ('专业技术人员','管理人员','事业工人','机关工人','运动员') 
and 职称 in ('二级高级法官','一级高级法官','高级法官助理',
'二级高级检察官','一级高级检察官','高级检察官助理',
'厅局级副职',
'厅局级正职','省部级副职','省部级正职',
'二级巡视员','一级巡视员'
);-- 副厅级以上、二级巡视员及以上、二级高级法官检察官及以上，不限制年龄



drop table if exists temp_nl_now;
create table temp_nl_now as
select *,
(select t125.c02 from data_record_t126 t126,data_record_t125 t125 
	where t126.c01 = concat(t.单位id,'') and t126.c02 = t.`人员编号` and t125.changeSign = t126.changeSign
   and t126.changeType = '10831' order by t126.c46 limit 1)  减少起薪时间,
(select t126.fund_month from data_record_t126 t126,data_record_t125 t125 
	where t126.c01 = concat(t.单位id,'') and t126.c02 = t.`人员编号` and t125.changeSign = t126.changeSign
   and t126.changeType = '10831' order by t126.c46 limit 1) 减少基金月份,
0 减少时年龄,
'2019-01-01' 到龄时间,
'2019-01-01' 应减少月份
from temp_cl_list t where `11月时年龄` >= 50 and 应退休年龄 < 99;
 
update temp_nl_now set 到龄时间 = '';
update temp_nl_now set 应减少月份 = '';

update temp_nl_now set 减少时年龄 = TIMESTAMPDIFF(year,出生日期,concat(减少起薪时间,'-01')) where 减少起薪时间 is not null;

-- select 出生日期,`11月时年龄`,`应退休年龄`,减少起薪时间,减少时年龄,DATE_ADD(出生日期,INTERVAL `应退休年龄` year) 到龄时间 from temp_nl_now where 减少起薪时间 is not null;

update temp_nl_now set 到龄时间 = DATE_ADD(出生日期,INTERVAL `应退休年龄` year) where `11月时年龄` >= 50;

update temp_nl_now set 应减少月份 = DATE_ADD(到龄时间,INTERVAL 1 month) where `11月时年龄` >= 50;

update temp_nl_now set 应减少月份 = SUBSTR(应减少月份 FROM 1 FOR 7) where `11月时年龄` >= 50;

select 出生日期,`11月时年龄`,`应退休年龄`,减少起薪时间,减少时年龄,到龄时间,应减少月份 from temp_nl_now where `11月时年龄` >= 50;

select * from temp_nl_now where `11月时年龄` >= 50;

select *,
(select t2.c02 from t111 t2,t111 t1 where t1.id = t.单位id and t1.c11 = t2.id) 主管部门
 from temp_nl_now t where 应减少月份<'2019-01'
and (应减少月份<减少起薪时间 or 当前变动类型!='人员减少')
and ifnull(减少起薪时间,'2019-01') > '2018-07' ;
-- order by 主管部门,单位id,ifnull(减少起薪时间,'2019-01');



insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,endSalaryTime,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordId)
select 单位id,人员id,人员编号,人员姓名,性别,(select c07 from t126 where id = 人员id),7,减少起薪时间,出生日期,
人员职级,
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where 人员id=concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allAuditFlag = 2  and c02<='2018-07'  ) and t126.allAuditFlag = 2)),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where 人员id=concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allAuditFlag = 2   and   c02<='2018-07'  )and t126.allAuditFlag = 2)),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where 人员id=concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allAuditFlag = 2   and   c02<='2018-07'  )and t126.allAuditFlag = 2),
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where 人员id=concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allAuditFlag = 2   and   c02<='2018-07'  )and t126.allAuditFlag = 2),
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where 人员id=concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allAuditFlag = 2   and   c02<='2018-07'  )and t126.allAuditFlag = 2)*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where 人员id=concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allAuditFlag = 2   and   c02<='2018-07'  )and t126.allAuditFlag = 2)*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0))  from data_record_t126 t126,data_record_t125 t125 
where 人员id=concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allAuditFlag = 2   and   c02<='2018-07'  )and t126.allAuditFlag = 2),
'超龄未退休人员',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where 人员id=concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allAuditFlag = 2   and   c02<='2018-07'  )and t126.allAuditFlag = 2)),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where 人员id=concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allAuditFlag = 2   and   c02<='2018-07'  )and t126.allAuditFlag = 2)

from temp_nl_now t where  应减少月份<'2019-01'
and (应减少月份<减少起薪时间 or 当前变动类型!='人员减少')
and ifnull(减少起薪时间,'2019-01') > '2018-07' ;
 
 
insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,endSalaryTime,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordId)
select 单位id,人员id,人员编号,人员姓名,性别,(select c07 from t126 where id = 人员id),8,减少起薪时间,出生日期,
人员职级,
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where 人员id=concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allAuditFlag = 2  and   c02<='2018-08'  )and t126.allAuditFlag = 2)),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where 人员id=concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allAuditFlag = 2  and   c02<='2018-08'  )and t126.allAuditFlag = 2)),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where 人员id=concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allAuditFlag = 2  and   c02<='2018-08'  )and t126.allAuditFlag = 2),
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where 人员id=concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allAuditFlag = 2  and   c02<='2018-08'  )and t126.allAuditFlag = 2),
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where 人员id=concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allAuditFlag = 2  and   c02<='2018-08'  )and t126.allAuditFlag = 2)*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where 人员id=concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allAuditFlag = 2  and   c02<='2018-08'  )and t126.allAuditFlag = 2)*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0))  from data_record_t126 t126,data_record_t125 t125 
where 人员id=concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allAuditFlag = 2  and   c02<='2018-08'  )and t126.allAuditFlag = 2),
'超龄未退休人员',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where 人员id=concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allAuditFlag = 2  and   c02<='2018-08'  )and t126.allAuditFlag = 2)),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where 人员id=concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allAuditFlag = 2  and   c02<='2018-08'  )and t126.allAuditFlag = 2)

from temp_nl_now t where  应减少月份<'2019-01'
and (应减少月份<减少起薪时间 or 当前变动类型!='人员减少')
and ifnull(减少起薪时间,'2019-01') > '2018-07' ;
 
 
insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,endSalaryTime,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordId)
select 单位id,人员id,人员编号,人员姓名,性别,(select c07 from t126 where id = 人员id),9,减少起薪时间,出生日期,
人员职级,
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where 人员id=concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allAuditFlag = 2  and   c02<='2018-09'  )and t126.allAuditFlag = 2)),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where 人员id=concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allAuditFlag = 2  and   c02<='2018-09'  )and t126.allAuditFlag = 2)),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where 人员id=concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allAuditFlag = 2  and   c02<='2018-09'  )and t126.allAuditFlag = 2),
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where 人员id=concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allAuditFlag = 2  and   c02<='2018-09'  )and t126.allAuditFlag = 2),
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where 人员id=concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allAuditFlag = 2  and   c02<='2018-09'  )and t126.allAuditFlag = 2)*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where 人员id=concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allAuditFlag = 2  and   c02<='2018-09'  )and t126.allAuditFlag = 2)*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0))  from data_record_t126 t126,data_record_t125 t125 
where 人员id=concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allAuditFlag = 2  and   c02<='2018-09'  )and t126.allAuditFlag = 2),
'超龄未退休人员',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where 人员id=concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allAuditFlag = 2  and   c02<='2018-09'  )and t126.allAuditFlag = 2)),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where 人员id=concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allAuditFlag = 2  and   c02<='2018-09'  )and t126.allAuditFlag = 2)

from temp_nl_now t where  应减少月份<'2019-01'
and (应减少月份<减少起薪时间 or 当前变动类型!='人员减少')
and ifnull(减少起薪时间,'2019-01') > '2018-07' ;


insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,endSalaryTime,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordId)
select 单位id,人员id,人员编号,人员姓名,性别,(select c07 from t126 where id = 人员id),10,减少起薪时间,出生日期,
人员职级,
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where 人员id=concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allAuditFlag = 2  and   c02<='2018-10'  )and t126.allAuditFlag = 2)),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where 人员id=concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allAuditFlag = 2  and   c02<='2018-10'  )and t126.allAuditFlag = 2)),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where 人员id=concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allAuditFlag = 2  and   c02<='2018-10'  )and t126.allAuditFlag = 2),
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where 人员id=concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allAuditFlag = 2  and   c02<='2018-10'  )and t126.allAuditFlag = 2),
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where 人员id=concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allAuditFlag = 2  and   c02<='2018-10'  )and t126.allAuditFlag = 2)*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where 人员id=concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allAuditFlag = 2  and   c02<='2018-10'  )and t126.allAuditFlag = 2)*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0))  from data_record_t126 t126,data_record_t125 t125 
where 人员id=concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allAuditFlag = 2  and   c02<='2018-10'  )and t126.allAuditFlag = 2),
'超龄未退休人员',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where 人员id=concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allAuditFlag = 2  and   c02<='2018-10'  )and t126.allAuditFlag = 2)),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where 人员id=concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allAuditFlag = 2  and   c02<='2018-10'  )and t126.allAuditFlag = 2)

from temp_nl_now t where  应减少月份<'2019-01'
and (应减少月份<减少起薪时间 or 当前变动类型!='人员减少')
and ifnull(减少起薪时间,'2019-01') > '2018-07' ;


insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,endSalaryTime,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordId)
select 单位id,人员id,人员编号,人员姓名,性别,(select c07 from t126 where id = 人员id),11,减少起薪时间,出生日期,
人员职级,
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where 人员id=concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allAuditFlag = 2  and   c02<='2018-11'  )and t126.allAuditFlag = 2)),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where 人员id=concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allAuditFlag = 2  and   c02<='2018-11'  )and t126.allAuditFlag = 2)),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where 人员id=concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allAuditFlag = 2  and   c02<='2018-11'  )and t126.allAuditFlag = 2),
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where 人员id=concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allAuditFlag = 2  and   c02<='2018-11'  )and t126.allAuditFlag = 2),
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where 人员id=concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allAuditFlag = 2  and   c02<='2018-11'  )and t126.allAuditFlag = 2)*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where 人员id=concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allAuditFlag = 2  and   c02<='2018-11'  )and t126.allAuditFlag = 2)*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0))  from data_record_t126 t126,data_record_t125 t125 
where 人员id=concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allAuditFlag = 2  and   c02<='2018-11'  )and t126.allAuditFlag = 2),
'超龄未退休人员',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where 人员id=concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allAuditFlag = 2  and   c02<='2018-11'  )and t126.allAuditFlag = 2)),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where 人员id=concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allAuditFlag = 2  and   c02<='2018-11'  )and t126.allAuditFlag = 2)

from temp_nl_now t where  应减少月份<'2019-01'
and (应减少月份<减少起薪时间 or 当前变动类型!='人员减少')
and ifnull(减少起薪时间,'2019-01') > '2018-07' ;


insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,endSalaryTime,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordId)
select 单位id,人员id,人员编号,人员姓名,性别,(select c07 from t126 where id = 人员id),12,减少起薪时间,出生日期,
人员职级,
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where 人员id=concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allAuditFlag = 2  and   c02<='2018-12'  )and t126.allAuditFlag = 2)),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where 人员id=concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allAuditFlag = 2  and   c02<='2018-12'  )and t126.allAuditFlag = 2)),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where 人员id=concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allAuditFlag = 2  and   c02<='2018-12'  )and t126.allAuditFlag = 2),
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where 人员id=concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allAuditFlag = 2  and   c02<='2018-12'  )and t126.allAuditFlag = 2),
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where 人员id=concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allAuditFlag = 2  and   c02<='2018-12'  )and t126.allAuditFlag = 2)*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where 人员id=concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allAuditFlag = 2  and   c02<='2018-12'  )and t126.allAuditFlag = 2)*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0))  from data_record_t126 t126,data_record_t125 t125 
where 人员id=concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allAuditFlag = 2  and   c02<='2018-12'  )and t126.allAuditFlag = 2),
'超龄未退休人员',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where 人员id=concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allAuditFlag = 2  and   c02<='2018-12'  )and t126.allAuditFlag = 2)),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where 人员id=concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allAuditFlag = 2  and   c02<='2018-12'  )and t126.allAuditFlag = 2)

from temp_nl_now t where  应减少月份<'2019-01'
and (应减少月份<减少起薪时间 or 当前变动类型!='人员减少')
and ifnull(减少起薪时间,'2019-01') > '2018-07' ;
 
 
 
insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,endSalaryTime,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordId)
select 单位id,人员id,人员编号,人员姓名,性别,(select c07 from t126 where id = 人员id),13,减少起薪时间,出生日期,
人员职级,
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where 人员id=concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allAuditFlag = 2  and  c02<='2018-12'  and changetype!='10831'  )  and t126.allAuditFlag = 2 )),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where 人员id=concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allAuditFlag = 2  and  c02<='2018-12'  and changetype!='10831'  )  and t126.allAuditFlag = 2 )),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where 人员id=concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allAuditFlag = 2  and  c02<='2018-12'  and changetype!='10831'  )  and t126.allAuditFlag = 2 ),
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where 人员id=concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allAuditFlag = 2  and  c02<='2018-12'  and changetype!='10831'  )  and t126.allAuditFlag = 2 ),
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where 人员id=concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allAuditFlag = 2  and  c02<='2018-12'  and changetype!='10831'  )  and t126.allAuditFlag = 2 )*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where 人员id=concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allAuditFlag = 2  and  c02<='2018-12'  and changetype!='10831'  )  and t126.allAuditFlag = 2 )*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0))  from data_record_t126 t126,data_record_t125 t125 
where 人员id=concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allAuditFlag = 2  and  c02<='2018-12'  and changetype!='10831'  )  and t126.allAuditFlag = 2 ),
'超龄未退休人员',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where 人员id=concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allAuditFlag = 2  and  c02<='2018-12'  and changetype!='10831'  )  and t126.allAuditFlag = 2 )),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where 人员id=concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allAuditFlag = 2  and  c02<='2018-12'  and changetype!='10831'  )  and t126.allAuditFlag = 2 )
from temp_nl_now t  

where  应减少月份<'2019-01'
and (应减少月份<减少起薪时间 or 当前变动类型!='人员减少')
and ifnull(减少起薪时间,'2019-01') > '2018-07'
 and exists(select 1 from t111 where id = 单位id and ((c05 in ('10295','10821') or c19='10487') and id!=1469))

and exists(select 1 from t111 where id = 单位id);



--  设置退休减少止薪时间（有停发工资的取停发工资时间）
update adjustwage.exadjust ,(
select * from (
select *,
(select t2.c02 from t111 t2,t111 t1 where t1.id = t.单位id and t1.c11 = t2.id) 主管部门
 from temp_nl_now t where 应减少月份<'2019-01'
and (应减少月份<减少起薪时间 or 当前变动类型!='人员减少')
and ifnull(减少起薪时间,'2019-01') > '2018-07' ) aa left join 
(select * from (
select * from (
select * from data_record_t125 where exists(select 1 from (
select id from t126 where exists(select 1 from  (
select 人员id
 from temp_nl_now t where 应减少月份<'2019-01'
and (应减少月份<减少起薪时间 or 当前变动类型!='人员减少')
and ifnull(减少起薪时间,'2019-01') > '2018-07' ) a where a.人员id= t126.id) and c43 = 10487
) b where id = data_record_t125.c06 ) and changetype = 10855 order by id desc 
) bb GROUP BY c06 ) cc) dd  on aa.人员id=dd.c06 where ifnull(减少起薪时间,'')!=ifnull(c02,'') and ifnull(c02,'')!='') ee
set exadjust.endsalarytime = c02 where exadjust.ryid = 人员id and exadjust.remark='超龄未退休人员';






update adjustwage.exadjust,temp_nl_now set jobsalary=0,levelsalary=0,teacherNurseUp10=0,specialTeach=0,subTotal=0
where   ryid=人员id and (substr(减少起薪时间 from 6 for 2)<=month and 减少起薪时间<='2018-12');

delete a from adjustwage.exadjust as a,adjustwage.exadjust b  where a.ryid=b.ryid 
 and a.remark ='超龄未退休人员'  and a.remark!=b.remark and b.remark='暂缓套改人员';

delete a from adjustwage.exadjust as a,adjustwage.exadjust b  where a.ryid=b.ryid and 
a.remark !='超龄未退休人员'  and a.remark!=b.remark and b.remark='超龄未退休人员';








	
			
END ;;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`adjustCLByUnitId`(IN dwid int(11))
label_pro:BEGIN	

drop table if exists temp_cl_list; 
create table temp_cl_list as 
select t111.id 单位id,t111.c02 单位名称,t126.id 人员id, t126.c02 人员编号, t126.c04 人员姓名,
(select name from sys_s_data where id = t126.c05) 性别,(select name from sys_s_data where id = t126.c28) 人员身份,
(select c05 from t127 where id = t126.c17)  人员职级,
(select name from sys_S_data where id = t126.c03) 状态,
(select name from sys_S_data where id = t126.c40) 当前变动类型,
(select name from sys_S_data where id = t126.c46) 人员去向,
t125.c02 起薪时间,
(select (case t127.c05 
 when '一级专业技术岗位' then '正高以上'
 when '二级专业技术岗位' then '正高'
 when '三级专业技术岗位' then '正高'
 when '四级专业技术岗位' then '正高'
 when '五级专业技术岗位' then '副高'
 when '六级专业技术岗位' then '副高'
 when '七级专业技术岗位' then '副高'
 else t127.c05
end )  from t127 where id = t126.c17)  职称,
t126.c08 as 出生日期,
TIMESTAMPDIFF(YEAR,t126.c08,'2018-11-30') 11月时年龄,
0 应退休年龄
from t111, t126, t125 
where  t126.c01 = concat(t111.id,'') -- 单位编号
and t126.c01 = concat(dwid,'') 
and t125.c06 = concat(t126.id,'') -- 人员编号
and t126.c03 != '10372' -- 非离休人员
and t126.c28 != '10522' -- 非运动员
order by 职称; 


update temp_cl_list set 应退休年龄 = 60 where 人员身份 = '专业技术人员' and 性别='男';
update temp_cl_list set 应退休年龄 = 55 where 人员身份 = '专业技术人员' and 性别='女';
update temp_cl_list set 应退休年龄 = 99 where 人员身份 = '专业技术人员' and 职称 in('副高','正高','正高以上');-- 七级岗级及以上不算超龄


update temp_cl_list set 应退休年龄 = 50 where 人员身份 = '事业工人' and 性别='女';
update temp_cl_list set 应退休年龄 = 50 where 人员身份 = '机关工人' and 性别='女';

update temp_cl_list set 应退休年龄 = 60 where 人员身份 = '事业工人' and 性别='男' ;
update temp_cl_list set 应退休年龄 = 60 where 人员身份 = '机关工人' and 性别='男' ;


-- select *  from temp_cl_list where 人员身份 = '管理人员';
update temp_cl_list set 应退休年龄 = 60 where 人员身份 = '管理人员' and 性别='男';
update temp_cl_list set 应退休年龄 = 55 where 人员身份 = '管理人员' and 性别='女';

update temp_cl_list set 应退休年龄 = 60 where 人员身份 = '管理人员'   and 性别='女'
and ( 职称 like  '六级职员岗位%'
or 职称 like '五级职员岗位%'
) ;-- 女性 管理六级及以上 不超过60岁


update temp_cl_list set 应退休年龄 = 99 where 人员身份 = '管理人员'   
and ( 职称 like '四级职员岗位%'
or 职称 like '三级职员岗位%'
or 职称 like '二级职员岗位%'
or 职称 like '一级职员岗位%'
) ;-- 四级岗位及以上不限年龄

 
update temp_cl_list set 应退休年龄 = 60 where 人员身份 not in ('专业技术人员','管理人员','事业工人','机关工人','运动员') and 性别='男';
update temp_cl_list set 应退休年龄 = 55 where 人员身份 not in ('专业技术人员','管理人员','事业工人','机关工人','运动员') and 性别='女';

update  temp_cl_list set 应退休年龄 = 60 where 人员身份 not in ('专业技术人员','管理人员','事业工人','机关工人','运动员') 
and 职称 in ('二级警长','一级警长','四级高级法官','三级高级法官','二级高级法官','一级高级法官',
'四级高级检察官','三级高级检察官','二级高级检察官','一级高级检察官',
'二级法官助理','一级法官助理','高级法官助理',
'二级检察官助理','一级检察官助理','高级检察官助理',
'二级书记员','一级书记员',
'县处级副职','县处级正职','厅局级副职',
'厅局级正职','省部级副职','省部级正职',
'四级调研员','三级调研员','二级调研员','一级调研员',
'二级巡视员','一级巡视员'
)
and 性别='女';-- 女性 副处级以上、管理六级及以上、四级高级法官及以上、四级高级检察官及以上、二级警长及以上，不超过60岁

update  temp_cl_list set 应退休年龄 = 99 where 人员身份 not in ('专业技术人员','管理人员','事业工人','机关工人','运动员') 
and 职称 in ('二级高级法官','一级高级法官','高级法官助理',
'二级高级检察官','一级高级检察官','高级检察官助理',
'厅局级副职',
'厅局级正职','省部级副职','省部级正职',
'二级巡视员','一级巡视员'
);-- 副厅级以上、二级巡视员及以上、二级高级法官检察官及以上，不限制年龄



drop table if exists temp_nl_now;
create table temp_nl_now as
select *,
(select t125.c02 from data_record_t126 t126,data_record_t125 t125 
	where t126.c01 = concat(t.单位id,'') and t126.c02 = t.`人员编号` and t125.changeSign = t126.changeSign
   and t126.changeType = '10831' order by t126.c46 limit 1)  减少起薪时间,
(select t126.fund_month from data_record_t126 t126,data_record_t125 t125 
	where t126.c01 = concat(t.单位id,'') and t126.c02 = t.`人员编号` and t125.changeSign = t126.changeSign
   and t126.changeType = '10831' order by t126.c46 limit 1) 减少基金月份,
0 减少时年龄,
'2019-01-01' 到龄时间,
'2019-01-01' 应减少月份
from temp_cl_list t where 单位id = dwid and  `11月时年龄` >= 50 and 应退休年龄 < 99;
 
update temp_nl_now set 到龄时间 = '';
update temp_nl_now set 应减少月份 = '';

update temp_nl_now set 减少时年龄 = TIMESTAMPDIFF(year,出生日期,concat(减少起薪时间,'-01')) where 减少起薪时间 is not null;

-- select 出生日期,`11月时年龄`,`应退休年龄`,减少起薪时间,减少时年龄,DATE_ADD(出生日期,INTERVAL `应退休年龄` year) 到龄时间 from temp_nl_now where 减少起薪时间 is not null;

update temp_nl_now set 到龄时间 = DATE_ADD(出生日期,INTERVAL `应退休年龄` year) where `11月时年龄` >= 50;

update temp_nl_now set 应减少月份 = DATE_ADD(到龄时间,INTERVAL 1 month) where `11月时年龄` >= 50;

update temp_nl_now set 应减少月份 = SUBSTR(应减少月份 FROM 1 FOR 7) where `11月时年龄` >= 50;

-- select 出生日期,`11月时年龄`,`应退休年龄`,减少起薪时间,减少时年龄,到龄时间,应减少月份 from temp_nl_now where `11月时年龄` >= 50;
-- 
-- select * from temp_nl_now where `11月时年龄` >= 50;
-- 
-- select *,
-- (select t2.c02 from t111 t2,t111 t1 where t1.id = t.单位id and t1.c11 = t2.id) 主管部门
--  from temp_nl_now t where 应减少月份<'2019-01'
-- and (应减少月份<减少起薪时间 or 当前变动类型!='人员减少')
-- and ifnull(减少起薪时间,'2019-01') > '2018-07' ;
-- order by 主管部门,单位id,ifnull(减少起薪时间,'2019-01');



insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,endSalaryTime,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordId)
select 单位id,人员id,人员编号,人员姓名,性别,(select c07 from t126 where id = 人员id),7,减少起薪时间,出生日期,
人员职级,
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where 人员id = concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allauditflag=2 and c02<='2018-07' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更
) and t126.allauditflag = 2)),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where 人员id = concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allauditflag=2 and c02<='2018-07' and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更
) and t126.allauditflag = 2)),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where 人员id = concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allauditflag=2 and c02<='2018-07' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更
) and t126.allauditflag = 2),
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where 人员id = concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allauditflag=2 and c02<='2018-07' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更
) and t126.allauditflag = 2),
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where 人员id = concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allauditflag=2 and c02<='2018-07' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更
) and t126.allauditflag = 2)*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where 人员id = concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allauditflag=2 and c02<='2018-07' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更
) and t126.allauditflag = 2)*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0))  from data_record_t126 t126,data_record_t125 t125 
where 人员id = concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allauditflag=2 and c02<='2018-07' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更
) and t126.allauditflag = 2),
'超龄未退休人员',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where 人员id = concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allauditflag=2 and c02<='2018-07' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更
) and t126.allauditflag = 2)),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where 人员id = concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allauditflag=2 and c02<='2018-07' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更
) and t126.allauditflag = 2)

from temp_nl_now t where 单位id = dwid and  应减少月份<'2019-01'
and (应减少月份<减少起薪时间 or 当前变动类型!='人员减少')
and ifnull(减少起薪时间,'2019-01') > '2018-07' ;
 
 
insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,endSalaryTime,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordId)
select 单位id,人员id,人员编号,人员姓名,性别,(select c07 from t126 where id = 人员id),8,减少起薪时间,出生日期,
人员职级,
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where 人员id = concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allauditflag=2 and c02<='2018-08' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更
) and t126.allauditflag = 2)),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where 人员id = concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allauditflag=2 and c02<='2018-08'
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
) and t126.allauditflag = 2)),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where 人员id = concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allauditflag=2 and c02<='2018-08' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2),
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where 人员id = concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allauditflag=2 and c02<='2018-08' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2),
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where 人员id = concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allauditflag=2 and c02<='2018-08' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2)*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where 人员id = concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allauditflag=2 and c02<='2018-08'  
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
) and t126.allauditflag = 2)*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0))  from data_record_t126 t126,data_record_t125 t125 
where 人员id = concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allauditflag=2 and c02<='2018-08' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2),
'超龄未退休人员',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where 人员id = concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allauditflag=2 and c02<='2018-08'  
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
) and t126.allauditflag = 2)),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where 人员id = concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allauditflag=2 and c02<='2018-08' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2)

from temp_nl_now t where 单位id = dwid and 应减少月份<'2019-01'
and (应减少月份<减少起薪时间 or 当前变动类型!='人员减少')
and ifnull(减少起薪时间,'2019-01') > '2018-07' ;
 
 
insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,endSalaryTime,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordId)
select 单位id,人员id,人员编号,人员姓名,性别,(select c07 from t126 where id = 人员id),9,减少起薪时间,出生日期,
人员职级,
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where 人员id = concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allauditflag=2 and c02<='2018-09' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2)),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where 人员id = concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allauditflag=2 and c02<='2018-09' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2)),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where 人员id = concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allauditflag=2 and c02<='2018-09' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2),
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where 人员id = concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allauditflag=2 and c02<='2018-09' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2),
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where 人员id = concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allauditflag=2 and c02<='2018-09' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2)*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where 人员id = concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allauditflag=2 and c02<='2018-09' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2)*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0))  from data_record_t126 t126,data_record_t125 t125 
where 人员id = concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allauditflag=2 and c02<='2018-09' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2),
'超龄未退休人员',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where 人员id = concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allauditflag=2 and c02<='2018-09' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2)),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where 人员id = concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allauditflag=2 and c02<='2018-09' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2)

from temp_nl_now t where 单位id = dwid and 应减少月份<'2019-01'
and (应减少月份<减少起薪时间 or 当前变动类型!='人员减少')
and ifnull(减少起薪时间,'2019-01') > '2018-07' ;


insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,endSalaryTime,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordId)
select 单位id,人员id,人员编号,人员姓名,性别,(select c07 from t126 where id = 人员id),10,减少起薪时间,出生日期,
人员职级,
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where 人员id = concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allauditflag=2 and c02<='2018-10' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2)),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where 人员id = concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allauditflag=2 and c02<='2018-10' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2)),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where 人员id = concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allauditflag=2 and c02<='2018-10' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2),
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where 人员id = concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allauditflag=2 and c02<='2018-10' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2),
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where 人员id = concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allauditflag=2 and c02<='2018-10' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2)*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where 人员id = concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allauditflag=2 and c02<='2018-10' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2)*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0))  from data_record_t126 t126,data_record_t125 t125 
where 人员id = concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allauditflag=2 and c02<='2018-10' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2),
'超龄未退休人员',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where 人员id = concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allauditflag=2 and c02<='2018-10' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2)),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where 人员id = concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allauditflag=2 and c02<='2018-10' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2)

from temp_nl_now t where 单位id = dwid and 应减少月份<'2019-01'
and (应减少月份<减少起薪时间 or 当前变动类型!='人员减少')
and ifnull(减少起薪时间,'2019-01') > '2018-07' ;


insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,endSalaryTime,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordId)
select 单位id,人员id,人员编号,人员姓名,性别,(select c07 from t126 where id = 人员id),11,减少起薪时间,出生日期,
人员职级,
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where 人员id = concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allauditflag=2 and c02<='2018-11' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2)),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where 人员id = concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allauditflag=2 and c02<='2018-11' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2)),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where 人员id = concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allauditflag=2 and c02<='2018-11' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2),
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where 人员id = concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allauditflag=2 and c02<='2018-11' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2),
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where 人员id = concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allauditflag=2 and c02<='2018-11' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2)*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where 人员id = concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allauditflag=2 and c02<='2018-11' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2)*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0))  from data_record_t126 t126,data_record_t125 t125 
where 人员id = concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allauditflag=2 and c02<='2018-11' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2),
'超龄未退休人员',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where 人员id = concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allauditflag=2 and c02<='2018-11' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2)),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where 人员id = concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allauditflag=2 and c02<='2018-11' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2)

from temp_nl_now t where 单位id = dwid and 应减少月份<'2019-01'
and (应减少月份<减少起薪时间 or 当前变动类型!='人员减少')
and ifnull(减少起薪时间,'2019-01') > '2018-07' ;


insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,endSalaryTime,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordId)
select 单位id,人员id,人员编号,人员姓名,性别,(select c07 from t126 where id = 人员id),12,减少起薪时间,出生日期,
人员职级,
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where 人员id = concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allauditflag=2 and c02<='2018-12' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2)),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where 人员id = concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allauditflag=2 and c02<='2018-12' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2)),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where 人员id = concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allauditflag=2 and c02<='2018-12' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2),
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where 人员id = concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allauditflag=2 and c02<='2018-12' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2),
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where 人员id = concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allauditflag=2 and c02<='2018-12' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2)*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where 人员id = concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allauditflag=2 and c02<='2018-12' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2)*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0))  from data_record_t126 t126,data_record_t125 t125 
where 人员id = concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allauditflag=2 and c02<='2018-12' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2),
'超龄未退休人员',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where 人员id = concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allauditflag=2 and c02<='2018-12' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2)),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where 人员id = concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allauditflag=2 and c02<='2018-12'
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
  ) and t126.allauditflag = 2)

from temp_nl_now t where 单位id = dwid and 应减少月份<'2019-01'
and (应减少月份<减少起薪时间 or 当前变动类型!='人员减少')
and ifnull(减少起薪时间,'2019-01') > '2018-07' ;
 
 
 
insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,endSalaryTime,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordId)
select 单位id,人员id,人员编号,人员姓名,性别,(select c07 from t126 where id = 人员id),13,减少起薪时间,出生日期,
人员职级,
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where 人员id = concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allauditflag=2 and c02<='2018-12'  and changetype!='10831' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 )and t126.allauditflag = 2)),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where 人员id = concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allauditflag=2 and c02<='2018-12'  and changetype!='10831' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 )and t126.allauditflag = 2)),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where 人员id = concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allauditflag=2 and c02<='2018-12'  and changetype!='10831' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 )and t126.allauditflag = 2),
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where 人员id = concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allauditflag=2 and c02<='2018-12'  and changetype!='10831' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 )and t126.allauditflag = 2),
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where 人员id = concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allauditflag=2 and c02<='2018-12'  and changetype!='10831' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 )and t126.allauditflag = 2)*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where 人员id = concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allauditflag=2 and c02<='2018-12'  and changetype!='10831' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 )and t126.allauditflag = 2)*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0))  from data_record_t126 t126,data_record_t125 t125 
where 人员id = concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allauditflag=2 and c02<='2018-12'  and changetype!='10831' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 )and t126.allauditflag = 2),
'超龄未退休人员',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where 人员id = concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allauditflag=2 and c02<='2018-12'  and changetype!='10831' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 )and t126.allauditflag = 2)),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where 人员id = concat(t126.dataid,'') and t125.c06 = concat(人员id,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(人员id,'') and allauditflag=2 and c02<='2018-12'  and changetype!='10831' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 )and t126.allauditflag = 2)
from temp_nl_now t 

where 单位id = dwid and 应减少月份<'2019-01'
and (应减少月份<减少起薪时间 or 当前变动类型!='人员减少')
and ifnull(减少起薪时间,'2019-01') > '2018-07'
 and exists(select 1 from t111 where id = 单位id and ((c05 in ('10295','10821') or c19='10487'  or id in (886,527)) and id!=1469))

and exists(select 1 from t111 where id = 单位id);



--  设置退休减少止薪时间（有停发工资的取停发工资时间）
update adjustwage.exadjust ,(
select * from (
select *,
(select t2.c02 from t111 t2,t111 t1 where t1.id = t.单位id and t1.c11 = t2.id) 主管部门
 from temp_nl_now t where 应减少月份<'2019-01'
and (应减少月份<减少起薪时间 or 当前变动类型!='人员减少')
and ifnull(减少起薪时间,'2019-01') > '2018-07' ) aa left join 
(select * from (
select * from (
select * from data_record_t125 where exists(select 1 from (
select id from t126 where exists(select 1 from  (
select 人员id
 from temp_nl_now t where 应减少月份<'2019-01'
and (应减少月份<减少起薪时间 or 当前变动类型!='人员减少')
and ifnull(减少起薪时间,'2019-01') > '2018-07' ) a where a.人员id= t126.id) and c43 = 10487
) b where id = data_record_t125.c06 ) and changetype = 10855 order by id desc 
) bb GROUP BY c06 ) cc) dd  on aa.人员id=dd.c06 where ifnull(减少起薪时间,'')!=ifnull(c02,'') and ifnull(c02,'')!='') ee
set exadjust.endsalarytime = c02 where  exadjust.unitId = dwid and   exadjust.ryid = 人员id and exadjust.remark='超龄未退休人员';



update adjustwage.exadjust,temp_nl_now set jobsalary=0,levelsalary=0,teacherNurseUp10=0,specialTeach=0,subTotal=0
where unitId=dwid and  ryid=人员id and (substr(减少起薪时间 from 6 for 2)<=month and 减少起薪时间<='2018-12');

delete a from adjustwage.exadjust as a,adjustwage.exadjust b  where a.ryid=b.ryid and a.unitId = dwid and b.unitId = dwid 
 and a.remark ='超龄未退休人员'  and a.remark!=b.remark and b.remark='暂缓套改人员';

delete a from adjustwage.exadjust as a,adjustwage.exadjust b  where a.ryid=b.ryid and a.unitId = dwid and b.unitId = dwid 
 and a.remark !='超龄未退休人员'  and a.remark!=b.remark and b.remark='超龄未退休人员';







	
			
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`adjustEx`()
label_pro:BEGIN	


truncate test1;
-- alter table test1 add column f26 varchar(255);
truncate adjustwage.exadjust;
truncate adjustwage.normaladjust;
-- f1人员id,f2单位id,f3人员编号,f4姓名,f5身份证,f6职务,f7级别,f8档次,f9职务工资,f10级别工资,f11提高10%,f12提高15%,f13小计,f14 性别，f15出生日期 f16学历 f17工资职级 f18是否领导f19身份f20工资标准类别f21变动类型f22是否停薪 
-- f24 是否计发生活费 f25是否计发病假 f26止薪时间
-- 非运动员地勘   18年最后一条变动 从当前表
-- insert into test1 (f1,f2,f3,f4,f5,f6,f7,f8,f9,f10,f11,f12,f13,f14,f15,f16,f17,f18,f19,f20,f21,f22,f23,f24,f25,f26)
-- select t126.id,t126.c01 dwbh,t126.c02 rybh,t126.c04 name ,t126.c07 idCard,(select c05 from t127 where id = t126.c17) zw,(select c05 from t127 where id = t125.c07) jb,(select c04 from t127 where id = t125.c09) dc,   t125.c25 zwSalary, if(ifnull(t125.c26,0)='' ,0,ifnull(t125.c26,0)) jbSalary,if(ifnull(t125.c28,0)='' ,0,ifnull(t125.c28,0)) up10,if(ifnull(t125.c29,0)='' ,0,ifnull(t125.c29,0)) up15,round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0),2) total,(select name from sys_s_data where id =t126.c05 ) t126c05,t126.c08,t126.c09,t126.c17,t126.c27,t126.c28,t126.c39
-- ,t126.c40,t126.c43,'t126',t125.c39,t125.c40,(case when t126.c40  in( '10831','10855') or t126.c43 = '10487'  then t125.c02  else null end ) 
-- from  t126, t125 
-- where  t125.c06 =concat(t126.id,'')   -- and t125.c02<='2018-12' 
--  and t126.c02 not in ('51031511600344','51031511600341','51031513600164',
-- '51031513600345','51031513600560','15100000070900022','15100000037700034','15100000037700035',
-- '15100000037700036','15100000037700037');
-- and t126.c28 !=10522 and not exists(select 1 from t127 where id = t126.c17 and c05 like '%地勘%');




-- 非运动员地勘   18年最后一条变动 从变动记录查
insert into test1 (f1,f2,f3,f4,f5,f6,f7,f8,f9,f10,f11,f12,f13,f14,f15,f16,f17,f18,f19,f20,f21,f22,f23,f24,f25,f26)
select * from (
select t126.dataid,t126.c01 dwbh,t126.c02 rybh,t126.c04 name ,t126.c07 idCard,(select c05 from t127 where id = t126.c17) zw,(select c05 from t127 where id = t125.c07) jb,(select c04 from t127 where id = t125.c09) dc,   t125.c25 zwSalary, if(ifnull(t125.c26,0)='' ,0,ifnull(t125.c26,0)) jbSalary,if(ifnull(t125.c28,0)='' ,0,ifnull(t125.c28,0)) up10,if(ifnull(t125.c29,0)='' ,0,ifnull(t125.c29,0)) up15,round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0),2) total,(select name from sys_s_data where id =t126.c05 ) t126c05,t126.c08,t126.c09,t126.c17,t126.c27,t126.c28,t126.c39
,t126.c40,t126.c43,'record',t125.c39 5c39,t125.c40 5c40,(case when t126.c40  in( '10831','10855') or t126.c43 = '10487'  then t125.c02  else null end ) as 5c02
from data_record_t126 t126 ,data_record_t125 t125 
where t126.changesign = t125.changesign 
-- and 
-- exists(select 1 from (select id  from t126 where not exists(select 1 from test1 where f1=concat(t126.id,'')) 
-- -- and t126.c28 !=10522 and not exists(select 1 from t127 where id = t126.c17 and c05 like '%地勘%')
-- ) b 
-- where b.id = t126.dataid )-- and t125.c02<='2018-12'
 and t126.c02 not in ('51031511600344','51031511600341','51031513600164',
'51031513600345','51031513600560','15100000070900022','15100000037700034','15100000037700035',
'15100000037700036','15100000037700037')
order by t125.id desc ) a  GROUP BY dataid ;



 -- f1人员id,f2单位id,f3人员编号,f4姓名,f5身份证,f6职务,f7级别,f8档次,f9职务工资,f10级别工资,f11提高10%,f12提高15%,f13小计,f14 性别，f15出生日期 f16学历 f17工资职级 f18是否领导f19身份f20工资制度f21变动类型f22是否停薪 f23来源
-- f24 是否计发生活费 f25是否计发病假 f26止薪时间
-- 非运动员地勘   18年最后一条变动 从当前表
insert into test1 (f1,f2,f3,f4,f5,f6,f7,f8,f9,f10,f11,f12,f13,f14,f15,f16,f17,f18,f19,f20,f21,f22,f23,f24,f25,f26)
select t126.id,t126.c01 dwbh,t126.c02 rybh,t126.c04 name ,t126.c07 idCard,(select c05 from t127 where id = t126.c17) zw,(select c05 from t127 where id = t125.c07) jb,(select c04 from t127 where id = t125.c09) dc,   t125.c25 zwSalary, if(ifnull(t125.c26,0)='' ,0,ifnull(t125.c26,0)) jbSalary,if(ifnull(t125.c28,0)='' ,0,ifnull(t125.c28,0)) up10,if(ifnull(t125.c29,0)='' ,0,ifnull(t125.c29,0)) up15,round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0),2) total,(select name from sys_s_data where id =t126.c05 ) t126c05,t126.c08,t126.c09,t126.c17,t126.c27,t126.c28,t126.c39
,t126.c40,t126.c43,'暂缓套改人员',t125.c39,t125.c40,(case when t126.c40  in( '10831','10855') or t126.c43 = '10487'  then t125.c02  else null end ) 
from  t126, t125 
where  t125.c06 =concat(t126.id,'')   and t126.c02 in ('51031511600344','51031511600341','51031513600164',
'51031513600345','51031513600560','15100000070900022','15100000037700034','15100000037700035',
'15100000037700036','15100000037700037');

-- 
-- select (select c02 from t111 where id =(select c11 from t111 where id =f2)) 主管部门,
-- (select c02 from t111 where id = f2) 单位名称,f3 人员编号,f4 人员姓名, f5 身份证 ,f6 职级,f7 级别,f8 档次
-- ,f9 职务工资,f10 级别工资 ,f11 `提高10%` ,f12 `提高15%` ,f13 基本工资小计

update test1,data_record_t125 t125 set f26 = t125.c02
where f1 = c06 
and exists(select 1 from data_record_t125 t1251 where t125.c05 = t1251.c05 and t125.c06
=t1251.c06 and t1251.changetype = '10831' and t1251.id>t125.id
)
and t125.changetype = '10855';

 update test1 ,t126 set f26=null
 where test1.f1=t126.id  and (t126.c40 not in( '10831','10855') and t126.c43!='10487');

-- f1人员id,f2单位id,f3人员编号,f4姓名,f5身份证,f6职务,f7级别,f8档次,f9职务工资,f10级别工资,f11提高10%,f12提高15%,f13小计,f14 性别，f15出生日期 f16学历 f17工资职级 f18是否领导f19身份f20工资制度f21变动类型f22是否停薪 
-- f24 是否计发生活费 f25是否计发病假

-- 停发工资 -异常人员

select (select c02 from t111 where id =(select c11 from t111 where id =f2)) 主管部门,
(select c02 from t111 where id = f2) 单位名称,f3 人员编号,f4 人员姓名, f5 身份证 ,f6 职级,f7 级别,f8 档次
,f9 职务工资,f10 级别工资 ,f11 `提高10%` ,f12 `提高15%` ,f13 基本工资小计
 from  test1 where  f13 = 0 and ifnull(f22,'') = 10487  and f21!=10831  
 and exists(select 1 from t111 where id = f2);
 
 insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,endSalaryTime,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordId)
select f2,f1,f3,f4,f14,f5,7,f26,f15,-- 工资职级,级别,档次,职务工资,级别工资,提高10%,提高15%,小计,'停发工资人员',人员身份
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07'  ) and t126.allauditflag =2 )),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07'  ) and t126.allauditflag =2 )),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07'  ) and t126.allauditflag =2 )),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07'  ) and t126.allauditflag =2 ),
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07'  ) and t126.allauditflag =2 ),
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07'  ) and t126.allauditflag =2 )*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07'  ) and t126.allauditflag =2 )*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0))  from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07'  ) and t126.allauditflag =2 ),
'停发工资人员',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07'  ) and t126.allauditflag =2 )),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07'  ) and t126.allauditflag =2 )

from test1 where  f13 = 0 and ifnull(f22,'') = 10487  and f21!=10831  
 and exists(select 1 from t111 where id = f2);
 
insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,endSalaryTime,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordId)
select f2,f1,f3,f4,f14,f5,8,f26,f15,-- 工资职级,级别,档次,职务工资,级别工资,提高10%,提高15%,小计,'停发工资人员',人员身份
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08'  ) and t126.allauditflag =2 )),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08'  ) and t126.allauditflag =2 )),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08'  ) and t126.allauditflag =2 )),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08'  ) and t126.allauditflag =2 ),
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08'  ) and t126.allauditflag =2 ),
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08'  ) and t126.allauditflag =2 )*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08'  ) and t126.allauditflag =2 )*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0)) from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08'  ) and t126.allauditflag =2 ),
'停发工资人员',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08'  ) and t126.allauditflag =2 )),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08'  ) and t126.allauditflag =2 )

from test1 where  f13 = 0 and ifnull(f22,'') = 10487  and f21!=10831  
 and exists(select 1 from t111 where id = f2);
 
 
 insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,endSalaryTime,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordId)
select f2,f1,f3,f4,f14,f5,9,f26,f15,-- 工资职级,级别,档次,职务工资,级别工资,提高10%,提高15%,小计,'停发工资人员',人员身份
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09'  ) and t126.allauditflag =2 )),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09'  ) and t126.allauditflag =2 )),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09'  ) and t126.allauditflag =2 )),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09'  ) and t126.allauditflag =2 ),
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09'  ) and t126.allauditflag =2 ),
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09'  ) and t126.allauditflag =2 )*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09'  ) and t126.allauditflag =2 )*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0)) from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09'  ) and t126.allauditflag =2 ),
'停发工资人员',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09'  ) and t126.allauditflag =2 )),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09'  ) and t126.allauditflag =2 )

from test1 where  f13 = 0 and ifnull(f22,'') = 10487  and f21!=10831  
 and exists(select 1 from t111 where id = f2);


 insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,endSalaryTime,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordId)
select f2,f1,f3,f4,f14,f5,10,f26,f15,-- 工资职级,级别,档次,职务工资,级别工资,提高10%,提高15%,小计,'停发工资人员',人员身份
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10'  ) and t126.allauditflag =2 )),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10'  ) and t126.allauditflag =2 )),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10'  ) and t126.allauditflag =2 )),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10'  ) and t126.allauditflag =2 ),
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10'  ) and t126.allauditflag =2 ),
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10'  ) and t126.allauditflag =2 )*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10'  ) and t126.allauditflag =2 )*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0)) from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10'  ) and t126.allauditflag =2 ),
'停发工资人员',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10'  ) and t126.allauditflag =2 )),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10'  ) and t126.allauditflag =2 )

from test1 where  f13 = 0 and ifnull(f22,'') = 10487  and f21!=10831  
 and exists(select 1 from t111 where id = f2);


 insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,endSalaryTime,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordId)
select f2,f1,f3,f4,f14,f5,11,f26,f15,-- 工资职级,级别,档次,职务工资,级别工资,提高10%,提高15%,小计,'停发工资人员',人员身份
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11'  ) and t126.allauditflag =2 )),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11'  ) and t126.allauditflag =2 )),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11'  ) and t126.allauditflag =2 )),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11'  ) and t126.allauditflag =2 ),
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11'  ) and t126.allauditflag =2 ),
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11'  ) and t126.allauditflag =2 )*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11'  ) and t126.allauditflag =2 )*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0)) from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11'  ) and t126.allauditflag =2 ),
'停发工资人员',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11'  ) and t126.allauditflag =2 )),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11'  ) and t126.allauditflag =2 )

from test1 where  f13 = 0 and ifnull(f22,'') = 10487  and f21!=10831  
 and exists(select 1 from t111 where id = f2);
 
 
 insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,endSalaryTime,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordId)
select f2,f1,f3,f4,f14,f5,12,f26,f15,-- 工资职级,级别,档次,职务工资,级别工资,提高10%,提高15%,小计,'停发工资人员',人员身份
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  ) and t126.allauditflag =2 )),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  ) and t126.allauditflag =2 )),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  ) and t126.allauditflag =2 )),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  ) and t126.allauditflag =2 ),
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  ) and t126.allauditflag =2 ),
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  ) and t126.allauditflag =2 )*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  ) and t126.allauditflag =2 )*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0)) from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  ) and t126.allauditflag =2 ),
'停发工资人员',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  ) and t126.allauditflag =2 )),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  ) and t126.allauditflag =2 )

from test1 where  f13 = 0 and ifnull(f22,'') = 10487  and f21!=10831  
 and exists(select 1 from t111 where id = f2);


 insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,endSalaryTime,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordId)
select f2,f1,f3,f4,f14,f5,13,f26,f15,-- 工资职级,级别,档次,职务工资,级别工资,提高10%,提高15%,小计,'停发工资人员',人员身份
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12' and changetype!='10831' ) and t126.allauditflag =2)),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  and changetype!='10831' ) and t126.allauditflag =2)),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  and changetype!='10831' ) and t126.allauditflag =2)),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  and changetype!='10831'  ) and t126.allauditflag =2),
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  and changetype!='10831'  ) and t126.allauditflag =2),
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  and changetype!='10831'  ) and t126.allauditflag =2)*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  and changetype!='10831'  ) and t126.allauditflag =2)*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0)) from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  and changetype!='10831'  ) and t126.allauditflag =2),
'停发工资人员',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  and changetype!='10831' ) and t126.allauditflag =2)),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  and changetype!='10831' ) and t126.allauditflag =2)
from test1 
--  left join t154 on   t154.c01=f2 and t154.c02 = f1
 where      f13 = 0 and ifnull(f22,'') = 10487  and f21!=10831  
 and f3 not like '%T'
--  and t154.c03 = '2018' 
 and exists(select 1 from t111 where id = f2 and ((c05 in ('10295','10821') or c19='10487') and id!=1469))

 and exists(select 1 from t111 where id = f2);


-- -----------------------暂缓套改人员
insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,endSalaryTime,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordId)
select f2,f1,f3,f4,f14,f5,7,f26,f15,-- 工资职级,级别,档次,职务工资,级别工资,提高10%,提高15%,小计,'停发工资人员',人员身份
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07'  ) and t126.allauditflag =2 )),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07'  ) and t126.allauditflag =2 )),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07'  ) and t126.allauditflag =2 )),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07'  ) and t126.allauditflag =2 ),
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07'  ) and t126.allauditflag =2 ),
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07'  ) and t126.allauditflag =2 )*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07'  ) and t126.allauditflag =2 )*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0))  from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07'  ) and t126.allauditflag =2 ),
'暂缓套改人员',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07'  ) and t126.allauditflag =2 )),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07'  ) and t126.allauditflag =2 )
from test1 where  f23 = '暂缓套改人员'
 and exists(select 1 from t111 where id = f2);
 
 insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,endSalaryTime,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordId)
select f2,f1,f3,f4,f14,f5,8,f26,f15,-- 工资职级,级别,档次,职务工资,级别工资,提高10%,提高15%,小计,'停发工资人员',人员身份
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08'  ) and t126.allauditflag =2 )),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08'  ) and t126.allauditflag =2 )),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08'  ) and t126.allauditflag =2 )),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08'  ) and t126.allauditflag =2 ),
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08'  ) and t126.allauditflag =2 ),
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08'  ) and t126.allauditflag =2 )*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08'  ) and t126.allauditflag =2 )*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0))  from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08'  ) and t126.allauditflag =2 ),
'暂缓套改人员',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08'  ) and t126.allauditflag =2 )),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08'  ) and t126.allauditflag =2 )
from test1 where  f23 = '暂缓套改人员'
 and exists(select 1 from t111 where id = f2);

 insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,endSalaryTime,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordId)
select f2,f1,f3,f4,f14,f5,9,f26,f15,-- 工资职级,级别,档次,职务工资,级别工资,提高10%,提高15%,小计,'停发工资人员',人员身份
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09'  ) and t126.allauditflag =2 )),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09'  ) and t126.allauditflag =2 )),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09'  ) and t126.allauditflag =2 )),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09'  ) and t126.allauditflag =2 ),
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09'  ) and t126.allauditflag =2 ),
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09'  ) and t126.allauditflag =2 )*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09'  ) and t126.allauditflag =2 )*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0))  from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09'  ) and t126.allauditflag =2 ),
'暂缓套改人员',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09'  ) and t126.allauditflag =2 )),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09'  ) and t126.allauditflag =2 )
from test1 where  f23 = '暂缓套改人员'
 and exists(select 1 from t111 where id = f2);
 
  insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,endSalaryTime,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordId)
select f2,f1,f3,f4,f14,f5,10,f26,f15,-- 工资职级,级别,档次,职务工资,级别工资,提高10%,提高15%,小计,'停发工资人员',人员身份
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10'  ) and t126.allauditflag =2 )),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10'  ) and t126.allauditflag =2 )),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10'  ) and t126.allauditflag =2 )),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10'  ) and t126.allauditflag =2 ),
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10'  ) and t126.allauditflag =2 ),
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10'  ) and t126.allauditflag =2 )*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10'  ) and t126.allauditflag =2 )*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0))  from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10'  ) and t126.allauditflag =2 ),
'暂缓套改人员',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10'  ) and t126.allauditflag =2 )),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10'  ) and t126.allauditflag =2 )
from test1 where  f23 = '暂缓套改人员'
 and exists(select 1 from t111 where id = f2);
 
  insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,endSalaryTime,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordId)
select f2,f1,f3,f4,f14,f5,11,f26,f15,-- 工资职级,级别,档次,职务工资,级别工资,提高10%,提高15%,小计,'停发工资人员',人员身份
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11'  ) and t126.allauditflag =2 )),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11'  ) and t126.allauditflag =2 )),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11'  ) and t126.allauditflag =2 )),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11'  ) and t126.allauditflag =2 ),
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11'  ) and t126.allauditflag =2 ),
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11'  ) and t126.allauditflag =2 )*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11'  ) and t126.allauditflag =2 )*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0))  from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11'  ) and t126.allauditflag =2 ),
'暂缓套改人员',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11'  ) and t126.allauditflag =2 )),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11'  ) and t126.allauditflag =2 )
from test1 where  f23 = '暂缓套改人员'
 and exists(select 1 from t111 where id = f2);
 
  insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,endSalaryTime,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordId)
select f2,f1,f3,f4,f14,f5,12,f26,f15,-- 工资职级,级别,档次,职务工资,级别工资,提高10%,提高15%,小计,'停发工资人员',人员身份
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  ) and t126.allauditflag =2 )),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  ) and t126.allauditflag =2 )),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  ) and t126.allauditflag =2 )),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  ) and t126.allauditflag =2 ),
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  ) and t126.allauditflag =2 ),
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  ) and t126.allauditflag =2 )*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  ) and t126.allauditflag =2 )*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0))  from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  ) and t126.allauditflag =2 ),
'暂缓套改人员',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  ) and t126.allauditflag =2 )),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  ) and t126.allauditflag =2 )
from test1 where  f23 = '暂缓套改人员'
 and exists(select 1 from t111 where id = f2);
 
  insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,endSalaryTime,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordId)
select f2,f1,f3,f4,f14,f5,13,f26,f15,-- 工资职级,级别,档次,职务工资,级别工资,提高10%,提高15%,小计,'停发工资人员',人员身份
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12' and changetype!='10831' ) and t126.allauditflag =2)),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  and changetype!='10831'  ) and t126.allauditflag =2)),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  and changetype!='10831'  ) and t126.allauditflag =2)),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  and changetype!='10831'  ) and t126.allauditflag =2),
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  and changetype!='10831'  ) and t126.allauditflag =2),
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  and changetype!='10831'  ) and t126.allauditflag =2)*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  and changetype!='10831'  ) and t126.allauditflag =2)*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0))  from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12' and changetype!='10831'   ) and t126.allauditflag =2),
'暂缓套改人员',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  and changetype!='10831'  ) and t126.allauditflag =2)),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  and changetype!='10831'  ) and t126.allauditflag =2)
from 
  test1 
 -- left join t154 on   t154.c01=f2 and t154.c02 = f1
 where  f23 = '暂缓套改人员'
 -- and t154.c03 = '2018' 
 and exists(select 1 from t111 where id = f2 and ((c05 in ('10295','10821') or c19='10487') and id!=1469))
 and exists(select 1 from t111 where id = f2);



  -- 停发工资工资不为0 -异常人员
-- select (select c02 from t111 where id =(select c11 from t111 where id =f2)) 主管部门,
-- (select c02 from t111 where id = f2) 单位名称,f3 人员编号,f4 人员姓名, f5 身份证 ,f6 职级,f7 级别,f8 档次
-- ,f9 职务工资,f10 级别工资 ,f11 `提高10%` ,f12 `提高15%` ,f13 基本工资小计 from  test1 where  f13 != 0 and ifnull(f22,'') = 10487 and f21!=10831
--  and exists(select 1 from t111 where id = f2);









-- 其他情况-- 工资为0 -异常人员
-- select (select c02 from t111 where id =(select c11 from t111 where id =f2)) 主管部门,
-- (select c02 from t111 where id = f2) 单位名称,f3 人员编号,f4 人员姓名, f5 身份证 ,f6 职级,f7 级别,f8 档次
-- ,f9 职务工资,f10 级别工资 ,f11 `提高10%` ,f12 `提高15%` ,f13 基本工资小计  from  test1 where  f13 = 0 and ifnull(f22,'') != 10487  and f21!=10831  
--  and exists(select 1 from t111 where id = f2);

-- 计发病假
-- select (select c02 from t111 where id =(select c11 from t111 where id =f2)) 主管部门,
-- (select c02 from t111 where id = f2) 单位名称,f3 人员编号,f4 人员姓名, f5 身份证 ,f6 职级,f7 级别,f8 档次
-- ,f9 职务工资,f10 级别工资 ,f11 `提高10%` ,f12 `提高15%` ,f13 基本工资小计 from  test1 where   ifnull(f25,'') = 10487  and   ifnull(f22,'') != 10487 
--  and exists(select 1 from t111 where id = f2)

-- 计发生活费 -异常人员
-- select (select c02 from t111 where id =(select c11 from t111 where id =f2)) 主管部门,
-- (select c02 from t111 where id = f2) 单位名称,f3 人员编号,f4 人员姓名, f5 身份证 ,f6 职级,f7 级别,f8 档次
-- ,f9 职务工资,f10 级别工资 ,f11 `提高10%` ,f12 `提高15%` ,f13 基本工资小计  from  test1 where  ifnull(f24,'') = 10487 and   ifnull(f22,'') != 10487 
--  and exists(select 1 from t111 where id = f2);


insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,endSalaryTime,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordid)
select f2,f1,f3,f4,f14,f5,7,f26,f15,-- 工资职级,级别,档次,职务工资,级别工资,提高10%,提高15%,小计,'人员',人员身份
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07'  ) and t126.allauditflag =2 )),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07'  ) and t126.allauditflag =2 )),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07'  ) and t126.allauditflag =2 )),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07'  ) and t126.allauditflag =2 ),
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07'  ) and t126.allauditflag =2 ),
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07'  ) and t126.allauditflag =2 )*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07'  ) and t126.allauditflag =2 )*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0)) from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07'  ) and t126.allauditflag =2 ),
'计发生活费人员',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07'  ) and t126.allauditflag =2 )),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07'  ) and t126.allauditflag =2 )
from test1 where  ifnull(f24,'') = 10487 and   ifnull(f22,'') != 10487 
 and exists(select 1 from t111 where id = f2);

insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,endSalaryTime,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordId)
select f2,f1,f3,f4,f14,f5,8,f26,f15,-- 工资职级,级别,档次,职务工资,级别工资,提高10%,提高15%,小计,'人员',人员身份
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08'  ) and t126.allauditflag =2 )),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08'  ) and t126.allauditflag =2 )),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08'  ) and t126.allauditflag =2 )),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08'  ) and t126.allauditflag =2 ),
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08'  ) and t126.allauditflag =2 ),
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08'  ) and t126.allauditflag =2 )*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08'  ) and t126.allauditflag =2 )*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0)) from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08'  ) and t126.allauditflag =2 ),
'计发生活费人员',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08'  ) and t126.allauditflag =2 )),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08'  ) and t126.allauditflag =2 )
from test1 where  ifnull(f24,'') = 10487 and   ifnull(f22,'') != 10487 
 and exists(select 1 from t111 where id = f2);
 
insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,endSalaryTime,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordId)
select f2,f1,f3,f4,f14,f5,9,f26,f15,-- 工资职级,级别,档次,职务工资,级别工资,提高10%,提高15%,小计,'人员',人员身份
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09'  ) and t126.allauditflag =2 )),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09'  ) and t126.allauditflag =2 )),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09'  ) and t126.allauditflag =2 )),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09'  ) and t126.allauditflag =2 ),
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09'  ) and t126.allauditflag =2 ),
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09'  ) and t126.allauditflag =2 )*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09'  ) and t126.allauditflag =2 )*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0)) from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09'  ) and t126.allauditflag =2 ),
'计发生活费人员',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09'  ) and t126.allauditflag =2 )),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09'  ) and t126.allauditflag =2 )
from test1 where  ifnull(f24,'') = 10487 and   ifnull(f22,'') != 10487 
 and exists(select 1 from t111 where id = f2);
 
insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,endSalaryTime,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordId)
select f2,f1,f3,f4,f14,f5,10,f26,f15,-- 工资职级,级别,档次,职务工资,级别工资,提高10%,提高15%,小计,'人员',人员身份
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10'  ) and t126.allauditflag =2 )),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10'  ) and t126.allauditflag =2 )),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10'  ) and t126.allauditflag =2 )),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10'  ) and t126.allauditflag =2 ),
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10'  ) and t126.allauditflag =2 ),
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10'  ) and t126.allauditflag =2 )*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10'  ) and t126.allauditflag =2 )*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0)) from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10'  ) and t126.allauditflag =2 ),
'计发生活费人员',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10'  ) and t126.allauditflag =2 )),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10'  ) and t126.allauditflag =2 )
from test1 where  ifnull(f24,'') = 10487 and   ifnull(f22,'') != 10487 
 and exists(select 1 from t111 where id = f2);
 
insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,endSalaryTime,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordId)
select f2,f1,f3,f4,f14,f5,11,f26,f15,-- 工资职级,级别,档次,职务工资,级别工资,提高10%,提高15%,小计,'人员',人员身份
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11'  ) and t126.allauditflag =2 )),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11'  ) and t126.allauditflag =2 )),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11'  ) and t126.allauditflag =2 )),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11'  ) and t126.allauditflag =2 ),
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11'  ) and t126.allauditflag =2 ),
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11'  ) and t126.allauditflag =2 )*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11'  ) and t126.allauditflag =2 )*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0)) from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11'  ) and t126.allauditflag =2 ),
'计发生活费人员',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11'  ) and t126.allauditflag =2 )),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11'  ) and t126.allauditflag =2 )
from test1 where  ifnull(f24,'') = 10487 and   ifnull(f22,'') != 10487 
 and exists(select 1 from t111 where id = f2);
 
insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,endSalaryTime,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordId)
select f2,f1,f3,f4,f14,f5,12,f26,f15,-- 工资职级,级别,档次,职务工资,级别工资,提高10%,提高15%,小计,'人员',人员身份
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  ) and t126.allauditflag =2 )),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  ) and t126.allauditflag =2 )),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  ) and t126.allauditflag =2 )),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  ) and t126.allauditflag =2 ),
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  ) and t126.allauditflag =2 ),
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  ) and t126.allauditflag =2 )*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  ) and t126.allauditflag =2 )*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0)) from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  ) and t126.allauditflag =2 ),
'计发生活费人员',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  ) and t126.allauditflag =2 )),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  ) and t126.allauditflag =2 )
from test1 where  ifnull(f24,'') = 10487 and   ifnull(f22,'') != 10487 
 and exists(select 1 from t111 where id = f2);
 


 insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,endSalaryTime,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordId)
select f2,f1,f3,f4,f14,f5,13,f26,f15,-- 工资职级,级别,档次,职务工资,级别工资,提高10%,提高15%,小计,'停发工资人员',人员身份
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  and changetype!='10831'  ) and t126.allauditflag =2)),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  and changetype!='10831'  ) and t126.allauditflag =2)),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  and changetype!='10831'  ) and t126.allauditflag =2)),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  and changetype!='10831'  ) and t126.allauditflag =2),
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  and changetype!='10831'  ) and t126.allauditflag =2),
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  and changetype!='10831'  ) and t126.allauditflag =2)*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  and changetype!='10831'  ) and t126.allauditflag =2)*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0)) from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  and changetype!='10831'  ) and t126.allauditflag =2),
'计发生活费人员',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  and changetype!='10831'  ) and t126.allauditflag =2)),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  and changetype!='10831'  ) and t126.allauditflag =2)
from test1 
 -- left join t154 on   t154.c01=f2 and t154.c02 = f1  
 where   ifnull(f24,'') = 10487 and   ifnull(f22,'') != 10487 
 and f3 not like '%T'
 -- and t154.c03 = '2018' 
 and exists(select 1 from t111 where id = f2 and ((c05 in ('10295','10821') or c19='10487') and id!=1469))
 and exists(select 1 from t111 where id = f2);




drop table  if exists test11;
create table test11 as 
select (select c02 from t111 where id =(select c11 from t111 where id =f2)) 主管部门,
(select c02 from t111 where id = f2) 单位名称,f3 人员编号,f4 人员姓名, f5 身份证 ,
(select name from sys_s_data where id = f16)  学历,f6 工资职级,(select c04 from t127 where id =f18) 是否领导,f7 级别,f8 档次
,f9 职务工资,bz 职务工资标准,f10 级别工资 ,jbgz 级别工资标准,
f11 `提高10%` ,f12 `提高15%` ,f13 基本工资小计 ,
f14 性别,f15 出生日期, 
 (select name from sys_s_data where id = f19) 身份,f20 工资标准类别,f21 变动类型,f22 是否停薪 ,
f24 是否计发生活费, f25 是否计发病假
,f2,f1
from (
select * from (
select round(f9/bz,2) zwbl,round(f10/jbgz,2) jbbl,
(select (select name from sys_s_data where id=c10) from t111 where id = f2 ) dwjb
,a.*
from (
select 
(case when f19 in ('10512','10515','10514','10513','11376',
							'11377','11180','10518') and f6 not like '%期%'
		/*('综合类公务员','参公人员','行政执法类公务员','专业技术公务员','司法行政人员',
							'司法辅助人员','人民警察','管理人员','员额内法官','员额内检察官')*/
			then (select c06 from t127 where c04=(select c04 from t127 where id =f18)
					and c05 = f6 and c08=f20 and c01 = '2016-07-01')
		when f19 in ('11181','11182') and f6 not like '%期%' -- '员额内法官','员额内检察官'
			then (select c06 from t127 where  c05 = f6 and c04 = f8 and c08=f20 and c01 = '2016-07-01')
			
		when  f6  like '%期%'
			then (select c06 from t127 where c04=(select name from sys_s_data where id =f16)
					and c05 = f6 and c08=f20 and c01 = '2016-07-01')
		when f19 in ('10519') and f6 not like '%期%' -- '专业技术人员'
			then (select c06 from t127 where  c05 = f6 and c08=f20 and c01 = '2016-07-01')
 		when f19 in ('10516') and f6 not like '%期%' -- '机关工人','事业工人'
			then (select c06 from t127 where  c05 = f6 and c08=f20 and c01 = '2016-07-01' and  c03 = '技术等级工资')
		when f19 in ('10520') and f6 not like '%期%' -- '机关工人','事业工人'
			then (select c06 from t127 where  c05 = f6 and c08=f20 and c01 = '2016-07-01' and c03 = '岗位工资')

 else 0 end ) bz,
(case when f19 in ('10512','10515','10514','10513','11376', 
							'11377','11180') and f6 not like '%期%'
/*'综合类公务员','参公人员','行政执法类公务员','专业技术公务员','司法行政人员',
							'司法辅助人员','人民警察'*/
			then (select c06 from t127 where c04=f8
					and c05 = f7 and c08=if(f20=10498,10497,f20) and c01 = '2016-07-01')
		when  f6  like '%期%'
			then 0
		when f19 in ('10519','10518','10520') and f6 not like '%期%' -- '专业技术人员','管理人员','事业工人'
			then (select c06 from t127 where  c04 = f8 and c08=f20 and c01 = '2016-07-01' )
		when f19 in ('10516') and f6 not like '%期%' -- '机关工人'
			then (select c06 from t127 where c05 = f6 and c04 = f8 and c08=f20 and c01 = '2016-07-01' )
	

 else 0 end ) jbgz,

test1.* from test1  ) a where (f9!=bz or f10!=jbgz) and ifnull(f22,'') != 10487 and  ifnull(f24,'') != 10487 and  ifnull(f25,'') != 10487
 and exists(select 1 from t111 where id = f2)
 ) b where (ifnull(zwbl,'')!=1 or ifnull(jbbl,'')!=1 )
 and f3 not like '%T'
 and    exists(select 1 from t126 where f1=concat(t126.id,'') and c03 != 10372) 
and if(dwjb='副地厅级' and  f6 IN('五级职员岗位','四级职员岗位') and  f9>2300,0,1)
-- select * from (
-- select 
-- (case when f19 in ('10512','10515','10514','10513','11376',
-- 							'11377','11180','10518','11181','11182') and f6 not like '%期%'
-- 		/*('综合类公务员','参公人员','行政执法类公务员','专业技术公务员','司法行政人员',
-- 							'司法辅助人员','人民警察','管理人员','员额内法官','员额内检察官')*/
-- 			then (select c06 from t127 where c04=(select c04 from t127 where id =f18)
-- 					and c05 = f6 and c08=f20 and c01 = '2016-07-01')
-- 		when  f6  like '%期%'
-- 			then (select c06 from t127 where c04=(select name from sys_s_data where id =f16)
-- 					and c05 = f6 and c08=f20 and c01 = '2016-07-01')
-- 		when f19 in ('10519') and f6 not like '%期%' -- '专业技术人员'
-- 			then (select c06 from t127 where  c05 = f6 and c08=f20 and c01 = '2016-07-01')
--  		when f19 in ('10516') and f6 not like '%期%' -- '机关工人','事业工人'
-- 			then (select c06 from t127 where  c05 = f6 and c08=f20 and c01 = '2016-07-01' and  c01 = '技术等级工资')
-- 		when f19 in ('10520') and f6 not like '%期%' -- '机关工人','事业工人'
-- 			then (select c06 from t127 where  c05 = f6 and c08=f20 and c01 = '2016-07-01' and c01 = '岗位工资')
-- 
--  else 0 end ) bz,
-- (case when f19 in ('10512','10515','10514','10513','11376', 
-- 							'11377','11180') and f6 not like '%期%'
-- /*'综合类公务员','参公人员','行政执法类公务员','专业技术公务员','司法行政人员',
-- 							'司法辅助人员','人民警察'*/
-- 			then (select c06 from t127 where c04=f8
-- 					and c05 = f7 and c08=if(f20=10498,10497,f20) and c01 = '2016-07-01')
-- 		when  f6  like '%期%'
-- 			then 0
-- 		when f19 in ('10519','10518','10520') and f6 not like '%期%' -- '专业技术人员','管理人员','事业工人'
-- 			then (select c06 from t127 where  c04 = f8 and c08=f20 and c01 = '2016-07-01' )
-- 		when f19 in ('10516') and f6 not like '%期%' -- '机关工人'
-- 			then (select c06 from t127 where c05 = f6 and c04 = f8 and c08=f20 and c01 = '2016-07-01' )
-- 		when f19 in ('11181','11182') and f6 not like '%期%' -- '员额内法官','员额内检察官'
-- 			then (select c06 from t127 where  c05 = f6 and c04 = f8 and c08=f20 and c01 = '2016-07-01')
-- 
--  else 0 end ) jbgz,
-- 
-- test1.* from test1 ) a where (f9!=bz or f10!=jbgz) and ifnull(f22,'') != 10487 and  ifnull(f24,'') != 10487 and  ifnull(f25,'') != 10487
--  and exists(select 1 from t111 where id = f2)
) b;




-- select (select c02 from t111 where id =(select c11 from t111 where id =f2)) 主管部门,
-- (select c02 from t111 where id = f2) 单位名称,f3 人员编号,f4 人员姓名, f5 身份证 ,
-- (select name from sys_s_data where id = f16)  学历,f6 工资职级,(select c04 from t127 where id =f18) 是否领导,f7 级别,f8 档次
-- ,f9 职务工资,bz 职务工资标准,f10 级别工资 ,0 级别工资标准,
-- f11 `提高10%` ,f12 `提高15%` ,f13 基本工资小计 ,
-- (select name from sys_s_data where id = f14) 性别,f15 出生日期, 
--  (select name from sys_s_data where id = f19) 身份,f20 工资标准类别,f21 变动类型,f22 是否停薪 ,
-- f24 是否计发生活费, f25 是否计发病假
-- ,f2,f1
-- from (
-- select * from (
-- select (select c06 from t127 where c04=(select c04 from t127 where id =f18)
-- and c05 = f6 and c08=f20 and c01 = '2016-07-01'
-- ) bz,
-- 
-- test1.* from test1 ) a where f9!=bz and ifnull(f22,'') != 10487 and  ifnull(f24,'') != 10487 and  ifnull(f25,'') != 10487
--  and exists(select 1 from t111 where id = f2)
-- ) b;

delete from test11 where 身份 = '机关离休干部';

update test11,t127 set `职务工资标准`= c06
where  c05=工资职级 and c04 = 档次 and c01 = '2016-07-01' and 身份 in ('员额内检察官','员额内法官');

update test11,t127 set `职务工资标准`= c06
where  c05=工资职级 and c01 = '2016-07-01' and 身份 in ('运动员') and c08 = '11340' ;

update test11,t127 set `级别工资标准`= c06
where  c05=级别 and c04 = 档次 and c01 = '2016-07-01' and 身份 in ('运动员') and c08 = '11340' ;

update test11,t127 set `级别工资标准`= c06
where  c05=级别 and c04 = 档次 and c01 = '2016-07-01' and 身份 in ('综合类公务员');

update test11,t127 set `级别工资标准`= c06
where  c04 = 档次 and c01 = '2016-07-01' and 身份 in ('管理人员') ;
-- 非副厅级单位四五级职员领导读非领导的工资
update test11,t127 set `职务工资标准`= c06
where  c05 = 工资职级 and c04 = '非领导职务' and c01 = '2016-07-01' and 身份 in ('管理人员') 
and not exists(select 1 from t111 where c02 = 单位名称 and c10=10324);

update test11,t127 set `级别工资标准`= c06
where  c05=级别 and c04 = 档次 and c01 = '2016-07-01' and 身份 in ('人民警察');



-- 工资标准不对的查询
-- select * from test11 where round(职务工资,2) - round(职务工资标准,2)!=0  and 基本工资小计!=0
-- union 
-- select * from test11 where round(级别工资,2) - round(级别工资标准,2)!=0 and 基本工资小计!=0;
-- 


insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordId)
select f2,f1,人员编号,人员姓名,性别,身份证,7 ,出生日期,-- 工资职级,级别,档次,职务工资,级别工资,提高10%,提高15%,小计,'人员',人员身份
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07'  ) and t126.allauditflag =2 )),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07'  ) and t126.allauditflag =2 )),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07'  ) and t126.allauditflag =2 )),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07'  ) and t126.allauditflag =2 ),
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07'  ) and t126.allauditflag =2 ),
ifnull((select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07'  ) and t126.allauditflag =2 )*1+0,0),
ifnull((select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07'  ) and t126.allauditflag =2 )*1+0,0),
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0)) from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07'  ) and t126.allauditflag =2 ),
'其他',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07'  ) and t126.allauditflag =2 )),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07'  ) and t126.allauditflag =2 )
from ( select * from test11 where 人员编号 not like '%T' and  round(职务工资,2) - round(职务工资标准,2)!=0  and 基本工资小计!=0
 union 
 select * from test11 where 人员编号 not like '%T' and  round(级别工资,2) - round(级别工资标准,2)!=0
 and 基本工资小计!=0 -- and 身份 not in ('员额内检察官','员额内法官')
 ) a;

insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordId)
select f2,f1,人员编号,人员姓名,性别,身份证,8 ,出生日期,-- 工资职级,级别,档次,职务工资,级别工资,提高10%,提高15%,小计,'人员',人员身份
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08'  ) and t126.allauditflag =2 )),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08'  ) and t126.allauditflag =2 )),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08'  ) and t126.allauditflag =2 )),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08'  ) and t126.allauditflag =2 )*1+0,
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08'  ) and t126.allauditflag =2 )*1+0,
ifnull((select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08'  ) and t126.allauditflag =2 )*1+0,0),
ifnull((select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08'  ) and t126.allauditflag =2 )*1+0,0),
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0)) from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08'  ) and t126.allauditflag =2 ),
'其他',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08'  ) and t126.allauditflag =2 )),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08'  ) and t126.allauditflag =2 )
from ( select * from test11 where 人员编号 not like '%T' and  round(职务工资,2) - round(职务工资标准,2)!=0  and 基本工资小计!=0
 union 
 select * from test11 where 人员编号 not like '%T' and  round(级别工资,2) - round(级别工资标准,2)!=0
 and 基本工资小计!=0 
 -- and 身份 not in ('员额内检察官','员额内法官')
 ) a;


insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordId)
select f2,f1,人员编号,人员姓名,性别,身份证,9 ,出生日期,-- 工资职级,级别,档次,职务工资,级别工资,提高10%,提高15%,小计,'人员',人员身份
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09'  ) and t126.allauditflag =2 )),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09'  ) and t126.allauditflag =2 )),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09'  ) and t126.allauditflag =2 )),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09'  ) and t126.allauditflag =2 )*1+0,
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09'  ) and t126.allauditflag =2 )*1+0,
ifnull((select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09'  ) and t126.allauditflag =2 )*1+0,0),
ifnull((select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09'  ) and t126.allauditflag =2 )*1+0,0),
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0)) from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09'  ) and t126.allauditflag =2 ),
'其他',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09'  ) and t126.allauditflag =2 )),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09'  ) and t126.allauditflag =2 )
from ( select * from test11 where 人员编号 not like '%T' and  round(职务工资,2) - round(职务工资标准,2)!=0  and 基本工资小计!=0
 union 
 select * from test11 where 人员编号 not like '%T' and  round(级别工资,2) - round(级别工资标准,2)!=0
 and 基本工资小计!=0 
 -- and 身份 not in ('员额内检察官','员额内法官')
 ) a;


insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordId)
select f2,f1,人员编号,人员姓名,性别,身份证,10 ,出生日期,-- 工资职级,级别,档次,职务工资,级别工资,提高10%,提高15%,小计,'人员',人员身份
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10'  ) and t126.allauditflag =2 )),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10'  ) and t126.allauditflag =2 )),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10'  ) and t126.allauditflag =2 )),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10'  ) and t126.allauditflag =2 )*1+0,
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10'  ) and t126.allauditflag =2 )*1+0,
ifnull((select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10'  ) and t126.allauditflag =2 )*1+0,0),
ifnull((select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10'  ) and t126.allauditflag =2 )*1+0,0),
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0)) from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10'  ) and t126.allauditflag =2 ),
'其他',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10'  ) and t126.allauditflag =2 )),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10'  ) and t126.allauditflag =2 )
from ( select * from test11 where 人员编号 not like '%T' and  round(职务工资,2) - round(职务工资标准,2)!=0  and 基本工资小计!=0
 union 
 select * from test11 where 人员编号 not like '%T' and  round(级别工资,2) - round(级别工资标准,2)!=0
 and 基本工资小计!=0 
 -- and 身份 not in ('员额内检察官','员额内法官')
 ) a;


insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordid)
select f2,f1,人员编号,人员姓名,性别,身份证,11 ,出生日期,-- 工资职级,级别,档次,职务工资,级别工资,提高10%,提高15%,小计,'人员',人员身份
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11'  ) and t126.allauditflag =2 )),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11'  ) and t126.allauditflag =2 )),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11'  ) and t126.allauditflag =2 )),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11'  ) and t126.allauditflag =2 )*1+0,
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11'  ) and t126.allauditflag =2 )*1+0,
ifnull((select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11'  ) and t126.allauditflag =2 )*1+0,0),
ifnull((select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11'  ) and t126.allauditflag =2 )*1+0,0),
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0)) from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11'  ) and t126.allauditflag =2 ),
'其他',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11'  ) and t126.allauditflag =2 )),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11'  ) and t126.allauditflag =2 )
from ( select * from test11 where 人员编号 not like '%T' and  round(职务工资,2) - round(职务工资标准,2)!=0  and 基本工资小计!=0
 union 
 select * from test11 where 人员编号 not like '%T' and  round(级别工资,2) - round(级别工资标准,2)!=0
 and 基本工资小计!=0 
 -- and 身份 not in ('员额内检察官','员额内法官')
 ) a;


insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordId)
select f2,f1,人员编号,人员姓名,性别,身份证,12 ,出生日期,-- 工资职级,级别,档次,职务工资,级别工资,提高10%,提高15%,小计,'人员',人员身份
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  ) and t126.allauditflag =2 )),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  ) and t126.allauditflag =2 )),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  ) and t126.allauditflag =2 )),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  ) and t126.allauditflag =2 )*1+0,
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  ) and t126.allauditflag =2 )*1+0,
ifnull((select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  ) and t126.allauditflag =2 )*1+0,0),
ifnull((select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and c02<='2018-12'  ))*1+0,0),
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0)) from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and c02<='2018-12'  )),
'其他',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and c02<='2018-12'  ))),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and c02<='2018-12'  ))
from ( select * from test11 where 人员编号 not like '%T' and  round(职务工资,2) - round(职务工资标准,2)!=0  and 基本工资小计!=0
 union 
 select * from test11 where 人员编号 not like '%T' and  round(级别工资,2) - round(级别工资标准,2)!=0
 and 基本工资小计!=0 
 -- and 身份 not in ('员额内检察官','员额内法官')
 ) a;


insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordId)
select f2,f1,人员编号,人员姓名,性别,身份证,13 ,出生日期,-- 工资职级,级别,档次,职务工资,级别工资,提高10%,提高15%,小计,'人员',人员身份
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allAuditFlag = 2 and c02<='2018-12' and changetype!='10831' ) and t126.allauditflag =2)),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allAuditFlag = 2  and c02<='2018-12'  and changetype!='10831' ) and t126.allauditflag =2)),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allAuditFlag = 2  and c02<='2018-12'  and changetype!='10831' ) and t126.allauditflag =2)),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allAuditFlag = 2  and c02<='2018-12'  and changetype!='10831' ) and t126.allauditflag =2)*1+0,
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allAuditFlag = 2  and c02<='2018-12' and changetype!='10831'  ) and t126.allauditflag =2)*1+0,
ifnull((select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allAuditFlag = 2  and c02<='2018-12'  and changetype!='10831' ) and t126.allauditflag =2)*1+0,0),
ifnull((select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allAuditFlag = 2  and c02<='2018-12' and changetype!='10831'  ) and t126.allauditflag =2)*1+0,0),
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0)) from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allAuditFlag = 2  and c02<='2018-12' and changetype!='10831'  ) and t126.allauditflag =2),
'其他',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allAuditFlag = 2  and c02<='2018-12'  and changetype!='10831' ) and t126.allauditflag =2)),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allAuditFlag = 2  and c02<='2018-07'  and changetype!='10831' ) and t126.allauditflag =2)
from ( select * from test11 where 人员编号 not like '%T' and  round(职务工资,2) - round(职务工资标准,2)!=0  and 基本工资小计!=0
 union 
 select * from test11 where 人员编号 not like '%T' and  round(级别工资,2) - round(级别工资标准,2)!=0
 and 基本工资小计!=0 -- and 身份 not in ('员额内检察官','员额内法官')
 ) a
 -- left join t154 on   t154.c01=f2 and t154.c02 = f1  
 where   人员编号 not like '%T'
 -- and t154.c03 = '2018' 
 and exists(select 1 from t111 where id = f2 and ((c05 in ('10295','10821') or c19='10487') and id!=1469))
 and exists(select 1 from t111 where id = f2);


	
			
END ;;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`adjustExByUnitId`(IN dwid int(11))
label_pro:BEGIN	



-- alter table test1 add column f26 varchar(255);

-- f1人员id,f2单位id,f3人员编号,f4姓名,f5身份证,f6职务,f7级别,f8档次,f9职务工资,f10级别工资,f11提高10%,f12提高15%,f13小计,f14 性别，f15出生日期 f16学历 f17工资职级 f18是否领导f19身份f20工资制度f21变动类型f22是否停薪 
-- f24 是否计发生活费 f25是否计发病假 f26止薪时间
-- 非运动员地勘   18年最后一条变动 从当前表
-- insert into test1 (f1,f2,f3,f4,f5,f6,f7,f8,f9,f10,f11,f12,f13,f14,f15,f16,f17,f18,f19,f20,f21,f22,f23,f24,f25,f26)
-- select t126.id,t126.c01 dwbh,t126.c02 rybh,t126.c04 name ,t126.c07 idCard,(select c05 from t127 where id = t126.c17) zw,(select c05 from t127 where id = t125.c07) jb,(select c04 from t127 where id = t125.c09) dc,   t125.c25 zwSalary, if(ifnull(t125.c26,0)='' ,0,ifnull(t125.c26,0)) jbSalary,if(ifnull(t125.c28,0)='' ,0,ifnull(t125.c28,0)) up10,if(ifnull(t125.c29,0)='' ,0,ifnull(t125.c29,0)) up15,round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0),2) total,(select name from sys_s_data where id =t126.c05 ) t126c05,t126.c08,t126.c09,t126.c17,t126.c27,t126.c28,t126.c39
-- ,t126.c40,t126.c43,'t126',t125.c39,t125.c40,(case when t126.c40  in( '10831','10855') or t126.c43 = '10487'  then t125.c02  else null end )
-- from  t126, t125 
-- where  t125.c06 =concat(t126.id,'') and t126.c01 = concat(dwid,'')  and t125.c02<='2018-12' 
--  and t126.c02 not in ('51031511600344','51031511600341','51031513600164',
-- '51031513600345','51031513600560','15100000070900022','15100000037700034','15100000037700035',
-- '15100000037700036','15100000037700037');

-- and t126.c28 !=10522 and not exists(select 1 from t127 where id = t126.c17 and c05 like '%地勘%');




-- 非运动员地勘   18年最后一条变动 从变动记录查
insert into test1 (f1,f2,f3,f4,f5,f6,f7,f8,f9,f10,f11,f12,f13,f14,f15,f16,f17,f18,f19,f20,f21,f22,f23,f24,f25,f26)
select * from (
select t126.dataid,(select t1266.c01 from t126 as t1266 where id = t126.dataid)  dwbh,(select t1266.c02 from t126 as t1266 where id = t126.dataid) rybh,t126.c04 name ,t126.c07 idCard,(select c05 from t127 where id = t126.c17) zw,(select c05 from t127 where id = t125.c07) jb,(select c04 from t127 where id = t125.c09) dc,   t125.c25 zwSalary, if(ifnull(t125.c26,0)='' ,0,ifnull(t125.c26,0)) jbSalary,if(ifnull(t125.c28,0)='' ,0,ifnull(t125.c28,0)) up10,if(ifnull(t125.c29,0)='' ,0,ifnull(t125.c29,0)) up15,round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0),2) total,(select name from sys_s_data where id =t126.c05 ) t126c05,t126.c08,t126.c09,t126.c17,t126.c27,t126.c28,t126.c39
,t126.c40,t126.c43,'record',t125.c39 5c39,t125.c40 5c40,(case when t126.c40  in( '10831','10855') or t126.c43 = '10487'  then t125.c02  else null end ) as 5c02
from data_record_t126 t126 ,data_record_t125 t125 
where t126.changesign = t125.changesign and   t126.c01 = concat(dwid,'') 
-- and 
-- exists(select 1 from (select id  from t126 where not exists(select 1 from test1 where f1=concat(t126.id,'')) 
-- -- and t126.c28 !=10522 and not exists(select 1 from t127 where id = t126.c17 and c05 like '%地勘%')
-- ) b 
-- where b.id = t126.dataid ) -- and t125.c02<='2018-12'  -- 在新单位补钱
-- 运动员与地勘不调标
and t126.c28 !='10522' and not exists(select 1 from t127 where id = t126.c17 and c05 like '%地勘%')

 and t126.c02 not in ('51031511600344','51031511600341','51031513600164',
'51031513600345','51031513600560','15100000070900022','15100000037700034','15100000037700035',
'15100000037700036','15100000037700037')
order by t125.id desc ) a  GROUP BY dataid ;



 -- f1人员id,f2单位id,f3人员编号,f4姓名,f5身份证,f6职务,f7级别,f8档次,f9职务工资,f10级别工资,f11提高10%,f12提高15%,f13小计,f14 性别，f15出生日期 f16学历 f17工资职级 f18是否领导f19身份f20工资制度f21变动类型f22是否停薪 f23来源
-- f24 是否计发生活费 f25是否计发病假 f26止薪时间
-- 非运动员地勘   18年最后一条变动 从当前表
insert into test1 (f1,f2,f3,f4,f5,f6,f7,f8,f9,f10,f11,f12,f13,f14,f15,f16,f17,f18,f19,f20,f21,f22,f23,f24,f25,f26)
select t126.id,t126.c01 dwbh,t126.c02 rybh,t126.c04 name ,t126.c07 idCard,(select c05 from t127 where id = t126.c17) zw,(select c05 from t127 where id = t125.c07) jb,(select c04 from t127 where id = t125.c09) dc,   t125.c25 zwSalary, if(ifnull(t125.c26,0)='' ,0,ifnull(t125.c26,0)) jbSalary,if(ifnull(t125.c28,0)='' ,0,ifnull(t125.c28,0)) up10,if(ifnull(t125.c29,0)='' ,0,ifnull(t125.c29,0)) up15,round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0),2) total,(select name from sys_s_data where id =t126.c05 ) t126c05,t126.c08,t126.c09,t126.c17,t126.c27,t126.c28,t126.c39
,t126.c40,t126.c43,'暂缓套改人员',t125.c39,t125.c40,(case when t126.c40  in( '10831','10855') or t126.c43 = '10487'  then t125.c02  else null end ) 
from  t126, t125 
where  t125.c06 =concat(t126.id,'')  and t126.c01 = concat(dwid,'')  and t126.c02 in ('51031511600344','51031511600341','51031513600164',
'51031513600345','51031513600560','15100000070900022','15100000037700034','15100000037700035',
'15100000037700036','15100000037700037');

-- 
-- select (select c02 from t111 where id =(select c11 from t111 where id =f2)) 主管部门,
-- (select c02 from t111 where id = f2) 单位名称,f3 人员编号,f4 人员姓名, f5 身份证 ,f6 职级,f7 级别,f8 档次
-- ,f9 职务工资,f10 级别工资 ,f11 `提高10%` ,f12 `提高15%` ,f13 基本工资小计

update test1,data_record_t125 t125 set f26 = t125.c02
where f1 = c06 and f2 = dwid 
and exists(select 1 from data_record_t125 t1251 where t125.c05 = t1251.c05 and t125.c06
=t1251.c06 and t1251.changetype = '10831' and t1251.id>t125.id
)
and t125.changetype = '10855';

 update test1 ,t126 set f26=null
 where f2=dwid and  test1.f1=t126.id and (ifnull(t126.c40,'') not in( '10831','10855') and ifnull(t126.c43,'')!='10487');

-- f1人员id,f2单位id,f3人员编号,f4姓名,f5身份证,f6职务,f7级别,f8档次,f9职务工资,f10级别工资,f11提高10%,f12提高15%,f13小计,f14 性别，f15出生日期 f16学历 f17工资职级 f18是否领导f19身份f20工资制度f21变动类型f22是否停薪 
-- f24 是否计发生活费 f25是否计发病假

-- 停发工资 -异常人员

-- select (select c02 from t111 where id =(select c11 from t111 where id =f2)) 主管部门,
-- (select c02 from t111 where id = f2) 单位名称,f3 人员编号,f4 人员姓名, f5 身份证 ,f6 职级,f7 级别,f8 档次
-- ,f9 职务工资,f10 级别工资 ,f11 `提高10%` ,f12 `提高15%` ,f13 基本工资小计
--  from  test1 where  f13 = 0 and ifnull(f22,'') = 10487  and f21!=10831  
--  and exists(select 1 from t111 where id = f2);

 
 insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,endSalaryTime,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordId)
select f2,f1,f3,f4,f14,f5,7,f26,f15,-- 工资职级,级别,档次,职务工资,级别工资,提高10%,提高15%,小计,'停发工资人员',人员身份
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 ),
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 ),
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0))  from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 ),
'停发工资人员',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )

from test1 where  f2= concat(dwid,'') and   f13 = 0 and ifnull(f22,'') = 10487  and f21!=10831  
 and exists(select 1 from t111 where id = f2);
 
insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,endSalaryTime,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordId)
select f2,f1,f3,f4,f14,f5,8,f26,f15,-- 工资职级,级别,档次,职务工资,级别工资,提高10%,提高15%,小计,'停发工资人员',人员身份
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 ),
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 ),
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0)) from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 ),
'停发工资人员',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )

from test1 where  f2= concat(dwid,'') and  f13 = 0 and ifnull(f22,'') = 10487  and f21!=10831  
 and exists(select 1 from t111 where id = f2);
 
 
 insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,endSalaryTime,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordId)
select f2,f1,f3,f4,f14,f5,9,f26,f15,-- 工资职级,级别,档次,职务工资,级别工资,提高10%,提高15%,小计,'停发工资人员',人员身份
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 ),
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 ),
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0)) from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 ),
'停发工资人员',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )

from test1 where  f2= concat(dwid,'') and  f13 = 0 and ifnull(f22,'') = 10487  and f21!=10831  
 and exists(select 1 from t111 where id = f2);


 insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,endSalaryTime,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordId)
select f2,f1,f3,f4,f14,f5,10,f26,f15,-- 工资职级,级别,档次,职务工资,级别工资,提高10%,提高15%,小计,'停发工资人员',人员身份
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10'  
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
) and t126.allauditflag = 2 ),
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 ),
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0)) from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 ),
'停发工资人员',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10'
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
  ) and t126.allauditflag = 2 )

from test1 where  f2= concat(dwid,'') and  f13 = 0 and ifnull(f22,'') = 10487  and f21!=10831  
 and exists(select 1 from t111 where id = f2);


 insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,endSalaryTime,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordId)
select f2,f1,f3,f4,f14,f5,11,f26,f15,-- 工资职级,级别,档次,职务工资,级别工资,提高10%,提高15%,小计,'停发工资人员',人员身份
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 ),
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 ),
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0)) from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 ),
'停发工资人员',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )

from test1 where  f2= concat(dwid,'') and  f13 = 0 and ifnull(f22,'') = 10487  and f21!=10831  
 and exists(select 1 from t111 where id = f2);
 
 
 insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,endSalaryTime,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordId)
select f2,f1,f3,f4,f14,f5,12,f26,f15,-- 工资职级,级别,档次,职务工资,级别工资,提高10%,提高15%,小计,'停发工资人员',人员身份
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
  ) and t126.allauditflag = 2 )),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 ),
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 ),
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0)) from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
  ) and t126.allauditflag = 2 ),
'停发工资人员',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )

from test1 where  f2= concat(dwid,'') and  f13 = 0 and ifnull(f22,'') = 10487  and f21!=10831  
 and exists(select 1 from t111 where id = f2);


 insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,endSalaryTime,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordId)
select f2,f1,f3,f4,f14,f5,13,f26,f15,-- 工资职级,级别,档次,职务工资,级别工资,提高10%,提高15%,小计,'停发工资人员',人员身份
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12' and changetype!='10831'
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  and changetype!='10831'
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  and changetype!='10831'
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  and changetype!='10831' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 ),
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  and changetype!='10831' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 ),
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  and changetype!='10831' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  and changetype!='10831' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0)) from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  and changetype!='10831' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 ),
'停发工资人员',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  and changetype!='10831'
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  and changetype!='10831' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
) and t126.allauditflag = 2 )
from test1 
 -- left join t154 on   t154.c01=f2 and t154.c02 = f1 
 where   f2= concat(dwid,'') and    f13 = 0 and ifnull(f22,'') = 10487  and f21!=10831  
 and f3 not like '%T'
 -- and t154.c03 = '2018' 
 and exists(select 1 from t111 where id = f2 and ((c05 in ('10295','10821') or c19='10487' or id in (886,527)) and id!=1469))

 and exists(select 1 from t111 where id = f2);


-- -----------------------暂缓套改人员
insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,endSalaryTime,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordId)
select f2,f1,f3,f4,f14,f5,7,f26,f15,-- 工资职级,级别,档次,职务工资,级别工资,提高10%,提高15%,小计,'停发工资人员',人员身份
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 ),
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 ),
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0))  from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 ),
'暂缓套改人员',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )
from test1 where  f2= concat(dwid,'') and   f23 = '暂缓套改人员'
 and exists(select 1 from t111 where id = f2);
 
 insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,endSalaryTime,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordId)
select f2,f1,f3,f4,f14,f5,8,f26,f15,-- 工资职级,级别,档次,职务工资,级别工资,提高10%,提高15%,小计,'停发工资人员',人员身份
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08'  
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
) and t126.allauditflag = 2 )),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08'
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
  ) and t126.allauditflag = 2 ),
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 ),
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0))  from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 ),
'暂缓套改人员',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08'  
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
) and t126.allauditflag = 2 )
from test1 where  f2= concat(dwid,'') and  f23 = '暂缓套改人员'
 and exists(select 1 from t111 where id = f2);

 insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,endSalaryTime,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordId)
select f2,f1,f3,f4,f14,f5,9,f26,f15,-- 工资职级,级别,档次,职务工资,级别工资,提高10%,提高15%,小计,'停发工资人员',人员身份
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09'
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 ),
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 ),
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0))  from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 ),
'暂缓套改人员',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )
from test1 where  f2= concat(dwid,'') and  f23 = '暂缓套改人员'
 and exists(select 1 from t111 where id = f2);
 
  insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,endSalaryTime,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordId)
select f2,f1,f3,f4,f14,f5,10,f26,f15,-- 工资职级,级别,档次,职务工资,级别工资,提高10%,提高15%,小计,'停发工资人员',人员身份
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10'  
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
) and t126.allauditflag = 2 )),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 ),
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 ),
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0))  from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 ),
'暂缓套改人员',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )
from test1 where  f2= concat(dwid,'') and  f23 = '暂缓套改人员'
 and exists(select 1 from t111 where id = f2);
 
  insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,endSalaryTime,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordId)
select f2,f1,f3,f4,f14,f5,11,f26,f15,-- 工资职级,级别,档次,职务工资,级别工资,提高10%,提高15%,小计,'停发工资人员',人员身份
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 ),
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 ),
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0))  from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 ),
'暂缓套改人员',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )
from test1 where  f2= concat(dwid,'') and  f23 = '暂缓套改人员'
 and exists(select 1 from t111 where id = f2);
 
  insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,endSalaryTime,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordId)
select f2,f1,f3,f4,f14,f5,12,f26,f15,-- 工资职级,级别,档次,职务工资,级别工资,提高10%,提高15%,小计,'停发工资人员',人员身份
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 ),
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 ),
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0))  from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 ),
'暂缓套改人员',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )
from test1 where  f2= concat(dwid,'') and  f23 = '暂缓套改人员'
 and exists(select 1 from t111 where id = f2);
 
  insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,endSalaryTime,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordId)
select f2,f1,f3,f4,f14,f5,13,f26,f15,-- 工资职级,级别,档次,职务工资,级别工资,提高10%,提高15%,小计,'停发工资人员',人员身份
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12' and changetype!='10831'
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  and changetype!='10831' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  and changetype!='10831' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  and changetype!='10831' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 ),
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  and changetype!='10831' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 ),
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  and changetype!='10831' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  and changetype!='10831' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0))  from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12' and changetype!='10831'  
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 ),
'暂缓套改人员',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  and changetype!='10831' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  and changetype!='10831' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )
from 
  test1 
 -- left join t154 on   t154.c01=f2 and t154.c02 = f1 
 where  f2= concat(dwid,'') and  f23 = '暂缓套改人员'
 -- and t154.c03 = '2018' 
 and exists(select 1 from t111 where id = f2 and ((c05 in ('10295','10821') or c19='10487'  or id in (886,527)) and id!=1469))
 and exists(select 1 from t111 where id = f2);



  -- 停发工资工资不为0 -异常人员
-- select (select c02 from t111 where id =(select c11 from t111 where id =f2)) 主管部门,
-- (select c02 from t111 where id = f2) 单位名称,f3 人员编号,f4 人员姓名, f5 身份证 ,f6 职级,f7 级别,f8 档次
-- ,f9 职务工资,f10 级别工资 ,f11 `提高10%` ,f12 `提高15%` ,f13 基本工资小计 from  test1 where  f13 != 0 and ifnull(f22,'') = 10487 and f21!=10831
--  and exists(select 1 from t111 where id = f2);









-- 其他情况-- 工资为0 -异常人员
-- select (select c02 from t111 where id =(select c11 from t111 where id =f2)) 主管部门,
-- (select c02 from t111 where id = f2) 单位名称,f3 人员编号,f4 人员姓名, f5 身份证 ,f6 职级,f7 级别,f8 档次
-- ,f9 职务工资,f10 级别工资 ,f11 `提高10%` ,f12 `提高15%` ,f13 基本工资小计  from  test1 where  f13 = 0 and ifnull(f22,'') != 10487  and f21!=10831  
--  and exists(select 1 from t111 where id = f2);

-- 计发病假
-- select (select c02 from t111 where id =(select c11 from t111 where id =f2)) 主管部门,
-- (select c02 from t111 where id = f2) 单位名称,f3 人员编号,f4 人员姓名, f5 身份证 ,f6 职级,f7 级别,f8 档次
-- ,f9 职务工资,f10 级别工资 ,f11 `提高10%` ,f12 `提高15%` ,f13 基本工资小计 from  test1 where   ifnull(f25,'') = 10487  and   ifnull(f22,'') != 10487 
--  and exists(select 1 from t111 where id = f2)

-- 计发生活费 -异常人员
-- select (select c02 from t111 where id =(select c11 from t111 where id =f2)) 主管部门,
-- (select c02 from t111 where id = f2) 单位名称,f3 人员编号,f4 人员姓名, f5 身份证 ,f6 职级,f7 级别,f8 档次
-- ,f9 职务工资,f10 级别工资 ,f11 `提高10%` ,f12 `提高15%` ,f13 基本工资小计  from  test1 where  ifnull(f24,'') = 10487 and   ifnull(f22,'') != 10487 
--  and exists(select 1 from t111 where id = f2);


insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,endSalaryTime,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordid)
select f2,f1,f3,f4,f14,f5,7,f26,f15,-- 工资职级,级别,档次,职务工资,级别工资,提高10%,提高15%,小计,'人员',人员身份
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 ),
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 ),
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0)) from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 ),
'计发生活费人员',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )
from test1 where  f2= concat(dwid,'') and  ifnull(f24,'') = 10487 and   ifnull(f22,'') != 10487 
 and exists(select 1 from t111 where id = f2);

insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,endSalaryTime,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordId)
select f2,f1,f3,f4,f14,f5,8,f26,f15,-- 工资职级,级别,档次,职务工资,级别工资,提高10%,提高15%,小计,'人员',人员身份
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08'  
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
) and t126.allauditflag = 2 )),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 ),
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 ),
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0)) from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 ),
'计发生活费人员',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )
from test1 where  f2= concat(dwid,'') and  ifnull(f24,'') = 10487 and   ifnull(f22,'') != 10487 
 and exists(select 1 from t111 where id = f2);
 
insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,endSalaryTime,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordId)
select f2,f1,f3,f4,f14,f5,9,f26,f15,-- 工资职级,级别,档次,职务工资,级别工资,提高10%,提高15%,小计,'人员',人员身份
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 ),
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09'
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
  ) and t126.allauditflag = 2 ),
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0)) from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 ),
'计发生活费人员',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )
from test1 where  f2= concat(dwid,'') and  ifnull(f24,'') = 10487 and   ifnull(f22,'') != 10487 
 and exists(select 1 from t111 where id = f2);
 
insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,endSalaryTime,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordId)
select f2,f1,f3,f4,f14,f5,10,f26,f15,-- 工资职级,级别,档次,职务工资,级别工资,提高10%,提高15%,小计,'人员',人员身份
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10'
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
  ) and t126.allauditflag = 2 ),
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 ),
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0)) from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 ),
'计发生活费人员',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )
from test1 where  f2= concat(dwid,'') and  ifnull(f24,'') = 10487 and   ifnull(f22,'') != 10487 
 and exists(select 1 from t111 where id = f2);
 
insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,endSalaryTime,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordId)
select f2,f1,f3,f4,f14,f5,11,f26,f15,-- 工资职级,级别,档次,职务工资,级别工资,提高10%,提高15%,小计,'人员',人员身份
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 ),
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 ),
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0)) from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11'
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
  ) and t126.allauditflag = 2 ),
'计发生活费人员',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )
from test1 where  f2= concat(dwid,'') and  ifnull(f24,'') = 10487 and   ifnull(f22,'') != 10487 
 and exists(select 1 from t111 where id = f2);
 
insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,endSalaryTime,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordId)
select f2,f1,f3,f4,f14,f5,12,f26,f15,-- 工资职级,级别,档次,职务工资,级别工资,提高10%,提高15%,小计,'人员',人员身份
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 ),
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 ),
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0)) from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
  ) and t126.allauditflag = 2 ),
'计发生活费人员',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )
from test1 where  f2= concat(dwid,'') and  ifnull(f24,'') = 10487 and   ifnull(f22,'') != 10487 
 and exists(select 1 from t111 where id = f2);
 


 insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,endSalaryTime,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordId)
select f2,f1,f3,f4,f14,f5,13,f26,f15,-- 工资职级,级别,档次,职务工资,级别工资,提高10%,提高15%,小计,'停发工资人员',人员身份
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  and changetype!='10831'
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
  ) and t126.allauditflag = 2 )),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  and changetype!='10831'
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
  ) and t126.allauditflag = 2 )),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  and changetype!='10831' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  and changetype!='10831' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 ),
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  and changetype!='10831' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 ),
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  and changetype!='10831' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  and changetype!='10831' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0)) from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  and changetype!='10831' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 ),
'计发生活费人员',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  and changetype!='10831' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12'  and changetype!='10831' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )
from test1 
 -- left join t154 on   t154.c01=f2 and t154.c02 = f1  
 where  f2= concat(dwid,'') and   ifnull(f24,'') = 10487 and   ifnull(f22,'') != 10487 
 and f3 not like '%T'
-- and t154.c03 = '2018' 
 and exists(select 1 from t111 where id = f2 and ((c05 in ('10295','10821') or c19='10487'  or id in (886,527)) and id!=1469))
 and exists(select 1 from t111 where id = f2);




drop table  if exists test11;
create table test11 as 
select (select c02 from t111 where id =(select c11 from t111 where id =f2)) 主管部门,
(select c02 from t111 where id = f2) 单位名称,f3 人员编号,f4 人员姓名, f5 身份证 ,
(select name from sys_s_data where id = f16)  学历,f6 工资职级,(select c04 from t127 where id =f18) 是否领导,f7 级别,f8 档次
,f9 职务工资,bz 职务工资标准,f10 级别工资 ,jbgz 级别工资标准,
f11 `提高10%` ,f12 `提高15%` ,f13 基本工资小计 ,
f14 性别,f15 出生日期, 
 (select name from sys_s_data where id = f19) 身份,f20 工资标准类别,f21 变动类型,f22 是否停薪 ,
f24 是否计发生活费, f25 是否计发病假
,f2,f1
from (
select * from (
select round(f9/bz,2) zwbl,round(f10/jbgz,2) jbbl,
(select (select name from sys_s_data where id=c10) from t111 where id = f2 ) dwjb
,a.*
from (
select 
(case when f19 in ('10512','10515','10514','10513','11376',
							'11377','11180','10518') and f6 not like '%期%'
		/*('综合类公务员','参公人员','行政执法类公务员','专业技术公务员','司法行政人员',
							'司法辅助人员','人民警察','管理人员','员额内法官','员额内检察官')*/
			then (select c06 from t127 where c04=(select c04 from t127 where id =f18)
					and c05 = f6 and c08=f20 and c01 = '2016-07-01')
		when f19 in ('11181','11182') and f6 not like '%期%' -- '员额内法官','员额内检察官'
			then (select c06 from t127 where  c05 = f6 and c04 = f8 and c08=f20 and c01 = '2016-07-01')
			
		when  f6  like '%期%'
			then (select c06 from t127 where c04=(select name from sys_s_data where id =f16)
					and c05 = f6 and c08=f20 and c01 = '2016-07-01')
		when f19 in ('10519') and f6 not like '%期%' -- '专业技术人员'
			then (select c06 from t127 where  c05 = f6 and c08=f20 and c01 = '2016-07-01')
 		when f19 in ('10516') and f6 not like '%期%' -- '机关工人','事业工人'
			then (select c06 from t127 where  c05 = f6 and c08=f20 and c01 = '2016-07-01' and  c03 = '技术等级工资')
		when f19 in ('10520') and f6 not like '%期%' -- '机关工人','事业工人'
			then (select c06 from t127 where  c05 = f6 and c08=f20 and c01 = '2016-07-01' and c03 = '岗位工资')

 else 0 end ) bz,
(case when f19 in ('10512','10515','10514','10513','11376', 
							'11377','11180') and f6 not like '%期%'
/*'综合类公务员','参公人员','行政执法类公务员','专业技术公务员','司法行政人员',
							'司法辅助人员','人民警察'*/
			then (select c06 from t127 where c04=f8
					and c05 = f7 and c08=if(f20=10498,10497,f20) and c01 = '2016-07-01')
		when  f6  like '%期%'
			then 0
		when f19 in ('10519','10518','10520') and f6 not like '%期%' -- '专业技术人员','管理人员','事业工人'
			then (select c06 from t127 where  c04 = f8 and c08=f20 and c01 = '2016-07-01' )
		when f19 in ('10516') and f6 not like '%期%' -- '机关工人'
			then (select c06 from t127 where c05 = f6 and c04 = f8 and c08=f20 and c01 = '2016-07-01' )
	

 else 0 end ) jbgz,

test1.* from test1 where f2= concat(dwid,'')   ) a where (f9!=bz or f10!=jbgz) and ifnull(f22,'') != 10487 and  ifnull(f24,'') != 10487 and  ifnull(f25,'') != 10487
 and exists(select 1 from t111 where id = f2)
 ) b where (ifnull(zwbl,'')!=1 or ifnull(jbbl,'')!=1 )
 and f3 not like '%T'
 and    exists(select 1 from t126 where f1=concat(t126.id,'') and c03 != 10372) 
and if(dwjb='副地厅级' and  f6 IN('五级职员岗位','四级职员岗位') and  f9>2300,0,1)
-- select * from (
-- select 
-- (case when f19 in ('10512','10515','10514','10513','11376',
-- 							'11377','11180','10518','11181','11182') and f6 not like '%期%'
-- 		/*('综合类公务员','参公人员','行政执法类公务员','专业技术公务员','司法行政人员',
-- 							'司法辅助人员','人民警察','管理人员','员额内法官','员额内检察官')*/
-- 			then (select c06 from t127 where c04=(select c04 from t127 where id =f18)
-- 					and c05 = f6 and c08=f20 and c01 = '2016-07-01')
-- 		when  f6  like '%期%'
-- 			then (select c06 from t127 where c04=(select name from sys_s_data where id =f16)
-- 					and c05 = f6 and c08=f20 and c01 = '2016-07-01')
-- 		when f19 in ('10519') and f6 not like '%期%' -- '专业技术人员'
-- 			then (select c06 from t127 where  c05 = f6 and c08=f20 and c01 = '2016-07-01')
--  		when f19 in ('10516') and f6 not like '%期%' -- '机关工人','事业工人'
-- 			then (select c06 from t127 where  c05 = f6 and c08=f20 and c01 = '2016-07-01' and  c01 = '技术等级工资')
-- 		when f19 in ('10520') and f6 not like '%期%' -- '机关工人','事业工人'
-- 			then (select c06 from t127 where  c05 = f6 and c08=f20 and c01 = '2016-07-01' and c01 = '岗位工资')
-- 
--  else 0 end ) bz,
-- (case when f19 in ('10512','10515','10514','10513','11376', 
-- 							'11377','11180') and f6 not like '%期%'
-- /*'综合类公务员','参公人员','行政执法类公务员','专业技术公务员','司法行政人员',
-- 							'司法辅助人员','人民警察'*/
-- 			then (select c06 from t127 where c04=f8
-- 					and c05 = f7 and c08=if(f20=10498,10497,f20) and c01 = '2016-07-01')
-- 		when  f6  like '%期%'
-- 			then 0
-- 		when f19 in ('10519','10518','10520') and f6 not like '%期%' -- '专业技术人员','管理人员','事业工人'
-- 			then (select c06 from t127 where  c04 = f8 and c08=f20 and c01 = '2016-07-01' )
-- 		when f19 in ('10516') and f6 not like '%期%' -- '机关工人'
-- 			then (select c06 from t127 where c05 = f6 and c04 = f8 and c08=f20 and c01 = '2016-07-01' )
-- 		when f19 in ('11181','11182') and f6 not like '%期%' -- '员额内法官','员额内检察官'
-- 			then (select c06 from t127 where  c05 = f6 and c04 = f8 and c08=f20 and c01 = '2016-07-01')
-- 
--  else 0 end ) jbgz,
-- 
-- test1.* from test1 ) a where (f9!=bz or f10!=jbgz) and ifnull(f22,'') != 10487 and  ifnull(f24,'') != 10487 and  ifnull(f25,'') != 10487
--  and exists(select 1 from t111 where id = f2)
) b;




-- select (select c02 from t111 where id =(select c11 from t111 where id =f2)) 主管部门,
-- (select c02 from t111 where id = f2) 单位名称,f3 人员编号,f4 人员姓名, f5 身份证 ,
-- (select name from sys_s_data where id = f16)  学历,f6 工资职级,(select c04 from t127 where id =f18) 是否领导,f7 级别,f8 档次
-- ,f9 职务工资,bz 职务工资标准,f10 级别工资 ,0 级别工资标准,
-- f11 `提高10%` ,f12 `提高15%` ,f13 基本工资小计 ,
-- (select name from sys_s_data where id = f14) 性别,f15 出生日期, 
--  (select name from sys_s_data where id = f19) 身份,f20 工资标准类别,f21 变动类型,f22 是否停薪 ,
-- f24 是否计发生活费, f25 是否计发病假
-- ,f2,f1
-- from (
-- select * from (
-- select (select c06 from t127 where c04=(select c04 from t127 where id =f18)
-- and c05 = f6 and c08=f20 and c01 = '2016-07-01'
-- ) bz,
-- 
-- test1.* from test1 ) a where f9!=bz and ifnull(f22,'') != 10487 and  ifnull(f24,'') != 10487 and  ifnull(f25,'') != 10487
--  and exists(select 1 from t111 where id = f2)
-- ) b;

delete from test11 where 身份 = '机关离休干部' and  f2= concat(dwid,'')   ;

update test11,t127 set `职务工资标准`= c06
where  c05=工资职级  and  f2= concat(dwid,'')  and c04 = 档次 and c01 = '2016-07-01' and 身份 in ('员额内检察官','员额内法官');

update test11,t127 set `职务工资标准`= c06
where  c05=工资职级  and  f2= concat(dwid,'')  and c01 = '2016-07-01' and 身份 in ('运动员') and c08 = '11340' ;

update test11,t127 set `级别工资标准`= c06
where  c05=级别  and  f2= concat(dwid,'')  and c04 = 档次 and c01 = '2016-07-01' and 身份 in ('运动员') and c08 = '11340' ;


update test11,t127 set `级别工资标准`= c06
where  c05=级别  and  f2= concat(dwid,'')  and c04 = 档次 and c01 = '2016-07-01' and 身份 in ('综合类公务员');

update test11,t127 set `级别工资标准`= c06
where  c04 = 档次  and  f2= concat(dwid,'')  and c01 = '2016-07-01' and 身份 in ('管理人员') ;
-- 非副厅级单位四五级职员领导读非领导的工资
update test11,t127 set `职务工资标准`= c06
where  c05 = 工资职级  and  f2= concat(dwid,'')  and c04 = '非领导职务' and c01 = '2016-07-01' and 身份 in ('管理人员') 
and not exists(select 1 from t111 where c02 = 单位名称 and c10=10324);

update test11,t127 set `级别工资标准`= c06
where  c05=级别  and  f2= concat(dwid,'')  and c04 = 档次 and c01 = '2016-07-01' and 身份 in ('人民警察');

-- 工资标准不对的查询
-- select * from test11 where round(职务工资,2) - round(职务工资标准,2)!=0  and 基本工资小计!=0
-- union 
-- select * from test11 where round(级别工资,2) - round(级别工资标准,2)!=0 and 基本工资小计!=0;
-- 



insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordId)
select f2,f1,人员编号,人员姓名,性别,身份证,7 ,出生日期,-- 工资职级,级别,档次,职务工资,级别工资,提高10%,提高15%,小计,'人员',人员身份
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07'  
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
) and t126.allauditflag = 2 )),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 ),
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 ),
ifnull((select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )*1+0,0),
ifnull((select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )*1+0,0),
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0)) from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 ),
'其他',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07'
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
  ) and t126.allauditflag = 2 )),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-07' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )
from ( select * from test11 where 人员编号 not like '%T'  and  f2= concat(dwid,'')  and  round(职务工资,2) - round(职务工资标准,2)!=0  and 基本工资小计!=0
 union 
 select * from test11 where 人员编号 not like '%T'  and  f2= concat(dwid,'')  and  round(级别工资,2) - round(级别工资标准,2)!=0
 and 基本工资小计!=0 -- and 身份 not in ('员额内检察官','员额内法官')
) a;

insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordId)
select f2,f1,人员编号,人员姓名,性别,身份证,8 ,出生日期,-- 工资职级,级别,档次,职务工资,级别工资,提高10%,提高15%,小计,'人员',人员身份
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08'
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
  ) and t126.allauditflag = 2 )),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )*1+0,
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )*1+0,
ifnull((select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )*1+0,0),
ifnull((select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )*1+0,0),
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0)) from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 ),
'其他',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08'
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
  ) and t126.allauditflag = 2 )),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-08' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )
from ( select * from test11 where 人员编号 not like '%T'  and  f2= concat(dwid,'')  and  round(职务工资,2) - round(职务工资标准,2)!=0  and 基本工资小计!=0
 union 
 select * from test11 where 人员编号 not like '%T'  and  f2= concat(dwid,'')  and  round(级别工资,2) - round(级别工资标准,2)!=0
 and 基本工资小计!=0 -- and 身份 not in ('员额内检察官','员额内法官')
) a;


insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordId)
select f2,f1,人员编号,人员姓名,性别,身份证,9 ,出生日期,-- 工资职级,级别,档次,职务工资,级别工资,提高10%,提高15%,小计,'人员',人员身份
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09'
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
  ) and t126.allauditflag = 2 )),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09'
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
  ) and t126.allauditflag = 2 )),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09'
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
  ) and t126.allauditflag = 2 )*1+0,
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09'  
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
) and t126.allauditflag = 2 )*1+0,
ifnull((select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )*1+0,0),
ifnull((select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )*1+0,0),
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0)) from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 ),
'其他',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09'
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
  ) and t126.allauditflag = 2 )),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-09' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )
from ( select * from test11 where 人员编号 not like '%T'  and  f2= concat(dwid,'')  and  round(职务工资,2) - round(职务工资标准,2)!=0  and 基本工资小计!=0
 union 
 select * from test11 where 人员编号 not like '%T'  and  f2= concat(dwid,'')  and  round(级别工资,2) - round(级别工资标准,2)!=0
 and 基本工资小计!=0 -- and 身份 not in ('员额内检察官','员额内法官')
) a;


insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordId)
select f2,f1,人员编号,人员姓名,性别,身份证,10 ,出生日期,-- 工资职级,级别,档次,职务工资,级别工资,提高10%,提高15%,小计,'人员',人员身份
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )*1+0,
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )*1+0,
ifnull((select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )*1+0,0),
ifnull((select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )*1+0,0),
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0)) from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 ),
'其他',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-10' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )
from ( select * from test11 where 人员编号 not like '%T'  and  f2= concat(dwid,'')  and  round(职务工资,2) - round(职务工资标准,2)!=0  and 基本工资小计!=0
 union 
 select * from test11 where 人员编号 not like '%T'  and  f2= concat(dwid,'')  and  round(级别工资,2) - round(级别工资标准,2)!=0
 and 基本工资小计!=0 -- and 身份 not in ('员额内检察官','员额内法官')
) a;


insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordid)
select f2,f1,人员编号,人员姓名,性别,身份证,11 ,出生日期,-- 工资职级,级别,档次,职务工资,级别工资,提高10%,提高15%,小计,'人员',人员身份
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )*1+0,
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )*1+0,
ifnull((select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )*1+0,0),
ifnull((select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )*1+0,0),
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0)) from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 ),
'其他',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11'
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
  ) and t126.allauditflag = 2 )),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-11' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )
from ( select * from test11 where 人员编号 not like '%T'  and  f2= concat(dwid,'')  and  round(职务工资,2) - round(职务工资标准,2)!=0  and 基本工资小计!=0
 union 
 select * from test11 where 人员编号 not like '%T'  and  f2= concat(dwid,'')  and  round(级别工资,2) - round(级别工资标准,2)!=0
 and 基本工资小计!=0 -- and 身份 not in ('员额内检察官','员额内法官')
) a;


insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordId)
select f2,f1,人员编号,人员姓名,性别,身份证,12 ,出生日期,-- 工资职级,级别,档次,职务工资,级别工资,提高10%,提高15%,小计,'人员',人员身份
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )*1+0,
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )*1+0,
ifnull((select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and allauditflag = 2  and c02<='2018-12' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )*1+0,0),
ifnull((select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and c02<='2018-12' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )*1+0,0),
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0)) from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and c02<='2018-12' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 ),
'其他',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and c02<='2018-12' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and c02<='2018-12' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )
from ( select * from test11 where 人员编号 not like '%T'  and  f2= concat(dwid,'')  and  round(职务工资,2) - round(职务工资标准,2)!=0  and 基本工资小计!=0
 union 
 select * from test11 where 人员编号 not like '%T'  and  f2= concat(dwid,'')  and  round(级别工资,2) - round(级别工资标准,2)!=0
 and 基本工资小计!=0 -- and 身份 not in ('员额内检察官','员额内法官')
) a;


insert into adjustwage.exadjust(unitId,ryId,rybh,name,sex,idcard,month,birthday,job,level,rankLevel,
 jobsalary,levelsalary,teacherNurseUp10,specialTeach,subTotal, remark,rysf,recordId)
select f2,f1,人员编号,人员姓名,性别,身份证,13 ,出生日期,-- 工资职级,级别,档次,职务工资,级别工资,提高10%,提高15%,小计,'人员',人员身份
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and c02<='2018-12' and changetype!='10831'
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and c02<='2018-12'  and changetype!='10831' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
) and t126.allauditflag = 2 )),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and c02<='2018-12'  and changetype!='10831'
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and c02<='2018-12'  and changetype!='10831'
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )*1+0,
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and c02<='2018-12' and changetype!='10831' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )*1+0,
ifnull((select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and c02<='2018-12'  and changetype!='10831' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
) and t126.allauditflag = 2 )*1+0,0),
ifnull((select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and c02<='2018-12' and changetype!='10831'
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
  ) and t126.allauditflag = 2 )*1+0,0),
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0)) from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and c02<='2018-12' and changetype!='10831' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 ),
'其他',
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and c02<='2018-12'  and changetype!='10831'
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f1 = concat(t126.dataid,'') and t125.c06 = concat(f1,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 =concat(f1,'') and c02<='2018-12'  and changetype!='10831'
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag = 2 )
from ( select * from test11 where 人员编号 not like '%T'  and  f2= concat(dwid,'')  and  round(职务工资,2) - round(职务工资标准,2)!=0  and 基本工资小计!=0
 union 
 select * from test11 where 人员编号 not like '%T'  and  f2= concat(dwid,'')  and  round(级别工资,2) - round(级别工资标准,2)!=0
 and 基本工资小计!=0 -- and 身份 not in ('员额内检察官','员额内法官')
) a
 -- left join t154 on   t154.c01=f2 and t154.c02 = f1  
 where   人员编号 not like '%T'
 -- and t154.c03 = '2018' 
 and exists(select 1 from t111 where id = f2 and ((c05 in ('10295','10821') or c19='10487'  or id in (886,527)) and id!=1469))
 and exists(select 1 from t111 where id = f2);



			
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`adjustFill`()
label_pro:BEGIN	
-- 先按16年标准计算 比较工资是否计算比例，然后再按18年的调标
-- 运动员基础津贴
update adjustwage.normaladjust na,t127 set jobSalaryAfter = c06
where t127.c01 = '2016-07-01' and c05=job and c08='11340'
and na.rysf in ('运动员')
and job not like '%期%' and jobsalary>0;
-- 运动员成绩津贴
update adjustwage.normaladjust na,t127 set levelSalaryAfter = c06
where t127.c01 = '2016-07-01' and c05=level and c04=ranklevel
and na.rysf in ('运动员')
and job not like '%期%' and jobsalary>0;
-- 公务员类非试用期的职务工资
update adjustwage.normaladjust na,t127 set jobSalaryAfter = c06
where t127.c01 = '2016-07-01' and c05=job and c04 = (select c04 from t127 where id = (select c27 from data_record_t126 where id = recordId))
and na.rysf in ('综合类公务员','参公人员','行政执法类公务员','专业技术公务员','司法行政人员','司法辅助人员','人民警察')
and job not like '%期%' and jobsalary>0;
-- 公务员类试用期的职务工资
update adjustwage.normaladjust na,t127 set jobSalaryAfter = c06
where t127.c01 = '2016-07-01' and c05 like '%试用期%' and c04 = (select name from sys_s_data where id = (select c09 from data_record_t126 where id = recordId))
and na.rysf in ('综合类公务员','参公人员','行政执法类公务员','专业技术公务员','司法行政人员','司法辅助人员','人民警察')
and job  like '%期%' and jobsalary>0;
-- 公务员类非试用期的级别工资
update adjustwage.normaladjust na,t127 set levelSalaryAfter = c06
where t127.c01 = '2016-07-01' and c05=level and c04 = ranklevel
and na.rysf in ('综合类公务员','参公人员','行政执法类公务员','专业技术公务员','司法行政人员','司法辅助人员','人民警察')
and job not like '%期%' and ifnull(levelsalary,0)>0;


-- 事业管理的职务工资
update adjustwage.normaladjust na,t127 set jobSalaryAfter = c06
where t127.c01 = '2016-07-01' and c05=job and c04 = (select c04 from t127 where id = (select c27 from data_record_t126 where id = recordId))
and na.rysf in ('管理人员')
and job not like '%期%' and jobsalary>0;
-- 非副厅级单位四五级职员领导读非领导的工资
update adjustwage.normaladjust na,t127 set jobSalaryAfter= c06
where  c05 = job and c04 = '非领导职务' and c01 = '2016-07-01' and na.rysf in ('管理人员')
and not exists(select 1 from t111 where id = unitId and c10=10324);

-- 事业专技的职务工资
update adjustwage.normaladjust na,t127 set jobSalaryAfter = c06
where t127.c01 = '2016-07-01' and c05=job 
and na.rysf in ('专业技术人员')
and job not like '%期%' and jobsalary>0;

-- 事业试用期职务工资】
update adjustwage.normaladjust na,t127 set jobSalaryAfter = c06
where t127.c01 = '2016-07-01' and c05 like '%试用期' and c04 = (select name from sys_s_data where id = (select c09 from data_record_t126 where id = recordId))
and na.rysf in ('管理人员','专业技术人员')
and job  like '%期' and jobsalary>0;
update adjustwage.normaladjust na,t127 set jobSalaryAfter = c06
where t127.c01 = '2016-07-01' and c05 like '%试用期(地勘)' and c04 = (select name from sys_s_data where id = (select c09 from data_record_t126 where id = recordId))
and na.rysf in ('管理人员','专业技术人员')
and job  like '%试用期(地勘)' and jobsalary>0;

-- 事业薪级工资
update adjustwage.normaladjust na,t127 set levelSalaryAfter = c06
where t127.c01 = '2016-07-01'    and  c04 = ranklevel
and na.rysf in ('管理人员') and c08 = 11334 and job not like '%地勘%'
and job not like '%期%' and ifnull(levelsalary,0)>0;
update adjustwage.normaladjust na,t127 set levelSalaryAfter = c06
where t127.c01 = '2016-07-01'    and  c04 = ranklevel
and na.rysf in ('专业技术人员') and c08 = 11335 and job not like '%地勘%'
and job not like '%期%' and ifnull(levelsalary,0)>0;

update adjustwage.normaladjust na,t127 set levelSalaryAfter = c06
where t127.c01 = '2016-07-01'    and  c04 = ranklevel
and na.rysf in ('管理人员') and c08 = 11337 and job  like '%地勘%'
and job not like '%期%' and ifnull(levelsalary,0)>0;
update adjustwage.normaladjust na,t127 set levelSalaryAfter = c06
where t127.c01 = '2016-07-01'    and  c04 = ranklevel
and na.rysf in ('专业技术人员') and c08 = 11338 and job  like '%地勘%'
and job not like '%期%' and ifnull(levelsalary,0)>0;


-- 法检职务工资
update adjustwage.normaladjust na,t127 set jobSalaryAfter = c06
where t127.c01 = '2016-07-01' and c05=job and c04 = ranklevel
and na.rysf in ('员额内法官','员额内检察官')
and job not like '%期%' and jobsalary>0;



-- 工人技术等级工资
update adjustwage.normaladjust na,t127 set jobSalaryAfter = c06
where t127.c01 = '2016-07-01' and c05=job 
and na.rysf in ('机关工人','事业工人')
and job not like '%期%' and jobsalary>0;
update adjustwage.normaladjust na,t127 set jobSalaryAfter = c06
where t127.c01 = '2016-07-01'    and c05=job  and c08 = 11336
and na.rysf in ('事业工人')
and job  = '普通工' and jobsalary>0;
update adjustwage.normaladjust na,t127 set jobSalaryAfter = c06
where t127.c01 = '2016-07-01'   and c05=job  and c08 = 11339
and na.rysf in ('事业工人')
and job  = '普通工(地勘)' and jobsalary>0;


-- 机关工人岗位工资
update adjustwage.normaladjust na,t127 set levelSalaryAfter = c06
where t127.c01 = '2016-07-01' and c05=job and c04 = ranklevel and c08 = '11333'
and na.rysf in ('机关工人')
and job not like '%期%' and ifnull(levelsalary,0)>0;
-- 事业工人岗位工资
update adjustwage.normaladjust na,t127 set levelSalaryAfter = c06
where t127.c01 = '2016-07-01'    and c04 = ranklevel and c08 = '11336'
and na.rysf in ('事业工人') and job not like '%地勘%'
and job not like '%期%' and ifnull(levelsalary,0)>0;
update adjustwage.normaladjust na,t127 set levelSalaryAfter = c06
where t127.c01 = '2016-07-01'   and c04 = ranklevel and c08 = '11339'
and na.rysf in ('事业工人') and job  like '%地勘%'
and job not like '%期%' and ifnull(levelsalary,0)>0;


-- 工人学徒期
update adjustwage.normaladjust na,t127 set jobSalaryAfter = c06
where t127.c01 = '2016-07-01' and c05 like '%期' and c04 = (select name from sys_s_data where id = (select c09 from data_record_t126 where id = recordId)) 
and na.rysf in ('事业工人') and  c08 = 11336 and c05 = job
and job  like '%期' and jobsalary>0;
update adjustwage.normaladjust na,t127 set jobSalaryAfter = c06
where t127.c01 = '2016-07-01' and c05 like '%期(地勘)' and c04 = (select name from sys_s_data where id = (select c09 from data_record_t126 where id = recordId)) 
and na.rysf in ('事业工人') and  c08 = 11336 and c05 = job
and job  like '%期(地勘)' and jobsalary>0;



update adjustwage.normaladjust set nt = 0.6 where round(jobsalary/jobsalaryafter,2) =round(jobsalary/jobsalaryafter,2) 
and round(jobsalary/jobsalaryafter,2) = 0.6;
update adjustwage.normaladjust set nt = 0.7 where round(jobsalary/jobsalaryafter,2) =round(jobsalary/jobsalaryafter,2) 
and round(jobsalary/jobsalaryafter,2) = 0.7;
update adjustwage.normaladjust set nt = 0.75 where round(jobsalary/jobsalaryafter,2) =round(jobsalary/jobsalaryafter,2) 
and round(jobsalary/jobsalaryafter,2) = 0.75;
update adjustwage.normaladjust set nt = 0.8 where  round(jobsalary/jobsalaryafter,2) =round(jobsalary/jobsalaryafter,2) 
and round(jobsalary/jobsalaryafter,2) = 0.8;
update adjustwage.normaladjust set nt = 0.9 where  round(jobsalary/jobsalaryafter,2) =round(jobsalary/jobsalaryafter,2)
and round(jobsalary/jobsalaryafter,2) = 0.9;



-- 计发生活费的人转移到异常人员表
insert into adjustwage.exadjust (unitId,ryId,rybh,name,sex,idcard,month,endSalaryTime,birthday,job,level,rankLevel,jobSalary,
levelSalary,teacherNurseUp10,specialTeach,subTotal,remark,nt,rysf,recordId)
select unitId,ryId,rybh,name,(select name from sys_s_data where id = (select c05 from t126 where id = ryid) ),idcard,month,
(select f26 from test1 where f1 = ryid ),(select f15 from test1 where f1 = ryid ),job,level,rankLevel,jobSalary,
levelSalary,teacherNurseUp10,specialTeach,subTotal,'其他',nt,rysf,recordId
from adjustwage.normaladjust where exists(select 1 from adjustwage.normaladjust b where 
b.unitId =normaladjust.unitId and  b.ryid = normaladjust.ryid and (b.nt = 0.6 or b.nt = 0.75) )
and not exists(select 1 from adjustwage.exadjust where ryId = normaladjust.ryid);
-- 工资不是标准数据的传入异常表

delete a from adjustwage.normaladjust a,adjustwage.normaladjust b  where   a.unitid=b.unitid and a.ryid =b.ryid and (b.nt = 0.6 or b.nt = 0.75)
and exists(select 1 from adjustwage.exadjust where ryId = a.ryid);

	-- <=7月减少，>12月接收的，都在接收单位列入异常人员
insert into adjustwage.exadjust (unitId,ryId,rybh,name,sex,idcard,month,endSalaryTime,birthday,job,level,rankLevel,jobSalary,
levelSalary,teacherNurseUp10,specialTeach,subTotal,remark,nt,rysf,recordId)
select unitId,ryId,rybh,name,(select name from sys_s_data where id = (select c05 from t126 where id = ryid) ),idcard,month,
(select f26 from test1 where f1 = ryid ),(select f15 from test1 where f1 = ryid ),job,level,rankLevel,jobSalary,
levelSalary,teacherNurseUp10,specialTeach,subTotal,'其他','<=7月减少，>12月接收的，都在接收单位列入异常人员',rysf,recordId
from adjustwage.normaladjust where  ryid = 86803 
and exists(select 1 from adjustwage.normaladjust b where b.unitId = concat(dwid,'') and 
b.unitId =normaladjust.unitId and  b.ryid = normaladjust.ryid and (b.nt = 0.6 or b.nt = 0.75) )
and not exists(select 1 from adjustwage.exadjust where ryId = normaladjust.ryid);
-- <=7月减少，>12月接收的，都在接收单位列入异常人员
delete a from adjustwage.normaladjust a,adjustwage.normaladjust b  where  a.unitId = concat(dwid,'') and a.ryid = 86803 
and a.unitid=b.unitid and a.ryid =b.ryid and (b.nt = 0.6 or b.nt = 0.75)
and exists(select 1 from adjustwage.exadjust where ryId = a.ryid);

-- 其他异常人员  工资！=标准的
insert into adjustwage.exadjust (unitId,ryId,rybh,name,sex,idcard,month,endSalaryTime,birthday,job,level,rankLevel,jobSalary,
levelSalary,teacherNurseUp10,specialTeach,subTotal,remark,nt,rysf,recordId)
select unitId,ryId,rybh,name,(select name from sys_s_data where id = (select c05 from t126 where id = ryid) ),idcard,month,
(select f26 from test1 where f1 = ryid ),(select f15 from test1 where f1 = ryid ),job,level,rankLevel,jobSalary,
levelSalary,teacherNurseUp10,specialTeach,subTotal,'其他',nt,rysf,recordId
from (
select unitId,ryId,rybh,name,(select name from sys_s_data where id = (select c05 from t126 where id = ryid) ),idcard,month,
(select f26 from test1 where f1 = ryid ),(select f15 from test1 where f1 = ryid ),job,level,rankLevel,jobSalary,
levelSalary,teacherNurseUp10,specialTeach,subTotal,'其他',nt,rysf,recordId
from (
 select (select c01 from smso.t111 where id = normaladjust.unitId) 单位代码,
 (select c02 from smso.t111 where id = normaladjust.unitId) 单位名称,
  (select name from smso.sys_s_data where id =(select c10 from  smso.t111 where id = normaladjust.unitId)) 单位级别,
	 rysf 人员身份,rybh 人员编号,name 姓名,month 月份,job 职务,
 (select c04 from smso.t127 where id =(select c27 from smso.data_record_t126 where id = recordId)) 是否领导,
level 级别,ranklevel 档次,jobsalary 职务工资,levelsalary 级别工资,teachernurseup10 `提高10%`,specialteach `提高15%`,subtotal 小计,
 jobsalaryafter 后职务工资,levelsalaryafter 后级别工资,teachernurseup10after `后提高10%`,specialteachafter `后提高15%`,subtotalafter 后小计,
 fill 补扣发,
 normaladjust.*  from adjustwage.normaladjust where  exists(select 1 from adjustwage.normaladjust b where 
b.unitId =normaladjust.unitId and  b.ryid = normaladjust.ryid and  ifnull(nt,'') not in (0.7,0.8,0.9)  and (round(ifnull(jobsalary,0))!=round(ifnull(jobsalaryafter,0)) or round(ifnull(levelsalary,0))!=round(ifnull(levelsalaryafter,0)))  )

 ) b
 where (单位级别 = '副地厅级' and 职务 not in('四级职员岗位','五级职员岗位'))
 or (单位级别 != '副地厅级' and 职务  in('四级职员岗位','五级职员岗位'))
 or (单位级别 != '副地厅级' and 职务 not in('四级职员岗位','五级职员岗位'))
 ) a;
 
   select GROUP_CONCAT(rybh ) into @temp
 from ( select DISTINCT rybh from adjustwage.exadjust   group by rybh having count(1)<6 ) aa;
  delete from adjustwage.exadjust where 
 locate(rybh ,@temp)>0;
 

 
 delete from adjustwage.normaladjust where exists(select 1 from  adjustwage.exadjust
 where ryid = normaladjust.ryid);
 
 

/*delete  from adjustwage.normaladjust where
exists(select 1 from (
select id
from (
select *
from (
 select (select c01 from smso.t111 where id = normaladjust.unitId) 单位代码,
 (select c02 from smso.t111 where id = normaladjust.unitId) 单位名称,
  (select name from smso.sys_s_data where id =(select c10 from  smso.t111 where id = normaladjust.unitId)) 单位级别,
	 rysf 人员身份,rybh 人员编号,name 姓名,month 月份,job 职务,
 (select c04 from smso.t127 where id =(select c27 from smso.data_record_t126 where id = recordId)) 是否领导,
level 级别,ranklevel 档次,jobsalary 职务工资,levelsalary 级别工资,teachernurseup10 `提高10%`,specialteach `提高15%`,subtotal 小计,
 jobsalaryafter 后职务工资,levelsalaryafter 后级别工资,teachernurseup10after `后提高10%`,specialteachafter `后提高15%`,subtotalafter 后小计,
 fill 补扣发,
 normaladjust.*  from adjustwage.normaladjust where  exists(select 1 from adjustwage.normaladjust b where 
b.unitId =normaladjust.unitId and  b.ryid = normaladjust.ryid and  ifnull(nt,'') not in (0.7,0.8,0.9)  and (round(ifnull(jobsalary,0))!=round(ifnull(jobsalaryafter,0)) or round(ifnull(levelsalary,0))!=round(ifnull(levelsalaryafter,0)))  )

 ) b
 where (单位级别 = '副地厅级' and 职务 not in('四级职员岗位','五级职员岗位'))
 or (单位级别 != '副地厅级' and 职务  in('四级职员岗位','五级职员岗位'))
 or (单位级别 != '副地厅级' and 职务 not in('四级职员岗位','五级职员岗位'))
 
 ) a ) c where c.id = normaladjust.id );*/




-- 18年标准
-- 运动员基础津贴
update adjustwage.normaladjust na,t127 set jobSalaryAfter = c06
where t127.c01 = '2018-07-01' and c05=job and c08='11340'
and na.rysf in ('运动员')
and job not like '%期%' and jobsalary>0;
-- 运动员成绩津贴
update adjustwage.normaladjust na,t127 set levelSalaryAfter = c06
where t127.c01 = '2018-07-01' and c05=level and c04=ranklevel
and na.rysf in ('运动员')
and job not like '%期%' and jobsalary>0;
-- 公务员类非试用期的职务工资
update adjustwage.normaladjust na,t127 set jobSalaryAfter = c06
where t127.c01 = '2018-07-01' and c05=job and c04 = (select c04 from t127 where id = (select c27 from data_record_t126 where id = recordId))
and na.rysf in ('综合类公务员','参公人员','行政执法类公务员','专业技术公务员','司法行政人员','司法辅助人员','人民警察')
-- and  job not in ('一级调研员','三级调研员','一级主任科员','三级主任科员','四级警长','一级警员')
and job not like '%期%' and jobsalary>0;

-- 公务员类试用期的职务工资
update adjustwage.normaladjust na,t127 set jobSalaryAfter = c06
where t127.c01 = '2018-07-01' and c05 like '%试用期%' and c04 = (select name from sys_s_data where id = (select c09 from data_record_t126 where id = recordId))
and na.rysf in ('综合类公务员','参公人员','行政执法类公务员','专业技术公务员','司法行政人员','司法辅助人员','人民警察')
and job  like '%期%' and jobsalary>0;
-- 公务员类非试用期的级别工资
update adjustwage.normaladjust na,t127 set levelSalaryAfter = c06
where t127.c01 = '2018-07-01' and c05=level and c04 = ranklevel
and na.rysf in ('综合类公务员','参公人员','行政执法类公务员','专业技术公务员','司法行政人员','司法辅助人员','人民警察')
-- and  job not in ('一级调研员','三级调研员','一级主任科员','三级主任科员','四级警长','一级警员')
and job not like '%期%' and ifnull(levelsalary,0)>0;



-- 事业管理的职务工资
update adjustwage.normaladjust na,t127 set jobSalaryAfter = c06
where t127.c01 = '2018-07-01'  and c05=job and c04 = (select c04 from t127 where id = (select c27 from data_record_t126 where id = recordId))
and na.rysf in ('管理人员') and c08 = 11334 and job not like '%地勘%'
and job not like '%期%' and jobsalary>0;
-- update adjustwage.normaladjust na,t127 set jobSalaryAfter = c06
-- where t127.c01 = '2018-07-01'  and na.unitId = concat(dwid,'')  and c05=job and c04 = (select c04 from t127 where id = (select c27 from data_record_t126 where id = recordId))
-- and na.rysf in ('管理人员') and c08 = 11337 and job  like '%地勘%'
-- and job not like '%期%' and jobsalary>0;


-- 非副厅级单位四五级职员领导读非领导的工资
update adjustwage.normaladjust na,t127 set jobSalaryAfter= c06
where  c05 = job and c04 = '非领导职务' and c01 = '2018-07-01' and na.rysf in ('管理人员')
and not exists(select 1 from t111 where id = unitId and c10=10324);

-- 事业专技的职务工资
update adjustwage.normaladjust na,t127 set jobSalaryAfter = c06
where t127.c01 = '2018-07-01'    and c05=job 
and na.rysf in ('专业技术人员') and c08 = 11335 and job not like '%地勘%'
and job not like '%期%' and jobsalary>0;
-- update adjustwage.normaladjust na,t127 set jobSalaryAfter = c06
-- where t127.c01 = '2018-07-01'    and c05=job 
-- and na.rysf in ('专业技术人员') and c08 = 11338 and job  like '%地勘%'
-- and job not like '%期%' and jobsalary>0;

-- 事业试用期职务工资】
update adjustwage.normaladjust na,t127 set jobSalaryAfter = c06
where t127.c01 = '2018-07-01' and c05 like '%试用期' and c04 = (select name from sys_s_data where id = (select c09 from data_record_t126 where id = recordId))
and na.rysf in ('管理人员','专业技术人员')
and job  like '%期' and jobsalary>0;
-- update adjustwage.normaladjust na,t127 set jobSalaryAfter = c06
-- where t127.c01 = '2018-07-01' and c05 like '%试用期(地勘)' and c04 = (select name from sys_s_data where id = (select c09 from data_record_t126 where id = recordId))
-- and na.rysf in ('管理人员','专业技术人员')
-- and job  like '%期(地勘)' and jobsalary>0;

-- 事业薪级工资
update adjustwage.normaladjust na,t127 set levelSalaryAfter = c06
where t127.c01 = '2018-07-01'   and  c04 = ranklevel and job not like '%地勘%'
and na.rysf in ('管理人员') and c08 =11334 
and job not like '%期%' and ifnull(levelsalary,0)>0;
update adjustwage.normaladjust na,t127 set levelSalaryAfter = c06
where t127.c01 = '2018-07-01'   and  c04 = ranklevel and job not like '%地勘%'
and na.rysf in ('专业技术人员') and c08 =11335
and job not like '%期%' and ifnull(levelsalary,0)>0;

-- update adjustwage.normaladjust na,t127 set levelSalaryAfter = c06
-- where t127.c01 = '2018-07-01'  and na.unitId = concat(dwid,'')  and  c04 = ranklevel and job  like '%地勘%'
-- and na.rysf in ('管理人员') and c08 =11337
-- and job not like '%期%' and ifnull(levelsalary,0)>0;
-- update adjustwage.normaladjust na,t127 set levelSalaryAfter = c06
-- where t127.c01 = '2018-07-01'  and na.unitId = concat(dwid,'')  and  c04 = ranklevel and job  like '%地勘%'
-- and na.rysf in ('专业技术人员') and c08 =11338
-- and job not like '%期%' and ifnull(levelsalary,0)>0;

-- 法检职务工资
update adjustwage.normaladjust na,t127 set jobSalaryAfter = c06
where t127.c01 = '2018-07-01' and c05=job and c04 = ranklevel
and na.rysf in ('员额内法官','员额内检察官')
and job not like '%期%' and jobsalary>0;



-- 工人技术等级工资
update adjustwage.normaladjust na,t127 set jobSalaryAfter = c06
where t127.c01 = '2018-07-01'    and c05=job 
and na.rysf in ('机关工人','事业工人')
and job not like '%期%' and jobsalary>0;
update adjustwage.normaladjust na,t127 set jobSalaryAfter = c06
where t127.c01 = '2018-07-01'  and c05=job  and c08 = 11336
and na.rysf in ('事业工人')
and job  = '普通工' and jobsalary>0;
-- update adjustwage.normaladjust na,t127 set jobSalaryAfter = c06
-- where t127.c01 = '2018-07-01'  and na.unitId = concat(dwid,'')  and c05=job  and c08 = 11339
-- and na.rysf in ('事业工人')
-- and job  = '普通工(地勘)' and jobsalary>0;

-- 机关工人岗位工资
update adjustwage.normaladjust na,t127 set levelSalaryAfter = c06
where t127.c01 = '2018-07-01' and c05=job and c04 = ranklevel and c08 = '11333'
and na.rysf in ('机关工人')
and job not like '%期%' and ifnull(levelsalary,0)>0;
-- 事业工人岗位工资
update adjustwage.normaladjust na,t127 set levelSalaryAfter = c06
where t127.c01 = '2018-07-01'    and c04 = ranklevel and c08 = '11336'  and job not like '%地勘%'
and na.rysf in ('事业工人') and c08 =11336
and job not like '%期%' and ifnull(levelsalary,0)>0;
-- update adjustwage.normaladjust na,t127 set levelSalaryAfter = c06
-- where t127.c01 = '2018-07-01'   and na.unitId = concat(dwid,'')  and c04 = ranklevel and c08 = '11336'  and job  like '%地勘%'
-- and na.rysf in ('事业工人') and c08 =11339
-- and job not like '%期%' and ifnull(levelsalary,0)>0;

-- 工人学徒期
update adjustwage.normaladjust na,t127 set jobSalaryAfter = c06
where t127.c01 = '2018-07-01' and c05 like '%期' and c04 = (select name from sys_s_data where id = (select c09 from data_record_t126 where id = recordId)) 
and na.rysf in ('事业工人')  and c08 = 11336 and c05 = job
and job  like '%期' and jobsalary>0;
-- update adjustwage.normaladjust na,t127 set jobSalaryAfter = c06
-- where t127.c01 = '2018-07-01' and c05 like '%期(地勘)' and c04 = (select name from sys_s_data where id = (select c09 from data_record_t126 where id = recordId)) 
-- and na.rysf in ('事业工人')  and c08 = 11336 and c05 = job
-- and job  like '%期(地勘)' and jobsalary>0;


update adjustwage.normaladjust set  jobsalaryafter = round(jobsalaryafter*nt  ) , levelsalaryafter = round(levelsalaryafter*nt  )
where nt in (0.7,0.8,0.9);



-- 提高10%
update adjustwage.normaladjust  
set teacherNurseup10after = round((ifnull(jobsalaryafter,0)+ifnull(levelsalaryafter,0))*0.1)
where ifnull(teacherNurseup10,0)>0;
-- 提高15%
update adjustwage.normaladjust  
set specialteachafter = round((ifnull(jobsalaryafter,0)+ifnull(levelsalaryafter,0)+ifnull(teacherNurseup10after,0))*0.15)
where ifnull(specialteach,0)>0;

-- 小计 
update adjustwage.normaladjust  
set  subtotalafter= (ifnull(jobsalaryafter,0)+ifnull(levelsalaryafter,0)+ifnull(teacherNurseup10after,0)
+ifnull(specialteachafter,0))
where ifnull(subtotal,0)>0;

-- 补扣发 
update adjustwage.normaladjust  
set  fill= (ifnull(subtotalafter,0)-ifnull(subtotal,0))
where ifnull(subtotal,0)>0 ;
-- and  job not in ('一级调研员','三级调研员','一级主任科员','三级主任科员','四级警长','一级警员')
-- and  rysf not  in ('员额内法官','员额内检察官')







update adjustwage.exadjust set jobsalary=0,levelsalary=0,teacherNurseUp10=0,specialTeach=0,subTotal=0,nt='减少人员设置后续工资为0'
where  substr(endsalarytime from 6 for 2)<=month and endsalarytime<='2018-12';

update adjustwage.normaladjust,t126,t125 set jobsalary=0,levelsalary=0,teacherNurseUp10=0,specialTeach=0,subTotal=0,nt='减少人员设置后续工资为0',
jobsalaryAfter=0,levelsalaryAfter=0,teacherNurseUp10After=0,specialTeachAfter=0,subTotalAfter=0,fill=0
where   ryid = t126.id and t125.c06 = concat(t126.id,'')
and t126.c40 = '10831' 
and (month>=substr(t125.c02 from 6 for 2) and endsalarytime<='2018-12');




	
			
END ;;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`adjustFillByUnitId`(IN dwid int(11))
label_pro:BEGIN	
-- 先按16年标准计算 比较工资是否计算比例，然后再按18年的调标
-- 运动员基础津贴
update adjustwage.normaladjust na,t127 set jobSalaryAfter = c06
where t127.c01 = '2016-07-01' and na.unitId = concat(dwid,'')  and c05=job and c08='11340'
and na.rysf in ('运动员')
and job not like '%期%' and jobsalary>0;
-- 运动员成绩津贴
update adjustwage.normaladjust na,t127 set levelSalaryAfter = c06
where t127.c01 = '2016-07-01' and na.unitId = concat(dwid,'')  and c05=level and c04=ranklevel
and na.rysf in ('运动员')
and job not like '%期%' and jobsalary>0;
-- 公务员类非试用期的职务工资
update adjustwage.normaladjust na,t127 set jobSalaryAfter = c06
where t127.c01 = '2016-07-01' and na.unitId = concat(dwid,'') and c05=job and c04 = (select c04 from t127 where id = (select c27 from data_record_t126 where id = recordId))
and na.rysf in ('综合类公务员','参公人员','行政执法类公务员','专业技术公务员','司法行政人员','司法辅助人员','人民警察')
and job not like '%期%' and jobsalary>0;

-- 公务员类试用期的职务工资
update adjustwage.normaladjust na,t127 set jobSalaryAfter = c06
where t127.c01 = '2016-07-01'  and na.unitId = concat(dwid,'')  and c05 like '%试用期%' and c04 = (select name from sys_s_data where id = (select c09 from data_record_t126 where id = recordId))
and na.rysf in ('综合类公务员','参公人员','行政执法类公务员','专业技术公务员','司法行政人员','司法辅助人员','人民警察')
and job  like '%期%' and jobsalary>0;

-- 公务员类非试用期的级别工资
update adjustwage.normaladjust na,t127 set levelSalaryAfter = c06
where t127.c01 = '2016-07-01'  and na.unitId = concat(dwid,'')  and c05=level and c04 = ranklevel
and na.rysf in ('综合类公务员','参公人员','行政执法类公务员','专业技术公务员','司法行政人员','司法辅助人员','人民警察')
and job not like '%期%' and ifnull(levelsalary,0)>0;


-- 事业管理的职务工资
update adjustwage.normaladjust na,t127 set jobSalaryAfter = c06
where t127.c01 = '2016-07-01'  and na.unitId = concat(dwid,'')  and c05=job and c04 = (select c04 from t127 where id = (select c27 from data_record_t126 where id = recordId)) 
and na.rysf in ('管理人员')
and job not like '%期%' and jobsalary>0;
-- 非副厅级单位四五级职员领导读非领导的工资
update adjustwage.normaladjust na,t127 set jobSalaryAfter= c06
where  c05 = job  and na.unitId = concat(dwid,'')  and c04 = '非领导职务' and c01 = '2016-07-01' and na.rysf in ('管理人员')
and not exists(select 1 from t111 where id = unitId and c10=10324);

-- 事业专技的职务工资
update adjustwage.normaladjust na,t127 set jobSalaryAfter = c06
where t127.c01 = '2016-07-01'  and na.unitId = concat(dwid,'')  and c05=job 
and na.rysf in ('专业技术人员')
and job not like '%期%' and jobsalary>0;

-- 事业试用期职务工资】
update adjustwage.normaladjust na,t127 set jobSalaryAfter = c06
where t127.c01 = '2016-07-01'  and na.unitId = concat(dwid,'')  and c05 like '%试用期' and c04 = (select name from sys_s_data where id = (select c09 from data_record_t126 where id = recordId))
and na.rysf in ('管理人员','专业技术人员')
and job  like '%期' and jobsalary>0;

-- 事业地勘试用期职务工资】
update adjustwage.normaladjust na,t127 set jobSalaryAfter = c06
where t127.c01 = '2016-07-01'  and na.unitId = concat(dwid,'')  and c05 like '%试用期(地勘)' and c04 = (select name from sys_s_data where id = (select c09 from data_record_t126 where id = recordId))
and na.rysf in ('管理人员','专业技术人员')
and job  like '%期(地勘)' and jobsalary>0;

-- 事业薪级工资
update adjustwage.normaladjust na,t127 set levelSalaryAfter = c06
where t127.c01 = '2016-07-01'  and na.unitId = concat(dwid,'')  and  c04 = ranklevel
and na.rysf in ('管理人员') and c08 = 11334 and job not like '%地勘%'
and job not like '%期%' and ifnull(levelsalary,0)>0;
update adjustwage.normaladjust na,t127 set levelSalaryAfter = c06
where t127.c01 = '2016-07-01'  and na.unitId = concat(dwid,'')  and  c04 = ranklevel
and na.rysf in ('专业技术人员') and c08 = 11335 and job not like '%地勘%'
and job not like '%期%' and ifnull(levelsalary,0)>0;

update adjustwage.normaladjust na,t127 set levelSalaryAfter = c06
where t127.c01 = '2016-07-01'  and na.unitId = concat(dwid,'')  and  c04 = ranklevel
and na.rysf in ('管理人员') and c08 = 11337 and job  like '%地勘%'
and job not like '%期%' and ifnull(levelsalary,0)>0;
update adjustwage.normaladjust na,t127 set levelSalaryAfter = c06
where t127.c01 = '2016-07-01'  and na.unitId = concat(dwid,'')  and  c04 = ranklevel
and na.rysf in ('专业技术人员') and c08 = 11338 and job  like '%地勘%'
and job not like '%期%' and ifnull(levelsalary,0)>0;



-- 法检职务工资
update adjustwage.normaladjust na,t127 set jobSalaryAfter = c06
where t127.c01 = '2016-07-01'  and na.unitId = concat(dwid,'')  and c05=job and c04 = ranklevel
and na.rysf in ('员额内法官','员额内检察官')
and job not like '%期%' and jobsalary>0;



-- 工人技术等级工资
update adjustwage.normaladjust na,t127 set jobSalaryAfter = c06
where t127.c01 = '2016-07-01'  and na.unitId = concat(dwid,'')  and c05=job 
and na.rysf in ('机关工人','事业工人')
and job not like '%期%' and jobsalary>0;
update adjustwage.normaladjust na,t127 set jobSalaryAfter = c06
where t127.c01 = '2016-07-01'  and na.unitId = concat(dwid,'')  and c05=job  and c08 = 11336
and na.rysf in ('事业工人')
and job  = '普通工' and jobsalary>0;
update adjustwage.normaladjust na,t127 set jobSalaryAfter = c06
where t127.c01 = '2016-07-01'  and na.unitId = concat(dwid,'')  and c05=job  and c08 = 11339
and na.rysf in ('事业工人')
and job  = '普通工(地勘)' and jobsalary>0;


-- 机关工人岗位工资
update adjustwage.normaladjust na,t127 set levelSalaryAfter = c06
where t127.c01 = '2016-07-01'  and na.unitId = concat(dwid,'')  and c05=job and c04 = ranklevel and c08 = '11333'
and na.rysf in ('机关工人')
and job not like '%期%' and ifnull(levelsalary,0)>0;
-- 事业工人岗位工资
update adjustwage.normaladjust na,t127 set levelSalaryAfter = c06
where t127.c01 = '2016-07-01'  and na.unitId = concat(dwid,'')   and c04 = ranklevel and c08 = '11336'
and na.rysf in ('事业工人') and job not like '%地勘%'
and job not like '%期%' and ifnull(levelsalary,0)>0;
update adjustwage.normaladjust na,t127 set levelSalaryAfter = c06
where t127.c01 = '2016-07-01'  and na.unitId = concat(dwid,'')   and c04 = ranklevel and c08 = '11339'
and na.rysf in ('事业工人') and job  like '%地勘%'
and job not like '%期%' and ifnull(levelsalary,0)>0;

-- 工人学徒期
update adjustwage.normaladjust na,t127 set jobSalaryAfter = c06
where t127.c01 = '2016-07-01'  and na.unitId = concat(dwid,'')  and c05 like '%期' and c04 = (select name from sys_s_data where id = (select c09 from data_record_t126 where id = recordId)) and c08 = 11336 and c05 = job
and na.rysf in ('事业工人')
and job  like '%期' and jobsalary>0;
update adjustwage.normaladjust na,t127 set jobSalaryAfter = c06
where t127.c01 = '2016-07-01'  and na.unitId = concat(dwid,'')  and c05 like '%期(地勘)' and c04 = (select name from sys_s_data where id = (select c09 from data_record_t126 where id = recordId))  and c08 = 11336 and c05 = job
and na.rysf in ('事业工人')
and job  like '%期(地勘)' and jobsalary>0;



update adjustwage.normaladjust set nt = 0.6 where unitId = concat(dwid,'') and  round(jobsalary/jobsalaryafter,2) =round(jobsalary/jobsalaryafter,2) 
and round(jobsalary/jobsalaryafter,2) = 0.6;
update adjustwage.normaladjust set nt = 0.7 where  unitId = concat(dwid,'') and  round(jobsalary/jobsalaryafter,2) =round(jobsalary/jobsalaryafter,2) 
and round(jobsalary/jobsalaryafter,2) = 0.7;
update adjustwage.normaladjust set nt = 0.75 where unitId = concat(dwid,'') and  round(jobsalary/jobsalaryafter,2) =round(jobsalary/jobsalaryafter,2) 
and round(jobsalary/jobsalaryafter,2) = 0.75;
update adjustwage.normaladjust set nt = 0.8 where   unitId = concat(dwid,'') and  round(jobsalary/jobsalaryafter,2) =round(jobsalary/jobsalaryafter,2) 
and round(jobsalary/jobsalaryafter,2) = 0.8;
update adjustwage.normaladjust set nt = 0.9 where   unitId = concat(dwid,'') and  round(jobsalary/jobsalaryafter,2) =round(jobsalary/jobsalaryafter,2)
and round(jobsalary/jobsalaryafter,2) = 0.9;



-- 计发生活费的人转移到异常人员表
insert into adjustwage.exadjust (unitId,ryId,rybh,name,sex,idcard,month,endSalaryTime,birthday,job,level,rankLevel,jobSalary,
levelSalary,teacherNurseUp10,specialTeach,subTotal,remark,nt,rysf,recordId)
select unitId,ryId,rybh,name,(select name from sys_s_data where id = (select c05 from t126 where id = ryid) ),idcard,month,
(select f26 from test1 where f1 = ryid ),(select f15 from test1 where f1 = ryid ),job,level,rankLevel,jobSalary,
levelSalary,teacherNurseUp10,specialTeach,subTotal,'其他',nt,rysf,recordId
from adjustwage.normaladjust where  unitId = concat(dwid,'') 
and exists(select 1 from adjustwage.normaladjust b where b.unitId = concat(dwid,'') and 
b.unitId =normaladjust.unitId and  b.ryid = normaladjust.ryid and (b.nt = 0.6 or b.nt = 0.75) )
and not exists(select 1 from adjustwage.exadjust where ryId = normaladjust.ryid);
-- 工资不是标准数据的传入异常表
delete a from adjustwage.normaladjust a,adjustwage.normaladjust b  where  a.unitId = concat(dwid,'') 
and a.unitid=b.unitid and a.ryid =b.ryid and (b.nt = 0.6 or b.nt = 0.75)
and exists(select 1 from adjustwage.exadjust where ryId = a.ryid);



-- 其他异常人员  工资！=标准的
insert into adjustwage.exadjust (unitId,ryId,rybh,name,sex,idcard,month,endSalaryTime,birthday,job,level,rankLevel,jobSalary,
levelSalary,teacherNurseUp10,specialTeach,subTotal,remark,nt,rysf,recordId)
select unitId,ryId,rybh,name,(select name from sys_s_data where id = (select c05 from t126 where id = ryid) ),idcard,month,
(select f26 from test1 where f1 = ryid ),(select f15 from test1 where f1 = ryid ),job,level,rankLevel,jobSalary,
levelSalary,teacherNurseUp10,specialTeach,subTotal,'其他',nt,rysf,recordId
from (
select unitId,ryId,rybh,name,(select name from sys_s_data where id = (select c05 from t126 where id = ryid) ),idcard,month,
(select f26 from test1 where f1 = ryid ),(select f15 from test1 where f1 = ryid ),job,level,rankLevel,jobSalary,
levelSalary,teacherNurseUp10,specialTeach,subTotal,'其他',nt,rysf,recordId
from (
 select (select c01 from smso.t111 where id = normaladjust.unitId) 单位代码,
 (select c02 from smso.t111 where id = normaladjust.unitId) 单位名称,
  (select name from smso.sys_s_data where id =(select c10 from  smso.t111 where id = normaladjust.unitId)) 单位级别,
	 rysf 人员身份,rybh 人员编号,name 姓名,month 月份,job 职务,
 (select c04 from smso.t127 where id =(select c27 from smso.data_record_t126 where id = recordId)) 是否领导,
level 级别,ranklevel 档次,jobsalary 职务工资,levelsalary 级别工资,teachernurseup10 `提高10%`,specialteach `提高15%`,subtotal 小计,
 jobsalaryafter 后职务工资,levelsalaryafter 后级别工资,teachernurseup10after `后提高10%`,specialteachafter `后提高15%`,subtotalafter 后小计,
 fill 补扣发,
 normaladjust.*  from adjustwage.normaladjust where unitid = dwid 
 and exists(select 1 from adjustwage.normaladjust b where b.unitId = concat(dwid,'') and 
b.unitId =normaladjust.unitId and  b.ryid = normaladjust.ryid and  ifnull(nt,'') not in (0.7,0.8,0.9)  and (round(ifnull(jobsalary,0))!=round(ifnull(jobsalaryafter,0)) or round(ifnull(levelsalary,0))!=round(ifnull(levelsalaryafter,0)))  )

 ) b
 where (单位级别 = '副地厅级' and 职务 not in('四级职员岗位','五级职员岗位'))
 or (单位级别 != '副地厅级' and 职务  in('四级职员岗位','五级职员岗位'))
 or (单位级别 != '副地厅级' and 职务 not in('四级职员岗位','五级职员岗位'))
 ) a;
 
 

 
 select GROUP_CONCAT(rybh ) into @temp
 from ( select DISTINCT rybh from adjustwage.exadjust where unitId =dwid  group by rybh having count(1)<6 ) aa;
  delete from adjustwage.exadjust where 
 locate(rybh ,@temp)>0;

 select 199,normaladjust.* from adjustwage.normaladjust where unitid = '1117' and rybh = '15100000007100184';
 
 -- select '存在于normaladjust的人员',normaladjust.* from adjustwage.normaladjust where exists(select 1 from  adjustwage.exadjust
 -- where ryid = normaladjust.ryid);
 
 delete from adjustwage.normaladjust where exists(select 1 from  adjustwage.exadjust
 where ryid = normaladjust.ryid);
-- delete  from adjustwage.normaladjust where
-- exists(select 1 from (
-- select id
-- from (
-- select *
-- from (
--  select (select c01 from smso.t111 where id = normaladjust.unitId) 单位代码,
--  (select c02 from smso.t111 where id = normaladjust.unitId) 单位名称,
--   (select name from smso.sys_s_data where id =(select c10 from  smso.t111 where id = normaladjust.unitId)) 单位级别,
-- 	 rysf 人员身份,rybh 人员编号,name 姓名,month 月份,job 职务,
--  (select c04 from smso.t127 where id =(select c27 from smso.data_record_t126 where id = recordId)) 是否领导,
-- level 级别,ranklevel 档次,jobsalary 职务工资,levelsalary 级别工资,teachernurseup10 `提高10%`,specialteach `提高15%`,subtotal 小计,
--  jobsalaryafter 后职务工资,levelsalaryafter 后级别工资,teachernurseup10after `后提高10%`,specialteachafter `后提高15%`,subtotalafter 后小计,
--  fill 补扣发,
--  normaladjust.*  from adjustwage.normaladjust where unitid = dwid 
--  and exists(select 1 from adjustwage.normaladjust b where b.unitId = concat(dwid,'') and 
-- b.unitId =normaladjust.unitId and  b.ryid = normaladjust.ryid and  ifnull(nt,'') not in (0.7,0.8,0.9)  and (round(ifnull(jobsalary,0))!=round(ifnull(jobsalaryafter,0)) or round(ifnull(levelsalary,0))!=round(ifnull(levelsalaryafter,0)))  )
-- 
--  ) b
--  where (单位级别 = '副地厅级' and 职务 not in('四级职员岗位','五级职员岗位'))
--  or (单位级别 != '副地厅级' and 职务  in('四级职员岗位','五级职员岗位'))
--  or (单位级别 != '副地厅级' and 职务 not in('四级职员岗位','五级职员岗位'))
--  
--  ) a ) c where c.id = normaladjust.id );




-- 18年标准
-- 运动员基础津贴
update adjustwage.normaladjust na,t127 set jobSalaryAfter = c06
where t127.c01 = '2018-07-01' and na.unitId = concat(dwid,'')  and c05=job and c08='11340'
and na.rysf in ('运动员')
and job not like '%期%' and jobsalary>0;
-- 运动员成绩津贴
update adjustwage.normaladjust na,t127 set levelSalaryAfter = c06
where t127.c01 = '2018-07-01' and na.unitId = concat(dwid,'')  and c05=level and c04=ranklevel
and na.rysf in ('运动员')
and job not like '%期%' and jobsalary>0;
-- 公务员类非试用期的职务工资
update adjustwage.normaladjust na,t127 set jobSalaryAfter = c06
where t127.c01 = '2018-07-01'  and na.unitId = concat(dwid,'')  and c05=job and c04 = (select c04 from t127 where id = (select c27 from data_record_t126 where id = recordId))
and na.rysf in ('综合类公务员','参公人员','行政执法类公务员','专业技术公务员','司法行政人员','司法辅助人员','人民警察')
-- and  job not in ('一级调研员','三级调研员','一级主任科员','三级主任科员','四级警长','一级警员')
and job not like '%期%' and jobsalary>0;


-- 公务员类试用期的职务工资
update adjustwage.normaladjust na,t127 set jobSalaryAfter = c06
where t127.c01 = '2018-07-01'   and na.unitId = concat(dwid,'')  and c05 like '%试用期%' and c04 = (select name from sys_s_data where id = (select c09 from data_record_t126 where id = recordId))
and na.rysf in ('综合类公务员','参公人员','行政执法类公务员','专业技术公务员','司法行政人员','司法辅助人员','人民警察')
and job  like '%期%' and jobsalary>0;
-- 公务员类非试用期的级别工资
update adjustwage.normaladjust na,t127 set levelSalaryAfter = c06
where t127.c01 = '2018-07-01'  and na.unitId = concat(dwid,'')  and c05=level and c04 = ranklevel
and na.rysf in ('综合类公务员','参公人员','行政执法类公务员','专业技术公务员','司法行政人员','司法辅助人员','人民警察')
-- and  job not in ('一级调研员','三级调研员','一级主任科员','三级主任科员','四级警长','一级警员')
and job not like '%期%' and ifnull(levelsalary,0)>0;




-- 事业管理的职务工资
update adjustwage.normaladjust na,t127 set jobSalaryAfter = c06
where t127.c01 = '2018-07-01'  and na.unitId = concat(dwid,'')  and c05=job and c04 = (select c04 from t127 where id = (select c27 from data_record_t126 where id = recordId))
and na.rysf in ('管理人员') and c08 = 11334 and job not like '%地勘%'
and job not like '%期%' and jobsalary>0;
-- update adjustwage.normaladjust na,t127 set jobSalaryAfter = c06
-- where t127.c01 = '2018-07-01'  and na.unitId = concat(dwid,'')  and c05=job and c04 = (select c04 from t127 where id = (select c27 from data_record_t126 where id = recordId))
-- and na.rysf in ('管理人员') and c08 = 11337 and job  like '%地勘%'
-- and job not like '%期%' and jobsalary>0;
-- 非副厅级单位四五级职员领导读非领导的工资
update adjustwage.normaladjust na,t127 set jobSalaryAfter= c06
where  c05 = job  and na.unitId = concat(dwid,'')  and c04 = '非领导职务' and c01 = '2018-07-01' and na.rysf in ('管理人员')
and not exists(select 1 from t111 where id = unitId and c10=10324);


-- 事业专技的职务工资
update adjustwage.normaladjust na,t127 set jobSalaryAfter = c06
where t127.c01 = '2018-07-01'  and na.unitId = concat(dwid,'')  and c05=job 
and na.rysf in ('专业技术人员') and c08 = 11335 and job not like '%地勘%'
and job not like '%期%' and jobsalary>0;
-- update adjustwage.normaladjust na,t127 set jobSalaryAfter = c06
-- where t127.c01 = '2018-07-01'  and na.unitId = concat(dwid,'')  and c05=job 
-- and na.rysf in ('专业技术人员') and c08 = 11338 and job  like '%地勘%'
-- and job not like '%期%' and jobsalary>0;

-- 事业试用期职务工资】
update adjustwage.normaladjust na,t127 set jobSalaryAfter = c06
where t127.c01 = '2018-07-01'  and na.unitId = concat(dwid,'')  and c05 like '%试用期' and c04 = (select name from sys_s_data where id = (select c09 from data_record_t126 where id = recordId))
and na.rysf in ('管理人员','专业技术人员')
and job  like '%期' and jobsalary>0;

-- 地勘试用期职务工资
-- update adjustwage.normaladjust na,t127 set jobSalaryAfter = c06
-- where t127.c01 = '2018-07-01'  and na.unitId = concat(dwid,'')  and c05 like '%试用期(地勘)' and c04 = (select name from sys_s_data where id = (select c09 from data_record_t126 where id = recordId))
-- and na.rysf in ('管理人员','专业技术人员')
-- and job  like '%期(地勘)' and jobsalary>0;


-- 事业薪级工资
update adjustwage.normaladjust na,t127 set levelSalaryAfter = c06
where t127.c01 = '2018-07-01'  and na.unitId = concat(dwid,'')  and  c04 = ranklevel and job not like '%地勘%'
and na.rysf in ('管理人员') and c08 =11334 
and job not like '%期%' and ifnull(levelsalary,0)>0;
update adjustwage.normaladjust na,t127 set levelSalaryAfter = c06
where t127.c01 = '2018-07-01'  and na.unitId = concat(dwid,'')  and  c04 = ranklevel and job not like '%地勘%'
and na.rysf in ('专业技术人员') and c08 =11335
and job not like '%期%' and ifnull(levelsalary,0)>0;

-- update adjustwage.normaladjust na,t127 set levelSalaryAfter = c06
-- where t127.c01 = '2018-07-01'  and na.unitId = concat(dwid,'')  and  c04 = ranklevel and job  like '%地勘%'
-- and na.rysf in ('管理人员') and c08 =11337
-- and job not like '%期%' and ifnull(levelsalary,0)>0;
-- update adjustwage.normaladjust na,t127 set levelSalaryAfter = c06
-- where t127.c01 = '2018-07-01'  and na.unitId = concat(dwid,'')  and  c04 = ranklevel and job  like '%地勘%'
-- and na.rysf in ('专业技术人员') and c08 =11338
-- and job not like '%期%' and ifnull(levelsalary,0)>0;


-- 法检职务工资
update adjustwage.normaladjust na,t127 set jobSalaryAfter = c06
where t127.c01 = '2018-07-01'   and na.unitId = concat(dwid,'') and c05=job and c04 = ranklevel
and na.rysf in ('员额内法官','员额内检察官')
and job not like '%期%' and jobsalary>0;



-- 工人技术等级工资
update adjustwage.normaladjust na,t127 set jobSalaryAfter = c06
where t127.c01 = '2018-07-01'  and na.unitId = concat(dwid,'')  and c05=job 
and na.rysf in ('机关工人','事业工人')
and job not like '%期%' and jobsalary>0;
update adjustwage.normaladjust na,t127 set jobSalaryAfter = c06
where t127.c01 = '2018-07-01'  and na.unitId = concat(dwid,'')  and c05=job  and c08 = 11336
and na.rysf in ('事业工人')
and job  = '普通工' and jobsalary>0;
-- update adjustwage.normaladjust na,t127 set jobSalaryAfter = c06
-- where t127.c01 = '2018-07-01'  and na.unitId = concat(dwid,'')  and c05=job  and c08 = 11339
-- and na.rysf in ('事业工人')
-- and job  = '普通工(地勘)' and jobsalary>0;


-- 机关工人岗位工资
update adjustwage.normaladjust na,t127 set levelSalaryAfter = c06
where t127.c01 = '2018-07-01'  and na.unitId = concat(dwid,'')  and c05=job and c04 = ranklevel and c08 = '11333'
and na.rysf in ('机关工人')
and job not like '%期%' and ifnull(levelsalary,0)>0;
-- 事业工人岗位工资
update adjustwage.normaladjust na,t127 set levelSalaryAfter = c06
where t127.c01 = '2018-07-01'   and na.unitId = concat(dwid,'')  and c04 = ranklevel and c08 = '11336'  and job not like '%地勘%'
and na.rysf in ('事业工人') and c08 =11336
and job not like '%期%' and ifnull(levelsalary,0)>0;
-- update adjustwage.normaladjust na,t127 set levelSalaryAfter = c06
-- where t127.c01 = '2018-07-01'   and na.unitId = concat(dwid,'')  and c04 = ranklevel and c08 = '11336'  and job  like '%地勘%'
-- and na.rysf in ('事业工人') and c08 =11339
-- and job not like '%期%' and ifnull(levelsalary,0)>0;

-- 工人学徒期
update adjustwage.normaladjust na,t127 set jobSalaryAfter = c06
where t127.c01 = '2018-07-01'  and na.unitId = concat(dwid,'')  and c05 like '%期' and c04 = (select name from sys_s_data where id = (select c09 from data_record_t126 where id = recordId))  and c08 = 11336 and c05 = job
and na.rysf in ('事业工人')
and job  like '%期' and jobsalary>0;
-- update adjustwage.normaladjust na,t127 set jobSalaryAfter = c06
-- where t127.c01 = '2018-07-01'  and na.unitId = concat(dwid,'')  and c05 like '%期(地勘)' and c04 = (select name from sys_s_data where id = (select c09 from data_record_t126 where id = recordId))  and c08 = 11336 and c05 = job
-- and na.rysf in ('事业工人')
-- and job  like '%期(地勘)' and jobsalary>0;
-- 


update adjustwage.normaladjust set  jobsalaryafter = round(jobsalaryafter*nt  ) , levelsalaryafter = round(levelsalaryafter*nt  )
where   unitId = concat(dwid,'') and nt in (0.7,0.8,0.9);



-- 提高10%
update adjustwage.normaladjust  
set teacherNurseup10after = round((ifnull(jobsalaryafter,0)+ifnull(levelsalaryafter,0))*0.1)
where   unitId = concat(dwid,'') and   ifnull(teacherNurseup10,0)>0;
-- 提高15%
update adjustwage.normaladjust  
set specialteachafter = round((ifnull(jobsalaryafter,0)+ifnull(levelsalaryafter,0)+ifnull(teacherNurseup10after,0))*0.15)
where unitId = concat(dwid,'') and  ifnull(specialteach,0)>0;

-- 小计 
update adjustwage.normaladjust  
set  subtotalafter= (ifnull(jobsalaryafter,0)+ifnull(levelsalaryafter,0)+ifnull(teacherNurseup10after,0)
+ifnull(specialteachafter,0))
where unitId = concat(dwid,'') and  ifnull(subtotal,0)>0;

-- 补扣发 
update adjustwage.normaladjust  
set  fill= (ifnull(subtotalafter,0)-ifnull(subtotal,0))
where unitId = concat(dwid,'') and  ifnull(subtotal,0)>0 ;
-- and  job not in ('一级调研员','三级调研员','一级主任科员','三级主任科员','四级警长','一级警员')
-- and  rysf not  in ('员额内法官','员额内检察官');



update adjustwage.exadjust set jobsalary=0,levelsalary=0,teacherNurseUp10=0,specialTeach=0,subTotal=0,nt='减少人员设置后续工资为0'
where unitId=dwid  and substr(endsalarytime from 6 for 2)<=month and endsalarytime<='2018-12';



-- 退休减少人员设置减少后工资为0   但是保留13新
update adjustwage.normaladjust,data_record_t126 t126,data_record_t125 t125 set jobsalary=0,levelsalary=0,teacherNurseUp10=0,specialTeach=0,subTotal=0,nt='减少人员设置后续工资为0',
jobsalaryAfter=0,levelsalaryAfter=0,teacherNurseUp10After=0,specialTeachAfter=0,subTotalAfter=0,fill=0
where normaladjust.unitId=dwid and t126.c01 = concat(dwid,'') and ryid = t126.dataid -- and t125.c06 = concat(t126.dataid,'')
and t126.c40 = '10831' and t125.changesign = t126.changesign and ifnull(t126.c46,'')=10489 and month <13
and (month>=substr(t125.c02 from 6 for 2) and t125.c02 <='2018-12' and t126.allAuditFlag=2);
-- 非退休减少人员设置减少后工资为0   不保留13新
update adjustwage.normaladjust,data_record_t126 t126,data_record_t125 t125 set jobsalary=0,levelsalary=0,teacherNurseUp10=0,specialTeach=0,subTotal=0,nt='减少人员设置后续工资为0',
jobsalaryAfter=0,levelsalaryAfter=0,teacherNurseUp10After=0,specialTeachAfter=0,subTotalAfter=0,fill=0
where normaladjust.unitId=dwid and t126.c01 = concat(dwid,'') and ryid = t126.dataid -- and t125.c06 = concat(t126.dataid,'')
and t126.c40 = '10831' and t125.changesign = t126.changesign and ifnull(t126.c46,'')!=10489 
and (month>=substr(t125.c02 from 6 for 2) and t125.c02 <='2018-12' and t126.allAuditFlag=2);




	
			
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`adjustNormal`()
label_pro:BEGIN	

insert into adjustwage.normaladjust(unitId,ryId,rybh,name,idcard,month,job,level,rankLevel,jobSalary,levelSalary,teacherNurseUp10,specialTeach,subTotal,rysf,recordId)
select f2,f1,f3,f4,f5,7,-- 工资职级,级别,档次,职务工资,级别工资,提高10%,提高15%,小计,'停发工资人员',人员身份
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 ) and allauditflag =2  and c02<='2018-07'  ) and t126.allAuditFlag =2 )),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 ) and allauditflag =2  and c02<='2018-07'  ) and t126.allAuditFlag =2 )),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 ) and allauditflag =2  and c02<='2018-07'  ) and t126.allAuditFlag =2 )),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 ) and allauditflag =2  and c02<='2018-07'  ) and t126.allAuditFlag =2 )*1+0,
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 ) and allauditflag =2  and c02<='2018-07'  ) and t126.allAuditFlag =2 )*1+0,
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 ) and allauditflag =2  and c02<='2018-07'  ) and t126.allAuditFlag =2 )*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 ) and allauditflag =2  and c02<='2018-07'  ) and t126.allAuditFlag =2 )*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0)) from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 ) and allauditflag =2  and c02<='2018-07'  ) and t126.allAuditFlag =2 ),
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 ) and allauditflag =2  and c02<='2018-07'  ) and t126.allAuditFlag =2 )),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 ) and allauditflag =2  and c02<='2018-07'  ) and t126.allAuditFlag =2 )
from test1 where  
not exists(select 1 from adjustwage.exadjust where ryid=f1)
and not exists(select 1 from adjustwage.ywjyadjust where ryid=f1)
and f3 not like '%T'
and ifnull(f26,'2018-12')>'2018-07'
 and exists(select 1 from t111 where id = f2);
 
 


/*insert into adjustwage.normaladjust(unitId,ryId,rybh,name,idcard,month,job,level,rankLevel,jobSalary,levelSalary,teacherNurseUp10,specialTeach,subTotal,rysf)
select c01,id,c02,c04,c07,8,
(select c05 from t127 where id = (select t126r.c17 from data_record_t126 t126r,data_record_t125 t125r 
where t126r.c01=t126.c01 and t125r.c05 = t126.c01 and  t126r.dataid = t126.id and t125r.c06 = concat(t126.id,'') and t125r.changesign=t126r.changesign and t125r.id =(
select max(id) from data_record_t125 where c05=concat(t126.c01,'') and  c06 =concat(t126.id,'') and c02<='2018-08'  ))),
(select c05 from t127 where id = (select t125r.c07 from data_record_t126 t126r,data_record_t125 t125r 
where t126r.c01=t126.c01 and t125r.c05 = t126.c01 and  t126r.dataid = t126.id and t125r.c06 = concat(t126.id,'') and t125r.changesign=t126r.changesign and t125r.id =(
select max(id) from data_record_t125 where c05=concat(t126.c01,'') and  c06 =concat(t126.id,'') and c02<='2018-08'  ))),
(select c04 from t127 where id = (select t125r.c09 from data_record_t126 t126r,data_record_t125 t125r 
where t126r.c01=t126.c01 and t125r.c05 = t126.c01 and  t126r.dataid = t126.id and t125r.c06 = concat(t126.id,'') and t125r.changesign=t126r.changesign and t125r.id =(
select max(id) from data_record_t125 where c05=concat(t126.c01,'') and  c06 =concat(t126.id,'') and c02<='2018-08'  ))),
(select t125r.c25 from data_record_t126 t126r,data_record_t125 t125r 
where t126r.c01=t126.c01 and t125r.c05 = t126.c01 and  t126r.dataid = t126.id and t125r.c06 = concat(t126.id,'') and t125r.changesign=t126r.changesign and t125r.id =(
select max(id) from data_record_t125 where c05=concat(t126.c01,'') and  c06 =concat(t126.id,'') and c02<='2018-08'  ))*1+0,
(select t125r.c26 from data_record_t126 t126r,data_record_t125 t125r 
where t126r.c01=t126.c01 and t125r.c05 = t126.c01 and  t126r.dataid = t126.id and t125r.c06 = concat(t126.id,'') and t125r.changesign=t126r.changesign and t125r.id =(
select max(id) from data_record_t125 where c05=concat(t126.c01,'') and  c06 =concat(t126.id,'') and c02<='2018-08'  ))*1+0,
ifnull((select t125r.c28 from data_record_t126 t126r,data_record_t125 t125r 
where t126r.c01=t126.c01 and t125r.c05 = t126.c01 and  t126r.dataid = t126.id and t125r.c06 = concat(t126.id,'') and t125r.changesign=t126r.changesign and t125r.id =(
select max(id) from data_record_t125 where c05=concat(t126.c01,'') and  c06 =concat(t126.id,'') and c02<='2018-08'  ))*1+0,0),
ifnull((select t125r.c29 from data_record_t126 t126r,data_record_t125 t125r 
where t126r.c01=t126.c01 and t125r.c05 = t126.c01 and  t126r.dataid = t126.id and t125r.c06 = concat(t126.id,'') and t125r.changesign=t126r.changesign and t125r.id =(
select max(id) from data_record_t125 where c05=concat(t126.c01,'') and  c06 =concat(t126.id,'') and c02<='2018-08'  ))*1+0,0),
(select t125r.c32 from data_record_t126 t126r,data_record_t125 t125r 
where t126r.c01=t126.c01 and t125r.c05 = t126.c01 and  t126r.dataid = t126.id and t125r.c06 = concat(t126.id,'') and t125r.changesign=t126r.changesign and t125r.id =(
select max(id) from data_record_t125 where c05=concat(t126.c01,'') and  c06 =concat(t126.id,'') and c02<='2018-08'  )),
(select name from sys_s_data where id = (select t126r.c28 from data_record_t126 t126r,data_record_t125 t125r 
where t126r.c01=t126.c01 and t125r.c05 = t126.c01 and  t126r.dataid = t126.id and t125r.c06 = concat(t126.id,'') and t125r.changesign=t126r.changesign and t125r.id =(
select max(id) from data_record_t125 where c05=concat(t126.c01,'') and  c06 =concat(t126.id,'') and c02<='2018-08'  )))
from t126 where c03!=10372 and 
c28!=10522 
and not exists(select 1 from t127 where id = t126.c17 and c05 like '%地勘%')
and  not exists(select 1 from adjustwage.exadjust where ryid=t126.id);*/


insert into adjustwage.normaladjust(unitId,ryId,rybh,name,idcard,month,job,level,rankLevel,jobSalary,levelSalary,teacherNurseUp10,specialTeach,subTotal,rysf,recordId)
select f2,f1,f3,f4,f5,8,-- 工资职级,级别,档次,职务工资,级别工资,提高10%,提高15%,小计,'停发工资人员',人员身份
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 ) and allauditflag =2  and c02<='2018-08'  ) and t126.allAuditFlag =2 )),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 ) and allauditflag =2  and c02<='2018-08'  ) and t126.allAuditFlag =2 )),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 ) and allauditflag =2  and c02<='2018-08'  ) and t126.allAuditFlag =2 )),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 ) and allauditflag =2  and c02<='2018-08'  ) and t126.allAuditFlag =2 )*1+0,
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 ) and allauditflag =2  and c02<='2018-08'  ) and t126.allAuditFlag =2 )*1+0,
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 ) and allauditflag =2  and c02<='2018-08'  ) and t126.allAuditFlag =2 )*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 ) and allauditflag =2  and c02<='2018-08'  ) and t126.allAuditFlag =2 )*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0)) from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 ) and allauditflag =2  and c02<='2018-08'  ) and t126.allAuditFlag =2 ),
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 ) and allauditflag =2  and c02<='2018-08'  ) and t126.allAuditFlag =2 )),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 ) and allauditflag =2  and c02<='2018-08'  ) and t126.allAuditFlag =2 )
from test1 where  
not exists(select 1 from adjustwage.exadjust where ryid=f1)
and not exists(select 1 from adjustwage.ywjyadjust where ryid=f1)
and f3 not like '%T'
and ifnull(f26,'2018-12')>'2018-07'
 and exists(select 1 from t111 where id = f2);
 
insert into adjustwage.normaladjust(unitId,ryId,rybh,name,idcard,month,job,level,rankLevel,jobSalary,levelSalary,teacherNurseUp10,specialTeach,subTotal,rysf,recordId)
select f2,f1,f3,f4,f5,9,-- 工资职级,级别,档次,职务工资,级别工资,提高10%,提高15%,小计,'停发工资人员',人员身份
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 ) and allauditflag =2  and c02<='2018-09'  ) and t126.allAuditFlag =2 )),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 ) and allauditflag =2  and c02<='2018-09'  ) and t126.allAuditFlag =2 )),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 ) and allauditflag =2  and c02<='2018-09'  ) and t126.allAuditFlag =2 )),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 ) and allauditflag =2  and c02<='2018-09'  ) and t126.allAuditFlag =2 )*1+0,
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 ) and allauditflag =2  and c02<='2018-09'  ) and t126.allAuditFlag =2 )*1+0,
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 ) and allauditflag =2  and c02<='2018-09'  ) and t126.allAuditFlag =2 )*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 ) and allauditflag =2  and c02<='2018-09'  ) and t126.allAuditFlag =2 )*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0)) from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 ) and allauditflag =2  and c02<='2018-09'  ) and t126.allAuditFlag =2 ),
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 ) and allauditflag =2  and c02<='2018-09'  ) and t126.allAuditFlag =2 )),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 ) and allauditflag =2  and c02<='2018-09'  ) and t126.allAuditFlag =2 )
from test1 where  
not exists(select 1 from adjustwage.exadjust where ryid=f1)
and not exists(select 1 from adjustwage.ywjyadjust where ryid=f1)
and f3 not like '%T'
and ifnull(f26,'2018-12')>'2018-07'
 and exists(select 1 from t111 where id = f2);
 
insert into adjustwage.normaladjust(unitId,ryId,rybh,name,idcard,month,job,level,rankLevel,jobSalary,levelSalary,teacherNurseUp10,specialTeach,subTotal,rysf,recordId)
select f2,f1,f3,f4,f5,10,-- 工资职级,级别,档次,职务工资,级别工资,提高10%,提高15%,小计,'停发工资人员',人员身份
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 ) and allauditflag =2  and c02<='2018-10'  ) and t126.allAuditFlag =2 )),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 ) and allauditflag =2  and c02<='2018-10'  ) and t126.allAuditFlag =2 )),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 ) and allauditflag =2  and c02<='2018-10'  ) and t126.allAuditFlag =2 )),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 ) and allauditflag =2  and c02<='2018-10'  ) and t126.allAuditFlag =2 )*1+0,
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 ) and allauditflag =2  and c02<='2018-10'  ) and t126.allAuditFlag =2 )*1+0,
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 ) and allauditflag =2  and c02<='2018-10'  ) and t126.allAuditFlag =2 )*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 ) and allauditflag =2  and c02<='2018-10'  ) and t126.allAuditFlag =2 )*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0)) from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 ) and allauditflag =2  and c02<='2018-10'  ) and t126.allAuditFlag =2 ),
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 ) and allauditflag =2  and c02<='2018-10'  ) and t126.allAuditFlag =2 )),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 ) and allauditflag =2  and c02<='2018-10'  ) and t126.allAuditFlag =2 )
from test1 where  
not exists(select 1 from adjustwage.exadjust where ryid=f1)
and not exists(select 1 from adjustwage.ywjyadjust where ryid=f1)
and f3 not like '%T'
and ifnull(f26,'2018-12')>'2018-07'
 and exists(select 1 from t111 where id = f2);
 
insert into adjustwage.normaladjust(unitId,ryId,rybh,name,idcard,month,job,level,rankLevel,jobSalary,levelSalary,teacherNurseUp10,specialTeach,subTotal,rysf,recordId)
select f2,f1,f3,f4,f5,11,-- 工资职级,级别,档次,职务工资,级别工资,提高10%,提高15%,小计,'停发工资人员',人员身份
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 ) and allauditflag =2  and c02<='2018-11'  ) and t126.allAuditFlag =2 )),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 ) and allauditflag =2  and c02<='2018-11'  ) and t126.allAuditFlag =2 )),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 ) and allauditflag =2  and c02<='2018-11'  ) and t126.allAuditFlag =2 )),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 ) and allauditflag =2  and c02<='2018-11'  ) and t126.allAuditFlag =2 )*1+0,
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 ) and allauditflag =2  and c02<='2018-11'  ) and t126.allAuditFlag =2 )*1+0,
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 ) and allauditflag =2  and c02<='2018-11'  ) and t126.allAuditFlag =2 )*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 ) and allauditflag =2  and c02<='2018-11'  ) and t126.allAuditFlag =2 )*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0)) from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 ) and allauditflag =2  and c02<='2018-11'  ) and t126.allAuditFlag =2 ),
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 ) and allauditflag =2  and c02<='2018-11'  ) and t126.allAuditFlag =2 )),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 ) and allauditflag =2  and c02<='2018-11'  ) and t126.allAuditFlag =2 )
from test1 where  
not exists(select 1 from adjustwage.exadjust where ryid=f1)
and not exists(select 1 from adjustwage.ywjyadjust where ryid=f1)
and f3 not like '%T'
and ifnull(f26,'2018-12')>'2018-07'
 and exists(select 1 from t111 where id = f2);
 
insert into adjustwage.normaladjust(unitId,ryId,rybh,name,idcard,month,job,level,rankLevel,jobSalary,levelSalary,teacherNurseUp10,specialTeach,subTotal,rysf,recordId)
select f2,f1,f3,f4,f5,12,
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 ) and allauditflag =2  and c02<='2018-12'  ) and t126.allAuditFlag =2 )),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 ) and allauditflag =2  and c02<='2018-12'  ) and t126.allAuditFlag =2 )),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 ) and allauditflag =2  and c02<='2018-12'  ) and t126.allAuditFlag =2 )),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 ) and allauditflag =2  and c02<='2018-12'  ) and t126.allAuditFlag =2 )*1+0,
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 ) and allauditflag =2  and c02<='2018-12'  ) and t126.allAuditFlag =2 )*1+0,
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 ) and allauditflag =2  and c02<='2018-12'  ) and t126.allAuditFlag =2 )*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 ) and allauditflag =2  and c02<='2018-12'  ) and t126.allAuditFlag =2 )*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0)) from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 ) and allauditflag =2  and c02<='2018-12'  ) and t126.allAuditFlag =2 ),
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 ) and allauditflag =2  and c02<='2018-12'  ) and t126.allAuditFlag =2 )),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 ) and allauditflag =2  and c02<='2018-12'  ) and t126.allAuditFlag =2 )
from test1 where  
not exists(select 1 from adjustwage.exadjust where ryid=f1)
and not exists(select 1 from adjustwage.ywjyadjust where ryid=f1)
and f3 not like '%T'
and ifnull(f26,'2018-12')>'2018-07'
 and exists(select 1 from t111 where id = f2);



insert into adjustwage.normaladjust(unitId,ryId,rybh,name,idcard,month,job,level,rankLevel,jobSalary,levelSalary,teacherNurseUp10,specialTeach,subTotal,rysf,recordId)
select f2,f1,f3,f4,f5,13,
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06  IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 ) and allauditflag=2   and c02<='2018-12'  and changetype!='10831'  ) and t126.allAuditFlag =2 )),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06  IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 )  and allauditflag=2   and c02<='2018-12'  and changetype!='10831'  ) and t126.allAuditFlag =2 )),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06  IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 )  and allauditflag=2   and c02<='2018-12'  and changetype!='10831'  ) and t126.allAuditFlag =2 )),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06  IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 )  and allauditflag=2   and c02<='2018-12'  and changetype!='10831'  ) and t126.allAuditFlag =2 )*1+0,
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06  IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 )  and allauditflag=2   and c02<='2018-12'  and changetype!='10831'  ) and t126.allAuditFlag =2 )*1+0,
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06  IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 )  and allauditflag=2   and c02<='2018-12' and changetype!='10831'   ) and t126.allAuditFlag =2 )*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06  IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 )  and allauditflag=2   and c02<='2018-12'  and changetype!='10831'  ) and t126.allAuditFlag =2 )*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0)) from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06  IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 )  and allauditflag=2   and c02<='2018-12'  and changetype!='10831'  ) and t126.allAuditFlag =2 ),
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06  IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 ) and allauditflag=2    and c02<='2018-12'  and changetype!='10831'  ) and t126.allAuditFlag =2 )),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'')  and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06  IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2 )  and allauditflag=2   and c02<='2018-12'  and changetype!='10831'  ) and t126.allAuditFlag =2 )
from test1 
where
not exists(select 1 from adjustwage.exadjust where ryid=f1)
and not exists(select 1 from adjustwage.ywjyadjust where ryid=f1)
and f3 not like '%T'

and ifnull(f26,'2018-12')>'2018-07'
and exists(select 1 from t111 where id = f2 and ((c05 in ('10295','10821') or c19='10487') and id!=1469))

 and exists(select 1 from t111 where id = f2);





delete from adjustwage.normaladjust  where rysf = '机关离休干部';
-- delete from adjustwage.normaladjust  where job like '%地勘%';















	
			
END ;;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`adjustNormalByUnitId`(IN dwid int(11))
label_pro:BEGIN	

insert into adjustwage.normaladjust(unitId,ryId,rybh,name,idcard,month,job,level,rankLevel,jobSalary,levelSalary,teacherNurseUp10,specialTeach,subTotal,rysf,recordId)
select f2,f1,f3,f4,f5,7,-- 工资职级,级别,档次,职务工资,级别工资,提高10%,提高15%,小计,'停发工资人员',人员身份
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2) and allauditflag=2 and c02<='2018-07'
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
  ) and t126.allauditflag=2 )),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2) and allauditflag=2 and c02<='2018-07'
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
  ) and t126.allauditflag=2 )),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2) and allauditflag=2 and c02<='2018-07' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag=2 )),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2) and allauditflag=2 and c02<='2018-07' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag=2 )*1+0,
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2) and allauditflag=2 and c02<='2018-07' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag=2 )*1+0,
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2) and allauditflag=2 and c02<='2018-07' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag=2 )*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2) and allauditflag=2 and c02<='2018-07' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag=2 )*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0)) from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2) and allauditflag=2 and c02<='2018-07' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag=2 ),
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2) and allauditflag=2 and c02<='2018-07' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag=2 )),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2) and allauditflag=2 and c02<='2018-07' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag=2 )
from test1 where  f2 = concat(dwid,'') and  
not exists(select 1 from adjustwage.exadjust where ryid=f1)
and not exists(select 1 from adjustwage.ywjyadjust where ryid=f1)
and f3 not like '%T'
and ifnull(f26,'2018-12')>'2018-07'
 and exists(select 1 from t111 where id = f2);
 
 


/*insert into adjustwage.normaladjust(unitId,ryId,rybh,name,idcard,month,job,level,rankLevel,jobSalary,levelSalary,teacherNurseUp10,specialTeach,subTotal,rysf)
select c01,id,c02,c04,c07,8,
(select c05 from t127 where id = (select t126r.c17 from data_record_t126 t126r,data_record_t125 t125r 
where t126r.c01=t126.c01 and t125r.c05 = t126.c01 and  t126r.dataid = t126.id and t125r.c06 = concat(t126.id,'') and t125r.changesign=t126r.changesign and t125r.id =(
select max(id) from data_record_t125 where c05=concat(t126.c01,'') and  c06 =concat(t126.id,'') and c02<='2018-08'  ))),
(select c05 from t127 where id = (select t125r.c07 from data_record_t126 t126r,data_record_t125 t125r 
where t126r.c01=t126.c01 and t125r.c05 = t126.c01 and  t126r.dataid = t126.id and t125r.c06 = concat(t126.id,'') and t125r.changesign=t126r.changesign and t125r.id =(
select max(id) from data_record_t125 where c05=concat(t126.c01,'') and  c06 =concat(t126.id,'') and c02<='2018-08'  ))),
(select c04 from t127 where id = (select t125r.c09 from data_record_t126 t126r,data_record_t125 t125r 
where t126r.c01=t126.c01 and t125r.c05 = t126.c01 and  t126r.dataid = t126.id and t125r.c06 = concat(t126.id,'') and t125r.changesign=t126r.changesign and t125r.id =(
select max(id) from data_record_t125 where c05=concat(t126.c01,'') and  c06 =concat(t126.id,'') and c02<='2018-08'  ))),
(select t125r.c25 from data_record_t126 t126r,data_record_t125 t125r 
where t126r.c01=t126.c01 and t125r.c05 = t126.c01 and  t126r.dataid = t126.id and t125r.c06 = concat(t126.id,'') and t125r.changesign=t126r.changesign and t125r.id =(
select max(id) from data_record_t125 where c05=concat(t126.c01,'') and  c06 =concat(t126.id,'') and c02<='2018-08'  ))*1+0,
(select t125r.c26 from data_record_t126 t126r,data_record_t125 t125r 
where t126r.c01=t126.c01 and t125r.c05 = t126.c01 and  t126r.dataid = t126.id and t125r.c06 = concat(t126.id,'') and t125r.changesign=t126r.changesign and t125r.id =(
select max(id) from data_record_t125 where c05=concat(t126.c01,'') and  c06 =concat(t126.id,'') and c02<='2018-08'  ))*1+0,
ifnull((select t125r.c28 from data_record_t126 t126r,data_record_t125 t125r 
where t126r.c01=t126.c01 and t125r.c05 = t126.c01 and  t126r.dataid = t126.id and t125r.c06 = concat(t126.id,'') and t125r.changesign=t126r.changesign and t125r.id =(
select max(id) from data_record_t125 where c05=concat(t126.c01,'') and  c06 =concat(t126.id,'') and c02<='2018-08'  ))*1+0,0),
ifnull((select t125r.c29 from data_record_t126 t126r,data_record_t125 t125r 
where t126r.c01=t126.c01 and t125r.c05 = t126.c01 and  t126r.dataid = t126.id and t125r.c06 = concat(t126.id,'') and t125r.changesign=t126r.changesign and t125r.id =(
select max(id) from data_record_t125 where c05=concat(t126.c01,'') and  c06 =concat(t126.id,'') and c02<='2018-08'  ))*1+0,0),
(select t125r.c32 from data_record_t126 t126r,data_record_t125 t125r 
where t126r.c01=t126.c01 and t125r.c05 = t126.c01 and  t126r.dataid = t126.id and t125r.c06 = concat(t126.id,'') and t125r.changesign=t126r.changesign and t125r.id =(
select max(id) from data_record_t125 where c05=concat(t126.c01,'') and  c06 =concat(t126.id,'') and c02<='2018-08'  )),
(select name from sys_s_data where id = (select t126r.c28 from data_record_t126 t126r,data_record_t125 t125r 
where t126r.c01=t126.c01 and t125r.c05 = t126.c01 and  t126r.dataid = t126.id and t125r.c06 = concat(t126.id,'') and t125r.changesign=t126r.changesign and t125r.id =(
select max(id) from data_record_t125 where c05=concat(t126.c01,'') and  c06 =concat(t126.id,'') and c02<='2018-08'  )))
from t126 where c03!=10372 and 
c28!=10522 
and not exists(select 1 from t127 where id = t126.c17 and c05 like '%地勘%')
and  not exists(select 1 from adjustwage.exadjust where ryid=t126.id);*/


insert into adjustwage.normaladjust(unitId,ryId,rybh,name,idcard,month,job,level,rankLevel,jobSalary,levelSalary,teacherNurseUp10,specialTeach,subTotal,rysf,recordId)
select f2,f1,f3,f4,f5,8,-- 工资职级,级别,档次,职务工资,级别工资,提高10%,提高15%,小计,'停发工资人员',人员身份
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2) and allauditflag=2 and c02<='2018-08' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag=2 )),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2) and allauditflag=2 and c02<='2018-08' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag=2 )),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2) and allauditflag=2 and c02<='2018-08' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag=2 )),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2) and allauditflag=2 and c02<='2018-08' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag=2 )*1+0,
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2) and allauditflag=2 and c02<='2018-08' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag=2 )*1+0,
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2) and allauditflag=2 and c02<='2018-08' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag=2 )*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2) and allauditflag=2 and c02<='2018-08' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag=2 )*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0)) from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2) and allauditflag=2 and c02<='2018-08' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag=2 ),
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2) and allauditflag=2 and c02<='2018-08' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag=2 )),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2) and allauditflag=2 and c02<='2018-08' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag=2 )
from test1 where  f2 = concat(dwid,'') and   
not exists(select 1 from adjustwage.exadjust where ryid=f1)
and not exists(select 1 from adjustwage.ywjyadjust where ryid=f1)
and f3 not like '%T'
and ifnull(f26,'2018-12')>'2018-07'
 and exists(select 1 from t111 where id = f2);
 
insert into adjustwage.normaladjust(unitId,ryId,rybh,name,idcard,month,job,level,rankLevel,jobSalary,levelSalary,teacherNurseUp10,specialTeach,subTotal,rysf,recordId)
select f2,f1,f3,f4,f5,9,-- 工资职级,级别,档次,职务工资,级别工资,提高10%,提高15%,小计,'停发工资人员',人员身份
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2) and allauditflag=2 and c02<='2018-09' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag=2 )),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2) and allauditflag=2 and c02<='2018-09' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag=2 )),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2) and allauditflag=2 and c02<='2018-09' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag=2 )),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2) and allauditflag=2 and c02<='2018-09' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag=2 )*1+0,
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2) and allauditflag=2 and c02<='2018-09' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag=2 )*1+0,
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2) and allauditflag=2 and c02<='2018-09' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag=2 )*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2) and allauditflag=2 and c02<='2018-09' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag=2 )*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0)) from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2) and allauditflag=2 and c02<='2018-09' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag=2 ),
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2) and allauditflag=2 and c02<='2018-09' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag=2 )),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2) and allauditflag=2 and c02<='2018-09' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag=2 )
from test1 where   f2 = concat(dwid,'') and  
not exists(select 1 from adjustwage.exadjust where ryid=f1)
and not exists(select 1 from adjustwage.ywjyadjust where ryid=f1)
and f3 not like '%T'
and ifnull(f26,'2018-12')>'2018-07'
 and exists(select 1 from t111 where id = f2);
 
insert into adjustwage.normaladjust(unitId,ryId,rybh,name,idcard,month,job,level,rankLevel,jobSalary,levelSalary,teacherNurseUp10,specialTeach,subTotal,rysf,recordId)
select f2,f1,f3,f4,f5,10,-- 工资职级,级别,档次,职务工资,级别工资,提高10%,提高15%,小计,'停发工资人员',人员身份
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2) and allauditflag=2 and c02<='2018-10' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag=2 )),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2) and allauditflag=2 and c02<='2018-10' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag=2 )),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2) and allauditflag=2 and c02<='2018-10' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag=2 )),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2) and allauditflag=2 and c02<='2018-10' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag=2 )*1+0,
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2) and allauditflag=2 and c02<='2018-10' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag=2 )*1+0,
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2) and allauditflag=2 and c02<='2018-10' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag=2 )*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2) and allauditflag=2 and c02<='2018-10' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag=2 )*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0)) from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2) and allauditflag=2 and c02<='2018-10' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag=2 ),
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2) and allauditflag=2 and c02<='2018-10' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag=2 )),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2) and allauditflag=2 and c02<='2018-10' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag=2 )
from test1 where   f2 = concat(dwid,'') and  
not exists(select 1 from adjustwage.exadjust where ryid=f1)
and not exists(select 1 from adjustwage.ywjyadjust where ryid=f1)
and f3 not like '%T'
and ifnull(f26,'2018-12')>'2018-07'
 and exists(select 1 from t111 where id = f2);
 
insert into adjustwage.normaladjust(unitId,ryId,rybh,name,idcard,month,job,level,rankLevel,jobSalary,levelSalary,teacherNurseUp10,specialTeach,subTotal,rysf,recordId)
select f2,f1,f3,f4,f5,11,-- 工资职级,级别,档次,职务工资,级别工资,提高10%,提高15%,小计,'停发工资人员',人员身份
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2) and allauditflag=2 and c02<='2018-11' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag=2 )),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2) and allauditflag=2 and c02<='2018-11' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag=2 )),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2) and allauditflag=2 and c02<='2018-11' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag=2 )),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2) and allauditflag=2 and c02<='2018-11'
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
  ) and t126.allauditflag=2 )*1+0,
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2) and allauditflag=2 and c02<='2018-11' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag=2 )*1+0,
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2) and allauditflag=2 and c02<='2018-11' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag=2 )*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2) and allauditflag=2 and c02<='2018-11' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag=2 )*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0)) from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2) and allauditflag=2 and c02<='2018-11' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag=2 ),
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2) and allauditflag=2 and c02<='2018-11'
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
  ) and t126.allauditflag=2 )),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2) and allauditflag=2 and c02<='2018-11' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag=2 )
from test1 where   f2 = concat(dwid,'') and  
not exists(select 1 from adjustwage.exadjust where ryid=f1)
and not exists(select 1 from adjustwage.ywjyadjust where ryid=f1)
and f3 not like '%T'
and ifnull(f26,'2018-12')>'2018-07'
 and exists(select 1 from t111 where id = f2);
 
insert into adjustwage.normaladjust(unitId,ryId,rybh,name,idcard,month,job,level,rankLevel,jobSalary,levelSalary,teacherNurseUp10,specialTeach,subTotal,rysf,recordId)
select f2,f1,f3,f4,f5,12,
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2) and allauditflag=2 and c02<='2018-12' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag=2 )),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2) and allauditflag=2 and c02<='2018-12' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag=2 )),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2) and allauditflag=2 and c02<='2018-12' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag=2 )),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2) and allauditflag=2 and c02<='2018-12' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag=2 )*1+0,
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2) and allauditflag=2 and c02<='2018-12' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag=2 )*1+0,
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2) and allauditflag=2 and c02<='2018-12' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag=2 )*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2) and allauditflag=2 and c02<='2018-12' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag=2 )*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0)) from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2) and allauditflag=2 and c02<='2018-12' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag=2 ),
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2) and allauditflag=2 and c02<='2018-12' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag=2 )),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2) and allauditflag=2 and c02<='2018-12' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag=2 )
from test1 where   f2 = concat(dwid,'') and  
not exists(select 1 from adjustwage.exadjust where ryid=f1)
and not exists(select 1 from adjustwage.ywjyadjust where ryid=f1)
and f3 not like '%T'
and ifnull(f26,'2018-12')>'2018-07'
 and exists(select 1 from t111 where id = f2);

-- select  'normal',276,current_timestamp(3);

insert into adjustwage.normaladjust(unitId,ryId,rybh,name,idcard,month,job,level,rankLevel,jobSalary,levelSalary,teacherNurseUp10,specialTeach,subTotal,rysf,recordId)
select f2,f1,f3,f4,f5,13,
(select c05 from t127 where id = (select t126.c17 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06 IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2) and allauditflag=2  and c02<='2018-12'  and changetype!='10831' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag=2 )),
(select c05 from t127 where id = (select t125.c07 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06  IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2) and allauditflag=2    and c02<='2018-12'  and changetype!='10831' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag=2 )),
(select c04 from t127 where id = (select t125.c09 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06  IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2) and allauditflag=2   and c02<='2018-12'  and changetype!='10831' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag=2 )),
(select t125.c25 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06  IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2)  and allauditflag=2  and c02<='2018-12'  and changetype!='10831' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag=2 )*1+0,
(select t125.c26 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06  IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2) and allauditflag=2   and c02<='2018-12'  and changetype!='10831' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag=2 )*1+0,
(select t125.c28 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06  IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2)  and allauditflag=2  and c02<='2018-12' and changetype!='10831'  
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag=2 )*1+0,
(select t125.c29 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06  IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2)  and allauditflag=2  and c02<='2018-12'  and changetype!='10831' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag=2 )*1+0,
(select round(ifnull(t125.c25,0)+ifnull(t125.c26,0)+ifnull(t125.c28,0)+ifnull(t125.c29,0)) from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06  IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2) and allauditflag=2   and c02<='2018-12'  and changetype!='10831' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag=2 ),
(select name from sys_s_data where id = (select t126.c28 from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06  IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2) and allauditflag=2   and c02<='2018-12'  and changetype!='10831' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag=2 )),
(select t126.id from data_record_t126 t126,data_record_t125 t125 
where f5 = concat(t126.c07,'') and t125.c06 = concat(t126.dataid,'') and t125.changesign=t126.changesign and t125.id =(
select max(id) from data_record_t125 where   c06  IN (select DISTINCT concat(dataid,'') from data_record_t126 where c07 = f5 and allauditflag=2)  and allauditflag=2  and c02<='2018-12'  and changetype!='10831' 
and changeType not in ('10751','11530','11532','11414') -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更 
 ) and t126.allauditflag=2 )
from test1 
where  f2 = concat(dwid,'') and  
not exists(select 1 from adjustwage.exadjust where ryid=f1)
and not exists(select 1 from adjustwage.ywjyadjust where ryid=f1)
and f3 not like '%T'

and ifnull(f26,'2018-12')>'2018-07'
and exists(select 1 from t111 where id = f2 and ((c05 in ('10295','10821') or c19='10487'  or id in (886,527)) and id!=1469))

 and exists(select 1 from t111 where id = f2);

-- select  'normal',321,current_timestamp(3);


delete from adjustwage.normaladjust  where  unitId = concat(dwid,'') and   rysf = '机关离休干部';
-- delete from adjustwage.normaladjust  where unitId = concat(dwid,'') and   job like '%地勘%';



-- select count(1) 正常总条数 from adjustwage.normaladjust;



-- select  'normal',333,current_timestamp(3);






	
			
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`auditAllFlag`(IN orgId varchar(200),IN perAuditFlag varchar(10),In allAuditFlag VARCHAR(10),
IN auditMsg VARCHAR(200),IN v_i_fund_month varchar(20),INOUT resultMsg  varchar(1000) CHARSET utf8)
label_pro:BEGIN
	declare stemNum int(11);
	declare sTempNum int(11);
	declare stemFundMonth varchar(20); -- 基金月份 
	DECLARE v_table VARCHAR(30);
	DECLARE v_allowance_table VARCHAR(50);
	declare sysDataBase varchar(20);-- 数据库名称
-- 基金 通过 或不通过 或 撤回 或统一撤回(全部已经通过了的,是调用fund_audit函数)
	if orgId = 0 then 
		set resultMsg = '单位id不能为空';
		leave label_pro;
	end if; 
	set resultMsg = '';
	select ifnull(content,'smso') into sysDataBase from sys_s_config where enname = 'DATABASE_NAME';-- 数据库名称
	-- 警察加班补扣发表
	select count(1) into stemNum from t152 where c12 = concat(v_i_fund_month,'') and c01=concat(orgId,'');
	if stemNum > 0 then
		update t152,sys_s_data d set c13 = d.id where c12 = v_i_fund_month and c01=concat(orgId,'') 
		and d.typename = 'ybshzt' and d.data_value = allauditFlag;-- 状态更新 
	end if;
	
	-- 警察值勤补扣发表
	select count(1) into stemNum from t153 where c14 = concat(v_i_fund_month,'') and c01=concat(orgId,'');
	if stemNum > 0 then
		update t153,sys_s_data d set c17 = d.id where c14 = concat(v_i_fund_month,'') and c01=concat(orgId,'') 
		and d.typename = 'ybshzt' and d.data_value = allauditFlag;-- 状态更新 
	end if;
	
	-- 艰边津补贴扣扣发表
	select count(1) into stemNum from t164 where c11 = concat(v_i_fund_month,'') and c01=concat(orgId,'');
	if stemNum > 0 then
		update t164,sys_s_data d set c10 = d.id where c11 = concat(v_i_fund_month,'') and c01=concat(orgId,'') 
		and d.typename = 'ybshzt' and d.data_value = allauditFlag;-- 状态更新 
	end if;
	
	-- 其它一次性补扣发项目表
	select count(1) into stemNum from t119 where c20 = concat(v_i_fund_month,'') and c04=concat(orgId,'') and c01 in 
	(select id from t126 where t126.c01 = concat(orgId,'') and t126.c03 != '10372'); -- 10372是离休人员
	if stemNum > 0 then
		update t119 ,sys_s_data d set c21 = d.id where c20 = concat(v_i_fund_month,'') and c04=concat(orgId,'')
		and c01 in (select id from t126 where t126.c01 = concat(orgId,'') and  t126.c03 != '10372') and d.typename = 'ybshzt' and d.data_value = allauditFlag;--  状态更新为 -- 10372是离休人员
	end if;
	
	-- 一次性年终奖金管理表
	select count(1) into stemNum from t151 where c04 = concat(v_i_fund_month,'') and c01=concat(orgId,'');
	if stemNum > 0 then
		update t151,sys_s_data d set c03 = d.id where c04 = concat(v_i_fund_month,'') and c01=concat(orgId,'') 
		and d.typename = 'ybshzt' and d.data_value = allauditFlag;-- 状态更新
	end if;
	
	-- 此处先判断是否所有的都通过了
	if allAuditFlag = '2' THEN -- 审核通过
		/* update data_data_record a set allAuditFlag = '2'  -- 全部审核状态为2,通过
			where dataclassCode = 't126' and c01 = orgId and fund_month = v_i_fund_month and allAuditFlag != '2';-- 未审核通过的数据
			-- 更新所有上报的操作记录
		update data_data_record a , data_data_record b set a.allAuditFlag = '2' 
			where b.dataclassCode = 't126' and a.changeSign = b.changeSign and b.allAuditflag = '2';*/
		update data_record_t126  set allAuditFlag = '2'  -- 全部审核状态为2,通过
		where -- dataclassCode = 't126' and 
		c01 = concat(orgId,'') and fund_month = concat(v_i_fund_month,'') and allAuditFlag != '2' and c03 != '10372'; -- 10372是离休人员
		update data_record_t125  set allAuditFlag = '2' 
		where -- dataclassCode = 't125' and 
		c05 = concat(orgId,'') and fund_month = concat(v_i_fund_month,'') and allAuditFlag != '2' and c06 in (select id from t126 where t126.c01 = concat(orgId,'') and   t126.c03 != '10372'); -- 10372是离休人员
		update data_record_t117  set allAuditFlag = '2' 
		where--  dataclassCode = 't117' and 
		c02 = concat(orgId,'') and fund_month = concat(v_i_fund_month,'') and allAuditFlag != '2' and c03 in (select id from t126 where t126.c01 = concat(orgId,'') and   t126.c03 != '10372'); -- 10372是离休人员
		leave label_pro;
	end if;
		
	if allauditFlag = '3' then -- 审核不通过
		/*update data_data_record set allAuditFlag = '3',auditMsg = auditMsg ,fund_month = ''
		 where c01 = orgId and fund_month = v_i_fund_month and allAuditFlag != '2';-- 未审核通过的数据
		update data_data_record a , data_data_record b set a.allAuditFlag = '3' ,a.fund_month = ''
			where b.dataclassCode = 't126' and a.changeSign = b.changeSign
			and b.c01 = orgId
			and b.allAuditFlag = '3' 
			and a.allAuditFlag !='2';*/
		update data_record_t126 set allAuditFlag = '3',auditMsg = auditMsg /**,fund_month = '' */
		where c01 = concat(orgId,'') and fund_month = concat(v_i_fund_month,'') and allAuditFlag != '2' and c03 != '10372';-- 未审核通过的数据	 -- 10372是离休人员
		update data_record_t125 set allAuditFlag = '3',auditMsg = auditMsg /**,fund_month = '' */
		where c05 = concat(orgId,'') and fund_month = concat(v_i_fund_month,'') and allAuditFlag != '2' and c06 in (select id from t126 where t126.c01 = concat(orgId,'') and   t126.c03 != '10372');-- 未审核通过的数据	 -- 10372是离休人员
		update data_record_t117 set allAuditFlag = '3',auditMsg = auditMsg /**,fund_month = '' */
		where c02 = concat(orgId,'') and fund_month = concat(v_i_fund_month,'') and allAuditFlag != '2' and c03 in (select id from t126 where t126.c01 = concat(orgId,'') and   t126.c03 != '10372');-- 未审核通过的数据	 -- 10372是离休人员
	end if;
	
	if allauditFlag = '8' then -- 撤回
		/*update data_data_record set allAuditFlag = '8',fund_month = '' 
		where c01 = orgId and if(ifnull(fund_month,'')='',v_i_fund_month,fund_month) = v_i_fund_month and allAuditFlag != '2';-- 未审核通过的数据
		update data_data_record a , data_data_record b set a.allAuditFlag = '8' ,a.fund_month = ''
			where b.dataclassCode = 't126' and a.changeSign = b.changeSign 
			and b.c01 = orgId
			and b.allAuditFlag = '8' and a.allAuditFlag !='2';*/
		update data_record_t126 set allAuditFlag = '8'/**,fund_month = '' */
		where c01 = concat(orgId,'') and if(ifnull(fund_month,'')='','',fund_month) = v_i_fund_month and allAuditFlag != '2' and c03 != '10372';-- 未审核通过的数据 -- 10372是离休人员
		update data_record_t125 set allAuditFlag = '8'/**,fund_month = '' */
		where c05 = concat(orgId,'') and if(ifnull(fund_month,'')='','',fund_month) = v_i_fund_month and allAuditFlag != '2' and c06 in (select id from t126 where t126.c01 = concat(orgId,'') and   t126.c03 != '10372');-- 未审核通过的数据 -- 10372是离休人员
		update data_record_t117 set allAuditFlag = '8'/**,fund_month = '' */
		where c02 = concat(orgId,'') and if(ifnull(fund_month,'')='','',fund_month) = v_i_fund_month and allAuditFlag != '2' and c03 in (select id from t126 where t126.c01 = concat(orgId,'') and   t126.c03 != '10372');-- 未审核通过的数据 -- 10372是离休人员
	end if;
	
	if allauditFlag = '7' then -- 撤回申请中
		/*update data_data_record set allAuditFlag = '7'
		where c01 = orgId and fund_month = v_i_fund_month and allAuditFlag != '2';-- 未审核通过的数据
		update data_data_record a , data_data_record b set a.allAuditFlag = '7' 
			where b.dataclassCode = 't126' and a.changeSign = b.changeSign 
			and b.c01 = orgId
			and b.allAuditFlag = '7' and a.allAuditFlag !='2';*/
		update data_record_t126 set allAuditFlag = '7'
		where c01 = concat(orgId,'') and fund_month = concat(v_i_fund_month,'') and allAuditFlag != '2' and c03 != '10372';-- 未审核通过的数据 -- 10372是离休人员
		update data_record_t125 set allAuditFlag = '7'
		where c05 = concat(orgId,'') and fund_month = concat(v_i_fund_month,'') and allAuditFlag != '2' and c06 in (select id from t126 where t126.c01 = concat(orgId,'') and   t126.c03 != '10372');-- 未审核通过的数据 -- 10372是离休人员
		update data_record_t117 set allAuditFlag = '7'
		where c02 = concat(orgId,'') and fund_month = concat(v_i_fund_month,'') and allAuditFlag != '2' and c03 in (select id from t126 where t126.c01 = concat(orgId,'') and   t126.c03 != '10372');-- 未审核通过的数据 -- 10372是离休人员
	end if;
	
	if allauditFlag = '10' then -- 统一撤回
		select MIN(byyb_month) into @perPmonth from fund_byyb where unit_id =concat(orgId,'') and fund_month = v_i_fund_month;
		
			select PERIOD_DIFF(v_i_fund_month,@perPmonth) into stemNum;-- 201610-201601
			set sTempNum = 0; 
			if stemNum>0 then -- 存在补扣发
					while sTempNum<stemNum DO
					set stemFundMonth = DATE_FORMAT(DATE_ADD(concat(@perPmonth,'01'),INTERVAL sTempNum MONTH),'%Y%m');
					set v_table = concat('fund_salary_pay','_',stemFundMonth);-- 对应月份 201607到v_i_fund_month之前相关的发放表的补扣发
					set v_allowance_table = concat('fund_salary_subsidies_pay','_',stemFundMonth); -- 对应月份201607到v_i_fund_month之前相关发放表-津补贴的补扣发
					select count(1) into @stempNum from information_schema.tables where table_schema = sysDataBase and TABLE_NAME = v_table;-- smso数据库里面对应的工资发放表信息
					if @stempNum >0 then 
						
						set @sqlstr = concat("
							update ",v_table," tab,(select unit_id,staff_id,fund_month,byyb_month,sum(ifnull(zwgz_byyb,0)) a1,sum(ifnull(gwgz_byyb,0)) a2,
								sum(ifnull(jshstg_byyb,0)) a3,sum(ifnull(tsjytg_byyb,0)) a4,
								sum(ifnull(bltggz_byyb,0)) a5,sum(ifnull(jsblgz_byyb,0)) a6,
								sum(ifnull(hsblgz_byyb,0)) a7,sum(ifnull(psxlj_byyb,0)) a8,
								sum(ifnull(jxgz_byyb,0)) a9,sum(ifnull( jbt_salary_byyb,0)) a10,
								sum(ifnull(total_salary_byyb,0)) a11,sum(ifnull(total_salary_byyb,0)) a12
				
				 			from fund_byyb where unit_id = ",orgId," and fund_month = ",v_i_fund_month," and byyb_month = ",stemFundMonth,"   GROUP BY staff_id) byb 
								set tab.zwgz_hx = ifnull(tab.zwgz_hx,0) - a1,
									tab.gwgz_hx = ifnull(tab.gwgz_hx,0) - a2,
									tab.jshstg_hx = ifnull(tab.jshstg_hx,0) - a3,
									tab.tsjytg_hx = ifnull(tab.tsjytg_hx,0) - a4 ,
									tab.bltggz_hx = ifnull(tab.bltggz_hx,0) - a5,
									tab.jsblgz_hx = ifnull(tab.jsblgz_hx,0) - a6,
									tab.hsblgz_hx = ifnull(tab.hsblgz_hx,0) - a7,
									tab.psxlj_hx = ifnull(tab.psxlj_hx,0) - a8,
									tab.jxgz_hx = ifnull(tab.jxgz_hx,0) - a9,
									tab.jbt_salary_hx = ifnull(tab.jbt_salary_hx,0) -a10,
									tab.part_total_salary_hx = ifnull(tab.part_total_salary_hx,0) - a11 ,
									tab.fill_salary_hx = ifnull(tab.fill_salary_hx,0) - a12
				
							where tab.unit_id = ",orgId," and  byb.unit_id = tab.unit_id and tab.staff_id = byb.staff_id and byb.fund_month = ",v_i_fund_month," and byb.byyb_month = ",stemFundMonth,"  
						
						 "); 
						PREPARE stmt FROM @sqlstr;
						EXECUTE stmt;
						DROP PREPARE stmt;	
						set @sqlstr = concat("
							 update ",v_allowance_table," tab,(select unit_id,staff_id,fund_month,byyb_month,allowance_id, 
							 			sum(ifnull(salary_byyb,0)) as a1 from fund_subsidies_byyb
									where unit_id = ",orgId," and fund_month = ",v_i_fund_month," and byyb_month = ",stemFundMonth,"
				 					GROUP BY staff_id,allowance_id) byb 
							set tab.salary_hx_bf = ifnull(tab.salary_hx_bf,0) - a1
							where tab.unit_id = ",orgId," and byb.unit_id = tab.unit_id and tab.staff_id = byb.staff_id and tab.allowance_id =byb.allowance_id 
							 	and byb.fund_month = ",v_i_fund_month," and byb.byyb_month = ",stemFundMonth,"
							  "); 
						PREPARE stmt FROM @sqlstr;
						EXECUTE stmt;
						DROP PREPARE stmt;	
						
						
					end if;
					set sTempNum = sTempNum+1;
					end while;
			end if;
		
		
		/*set @permonth = DATE_FORMAT(DATE_ADD(concat(v_i_fund_month,'01'),INTERVAL -1 MONTH),'%Y%m');
		set @perPmonth = DATE_FORMAT(DATE_ADD(concat(v_i_fund_month,'01'),INTERVAL -2 MONTH),'%Y%m');
		
			
		
		set @sqlstr = concat("update fund_salary_pay_",@perPmonth," tab,(select unit_id,staff_id,fund_month,byyb_month,sum(ifnull(zwgz_byyb,0)) a1,sum(ifnull(gwgz_byyb,0)) a2,
				sum(ifnull(jshstg_byyb,0)) a3,sum(ifnull(tsjytg_byyb,0)) a4,
				sum(ifnull(bltggz_byyb,0)) a5,sum(ifnull(jsblgz_byyb,0)) a6,
				sum(ifnull(hsblgz_byyb,0)) a7,sum(ifnull(psxlj_byyb,0)) a8,
				sum(ifnull(jxgz_byyb,0)) a9,sum(ifnull( jbt_salary_byyb,0)) a10,
				sum(ifnull(total_salary_byyb,0)) a11,sum(ifnull(total_salary_byyb,0)) a12

 			from fund_byyb where unit_id = ",orgId," and fund_month = ",v_i_fund_month," and byyb_month = ",@perPmonth,"   GROUP BY staff_id) byb 
				set tab.zwgz_hx = ifnull(tab.zwgz_hx,0) - a1,
					tab.gwgz_hx = ifnull(tab.gwgz_hx,0) - a2,
					tab.jshstg_hx = ifnull(tab.jshstg_hx,0) - a3,
					tab.tsjytg_hx = ifnull(tab.tsjytg_hx,0) - a4 ,
					tab.bltggz_hx = ifnull(tab.bltggz_hx,0) - a5,
					tab.jsblgz_hx = ifnull(tab.jsblgz_hx,0) - a6,
					tab.hsblgz_hx = ifnull(tab.hsblgz_hx,0) - a7,
					tab.psxlj_hx = ifnull(tab.psxlj_hx,0) - a8,
					tab.jxgz_hx = ifnull(tab.jxgz_hx,0) - a9,
					tab.jbt_salary_hx = ifnull(tab.jbt_salary_hx,0) -a10,
					tab.part_total_salary_hx = ifnull(tab.part_total_salary_hx,0) - a11 ,
					tab.fill_salary_hx = ifnull(tab.fill_salary_hx,0) - a12

			where tab.unit_id = ",orgId," and  byb.unit_id = tab.unit_id and tab.staff_id = byb.staff_id and byb.fund_month = ",v_i_fund_month," and byb.byyb_month = ",@perPmonth,"  
		
		 "); 
		PREPARE stmt FROM @sqlstr;
		EXECUTE stmt;
		DROP PREPARE stmt;	
		
		set @sqlstr = concat(" update fund_salary_subsidies_pay_",@perPmonth," tab,(select unit_id,staff_id,fund_month,byyb_month,allowance_id, 
			 			sum(ifnull(salary_byyb,0)) as a1 from fund_subsidies_byyb
					where unit_id = ",orgId," and fund_month = ",v_i_fund_month," and byyb_month = ",@perPmonth,"
 					GROUP BY staff_id,allowance_id) byb 
			set tab.salary_hx_bf = ifnull(tab.salary_hx_bf,0) - a1
			where tab.unit_id = ",orgId," and byb.unit_id = tab.unit_id and tab.staff_id = byb.staff_id and tab.allowance_id =byb.allowance_id 
			 	and byb.fund_month = ",v_i_fund_month," and byb.byyb_month = ",@perPmonth,"
			 "); 
		PREPARE stmt FROM @sqlstr;
		EXECUTE stmt;
		DROP PREPARE stmt;	*/
		delete from fund_byyb where unit_id = concat(orgId,'') and fund_month = v_i_fund_month;
		delete from fund_subsidies_byyb where unit_id = concat(orgId,'') and fund_month = v_i_fund_month;
		
		
		set @sqlstr = concat(" update data_record_t126 set allAuditFlag = '10' where  c01 ='",orgId,
					"' and fund_month = '",v_i_fund_month,"' and allAuditFlag= '2'"," and c03 != '10372'"); -- 10372是离休人员
		PREPARE stmt FROM @sqlstr;
		EXECUTE stmt;
		DROP PREPARE stmt;	
		-- update data_data_record set allAuditFlag = '10',fund_month = '' 
		 -- where dataclassCode = 't126' and c01 = orgId and fund_month = v_i_fund_month and allAuditFlag= '2';-- 更新所有通过的操作记录
		set @sqlstr = concat(" update data_record_t117 set allAuditFlag = '10' where  c02 ='",orgId,
					"' and fund_month = '",v_i_fund_month,"' and allAuditFlag= '2'"," and c03 in (select id from t126 where t126.c01 = concat(",orgId,",'') and   t126.c03 != '10372')"); -- 10372是离休人员
		PREPARE stmt FROM @sqlstr;
		EXECUTE stmt;
		DROP PREPARE stmt;
		set @sqlstr = concat(" update data_record_t125 set allAuditFlag = '10' where  c05 ='",orgId,
					"' and fund_month = '",v_i_fund_month,"' and allAuditFlag= '2'"," and c06 in (select id from t126 where t126.c01 = concat(",orgId,",'') and   t126.c03 != '10372')"); -- 10372是离休人员
		PREPARE stmt FROM @sqlstr;
		EXECUTE stmt;
		DROP PREPARE stmt;
		-- update data_data_record a , data_data_record b set a.allAuditFlag = '10' ,a.fund_month = ''
		-- 	where b.dataclassCode = 't126' and a.changeSign = b.changeSign 
			-- and b.c01 = orgId and b.allAuditFlag = '10' and a.allAuditFlag ='2';
	end if;
			
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`auditAllFlagLx`(IN orgId varchar(200),IN perAuditFlag varchar(10),In allAuditFlag VARCHAR(10),
IN auditMsg VARCHAR(200),IN v_i_fund_month varchar(20),INOUT resultMsg  varchar(1000) CHARSET utf8)
label_pro:BEGIN
	declare stemNum int(11);
-- 基金 通过 或不通过 或 撤回 或统一撤回(全部已经通过了的,是调用fund_audit函数)
	if orgId = 0 then 
		set resultMsg = '单位id不能为空';
		leave label_pro;
	end if; 
	set resultMsg = '';
	-- 其它一次性补扣发项目表
	-- 10372是表示离休人员
	select count(1) into stemNum from t119 where c20 = concat(v_i_fund_month,'') and c04=concat(orgId,'') and c01 in 
	(select id from t126 where t126.c01 = concat(orgId,'') and   t126.c03 = '10372');
	if stemNum > 0 then
		update t119 ,sys_s_data d set c21 = d.id where c20 = concat(v_i_fund_month,'') and c04=concat(orgId,'')
		and c01 in (select id from t126 where t126.c01 = concat(orgId,'') and   t126.c03 = '10372') and d.typename = 'ybshzt' and d.data_value = allauditFlag;--  状态更新为
	end if;
	-- 此处先判断是否所有的都通过了
	if allAuditFlag = '2' THEN -- 审核通过
		update data_record_t126  set allAuditFlag = '2'  -- 全部审核状态为2,通过
		where -- dataclassCode = 't126' and 
		c01 = concat(orgId,'') and fund_month = concat(v_i_fund_month,'') and allAuditFlag != '2' and c03 = '10372';
		update data_record_t125  set allAuditFlag = '2' 
		where -- dataclassCode = 't125' and 
		c05 = concat(orgId,'') and fund_month = concat(v_i_fund_month,'') and allAuditFlag != '2' and c06 in (select id from t126 where t126.c01 = concat(orgId,'') and   t126.c03 = '10372');
		update data_record_t117  set allAuditFlag = '2' 
		where--  dataclassCode = 't117' and 
		c02 = concat(orgId,'') and fund_month = concat(v_i_fund_month,'') and allAuditFlag != '2' and c03 in (select id from t126 where t126.c01 = concat(orgId,'') and   t126.c03 = '10372');
		leave label_pro;
	end if;
		
	if allauditFlag = '3' then -- 审核不通过
		update data_record_t126 set allAuditFlag = '3',auditMsg = auditMsg /**,fund_month = '' */
		where c01 = concat(orgId,'') and fund_month = concat(v_i_fund_month,'') and allAuditFlag != '2' and c03 = '10372';-- 未审核通过的数据	
		update data_record_t125 set allAuditFlag = '3',auditMsg = auditMsg /**,fund_month = '' */
		where c05 = concat(orgId,'') and fund_month = concat(v_i_fund_month,'') and allAuditFlag != '2' and c06 in (select id from t126 where t126.c01 = concat(orgId,'') and   t126.c03 = '10372');-- 未审核通过的数据	
		update data_record_t117 set allAuditFlag = '3',auditMsg = auditMsg /**,fund_month = '' */
		where c02 = concat(orgId,'') and fund_month = concat(v_i_fund_month,'') and allAuditFlag != '2' and c03 in (select id from t126 where t126.c01 = concat(orgId,'') and   t126.c03 = '10372');-- 未审核通过的数据	
	end if;
	if allauditFlag = '8' then -- 撤回
		update data_record_t126 set allAuditFlag = '8'/**,fund_month = '' */
		where c01 = concat(orgId,'') and if(ifnull(fund_month,'')='','',fund_month) = v_i_fund_month and allAuditFlag != '2' and c03 = '10372';-- 未审核通过的数据
		update data_record_t125 set allAuditFlag = '8'/**,fund_month = '' */ 
		where c05 = concat(orgId,'') and if(ifnull(fund_month,'')='','',fund_month) = v_i_fund_month and allAuditFlag != '2' and c06 in (select id from t126 where t126.c01 = concat(orgId,'') and   t126.c03 = '10372');-- 未审核通过的数据
		update data_record_t117 set allAuditFlag = '8'/**,fund_month = '' */
		where c02 = concat(orgId,'') and if(ifnull(fund_month,'')='','',fund_month) = v_i_fund_month and allAuditFlag != '2' and c03 in (select id from t126 where t126.c01 = concat(orgId,'') and   t126.c03 = '10372');-- 未审核通过的数据
	end if;
	if allauditFlag = '7' then -- 撤回申请中
		update data_record_t126 set allAuditFlag = '7'
		where c01 = concat(orgId,'') and fund_month = concat(v_i_fund_month,'') and allAuditFlag != '2' and c03 = '10372';-- 未审核通过的数据
		update data_record_t125 set allAuditFlag = '7'
		where c05 = concat(orgId,'') and fund_month = concat(v_i_fund_month,'') and allAuditFlag != '2' and c06 in (select id from t126 where t126.c01 = concat(orgId,'') and   t126.c03 = '10372');-- 未审核通过的数据
		update data_record_t117 set allAuditFlag = '7'
		where c02 = concat(orgId,'') and fund_month = concat(v_i_fund_month,'') and allAuditFlag != '2' and c03 in (select id from t126 where t126.c01 = concat(orgId,'') and   t126.c03 = '10372');-- 未审核通过的数据
	end if;
	if allauditFlag = '10' then -- 统一撤回
		set @sqlstr = concat(" update data_record_t126 set allAuditFlag = '10' where dataclassCode = 't126' and c01 ='",orgId,
					"' and fund_month = '",v_i_fund_month,"' and allAuditFlag= '2'"," and c03 = '10372'");
		PREPARE stmt FROM @sqlstr;
		EXECUTE stmt;
		DROP PREPARE stmt;	
		-- update data_data_record set allAuditFlag = '10',fund_month = '' 
		 -- where dataclassCode = 't126' and c01 = orgId and fund_month = v_i_fund_month and allAuditFlag= '2';-- 更新所有通过的操作记录
		set @sqlstr = concat(" update data_record_t117 set allAuditFlag = '10'  where dataclassCode = 't117' and c02 ='",orgId,
					"' and fund_month = '",v_i_fund_month,"' and allAuditFlag= '2'"," and c03 in (select id from t126 where t126.c01 = concat(",orgId,",'') and   t126.c03 = '10372')");
		PREPARE stmt FROM @sqlstr;
		EXECUTE stmt;
		DROP PREPARE stmt;
		set @sqlstr = concat(" update data_record_t125 set allAuditFlag = '10'  where dataclassCode = 't125' and c05 ='",orgId,
					"' and fund_month = '",v_i_fund_month,"' and allAuditFlag= '2'"," and c06 in (select id from t126 where t126.c01 = concat(",orgId,",'') and   t126.c03 = '10372')");
		PREPARE stmt FROM @sqlstr;
		EXECUTE stmt;
		DROP PREPARE stmt;
	end if;
			
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`auditBeforeFlag`(IN orgId varchar(200),IN perAuditFlag varchar(10),In allAuditFlag VARCHAR(10),IN auditMsg VARCHAR(200),INOUT resultMsg  varchar(1000) CHARSET utf8)
BEGIN
			if orgId = 0 then 
				set resultMsg = '单位id不能为空';
			else 
				if orgId = 0 then
					set resultMsg = '单位id人不能为空';
				else
					-- 此处先判断是否所有的都通过了
					set resultMsg = "";
					if allAuditFlag = '2' THEN -- 审核通过
						/*update data_data_record a set perAuditFlag = '2' 
							where dataclassCode = 't126' and c01 = orgId and perAuditFlag = '2' 
							and exists(select 1 from t141 d where d.c01 = a.changeType )-- t141 前置变动配置表 c01变动类型
							;-- 更新所有上报的操作记录
						update data_data_record a , data_data_record b set a.perAuditFlag = '2' 
							where b.dataclassCode = 't126' and a.changeSign = b.changeSign 
							and b.c01 = orgId and b.perAuditFlag = '2'
							and exists(select 1 from t141 d where d.c01 = a.changeType );*/-- t141 前置变动配置表 c01变动类型

						update data_record_t126 a set perAuditFlag = '2' 
							where -- dataclassCode = 't126' and 
							c01 = concat(orgId,'') and perAuditFlag = '2' 
							and exists(select 1 from t141 d where d.c01 = a.changeType )-- t141 前置变动配置表 c01变动类型
							;-- 更新所有上报的操作记录
						update data_record_t125 a set perAuditFlag = '2' 
							where --  dataclassCode = 't125' and 
							c05 = concat(orgId,'') and perAuditFlag = '2' 
							and exists(select 1 from t141 d where d.c01 = a.changeType )-- t141 前置变动配置表 c01变动类型
							;-- 更新所有上报的操作记录
						update data_record_t117 a set perAuditFlag = '2' 
							where -- dataclassCode = 't117' and 
							c02 = concat(orgId,'') and perAuditFlag = '2' 
							and exists(select 1 from t141 d where d.c01 = a.changeType )-- t141 前置变动配置表 c01变动类型
							;-- 更新所有上报的操作记录
					ELSE -- 审核不通过
						/*update data_data_record a set allAuditFlag = '0',perAuditFlag='0',
						auditMsg = auditMsg 
						where dataclassCode='126' and  c01 = orgId 
						and perAuditFlag='1' and ifnull(allAuditFlag,'')!= '3'
						and exists(select 1 from t141 d where d.c01 = a.changeType )-- t141 前置变动配置表 c01变动类型
						;-- 更新所有上报的操作记录
						update data_data_record a , data_data_record b set a.allAuditFlag = '0',a.perAuditFlag='0' 
							where b.dataclassCode = 't126' and a.changeSign = b.changeSign 
							and b.c01 = orgId
							and a.perAuditFlag = '1' and ifnull(b.allAuditFlag,'')!= '3'
							and exists(select 1 from t141 d where d.c01 = a.changeType );*/-- t141 前置变动配置表 c01变动类型

						update data_record_t126 a set allAuditFlag = '0',perAuditFlag='0',
						auditMsg = auditMsg 
						where -- dataclassCode='126' and  
						c01 = concat(orgId,'') 
						and perAuditFlag='1' and ifnull(allAuditFlag,'')!= '3'
						and exists(select 1 from t141 d where d.c01 = a.changeType )-- t141 前置变动配置表 c01变动类型
						;-- 更新所有上报的操作记录
						update data_record_t125 a set allAuditFlag = '0',perAuditFlag='0',
						auditMsg = auditMsg 
						where -- dataclassCode='125' and  
						c05 = concat(orgId,'') 
						and perAuditFlag='1' and ifnull(allAuditFlag,'')!= '3'
						and exists(select 1 from t141 d where d.c01 = a.changeType )-- t141 前置变动配置表 c01变动类型
						;-- 更新所有上报的操作记录
						update data_record_t117 a set allAuditFlag = '0',perAuditFlag='0',
						auditMsg = auditMsg 
						where -- dataclassCode='117' and  
						c02 = concat(orgId,'') 
						and perAuditFlag='1' and ifnull(allAuditFlag,'')!= '3'
						and exists(select 1 from t141 d where d.c01 = a.changeType )-- t141 前置变动配置表 c01变动类型
						;-- 更新所有上报的操作记录
					end if;
				end if;
			end if;
			
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`beforeApply`(IN createrId int(11),IN orgId int(11),IN chanType int(11),
INOUT resultMsg  varchar(1000) CHARSET utf8)
label_pro:BEGIN
    -- 前置变动申请
	declare stemNum int(11);-- 参数
	declare jcJbNum int(11);-- 警察加班
	declare jcZqNum int(11);-- 警察值勤
	declare jbJbtNum int(11);--  艰边津补贴
	declare recordNum int(11);-- 变动记录
	if createrId = 0 then 
		set resultMsg = '操作人不能为空';
	else 
		if orgId = 0 then
			set resultMsg = '单位id不能为空';
		else
		
			-- 警察加班补贴
			select count(1) into jcJbNum from t152 where c01 = concat(orgId,'') 
				-- and EXISTS (select 1 from t126,sys_s_data d where d.id = t126.c03 and t126.id = t153.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
				and ifnull(c15,'') in( 0,3,8,10) and ifnull(c13,'')!='11204';-- 前置审核状态  0-未申报 1-待审核 2-审核通过 3-审核不通过
	
			-- 警察执勤津补贴
			select count(1) into jcZqNum from t153 where c01 = concat(orgId,'') 
			and ifnull(c18,'') in( 0,3,8,10) and ifnull(c10,'')!='11204';-- 前置审核状态  0-未申报 1-待审核 2-审核通过 3-审核不通过
	
			-- 艰边津贴补扣发
			select count(1) into jbJbtNum from t164 where c01 = concat(orgId,'') 
			and ifnull(c12,'') in( 0,3,8,10) and ifnull(c10,'')!='11204'; -- 前置审核状态  0-未申报 1-待审核 2-审核通过 3-审核不通过
	
			-- 0-未申报 1-待审核 2-审核通过 3-审核不通过 9-生成基金未上报 8-撤回 7-撤回申请中 10-统一撤回
			select count(1) into recordNum from data_record_t126 where dataclassCode = 't126' 
			and ifnull(perAuditFlag,0) in( 0,3,8,10) and
			c01 = concat(orgId,'') and c40 in (select c01 from t141) ;
			
			if recordNum = 0 and jbJbtNum = 0 and jcZqNum = 0 and jcJbNum = 0 then
				if chanType > 0 then
					set resultMsg = '该类型前置变动数据已经上报审核';
				else
					set resultMsg = '当月没有前置变动数据或数据已全部申报';
				end if;
				leave label_pro; 
			end if;
			
			select count(1) into stemNum from fund_audit_record where unit_id = concat(orgId,'') and ifnull(fund_status,'') = '1';
			if stemNum >0 then
				set resultMsg = '存在月报数据待审核';
				leave label_pro; 
			end if;
				
			select count(1) into stemNum from fund_audit_record where unit_id = concat(orgId,'') and ifnull(fund_status,'') = '7';
			if stemNum >0 then
				set resultMsg = '存在月报数据撤回申请中';
				leave label_pro; 
			end if;
			set resultMsg = '';
			-- 此处写所有的变动记录过程
			if chanType > 0 then -- 撤回的变动记录不为空
				select name into @changeTypeName from sys_s_data where id = chanType;
				if position('艰' in @changeTypeName) > 0 then -- 艰边
					if jbJbtNum > 0 then --  艰边津补贴
						update t164 set c12 = '1',
						c14 = 1,c15=1,c16=1,c17=1,c18=1,c19=1
						where c01 = concat(orgId,'') 
						and ifnull(c12,'') != '1'   and ifnull(c12,'') != '2'  and ifnull(c10,'')!='11204';-- 判断艰边（C12:月报审核基金状态）不等于待审核，通过的条件以及（C10：基金审核总状态）不等于（11204：通过）的数据不需要更新状态
					end if;
				else 
					if position('加班' in @changeTypeName) > 0 then -- 警察 加班
						if jcJbNum > 0 then -- 警察加班
							update t152 set c15 = '1',
							c17 = 1,c18=1,c19=1,c20=1,c21=1,c22=1
							 where c01 = concat(orgId,'') 
							and ifnull(c15,'') != '1'   and ifnull(c15,'') != '2'  and ifnull(c13,'')!='11204';-- 判断警察加班（C15:月报审核基金状态）不等于待审核，通过的条件以及（C13：基金审核总状态）不等于（11204：通过）的数据不需要更新状态
						end if;
					else 
						if position('值勤' in @changeTypeName) > 0 then -- 警察 值勤
							if jcZqNum > 0 then -- 警察值勤
								update t153 set c18 = '1',
								c20 = 1,c21=1,c22=1,c23=1,c24=1,c25=1
								where c01 = concat(orgId,'') 
								and ifnull(c18,'') != '1'   and ifnull(c18,'') != '2'  and ifnull(c17,'')!='11204';-- 判断警察值勤（C18:月报审核基金状态）不等于待审核，通过的条件以及（C17：基金审核总状态）不等于（11204：通过）的数据不需要更新状态
							end if;
						else -- 其它在data_data_record里面的变动
							if recordNum > 0 then -- 前置变动记录(record表)数量
								/*update data_data_record set perAuditFlag = 1,allAuditFlag = 0,
								firstFlag = 1,secondFlag=1,thirdFlag=1,forthFlag=1,fiveFlag=1,sixFlag=1,
								operateId = createrId,operateTime = SYSDATE()
								where dataclassCode = 't126' and perAuditFlag in(0,3,8,9,10)
								and c40 = chanType
								 and allAuditFlag in(0,3,8,9,10)
								 and c01 = orgId and c40 in (select c01 from t141);
								
								update data_data_record a ,data_data_record b set a.perAuditFlag = 1,a.allAuditFlag = 0,
								a.firstFlag = 1,a.secondFlag=1,a.thirdFlag=1,a.forthFlag=1,a.fiveFlag=1,a.sixFlag=1,
								a.operateId = b.operateId,a.operateTime = b.operateTime
								where b.dataclassCode = 't126' and a.changeType = b.changeType
								and b.changeType = chanType
								 and a.changeSign = b.changeSign 
								and b.c01 = orgId
								and a.perAuditFlag in(0,3,8,9,10)  and b.perAuditFlag = 1;*/
								update data_record_t126 set perAuditFlag = 1,allAuditFlag = 0,
								firstFlag = 1,secondFlag=1,thirdFlag=1,forthFlag=1,fiveFlag=1,sixFlag=1,
								operateId = createrId,operateTime = SYSDATE()
								where -- dataclassCode = 't126' 
								c01 = concat(orgId,'') 
								and c40 = chanType
								 and allAuditFlag in(0,3,8,9,10)
								 and perAuditFlag in(0,3,8,9,10)
								 and c40 in (select c01 from t141);
								 
								 update data_record_t125 a ,data_record_t126 b set a.perAuditFlag = 1,a.allAuditFlag = 0,
								a.firstFlag = 1,a.secondFlag=1,a.thirdFlag=1,a.forthFlag=1,a.fiveFlag=1,a.sixFlag=1,
								a.operateId = b.operateId,a.operateTime = b.operateTime
								where 
								b.c01 = concat(orgId,'')
								-- b.dataclassCode = 't126' 
								and a.changeType = b.changeType
								and b.changeType = chanType
								 and a.changeSign = b.changeSign 
								
								and a.perAuditFlag in(0,3,8,9,10)  and b.perAuditFlag = 1;
								 update data_record_t117 a ,data_record_t126 b set a.perAuditFlag = 1,a.allAuditFlag = 0,
								a.firstFlag = 1,a.secondFlag=1,a.thirdFlag=1,a.forthFlag=1,a.fiveFlag=1,a.sixFlag=1,
								a.operateId = b.operateId,a.operateTime = b.operateTime
								where -- b.dataclassCode = 't126' and
								 a.changeType = b.changeType
								and b.c01 = concat(orgId,'')
								and b.changeType = chanType
								 and a.changeSign = b.changeSign 
								and a.perAuditFlag in(0,3,8,9,10)  and b.perAuditFlag = 1;
							end if;
						end if;
					end if;
				end if;
			else 
				select count(1) into stemNum from data_record_t126 where dataclassCode = 't126' and ifnull(fund_month,'') = '' and perAuditFlag = '1' and
				c01 = concat(orgId,'') and c40 in (select c01 from t141);
				/**if stemNum > 0 then
					set resultMsg = '当月已经申请前置变动待审核中！';
					leave label_pro; 
				end if;
				*/
				if jcJbNum > 0 then -- 警察加班
					update t152 set c15 = '1',
					c17 = 1,c18=1,c19=1,c20=1,c21=1,c22=1
					 where c01 = concat(orgId,'') 
					and ifnull(c15,'') != '1'   and ifnull(c15,'') != '2'  and ifnull(c13,'')!='11204';-- 判断警察加班（C15:月报审核基金状态）不等于待审核，通过的条件以及（C13：基金审核总状态）不等于（11204：通过）的数据不需要更新状态
				end if;
				if jcZqNum > 0 then -- 警察值勤
					update t153 set c18 = '1',
					c20 = 1,c21=1,c22=1,c23=1,c24=1,c25=1
					where c01 = concat(orgId,'') 
						and ifnull(c18,'') != '1'   and ifnull(c18,'') != '2'  and ifnull(c17,'')!='11204';-- 判断警察值勤（C18:月报审核基金状态）不等于待审核，通过的条件以及（C17：基金审核总状态）不等于（11204：通过）的数据不需要更新状态
				end if;
				if jbJbtNum > 0 then -- 艰边津补贴
					update t164 set c12 = '1',
					c14 = 1,c15=1,c16=1,c17=1,c18=1,c19=1
					where c01 = concat(orgId,'') 
					and ifnull(c12,'') != '1'   and ifnull(c12,'') != '2'  and ifnull(c10,'')!='11204';-- 判断艰边（C12:月报审核基金状态）不等于待审核，通过的条件以及（C10：基金审核总状态）不等于（11204：通过）的数据不需要更新状态
				end if;
					
				-- t141 前置审核配置表 select c01 from t141; c01 变动类型 ;
				-- select * from data_data_record where dataclassCode = 't126' and perAuditFlag = 0 and allAuditFlag = 0 and c01 = orgId and c40 in (select c01 from t141);
				if recordNum > 0 then -- 前置变动记录(record表)数量
					/*update data_data_record set perAuditFlag = 1,allAuditFlag = 0,
					firstFlag = 1,secondFlag=1,thirdFlag=1,forthFlag=1,fiveFlag=1,sixFlag=1,
					operateId = createrId,operateTime = SYSDATE()
					where dataclassCode = 't126' and perAuditFlag in(0,3,8,9,10) and allAuditFlag in(0,3,8,9,10)
					 and c01 = orgId and c40 in (select c01 from t141);
					
					update data_data_record a ,data_data_record b set a.perAuditFlag = 1,a.allAuditFlag = 0,
					a.firstFlag = 1,a.secondFlag=1,a.thirdFlag=1,a.forthFlag=1,a.fiveFlag=1,a.sixFlag=1,
					a.operateId = b.operateId,a.operateTime = b.operateTime
					where b.dataclassCode = 't126' and a.changeType = b.changeType and a.changeSign = b.changeSign 
					and b.c01 = orgId
					and a.perAuditFlag in(0,3,8,9,10)  and b.perAuditFlag = 1;*/
					
					update data_record_t126 set perAuditFlag = 1,allAuditFlag = 0,
					firstFlag = 1,secondFlag=1,thirdFlag=1,forthFlag=1,fiveFlag=1,sixFlag=1,
					operateId = createrId,operateTime = SYSDATE()
					where dataclassCode = 't126' and perAuditFlag in(0,3,8,9,10) and allAuditFlag in(0,3,8,9,10)
					 and c01 = concat(orgId,'') and c40 in (select c01 from t141);
					
					update data_record_t125 a ,data_record_t126 b set a.perAuditFlag = 1,a.allAuditFlag = 0,
					a.firstFlag = 1,a.secondFlag=1,a.thirdFlag=1,a.forthFlag=1,a.fiveFlag=1,a.sixFlag=1,
					a.operateId = b.operateId,a.operateTime = b.operateTime
					where -- b.dataclassCode = 't126' and 
					a.changeType = b.changeType and a.changeSign = b.changeSign 
					and b.c01 = concat(orgId,'')
					and a.perAuditFlag in(0,3,8,9,10)  and b.perAuditFlag = 1;
					update data_record_t117 a ,data_record_t126 b set a.perAuditFlag = 1,a.allAuditFlag = 0,
					a.firstFlag = 1,a.secondFlag=1,a.thirdFlag=1,a.forthFlag=1,a.fiveFlag=1,a.sixFlag=1,
					a.operateId = b.operateId,a.operateTime = b.operateTime
					where -- b.dataclassCode = 't126' and 
					a.changeType = b.changeType and a.changeSign = b.changeSign 
					and b.c01 = concat(orgId,'')
					and a.perAuditFlag in(0,3,8,9,10)  and b.perAuditFlag = 1;
				end if;
			end if;
		end if;
	end if;
	
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`cancelBeforeApply`(IN createrId int(11),IN orgId int(11),IN chanType int(11),
INOUT resultMsg  varchar(1000) CHARSET utf8)
label_pro:BEGIN
-- 输入参数：
-- 		createrId：操作人的编号，orgId：单位人的编号，resultMsg：描述

	-- 声明变量
	declare stemNum int(11);
	declare jcJbNum int(11);-- 警察加班
	declare jcZqNum int(11);-- 警察值勤
	declare jbJbtNum int(11);--  艰边津补贴
	declare recordNum int(11);-- 变动记录
		-- 撤回-前置申报
		if createrId = 0 then 
			set resultMsg = '操作人不能为空';
		else 
			if orgId = 0 then
				set resultMsg = '单位信息不能为空';
			else
				set resultMsg = "";
				
				-- 警察加班补贴
				select count(1) into jcJbNum from t152 where c01 = concat(orgId,'') 
					-- and EXISTS (select 1 from t126,sys_s_data d where d.id = t126.c03 and t126.id = t153.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
					and c15 = '1';-- 前置审核状态  0-未申报 1-待审核 2-审核通过 3-审核不通过
		
				-- 警察执勤津补贴
				select count(1) into jcZqNum from t153 where c01 = concat(orgId,'') 
				and c18 = '1';-- 前置审核状态  0-未申报 1-待审核 2-审核通过 3-审核不通过
		
				-- 艰边津贴补扣发
				select count(1) into jbJbtNum from t164 where c01 = concat(orgId,'') 
				and c12 = '1'; -- 前置审核状态  0-未申报 1-待审核 2-审核通过 3-审核不通过
		
				-- 0-未申报 1-待审核 2-审核通过 3-审核不通过 9-生成基金未上报 8-撤回 7-撤回申请中 10-统一撤回
				select count(1) into recordNum from data_record_t126 where dataclassCode = 't126' 
				and perAuditFlag = '1' and 
				c01 = concat(orgId,'') and c40 in (select c01 from t141);
				
				if recordNum = 0 and jbJbtNum = 0 and jcZqNum = 0 and jcJbNum = 0 then
					set resultMsg = '目前没有前置变动数据上报,不用撤回';
					leave label_pro; 
				end if;
				
				-- 存在月报数据待审核中
				select count(1) into stemNum from fund_audit_record where unit_id = concat(orgId,'') and ifnull(fund_status,'') = '1';
				if stemNum > 0 then
					set resultMsg = '存在月报数据待审核';
					leave label_pro;
				end if;
				
				-- 存在月报数据撤回申请中
				select count(1) into stemNum from fund_audit_record where unit_id = concat(orgId,'') and ifnull(fund_status,'') = '7';
				if stemNum > 0 then
					set resultMsg = '存在月报数据撤回申请中';
					leave label_pro; 
				end if;
				
				set resultMsg = '';
				if chanType > 0 then -- 撤回的变动记录类型不为空
					select name into @changeTypeName from sys_s_data where id = chanType;
					if position('艰' in @changeTypeName) > 0 then -- 艰边
						if jbJbtNum > 0 then --  艰边津补贴
							update t164 set c12 = '8',
							c14 = 8,c15=8,c16=8,c17=8,c18=8,c19=8
							where c01 = concat(orgId,'') 
							and c12 ='1';
						end if;
					else 
						if position('加班' in @changeTypeName) > 0 then -- 警察 加班
							if jcJbNum > 0 then -- 警察加班
								update t152 set c15 = '8',
								c17 = 8,c18=8,c19=8,c20=8,c21=8,c22=8
								 where c01 = concat(orgId,'') 
								and c15 ='1';
							end if;
						else 
							if position('值勤' in @changeTypeName) > 0 then -- 警察 值勤
								if jcZqNum > 0 then -- 警察值勤
									update t153 set c18 = '8',
									c20 = 8,c21=8,c22=8,c23=8,c24=8,c25=8
									where c01 = concat(orgId,'') 
									and c18 ='1';
								end if;
							else -- 其它在data_data_record里面的变动
								if recordNum > 0 then 
									-- 修改单条审核状态和全部审核状态为：8（撤回）
									update data_record_t126 set perAuditFlag = 8 , 
									firstFlag = 8,secondFlag = 8,thirdFlag = 8,forthFlag = 8,fiveFlag = 8,sixFlag = 8,
									operateId = createrId,operateTime = SYSDATE()
									where -- dataclassCode = 't126' and 
									c01 = concat(orgId,'') 
									and perAuditFlag = 1
									and c40 = chanType
									;-- and c40 in (select c01 from t141);
									
									-- 修改相关联表的审核状态
									update data_record_t125 a ,data_record_t126 b set a.perAuditFlag = 8 ,
									a.firstFlag = 8,a.secondFlag = 8,a.thirdFlag = 8,a.forthFlag = 8,a.fiveFlag = 8,a.sixFlag = 8,
									a.operateId = b.operateId,a.operateTime = b.operateTime
									where -- b.dataclassCode = 't126' and 
										a.changeType = b.changeType
									 and a.changeSign = b.changeSign and b.c40 = chanType 
									and a.perAuditFlag = 1 and b.perAuditFlag = 8;
									update data_record_t117 a ,data_record_t126 b set a.perAuditFlag = 8 ,
									a.firstFlag = 8,a.secondFlag = 8,a.thirdFlag = 8,a.forthFlag = 8,a.fiveFlag = 8,a.sixFlag = 8,
									a.operateId = b.operateId,a.operateTime = b.operateTime
									where -- b.dataclassCode = 't126' and 
									a.changeType = b.changeType
									 and a.changeSign = b.changeSign and b.c40 = chanType 
									and a.perAuditFlag = 1 and b.perAuditFlag = 8;
								end if;
							end if;
						end if;
					end if;
				else
					-- 此处写所有的变动记录过程

					-- t141：前置审核配置表 select c01 from t141; 
					-- c01 变动类型 ：1-待审核，2-审核通过 ，3-审核不通过， 9-月报生成未上报， 8-撤回。
					
					if jcJbNum > 0 then -- 警察加班
						update t152 set c15 = '8',
						c17 = 8,c18=8,c19=8,c20=8,c21=8,c22=8
						 where c01 = concat(orgId,'') 
						and c15 ='1';
					end if;
					if jcZqNum > 0 then -- 警察值勤
						update t153 set c18 = '8',
						c20 = 8,c21=8,c22=8,c23=8,c24=8,c25=8
						where c01 = concat(orgId,'') 
						and c18 ='1';
					end if;
					if jbJbtNum > 0 then --  艰边津补贴
						update t164 set c12 = '8',
						c14 = 8,c15=8,c16=8,c17=8,c18=8,c19=8
						where c01 = concat(orgId,'') 
						and c12 ='1';
					end if;
					
					if recordNum > 0 then 
						-- 修改单条审核状态和全部审核状态为：8（撤回）
						update data_record_t126 set perAuditFlag = 8 ,
						firstFlag = 8,secondFlag = 8,thirdFlag = 8,forthFlag = 8,fiveFlag = 8,sixFlag = 8,
						operateId = createrId,operateTime = SYSDATE()
						where -- dataclassCode = 't126' and 
						perAuditFlag = 1 and c01 = concat(orgId,'') and c40 in (select c01 from t141);
						
						-- 修改相关联表的审核状态
						update data_record_t125 a ,data_record_t126 b set a.perAuditFlag = 8 ,
						a.firstFlag = 8,a.secondFlag = 8,a.thirdFlag = 8,a.forthFlag = 8,a.fiveFlag = 8,a.sixFlag = 8,
						a.operateId = b.operateId,a.operateTime = b.operateTime
						where -- b.dataclassCode = 't126' and 
						a.changeType = b.changeType and a.changeSign = b.changeSign 
						and a.perAuditFlag = 1 and b.perAuditFlag = 8;
						update data_record_t117 a ,data_record_t126 b set a.perAuditFlag = 8 ,
						a.firstFlag = 8,a.secondFlag = 8,a.thirdFlag = 8,a.forthFlag = 8,a.fiveFlag = 8,a.sixFlag = 8,
						a.operateId = b.operateId,a.operateTime = b.operateTime
						where -- b.dataclassCode = 't126' and 
						a.changeType = b.changeType and a.changeSign = b.changeSign 
						and a.perAuditFlag = 1 and b.perAuditFlag = 8;
					end if;
				end if;
			end if;
		end if;
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`clear_column`()
BEGIN
	-- 删除门户栏目相关数据并将自增长id清0
  delete from sys_s_column;
	delete from sys_s_columnrelation;
	delete from sys_s_columnright;
	alter table sys_s_column auto_increment = 1;
	alter table sys_s_columnrelation auto_increment = 1;
	alter table sys_s_columnright auto_increment = 1;
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`clear_dataunit`()
BEGIN

-- 初始化应用管理与服务相关数据(为数据源表添加触发器，当删除数据源时同步删除数据源的字段、条件、排序等)
delete from data_source;
delete from data_unit;
delete from data_unit_conditions;
delete from dataunit_model where type != 3;-- 门户模板不进行清理
delete from dataunit_model_columns;
delete from dataunit_function;

END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`clear_pm`()
BEGIN
 -- 删除流程相关数据并将自增长id清0
  delete from pm_data;
 delete from pm_type;
 delete from pm_type_node;
 delete from pm_type_node_premission;
 delete from pm_type_node_role;
 alter table pm_data auto_increment = 1;
 alter table pm_type auto_increment = 1;
 alter table pm_type_node auto_increment = 1;
 alter table pm_type_node_premission auto_increment = 1;
 alter table pm_type_node_role auto_increment = 1;
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`clear_portal`()
BEGIN
 -- 删除门户相关数据
  delete from sys_s_column;
 delete from sys_s_columnrelation;
 delete from sys_s_columnright;
 delete from data_item where dataclasscode = 'tp' and id > 10;
 delete from data_data where dataclasscode = 'tp';
 -- delete from dataunit_model where type = 3;-- 门户模板不进行清理
 alter table sys_s_column auto_increment = 1;
 alter table sys_s_columnrelation auto_increment = 1;
 alter table sys_s_columnright auto_increment = 1;
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`clear_sys`()
BEGIN

-- 初始化系统相关数据
delete from sys_s_user where id > 1;
delete from sys_s_role where id > 2;
delete from sys_s_org;
delete from sys_s_log;
delete from sys_s_userrole;
delete from sys_s_config;
delete from sys_s_data;
delete from sys_s_datatype;

 alter table sys_s_user auto_increment = 2;
 alter table sys_s_role auto_increment = 3;
 alter table sys_s_org auto_increment = 1;
 alter table sys_s_log auto_increment = 1;
 alter table sys_s_userrole auto_increment = 1;
 alter table sys_s_config auto_increment = 1;
 alter table sys_s_data auto_increment = 1;
 alter table sys_s_datatype auto_increment = 1;

END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`deleteNotExistsAtt`(inout resultMsg varchar(10000))
label_pro:BEGIN	
	/**
	tableName-查询表 fund_total_gov/fund_total_ins
	unit_id-单位id
	fund_month-基金月份
	*/
		-- 获取sys_s_data 表dataId的所有上级  
	DECLARE sTemp int(11);
    -- DECLARE sTempJbtCodeSalary VARCHAR(1000);
    DECLARE jbtLength int(11);
    DECLARE stempCount int(11);
    DECLARE sTemRecordId int(11);

    declare i int;


DECLARE done INT DEFAULT FALSE;
-- 
DECLARE recordId_ CURSOR FOR
SELECT t125.id from data_record_t125 t125
		where 
LENGTH(c48)>0
;
DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
set @i= 0;
	-- 打开游标
  OPEN recordId_;  
  -- 开始循环
  read_loop: LOOP
    -- 提取游标里的数据，这里只有一个，多个的话也一样；
    FETCH recordId_ INTO sTemRecordId;
    -- 声明结束的时候
    IF done THEN
      LEAVE read_loop;
    END IF;
		
	
					select id,c06,c48 into @i2,@c06,@atts from data_record_t125 where id = sTemRecordId and LENGTH(c48)>0  limit 1;
						set @lastAtts = @atts;
						if LENGTH(@atts) >0 then 
								select REPLACE(REPLACE( SUBSTRING_INDEX(@atts	,',',1), SUBSTRING_INDEX(@atts,',',0),''),',','') into @temp;
								if LENGTH(@temp) > 0 then
										select COUNT(1) into @count from data_attachment where id = @temp;
										if @count = 0 THEN
											set @lastAtts = REPLACE(@lastAtts,@temp,'');
										end if;
								end if;

								select REPLACE(REPLACE( SUBSTRING_INDEX(@atts	,',',2), SUBSTRING_INDEX(@atts,',',1),''),',','') into @temp;
								if LENGTH(@temp) > 0 then
										select COUNT(1) into @count from data_attachment where id = @temp;
										if @count = 0 THEN
											set @lastAtts = REPLACE(@lastAtts,@temp,'');
										end if;
								end if;

								select REPLACE(REPLACE( SUBSTRING_INDEX(@atts	,',',3), SUBSTRING_INDEX(@atts,',',2),''),',','') into @temp;
								if LENGTH(@temp) > 0 then
										select COUNT(1) into @count from data_attachment where id = @temp;
										if @count = 0 THEN
											set @lastAtts = REPLACE(@lastAtts,@temp,'');
										end if;
								end if;

								select REPLACE(REPLACE( SUBSTRING_INDEX(@atts	,',',4), SUBSTRING_INDEX(@atts,',',3),''),',','') into @temp;
								if LENGTH(@temp) > 0 then
										select COUNT(1) into @count from data_attachment where id = @temp;
										if @count = 0 THEN
											set @lastAtts = REPLACE(@lastAtts,@temp,'');
										end if;
								end if;

								select REPLACE(REPLACE( SUBSTRING_INDEX(@atts	,',',5), SUBSTRING_INDEX(@atts,',',4),''),',','') into @temp;
								if LENGTH(@temp) > 0 then
										select COUNT(1) into @count from data_attachment where id = @temp;
										if @count = 0 THEN
											set @lastAtts = REPLACE(@lastAtts,@temp,'');
										end if;
								end if;

								select REPLACE(REPLACE( SUBSTRING_INDEX(@atts	,',',6), SUBSTRING_INDEX(@atts,',',5),''),',','') into @temp;
								if LENGTH(@temp) > 0 then
										select COUNT(1) into @count from data_attachment where id = @temp;
										if @count = 0 THEN
											set @lastAtts = REPLACE(@lastAtts,@temp,'');
										end if;
								end if;

								select REPLACE(REPLACE( SUBSTRING_INDEX(@atts	,',',7), SUBSTRING_INDEX(@atts,',',6),''),',','') into @temp;
								if LENGTH(@temp) > 0 then
										select COUNT(1) into @count from data_attachment where id = @temp;
										if @count = 0 THEN
											set @lastAtts = REPLACE(@lastAtts,@temp,'');
										end if;
								end if;

								select REPLACE(REPLACE( SUBSTRING_INDEX(@atts	,',',8), SUBSTRING_INDEX(@atts,',',7),''),',','') into @temp;
								if LENGTH(@temp) > 0 then
										select COUNT(1) into @count from data_attachment where id = @temp;
										if @count = 0 THEN
											set @lastAtts = REPLACE(@lastAtts,@temp,'');
										end if;
								end if;

								select REPLACE(REPLACE( SUBSTRING_INDEX(@atts	,',',9), SUBSTRING_INDEX(@atts,',',8),''),',','') into @temp;
								if LENGTH(@temp) > 0 then
										select COUNT(1) into @count from data_attachment where id = @temp;
										if @count = 0 THEN
											set @lastAtts = REPLACE(@lastAtts,@temp,'');
										end if;
								end if;

								select REPLACE(REPLACE( SUBSTRING_INDEX(@atts	,',',10), SUBSTRING_INDEX(@atts,',',9),''),',','') into @temp;
								if LENGTH(@temp) > 0 then
										select COUNT(1) into @count from data_attachment where id = @temp;
										if @count = 0 THEN
											set @lastAtts = REPLACE(@lastAtts,@temp,'');
										end if;
								end if;

								select REPLACE(REPLACE( SUBSTRING_INDEX(@atts	,',',11), SUBSTRING_INDEX(@atts,',',10),''),',','') into @temp;
								if LENGTH(@temp) > 0 then
										select COUNT(1) into @count from data_attachment where id = @temp;
										if @count = 0 THEN
											set @lastAtts = REPLACE(@lastAtts,@temp,'');
										end if;
								end if;

								select REPLACE(REPLACE( SUBSTRING_INDEX(@atts	,',',12), SUBSTRING_INDEX(@atts,',',11),''),',','') into @temp;
								if LENGTH(@temp) > 0 then
										select COUNT(1) into @count from data_attachment where id = @temp;
										if @count = 0 THEN
											set @lastAtts = REPLACE(@lastAtts,@temp,'');
										end if;
								end if;

								if LENGTH(@lastAtts) != LENGTH(@atts) THEN		
											set @i = @i+1;
										update data_record_t125 set c48 = @lastAtts where id = @i2;
								end if;
					
						end if;






	
  END LOOP;
  -- 关闭游标
  CLOSE recordId_;



select '清除变动记录附件条数：',@i;



   END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`ds_import`(INOUT `ds_import` int)
BEGIN
	


END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`fillCount`(IN v_unit_dataId varchar(200),
IN changeId int(11),IN changeType varchar(200) ,
IN chaSign varchar(200),
IN fundMonth varchar(20),
INOUT resultMsg  varchar(1000) CHARSET utf8)
label_pro:BEGIN	
-- changeId 变动记录id 主要是t126的变动记录id,此id来查询所有关联的工资t125,津贴t117 变动记录
	DECLARE departId varchar(100);-- 单位id
	DECLARE departCode varchar(100);-- 单位代码
	DECLARE staffId varchar(100);-- 人员id
	DECLARE staffName varchar(100);-- 人员姓名
	DECLARE staffNo varchar(100);-- 人员编号
	DECLARE salaryId varchar(100);-- 工资信息的Id
	DECLARE salaryRecordId varchar(100);-- 工资信息的recordId
	DECLARE bdbkk double DEFAULT 0;-- 变动补扣款
	DECLARE bdmybkk double DEFAULT 0;-- 变动每月补扣款
	DECLARE sTempBdbkk double DEFAULT 0;-- 变动每月补扣款-
	DECLARE sTempBdmybkk double DEFAULT 0;-- 变动每月补扣款-
	DECLARE jjyf varchar(100);-- 变动生效月份 基金月份 201606
	DECLARE changeTypeCode varchar(100);-- 变动类型code
	DECLARE qxsj varchar(100);-- 起薪时间
	DECLARE txsj varchar(100);-- 停薪时间
	DECLARE zwgz varchar(100);-- 职务工资
	DECLARE gwgz varchar(100);-- 岗位工资
	DECLARE jhtg varchar(100) DEFAULT 0;-- 教师护士提高10%
	DECLARE tjtg varchar(100) DEFAULT 0;-- 特殊教育提高15%
	DECLARE bltg varchar(100) DEFAULT 0;-- 保留特岗工资
	DECLARE bljs varchar(100) DEFAULT 0;-- 保留教师10%
	DECLARE blhs varchar(100) DEFAULT 0;-- 保留护士10%
	DECLARE psxlj varchar(100) DEFAULT 0;-- 平时训练奖
	DECLARE jcjx varchar(100) DEFAULT 0;-- 基础绩效
	DECLARE jbt varchar(100);-- 津补贴
	DECLARE gzxj varchar(100);-- 当月基本工资小计 
	DECLARE rysf varchar(100);-- 人员身份 jg-机关 sy-事业
	DECLARE sTempRecordIds varchar(100);-- 人员身份 jg-机关 sy-事业
	DECLARE sTempSigns varchar(1000);-- 人员身份 jg-机关 sy-事业
	DECLARE bdYear varchar(100);-- 变动时间-截取 年
	DECLARE bdMonth varchar(100);-- 变动时间-截取 月
	DECLARE qxYear varchar(100);-- 起薪时间-截取 年
	DECLARE qxMonth varchar(100);-- 起薪时间-截取 月
	DECLARE qxYearMonth varchar(100);-- 起薪时间-截取 年月 201607
	
	DECLARE jjqxMonth int(11) DEFAULT 0;-- 变动时间对应的下月(基金月份)-(减去)起薪时间的月份 201606变动-201505起薪 结果: 12+1+1=14 201607月份发工资 补发 201607-201505个月  14个月
	DECLARE sTempNum int(11) DEFAULT 0;-- 参数
	DECLARE sTempYearMonth varchar(6);-- 
	DECLARE sTempParam varchar(20);-- 变量
	
	DECLARE nextYearMonth varchar(6);-- 下月份 201607 可能是基金月份
	DECLARE nextYear varchar(6);-- 下个月所在年份 2016
	DECLARE nextMonth varchar(6);-- 下月份 07
	DECLARE nextDay varchar(6);-- 下月份 20160707
	
	
	DECLARE preId int(11);-- 当前变动 起薪时间对应的t126的变动id
	DECLARE preZwgz double DEFAULT 0;-- 当前变动 起薪时间对应的t125的职务工资
	DECLARE preGwgz double DEFAULT 0;-- 当前变动 起薪时间对应的t125的级别工资/岗位工资
	DECLARE preJhtg varchar(100) DEFAULT 0;-- 当前变动 起薪时间对应的t125的教师护士提高10%
	DECLARE preTjtg varchar(100) DEFAULT 0;-- 当前变动 起薪时间对应的t125的特殊教育提高15%
	DECLARE preBltg varchar(100) DEFAULT 0;-- 当前变动 起薪时间对应的t125的保留特岗工资
	DECLARE preBljs varchar(100) DEFAULT 0;-- 当前变动 起薪时间对应的t125的保留教师10%
	DECLARE preBlhs varchar(100) DEFAULT 0;-- 当前变动 起薪时间对应的t125的保留护士10%
	DECLARE prePsxlj varchar(100) DEFAULT 0;-- 当前变动 起薪时间对应的t125的平时训练奖
	DECLARE preJcjx varchar(100) DEFAULT 0;-- 当前变动 起薪时间对应的t125的基础津贴
	DECLARE preJbt double DEFAULT 0;-- 当前变动 起薪时间对应的t125的津补贴
	DECLARE preHxbkf double DEFAULT 0;-- 当前变动 起薪时间对应的后续补扣发
	DECLARE preYfgzxj double DEFAULT 0;-- 当前变动 起薪时间对应的 上次应发工资合计 除开当月实际补扣发 不算本次操作的补扣发金额(基本工资小计+后续补扣发)
	DECLARE preYfGzhj double DEFAULT 0;-- 当前变动 起薪时间对应的t125的应发工资合计(不算当月实际补扣发)(基本工资小计+后续补扣发+本次操作的补扣发金额)
	DECLARE preChangeSign varchar(100);-- 当前变动 起薪时间对应的t125的工资合计
-- DECLARE preXj double;-- 当前变动 起薪时间对应的t125的小计 除开[津补贴,一次性补扣发(加班值勤,年终一次奖金,其它一次性补扣发)]
	DECLARE preBkf double DEFAULT 0;-- 当前变动 起薪时间对应的 补扣发
	DECLARE preGz double DEFAULT 0;-- 当前变动 起薪时间对应的 工资(级别工资+岗位工资+其它工资项+津补贴)[不计补扣款]
	
	DECLARE monthCount int(11) DEFAULT 0;-- 当前变动 起薪时间对应的 工资发放表数量 如果 <1 则表示没有生成 发放表
	DECLARE recordCount int(11) DEFAULT 0;-- 

	DECLARE subZwgz double DEFAULT 0;-- 当前变动与起薪时间的职务工资差
	DECLARE subGwgz double DEFAULT 0;-- 当前变动与起薪时间的级别/岗位工资差
	DECLARE subJhtg double DEFAULT 0;-- 当前变动与起薪时间的教师护士提高10%
	DECLARE subTjtg double DEFAULT 0;-- 当前变动与起薪时间的特殊教育提高15%
	DECLARE subBltg double DEFAULT 0;-- 当前变动与起薪时间的保留特岗工资
	DECLARE subBljs double DEFAULT 0;-- 当前变动与起薪时间的保留教师10%
	DECLARE subBlhs double DEFAULT 0;-- 当前变动与起薪时间的保留护士10%
	DECLARE subPsxlj double DEFAULT 0;-- 当前变动与起薪时间的平时训练奖
	DECLARE subJcjx double DEFAULT 0;-- 当前变动与起薪时间的基础绩效
	DECLARE subJbt double DEFAULT 0;-- 当前变动与起薪时间的津补贴
	DECLARE subGz double DEFAULT 0;-- 当前变动与起薪时间的工资小计差
	
	DECLARE sumZwgz double DEFAULT 0;-- 当前变动与起薪时间的职务工资-补扣发总和
	DECLARE sumGwgz double DEFAULT 0;-- 当前变动与起薪时间的级别/岗位工资-补扣发总和
	DECLARE sumJhtg double DEFAULT 0;-- 当前变动与起薪时间的教师护士提高10%-补扣发总和
	DECLARE sumTjtg double DEFAULT 0;-- 当前变动与起薪时间的特殊教育提高15%-补扣发总和
	DECLARE sumBltg double DEFAULT 0;-- 当前变动与起薪时间的保留特岗工资-补扣发总和
	DECLARE sumBljs double DEFAULT 0;-- 当前变动与起薪时间的保留教师10%-补扣发总和
	DECLARE sumBlhs double DEFAULT 0;-- 当前变动与起薪时间的保留护士10%-补扣发总和
	DECLARE sumPsxlj double DEFAULT 0;-- 当前变动与起薪时间的平时训练奖-补扣发总和
	DECLARE sumJcjx double DEFAULT 0;-- 当前变动与起薪时间的基础绩效-补扣发总和
	DECLARE sumJbt double DEFAULT 0;-- 当前变动与起薪时间的津补贴-补扣发总和
	DECLARE sumGz double DEFAULT 0;-- 当前变动与起薪时间的工资小计-补扣发总和
									
	DECLARE v_unit_id varchar(50);-- 单位代码

	declare sysDataBase varchar(20);-- 数据库名称
	select ifnull(content,'smso') into sysDataBase from sys_s_config where enname = 'DATABASE_NAME';-- 数据库名称
	
	select c01 into v_unit_id from t111 where id = v_unit_dataId;-- t111.c01 单位代码

	select count(1) into recordCount from data_record_t126 where id = changeId and ( allAuditFlag = '2' or allAuditFlag = '1');
	if recordCount > 0 then -- 操作记录已经审核上报或通过
		leave label_pro;
	end if;	
	select count(1) into recordCount from record_fill_tail where change_id = changeId;
	delete from record_fill_tail where change_id = changeId; 
	
	select DATE_FORMAT(DATE_ADD(now(),INTERVAL 1 MONTH),'%Y'),DATE_FORMAT(DATE_ADD(now(),INTERVAL 1 MONTH),'%m'),
	DATE_FORMAT(DATE_ADD(now(),INTERVAL 1 MONTH),'%d'),DATE_FORMAT(DATE_ADD(now(),INTERVAL 1 MONTH),'%Y%m')
	 into nextYear,nextMonth,nextDay,nextYearMonth;
	if v_unit_dataId = 0 then 
		set resultMsg = '单位id不能为空';
		leave label_pro;
	else 
		-- 此处先判断是否所有的都通过了
		set resultMsg = '';
		-- select from t111 where id = v_unit_dataId;
		select data_value into changeTypeCode from sys_s_data where id = changeType;-- 变动类型code
		-- t126 人员基本信息表  c01-单位id,c02-人员编号,c04-人员姓名,c41-变动时间
		select dataId,c01,c02,c04 into staffId,departId,staffNo,staffName 
		from data_record_t126 where id = changeId ;
		if staffId = null then 
			set resultMsg = '数据获取不正确';
			leave label_pro;
		else 
			if staffId = 0 THEN	
				set resultMsg = '数据获取不正确';
				leave label_pro;
			end if;
		end if ;
		select c01 into departCode from t111 where id = departId;-- 获取单位代码
		-- t125 人员工资信息表 c02-起薪时间 c25-职务/职级工资 c26-级别/岗位工资 c27-津补贴合计 c32-工资合计/工资小计 除开补扣款
		-- c28-教师护士提高10% c29-特殊教育提高15% c30-保留特岗工资 c44-中小学教师保留10%工资 c45-保留护士提高10%工资 c47-平时训练奖 c31-基础绩效
		
		select id ,dataId ,c02,c25,c26,c27,c32,
		case when ifnull(c28,'')='' then 0 else c28 end,case when ifnull(c29,'')='' then 0 else c29 end,
		case when ifnull(c30,'')='' then 0 else c30 end,case when ifnull(c44,'')='' then 0 else c44 end,
		case when ifnull(c45,'')='' then 0 else c45 end,case when ifnull(c47,'')='' then 0 else c47 end
		into salaryRecordId,salaryId,qxsj,zwgz,gwgz,jbt,gzxj,jhtg,tjtg,bltg,bljs,blhs,psxlj
		from data_record_t125 where changeSign = chaSign ;
		
		if changeTypeCode = '15' || changeTypeCode = '08' then -- 15停发工资  08人员减少 
			select if(length(c38)>7,substr(c38,1,7),c38) into txsj from data_record_t125 where changeSign = chaSign ;
			-- c38 停薪时间
			 set qxsj = txsj;
		end if;
		
		 -- select group_concat(id),GROUP_CONCAT(changeSign) INTO sTempRecordIds,sTempSigns from data_data_record where dataclassCode = 't125' and c02 >= qxsj;-- c02 起薪时间
		-- select REPLACE(SUBSTR(content FROM 1 FOR 7),'-','') into sTempParam from sys_s_config where enname = 'SOFT_UPDATE_DATE';-- 软件上新时间 
		set qxsj = replace(qxsj,'-','');-- 2016-07 to 201607	
		set qxsj = concat(qxsj,'01'); -- 201607 to 20160701
		if ''!= fundMonth then
			set jjyf = fundMonth;
		else
			set jjyf = nextYearMonth;-- 基金月份 先默认为下一个月
		end if;
		select Year(concat(fundMonth,'01')),Month(concat(fundMonth,'01')) into bdYear,bdMonth;
		select Year(qxsj),Month(qxsj),DATE_FORMAT(qxsj,'%Y%m') into qxYear,qxMonth,qxYearMonth;
		
		--  记录当前变动与前一条变动记录的差额 
		/**尚需要修改填充津补贴的差额
		delete from record_fill_subsidies where change_id -- 删除津补贴记录补扣发表
				in(select b.id from data_data_record a,data_data_record b 
				where a.dataclassCode = 't126' and a.id = changeId and a.changeSign = b.changeSign and 
				b.dataclassCode = 't117' );*/
			delete  c  from record_fill_subsidies c ,
				(select b.id as did from data_record_t126 a,data_record_t117 b
				where  a.id = changeId and a.changeSign = b.changeSign 
				) as d 
			where c.change_id = d.did;

		delete from record_fill_tail where change_id = changeId;-- 先删除已经存在的记录补扣发表
		update data_record_t126 set fund_month = jjyf where id = changeId;
		-- select count(1) into @preCount from data_record_t126 
		-- where dataId = staffId and c01=departId and id < changeId    ;
		-- 上面的判断方式如有来回调动的情况就不对了 
		select if(changetype='10750' or changetype='10832',0,1) into @preCount  from data_record_t126  a
		where a.id=changeId;
		if @preCount>0 then  -- 非录入新进人员
			select id into @preRecordId from data_record_t126 
			where c01=departId and dataId = staffId and id < changeId   
			order by id desc limit 0,1;
			if changeTypeCode = '07' then -- 人员基本信息修改
				leave label_pro; 
			end if;
			if changeTypeCode = '7201' then -- 年度工龄变更
				leave label_pro; 
			end if;
			if changeTypeCode = '74' || changeTypeCode = '75' then -- 其它变动  人员统发信息变动
				leave label_pro; 
			end if;
			if changeTypeCode = '08' then -- 08-人员减少 15-停发工资
				insert into record_fill_tail(staff_id,unit_id,unit_code,change_id,change_type,
				-- 								人员id	单位id	单位代码	变动id	变动类型
					zwgz_ce,gwgz_ce,
				-- 职务工资_补发 岗位工资_补发 
					jshstg_ce,tsjytg_ce,
					-- 教师护士提高_补发 特殊教育提高_补发
					bltggz_ce,jsblgz_ce,
					-- 保留特岗工资_补发 教师保留工资_补发
					hsblgz_ce,psxlj_ce,jxgz_ce,
					-- 护士保留工资_补发 平时训练奖_补发 绩效工资_补发
					jbt_salary_ce,part_total_salary_ce,total_salary_ce)
						-- 津补贴合计_补发 工资小计_补发 
				select staffId,departId,departCode,t126_2.id,t126_2.changeType,
					0-ifnull(t125_2.c25,0),0-ifnull(t125_2.c26,0),
					0-ifnull(t125_2.c28,0),0-ifnull(t125_2.c29,0),
					0-ifnull(t125_2.c30,0),0-ifnull(t125_2.c44,0),
					0-ifnull(t125_2.c45,0),0-ifnull(t125_2.c47,0),0-ifnull(t125_2.c31,0),
					0-ifnull(t125_2.c27,0),0-ifnull(t125_2.c32,0),0-ifnull(t125_2.c32,0)
					from 
					data_record_t126 t126_2,data_record_t125 t125_2
					where   t125_2.c06 = concat(t126_2.dataId ,'')  -- t125人员工资表 c06-人员编号 关联 t126人员基本信息表
					and t126_2.changeSign = t125_2.changeSign and t126_2.changeSign = chaSign;
				insert into record_fill_subsidies (
					change_id,staff_id,jbt_id,jbt_salary,jbt_salary_bf,
					-- 变动id 人员id  津补贴id	津补贴金额	津补贴补发
					/*jbt_salary_yf,*/jbt_salary_ce,fund_month,changeSign)
					-- 津补贴应发	津补贴差额			基金月份	变动标志
				select t117.id,t126.dataId,t117.c04,t117.c07,0,
					-- 变动id 人员id  津补贴id	津补贴金额	津补贴补发
					0-ifnull(t117.c07,0),jjyf,t126.changeSign
					-- 津补贴差额			基金月份	变动标志
				from data_record_t117 t117  join data_record_t126 t126 on t117.changeSign = t126.changeSign
				where  t117.changeSign = chaSign;
				-- set resultMsg = concat('chaSign:',chaSign);leave label_pro;
			else  -- 个别变动 
				/*select count(1) into @ZG 		from data_record_t126 t126_1 ,data_record_t125 t125_1,
					data_record_t126 t126_2,data_record_t125 t125_2
					where t126_1.dataclassCode = 't126' and t125_1.dataclassCode = 't125'
					and t126_2.dataclassCode = 't126' and t125_2.dataclassCode = 't125'
					and t126_1.dataId = t125_1.c06 -- t125人员工资表 c06-人员编号 关联 t126人员基本信息表
					and t126_2.dataId = t125_2.c06 -- t125人员工资表 c06-人员编号 关联 t126人员基本信息表
					and t126_1.changeSign = t125_1.changeSign and t126_1.id = @preRecordId 
					and t126_2.changeSign = t125_2.changeSign and t126_2.changeSign = chaSign
					and ((t125_1.c36 in(10469,10470,10471,11172,11270,11271) and t125_2.c36 in (10469,10470,10471,11172,11270,11271)) -- 没转岗的
						or (t125_1.c36 in(10472,10473) and t125_2.c36 in (10472,10473)));-- 没转岗的
				if @ZG >0 then -- 非不同职务序列转岗*/

					insert into record_fill_tail(staff_id,unit_id,unit_code,change_id,change_type,
					-- 								人员id	单位id	单位代码	变动id	变动类型
					zwgz,gwgz,
					-- 职务工资 岗位工资 
						jshstg,tsjytg,
						-- 教师护士提高 特殊教育提高
						bltggz,jsblgz,
						-- 保留特岗工资 教师保留工资
						hsblgz,psxlj,jxgz,
						-- 护士保留工资 平时训练奖 绩效工资
						jbt_salary,part_total_salary,total_salary,
						-- 津补贴合计 工资小计			工资合计
					zwgz_ce,gwgz_ce,
					-- 职务工资_补发 岗位工资_补发 
					jshstg_ce,tsjytg_ce,
					-- 教师护士提高_补发 特殊教育提高_补发
					bltggz_ce,jsblgz_ce,
					-- 保留特岗工资_补发 教师保留工资_补发
					hsblgz_ce,psxlj_ce,jxgz_ce,
					-- 护士保留工资_补发 平时训练奖_补发 绩效工资_补发
					jbt_salary_ce,part_total_salary_ce,total_salary_ce)
						-- 津补贴合计_补发 工资小计_补发 
					select staffId,departId,departCode,t126_2.id,t126_2.changeType,
					t125_2.c25,t125_2.c26,
					-- 职务工资 岗位工资 
						t125_2.c28,t125_2.c29,
						-- 教师护士提高 特殊教育提高
						t125_2.c30,t125_2.c44,
						-- 保留特岗工资 教师保留工资
						t125_2.c45,t125_2.c47,t125_2.c31,
						-- 护士保留工资 平时训练奖 绩效工资
						t125_2.c27,t125_2.c32,t125_2.c32,
						-- 津补贴合计 工资小计 工资合计
					round((ifnull(t125_2.c25,'')-ifnull(t125_1.c25,'')),2),round((ifnull(t125_2.c26,'')-ifnull(t125_1.c26,'')),2),
					round((ifnull(t125_2.c28,'')-ifnull(t125_1.c28,'')),2),round((ifnull(t125_2.c29,'')-ifnull(t125_1.c29,'')),2),
					round((ifnull(t125_2.c30,'')-ifnull(t125_1.c30,'')),2),round((ifnull(t125_2.c44,'')-ifnull(t125_1.c44,'')),2),
					round((ifnull(t125_2.c45,'')-ifnull(t125_1.c45,'')),2),round((ifnull(t125_2.c47,'')-ifnull(t125_1.c47,'')),2),round((ifnull(t125_2.c31,'')-ifnull(t125_1.c31,'')),2),
					round((ifnull(t125_2.c27,'')-ifnull(t125_1.c27,'')),2),round((ifnull(t125_2.c32,'')-ifnull(t125_1.c32,'')),2),round((ifnull(t125_2.c32,'')-ifnull(t125_1.c32,'')),2)
					from data_record_t126 t126_1 ,data_record_t125 t125_1,
					data_record_t126 t126_2,data_record_t125 t125_2
					where   t125_1.c06 = concat(t126_1.dataId ,'') -- t125人员工资表 c06-人员编号 关联 t126人员基本信息表
					and  t125_2.c06 = concat(t126_2.dataId ,'')  -- t125人员工资表 c06-人员编号 关联 t126人员基本信息表
					and t126_1.changeSign = t125_1.changeSign and t126_1.id = @preRecordId 
					and t126_2.changeSign = t125_2.changeSign and t126_2.changeSign = chaSign    ;
					-- and ((t125_1.c36 in(10469,10470,10471,11172,11270,11271) and t125_2.c36 in (10469,10470,10471,11172,11270,11271)) -- 没转岗的
						-- or (t125_1.c36 in(10472,10473) and t125_2.c36 in (10472,10473)));-- 没转岗的

					insert into record_fill_subsidies (
					change_id,staff_id,jbt_id,jbt_salary,jbt_salary_bf,
					-- 变动id 人员id  津补贴id	津补贴金额	津补贴补发
					/*jbt_salary_yf,*/jbt_salary_ce,fund_month,changeSign)
					-- 津补贴应发	津补贴差额			基金月份	变动标志
					select t117.id,t126.dataId,t117.c04,t117.c07,0,
						-- 变动id 人员id  津补贴id	津补贴金额	津补贴补发
						round((t117.c07-ifnull(t117_0.c07,0)),2),jjyf,t126.changeSign
						-- 津补贴差额			基金月份	变动标志
					from data_record_t117 t117 join data_record_t126 t126 on t117.changeSign = t126.changeSign 
					join data_record_t126 t126_0 on t126_0.dataId = t126.dataId
					left join data_record_t117 t117_0 on t117_0.changeSign = t126_0.changeSign 
					and t117.dataId = t117_0.dataId 
					where   t126_0.id =  @preRecordId 
					and t126.changeSign = chaSign;
				/*else
						-- 转岗（不同职务序列）
					insert into record_fill_tail(staff_id,unit_id,unit_code,change_id,change_type,
					-- 								人员id	单位id	单位代码	变动id	变动类型
						zwgz,gwgz,
						-- 职务工资 岗位工资 
							jshstg,tsjytg,
							-- 教师护士提高 特殊教育提高
							bltggz,jsblgz,
							-- 保留特岗工资 教师保留工资
							hsblgz,psxlj,jxgz,
							-- 护士保留工资 平时训练奖 绩效工资
							jbt_salary,part_total_salary,total_salary,
							-- 津补贴合计 工资小计			工资合计
						zwgz_ce,gwgz_ce,
					-- 职务工资_补发 岗位工资_补发 
						jshstg_ce,tsjytg_ce,
						-- 教师护士提高_补发 特殊教育提高_补发
						bltggz_ce,jsblgz_ce,
						-- 保留特岗工资_补发 教师保留工资_补发
						hsblgz_ce,psxlj_ce,jxgz_ce,
						-- 护士保留工资_补发 平时训练奖_补发 绩效工资_补发
						jbt_salary_ce,part_total_salary_ce,total_salary_ce)
							-- 津补贴合计_补发 工资小计_补发 
					select staffId,departId,departCode,t126_2.id,t126_2.changeType,
						t125_2.c25,t125_2.c26,
						-- 职务工资 岗位工资 
							t125_2.c28,t125_2.c29,
							-- 教师护士提高 特殊教育提高
							t125_2.c30,t125_2.c44,
							-- 保留特岗工资 教师保留工资
							t125_2.c45,t125_2.c47,t125_2.c31,
							-- 护士保留工资 平时训练奖 绩效工资
							t125_2.c27,t125_2.c32,t125_2.c32,
							-- 津补贴合计 工资小计 工资合计
						0-ifnull(t125_1.c25,''),0-ifnull(t125_1.c26,''),
						0-ifnull(t125_1.c28,''),0-ifnull(t125_1.c29,''),
						0-ifnull(t125_1.c30,''),0-ifnull(t125_1.c44,''),
						0-ifnull(t125_1.c45,''),0-ifnull(t125_1.c47,''),0-ifnull(t125_1.c31,''),
						0-ifnull(t125_1.c27,''),0-ifnull(t125_1.c32,''),0-ifnull(t125_1.c32,'')
						from data_record_t126 t126_1 ,data_record_t125 t125_1,
						data_record_t126 t126_2,data_record_t125 t125_2
						where 
						 t126_1.dataId = t125_1.c06 -- t125人员工资表 c06-人员编号 关联 t126人员基本信息表
						and t126_2.dataId = t125_2.c06 -- t125人员工资表 c06-人员编号 关联 t126人员基本信息表
						and t126_1.changeSign = t125_1.changeSign and t126_1.id = @preRecordId 
						and t126_2.changeSign = t125_2.changeSign and t126_2.changeSign = chaSign
						and ((t125_1.c36 in(10469,10470,10471,11172,11270,11271) and t125_2.c36 in (10472,10473)) -- 转岗的
							or (t125_1.c36 in(10472,10473) and t125_2.c36 in (10469,10470,10471,11172,11270,11271)));-- 转岗的

					insert into record_fill_subsidies (
					change_id,staff_id,jbt_id,jbt_salary,jbt_salary_bf,
					-- 变动id 人员id  津补贴id	津补贴金额	津补贴补发
					/*jbt_salary_yf,*//*jbt_salary_ce,fund_month,changeSign)
					-- 津补贴应发	津补贴差额			基金月份	变动标志
					select t117.id,t126.dataId,t117.c04,t117.c07,t117.c07,
						-- 变动id 人员id  津补贴id	津补贴金额	津补贴补发
						0-ifnull(t117_0.c07,0),jjyf,t126.changeSign
						-- 津补贴差额			基金月份	变动标志
					from data_record_t117 t117 join data_record_t126 t126 on t117.changeSign = t126.changeSign 
					join data_record_t126 t126_0 on t126_0.dataId = t126.dataId
					left join data_record_t117 t117_0 on t117_0.changeSign = t126_0.changeSign 
					and t117.dataId = t117_0.dataId 
					where  t126_0.id =  @preRecordId 
					and t126.changeSign = chaSign;
				end if;	*/
			end if;
		else -- 录入新进人员

			insert into record_fill_tail(staff_id,unit_id,unit_code,change_id,change_type,
			-- 	 变动记录主表							人员id	单位id	单位代码	变动id	变动类型
				zwgz,gwgz,
				-- 职务工资 岗位工资 
					jshstg,tsjytg,
					-- 教师护士提高 特殊教育提高
					bltggz,jsblgz,
					-- 保留特岗工资 教师保留工资
					hsblgz,psxlj,jxgz,
					-- 护士保留工资 平时训练奖 绩效工资
					jbt_salary,part_total_salary,total_salary,
					-- 津补贴合计 工资小计			工资合计
				zwgz_ce,gwgz_ce,
			-- 职务工资_补发 岗位工资_补发 
				jshstg_ce,tsjytg_ce,
				-- 教师护士提高_补发 特殊教育提高_补发
				bltggz_ce,jsblgz_ce,
				-- 保留特岗工资_补发 教师保留工资_补发
				hsblgz_ce,psxlj_ce,jxgz_ce,
				-- 护士保留工资_补发 平时训练奖_补发 绩效工资_补发
				jbt_salary_ce,part_total_salary_ce,total_salary_ce)
					-- 津补贴合计_补发 工资小计_补发 
			select staffId,departId,departCode,t126.id,t126.changeType,
				t125.c25,t125.c26,
				-- 职务工资 岗位工资 
					t125.c28,t125.c29,
					-- 教师护士提高 特殊教育提高
					t125.c30,t125.c44,
					-- 保留特岗工资 教师保留工资
					t125.c45,t125.c47,t125.c31,
					-- 护士保留工资 平时训练奖 绩效工资
					t125.c27,t125.c32,t125.c32,
					-- 津补贴合计 工资小计 工资合计
				t125.c25+0,t125.c26+0,
				t125.c28+0,t125.c29+0,
				t125.c30+0,t125.c44+0,
				t125.c45+0,t125.c47+0,t125.c31+0,
				t125.c27+0,t125.c32+0,t125.c32+0
				from data_record_t126 t126 ,data_record_t125 t125 
				where   t125.c06 = concat(t126.dataId ,'') -- t125人员工资表 c06-人员编号 关联 t126人员基本信息表
				and t126.changeSign = t125.changeSign and t126.changeSign = chaSign ;
			-- 更新变动记录相应补扣发详细表 insert into record_fill_tail(staffId,changeId,changeType,zwgz,zwgz_bf,gwgz,gwgz_bf
			insert into record_fill_subsidies (
					change_id,staff_id,jbt_id,jbt_salary,/*jbt_salary_bf,*/
					-- 变动id 人员id  津补贴id	津补贴金额	津补贴补发
					/*jbt_salary_yf,*/jbt_salary_ce,fund_month,changeSign)
					-- 津补贴应发	津补贴差额			基金月份	变动标志
				select t117.id,t126.dataId,t117.c04,t117.c07,
					-- 变动id 人员id  津补贴id	津补贴金额	津补贴补发
					t117.c07+0,jjyf,t126.changeSign
					-- 津补贴差额			基金月份	变动标志
				from data_record_t117 t117 ,data_record_t126 t126 
				where  t117.changeSign = t126.changeSign 
				and t126.changeSign = chaSign;

		end if;
	
	-- 计算补扣发
		if jjyf=qxYearMonth then -- 基金月份等于起薪时间,不存在补扣发
			leave label_pro;
		end if;
		select PERIOD_DIFF(jjyf,qxYearMonth) into jjqxMonth;-- 计算当前变动时间对应基金月份与起薪时间之间相差基金月月份 20160601做的变动,20160501起薪,201607月发工资,补发7-5 2个月
		-- set jjqxMonth = (bdYear-qxYear)*12+bdMonth-qxMonth+2;-- 计算当前变动时间与起薪时间之间相差基金月月份 20160601做的变动,20160501起薪,201607月发工资,三个月 补发7-5 2个月
		if jjqxMonth>0 then -- 基金月份大于起薪 时间, 不计算补扣发 //变动时间与起薪时间相差月分+1为0表示不需要计算补扣发

			if changeTypeCode = '06' or changeTypeCode = '09' then -- 06-录入新进人员  09-接收调入人员 16-恢复发放工资
				set bdmybkk = gzxj;-- 工资小计		
				set bdbkk = bdmybkk*jjqxMonth + 0;--  每月补扣款 							
				update data_record_t126 set fillMoney = bdbkk,fillMonthMoney = bdmybkk,changeMonth = jjyf where changeSign = chaSign and id = changeId;
				/**尚需要修改填充津补贴的补扣发
				delete from record_fill_subsidies where change_id -- 删除津补贴记录补扣发表
					in(select b.id from data_data_record a,data_data_record b 
					where a.id = changeId and a.changeSign = b.changeSign and 
					b.dataclassCode = 't117' );*/
				delete  c  from record_fill_subsidies c ,
				(select b.id as did from data_record_t126 a,data_record_t117 b
				where  a.id = changeId and a.changeSign = b.changeSign 
				) as d 
				where c.change_id = d.did;

				insert into record_fill_subsidies (change_id,staff_id,jbt_id,jbt_salary,jbt_salary_bf,fund_month,changeSign,jbt_salary_ce)
				select a.id,a.c03,a.c04,a.c07,ifnull(ifnull(a.c07,0)*jjqxMonth,0),jjyf,a.changeSign,round(ifnull(a.c07,0),2)
				-- 变动记录id  人员编号 津补贴编号  金额       补扣发 基金月份 变动标志
				from data_record_t117 a,data_record_t126 b where b.id=changeId
				and a.changeSign = b.changeSign ;
				
				-- 更新操作记录补扣发表 补扣发 
				update record_fill_tail a,data_record_t126 t126,data_record_t125 t125 set
					a.fillNum = jjqxMonth,
					-- 补扣发月数
					a.zwgz_bf=t125.c25*jjqxMonth+0,a.gwgz_bf=t125.c26*jjqxMonth+0,
				-- 职务工资_补发 岗位工资_补发 
					a.jshstg_bf=t125.c28*jjqxMonth+0,a.tsjytg_bf=t125.c29*jjqxMonth+0,
					-- 教师护士提高_补发 特殊教育提高_补发
					a.bltggz_bf=t125.c30*jjqxMonth+0,a.jsblgz_bf=t125.c44*jjqxMonth+0,
					-- 保留特岗工资_补发 教师保留工资_补发
					a.hsblgz_bf=t125.c45*jjqxMonth+0,a.psxlj_bf=t125.c47*jjqxMonth+0,a.jxgz_bf=t125.c31*jjqxMonth+0,
					-- 护士保留工资_补发 平时训练奖_补发 绩效工资_补发
					a.jbt_salary_bf=t125.c27*jjqxMonth+0,a.part_total_salary_bf=t125.c32*jjqxMonth+0,a.total_salary_bf=t125.c32*jjqxMonth+0
				where   t126.id = a.change_id and t126.changeSign = t125.changeSign
				and  t125.c06 = concat(t126.dataId ,'') -- t125人员工资表 c06-人员编号 关联 t126人员基本信息表
				and t126.changeSign = chaSign ;
				
				set sTempNum = 0; 
				while sTempNum<jjqxMonth DO	
					set @sTempYearMonth = DATE_FORMAT(DATE_ADD(qxsj,INTERVAL sTempNum MONTH),'%Y%m');-- 起薪时间+1/2/3 	
					select count(1) into @sTempNum from information_schema.tables where table_schema = sysDataBase and TABLE_NAME = concat('fund_salary_pay','_',@sTempYearMonth);-- smso数据库里面对应的工资变动表信息
					if @sTempNum < 1 then -- 判断是否已经存在v_i_fund_month(如201608)的工资发放表信息
						SET @sqlstr = CONCAT('CREATE TABLE ','fund_salary_pay','_',@sTempYearMonth,' LIKE ', ' fund_salary_pay');
						PREPARE stmt FROM @sqlstr;
						EXECUTE stmt;
					end if;
					
					select count(1) into @sTempNum from information_schema.tables where table_schema = sysDataBase and TABLE_NAME = concat('fund_salary_subsidies_pay','_',@sTempYearMonth);-- smso数据库里面对应的工资变动表信息
					if @sTempNum < 1 then -- 判断是否已经存在v_i_fund_month(如201608)的工资发放表信息
						SET @sqlstr = CONCAT('CREATE TABLE ','fund_salary_subsidies_pay','_',@sTempYearMonth,' LIKE ', ' fund_salary_subsidies_pay');
						PREPARE stmt FROM @sqlstr;
						EXECUTE stmt;
					end if;
					
					SET @sqlstr = CONCAT('select count(1) into @monthCount from  fund_salary_pay_',@sTempYearMonth,' where  unit_id =  \'',departId,'\' and   staff_id = \'',staffId,'\' ');							
					PREPARE stmt FROM @sqlstr;
					EXECUTE stmt;
					
					SET @sqlstr = CONCAT('delete from  fund_salary_pay_',@sTempYearMonth,' where  unit_id =  \'',departId,'\' and   staff_id = \'',staffId,'\' ');							
					PREPARE stmt FROM @sqlstr;
					EXECUTE stmt;
					SET @sqlstr = CONCAT('delete from  fund_salary_subsidies_pay_',@sTempYearMonth,' where  unit_id =  \'',departId,'\' and   staff_id = \'',staffId,'\' ');							
					PREPARE stmt FROM @sqlstr;
					EXECUTE stmt;
					-- set resultMsg = concat(' @sqlstr:', @sqlstr);leave label_pro;
					-- if @monthCount < 1 then -- [staffName]起薪时间[qxYearMonth]无工资信息
						SET @pay_table =  CONCAT('fund_salary_pay_',@sTempYearMonth);/*工资发放表*/
						SET @pay_allowance_table =  CONCAT('fund_salary_subsidies_pay_',@sTempYearMonth);/*工资发放-津补贴表*/
						SET @sqlstr = CONCAT('INSERT INTO ', @pay_table,' (fund_month,unit_id,unit_code,staff_id,staff_name,staff_code,
								staff_eduLevel,staff_standing,staff_curPost,
								-- 学历			人员身份		现任职务
								staff_actual_workRank,staff_workRank,staff_isLeader,staff_postSalRank,staff_salRankLevel,
								-- 实际职务/技术等级	工资对应职级	是否领导工资	工资级别		工资档次
								-- staff_jobSal,staff_levelSal,staff_teacherNurseUpTen,staff_specialTeachFifteen,staff_keepSpecialStationSal,staff_midTeacherKeeyTen,staff_keepNurseUpTen,
								-- 职务/技术等级工资 级别岗位级别工资 教师护士提高10% 特殊教育提高15%			保留特岗工资			中小学教师保留10%工资	保留护士提高10%工资
								-- staff_peacetimeAward,staff_basicPerfor,
								-- 平时训练奖			基础绩效
								-- jbt_total_salary,total_salary,actual_total_salary,salary_value,theory_total_salary,
								-- 津补贴小计	工资合计	实发工资合计		工资补扣发		实际应发工资合计
								zwgz_byyb,
								--  职务/技术等级工资-本月变动应补补扣发
								gwgz_byyb,
								-- 级别岗位级别工资-本月变动应补补扣发
								jshstg_byyb,
								-- 教师护士提高10%-本月变动应补补扣发
								tsjytg_byyb,
								-- 特殊教育提高15%-本月变动应补补扣发
								bltggz_byyb,
								-- 保留特岗工资-本月变动应补补扣发
								jsblgz_byyb,
								-- 中小学教师保留10%-本月变动应补补扣发
								hsblgz_byyb,
								-- 保留护士提高10%-本月变动应补补扣发
								psxlj_byyb,
								-- 平时训练奖-本月变动应补补扣发
								jxgz_byyb,
								-- 基础绩效-本月变动应补补扣发
								jbt_salary_byyb,
								-- 津补贴小计-本月变动应补补扣发
								part_total_salary_byyb,
								-- 工资小计-本月变动应补补扣发
								total_salary_byyb,
								-- 工资小计-本月变动应补补扣发
								is_finSupt,is_salUniOut,department_name,
								-- 是否财政供养 是否财政统发 部门
								staff_wageSystem,staff_isUpten,staff_plusGrade,staff_downGrade,staff_plusLevel,staff_floatLevel,staff_fixLevel,staff_downLevel,
								-- 人员工资制度 是否提高10%工资  已含高定级别  已含低定级别		已含高定档次	已含浮动档次	已含固定档次	已含低定档次
								st_sal_date,en_sal_date,staff_status,staff_sex,staff_birth,staff_degree,staff_workYears,staff_from,staff_establish,
								-- 起薪时间 停薪时间	人员状态		性别		出生日期	学位		连续工龄	人员来源	人员编制
								staff_isFullTeacher,staff_salaryStandard,staff_isMainPart,staff_isStop,staff_partYears,staff_isMidTeacher,
								-- 是否专职教师		执行工资标准			是否主力		是否停薪		入队年限		是否中小学教师
								staff_isNurse,staff_fileNum,staff_titleRank,staff_isSpecialTeach,staff_salStandardDate)
								-- 是否护士		根据文号		衔级			是否特殊教育		工资标准时间
								select ',@sTempYearMonth,',',v_unit_dataId,',\'',v_unit_id,'\',t126.dataId,t126.c04,t126.c02,
									(select d.name from sys_s_data d where d.id = t126.c09) as xl,(select d.name from sys_s_data d where d.id = t126.c28) as sf,t126.c19,
								-- 学历			人员身份		现任职务
									(select d.name from sys_s_data d where d.id = t126.c36) as sjzj,(select d.c05 from t127 d where d.id = t126.c17) gzdyzj,(select d.c04 from t127 d where d.id = t126.c27) sfld,
								-- 实际职务/技术等级	工资对应职级	是否领导工资	
									(select d.c05 from t127 d where d.id = t125.c07) jb,(select d.c04 from t127 d where d.id = t125.c09) dc,
								--  工资级别		工资档次
									-- t125.c25,t125.c26,t125.c28,t125.c29,t125.c30,t125.c44,t125.c45,
								-- 职务/技术等级工资 级别岗位级别工资 教师护士提高10% 特殊教育提高15%			保留特岗工资			中小学教师保留10%工资	保留护士提高10%工资
									-- t125.c47,t125.c31,
								-- 平时训练奖			基础绩效
									-- t125.c27,t125.c32,t125.c32+sum(ifnull(c.total_salary_bf,0)),sum(c.total_salary_bf),t125.c32+0,
								-- 津补贴小计 工资合计	实发工资合计		工资补扣发		实际应发工资合计
									 t125.c25,t125.c26,
								-- 职务/技术等级工资-本月变动应补补扣发 级别岗位级别工资-本月变动应补补扣发
									t125.c28,t125.c29,
								-- 教师护士提高10%-本月变动应补补扣发  特殊教育提高15%-本月变动应补补扣发 
									t125.c30,t125.c44,t125.c45,
								-- 保留特岗工资-本月变动应补补扣发 中小学教师保留10%工资-本月变动应补补扣发 	保留护士提高10%工资-本月变动应补补扣发 	
									 t125.c47,t125.c31,
								-- 平时训练奖-本月变动应补补扣发			基础绩效-本月变动应补补扣发
									 t125.c27,t125.c32,t125.c32,
								-- 津补贴小计-本月变动应补补扣发 工资小计-本月变动应补补扣发	工资合计-本月变动应补补扣发
								(select d.name from sys_s_data d where d.id = t126.c24) sfczgy,(select d.name from sys_s_data d where d.id = t126.c22) sfcztf,(select c03 from t113 where id=t126.c15),
								-- 是否财政供养 是否财政统发 部门
								(select d.name from sys_s_data d where d.id = t125.c36) gzzd,(select d.name from sys_s_data d where d.id = t125.c23) sftg10,
								-- 人员工资制度 是否提高10%工资
								t125.c11,t125.c13,t125.c15,t125.c17,t125.c19,t125.c21,
								-- 人员工资制度 是否提高10%工资  已含高定级别  已含低定级别		已含高定档次	已含浮动档次	已含固定档次	已含低定档次
								t125.c02,t125.c38,\'增加\' ryzt,(select d.name from sys_s_data d where d.id = t126.c05) xb,
								-- 起薪时间 停薪时间	人员状态		性别		出生日期	学位		连续工龄	人员来源	人员编制
								t126.c08,(select d.name from sys_s_data d where d.id = t126.c10) xw,t126.c14,
								-- 出生日期	学位		连续工龄	
								(select d.name from sys_s_data d where d.id = t126.c16) ryly,(select d.name from sys_s_data d where d.id = t126.c21) rybz,
								-- 人员来源	人员编制
								(select d.name from sys_s_data d where d.id = t125.c39) sfzz,(select d.name from sys_s_data d where d.id = t126.c39) zxgzbz,
								-- 是否专职教师		执行工资标准 
								(select d.name from sys_s_data d where d.id = t126.c42) sfzl,(select d.name from sys_s_data d where d.id = t126.c43) sftx,
								--  是否主力		是否停薪
								t126.c45,(select d.name from sys_s_data d where d.id = t125.c01) sfzxxjs,
								--  是否主力		是否停薪		入队年限		是否中小学教师
								(select d.name from sys_s_data d where d.id = t125.c03) sfhs,t125.c04,(select d.name from sys_s_data d where d.id = t125.c24) xj,
								-- 是否护士		根据文号		衔级
								(select d.name from sys_s_data d where d.id = t125.c35) sftsjy,t125.c49
								-- 是否特殊教育		工资标准时间
							from data_record_t126 t126 join data_record_t125 t125 on t126.dataId = t125.c06 
							where 1=1 and t126.c01 = \'',v_unit_dataId,'\'
							and t126.changeSign = t125.changeSign and t126.changeSign = \'',chaSign,'\''
							);
						PREPARE stmt FROM @sqlstr;
						EXECUTE stmt;	
						SET @sqlstr = CONCAT('INSERT INTO ', @pay_allowance_table,'(fund_month,unit_id,unit_code,staff_id,
								allowance_id,allowance_title,salary_byyb,staff_salStandardDate)
								-- 津补贴id 		津补贴名称 	 津补贴金额  津补贴当月实际补发 津补贴后续补发  津补贴标准时间
							select ',@sTempYearMonth,',',v_unit_dataId,',\'',v_unit_id,'\',t117.c03,t117.c04,t116.c03,t117.c07,ifnull(t117.c01,DATE_FORMAT(ifnull(t117.updateDate,t117.createDate),\'%Y-%m-%d\'))
									-- 基金月分 	   单位代码(51036000) 人员id 津补贴id  津补贴名称 津补贴金额 津补贴当月实际补发 津补贴后续补发  津补贴标准时间
							from data_record_t117 t117 ,t116, data_record_t126 t126
							where 1=1 and   t117.changeSign = t126.changeSign and t126.changeSign = \'',chaSign,'\'
							and t117.c02 = \'',v_unit_dataId,'\' and t117.c04 = concat(t116.id,\'\')  and t117.c03 = concat(t126.dataId ,\'\')
							');
						PREPARE stmt FROM @sqlstr;
						EXECUTE stmt;
					-- end if;
					set sTempNum = sTempNum + 1;
				end while;
			else 
				if changeTypeCode = '08' then -- 08-人员减少 15-停发工资
					set bdmybkk = -gzxj;-- 工资小计		
					set bdbkk = bdmybkk*jjqxMonth + 0;--  变动补扣款
					update data_record_t126 set fillMoney = bdbkk,fillMonthMoney = bdmybkk,changeMonth = jjyf where changeSign = chaSign and id = changeId;
					-- 更新变动记录相应补扣发详细表
					/*delete from record_fill_subsidies where change_id 
						in(select b.id from data_data_record a,data_data_record b 
						where a.id = changeId and a.changeSign = b.changeSign and 
						b.dataclassCode = 't117' );*/
				delete  c  from record_fill_subsidies c ,
				(select b.id as did from data_record_t126 a,data_record_t117 b
				where  a.id = changeId and a.changeSign = b.changeSign ) as d 
				where c.change_id = d.did;
				commit;		 
					insert into record_fill_subsidies (change_id,staff_id,jbt_id,jbt_salary,jbt_salary_ce,jbt_salary_bf,fund_month,changeSign)
					select a.id,a.c03,a.c04,0,round(0-a.c07,2),round((round(0-ifnull(a.c07,0),2))*jjqxMonth,2),jjyf,a.changeSign
					-- 变动记录id  人员编号 津补贴编号  金额为0 津补贴差额       补扣发 基金月份 变动标志
					from data_record_t117 a,data_record_t126 b where b.id=changeId
					and a.changeSign = b.changeSign ;
					
					-- 更新操作记录补扣发表 补扣发
					update record_fill_tail a,data_record_t126 t126,data_record_t125 t125 set
						a.fillNum = jjqxMonth,
						-- 补扣发月数
						a.zwgz_bf=-t125.c25*jjqxMonth+0,a.gwgz_bf=-t125.c26*jjqxMonth+0,
					-- 职务工资_补发 岗位工资_补发 
						a.jshstg_bf=-t125.c28*jjqxMonth+0,a.tsjytg_bf=-t125.c29*jjqxMonth+0,
						-- 教师护士提高_补发 特殊教育提高_补发
						a.bltggz_bf=-t125.c30*jjqxMonth+0,a.jsblgz_bf=-t125.c44*jjqxMonth+0,
						-- 保留特岗工资_补发 教师保留工资_补发
						a.hsblgz_bf=-t125.c45*jjqxMonth+0,a.psxlj_bf=-t125.c47*jjqxMonth+0,a.jxgz_bf=-t125.c31*jjqxMonth+0,
						-- 护士保留工资_补发 平时训练奖_补发 绩效工资_补发
						a.jbt_salary_bf=-t125.c27*jjqxMonth+0,a.part_total_salary_bf=-t125.c32*jjqxMonth+0,a.total_salary_bf=-t125.c32*jjqxMonth+0
					where   t126.id = a.change_id and t126.changeSign = t125.changeSign
					and  t125.c06 = concat(t126.dataId ,'') -- t125人员工资表 c06-人员编号 关联 t126人员基本信息表
					and t126.changeSign = chaSign ;
					
					set sTempNum = 0; 
					while sTempNum<jjqxMonth DO	
						set @sTempYearMonth = DATE_FORMAT(DATE_ADD(qxsj,INTERVAL sTempNum MONTH),'%Y%m');-- 起薪时间+1/2/3 	
							SET @pay_table =  CONCAT('fund_salary_pay_',@sTempYearMonth);/*工资发放表*/
							SET @pay_allowance_table =  CONCAT('fund_salary_subsidies_pay_',@sTempYearMonth);/*工资发放-津补贴表*/
							SET @sqlstr = CONCAT('update  ', @pay_table,' a ,data_record_t126 t126,data_record_t125 t125 set 
									zwgz_byyb = -ifnull( t125.c25,0),
									--  职务/技术等级工资-本月变动应补补扣发
									gwgz_byyb = -ifnull(t125.c26 ,0),
									-- 级别岗位级别工资-本月变动应补补扣发
									jshstg_byyb = -ifnull( t125.c28,0),
									-- 教师护士提高10%-本月变动应补补扣发
									tsjytg_byyb = -ifnull( t125.c29,0),
									-- 特殊教育提高15%-本月变动应补补扣发
									bltggz_byyb = -ifnull( t125.c30,0),
									-- 保留特岗工资-本月变动应补补扣发
									jsblgz_byyb = -ifnull( t125.c44,0),
									-- 中小学教师保留10%-本月变动应补补扣发
									hsblgz_byyb = -ifnull( t125.c45,0),
									-- 保留护士提高10%-本月变动应补补扣发
									psxlj_byyb = -ifnull(t125.c47 ,0),
									-- 平时训练奖-本月变动应补补扣发
									jxgz_byyb = -ifnull(t125.c31 ,0),
									-- 基础绩效-本月变动应补补扣发
									jbt_salary_byyb = -ifnull( t125.c27,0),
									-- 津补贴小计-本月变动应补补扣发
									part_total_salary_byyb = -ifnull( t125.c32,0),
									-- 工资小计-本月变动应补补扣发
									total_salary_byyb = -ifnull( t125.c32,0)
									-- 工资小计-本月变动应补补扣发
								where 1=1 and t126.c01 = \'',v_unit_dataId,'\' and  t125.c06 =concat(t126.dataId ,\'\')
								and a.unit_id =  t126.c01 and a.staff_id = concat(t126.dataId ,\'\') 
								and t126.changeSign = t125.changeSign and t126.changeSign = \'',chaSign,'\''
								);
							PREPARE stmt FROM @sqlstr;
							EXECUTE stmt;	
							SET @sqlstr = CONCAT('update  ', @pay_allowance_table,' a, data_record_t117 t117 ,data_record_t126 t126 set salary_byyb = 0-ifnull( t117.c07,0)
								
								where 1=1 and   t117.changeSign = t126.changeSign and t126.changeSign = \'',chaSign,'\'
								and a.unit_id = t126.c01 and a.staff_id = concat(t126.dataId ,\'\') and a.allowance_id = t117.c04
								and t117.c02 = \'',v_unit_dataId,'\'   and t117.c03 = concat(t126.dataId ,\'\')
								');
							PREPARE stmt FROM @sqlstr;
							EXECUTE stmt;
						-- end if;
						set sTempNum = sTempNum + 1;
					end while;
					
					
				else 		
						select count(1) into sTempNum from information_schema.tables where table_schema = sysDataBase and TABLE_NAME = concat('fund_salary_pay','_',qxYearMonth);-- smso数据库里面对应的工资变动表信息
						if sTempNum < 1 then -- 判断是否已经存在v_i_fund_month(如201608)的工资发放表信息
							SET @sqlstr = CONCAT('CREATE TABLE ','fund_salary_pay','_',qxYearMonth,' LIKE ', ' fund_salary_pay');
							PREPARE stmt FROM @sqlstr;
							EXECUTE stmt;
						end if;
						SET @sqlstr = CONCAT('select count(1) into @monthCount from fund_salary_pay_',qxYearMonth,' where unit_id =  \'',departId,'\' and  staff_id = \'',staffId,'\' ');										
						-- select count(1) into monthCount from fund_salary_pay where fund_month = qxYearMonth and staff_id = staffId;-- 机关基金发放表
						PREPARE stmt FROM @sqlstr;
						EXECUTE stmt;
						set monthCount = @monthCount;
						if monthCount < 1 then 
							-- set resultMsg = concat('@sqlstr:',@sqlstr,'[',staffName,']起薪时间[',qxYearMonth,']无工资信息');
							-- set resultMsg = concat('chaSign:',chaSign,',[',staffName,']起薪时间[',qxYearMonth,']无工资信息');
							set resultMsg = concat('[',staffName,']起薪时间[',qxYearMonth,']无工资信息');
							leave label_pro;
						else
							set sTempNum = 0; 

							select ifnull(replace(max(c02),'-',''),0) into @perMonth from data_record_t125 where c05 = v_unit_dataId and dataid = (
								select dataid  from data_record_t125 where changeSign = chaSign)
								and id <(select id from data_record_t125 where changeSign = chaSign);

							while sTempNum<jjqxMonth DO
								set sTempYearMonth = DATE_FORMAT(DATE_ADD(qxsj,INTERVAL sTempNum MONTH),'%Y%m');-- 起薪时间+1/2/3 
								SET @sqlstr = CONCAT('select count(1) into @monthCount from fund_salary_pay_',sTempYearMonth, ' where unit_id =  \'',departId,'\' and  staff_id = \'',staffId,'\' ');				
								PREPARE stmt FROM @sqlstr;
								EXECUTE stmt;
								set monthCount = @monthCount;
								if monthCount > 0 then -- 起薪时间 20160301 变动时间 20160601 基金月份 201607 此时 就需要计算3,4,5,6月的补扣发,如果这几个月中 sTempYearMonth 这个月存在补扣发表
									-- 调用 计算当前变动记录工资与某一个月的实际应发工资差 过程 获取 工资各项差额
									set subZwgz = 0;
									set subGwgz = 0;
									set subJhtg = 0;
									set subTjtg = 0;
									set subBltg = 0;
									set subBljs = 0;
									set subPsxlj = 0;
									set subJcjx = 0;
									set subJbt = 0;
									set subGz = 0;
								
										if @perMonth = 0 then
										call monthfillCount(v_unit_dataId,changeId,staffId,chaSign,sTempYearMonth,subZwgz,subGwgz,subJhtg,subTjtg,subBltg,subBljs,subBlhs,subPsxlj,subJcjx,subJbt,subGz,resultMsg);
									else 
										call monthfillCount(v_unit_dataId,changeId,staffId,chaSign,@perMonth,subZwgz,subGwgz,subJhtg,subTjtg,subBltg,subBljs,subBlhs,subPsxlj,subJcjx,subJbt,subGz,resultMsg);
									end if;
									

									
									if ''!=resultMsg then 
										leave label_pro;
									end if;
								/**if chaSign = '149008712086111185t1263358' and sTempYearMonth = '201705' then 
									set resultMsg = concat('subGwgz:',subGwgz,',sTempYearMonth:',sTempYearMonth,'@monthCount:',@monthCount);
									leave label_pro;
								end if;
								*/
									
									set @sqlstr = concat('insert into  fund_salary_subsidies_pay_',sTempYearMonth,'(fund_month,unit_id,unit_code,staff_id,allowance_id,allowance_title,
															salary_value,salary_sj_bf,
													salary_hx_bf,staff_salStandardDate,salary_byyb,status)
													-- ,CreateDate) 
													select ',sTempYearMonth,',t117.c02,(select c01 from t111 where id = t117.c02),t117.c03,t117.c04,(select c03 from t116 where id = t117.c04),
															0,0,
													0,\'\',0,0 -- ,',now(),'  
													from  data_record_t117 t117 where changesign =  \'',chaSign,'\' 
													and not EXISTS(select 1  from fund_salary_subsidies_pay_',sTempYearMonth,' a where
													a.unit_id = t117.c02 and a.unit_id =\'',departId,'\' and a.staff_id = t117.c03 and a.staff_id = \'',staffId,'\' and a.allowance_id = t117.c04  )
												 ');
									PREPARE stmt FROM @sqlstr;
									EXECUTE stmt; 
									
									
									if @perMonth = 0 then
										set @sqlstr = concat('update record_fill_subsidies rs , fund_salary_subsidies_pay_',sTempYearMonth,' fp ,data_record_t117 t117 set 
										rs.jbt_salary_bf = round(round(ifnull(rs.jbt_salary_bf,0),2) + (round(ifnull(t117.c07,0),2) - round(ifnull(fp.salary_value,0),2) 
										-- - round(ifnull(fp.salary_sj_bf,0),2) 
										- round(ifnull(fp.salary_hx_bf,0),2) - round(ifnull(fp.salary_byyb,0),2)) ,2)
										where rs.changesign = \'',chaSign,'\' and rs.changeSign = t117.changesign and  fp.staff_id = t117.c03 and fp.unit_id = t117.c02 
										and rs.jbt_id = fp.allowance_id and rs.jbt_id = t117.c04 ');
										PREPARE stmt FROM @sqlstr;
										EXECUTE stmt; 
									else 
										set @sqlstr = concat('update record_fill_subsidies rs , fund_salary_subsidies_pay_',@perMonth,' fp ,data_record_t117 t117 set 
										rs.jbt_salary_bf = round(round(ifnull(rs.jbt_salary_bf,0),2) + (round(ifnull(t117.c07,0),2) - round(ifnull(fp.salary_value,0),2) 
										-- - round(ifnull(fp.salary_sj_bf,0),2) 
										- round(ifnull(fp.salary_hx_bf,0),2) - round(ifnull(fp.salary_byyb,0),2)) ,2)
										where rs.changesign = \'',chaSign,'\' and rs.changeSign = t117.changesign and  fp.staff_id = t117.c03 and fp.unit_id = t117.c02 
										and rs.jbt_id = fp.allowance_id and rs.jbt_id = t117.c04 ');
										PREPARE stmt FROM @sqlstr;
										EXECUTE stmt; 
									end if;
									
									
									set @sqlstr = concat('
										update  fund_salary_subsidies_pay_',sTempYearMonth,' fp ,data_record_t117 t117 set 
										fp.salary_byyb = round(ifnull(fp.salary_byyb,0) +( ifnull(t117.c07,0) - ifnull(fp.salary_value,0) 
										- ifnull(fp.salary_hx_bf,0) - ifnull(fp.salary_byyb,0)),2) 
										where fp.unit_id =\'',departId,'\' and fp.staff_id = \'',staffId,'\' and t117.changesign =  \'',chaSign,'\' 
										 and t117.c02 = concat( fp.unit_id ,\'\' ) and fp.allowance_id = t117.c04 ');
									PREPARE stmt FROM @sqlstr;
									EXECUTE stmt;
									
									set @sqlstr = concat('update fund_salary_pay_',sTempYearMonth,' set 
									zwgz_byyb = ifnull(zwgz_byyb,0)+',subZwgz,',-- 职务工资本月应补补扣发
									gwgz_byyb = ifnull(gwgz_byyb,0)+',subGwgz,',-- 级别岗位级别工资补扣款-本月应补变动补扣款
									jshstg_byyb = ifnull(jshstg_byyb,0) + ',subJhtg,',-- 教师护士提高10%-本月应补变动补扣款
									tsjytg_byyb = ifnull(tsjytg_byyb,0) + ',subTjtg,',-- 特殊教育提高15%-本月应补变动补扣款
									bltggz_byyb = ifnull(bltggz_byyb,0) + ',subBltg,',-- 保留特岗工资-本月应补变动补扣款
									jsblgz_byyb = ifnull(jsblgz_byyb,0) + ',subBljs,',-- 中小学教师保留10%工资-本月应补变动补扣款
									hsblgz_byyb = ifnull(hsblgz_byyb,0) + ',subBlhs,',-- 保留护士提高10%工资-本月应补变动补扣款
									psxlj_byyb = ifnull(psxlj_byyb,0) + ',subPsxlj,',-- 平时训练奖-本月应补变动补扣款
									jxgz_byyb = ifnull(jxgz_byyb,0) + ',subJcjx,',-- 绩效工资-本月应补变动补扣款
									jbt_salary_byyb = ifnull(jbt_salary_byyb,0) + ',subJbt,',-- 津补贴补扣发-本月应补变动补扣款
									part_total_salary_byyb = ifnull(part_total_salary_byyb,0) + ',subGz,', -- 小计-本月应补变动补扣款
									total_salary_byyb = ifnull(total_salary_byyb,0)+',subGz,' --  应发-本月应补 合计工资,-- 除开一次性补扣发 当月实发工资小计+后续补扣发合计
									where  unit_id =  \'',departId,'\' and   staff_id = \'',staffId,'\'');
									PREPARE stmt FROM @sqlstr;
									EXECUTE stmt; 
								/**else -- 如果sTempYearMonth这个月不存在补扣发表
									
									SET @sqlstr = CONCAT('select staff_jobSal,staff_levelSal,
									-- 职务/技术等级工资 级别岗位级别工资
									staff_teacherNurseUpTen,staff_specialTeachFifteen,
									-- 教师护士提高10% 	特殊教育提高15%
									staff_keepSpecialStationSal,staff_midTeacherKeeyTen,staff_keepNurseUpTen,
									-- 保留特岗工资		中小学教师保留10%	保留护士提高10%
									staff_peacetimeAward,staff_basicPerfor,
									-- 平时训练奖		基础绩效
									jbt_total_salary,actual_total_salary,salary_value,theory_total_salary
									-- 津补贴小计	实发工资合计		工资补扣发		实际应发工资合计	
									into @preZwgz,@preGwgz,
									@preJhtg,@preTjtg,
									@preBltg,@preBljs,@preBlhs,
									@prePsxlj,@preJcjx,
									@preJbt,@preGz,@preBkf,@preYfGzhj
									from fund_salary_pay_',sTempYearMonth,'
									where fund_month =', sTempYearMonth ,'
									and staff_id = ',staffId);
									-- 机关基金发放表
									PREPARE stmt FROM @sqlstr;
									EXECUTE stmt;
									set preZwgz = @preZwgz;
									set preGwgz= @preGwgz;
									set preJhtg=@preJhtg;
									set preTjtg = @preTjtg;
									set preBltg = @preBltg;set preBljs = @preBljs;set preBlhs = @preBlhs;
									set prePsxlj = @prePsxlj;set preJcjx = @preJcjx;
									set preJbt = @preJbt;set preGz = @preGz;set preBkf = @preBkf;set preYfGzhj = @preYfGzhj;
									SET subZwgz = zwgz-preZwgz;-- 当前变动与起薪时间的职务工资差
									
									SET subGwgz = gwgz-preGwgz;-- 当前变动与起薪时间的级别/岗位工资差
									SET subJbt = jbt-preJbt;-- 当前变动与起薪时间的津补贴差
									SET subJhtg = jhtg - preJhtg;-- 当前变动与起薪时间的教师护士提高10%
									SET subTjtg = tjtg - preTjtg;-- 当前变动与起薪时间的特殊教育提高15%
									SET subBltg = bltg - preBltg;-- 当前变动与起薪时间的保留特岗工资
									SET subBljs = bljs - preBljs;-- 当前变动与起薪时间的保留教师10%
									SET subBlhs = blhs - preBlhs;-- 当前变动与起薪时间的保留护士10%
									SET subPsxlj = psxlj - prePsxlj;-- 当前变动与起薪时间的平时训练奖
									SET subJcjx = jcjx - preJcjx;-- 当前变动与起薪时间的基础绩效
									SET subJbt = jbt-preJbt;-- 当前变动与起薪时间的津补贴差
									SET subGz = gzxj - preGz;-- 当前变动与起薪时间的工资小计差 
									*/
									/* 
									SET @sqlstr = CONCAT('insert into ','fund_salary_fill','_',sTempYearMonth,' (fund_month,unit_id,unit_code,staff_id,staff_name,zwgz,zwgz_yf,gwgz,gwgz_yf,jshstg,jshstg_yf,
									tsjytg,tsjytg_yf,bltggz,bltggz_yf,jsblgz,jsblgz_yf,hsblgz,hsblgz_yf,psxlj,psxlj_yf,jxgz,jxgz_yf,
									jbt_salary,jbt_salary_yf,-- 津补贴-补发,津补贴-后续补扣发 
									part_total_salary,part_total_salary_yf,-- 工资小计-实发 工资小计-后续补扣发
									fill_salary,fill_salary_yf,-- 实发补扣发 补扣发-后续补扣发
									total_salary,total_salary_yf)--  工资实发合计 , 应发-合计工资,-- 除开一次性补扣发 当月实发工资小计+后续补扣发合计
									values(',sTempYearMonth,',',departId,',',departCode,',',staffId,',',staffName,',',preZwgz,',',subZwgz,',',preGwgz,',',subGwgz,',',preJhtg,',',subJhtg,',',
									preTjtg,',',subTjtg,',',preBltg,',',subBltg,',',preBljs,',',subBljs,',',preBlhs,',',subBlhs,',',prePsxlj,',',subPsxlj,',',preJcjx,',',subJcjx,',',
									preJbt,',',subJbt,',',
									preGz,',',subGz,',',0,',',subGz,',',preGz,',',subGz,')');
									PREPARE stmt FROM @sqlstr;
									EXECUTE stmt;
									*/
									/** SET @sqlstr = CONCAT('insert into ','fund_salary_fill_subsidies','_',sTempYearMonth,' (fund_month,unit_id,unit_code,staff_id,jbt_id,jbt_title,salary_value,
									salary_sj_bf,salary_hx_bf,staff_salStandardDate)--  工资实发合计 , 应发-合计工资,-- 除开一次性补扣发 当月实发工资小计+后续补扣发合计
									select ',sTempYearMonth,',',departId,',',departCode,',',staffId,',
									from ');
									PREPARE stmt FROM @sqlstr;
									EXECUTE stmt; 津补贴 写错了
									*/
									
								end if;
								set sumZwgz = ifnull(subZwgz,0) + ifnull(sumZwgz,0);-- 职务工资-补扣发总和
								set sumGwgz = ifnull(subGwgz,0) + ifnull(sumGwgz,0);-- 岗位工资-补扣发总和
								set sumJhtg = ifnull(subJhtg,0) + ifnull(sumJhtg,0);-- 教师护士提高-补扣发总和
								set sumTjtg = ifnull(subTjtg,0) + ifnull(sumTjtg,0);-- 特殊教育-补扣发总和
								set sumBltg = ifnull(subBltg,0) + ifnull(sumBltg,0);-- 保留特岗-补扣发总和
								set sumBljs = ifnull(subBljs,0) + ifnull(sumBljs,0);-- 保留教师-补扣发总和
								set sumBlhs = ifnull(subBlhs ,0)+ ifnull(sumBlhs,0);-- 保留护士-补扣发总和
								set sumPsxlj = ifnull(subPsxlj,0) + ifnull(sumPsxlj,0);-- 平时训练奖-补扣发总和
								set sumJcjx = ifnull(subJcjx,0) + ifnull(sumJcjx,0);-- 基础绩效-补扣发总和
								set sumJbt = ifnull(subJbt,0) + ifnull(sumJbt,0);-- 津补贴-补扣发总和
								set sumGz = ifnull(subGz,0) + ifnull(sumGz,0);-- 工资小计-补扣发总和
								set sTempNum = sTempNum+1;
					
							end while;
							select count(1) into recordCount from record_fill_tail where change_id = changeId;-- 变动记录对应补扣款
							if recordCount>0 then -- 记录补扣发表已经存在记录update 记录补扣表不需要应发



								update record_fill_tail set
									fillNum=jjqxMonth,-- 补扣发月数
									zwgz_bf = ifnull(zwgz_bf,0) + ifnull(sumZwgz,0),
									gwgz_bf = ifnull(gwgz_bf,0) + ifnull(sumGwgz,0), 
									jshstg_bf = ifnull(jshstg_bf,0) + ifnull(sumJhtg,0), 
									tsjytg_bf = ifnull(tsjytg_bf,0) + ifnull(sumTjtg,0), 
									bltggz_bf = ifnull(bltggz_bf,0) + ifnull(sumBltg,0), 
									jsblgz_bf = ifnull(jsblgz_bf,0) + ifnull(sumBljs,0), 
									hsblgz_bf = ifnull(hsblgz_bf,0) + ifnull(sumBlhs,0), 
									psxlj_bf = ifnull(psxlj_bf,0)+  ifnull(sumPsxlj,0), 
									jxgz_bf = ifnull(jxgz_bf,0) + ifnull(sumJcjx,0), 
									jbt_salary_bf =  ifnull(jbt_salary_bf,0) + ifnull(sumJbt,0), 
									part_total_salary_bf = ifnull(part_total_salary_bf,0) + ifnull(sumGz,0) ,
									-- fill_salary_bf = fill_salary_bf + sumGz, 
									total_salary_bf =   ifnull(total_salary_bf,0) + ifnull(sumGz,0)
								where  change_id = changeId;
								-- 算法为：补扣发差额乘以月数
								update record_fill_tail set
									
									zwgz_bf =  ifnull(zwgz_ce,0) *sTempNum, 
									gwgz_bf =  ifnull(gwgz_ce,0) *sTempNum, 
									jshstg_bf =  ifnull(jshstg_ce,0) *sTempNum, 
									tsjytg_bf =  ifnull(tsjytg_ce,0) *sTempNum, 
									bltggz_bf =  ifnull(bltggz_ce,0) *sTempNum, 
									jsblgz_bf = ifnull(jsblgz_ce,0) *sTempNum, 
									hsblgz_bf = ifnull(hsblgz_ce,0) *sTempNum, 
									psxlj_bf = ifnull(psxlj_ce,0) *sTempNum, 
									jxgz_bf = ifnull(jxgz_ce,0) *sTempNum, 
									jbt_salary_bf =  ifnull(jbt_salary_ce,0) *sTempNum, 
									part_total_salary_bf = ifnull(part_total_salary_ce,0) *sTempNum, 
									-- fill_salary_bf = fill_salary_bf + sumGz, 
									total_salary_bf =   ifnull(total_salary_ce,0) *sTempNum
								where  change_id = changeId;



							else -- 记录补扣发表不存在记录insert
-- set resultMsg = concat('departCode:',departCode);leave label_pro;
								insert into record_fill_tail(staff_id,unit_id,unit_code,change_id,change_type,
									zwgz,gwgz,jshstg,tsjytg,bltggz,jsblgz,hsblgz,psxlj,jbt_salary,part_total_salary,total_salary,
									zwgz_bf,gwgz_bf,jshstg_bf,tsjytg_bf,bltggz_bf,jsblgz_bf,hsblgz_bf,psxlj_bf,jxgz_bf,
									jbt_salary_bf, 
									part_total_salary_bf,total_salary_bf,fillNum)
								values(staffId,departId,departCode,changeId,changeType,
									zwgz,gwgz,jshstg,tsjytg,bltggz,jsblgz,hsblgz,psxlj,jbt,gzxj,gzxj+sumGz,
									-- 先将基础绩效屏蔽
									sumZwgz,sumGwgz,sumJhtg,sumTjtg,sumBltg,sumBljs,sumBlhs,sumPsxlj,sumJcjx,
									sumJbt,sumGz,sumGz,jjqxMonth);
									update record_fill_tail set
									
									jbt_salary_bf =  ifnull(jbt_salary_ce,0) *sTempNum, 
									part_total_salary_bf = ifnull(part_total_salary_ce,0) *sTempNum, 
									-- fill_salary_bf = fill_salary_bf + sumGz, 
									total_salary_bf =   ifnull(total_salary_ce,0) *sTempNum
								where  change_id = changeId;
									

						/**			
								insert into record_fill_subsidies (change_id,staff_id,jbt_id,jbt_salary,jbt_salary_bf,fund_month,changeSign)
								select a.id,a.c03,a.c04,a.c07,ifnull(a.c07,0),jjyf,a.changeSign
								-- 变动记录id  人员编号 津补贴编号  金额       补扣发 基金月份 变动标志
								from data_data_record a,data_data_record b where b.id=changeId
								and a.changeSign = b.changeSign and a.dataclassCode = 't117';
						*/
							end if;
					end if;		
				end if;
			end if ;
		end if;
	end if;
	/*update record_fill_tail set jbt_salary = case when length(jbt_salary)>10 then round(jbt_salary ,2) else jbt_salary end where change_id =changeId;
	update record_fill_tail set jbt_salary_bf = case when length(jbt_salary_bf)>10 then round(jbt_salary_bf ,2) else jbt_salary_bf end where change_id =changeId;
	update record_fill_tail set part_total_salary = case when length(part_total_salary)>10 then round(part_total_salary ,2) else part_total_salary end where change_id =changeId;
	update record_fill_tail set part_total_salary_bf = case when length(part_total_salary_bf)>10 then round(part_total_salary_bf ,2) else part_total_salary_bf end where change_id =changeId;
	update record_fill_tail set total_salary = case when length(total_salary)>10 then round(total_salary ,2) else total_salary end where change_id =changeId;
	update record_fill_tail set total_salary_bf = case when length(total_salary_bf)>10 then round(total_salary_bf ,2) else total_salary_bf end where change_id =changeId;
	update record_fill_tail set jbt_salary_ce = case when length(jbt_salary_ce)>10 then round(jbt_salary_ce ,2) else jbt_salary_ce end where change_id =changeId;
	update record_fill_tail set part_total_salary_ce = case when length(part_total_salary_ce)>10 then round(part_total_salary_ce ,2) else part_total_salary_ce end where change_id =changeId;
	update record_fill_tail set total_salary_ce = case when length(total_salary_ce)>10 then round(total_salary_ce ,2) else total_salary_ce end where change_id =changeId;*/		
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`fundRecordApply`(IN v_fundMonth varchar(20),IN v_unit_dataId int(11),INOUT resultMsg  varchar(1000) CHARSET utf8)
label_pro:BEGIN
	if v_fundMonth is null or v_fundMonth = 0 then
		set resultMsg = '基金月份不能为空';leave label_pro;
	end if;
	if v_unit_dataId = 0 then
		set resultMsg = '单位id人不能为空';leave label_pro;
	else
		-- 此处写所有的变动记录过程
		set resultMsg = '';
		
		update data_record_t126 set  allAuditFlag = 1
		/**firstFlag = 1,secondFlag =1,thirdFLag = 1,forthFlag = 1,fiveFlag = 1,sixFlag = 1*/
		where  c01 = concat(v_unit_dataId,'') and allAuditFlag = '9' ;-- 9为生成报表未申报

		update data_record_t125 a ,data_record_t126 b set a.allAuditFlag = 1
		/**a.firstFlag = 1,a.secondFlag =1,a.thirdFLag = 1,a.forthFlag = 1,a.fiveFlag = 1,a.sixFlag = 1*/
		where b.c01 = concat(v_unit_dataId,'') and  a.changeSign = b.changeSign 
		and a.allAuditFlag = '9' ; 
		
		update data_record_t117 a ,data_record_t126 b set a.allAuditFlag = 1
		/**a.firstFlag = 1,a.secondFlag =1,a.thirdFLag = 1,a.forthFlag = 1,a.fiveFlag = 1,a.sixFlag = 1*/
		where b.c01 = concat(v_unit_dataId,'')  and a.changeSign = b.changeSign 
		and a.allAuditFlag = '9' ; 
		
		
	
		
	end if;
			
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`fund_audit`(in v_i_fund_month varchar(6),in v_unit_id varchar(50),
in v_unit_dataId int(11),inout resultMsg varchar(1000))
label_pro:	BEGIN
-- 审核通过后,更新年终奖,警察加班补贴,警察值勤补贴,艰边津补贴,一次性补扣发,补扣发相关的信息
declare stemNum int(11);
declare sTempNum int(11);
declare sTemRecordId int(11);
DECLARE staffId VARCHAR(30);
DECLARE chanType VARCHAR(30);
DECLARE chanSign VARCHAR(200);
declare stemP varchar(20);
declare stemFundMonth varchar(20); -- 基金月份 
DECLARE v_table VARCHAR(30);
DECLARE v_allowance_table VARCHAR(50);
declare sysDataBase varchar(20);-- 数据库名称

DECLARE done INT DEFAULT FALSE;
-- 所有生成基金补扣发的变动记录(待审核通过的)
DECLARE recordId_ CURSOR FOR
SELECT t126.id from data_record_t126 t126
		where 1=1 and t126.dataclassCode = 't126' and allAuditFlag='1' -- 待审核通过的数据
and t126.c01 = concat(v_unit_dataId,'') -- t125.c36 人员工资制度为 201 -公务员职级工资
and t126.fund_month = v_i_fund_month -- 变动记录的基金月份
and not exists(select 1 from sys_s_data d where d.id = t126.c03 and d.typename = 'staffStatus' and d.data_value = '2')
-- 非离休人员
;
DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;

	select ifnull(content,'smso') into sysDataBase from sys_s_config where enname = 'DATABASE_NAME';-- 数据库名称

	-- 其它一次性补扣发项目表
  select count(1) into stemNum from t119 where c20 = concat(v_i_fund_month,'') and c04=concat(v_unit_dataId,'')
  	and not exists(select 1 from t126,sys_s_data d where t126.id = t119.c01 and d.id = t126.c03 and d.typename = 'staffStatus' and d.data_value = '2')
	-- 非离休人员
	;
	if stemNum > 0 then
		update t119 ,sys_s_data d set c21 = d.id where c20 = concat(v_i_fund_month,'') and c04=concat(v_unit_dataId,'')
		and d.typename = 'ybshzt' and d.data_value = '2' --  状态更新为 通过
		and not exists(select 1 from t126,sys_s_data e where t126.id = t119.c01 and e.id = t126.c03 and e.typename = 'staffStatus' and e.data_value = '2')
		-- 非离休人员
		;
	end if;
	
	-- 一次性年终奖金管理表
	select count(1) into stemNum from t151 where c04 = concat(v_i_fund_month,'') and c01=concat(v_unit_dataId,'');
	if stemNum > 0 then
		update t151,sys_s_data d set c03 = d.id where c04 = concat(v_i_fund_month,'') and c01=concat(v_unit_dataId,'') 
		and d.typename = 'ybshzt' and d.data_value = '2';-- 状态更新为 通过
	end if;
	
	-- 警察加班补扣发表
	select count(1) into stemNum from t152 where c12 = concat(v_i_fund_month,'') and c01=concat(v_unit_dataId,'');
	if stemNum > 0 then
		update t152,sys_s_data d set c13 = d.id where c12 = concat(v_i_fund_month,'') and c01=concat(v_unit_dataId,'') 
		and d.typename = 'ybshzt' and d.data_value = '2';-- 状态更新为 通过
	end if;
	
	-- 警察值勤补扣发表
	select count(1) into stemNum from t153 where c14 = concat(v_i_fund_month,'') and c01=concat(v_unit_dataId,'');
	if stemNum > 0 then
		update t153,sys_s_data d set c17 = d.id where c14 = concat(v_i_fund_month,'') and c01=concat(v_unit_dataId,'') 
		and d.typename = 'ybshzt' and d.data_value = '2';-- 状态更新为 通过
	end if;
	
	-- 艰边津补贴扣扣发表
	select count(1) into stemNum from t164 where c11 = concat(v_i_fund_month,'') and c01=concat(v_unit_dataId,'');
	if stemNum > 0 then
		update t164,sys_s_data d set c10 = d.id where c11 = concat(v_i_fund_month,'') and c01=concat(v_unit_dataId,'') 
		and d.typename = 'ybshzt' and d.data_value = '2';-- 状态更新为 通过
	end if;
	
	-- 终审通过该单位该基金月份所有在职人员 变动记录整体审核整体全部更新为通过

	update data_record_t126 a,data_record_t125 b set  a.allAuditFlag = '2',b.allAuditFlag='2'
	where a.changeSign = b.changeSign 
	and a.allAuditFlag='1' 
	and a.c01 = concat(v_unit_dataId,'')
	and a.fund_month = v_i_fund_month -- 变动记录的基金月份
	and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
	; -- 更新变动记录对应的审核状态为通过

	update data_record_t117 a , data_record_t126 b 
	set a.allAuditFlag = '2' 
	where a.changeSign = b.changeSign 
	and a.allAuditFlag='1' 
	and a.c02 = concat(v_unit_dataId,'')
	and a.fund_month = v_i_fund_month -- 变动记录的基金月份
	and not exists(select 1 from sys_s_data d where d.id = b.c03 and d.typename = 'staffStatus' and d.data_value = '2')
	; 


	-- 打开游标
  OPEN recordId_;  
  -- 开始循环
  read_loop: LOOP
    -- 提取游标里的数据，这里只有一个，多个的话也一样；
    FETCH recordId_ INTO sTemRecordId;
    -- 声明结束的时候
    IF done THEN
      LEAVE read_loop;
    END IF;
    -- 更新每条变动记录所涉及到的前几个月的补扣发情况表
    select changeType,changeSign,dataId into chanType ,chanSign,staffId 
    	from data_record_t126 where id = sTemRecordId and c03 != '10372'; -- 在职人员
	select c02 into stemP from data_record_t125 
		where changeSign = chanSign and changeType = chanType 
		and c06 in (select id from t126 where t126.c03 != '10372');-- t125.c02 起薪时间 2016-01
	

	/*
	select count(1) into @stemNum from data_data_record a join record_fill_tail b on a.id = b.change_id
	 where a.allAuditFlag = '2' and a.dataclassCode = 't126' and a.c01 = concat(v_unit_dataId,'')
	 and a.fund_month < v_i_fund_month ; -- 查询变动记录已经审核通过的数据
	if  @stemNum > 0 then
		delete from record_fill_tail c
	 	where 1=1 
	 	and exists(select 1 from data_data_record a join data_data_record b on a.changeSign = b.changeSign 
	 	and a.allAuditFlag = '2' and a.dataclassCode = 't126' and a.c01 = concat(v_unit_dataId,'')
	 	and c.change_id = a.id 
	 	and a.fund_month < v_i_fund_month ); -- 查询变动记录已经审核通过的数据
	end if;
	*/

	set stemP = replace(stemP,'-',''); -- 201601
	select PERIOD_DIFF(v_i_fund_month,stemP) into stemNum;-- 201610-201601
	set sTempNum = 0; 
	if stemNum>0 then -- 存在补扣发
		while sTempNum<stemNum DO
			set stemFundMonth = DATE_FORMAT(DATE_ADD(concat(stemP,'01'),INTERVAL sTempNum MONTH),'%Y%m');
			set v_table = concat('fund_salary_pay','_',stemFundMonth);-- 对应月份 201607到v_i_fund_month之前相关的发放表的补扣发
			set v_allowance_table = concat('fund_salary_subsidies_pay','_',stemFundMonth); -- 对应月份201607到v_i_fund_month之前相关发放表-津补贴的补扣发
			select count(1) into @stempNum from information_schema.tables where table_schema = sysDataBase and TABLE_NAME = v_table;-- smso数据库里面对应的工资发放表信息

			if @stempNum < 1 then -- 判断是否已经存在v_i_fund_month(如201608)的工资发放表信息
				SET @sqlstr = CONCAT('CREATE TABLE ',v_table,' LIKE ', ' fund_salary_pay');
				PREPARE stmt FROM @sqlstr;
				EXECUTE stmt;
				DROP PREPARE stmt;
			end if;	
			
			SET @sqlstr = CONCAT('select count(1) into @stempNum from ',v_table,' a where a.staff_id=',staffId);
			PREPARE stmt FROM @sqlstr;
			EXECUTE stmt;
			DROP PREPARE stmt;
			
			if @stempNum < 1 then	
				-- 添加对应月份的基金发放表+后续补扣发
				SET @sqlstr = CONCAT('INSERT INTO ', v_table,' (status,fund_month,unit_id,unit_code,staff_id,staff_name,
						staff_eduLevel,staff_standing,staff_curPost,
						-- 学历			人员身份		现任职务
						staff_actual_workRank,staff_workRank,staff_isLeader,staff_postSalRank,staff_salRankLevel,
						-- 实际职务/技术等级	工资对应职级	是否领导工资	工资级别		工资档次
						zwgz_hx,gwgz_hx,
						-- 职务/技术等级工资-后续补扣发  级别岗位级别工资-后续补扣发 
						jshstg_hx,tsjytg_hx,
						-- 教师护士提高10%-后续补扣发  特殊教育提高15%-后续补扣发 
						bltggz_hx,jsblgz_hx,hsblgz_hx,
						-- 保留特岗工资-后续补扣发  中小学教师保留10%-后续补扣发  保留护士提高10%-后续补扣发 
						psxlj_hx,jxgz_hx,
						-- 平时训练奖-后续补扣发  基础绩效-后续补扣发 
						jbt_salary_hx,part_total_salary_hx,fill_salary_hx,theory_total_salary,
						-- 津补贴小计-后续补扣发 后续工资补扣发， 实际应发工资合计
						is_finSupt,is_salUniOut,department_name,
						-- 是否财政供养 是否财政统发 部门
						staff_wageSystem,staff_isUpten,staff_plusGrade,staff_downGrade,staff_plusLevel,staff_floatLevel,staff_fixLevel,staff_downLevel,
						-- 人员工资制度 是否提高10%工资  已含高定级别  已含低定级别		已含高定档次	已含浮动档次	已含固定档次	已含低定档次
						st_sal_date,en_sal_date,staff_status,staff_sex,staff_birth,staff_degree,staff_workYears,staff_from,staff_establish,
						-- 起薪时间 停薪时间	人员状态		性别		出生日期	学位		连续工龄	人员来源	人员编制
						staff_isChuFen,staff_salaryStandard,staff_isMainPart,staff_isStop,staff_partYears,staff_isMidTeacher,
						-- 是否处分		执行工资标准			是否主力		是否停薪		入队年限		是否中小学教师
						staff_isNurse,staff_fileNum,staff_titleRank,staff_isSpecialTeach,staff_salStandardDate
						-- 是否护士		根据文号		衔级			是否特殊教育		工资标准时间
						,staff_czbm,staff_sbid,staff_mz,staff_sfz,staff_bysj
						-- 财政编码 社保号 民族 身份证号 毕业时间
						,staff_jrbdwsj,staff_cjgzsj,staff_xrzwsj,staff_jdgl
						-- 进入本单位时间 参加工作时间 现任职务时间 间断工龄
						,staff_kjsgl,staff_wjsgl,staff_jbsj,staff_dcsj
						-- 工作前可计算工龄 未计算学习工龄 级别起考年份 档次起考年份
						,staff_gddc,staff_gdyj,staff_fddc,staff_fdyj
						-- 高定档次 高定依据 浮动档次 浮动依据 
						,staff_gudingdc,staff_gudingyj,staff_dddc,staff_ddyj
						-- 固定档次 固定依据 低定档次 低定原因
						,staff_gdjb,staff_gdjbyj,staff_ddjb,staff_ddjbyj
						-- 高定级别 高定级别依据 低定级别 低定级别依据 
						)
						select 2,',stemFundMonth,',',v_unit_dataId,',\'',v_unit_id,'\',t126.id,t126.c04,
							ifnull((select d.name from sys_s_data d where d.id = t126.c09),t126.c09),ifnull((select d.name from sys_s_data d where d.id = t126.c28),t126.c28),t126.c19,
						-- 学历			人员身份		现任职务
							ifnull((select d.name from sys_s_data d where d.id = t126.c36),t126.c36),(select t127.c05 from t127 where t127.id = t126.c17),
						-- 实际职务/技术等级	工资对应职级	
							(select t127.c04 from t127 where t127.id = t126.c27),(select t127.c05 from t127 where t127.id = t125.c07),(select t127.c04 from t127 where t127.id = t125.c09),
						-- 是否领导工资	工资级别		工资档次
							t125.c25,t125.c26,t125.c28,t125.c29,t125.c30,t125.c44,t125.c45,
						-- 职务/技术等级工资 级别岗位级别工资 教师护士提高10% 特殊教育提高15%  保留特岗工资 中小学教师保留10%工资	保留护士提高10%工资
							t125.c47,t125.c31,
						-- 平时训练奖			基础绩效
							t125.c27,t125.c32+0,t125.c32+0,t125.c32+0,
						-- 津补贴小计-后续补扣发  工资小计后续补扣发 后续工资补扣发， 实际应发工资合计
						ifnull((select d.name from sys_s_data d where d.id = t126.c24),t126.c24),ifnull((select d.name from sys_s_data d where d.id = t126.c22),t126.c22),(select c03 from t113 where id=t126.c15),
						-- 是否财政供养 是否财政统发 部门
						ifnull((select d.name from sys_s_data d where d.id = t125.c36),t125.c36),ifnull((select d.name from sys_s_data d where d.id = t125.c23),t125.c23)
						-- 人员工资制度 是否提高10%工资
						,t125.c11,t125.c13,t125.c15,t125.c17,t125.c19,t125.c21,
						--    已含高定级别  已含低定级别		已含高定档次	已含浮动档次	已含固定档次	已含低定档次
						t125.c02,t125.c38,ifnull((select d.name from sys_s_data d where d.id = t126.c03),t126.c03),
						-- 起薪时间 停薪时间	人员状态		
						ifnull((select d.name from sys_s_data d where d.id = t126.c05),t126.c05),t126.c08,ifnull((select d.name from sys_s_data d where d.id = t126.c10),t126.c10),
						-- 性别		出生日期	学位		
						t126.c14,ifnull((select d.name from sys_s_data d where d.id = t126.c16),t126.c16),ifnull((select d.name from sys_s_data d where d.id = t126.c21),t126.c21),
						-- 连续工龄	人员来源	人员编制
						ifnull((select d.name from sys_s_data d where d.id = t125.c39),t125.c39),ifnull((select d.name from sys_s_data d where d.id = t126.c39),t126.c39),
						-- 是否处分  执行工资标准/工资标准类别
						ifnull((select d.name from sys_s_data d where d.id = t126.c42),t126.c42),ifnull((select d.name from sys_s_data d where d.id = t126.c43),t126.c43),
						--   是否主力		是否停薪	
						t126.c45,ifnull((select d.name from sys_s_data d where d.id = t125.c01),t125.c01),
						--	入队年限		是否中小学教师
						ifnull((select d.name from sys_s_data d where d.id = t125.c03),t125.c03),t125.c04,
						-- 是否护士		根据文号		
						ifnull((select d.name from sys_s_data d where d.id = t125.c24),t125.c24),ifnull((select d.name from sys_s_data d where d.id = t125.c35),t125.c35),t125.c49
						-- 衔级			是否特殊教育		工资标准时间
						,t126.c23,t126.c25,t126.c06,t126.c07,t126.c11
						-- 财政编码 社保号 民族 身份证号 毕业时间
						,t126.c13,t126.c12,t126.c20,concat(t126.c34,\'.\',t126.c35)
						-- 进入本单位时间 参加工作时间 现任职务时间 间断工龄
						,concat(t126.c32,\'.\',t126.c33),concat(t126.c30,\'.\',t126.c31),t125.c08,t125.c10
						-- 工作前可计算工龄 未计算学习工龄 级别起考年份 档次起考年份
						,t125.c15,t125.c16,t125.c17,t125.c18
						-- 高定档次 高定依据 浮动档次 浮动依据 
						,t125.c19,t125.c20,t125.c21,t125.c22
						-- 固定档次 固定依据 低定档次 低定原因
						,t125.c11,t125.c12,t125.c13,t125.c14 -- ,t126.c41
						-- 高定级别 高定级别依据 低定级别 低定级别依据 变动时间
					from data_record_t126 t126 join data_record_t125 t125 on t125.c06 = concat(t126.dataId,\'\') and t126.changeSign = t125.changeSign
					left join fund_salary_fill_',v_i_fund_month,' c on t126.dataId = c.staff_id and t126.changeSign = c.changeSign
					where t126.c01 = \'',v_unit_dataId,'\'  and t126.changeType in( \'10750\',\'10832\') -- 录入新进人员
					and t126.id = ',sTemRecordId, ' and t126.c03 != \'10372\'');
				PREPARE stmt FROM @sqlstr;
				EXECUTE stmt;
				DROP PREPARE stmt;
				
				
				
				
				-- 添加对应月份的基金发放表+后续补扣发
				SET @sqlstr = CONCAT('insert into fund_byyb (fund_month,byyb_month,unit_id,staff_id,
						zwgz_byyb,gwgz_byyb,jshstg_byyb,tsjytg_byyb,bltggz_byyb,jsblgz_byyb,hsblgz_byyb,
						psxlj_byyb,jxgz_byyb,
						jbt_salary_byyb,total_salary_byyb,CreateDate)
						select ',v_i_fund_month,',',stemFundMonth,',',v_unit_dataId,',t126.dataId,
						t125.c25,t125.c26,t125.c28,t125.c29,t125.c30,t125.c44,t125.c45,
						-- 职务/技术等级工资 级别岗位级别工资 教师护士提高10% 特殊教育提高15%  保留特岗工资 中小学教师保留10%工资	保留护士提高10%工资
							t125.c47,t125.c31,
						-- 平时训练奖			基础绩效
							t125.c27,t125.c32+0,now()
						-- 津补贴小计-后续补扣发  工资小计后续补扣发 
						from data_record_t126 t126 join data_record_t125 t125 on t125.c06 = concat(t126.dataId,\'\') and t126.changeSign = t125.changeSign
					left join fund_salary_fill_',v_i_fund_month,' c on t126.dataId = c.staff_id and t126.changeSign = c.changeSign
					where t126.c01 = \'',v_unit_dataId,'\'  and t126.changeType in( \'10750\',\'10832\') -- 录入新进人员
					and t126.id = ',sTemRecordId, ' and t126.c03 != \'10372\'');
				PREPARE stmt FROM @sqlstr;
				EXECUTE stmt;
				DROP PREPARE stmt;
				
			
				
			else	
				-- 更新对应月份的补扣发
				SET @sqlstr = CONCAT('update ', v_table,' set   
					zwgz_hx=ifnull(zwgz_hx,0)+ifnull(zwgz_byyb,0)+0,
					-- 职务/技术等级工资-后续补扣发
					gwgz_hx=ifnull(gwgz_hx,0)+ifnull(gwgz_byyb,0)+0,
					-- 级别岗位级别工资-后续补扣发
					jshstg_hx=ifnull(jshstg_hx,0)+ifnull(jshstg_byyb,0)+0,
					-- 教师护士提高10%-后续补扣发
					tsjytg_hx=ifnull(tsjytg_hx,0)+ifnull(tsjytg_byyb,0)+0,
					-- 特殊教育提高15%-后续补扣发
					bltggz_hx=ifnull(bltggz_hx,0)+ifnull(bltggz_byyb,0)+0,
					-- 保留特岗工资-后续补扣发
					jsblgz_hx=ifnull(jsblgz_hx,0)+ifnull(jsblgz_byyb,0)+0,
					-- 中小学教师保留10%-后续补扣发
					hsblgz_hx=ifnull(hsblgz_hx,0)+ifnull(hsblgz_byyb,0)+0,
					-- 保留护士提高10%-后续补扣发
					psxlj_hx=ifnull(psxlj_hx,0)+ifnull(psxlj_byyb,0)+0,
					-- 平时训练奖-后续补扣发
					jxgz_hx=ifnull(jxgz_hx,0)+ifnull(jxgz_byyb,0)+0,
					-- 基础绩效-后续补扣发
					jbt_salary_hx=ifnull(jbt_salary_hx,0)+ifnull(jbt_salary_byyb,0)+0,
					-- 津补贴小计-后续补扣发
					part_total_salary_hx=ifnull(part_total_salary_hx,0)+ifnull(part_total_salary_byyb,0)+0,
					-- 工资小计-后续补扣发
					fill_salary_hx=ifnull(fill_salary_hx,0)+ifnull(total_salary_byyb,0)+0
					-- 工资合计-后续变动补扣发
					,status = 2
					 -- 状态通过
					where unit_id =  \'',v_unit_dataId,'\' and  staff_id = \'',staffId,'\'');
				PREPARE stmt FROM @sqlstr;
				EXECUTE stmt;
				DROP PREPARE stmt;	
				
				-- 更新对应月份的补扣发  本月应补
				select count(1) into @countbyyb from fund_byyb where  unit_id =  concat(v_unit_dataId,'') and  staff_id = concat(staffId,'')
				and fund_month =  v_i_fund_month and byyb_month =  stemFundMonth ;
				if @countbyyb<1 then 
					SET @sqlstr = CONCAT('insert into fund_byyb (fund_month,byyb_month,unit_id,staff_id,
							zwgz_byyb,gwgz_byyb,jshstg_byyb,tsjytg_byyb,bltggz_byyb,jsblgz_byyb,hsblgz_byyb,
							psxlj_byyb,jxgz_byyb,
							jbt_salary_byyb,total_salary_byyb,CreateDate)
							select ',v_i_fund_month,',',stemFundMonth,',',v_unit_dataId,',',staffId,',
							zwgz_byyb,gwgz_byyb,jshstg_byyb,tsjytg_byyb,bltggz_byyb,jsblgz_byyb,hsblgz_byyb,
							-- 职务/技术等级工资 级别岗位级别工资 教师护士提高10% 特殊教育提高15%  保留特岗工资 中小学教师保留10%工资	保留护士提高10%工资
								psxlj_byyb,jxgz_byyb,
							-- 平时训练奖			基础绩效
								jbt_salary_byyb,total_salary_byyb,now()
							-- 津补贴小计-后续补扣发  工资小计后续补扣发 
							from ', v_table,'
						where unit_id =  \'',v_unit_dataId,'\' and  staff_id = \'',staffId,'\'');
					PREPARE stmt FROM @sqlstr;
					EXECUTE stmt;
					DROP PREPARE stmt;
				else 
					SET @sqlstr = CONCAT('update  fund_byyb byb,', v_table,' pay 
							set byb.zwgz_byyb =round(ifnull(byb.zwgz_byyb,0)+ifnull(pay.zwgz_byyb,0),2) ,
							byb.gwgz_byyb=round(ifnull(byb.gwgz_byyb,0)+ifnull(pay.gwgz_byyb,0),2),
							byb.jshstg_byyb=round(ifnull(byb.jshstg_byyb,0)+ifnull(pay.jshstg_byyb,0),2),
							byb.tsjytg_byyb=round(ifnull(byb.tsjytg_byyb,0)+ifnull(pay.tsjytg_byyb,0),2),
							byb.bltggz_byyb=round(ifnull(byb.bltggz_byyb,0)+ifnull(pay.bltggz_byyb,0),2),
							byb.jsblgz_byyb=round(ifnull(byb.jsblgz_byyb,0)+ifnull(pay.jsblgz_byyb,0),2),
							byb.hsblgz_byyb=round(ifnull(byb.hsblgz_byyb,0)+ifnull(pay.hsblgz_byyb,0),2),
							byb.psxlj_byyb=round(ifnull(byb.psxlj_byyb,0)+ifnull(pay.psxlj_byyb,0),2),
							byb.jxgz_byyb=round(ifnull(byb.jxgz_byyb,0)+ifnull(pay.jxgz_byyb,0),2),
							byb.jbt_salary_byyb=round(ifnull(byb.jbt_salary_byyb,0)+ifnull(pay.jbt_salary_byyb,0),2),
							byb.total_salary_byyb=round(ifnull(byb.total_salary_byyb,0)+ifnull(pay.total_salary_byyb,0),2)
							where byb.unit_id = pay.unit_id and byb.staff_id = pay.staff_id 
							and byb.unit_id = \'',v_unit_dataId,'\' 
							and byb.staff_id = \'',staffId,'\'
							and byb.fund_month = ',v_i_fund_month,' 
							and byb.byyb_month = ',stemFundMonth,' ');
					PREPARE stmt FROM @sqlstr;
					EXECUTE stmt;
					DROP PREPARE stmt;
				end if;
				
				
				
				
				-- 更新实际应发工资 以及清空最新一次的补扣发金额，确定下一个月再做变动时，月结申报时数据是0
				SET @sqlstr = CONCAT('update ', v_table,' set   
					theory_total_salary = ifnull(total_salary,0)+ifnull(fill_salary_hx,0)+0,
					-- 实际应发工资 当月工资合计+后续工资补扣发

					-- 清空所有最新一次的补扣发金额,确保下一个月再做变动,月结申报时数据是0
					zwgz_byyb= 0,gwgz_byyb=0,
					-- 职务/技术等级工资	级别岗位级别工资
					jshstg_byyb = 0,tsjytg_byyb=0,bltggz_byyb = 0,
					--  教师护士提高 特殊教育提高 保留特岗工资
					jsblgz_byyb=0, hsblgz_byyb = 0,
					-- 中小学教师保留  保留护士提高
					psxlj_byyb=0, jxgz_byyb = 0,
					-- 平时训练奖 绩效工资
					jbt_salary_byyb=0,part_total_salary_byyb = 0,total_salary_byyb=0
					-- 津补贴 	 小计 合计
					,status = 2
					-- 状态更新为2
					where unit_id =  \'',v_unit_dataId,'\' and   staff_id = \'',staffId,'\'');
				PREPARE stmt FROM @sqlstr;
				EXECUTE stmt;
				DROP PREPARE stmt;	
				
				-- 更新实际应发工资 以及清空最新一次的补扣发金额，确定下一个月再做变动时，月结申报时数据是0
				SET @sqlstr = CONCAT('update ', v_table,' set   
					theory_total_salary = ifnull(total_salary,0)+ifnull(fill_salary_hx,0)+0,
					-- 实际应发工资 当月工资合计+后续工资补扣发

					-- 清空所有最新一次的补扣发金额,确保下一个月再做变动,月结申报时数据是0
					zwgz_byyb= 0,gwgz_byyb=0,
					-- 职务/技术等级工资	级别岗位级别工资
					jshstg_byyb = 0,tsjytg_byyb=0,bltggz_byyb = 0,
					--  教师护士提高 特殊教育提高 保留特岗工资
					jsblgz_byyb=0, hsblgz_byyb = 0,
					-- 中小学教师保留  保留护士提高
					psxlj_byyb=0, jxgz_byyb = 0,
					-- 平时训练奖 绩效工资
					jbt_salary_byyb=0,part_total_salary_byyb = 0,total_salary_byyb=0
					-- 津补贴 	 小计 合计
					,status = 2 -- 状态2-通过
					where unit_id =  \'',v_unit_dataId,'\' and   staff_id = \'',staffId,'\'');
				PREPARE stmt FROM @sqlstr;
				EXECUTE stmt;
				DROP PREPARE stmt;	
			end if;
			
			select count(1) into @stempNum from information_schema.tables where table_schema = sysDataBase and TABLE_NAME = v_allowance_table;-- smso数据库里面对应的工资发放表信息
			if @stempNum < 1 then 
				SET @sqlstr = CONCAT('CREATE TABLE ',v_allowance_table,' LIKE ', ' fund_salary_subsidies_pay');
				PREPARE stmt FROM @sqlstr;
				EXECUTE stmt;
				DROP PREPARE stmt;
			end if;
			
			SET @sqlstr = CONCAT('select count(1) into @stempNum from ',v_allowance_table,' a where a.staff_id=\'',staffId,'\'');
			PREPARE stmt FROM @sqlstr;
			EXECUTE stmt;
			DROP PREPARE stmt;
			if @stempNum < 1 then 
				-- 更新发放表-津补贴 后续补扣发金额 以及清空最新一次的补扣发金额，确定下一个月再做变动时，月结申报时数据是0


			SET @sqlstr = CONCAT('INSERT INTO ', v_allowance_table,'(status,fund_month,unit_id,unit_code,staff_id,
					allowance_id,allowance_title,salary_hx_bf/**,staff_salStandardDate*/)
					-- 津补贴id 		津补贴名称 	 津补贴金额  津补贴当月实际补发 津补贴后续补发  津补贴标准时间
				select 2,',stemFundMonth,',',v_unit_dataId,',\'',v_unit_id,'\',t117.c03,t117.c04,t116.c03,t117.c07/**,ifnull(t117.c01,DATE_FORMAT(ifnull(t117.updateDate,t117.createDate),\'%Y-%m-%d\'))*/
						-- 基金月分 	   单位代码(51036000) 人员id 津补贴id  津补贴名称 津补贴金额 津补贴当月实际补发 津补贴后续补发  津补贴标准时间
				from data_record_t117 t117 ,t116,data_record_t126 t126
				where t126.id = ',sTemRecordId,'
				and t117.changeSign = t126.changeSign  --
				and t117.c02 = \'',v_unit_dataId,'\' and t117.c04 = t116.id  and t117.c03 = t126.dataId and t126.c03 = \'10372\' ');
				PREPARE stmt FROM @sqlstr;
				EXECUTE stmt;
				DROP PREPARE stmt;
				
				-- 更新对应月份的补扣发  本月应补
				
				SET @sqlstr = CONCAT('insert into fund_subsidies_byyb (fund_month,byyb_month,unit_id,staff_id,allowance_id,allowance_title,salary_byyb,
								CreateDate)
						select ',v_i_fund_month,',',stemFundMonth,',',v_unit_dataId,',',staffId,',
						allowance_id,allowance_title,salary_hx_bf,now()
						
						from ', v_allowance_table,'
					where unit_id =  \'',v_unit_dataId,'\' and   staff_id = \'',staffId,'\'');
				PREPARE stmt FROM @sqlstr;
				EXECUTE stmt;
				DROP PREPARE stmt;
			else
					-- 更新对应月份的补扣发  本月应补
				select count(1) into @countSubsidiesByyb from fund_subsidies_byyb where  unit_id =  concat(v_unit_dataId,'') and  staff_id = concat(staffId,'')
				and fund_month =  v_i_fund_month and byyb_month =  stemFundMonth ;
				if  @countSubsidiesByyb>0 then
					SET @sqlstr = CONCAT('update fund_subsidies_byyb byb,', v_allowance_table,' pay
						set byb.salary_byyb = round(ifnull(byb.salary_byyb,0) + ifnull(pay.salary_byyb,0),2)
						where  byb.unit_id = pay.unit_id and byb.staff_id = pay.staff_id  and byb.unit_id = \'',v_unit_dataId,'\'
							and byb.staff_id = \'',staffId,'\' and byb.fund_month = ',v_i_fund_month,' 
							and byb.byyb_month = ',stemFundMonth,' and  byb.allowance_id = pay.allowance_id 
					');
					PREPARE stmt FROM @sqlstr;
					EXECUTE stmt;
					DROP PREPARE stmt;
				else
					SET @sqlstr = CONCAT('insert into fund_subsidies_byyb (fund_month,byyb_month,unit_id,staff_id,allowance_id,allowance_title,salary_byyb,
									CreateDate)
							select ',v_i_fund_month,',',stemFundMonth,',',v_unit_dataId,',',staffId,',
							allowance_id,allowance_title,salary_byyb,now()
							from ', v_allowance_table,'
						where unit_id =  \'',v_unit_dataId,'\' and   staff_id = \'',staffId,'\'');
					PREPARE stmt FROM @sqlstr;
					EXECUTE stmt;
					DROP PREPARE stmt;
				end if;
				-- 更新发放表-津补贴 后续补扣发金额 以及清空最新一次的补扣发金额，确定下一个月再做变动时，月结申报时数据是0
				SET @sqlstr = CONCAT('update ', v_allowance_table,' set   
					salary_hx_bf = ifnull(salary_hx_bf,0)+ifnull(salary_byyb,0)+0,
					-- 后续补扣金额 =之前后续金额+最新一次的金额

					-- 清空所有最新一次的补扣发金额,确保下一个月再做变动,月结申报时数据是0
					salary_byyb= 0
					,status = 2 -- 状态为2
					where unit_id =  \'',v_unit_dataId,'\' and   staff_id = \'',staffId,'\'');
				PREPARE stmt FROM @sqlstr;
				EXECUTE stmt;
				DROP PREPARE stmt;	
			end if;
			set sTempNum = sTempNum+1;
		end while;
	end if;
	
  END LOOP;
  -- 关闭游标
  CLOSE recordId_;
  -- 删除对应本月应补
  select count(1) into @count from fund_audit_record where unit_id =concat(v_unit_dataId,'') and fund_month <
	(select fund_month from fund_audit_record where unit_id = concat(v_unit_dataId,'') and fund_month < 
	(select fund_month from fund_audit_record where unit_id = concat(v_unit_dataId,'') and fund_month = v_i_fund_month )
	order by fund_month desc limit 1 ) order by fund_month desc limit 1;
	if @count>0 then 
		  select fund_month into @month from fund_audit_record where unit_id =concat(v_unit_dataId,'') and fund_month <
			(select fund_month from fund_audit_record where unit_id = concat(v_unit_dataId,'') and fund_month < 
			(select fund_month from fund_audit_record where unit_id = concat(v_unit_dataId,'') and fund_month = v_i_fund_month )
			order by fund_month desc limit 1 ) order by fund_month desc limit 1;
			delete from fund_byyb where unit_id = concat(v_unit_dataId,'') and fund_month = concat(@month,'');
			delete from fund_subsidies_byyb where unit_id = concat(v_unit_dataId,'') and fund_month = concat(@month,'');
	end if;
  -- 审核完成后 删除前2个月的record_fill_tail以及record_fill_subsidies表
	set @m = concat(v_i_fund_month,'01');
	select DATE_FORMAT(DATE_SUB(@m,INTERVAL 1 MONTH),'%Y%m') into @stemMonth;
	
	/*delete from record_fill_tail 
	where change_id in(select id from data_data_record t126 where t126.dataclassCode = 't126'
	and  t126.c01 = v_unit_dataId and fund_month < @stemMonth);
	delete c from record_fill_tail c ,
	(select id from data_record_t126 t126 where t126.c01 = concat(v_unit_dataId,'') 
	and fund_month < @stemMonth and t126.c03 != '10372') d where d.id = c.change_id;
	commit;*/
	/*delete from record_fill_subsidies 
	where change_id in(select id from data_data_record t117 where t117.dataclassCode = 't117'
	and  t117.c02 = v_unit_dataId and fund_month < @stemMonth);
	delete c from record_fill_subsidies c,
	(select id from data_record_t117 t117 where t117.c02 = concat(v_unit_dataId,'')
	and fund_month < @stemMonth and t117.c03 in (select id from t126 where t126.c01 = concat(v_unit_dataId,'') and  t126.c03 != '10372')) d where c.change_id = d.id;
	commit;*/
	/*delete from record_fill_tail where change_id not in 
		(select id from data_data_record where dataclassCode = 't126');-- 删除变动补扣发表在变动记录不存在 的change_id
		delete c from record_fill_tail c, 
		(select id from data_record_t126 t126 where t126.c01 = concat(v_unit_dataId,'')  and t126.c03 != '10372') d where c.change_id = d.id;
	/*delete from record_fill_subsidies where change_id not in 
		(select id from data_data_record where dataclassCode = 't117');-- 删除变动补扣发表在变动记录不存在 的change_id 
		delete c from record_fill_subsidies c ,
		(select t117.id from data_record_t117 t117,t126 where t117.c03 = concat(t126.id,'') and   t126.c01 = concat(v_unit_dataId,'') and  t126.c03 != '10372') d  where c.change_id = d.id;
  	commit;*/
 COMMIT;

END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`fund_init`(in v_i_fund_month varchar(6),in v_unit_id varchar(50),in v_unit_dataId int(11),inout resultMsg varchar(1000))
label_pro:BEGIN
declare stemNum int(11);
declare stemP varchar(20);
declare stemFundMonth varchar(20); -- 基金月份 
DECLARE v_table VARCHAR(30);
DECLARE v_allowance_table VARCHAR(50);

	DECLARE czbm varchar(20);-- 财政编码
	
	DECLARE czgyNum int(11);-- 财政供养-人数
	DECLARE cztfNum int(11);-- 财政统发-人数
	DECLARE xzbzNum int(11);-- 行政编制-编制数
	DECLARE xzbzSjNum int(11);-- 行政编制-实有数
	DECLARE dlbzNum int(11);-- 单列编制-编制数
	DECLARE dlbzSjNum int(11);-- 单列编制-实有数
	DECLARE jjbzNum int(11);-- 纪检编制-编制数
	DECLARE jjbzSjNum int(11);-- 纪检编制-实有数
	DECLARE jzbzNum int(11);-- 军转编制-编制数
	DECLARE jzbzSjNum int(11);-- 军转编制-实有数
	DECLARE zfzxbzNum int(11);-- 政法专项编制-编制数
	DECLARE zfzxbzSjNum int(11);-- 政法专项编制-实有数
	DECLARE qebkNum int(11);-- 全额拨款编制-编制数
	DECLARE qebkSjNum int(11);-- 全额拨款编制-实有数
	DECLARE xzzfNum int(11);-- 行政执法编制-编制数
	DECLARE xzzfSjNum int(11);-- 行政执法编制-实有数
	DECLARE jggcNum int(11);-- 机关工勤编制-编制数
	DECLARE jggcSjNum int(11);-- 机关工勤编制-实有数
	DECLARE cebkNum int(11);-- 差额拨款-编制数
	DECLARE cebkSjNum int(11);-- 差额拨款-实有数
	DECLARE zszzNum int(11);-- 自收自支-编制数
	DECLARE zszzSjNum int(11);-- 自收自支-实有数

 	DECLARE byhdrsNum int(11) default 0;-- 本月核定人数
	DECLARE zjNum int(11) default 0;-- 增加小计

	DECLARE gzNum int(11) default 0;-- 公招数量
	DECLARE drNum int(11) default 0;-- 调入数量
	DECLARE jzgbNum int(11) default 0;-- 军转干部数量
	DECLARE ftjrNum int(11) default 0;-- 复退军人数量
	DECLARE qtzjNum int(11) default 0;-- 其他增加数量

	DECLARE jsNum int(11) default 0;-- 减少小计

	DECLARE ltxNum int(11) default 0;-- 退(离)休数量
	DECLARE dcNum int(11) default 0;-- 调出数量
	DECLARE swNum int(11) default 0;-- 死亡数量
	DECLARE czNum int(11) default 0;-- 辞职数量
	DECLARE ctNum int(11) default 0;-- 辞退数量
	DECLARE kcNum int(11) default 0;-- 开除数量
	DECLARE zdlzNum int(11) default 0;-- 自动离职数量
	DECLARE qtjsNum int(11) default 0;-- 其他减少数量

	declare sysDataBase varchar(20);-- 数据库名称

DECLARE personId_ CURSOR FOR
   SELECT t126.id from t126 ,t125,sys_s_data d 
		where t125.c06 = t126.id and d.id = t125.c36 
		and t126.c01 = concat(v_unit_dataId,'')  -- 
	  and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1');-- t126.c03 人员状态-码表 1-在职
 
	 select count(1) into stemNum from t126 where c01 = concat(v_unit_dataId,'');
	 if stemNum = 0 then 
	 	leave label_pro;-- 单位没有人员
	end if;

	select ifnull(content,'smso') into sysDataBase from sys_s_config where enname = 'DATABASE_NAME';-- 数据库名称

	-- select DATE_FORMAT(DATE_SUB(now(),INTERVAL 1 MONTH),'%Y%m') into stemFundMonth;-- 201606 
	set stemFundMonth = v_i_fund_month;
	select t128.c01 into czbm from t111,t128 where t111.c15 = t128.id and t111.id = v_unit_dataId ; -- t111.c15 单位财政编码 关联 t128 单位财政编码表c01 编码 c02 名称
	select c02,c03,c04,c05,c06,c08,c10,c07,c12,c13 into xzbzNum,dlbzNum,jjbzNum,jzbzNum,zfzxbzNum,qebkNum,xzzfNum,jggcNum,cebkNum,zszzNum
	 from t112 where c01 = concat(v_unit_dataId,'');-- t112 基层单位编制表 
	-- c02-行政编制,c03-单列编制,c04-纪检编制,c05-军转编制,c06-政法专项编制,c08-全额拨款事业编制,c10-行政执法事业编制,c07-机关工勤人员控制数,c12-差额拨款编制,c13-自收自支编制

	select count(1) into czgyNum from t126,sys_s_data d where t126.c01 = concat(v_unit_dataId,'') 
		and t126.c24 = d.id and d.typename = 'is' and d.data_value = 1 ; -- 财政供养-人数 t126.c24 是否财政供养

	select count(1) into cztfNum from t126,sys_s_data d where t126.c01 = concat(v_unit_dataId,'') 
		and t126.c22 = d.id and d.typename = 'is' and d.data_value = 1;-- 财政统发-人数t126.c22 是否工资统发

	select count(1) into xzbzSjNum from t126 ,sys_s_data d where t126.c01 = concat(v_unit_dataId,'') -- t126.c21 人员基本信息-人员编制
		and t126.c21 = d.id and d.typename = 'rybz' and d.data_value = '0101';-- 行政编制 实有数 

	select count(1) into dlbzSjNum from t126 ,sys_s_data d where t126.c01 = concat(v_unit_dataId,'') 
		and t126.c21 = d.id and d.typename = 'rybz' and d.data_value = '0102';-- 单列编制-实有数 

	select count(1) into jjbzSjNum from t126 ,sys_s_data d where t126.c01 = concat(v_unit_dataId,'') 
		and t126.c21 = d.id and d.typename = 'rybz' and d.data_value = '0103';-- 纪检编制-实有数 

	select count(1) into jzbzSjNum from t126 ,sys_s_data d where t126.c01 = concat(v_unit_dataId,'') 
		and t126.c21 = d.id and d.typename = 'rybz' and d.data_value = '0104';-- 军转编制-实有数 

	select count(1) into zfzxbzSjNum from t126 ,sys_s_data d where t126.c01 = concat(v_unit_dataId,'') 
		and t126.c21 = d.id and d.typename = 'rybz' and d.data_value = '011';-- 政法专项编制-实有数
 
	select count(1) into qebkSjNum from t126 ,sys_s_data d where t126.c01 = concat(v_unit_dataId,'') 
		and t126.c21 = d.id and d.typename = 'rybz' and d.data_value = '0201';-- 全额拨款编制-实有数
 
	select count(1) into xzzfSjNum from t126 ,sys_s_data d where t126.c01 = concat(v_unit_dataId,'') 
		and t126.c21 = d.id and d.typename = 'rybz' and d.data_value = '0202';-- 行政执法编制-实有数 

	select count(1) into jggcSjNum from t126 ,sys_s_data d where t126.c01 = concat(v_unit_dataId,'') 
		and t126.c21 = d.id and d.typename = 'rybz' and d.data_value = '0203';-- 机关工勤编制-实有数

	select count(1) into cebkSjNum from t126 ,sys_s_data d where t126.c01 = concat(v_unit_dataId,'') 
		and t126.c21 = d.id and d.typename = 'rybz' and d.data_value = '021';-- 差额拨款-实有数

	select count(1) into zszzSjNum from t126 ,sys_s_data d where t126.c01 = concat(v_unit_dataId,'') 
		and t126.c21 = d.id and d.typename = 'rybz' and d.data_value = '022';-- 自收自支-实有数 
	
	
	
	select count(1) into stemP from fund_audit_record where unit_id = concat(v_unit_dataId,'') and fund_month = stemFundMonth;
	-- 如果已经存在数据,则不执行后面的
	if stemP > 0 then LEAVE label_pro; end if;
	
	INSERT INTO fund_audit_record(fund_month,unit_id,unit_code,fund_status,firstFlag,secondFlag,
								thirdFlag,forthFlag,fiveFlag,sixFlag,auditMsg) 
						VALUES(stemFundMonth,v_unit_dataId,v_unit_id,'2','2','2','2','2','2','2','');/*插入审核状态数据并默认通过*/
						
	select c13 into stemP from t111 where id  = v_unit_dataId; -- t111单位基本信息表 c13 执行工资制度
	select data_value into stemP from sys_s_data where id = stemP and typename = 'wageScheme'; -- 0-机关 1-事业 2-机关事业并存
	SET v_table =  CONCAT('fund_salary_pay_',stemFundMonth);/*处理分表存储*/
	SET v_allowance_table =  CONCAT('fund_salary_subsidies_pay_',stemFundMonth);/*处理分表存储*/
	select count(1) into stemNum from information_schema.tables where table_schema = sysDataBase and TABLE_NAME = v_table;-- smso数据库里面对应的工资发放表信息
	if stemNum = 0 then -- 判断是否已经存在v_i_fund_month(如201608)的工资发放表信息
		SET @sqlstr = CONCAT('CREATE TABLE ',v_table,' LIKE ', ' fund_salary_pay');
		PREPARE stmt FROM @sqlstr;
		EXECUTE stmt;
		DROP PREPARE stmt;
	end if;
	select count(1) into stemNum from information_schema.tables where table_schema = sysDataBase and TABLE_NAME = v_allowance_table;-- smso数据库里面对应的工资发放津补贴表信息
	if stemNum = 0 then -- 判断是否已经存在v_i_fund_month(如201608)的工资发放表信息
		SET @sqlstr = CONCAT('CREATE TABLE ',v_allowance_table,' LIKE ', ' fund_salary_subsidies_pay');
		PREPARE stmt FROM @sqlstr;
		EXECUTE stmt;
		DROP PREPARE stmt;
	end if;
		
			-- 插入基金发放发- 通过t126.t125,t117获取
	SET @sqlstr = CONCAT('INSERT INTO ', v_table,' (fund_month,unit_id,unit_code,staff_id,staff_name,
			staff_eduLevel,staff_standing,staff_curPost,
			-- 学历			人员身份		现任职务
			staff_actual_workRank,staff_workRank,staff_isLeader,staff_postSalRank,staff_salRankLevel,
			-- 实际职务/技术等级	工资对应职级	是否领导工资	工资级别		工资档次
			staff_jobSal,staff_levelSal,staff_teacherNurseUpTen,staff_specialTeachFifteen,staff_keepSpecialStationSal,staff_midTeacherKeeyTen,staff_keepNurseUpTen,
			-- 职务/技术等级工资 级别岗位级别工资 教师护士提高10% 特殊教育提高15%			保留特岗工资			中小学教师保留10%工资	保留护士提高10%工资
			staff_peacetimeAward,staff_basicPerfor,
			-- 平时训练奖			基础绩效
			jbt_total_salary,actual_total_salary,salary_value,theory_total_salary,
			-- 津补贴小计		实发工资合计		工资补扣发		实际应发工资合计
			is_finSupt,is_salUniOut,department_name,
			-- 是否财政供养 是否财政统发 部门
			staff_wageSystem,staff_isUpten,staff_plusGrade,staff_downGrade,staff_plusLevel,staff_floatLevel,staff_fixLevel,staff_downLevel,
			-- 人员工资制度 是否提高10%工资  已含高定级别  已含低定级别		已含高定档次	已含浮动档次	已含固定档次	已含低定档次
			st_sal_date,en_sal_date,staff_status,staff_sex,staff_birth,staff_degree,staff_workYears,staff_from,staff_establish,
			-- 起薪时间 停薪时间	人员状态		性别		出生日期	学位		连续工龄	人员来源	人员编制
			staff_isChuFen,staff_salaryStandard,staff_isMainPart,staff_isStop,staff_partYears,staff_isMidTeacher,
			-- 是否处分		执行工资标准			是否主力		是否停薪		入队年限		是否中小学教师
			staff_isNurse,staff_fileNum,staff_titleRank,staff_isSpecialTeach,staff_salStandardDate
			-- 是否护士		根据文号		衔级			是否特殊教育		工资标准时间
			,staff_czbm,staff_sbid,staff_mz,staff_sfz,staff_bysj
			-- 财政编码 社保号 民族 身份证号 毕业时间
			,staff_jrbdwsj,staff_cjgzsj,staff_xrzwsj,staff_jdgl
			-- 进入本单位时间 参加工作时间 现任职务时间 间断工龄
			,staff_kjsgl,staff_wjsgl,staff_jbsj,staff_dcsj
			-- 工作前可计算工龄 未计算学习工龄 级别起考年份 档次起考年份
			,staff_gddc,staff_gdyj,staff_fddc,staff_fdyj
			-- 高定档次 高定依据 浮动档次 浮动依据 
			,staff_gudingdc,staff_gudingyj,staff_dddc,staff_ddyj
			-- 固定档次 固定依据 低定档次 低定原因
			,staff_gdjb,staff_gdjbyj,staff_ddjb,staff_ddjbyj
			-- 高定级别 高定级别依据 低定级别 低定级别依据
			)
			select ',v_i_fund_month,',',v_unit_dataId,',\'',v_unit_id,'\',t126.c02,t126.c04,
				ifnull((select d.name from sys_s_data d where d.id = t126.c09),t126.c09),ifnull((select d.name from sys_s_data d where d.id = t126.c28),t126.c28),t126.c19,
			-- 学历			人员身份		现任职务
				ifnull((select d.name from sys_s_data d where d.id = t126.c36),t126.c36),(select t127.c05 from t127 where t127.id = t126.c17),
			-- 实际职务/技术等级	工资对应职级	
				(select t127.c04 from t127 where t127.id = t126.c27),(select t127.c05 from t127 where t127.id = t125.c07),(select t127.c04 from t127 where t127.id = t125.c09),
			-- 是否领导工资	工资级别		工资档次
				t125.c25,t125.c26,t125.c28,t125.c29,t125.c30,t125.c44,t125.c45,
			-- 职务/技术等级工资 级别岗位级别工资 教师护士提高10% 特殊教育提高15%			保留特岗工资			中小学教师保留10%工资	保留护士提高10%工资
				t125.c47,t125.c31,
			-- 平时训练奖			基础绩效
				t125.c27,t125.c32,0,t125.c32+0,
			-- 津补贴小计		实发工资合计		工资补扣发		实际应发工资合计
			ifnull((select d.name from sys_s_data d where d.id = t126.c24),t126.c24),ifnull((select d.name from sys_s_data d where d.id = t126.c22),t126.c22),(select c03 from t113 where id=t126.c15),
			-- 是否财政供养 是否财政统发 部门
			ifnull((select d.name from sys_s_data d where d.id = t125.c36),t125.c36),ifnull((select d.name from sys_s_data d where d.id = t125.c23),t125.c23)
			-- 人员工资制度 是否提高10%工资
			,t125.c11,t125.c13,t125.c15,t125.c17,t125.c19,t125.c21,
			--    已含高定级别  已含低定级别		已含高定档次	已含浮动档次	已含固定档次	已含低定档次
			t125.c02,t125.c38,ifnull((select d.name from sys_s_data d where d.id = t126.c03),t126.c03),
			-- 起薪时间 停薪时间	人员状态		
			ifnull((select d.name from sys_s_data d where d.id = t126.c05),t126.c05),t126.c08,ifnull((select d.name from sys_s_data d where d.id = t126.c10),t126.c10),
			-- 性别		出生日期	学位		
			t126.c14,ifnull((select d.name from sys_s_data d where d.id = t126.c16),t126.c16),ifnull((select d.name from sys_s_data d where d.id = t126.c21),t126.c21),
			-- 连续工龄	人员来源	人员编制
			ifnull((select d.name from sys_s_data d where d.id = t125.c39),t125.c39),ifnull((select d.name from sys_s_data d where d.id = t126.c39),t126.c39),
			-- 是否处分  执行工资标准/工资标准类别
			ifnull((select d.name from sys_s_data d where d.id = t126.c42),t126.c42),ifnull((select d.name from sys_s_data d where d.id = t126.c43),t126.c43),
			--   是否主力		是否停薪	
			t126.c45,ifnull((select d.name from sys_s_data d where d.id = t125.c01),t125.c01),
			--	入队年限		是否中小学教师
			ifnull((select d.name from sys_s_data d where d.id = t125.c03),t125.c03),t125.c04,
			-- 是否护士		根据文号		
			ifnull((select d.name from sys_s_data d where d.id = t125.c24),t125.c24),ifnull((select d.name from sys_s_data d where d.id = t125.c35),t125.c35),t125.c49
			-- 衔级			是否特殊教育		工资标准时间
			,t126.c23,t126.c25,t126.c06,t126.c07,t126.c11
			-- 财政编码 社保号 民族 身份证号 毕业时间
			,t126.c13,t126.c12,t126.c20,concat(t126.c34,\'.\',t126.c35)
			-- 进入本单位时间 参加工作时间 现任职务时间 间断工龄
			,concat(t126.c32,\'.\',t126.c33),concat(t126.c30,\'.\',t126.c31),t125.c08,t125.c10
			-- 工作前可计算工龄 未计算学习工龄 级别起考年份 档次起考年份
			,t125.c15,t125.c16,t125.c17,t125.c18
			-- 高定档次 高定依据 浮动档次 浮动依据 
			,t125.c19,t125.c20,t125.c21,t125.c22
			-- 固定档次 固定依据 低定档次 低定原因
			,t125.c11,t125.c12,t125.c13,t125.c14
			-- 高定级别 高定级别依据 低定级别 低定级别依据
		from t126,t125 
		where 1=1 and t126.c01 = \'',v_unit_dataId,'\' and t126.id = t125.c06 ');
	PREPARE stmt FROM @sqlstr;
	EXECUTE stmt;
	DROP PREPARE stmt;	
	
	-- select this_month_person_num into stempParam from fund_total_person_type_gov where unit_id = v_unit_dataId and fund_month = stempMonth and person_type = '1';-- 上月核定人数
	
		if stemP = 0 or stemP = 2 then -- 机关
		/**	SET @sqlstr = CONCAT('INSERT INTO ', v_table,' select * from ' ,v_table_pre);
				PREPARE stmt FROM @sqlstr;
				EXECUTE stmt;
				SET @sqlstr = CONCAT('update ',v_table,' set',' fund_month = ',stemFundMonth,' and unit_id = ',v_unit_dataId);
				PREPARE stmt FROM @sqlstr;
				EXECUTE stmt;
				*/
			-- 插入机关核定表 机关总人数核定表fund_total_person_gov/fund_total_person_type_gov机关分类人数核定表(公务员/机关工勤)
			-- fund_total_person_gov  机关总人数核定表  存放编制等相关信息
-- 所有在职公务员
SELECT count(1) into byhdrsNum from t126 ,t125,sys_s_data d 
		where t125.c06 = t126.id and d.id = t125.c36 -- t125.c06人员工资表 c06人员编号关联 人员基本表t126.id
		and t126.c01 = concat(v_unit_dataId,'') and d.data_value = '201' -- t125.c36 人员工资制度为 201 -公务员职级工资
		and EXISTS (select 1 from t136 where t126.c39 = t136.c04) -- t126.c39 执行工资标准 关联 单位工资制度与人员属性信息对应关系t136.c04 执行工资标准
		-- 2017-1-6改成 工资标准类别 码表 
	  and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1');-- t126.c03 人员状态-码表 1-在职
		
	delete from fund_total_person_type_gov where fund_month  = v_i_fund_month and unit_id = concat(v_unit_dataId,'') and person_type = '1';-- 如果系统里面已经存在,先删除

		INSERT INTO fund_total_person_type_gov(fund_month,unit_id,unit_code,person_type,pre_month_person_num,
		increase_part_total,dr_num,gz_num,jz_num,ftjr_num,other_incr_num,
		decrease_part_total,tlx_num,dc_num,cz_num,ct_num,kc_num,zdlz_num,sw_num,other_decr_num,
		this_month_person_num)
		values( v_i_fund_month,v_unit_dataId,v_unit_id,'1' ,0,
		zjNum,drNum,gzNum,jzgbNum,ftjrNum,qtzjNum,
		jsNum,ltxNum,dcNum,czNum,ctNum,kcNum,zdlzNum,swNum,qtjsNum,
		byhdrsNum );-- 公务员(参公)

-- 所有机关工人
SELECT count(1) into byhdrsNum from t126 ,t125,sys_s_data d 
		where t125.c06 = t126.id and d.id = t125.c36 
		and t126.c01 = concat(v_unit_dataId,'') and  d.data_value in (202,203) -- t125.c36 人员工资制度为 202 -机关技工岗位等级工资制 203-机关普工岗位工资制
		and EXISTS (select 1 from t136 where t126.c39 = t136.c04) -- t126.c39 执行工资标准 关联 单位工资制度与人员属性信息对应关系t136.c04 执行工资标准
		-- 2017-1-6改成 工资标准类别 码表 
		and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1');-- t126.c03 人员状态-码表 1-在职
		
	delete from fund_total_person_type_gov where fund_month  = v_i_fund_month and unit_id = concat(v_unit_dataId,'') and person_type = '2';-- 如果系统里面已经存在,先删除

		INSERT INTO fund_total_person_type_gov(fund_month,unit_id,unit_code,person_type,pre_month_person_num,
		increase_part_total,dr_num,gz_num,jz_num,ftjr_num,other_incr_num,
		decrease_part_total,tlx_num,dc_num,cz_num,ct_num,kc_num,zdlz_num,sw_num,other_decr_num,
		this_month_person_num)
		values( v_i_fund_month,v_unit_dataId,v_unit_id,'2' ,0,
		zjNum,drNum,gzNum,jzgbNum,ftjrNum,qtzjNum,
		jsNum,ltxNum,dcNum,czNum,ctNum,kcNum,zdlzNum,swNum,qtjsNum,
		byhdrsNum );-- 机关工勤

	
	-- fund_total_person_gov  机关总人数核定表  存放编制等相关信息

	delete from fund_total_person_gov where fund_month  = v_i_fund_month and unit_id = concat(v_unit_dataId,'');-- 如果系统里面已经存在,先删除

	INSERT INTO fund_total_person_gov(fund_month,unit_id,unit_code,cz_code,czgy_num,cztf_num,xzbz_num,xzbz_sj_num,dlbz_num,dlbz_sj_num,jjbz_num,jjbz_sj_num,jzbz_num,jzbz_sj_num,zfzxbz_num,zfzxbz_sj_num,
		qebk_num,qebk_sj_num,xzzf_num,xzzf_sj_num,jggc_num,jggc_sj_num,cebk_num,cebk_sj_num,zszz_num,zszz_sj_num)
	values(v_i_fund_month,v_unit_dataId,v_unit_id,czbm,czgyNum,cztfNum,xzbzNum,xzbzSjNum,dlbzNum,dlbzSjNum,jjbzNum,jjbzSjNum,jzbzNum,jzbzSjNum,zfzxbzNum,zfzxbzSjNum,
		qebkNum,qebkSjNum,xzzfNum,xzzfSjNum,jggcNum,jggcSjNum,cebkNum,cebkSjNum,zszzNum,zszzSjNum); 
		end if;
		if stemP = 1 or stemP = 2  then 
			-- CALL p_6_fund (v_i_fund_month,v_unit_id);/*基金生成-事业工资发放表*/
			-- CALL p_5_fund (v_i_fund_month,v_unit_id);/*基金生成-事业变动花名册*/
			CALL p_4_fund (v_i_fund_month,v_unit_id,v_unit_dataId,resultMsg);/*基金生成-事业核定表*/
		end if;
	-- fund_salary_fill_201711 小数点
	-- update v_table set jbt_total_salary =cast(jbt_total_salary as decimal(10,2)) where fund_month = v_i_fund_month and unit_id =v_unit_dataId;
	-- update v_table set salary_value =cast(salary_value as decimal(10,2)) where fund_month = v_i_fund_month and unit_id =v_unit_dataId;
	-- update v_table set actual_total_salary =cast(actual_total_salary as decimal(10,2)) where fund_month = v_i_fund_month and unit_id =v_unit_dataId;
	-- update v_table set theory_total_salary =cast(theory_total_salary as decimal(10,2)) where fund_month = v_i_fund_month and unit_id =v_unit_dataId;
	SET @sqlstr = CONCAT('update ', v_table,'set jbt_total_salary =case when length(jbt_total_salary)>10 then cast(jbt_total_salary as decimal(10,2)) else jbt_total_salary end ,
	salary_value =case when length(salary_value)>10 then cast(salary_value as decimal(10,2)) else salary_value end,
	 actual_total_salary =case when length(actual_total_salary)>10 then cast(actual_total_salary as decimal(10,2)) else actual_total_salary end,
 theory_total_salary =case when length(theory_total_salary)>10 then cast(theory_total_salary as decimal(10,2)) else theory_total_salary end
 where fund_month = ',v_i_fund_month,'  and unit_id =',v_unit_dataId );

	-- set resultMsg = concat('@sqlstr:',@sqlstr);leave label_pro;
		PREPARE stmt FROM @sqlstr;
		EXECUTE stmt;
		DROP PREPARE stmt;
	
	
	
commit;
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`getFundTotalJbt`(in tableName varchar(100),in unitId varchar(20),
in fundMonth varchar(20),inout resultMsg varchar(10000))
label_pro:BEGIN	
	/**
	tableName-查询表 fund_total_gov/fund_total_ins
	unit_id-单位id
	fund_month-基金月份
	*/
		-- 获取sys_s_data 表dataId的所有上级  
	DECLARE sTemp int(11);
    -- DECLARE sTempJbtCodeSalary VARCHAR(1000);
    DECLARE jbtLength int(11);
    DECLARE stempCount int(11);
    
    delete from fund_total_sub_temp where fund_month = concat(fundMonth,'') and unit_id = concat(unitId,'') and table_name = tableName;
    
    set @sqlstr = concat('
	select count(1)
	into @stempNum
	from ',tableName,' where fund_month = ',fundMonth,' and unit_id = ',unitId ,' and ifnull(jbt_code_salary,\'\')!=\'\'');
	PREPARE stmt FROM @sqlstr; -- 查询
	EXECUTE stmt;
	DROP PREPARE stmt;
	set stempCount = 0;
	while stempCount < @stempNum DO 
	    set @sqlstr = concat('
		select length(jbt_code_salary)-length(replace(jbt_code_salary, \',\', \'\'))+1 
		into @stemNum
		from ',tableName,' where fund_month = ',fundMonth,' and unit_id = ',unitId,' and ifnull(jbt_code_salary,\'\')!=\'\' limit ',stempCount,',1');
		PREPARE stmt FROM @sqlstr; -- 查询
		EXECUTE stmt;
		DROP PREPARE stmt;
		
		set jbtLength = @stemNum;
		-- set sTempJbtCodeSalary = '$';
	      SET sTemp = 1;
	    
	      WHILE sTemp<=jbtLength DO
	        set @sqlstr = concat('
				insert into fund_total_sub_temp(fund_month,unit_id,jbt_code,jbt_salary,changeType,table_name)
			 select ',fundMonth,',',unitId,', SUBSTRING(jbtCodeSalary,1,POSITION(\'-\' IN jbtCodeSalary)-1) as jbtCode,
			round(SUBSTRING(jbtCodeSalary FROM POSITION(\'-\' IN jbtCodeSalary)+1),2) as jbtSalary,change_type,\'',tableName,'\'
		-- 	into @jbtCode,@jbtSalary
			from(
			select reverse(substring_index( reverse(substring_index(jbt_code_salary, \',\', ',sTemp,')), \',\', 1))  as jbtCodeSalary,
				ifnull(changetype_name,change_type) as change_type
			from ',tableName,' where fund_month = ',fundMonth,' and unit_id = ',unitId,' and ifnull(jbt_code_salary,\'\')!=\'\' 
			and change_type != \'本月核定工资总额\'
			limit ',stempCount,',1
			) a
			');
			-- set resultMsg = concat('@sqlstr:',@sqlstr);leave label_pro;
			PREPARE stmt FROM @sqlstr; -- 查询
			EXECUTE stmt;
			DROP PREPARE stmt;			
			set sTemp=sTemp+1;
	      END WHILE;
	      SET stempCount = stempCount+1;
	END WHILE;
	select count(1) into @sTnum  from fund_total_sub_temp where fund_month = concat(fundMonth,'') and unit_id = concat(unitId,'');
	if @sTnum > 0 then 
		select group_concat(concat(jbt_code,'-',case when round(jbtSalary ,2) =0 then '' else round(jbtSalary ,2)  end)) into resultMsg from 
		(select jbt_code,sum(jbt_salary) as jbtSalary 
		from fund_total_sub_temp where fund_month = concat(fundMonth,'') and unit_id = concat(unitId,'') and table_name = tableName
		group by jbt_code
		) a;
		delete from fund_total_sub_temp where fund_month = concat(fundMonth,'') and unit_id = concat(unitId,'') and table_name = tableName;
	end if;
   END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`init_data_auto_record`()
label_pro:BEGIN
	#Routine body goes here...
DECLARE org_id int(11);-- -- 单位id
	DECLARE done INT DEFAULT FALSE; -- 自定义控制游标循环变量,默认false  
	DECLARE My_Cursor CURSOR FOR (
		select id  from t111 
	);
	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE; -- 绑定控制变量到游标,游标循环结束自动转true  
	
	TRUNCATE data_auto_record;


	OPEN My_Cursor; -- 打开游标  
  myLoop: LOOP -- 开始循环体,myLoop为自定义循环名,结束循环时用到  
    FETCH My_Cursor into org_id; 
    IF done THEN -- 判断是否继续循环  
      LEAVE myLoop; -- 结束循环  
    END IF;  
		-- t113 c02 autonedlength 4		
		-- t126 c02 autonedlength 5		
		-- t130 c01 autonedlength 2	
		call p_init_autoBumen(org_id,@re);-- 部门表
		select c01 into @orgdm from t111 where id =org_id;
		/** select count(id) into @t113c02 from t113 where c01=org_id;
		if @t113c02 >0 THEN
			INSERT INTO `data_auto_record` VALUES ('', 't113', 'c02', now(), now(), @orgdm, '', '4', @t113c02);
		end if ;
		*/
		select count(id) into @t126c02 from t126 where c01=org_id;
		if @t126c02>0 then 
			INSERT INTO `data_auto_record` VALUES ('', 't126', 'c02', now(), now(), @orgdm, '', '5', @t126c02);
		end if;
		select count(id) into @t130c01 from t130 where c03=org_id;
		if @t130c01>0 then 
			INSERT INTO `data_auto_record` VALUES ('', 't130', 'c01', now(), now(), @orgdm, '', '2', @t130c01);
		end if;

  END LOOP myLoop; -- 结束自定义循环体  
  CLOSE My_Cursor; -- 关闭游标  


END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`jbtxiaoji`(inout resultMsg varchar(10000))
label:BEGIN
	DECLARE org_id int(11);-- -- 单位id

	DECLARE done INT DEFAULT FALSE; -- 自定义控制游标循环变量,默认false  
	DECLARE My_Cursor CURSOR FOR (
		  select DISTINCT c01 from t126 where id in(select id from (select a.c03 as id ,a.cc as ccc from (
			select c03,c04,count(1) as cc
			from t117 
			group by c03,c04

			order by count(1) desc) as a where cc>1)  as m) 



	);
	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE; -- 绑定控制变量到游标,游标循环结束自动转true  
	
	/*这个津补贴小计的问题

先把count(1)>1的单位找到
然后delete from t117 where c02 = 单位id
delete from ds_t5_c where dwmc = 211;
insert into ds_t5_c (select * from ds_t5 where dwmc = '四川省巴塘县地方税务局');
再p_init_ds_t117
再p_init_ds_money
再
p_insert_unit_record
*/
set resultMsg ='';


	OPEN My_Cursor; -- 打开游标  
  myLoop: LOOP -- 开始循环体,myLoop为自定义循环名,结束循环时用到  
    FETCH My_Cursor into org_id; 
    IF done THEN -- 判断是否继续循环  
      LEAVE myLoop; -- 结束循环  
    END IF;  
		
		if org_id>0 then 
			delete from t117 where c02 = concat(org_id,'');
			select c01,c02 into @orgNumber, @orgName from t111 where  id=org_id;
			delete from ds_t5_c where dwmc = @orgName or dwmc =concat(org_id,'');
			insert into ds_t5_c (select * from ds_t5 where dwmc = @orgName);

			 set @re='1';
				call p_init_ds_t117(@orgNumber,org_id,@orgName,@re);
				if LENGTH(@re)>1 then 
						set resultMsg =CONCAT(resultMsg,'+++',org_id,@orgName,@re);
						leave label;
				end if;
				set @re='1';
				call p_init_ds_money(@orgNumber,org_id,@orgName,@re);
       if LENGTH(@re)>1 then 
						 set resultMsg =CONCAT(resultMsg,'+++',org_id,@orgName,@re);
							leave label;
				end if;
				set @re='1';
				call	p_insert_unit_record(@orgNumber,org_id,@orgName,@re);
      if LENGTH(@re)>1 then 
						set resultMsg =CONCAT(resultMsg,'+++',org_id,@orgName,@re);
						leave label;
				end if;
				
		end if;



  END LOOP myLoop; -- 结束自定义循环体  
  CLOSE My_Cursor; -- 关闭游标  



END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`lxSalaryAdjustBkf`(IN dwid int(11),
INOUT resultMsg varchar(200) CHARSET utf8)
label_pro:BEGIN	

-- 更新前先清空之前的数据
DELETE FROM adjustwage.retireadjust;

-- 更新每种离休人员享受待遇级别   对应需要调整的标准

UPDATE t126 a,t125 b,t127 c SET b.c26='1700'
WHERE b.c06 = concat(a.id,'')  AND a.c03='10372' AND a.c17=c.id AND (c.c05='省部级正职' or c.c05='一级职员岗位');
UPDATE t126 a,t125 b,t127 c SET b.c26='1150'
WHERE b.c06 = concat(a.id,'')  AND a.c03='10372' AND a.c17=c.id AND (c.c05='省部级副职' or c.c05='二级职员岗位');

UPDATE t126 a,t125 b,t127 c SET b.c26='900'
WHERE b.c06 = concat(a.id,'')  AND a.c03='10372' AND a.c17=c.id AND (c.c05='厅局级正职' or c.c05='三级职员岗位');
UPDATE t126 a,t125 b,t127 c SET b.c26='750'
WHERE b.c06 = concat(a.id,'')  AND a.c03='10372' AND a.c17=c.id AND (c.c05='厅局级副职' or c.c05='四级职员岗位');

UPDATE t126 a,t125 b,t127 c SET b.c26='600'
WHERE b.c06 = concat(a.id,'')  AND a.c03='10372' AND a.c17=c.id AND (c.c05='县处级正职' or c.c05='五级职员岗位');
UPDATE t126 a,t125 b,t127 c SET b.c26='500'
WHERE b.c06 = concat(a.id,'')  AND a.c03='10372' AND a.c17=c.id AND (c.c05='县处级副职' or c.c05='六级职员岗位');
UPDATE t126 a,t125 b,t127 c SET b.c26='400'
WHERE b.c06 = concat(a.id,'')  AND a.c03='10372' AND a.c17=c.id AND (c.c05 LIKE '乡科级%' or c.c05='七级职员岗位' or c.c05='八级职员岗位');

UPDATE t126 a,t125 b,t127 c SET b.c26='820'
WHERE b.c06 = concat(a.id,'')  AND a.c03='10372' AND a.c17=c.id AND c.c05='教授';
UPDATE t126 a,t125 b,t127 c SET b.c26='580'
WHERE b.c06 = concat(a.id,'')  AND a.c03='10372' AND a.c17=c.id AND c.c05='副教授';
UPDATE t126 a,t125 b,t127 c SET b.c26='400'
WHERE b.c06 = concat(a.id,'')  AND a.c03='10372' AND a.c17=c.id AND c.c05='讲师';


-- 先插入在系统中存在 且需要做调标补扣发人员7~12月的数据
Insert into adjustwage.retireadjust(unitId,ryid,rybh,name,idcard,month,job,jobSalary,jobSalaryAfter,fill)
SELECT a.c01 unitId,a.id ryid,a.c02 rybh,a.c04 name,a.c07 idcard,'7',b.c05 job,c.c25 jobSalary,
(c.c25+c.c26) jobSalaryAfter,'0' fill
 FROM t126 a,t127 b,t125 c WHERE a.c03='10372' AND a.c17=b.id 
AND c.c06 = concat(a.id,'')  
AND NOT EXISTS(SELECT 1 FROM data_record_t125 WHERE dataId=c.id AND changeType='10831' AND c02<'2018-08')
AND EXISTS(SELECT 1 FROM data_record_t125 WHERE dataId=c.id AND changeType='10750' AND c02<'2019-01');
-- 八月
Insert into adjustwage.retireadjust(unitId,ryid,rybh,name,idcard,month,job,jobSalary,jobSalaryAfter,fill)
SELECT a.c01 unitId,a.id ryid,a.c02 rybh,a.c04 name,a.c07 idcard,'8',b.c05 job,c.c25 jobSalary,
(c.c25+c.c26) jobSalaryAfter,'0' fill
 FROM t126 a,t127 b,t125 c WHERE a.c03='10372' AND a.c17=b.id 
AND c.c06 = concat(a.id,'')  
AND NOT EXISTS(SELECT 1 FROM data_record_t125 WHERE dataId=c.id AND changeType='10831' AND c02<'2018-08')
AND EXISTS(SELECT 1 FROM data_record_t125 WHERE dataId=c.id AND changeType='10750' AND c02<'2019-01');
-- 九月
Insert into adjustwage.retireadjust(unitId,ryid,rybh,name,idcard,month,job,jobSalary,jobSalaryAfter,fill)
SELECT a.c01 unitId,a.id ryid,a.c02 rybh,a.c04 name,a.c07 idcard,'9',b.c05 job,c.c25 jobSalary,
(c.c25+c.c26) jobSalaryAfter,'0' fill
 FROM t126 a,t127 b,t125 c WHERE a.c03='10372' AND a.c17=b.id 
AND c.c06 = concat(a.id,'')  
AND NOT EXISTS(SELECT 1 FROM data_record_t125 WHERE dataId=c.id AND changeType='10831' AND c02<'2018-08')
AND EXISTS(SELECT 1 FROM data_record_t125 WHERE dataId=c.id AND changeType='10750' AND c02<'2019-01');
-- 十月
Insert into adjustwage.retireadjust(unitId,ryid,rybh,name,idcard,month,job,jobSalary,jobSalaryAfter,fill)
SELECT a.c01 unitId,a.id ryid,a.c02 rybh,a.c04 name,a.c07 idcard,'10',b.c05 job,c.c25 jobSalary,
(c.c25+c.c26) jobSalaryAfter,'0' fill
 FROM t126 a,t127 b,t125 c WHERE a.c03='10372' AND a.c17=b.id 
AND c.c06 = concat(a.id,'')  
AND NOT EXISTS(SELECT 1 FROM data_record_t125 WHERE dataId=c.id AND changeType='10831' AND c02<'2018-08')
AND EXISTS(SELECT 1 FROM data_record_t125 WHERE dataId=c.id AND changeType='10750' AND c02<'2019-01');
-- 十一月
Insert into adjustwage.retireadjust(unitId,ryid,rybh,name,idcard,month,job,jobSalary,jobSalaryAfter,fill)
SELECT a.c01 unitId,a.id ryid,a.c02 rybh,a.c04 name,a.c07 idcard,'11',b.c05 job,c.c25 jobSalary,
(c.c25+c.c26) jobSalaryAfter,'0' fill
 FROM t126 a,t127 b,t125 c WHERE a.c03='10372' AND a.c17=b.id 
AND c.c06 = concat(a.id,'')  
AND NOT EXISTS(SELECT 1 FROM data_record_t125 WHERE dataId=c.id AND changeType='10831' AND c02<'2018-08')
AND EXISTS(SELECT 1 FROM data_record_t125 WHERE dataId=c.id AND changeType='10750' AND c02<'2019-01');
-- 十二月
Insert into adjustwage.retireadjust(unitId,ryid,rybh,name,idcard,month,job,jobSalary,jobSalaryAfter,fill)
SELECT a.c01 unitId,a.id ryid,a.c02 rybh,a.c04 name,a.c07 idcard,'12',b.c05 job,c.c25 jobSalary,
(c.c25+c.c26) jobSalaryAfter,'0' fill
 FROM t126 a,t127 b,t125 c WHERE a.c03='10372' AND a.c17=b.id 
AND c.c06 = concat(a.id,'')  
AND NOT EXISTS(SELECT 1 FROM data_record_t125 WHERE dataId=c.id AND changeType='10831' AND c02<'2018-08')
AND EXISTS(SELECT 1 FROM data_record_t125 WHERE dataId=c.id AND changeType='10750' AND c02<'2019-01');





-- 计算每种待遇级别每个月需要补发的情况
-- 七月

 UPDATE adjustwage.retireadjust b,t125 c SET b.fill=(b.jobSalaryAfter-b.jobSalary)
WHERE  c.c06 = concat(b.ryid,'')   AND b.month='7'
AND NOT EXISTS(SELECT 1 FROM data_record_t125 WHERE dataId=c.id AND changeType='10831' AND c02<'2018-08')
AND EXISTS(SELECT 1 FROM data_record_t125 WHERE dataId=c.id AND changeType='10750' AND c02<'2018-08');
-- 八月
 UPDATE adjustwage.retireadjust b,t125 c SET b.fill=(b.jobSalaryAfter-b.jobSalary)
WHERE  c.c06 = concat(b.ryid,'')   AND b.month='8'
AND NOT EXISTS(SELECT 1 FROM data_record_t125 WHERE dataId=c.id AND changeType='10831' AND c02<'2018-09')
AND EXISTS(SELECT 1 FROM data_record_t125 WHERE dataId=c.id AND changeType='10750' AND c02<'2018-09');

-- 九月
 UPDATE adjustwage.retireadjust b,t125 c SET b.fill=(b.jobSalaryAfter-b.jobSalary)
WHERE c.c06 = concat(b.ryid,'')   AND b.month='9'
AND NOT EXISTS(SELECT 1 FROM data_record_t125 WHERE dataId=c.id AND changeType='10831' AND c02<'2018-10')
AND EXISTS(SELECT 1 FROM data_record_t125 WHERE dataId=c.id AND changeType='10750' AND c02<'2018-10');
-- 十月
 UPDATE adjustwage.retireadjust b,t125 c SET b.fill=(b.jobSalaryAfter-b.jobSalary)
WHERE c.c06 = concat(b.ryid,'')   AND b.month='10'
AND NOT EXISTS(SELECT 1 FROM data_record_t125 WHERE dataId=c.id AND changeType='10831' AND c02<'2018-11')
AND EXISTS(SELECT 1 FROM data_record_t125 WHERE dataId=c.id AND changeType='10750' AND c02<'2018-11');
-- 十一月
 UPDATE adjustwage.retireadjust b,t125 c SET b.fill=(b.jobSalaryAfter-b.jobSalary)
WHERE c.c06 = concat(b.ryid,'')   AND b.month='11' 
AND NOT EXISTS(SELECT 1 FROM data_record_t125 WHERE dataId=c.id AND changeType='10831' AND c02<'2018-12')
AND EXISTS(SELECT 1 FROM data_record_t125 WHERE dataId=c.id AND changeType='10750' AND c02<'2018-12');
-- 十二月
 UPDATE adjustwage.retireadjust b,t125 c SET b.fill=(b.jobSalaryAfter-b.jobSalary)
WHERE c.c06 = concat(b.ryid,'')   AND b.month='12'
AND NOT EXISTS(SELECT 1 FROM data_record_t125 WHERE dataId=c.id AND changeType='10831' AND c02<'2019-01')
AND EXISTS(SELECT 1 FROM data_record_t125 WHERE dataId=c.id AND changeType='10750' AND c02<'2019-01');

-- 恢复t125表 离休人员级别工资初始值
UPDATE t126 a,t125 b SET b.c26='' WHERE b.c06 = concat(a.id,'')  AND a.c03='10372'; 


END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`lxSalaryAdjustBkfByUnitId`(IN dwid int(11),
INOUT resultMsg varchar(200) CHARSET utf8)
label_pro:BEGIN	

-- 更新前先清空之前的数据
DELETE FROM adjustwage.retireadjust where unitId=concat(dwid,'');

-- 更新每种离休人员享受待遇级别   对应需要调整的标准

UPDATE t126 a,t125 b,t127 c SET b.c26='1700'
WHERE a.c01=concat(dwid,'') and b.c06 = concat(a.id,'') AND a.c03='10372' AND a.c17=c.id AND (c.c05='省部级正职' or c.c05='一级职员岗位');
UPDATE t126 a,t125 b,t127 c SET b.c26='1150'
WHERE a.c01=concat(dwid,'') and b.c06 = concat(a.id,'')  AND a.c03='10372' AND a.c17=c.id AND (c.c05='省部级副职' or c.c05='二级职员岗位');

UPDATE t126 a,t125 b,t127 c SET b.c26='900'
WHERE a.c01=concat(dwid,'') and b.c06 = concat(a.id,'')  AND a.c03='10372' AND a.c17=c.id AND (c.c05='厅局级正职' or c.c05='三级职员岗位');
UPDATE t126 a,t125 b,t127 c SET b.c26='750'
WHERE a.c01=concat(dwid,'') and b.c06 = concat(a.id,'')  AND a.c03='10372' AND a.c17=c.id AND (c.c05='厅局级副职' or c.c05='四级职员岗位');

UPDATE t126 a,t125 b,t127 c SET b.c26='600'
WHERE a.c01=concat(dwid,'') and b.c06 = concat(a.id,'')  AND a.c03='10372' AND a.c17=c.id AND (c.c05='县处级正职' or c.c05='五级职员岗位');
UPDATE t126 a,t125 b,t127 c SET b.c26='500'
WHERE a.c01=concat(dwid,'') and b.c06 = concat(a.id,'')  AND a.c03='10372' AND a.c17=c.id AND (c.c05='县处级副职' or c.c05='六级职员岗位');
UPDATE t126 a,t125 b,t127 c SET b.c26='400'
WHERE a.c01=concat(dwid,'') and b.c06 = concat(a.id,'')  AND a.c03='10372' AND a.c17=c.id AND (c.c05 LIKE '乡科级%' or c.c05='七级职员岗位' or c.c05='八级职员岗位');

UPDATE t126 a,t125 b,t127 c SET b.c26='820'
WHERE a.c01=concat(dwid,'') and b.c06 = concat(a.id,'')  AND a.c03='10372' AND a.c17=c.id AND c.c05='教授';
UPDATE t126 a,t125 b,t127 c SET b.c26='580'
WHERE a.c01=concat(dwid,'') and b.c06 = concat(a.id,'')  AND a.c03='10372' AND a.c17=c.id AND c.c05='副教授';
UPDATE t126 a,t125 b,t127 c SET b.c26='400'
WHERE a.c01=concat(dwid,'') and b.c06 = concat(a.id,'')  AND a.c03='10372' AND a.c17=c.id AND c.c05='讲师';


-- 先插入在系统中存在 且需要做调标补扣发人员7~12月的数据
Insert into adjustwage.retireadjust(unitId,ryid,rybh,name,idcard,month,job,jobSalary,jobSalaryAfter,fill)
SELECT a.c01 unitId,a.id ryid,a.c02 rybh,a.c04 name,a.c07 idcard,'7',b.c05 job,c.c25 jobSalary,
(c.c25+c.c26) jobSalaryAfter,'0' fill
 FROM t126 a,t127 b,t125 c WHERE a.c01=concat(dwid,'') and a.c03='10372' AND a.c17=b.id 
AND c.c06 = concat(a.id,'') 
AND NOT EXISTS(SELECT 1 FROM data_record_t125 WHERE dataId=c.id AND changeType='10831' AND c02<'2018-08')
AND EXISTS(SELECT 1 FROM data_record_t125 WHERE dataId=c.id AND changeType='10750' AND c02<'2019-01');
-- 八月
Insert into adjustwage.retireadjust(unitId,ryid,rybh,name,idcard,month,job,jobSalary,jobSalaryAfter,fill)
SELECT a.c01 unitId,a.id ryid,a.c02 rybh,a.c04 name,a.c07 idcard,'8',b.c05 job,c.c25 jobSalary,
(c.c25+c.c26) jobSalaryAfter,'0' fill
 FROM t126 a,t127 b,t125 c WHERE a.c01=concat(dwid,'') and a.c03='10372' AND a.c17=b.id 
AND c.c06 = concat(a.id,'')   
AND NOT EXISTS(SELECT 1 FROM data_record_t125 WHERE dataId=c.id AND changeType='10831' AND c02<'2018-08')
AND EXISTS(SELECT 1 FROM data_record_t125 WHERE dataId=c.id AND changeType='10750' AND c02<'2019-01');
-- 九月
Insert into adjustwage.retireadjust(unitId,ryid,rybh,name,idcard,month,job,jobSalary,jobSalaryAfter,fill)
SELECT a.c01 unitId,a.id ryid,a.c02 rybh,a.c04 name,a.c07 idcard,'9',b.c05 job,c.c25 jobSalary,
(c.c25+c.c26) jobSalaryAfter,'0' fill
 FROM t126 a,t127 b,t125 c WHERE a.c01=concat(dwid,'') and a.c03='10372' AND a.c17=b.id 
AND c.c06 = concat(a.id,'')   
AND NOT EXISTS(SELECT 1 FROM data_record_t125 WHERE dataId=c.id AND changeType='10831' AND c02<'2018-08')
AND EXISTS(SELECT 1 FROM data_record_t125 WHERE dataId=c.id AND changeType='10750' AND c02<'2019-01');
-- 十月
Insert into adjustwage.retireadjust(unitId,ryid,rybh,name,idcard,month,job,jobSalary,jobSalaryAfter,fill)
SELECT a.c01 unitId,a.id ryid,a.c02 rybh,a.c04 name,a.c07 idcard,'10',b.c05 job,c.c25 jobSalary,
(c.c25+c.c26) jobSalaryAfter,'0' fill
 FROM t126 a,t127 b,t125 c WHERE a.c01=concat(dwid,'') and a.c03='10372' AND a.c17=b.id 
AND c.c06 = concat(a.id,'')   
AND NOT EXISTS(SELECT 1 FROM data_record_t125 WHERE dataId=c.id AND changeType='10831' AND c02<'2018-08')
AND EXISTS(SELECT 1 FROM data_record_t125 WHERE dataId=c.id AND changeType='10750' AND c02<'2019-01');
-- 十一月
Insert into adjustwage.retireadjust(unitId,ryid,rybh,name,idcard,month,job,jobSalary,jobSalaryAfter,fill)
SELECT a.c01 unitId,a.id ryid,a.c02 rybh,a.c04 name,a.c07 idcard,'11',b.c05 job,c.c25 jobSalary,
(c.c25+c.c26) jobSalaryAfter,'0' fill
 FROM t126 a,t127 b,t125 c WHERE a.c01=concat(dwid,'') and a.c03='10372' AND a.c17=b.id 
AND c.c06 = concat(a.id,'')   
AND NOT EXISTS(SELECT 1 FROM data_record_t125 WHERE dataId=c.id AND changeType='10831' AND c02<'2018-08')
AND EXISTS(SELECT 1 FROM data_record_t125 WHERE dataId=c.id AND changeType='10750' AND c02<'2019-01');
-- 十二月
Insert into adjustwage.retireadjust(unitId,ryid,rybh,name,idcard,month,job,jobSalary,jobSalaryAfter,fill)
SELECT a.c01 unitId,a.id ryid,a.c02 rybh,a.c04 name,a.c07 idcard,'12',b.c05 job,c.c25 jobSalary,
(c.c25+c.c26) jobSalaryAfter,'0' fill
 FROM t126 a,t127 b,t125 c WHERE a.c01=concat(dwid,'') and a.c03='10372' AND a.c17=b.id 
AND c.c06 = concat(a.id,'')   
AND NOT EXISTS(SELECT 1 FROM data_record_t125 WHERE dataId=c.id AND changeType='10831' AND c02<'2018-08')
AND EXISTS(SELECT 1 FROM data_record_t125 WHERE dataId=c.id AND changeType='10750' AND c02<'2019-01');





-- 计算每种待遇级别每个月需要补发的情况
-- 七月
 UPDATE adjustwage.retireadjust b,t125 c SET b.fill=(b.jobSalaryAfter-b.jobSalary)
WHERE  b.unitId=concat(dwid,'') and c.c06 = concat(b.ryid,'')   AND b.month='7'
AND NOT EXISTS(SELECT 1 FROM data_record_t125 WHERE dataId=c.id AND changeType='10831' AND c02<'2018-08')
AND EXISTS(SELECT 1 FROM data_record_t125 WHERE dataId=c.id AND changeType='10750' AND c02<'2018-08');
-- 八月
 UPDATE adjustwage.retireadjust b,t125 c SET b.fill=(b.jobSalaryAfter-b.jobSalary)
WHERE  b.unitId=concat(dwid,'') and c.c06 = concat(b.ryid,'')  AND b.month='8'
AND NOT EXISTS(SELECT 1 FROM data_record_t125 WHERE dataId=c.id AND changeType='10831' AND c02<'2018-09')
AND EXISTS(SELECT 1 FROM data_record_t125 WHERE dataId=c.id AND changeType='10750' AND c02<'2018-09');

-- 九月
 UPDATE adjustwage.retireadjust b,t125 c SET b.fill=(b.jobSalaryAfter-b.jobSalary)
WHERE b.unitId=concat(dwid,'') and c.c06 = concat(b.ryid,'')  AND b.month='9'
AND NOT EXISTS(SELECT 1 FROM data_record_t125 WHERE dataId=c.id AND changeType='10831' AND c02<'2018-10')
AND EXISTS(SELECT 1 FROM data_record_t125 WHERE dataId=c.id AND changeType='10750' AND c02<'2018-10');
-- 十月
 UPDATE adjustwage.retireadjust b,t125 c SET b.fill=(b.jobSalaryAfter-b.jobSalary)
WHERE b.unitId=concat(dwid,'') and c.c06 = concat(b.ryid,'')  AND b.month='10'
AND NOT EXISTS(SELECT 1 FROM data_record_t125 WHERE dataId=c.id AND changeType='10831' AND c02<'2018-11')
AND EXISTS(SELECT 1 FROM data_record_t125 WHERE dataId=c.id AND changeType='10750' AND c02<'2018-11');
-- 十一月
 UPDATE adjustwage.retireadjust b,t125 c SET b.fill=(b.jobSalaryAfter-b.jobSalary)
WHERE b.unitId=concat(dwid,'') and c.c06 = concat(b.ryid,'')  AND b.month='11' 
AND NOT EXISTS(SELECT 1 FROM data_record_t125 WHERE dataId=c.id AND changeType='10831' AND c02<'2018-12')
AND EXISTS(SELECT 1 FROM data_record_t125 WHERE dataId=c.id AND changeType='10750' AND c02<'2018-12');
-- 十二月
 UPDATE adjustwage.retireadjust b,t125 c SET b.fill=(b.jobSalaryAfter-b.jobSalary)
WHERE b.unitId=concat(dwid,'') and c.c06 = concat(b.ryid,'')  AND b.month='12'
AND NOT EXISTS(SELECT 1 FROM data_record_t125 WHERE dataId=c.id AND changeType='10831' AND c02<'2019-01')
AND EXISTS(SELECT 1 FROM data_record_t125 WHERE dataId=c.id AND changeType='10750' AND c02<'2019-01');

-- 恢复t125表 离休人员级别工资初始值
UPDATE t126 a,t125 b SET b.c26='' WHERE a.c01=concat(dwid,'') and  b.c06 = concat(a.id,'')  AND a.c03='10372'; 

END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`lx_fund_audit`(in v_i_fund_month varchar(6),in v_unit_id varchar(50),
in v_unit_dataId int(11),inout resultMsg varchar(1000))
label_pro:	BEGIN
-- 审核通过后,更新年终奖,警察加班补贴,警察值勤补贴,艰边津补贴,一次性补扣发,补扣发相关的信息
declare stemNum int(11);
declare sTempNum int(11);
declare sTemRecordId int(11);
DECLARE staffId VARCHAR(30);
DECLARE chanType VARCHAR(30);
DECLARE chanSign VARCHAR(200);
declare stemP varchar(20);
declare stemFundMonth varchar(20); -- 基金月份 
DECLARE v_table VARCHAR(30);
DECLARE v_allowance_table VARCHAR(50);
declare sysDataBase varchar(20);-- 数据库名称

DECLARE done INT DEFAULT FALSE;
-- 所有生成基金补扣发的变动记录(待审核通过的)
DECLARE recordId_ CURSOR FOR
SELECT t126.id from data_record_t126 t126
		where 1=1 and t126.dataclassCode = 't126' and allAuditFlag='1' -- 待审核通过的数据
and t126.c01 = concat(v_unit_dataId,'') -- t125.c36 人员工资制度为 201 -公务员职级工资
and t126.fund_month = v_i_fund_month -- 变动记录的基金月份
and ( EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '2')-- t126.c03 人员状态-码表 1-在职
	or EXISTS (select 1 from data_record_t126 preT126,sys_s_data d where preT126.dataclassCode = 't126' 
	and preT126.dataId = t126.dataId -- and preT126.allAuditFlag = 2 
	and  d.id = preT126.c03 and d.data_value = '2' and preT126.id < t126.id 
	  ) -- 上一个月还是在职人员 这个月不在职,即做了人员减少
	or exists(select 1 from data_record_t126 preT126,sys_s_data d where preT126.dataclassCode = 't126' 
		and preT126.dataId = t126.dataId and ifnull(allAuditFlag,'')!='2' 
		and preT126.changeType = 10750
		and  d.id = preT126.c03 and d.data_value = '2' and preT126.id < t126.id 
	) -- 这个月做了新进人员后 直接又给此人做人员减少
)
and exists(select 1 from sys_s_data d where d.id = t126.c03 and d.typename = 'staffStatus' and d.data_value = '2')
-- 离休人员
;
DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;

	select ifnull(content,'smso') into sysDataBase from sys_s_config where enname = 'DATABASE_NAME';-- 数据库名称

	-- 其它一次性补扣发项目表
  select count(1) into stemNum from t119 where c20 = concat(v_i_fund_month,'') and c04=concat(v_unit_dataId,'')
  	and not exists(select 1 from t126,sys_s_data d where t126.id = t119.c01 and d.id = t126.c03 and d.typename = 'staffStatus' and d.data_value = '1')
	-- 离休人员
	;
	if stemNum > 0 then
		update t119 ,sys_s_data d set c21 = d.id where c20 = concat(v_i_fund_month,'') and c04=concat(v_unit_dataId,'')
		and d.typename = 'ybshzt' and d.data_value = '2' --  状态更新为 通过
		and not exists(select 1 from t126,sys_s_data e where t126.id = t119.c01 and e.id = t126.c03 and e.typename = 'staffStatus' and e.data_value = '1')
		-- 离休人员
		;
	end if;
	
	/*-- 一次性年终奖金管理表
	select count(1) into stemNum from t151 where c04 = concat(v_i_fund_month,'') and c01=concat(v_unit_dataId,'');
	if stemNum > 0 then
		update t151,sys_s_data d set c03 = d.id where c04 = concat(v_i_fund_month,'') and c01=concat(v_unit_dataId,'') 
		and d.typename = 'ybshzt' and d.data_value = '2';-- 状态更新为 通过
	end if;
	
	-- 警察加班补扣发表
	select count(1) into stemNum from t152 where c12 = concat(v_i_fund_month,'') and c01=concat(v_unit_dataId,'');
	if stemNum > 0 then
		update t152,sys_s_data d set c13 = d.id where c12 = concat(v_i_fund_month,'') and c01=concat(v_unit_dataId,'') 
		and d.typename = 'ybshzt' and d.data_value = '2';-- 状态更新为 通过
	end if;
	
	-- 警察值勤补扣发表
	select count(1) into stemNum from t153 where c14 = concat(v_i_fund_month,'') and c01=concat(v_unit_dataId,'');
	if stemNum > 0 then
		update t153,sys_s_data d set c17 = d.id where c14 = concat(v_i_fund_month,'') and c01=concat(v_unit_dataId,'') 
		and d.typename = 'ybshzt' and d.data_value = '2';-- 状态更新为 通过
	end if;
	
	-- 艰边津补贴扣扣发表
	select count(1) into stemNum from t164 where c11 = concat(v_i_fund_month,'') and c01=concat(v_unit_dataId,'');
	if stemNum > 0 then
		update t164,sys_s_data d set c10 = d.id where c11 = concat(v_i_fund_month,'') and c01=concat(v_unit_dataId,'') 
		and d.typename = 'ybshzt' and d.data_value = '2';-- 状态更新为 通过
	end if;*/
	
	-- 打开游标
  OPEN recordId_;  
  -- 开始循环
  read_loop: LOOP
    -- 提取游标里的数据，这里只有一个，多个的话也一样；
    FETCH recordId_ INTO sTemRecordId;
    -- 声明结束的时候
    IF done THEN
      LEAVE read_loop;
    END IF;
    -- 更新每条变动记录所涉及到的前几个月的补扣发情况表
    select count(1) into @lxNum
    	from data_record_t126 where dataclassCode = 't126' and id = sTemRecordId and c03 = '10372'; -- 离休人员

	if @lxNum > 0 then -- 如果存在离休人员
	    -- 更新每条变动记录所涉及到的前几个月的补扣发情况表
	    select changeType,changeSign,dataId into chanType ,chanSign,staffId 
	    	from data_record_t126 where id = sTemRecordId and c03 = '10372'; -- 离休人员

		select c02 into stemP from data_record_t125 
			where  changeType = chanType 
			and changeSign = chanSign;-- t125.c02 起薪时间 2016-01 
		
		update data_record_t126 set  allAuditFlag = '2' 
		where id = sTemRecordId and c03 = '10372';-- 更新变动记录对应的审核状态为通过
		update data_record_t125 a , data_record_t126 b 
		set a.allAuditFlag = '2' 
			where a.changeSign = b.changeSign 
			and b.id = sTemRecordId;-- 更新变动记录对应工资/津补贴的审核状态为通过
		update data_record_t117 a , data_record_t126 b 
		set a.allAuditFlag = '2' 
			where a.changeSign = b.changeSign 
			and b.id = sTemRecordId;-- 更新变动记录对应工资/津补贴的审核状态为通过
		/*
	select count(1) into @stemNum from data_data_record a join record_fill_tail b on a.id = b.change_id
	 where a.allAuditFlag = '2' and a.dataclassCode = 't126' and a.c01 = concat(v_unit_dataId,'')
	 and a.fund_month < v_i_fund_month ; -- 查询变动记录已经审核通过的数据
	if  @stemNum > 0 then
		delete from record_fill_tail c
	 	where 1=1 
	 	and exists(select 1 from data_data_record a join data_data_record b on a.changeSign = b.changeSign 
	 	and a.allAuditFlag = '2' and a.dataclassCode = 't126' and a.c01 = concat(v_unit_dataId,'')
	 	and c.change_id = a.id 
	 	and a.fund_month < v_i_fund_month ); -- 查询变动记录已经审核通过的数据
	end if;
	*/
	
		set stemP = replace(stemP,'-',''); -- 201601
		select PERIOD_DIFF(v_i_fund_month,stemP) into stemNum;-- 201610-201601
		set sTempNum = 0; 
		if stemNum>0 then -- 存在补扣发
			while sTempNum<=stemNum DO
				set stemFundMonth = DATE_FORMAT(DATE_ADD(concat(stemP,'01'),INTERVAL sTempNum MONTH),'%Y%m');
				set v_table = concat('fund_salary_pay','_',stemFundMonth);-- 对应月份 201607到v_i_fund_month之前相关的发放表的补扣发
				set v_allowance_table = concat('fund_salary_subsidies_pay','_',stemFundMonth); -- 对应月份201607到v_i_fund_month之前相关发放表-津补贴的补扣发
				select count(1) into @stempNum from information_schema.tables where table_schema = sysDataBase and TABLE_NAME = v_table;-- smso数据库里面对应的工资发放表信息
	
				if @stempNum < 1 then -- 判断是否已经存在v_i_fund_month(如201608)的工资发放表信息
					SET @sqlstr = CONCAT('CREATE TABLE ',v_table,' LIKE ', ' fund_salary_pay');
					PREPARE stmt FROM @sqlstr;
					EXECUTE stmt;
					DROP PREPARE stmt;
				end if;	
				
				SET @sqlstr = CONCAT('select count(1) into @stempNum from ',v_table,' a where a.staff_id=',staffId);
				PREPARE stmt FROM @sqlstr;
				EXECUTE stmt;
				DROP PREPARE stmt;
				
				if @stempNum < 1 then	
					-- 添加对应月份的基金发放表+后续补扣发
					SET @sqlstr = CONCAT('INSERT INTO ', v_table,' (status,fund_month,unit_id,unit_code,staff_id,staff_name,
							staff_eduLevel,staff_standing,staff_curPost,
							-- 学历			人员身份		现任职务
							staff_actual_workRank,staff_workRank,staff_isLeader,staff_postSalRank,staff_salRankLevel,
							-- 实际职务/技术等级	工资对应职级	是否领导工资	工资级别		工资档次
							zwgz_hx,gwgz_hx,
							-- 职务/技术等级工资-后续补扣发  级别岗位级别工资-后续补扣发 
							jshstg_hx,tsjytg_hx,
							-- 教师护士提高10%-后续补扣发  特殊教育提高15%-后续补扣发 
							bltggz_hx,jsblgz_hx,hsblgz_hx,
							-- 保留特岗工资-后续补扣发  中小学教师保留10%-后续补扣发  保留护士提高10%-后续补扣发 
							psxlj_hx,jxgz_hx,
							-- 平时训练奖-后续补扣发  基础绩效-后续补扣发 
							jbt_salary_hx,part_total_salary_hx,fill_salary_hx,theory_total_salary,
							-- 津补贴小计-后续补扣发 后续工资补扣发， 实际应发工资合计
							is_finSupt,is_salUniOut,department_name,
							-- 是否财政供养 是否财政统发 部门
							staff_wageSystem,staff_isUpten,staff_plusGrade,staff_downGrade,staff_plusLevel,staff_floatLevel,staff_fixLevel,staff_downLevel,
							-- 人员工资制度 是否提高10%工资  已含高定级别  已含低定级别		已含高定档次	已含浮动档次	已含固定档次	已含低定档次
							st_sal_date,en_sal_date,staff_status,staff_sex,staff_birth,staff_degree,staff_workYears,staff_from,staff_establish,
							-- 起薪时间 停薪时间	人员状态		性别		出生日期	学位		连续工龄	人员来源	人员编制
							staff_isChuFen,staff_salaryStandard,staff_isMainPart,staff_isStop,staff_partYears,staff_isMidTeacher,
							-- 是否处分		执行工资标准			是否主力		是否停薪		入队年限		是否中小学教师
							staff_isNurse,staff_fileNum,staff_titleRank,staff_isSpecialTeach,staff_salStandardDate
							-- 是否护士		根据文号		衔级			是否特殊教育		工资标准时间
							,staff_czbm,staff_sbid,staff_mz,staff_sfz,staff_bysj
							-- 财政编码 社保号 民族 身份证号 毕业时间
							,staff_jrbdwsj,staff_cjgzsj,staff_xrzwsj,staff_jdgl
							-- 进入本单位时间 参加工作时间 现任职务时间 间断工龄
							,staff_kjsgl,staff_wjsgl,staff_jbsj,staff_dcsj
							-- 工作前可计算工龄 未计算学习工龄 级别起考年份 档次起考年份
							,staff_gddc,staff_gdyj,staff_fddc,staff_fdyj
							-- 高定档次 高定依据 浮动档次 浮动依据 
							,staff_gudingdc,staff_gudingyj,staff_dddc,staff_ddyj
							-- 固定档次 固定依据 低定档次 低定原因
							,staff_gdjb,staff_gdjbyj,staff_ddjb,staff_ddjbyj
							-- 高定级别 高定级别依据 低定级别 低定级别依据 
							)
							select 2,',stemFundMonth,',',v_unit_dataId,',\'',v_unit_id,'\',t126.id,t126.c04,
								ifnull((select d.name from sys_s_data d where d.id = t126.c09),t126.c09),ifnull((select d.name from sys_s_data d where d.id = t126.c28),t126.c28),t126.c19,
							-- 学历			人员身份		现任职务
								ifnull((select d.name from sys_s_data d where d.id = t126.c36),t126.c36),(select t127.c05 from t127 where t127.id = t126.c17),
							-- 实际职务/技术等级	工资对应职级	
								(select t127.c04 from t127 where t127.id = t126.c27),(select t127.c05 from t127 where t127.id = t125.c07),(select t127.c04 from t127 where t127.id = t125.c09),
							-- 是否领导工资	工资级别		工资档次
								t125.c25,t125.c26,t125.c28,t125.c29,t125.c30,t125.c44,t125.c45,
							-- 职务/技术等级工资 级别岗位级别工资 教师护士提高10% 特殊教育提高15%  保留特岗工资 中小学教师保留10%工资	保留护士提高10%工资
								t125.c47,t125.c31,
							-- 平时训练奖			基础绩效
								t125.c27,t125.c32+0,t125.c32+0,t125.c32+0,
							-- 津补贴小计-后续补扣发  工资小计后续补扣发 后续工资补扣发， 实际应发工资合计
							ifnull((select d.name from sys_s_data d where d.id = t126.c24),t126.c24),ifnull((select d.name from sys_s_data d where d.id = t126.c22),t126.c22),(select c03 from t113 where id=t126.c15),
							-- 是否财政供养 是否财政统发 部门
							ifnull((select d.name from sys_s_data d where d.id = t125.c36),t125.c36),ifnull((select d.name from sys_s_data d where d.id = t125.c23),t125.c23)
							-- 人员工资制度 是否提高10%工资
							,t125.c11,t125.c13,t125.c15,t125.c17,t125.c19,t125.c21,
							--    已含高定级别  已含低定级别		已含高定档次	已含浮动档次	已含固定档次	已含低定档次
							t125.c02,t125.c38,ifnull((select d.name from sys_s_data d where d.id = t126.c03),t126.c03),
							-- 起薪时间 停薪时间	人员状态		
							ifnull((select d.name from sys_s_data d where d.id = t126.c05),t126.c05),t126.c08,ifnull((select d.name from sys_s_data d where d.id = t126.c10),t126.c10),
							-- 性别		出生日期	学位		
							t126.c14,ifnull((select d.name from sys_s_data d where d.id = t126.c16),t126.c16),ifnull((select d.name from sys_s_data d where d.id = t126.c21),t126.c21),
							-- 连续工龄	人员来源	人员编制
							ifnull((select d.name from sys_s_data d where d.id = t125.c39),t125.c39),ifnull((select d.name from sys_s_data d where d.id = t126.c39),t126.c39),
							-- 是否处分  执行工资标准/工资标准类别
							ifnull((select d.name from sys_s_data d where d.id = t126.c42),t126.c42),ifnull((select d.name from sys_s_data d where d.id = t126.c43),t126.c43),
							--   是否主力		是否停薪	
							t126.c45,ifnull((select d.name from sys_s_data d where d.id = t125.c01),t125.c01),
							--	入队年限		是否中小学教师
							ifnull((select d.name from sys_s_data d where d.id = t125.c03),t125.c03),t125.c04,
							-- 是否护士		根据文号		
							ifnull((select d.name from sys_s_data d where d.id = t125.c24),t125.c24),ifnull((select d.name from sys_s_data d where d.id = t125.c35),t125.c35),t125.c49
							-- 衔级			是否特殊教育		工资标准时间
							,t126.c23,t126.c25,t126.c06,t126.c07,t126.c11
							-- 财政编码 社保号 民族 身份证号 毕业时间
							,t126.c13,t126.c12,t126.c20,concat(t126.c34,\'.\',t126.c35)
							-- 进入本单位时间 参加工作时间 现任职务时间 间断工龄
							,concat(t126.c32,\'.\',t126.c33),concat(t126.c30,\'.\',t126.c31),t125.c08,t125.c10
							-- 工作前可计算工龄 未计算学习工龄 级别起考年份 档次起考年份
							,t125.c15,t125.c16,t125.c17,t125.c18
							-- 高定档次 高定依据 浮动档次 浮动依据 
							,t125.c19,t125.c20,t125.c21,t125.c22
							-- 固定档次 固定依据 低定档次 低定原因
							,t125.c11,t125.c12,t125.c13,t125.c14 -- ,t126.c41
							-- 高定级别 高定级别依据 低定级别 低定级别依据 变动时间
						from data_record_t126 t126 join data_record_t125 t125 on t126.dataId = t125.c06 and t126.changeSign = t125.changeSign
						left join fund_salary_fill_',v_i_fund_month,' c on t126.dataId = c.staff_id and t126.changeSign = c.changeSign
						where 1=1 and t126.c01 = \'',v_unit_dataId,'\'  and t126.changeType = \'10750\' -- 录入新进人员
						and t126.id = ',sTemRecordId,' and t126.c03 = \'10372\' and t125.c06 in (select id from t126 where t126.c01 = \'',v_unit_dataId,'\' and  t126.c03 = \'10372\')');
					PREPARE stmt FROM @sqlstr;
					EXECUTE stmt;
					DROP PREPARE stmt;
				else	
					-- 更新对应月份的补扣发
					SET @sqlstr = CONCAT('update ', v_table,' set   
						zwgz_hx=ifnull(zwgz_hx,0)+ifnull(zwgz_byyb,0)+0,
						-- 职务/技术等级工资-后续补扣发
						gwgz_hx=ifnull(gwgz_hx,0)+ifnull(gwgz_byyb,0)+0,
						-- 级别岗位级别工资-后续补扣发
						jshstg_hx=ifnull(jshstg_hx,0)+ifnull(jshstg_byyb,0)+0,
						-- 教师护士提高10%-后续补扣发
						tsjytg_hx=ifnull(tsjytg_hx,0)+ifnull(tsjytg_byyb,0)+0,
						-- 特殊教育提高15%-后续补扣发
						bltggz_hx=ifnull(bltggz_hx,0)+ifnull(bltggz_byyb,0)+0,
						-- 保留特岗工资-后续补扣发
						jsblgz_hx=ifnull(jsblgz_hx,0)+ifnull(jsblgz_byyb,0)+0,
						-- 中小学教师保留10%-后续补扣发
						hsblgz_hx=ifnull(hsblgz_hx,0)+ifnull(hsblgz_byyb,0)+0,
						-- 保留护士提高10%-后续补扣发
						psxlj_hx=ifnull(psxlj_hx,0)+ifnull(psxlj_byyb,0)+0,
						-- 平时训练奖-后续补扣发
						jxgz_hx=ifnull(jxgz_hx,0)+ifnull(jxgz_byyb,0)+0,
						-- 基础绩效-后续补扣发
						jbt_salary_hx=ifnull(jbt_salary_hx,0)+ifnull(jbt_salary_byyb,0)+0,
						-- 津补贴小计-后续补扣发
						part_total_salary_hx=ifnull(part_total_salary_hx,0)+ifnull(part_total_salary_byyb,0)+0,
						-- 工资小计-后续补扣发
						fill_salary_hx=ifnull(fill_salary_hx,0)+ifnull(total_salary_byyb,0)+0
						-- 工资合计-后续变动补扣发
						,status = 2
						 -- 状态通过
						where staff_id = ',staffId,'
					');
					PREPARE stmt FROM @sqlstr;
					EXECUTE stmt;
					DROP PREPARE stmt;	
					
					-- 更新实际应发工资 以及清空最新一次的补扣发金额，确定下一个月再做变动时，月结申报时数据是0
					SET @sqlstr = CONCAT('update ', v_table,' set   
						theory_total_salary = ifnull(total_salary,0)+ifnull(fill_salary_hx,0)+0,
						-- 实际应发工资 当月工资合计+后续工资补扣发
	
						-- 清空所有最新一次的补扣发金额,确保下一个月再做变动,月结申报时数据是0
						zwgz_byyb= 0,gwgz_byyb=0,
						-- 职务/技术等级工资	级别岗位级别工资
						jshstg_byyb = 0,tsjytg_byyb=0,bltggz_byyb = 0,
						--  教师护士提高 特殊教育提高 保留特岗工资
						jsblgz_byyb=0, hsblgz_byyb = 0,
						-- 中小学教师保留  保留护士提高
						psxlj_byyb=0, jxgz_byyb = 0,
						-- 平时训练奖 绩效工资
						jbt_salary_byyb=0,part_total_salary_byyb = 0,total_salary_byyb=0
						-- 津补贴 	 小计 合计
						,status = 2
						-- 状态更新为2
						where staff_id = ',staffId,'
					');
					PREPARE stmt FROM @sqlstr;
					EXECUTE stmt;
					DROP PREPARE stmt;	
					
					-- 更新实际应发工资 以及清空最新一次的补扣发金额，确定下一个月再做变动时，月结申报时数据是0
					SET @sqlstr = CONCAT('update ', v_table,' set   
						theory_total_salary = ifnull(total_salary,0)+ifnull(fill_salary_hx,0)+0,
						-- 实际应发工资 当月工资合计+后续工资补扣发
	
						-- 清空所有最新一次的补扣发金额,确保下一个月再做变动,月结申报时数据是0
						zwgz_byyb= 0,gwgz_byyb=0,
						-- 职务/技术等级工资	级别岗位级别工资
						jshstg_byyb = 0,tsjytg_byyb=0,bltggz_byyb = 0,
						--  教师护士提高 特殊教育提高 保留特岗工资
						jsblgz_byyb=0, hsblgz_byyb = 0,
						-- 中小学教师保留  保留护士提高
						psxlj_byyb=0, jxgz_byyb = 0,
						-- 平时训练奖 绩效工资
						jbt_salary_byyb=0,part_total_salary_byyb = 0,total_salary_byyb=0
						-- 津补贴 	 小计 合计
						,status = 2 -- 状态2-通过
						where staff_id = ',staffId,'
					');
					PREPARE stmt FROM @sqlstr;
					EXECUTE stmt;
					DROP PREPARE stmt;	
				end if;
				
				select count(1) into @stempNum from information_schema.tables where table_schema = sysDataBase and TABLE_NAME = v_allowance_table;-- smso数据库里面对应的工资发放表信息
				if @stempNum < 1 then 
					SET @sqlstr = CONCAT('CREATE TABLE ',v_allowance_table,' LIKE ', ' fund_salary_subsidies_pay');
					PREPARE stmt FROM @sqlstr;
					EXECUTE stmt;
					DROP PREPARE stmt;
				end if;
				
				SET @sqlstr = CONCAT('select count(1) into @stempNum from ',v_allowance_table,' a where a.staff_id=',staffId);
				PREPARE stmt FROM @sqlstr;
				EXECUTE stmt;
				DROP PREPARE stmt;
				if @stempNum < 1 then 
					-- 更新发放表-津补贴 后续补扣发金额 以及清空最新一次的补扣发金额，确定下一个月再做变动时，月结申报时数据是0
					SET @sqlstr = CONCAT('insert into  ', v_allowance_table,' set   
						salary_hx_bf = ifnull(salary_hx_bf,0)+ifnull(salary_byyb,0)+0,
						-- 后续补扣金额 =之前后续金额+最新一次的金额
	
						-- 清空所有最新一次的补扣发金额,确保下一个月再做变动,月结申报时数据是0
						salary_byyb= 0
						where staff_id = ',staffId,'
					');
	
				SET @sqlstr = CONCAT('INSERT INTO ', v_allowance_table,'(status,fund_month,unit_id,unit_code,staff_id,
						allowance_id,allowance_title,salary_hx_bf/**,staff_salStandardDate*/)
						-- 津补贴id 		津补贴名称 	 津补贴金额  津补贴当月实际补发 津补贴后续补发  津补贴标准时间
					select 2,',stemFundMonth,',',v_unit_dataId,',\'',v_unit_id,'\',t117.c03,t117.c04,t116.c03,t117.c07/**,ifnull(t117.c01,DATE_FORMAT(ifnull(t117.updateDate,t117.createDate),\'%Y-%m-%d\'))*/
							-- 基金月分 	   单位代码(51036000) 人员id 津补贴id  津补贴名称 津补贴金额 津补贴当月实际补发 津补贴后续补发  津补贴标准时间
					from data_record_t117 t117 ,t116,data_record_t126 t126
					where 1=1 and t117.dataclassCode = \'t117\' and t117.changeSign = t126.changeSign 
					and t126.id = ',sTemRecordId,'
					and t117.c02 = \'',v_unit_dataId,'\' and t117.c04 = t116.id  and t117.c03 = t126.dataId and t126.c03 = \'10372\' and t117.c03 in (select id from t126 where t126.c01 = \'',v_unit_dataId,'\' and  t126.c03 = \'10372\')');
					PREPARE stmt FROM @sqlstr;
					EXECUTE stmt;
					DROP PREPARE stmt;
				else
					-- 更新发放表-津补贴 后续补扣发金额 以及清空最新一次的补扣发金额，确定下一个月再做变动时，月结申报时数据是0
					SET @sqlstr = CONCAT('update ', v_allowance_table,' set   
						salary_hx_bf = ifnull(salary_hx_bf,0)+ifnull(salary_byyb,0)+0,
						-- 后续补扣金额 =之前后续金额+最新一次的金额
	
						-- 清空所有最新一次的补扣发金额,确保下一个月再做变动,月结申报时数据是0
						salary_byyb= 0
						,status = 2 -- 状态为2
						where staff_id = ',staffId,'
					');
					PREPARE stmt FROM @sqlstr;
					EXECUTE stmt;
					DROP PREPARE stmt;	
				end if;
				set sTempNum = sTempNum+1;
			end while;
		end if;
	end if;
	
  END LOOP;
  -- 关闭游标
  CLOSE recordId_;
  
  -- 审核完成后 删除前2个月的record_fill_tail以及record_fill_subsidies表
	set @m = concat(v_i_fund_month,'01');
	select DATE_FORMAT(DATE_SUB(@m,INTERVAL 1 MONTH),'%Y%m') into @stemMonth;
	
	/*delete from record_fill_tail 
	where change_id in(select id from data_data_record t126 where t126.dataclassCode = 't126'
	and  t126.c01 = v_unit_dataId and fund_month < @stemMonth);*/
	delete c from record_fill_tail c ,
	(select id from data_record_t126 t126 where t126.dataclassCode = 't126'
	and  t126.c01 = concat(v_unit_dataId,'') and fund_month < @stemMonth and t126.c03 = '10372') d where d.id = c.change_id;
	commit;
	/*delete from record_fill_subsidies 
	where change_id in(select id from data_data_record t117 where t117.dataclassCode = 't117'
	and  t117.c02 = v_unit_dataId and fund_month < @stemMonth);*/
	delete c from record_fill_subsidies c,
	(select id from data_record_t117 t117 where t117.dataclassCode = 't117'
	and  t117.c02 = 120 and fund_month < 201709 and t117.c03 in (select id from t126 where t126.c01 = concat(v_unit_dataId,'') and  t126.c03 = '10372')) d where c.change_id = d.id;
	commit;
	/*delete from record_fill_tail where change_id not in 
		(select id from data_data_record where dataclassCode = 't126');-- 删除变动补扣发表在变动记录不存在 的change_id*/
		delete c from record_fill_tail c, 
		(select id from data_record_t126 t126 where dataclassCode = 't126' and t126.c03 = '10372') d where c.change_id = d.id;
	/*delete from record_fill_subsidies where change_id not in 
		(select id from data_data_record where dataclassCode = 't117');-- 删除变动补扣发表在变动记录不存在 的change_id */
		delete c from record_fill_subsidies c ,
		(select id from data_record_t117 t117 where dataclassCode = 't117' and t117.c03 in (select id from t126 where t126.c01 = concat(v_unit_dataId,'') and  t126.c03 = '10372')) d where c.change_id = d.id;
  	commit;
 COMMIT;

END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`monthfillCount`(IN v_unit_dataId int(11),IN changeId int(11),IN staffId int(11),IN chaSign varchar(100),
IN qxYearMonth varchar(6),
			INOUT subZwgz double,-- 当前变动与起薪时间的职务工资差
			INOUT subGwgz double,-- 当前变动与起薪时间的级别/岗位工资差
			INOUT subJhtg double,-- 当前变动与起薪时间的教师护士提高10%
			INOUT subTjtg double,-- 当前变动与起薪时间的特殊教育提高15%
			INOUT subBltg double,-- 当前变动与起薪时间的保留特岗工资
			INOUT subBljs double,-- 当前变动与起薪时间的保留教师10%
			INOUT subBlhs double,-- 当前变动与起薪时间的保留护士10%
			INOUT subPsxlj double,-- 当前变动与起薪时间的平时训练奖
			INOUT subJcjx double,-- 当前变动与起薪时间的基础绩效
			INOUT subJbt double,-- 当前变动与起薪时间的津补贴
			INOUT subGz double,-- 当前变动与起薪时间的工资小计差
			INOUT resultMsg  varchar(10000) CHARSET utf8)
label_pro:BEGIN	
			-- changeId 变动记录id 主要是t126的变动记录id,此id来查询所有关联的工资t125,津贴t117 变动记录
			
			DECLARE staffNo varchar(100);-- 人员编号
			DECLARE salaryRecordId varchar(100);-- 工资信息的recordId
			DECLARE jjyf varchar(100);-- 变动生效月份 基金月份 201606
			DECLARE changeTypeCode varchar(100);-- 变动类型code
			DECLARE qxsj varchar(100);-- 起薪时间
			DECLARE bdsj varchar(100);-- 变动时间
			DECLARE zwgz varchar(100);-- 职务工资
			DECLARE gwgz varchar(100);-- 岗位工资
			DECLARE jhtg varchar(100) DEFAULT 0;-- 教师护士提高10%
			DECLARE tjtg varchar(100) DEFAULT 0;-- 特殊教育提高15%
			DECLARE bltg varchar(100) DEFAULT 0;-- 保留特岗工资
			DECLARE bljs varchar(100) DEFAULT 0;-- 保留教师10%
			DECLARE blhs varchar(100) DEFAULT 0;-- 保留护士10%
			DECLARE psxlj varchar(100) DEFAULT 0;-- 平时训练奖
			DECLARE jcjx varchar(100) DEFAULT 0;-- 基础绩效
			DECLARE jbt varchar(100);-- 津补贴
			DECLARE gzxj varchar(100);-- 当月基本工资小计 
			DECLARE rysf varchar(100);-- 人员身份 jg-机关 sy-事业

			DECLARE preId int(11);-- 当前变动 起薪时间对应的t126的变动id
			DECLARE preZwgz varchar(100) DEFAULT 0;-- 当前变动 起薪时间对应的t125的职务工资
			DECLARE preGwgz varchar(100) DEFAULT 0;-- 当前变动 起薪时间对应的t125的级别工资/岗位工资
			DECLARE preJhtg varchar(100) DEFAULT 0;-- 当前变动 起薪时间对应的t125的教师护士提高10%
			DECLARE preTjtg varchar(100) DEFAULT 0;-- 当前变动 起薪时间对应的t125的特殊教育提高15%
			DECLARE preBltg varchar(100) DEFAULT 0;-- 当前变动 起薪时间对应的t125的保留特岗工资
			DECLARE preBljs varchar(100) DEFAULT 0;-- 当前变动 起薪时间对应的t125的保留教师10%
			DECLARE preBlhs varchar(100) DEFAULT 0;-- 当前变动 起薪时间对应的t125的保留护士10%
			DECLARE prePsxlj varchar(100) DEFAULT 0;-- 当前变动 起薪时间对应的t125的平时训练奖
			DECLARE preJcjx varchar(100) DEFAULT 0;-- 当前变动 起薪时间对应的t125的基础津贴
			DECLARE preJbt varchar(100) DEFAULT 0;-- 当前变动 起薪时间对应的t125的津补贴
			DECLARE preHxbkf varchar(100) DEFAULT 0;-- 当前变动 起薪时间对应的后续补扣发
			DECLARE preYfgzxj varchar(100) DEFAULT 0;-- 当前变动 起薪时间对应的 上次应发工资合计 除开当月实际补扣发 不算本次操作的补扣发金额(基本工资小计+后续补扣发)
			DECLARE preYfGzhj varchar(100) DEFAULT 0;-- 当前变动 起薪时间对应的t125的应发工资合计(不算当月实际补扣发)(基本工资小计+后续补扣发+本次操作的补扣发金额)
			DECLARE preChangeSign varchar(100);-- 当前变动 起薪时间对应的t125的工资合计
			-- DECLARE preXj double;-- 当前变动 起薪时间对应的t125的小计 除开[津补贴,一次性补扣发(加班值勤,年终一次奖金,其它一次性补扣发)]
			DECLARE preBkf varchar(100) DEFAULT 0;-- 当前变动 起薪时间对应的 补扣发
			DECLARE preGz varchar(100) DEFAULT 0;-- 当前变动 起薪时间对应的 工资(级别工资+岗位工资+其它工资项+津补贴)[不计补扣款]


			DECLARE monthCount int(11);-- 当前变动 起薪时间对应的 工资发放表数量 如果 <1 则表示没有生成 发放表
			
			-- t125 人员工资信息表 c02-起薪时间 c25-职务/职级工资 c26-级别/岗位工资 c27-津补贴合计 c32-工资合计/工资小计 除开补扣款
					-- c28-教师护士提高10% c29-特殊教育提高15% c30-保留特岗工资 c44-中小学教师保留10%工资 c45-保留护士提高10%工资 c47-平时训练奖 c31-基础绩效
			select c25,c26,c27,c32,c28,c29,c30,c44,c45,c47,c31
			into zwgz,gwgz,jbt,gzxj,jhtg,tjtg,bltg,bljs,blhs,psxlj,jcjx
			from data_record_t125 where changeSign = chaSign ;-- and dataclassCode = 't125';
			set resultMsg = '';
			
			SET @sqlstr = CONCAT('select count(1) into @monthCount from fund_salary_pay_',qxYearMonth, ' where unit_id =  \'',v_unit_dataId,'\' and   staff_id = \'',staffId,'\' ');				
			PREPARE stmt FROM @sqlstr;
			EXECUTE stmt;
			DROP PREPARE stmt;
			set monthCount = @monthCount;
			-- select count(1) into monthCount from fund_salary_fill where fund_month = qxYearMonth and staff_id = staffId;
			if monthCount > 0 then -- 存在起薪时间的基金月分补扣发表
				/* select zwgz+zwgz_yf,gwgz+gwgz_yf,jshstg+jshstg_yf,tsjytg+tsjytg_yf,bltggz+bltggz_yf,jsblgz+jsblgz_yf,hsblgz+hsblgz_yf,psxlj+psxlj_yf,
				jxgz+jxgz_yf,
				total_salary_bf,-- 实际发放工资补扣发合计
				part_total_salary+part_total_salary_yf,--  实际发放工资小计+后续工资小计
				part_total_salary+part_total_salary_yf,--  应发工资小计
				part_total_salary+total_salary_yf,-- 实际发放工资小计+后续工资合计
				total_salary_yf -- 后续工资补扣款合计
				into preZwgz,preGwgz,preJhtg,preTjtg,preBltg,preBljs,preBlhs,prePsxlj,preJcjx,
				preBkf,preGz,preYfgzxj,preYfGzhj ,preHxbkf
				from fund_salary_fill -- 工资发放补扣款表
				where fund_month = qxYearMonth 
				and staff_id = staffId;-- 机关基金发放表
				*/
				SET @sqlstr = CONCAT('select ifnull(staff_jobSal,0)+ifnull(zwgz_hx,0)+ifnull(zwgz_byyb,0),ifnull(staff_levelSal,0)+ifnull(gwgz_hx,0)+ifnull(gwgz_byyb,0),
					-- 职务工资+职务工资后续补扣发+职务工资目前本月应补     岗位工资+岗位工资后续补扣发+岗位工资目前本月应补
				ifnull(staff_teacherNurseUpTen,0)+ifnull(jshstg_hx,0)+ifnull(jshstg_byyb,0),ifnull(staff_specialTeachFifteen,0)+ifnull(tsjytg_hx,0)+ifnull(tsjytg_byyb,0),
				-- 教师护士提高10%                                 特殊教育提高15%
				ifnull(staff_keepSpecialStationSal,0)+ifnull(bltggz_hx,0)+ifnull(bltggz_byyb,0),
				-- 保留特岗工资				
				ifnull(staff_midTeacherKeeyTen,0)+ifnull(jsblgz_hx,0)+ifnull(jsblgz_byyb,0),ifnull(staff_keepNurseUpTen,0)+ifnull(hsblgz_hx,0)+ifnull(hsblgz_byyb,0),
				-- 中小学教师保留10%                                      保留护士提高10%
				ifnull(staff_peacetimeAward,0)+ifnull(psxlj_hx,0)+ifnull(psxlj_byyb,0),
				-- 平时训练奖
				ifnull(staff_basicPerfor,0)+ifnull(jxgz_hx,0)+ifnull(jxgz_byyb,0),
				-- 基础绩效
				ifnull(jbt_total_salary,0)+ifnull(jbt_salary_hx,0)+ifnull(jbt_salary_byyb,0),
				-- 津补贴小计
				ifnull(part_total_salary,0)+ifnull(part_total_salary_hx,0)+ifnull(part_total_salary_byyb,0),-- 实际发放工资小计(基本工资+津补贴/除开补扣发的)+后续工资小计+本月应补
				ifnull(salary_value,0), -- 工资当月实际发放补扣款
				ifnull(part_total_salary,0)+ifnull(part_total_salary_hx,0)+ifnull(part_total_salary_byyb,0),-- 实际发放工资小计(基本工资+津补贴/除开补扣发的)+后续工资小计+本月应补
				ifnull(total_salary,0)+ifnull(fill_salary_hx,0)+ifnull(total_salary_byyb,0),-- 实际发放工资合计+后续补扣发+本月应补
				ifnull(fill_salary_hx,0)+ifnull(total_salary_byyb,0) -- 后续工资补扣款合计+本月应补
				into @preZwgz,@preGwgz,@preJhtg,@preTjtg,@preBltg,@preBljs,@preBlhs,@prePsxlj,@preJcjx,
				@preJbt,
				@preGz,@preBkf,@preYfgzxj,@preYfGzhj ,@preHxbkf
				from fund_salary_pay_',qxYearMonth,'
				where  unit_id = \'',v_unit_dataId,'\'
				and staff_id = \'',staffId,'\'' );
				-- 机关基金发放表
				PREPARE stmt FROM @sqlstr;
				EXECUTE stmt;
				DROP PREPARE stmt;
				
			else -- 不存在起薪时间的基金月份补扣发表
				/* select staff_jobSal,staff_levelSal,
				-- 职务/技术等级工资 级别岗位级别工资
				staff_teacherNurseUpTen,staff_specialTeachFifteen,
				-- 教师护士提高10% 	特殊教育提高15%
				staff_keepSpecialStationSal,staff_midTeacherKeeyTen,staff_keepNurseUpTen,
				-- 保留特岗工资		中小学教师保留10%	保留护士提高10%
				staff_peacetimeAward,staff_basicPerfor,
				-- 平时训练奖		基础绩效
				jbt_total_salary,actual_total_salary,salary_value,theory_total_salary
				-- 津补贴小计	实发工资合计		工资补扣发		实际应发工资合计	
				into preZwgz,preGwgz,
				preJhtg,preTjtg,
				preBltg,preBljs,preBlhs,
				prePsxlj,preJcjx,
				preJbt,preGz,preBkf,preYfGzhj
				from fund_salary_pay 
				where fund_month = qxYearMonth 
				and staff_id = staffId;-- 机关基金发放表
				*/	

				SET @sqlstr = CONCAT('select ifnull(staff_jobSal,0),ifnull(staff_levelSal,0),
				-- 职务/技术等级工资 级别岗位级别工资
				ifnull(staff_teacherNurseUpTen,0),ifnull(staff_specialTeachFifteen,0),
				-- 教师护士提高10% 	特殊教育提高15%
				ifnull(staff_keepSpecialStationSal,0),ifnull(staff_midTeacherKeeyTen,0),ifnull(staff_keepNurseUpTen,0),
				-- 保留特岗工资		中小学教师保留10%	保留护士提高10%
				ifnull(staff_peacetimeAward,0),ifnull(staff_basicPerfor,0),
				-- 平时训练奖		基础绩效
				ifnull(jbt_total_salary,0),ifnull(actual_total_salary,0),ifnull(salary_value,0),ifnull(theory_total_salary,0)
				-- 津补贴小计	实发工资合计		工资补扣发		实际应发工资合计	
				into @preZwgz,@preGwgz,
				@preJhtg,@preTjtg,
				@preBltg,@preBljs,@preBlhs,
				@prePsxlj,@preJcjx,
				@preJbt,@preGz,@preBkf,@preYfGzhj
				from fund_salary_pay_',qxYearMonth,'
				where  unit_id = \'',v_unit_dataId,'\'
				and staff_id = \'',staffId,'\'' );
				-- 机关基金发放表
				PREPARE stmt FROM @sqlstr;
				EXECUTE stmt;
				DROP PREPARE stmt;
							
			end if;
			set preZwgz = @preZwgz;
			set preGwgz = @preGwgz;
			set preJhtg = @preJhtg;
			set preTjtg = @preTjtg;
			set preBltg = @preBltg;
			set preBljs = @preBljs;
			set preBlhs = @preBlhs;
			set prePsxlj = @prePsxlj;
			set preJcjx = @preJcjx;
			set preJbt = @preJbt;
			set preGz = @preGz;
			set preBkf = @preBkf;
			set preYfgzxj = @preYfgzxj;
			set preYfGzhj = @preYfGzhj;
			set preHxbkf = @preHxbkf;
			
			SET subZwgz = ifnull(zwgz,0)-ifnull(preZwgz,0) ;-- 当前变动与起薪时间的职务工资差
			SET subGwgz = ifnull(gwgz,0)-ifnull(preGwgz,0) ;-- 当前变动与起薪时间的级别/岗位工资差
			SET subJbt = ifnull(jbt,0)-ifnull(preJbt,0) ;-- 当前变动与起薪时间的津补贴差
			SET subJhtg =ifnull(jhtg,0) - ifnull(preJhtg,0) ;-- 当前变动与起薪时间的教师护士提高10%
			SET subTjtg = ifnull(tjtg,0) -ifnull(preTjtg,0) ;-- 当前变动与起薪时间的特殊教育提高15%
			SET subBltg = ifnull(bltg,0) - ifnull(preBltg,0) ;-- 当前变动与起薪时间的保留特岗工资
			SET subBljs = ifnull(bljs,0) - ifnull(preBljs,0) ;-- 当前变动与起薪时间的保留教师10%
			SET subBlhs = ifnull(blhs,0) - ifnull(preBlhs,0) ;-- 当前变动与起薪时间的保留护士10%
			SET subPsxlj = ifnull(psxlj,0) - ifnull(prePsxlj,0) ;-- 当前变动与起薪时间的平时训练奖
			SET subJcjx = ifnull(jcjx,0) - ifnull(preJcjx,0) ;-- 当前变动与起薪时间的基础绩效
			SET subJbt = ifnull(jbt,0)-ifnull(preJbt,0) ;-- 当前变动与起薪时间的津补贴差
			SET subGz = ifnull(gzxj,0) - ifnull(preGz,0) ;-- 当前变动与起薪时间的工资小计差 


			
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`mywf`(IN a1 INT)
BEGIN
DECLARE b1 INT;
SET b1=a1+1;
IF b1=0 THEN
UPDATE t126 SET c01='6' WHERE id=1;
END IF;

END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`NewProc`(in personId varchar(100),
	INOUT jbtxj int(11),
-- 津补贴 小计
	in zwgz varchar(10),
-- 职务工资
	in jbgz int(11),
-- 级别工资
	inout resultMsg varchar(1000))
BEGIN
	DECLARE jbtId int(11);
	DECLARE zxgs varchar(100);-- t117执行公式
	DECLARE zxje varchar(11);-- t117执行金额
	declare stemIndex int(11);

  DECLARE done INT DEFAULT FALSE;
	DECLARE zxgsje int(11) DEFAULT 0;
	-- t117 执行公式*t117执行金额
	DECLARE jbtId_ CURSOR FOR select id from t117  
	where c03 = personId and ifnull(c07,'')>0  and position('%' in c01 ) >0;
	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
	
	set stemIndex = 0;
	-- 打开游标
	OPEN jbtId_;
	-- 开始循环
	read_loop1:LOOP
	-- 提取游标里的数据
	FETCH jbtId_ INTO jbtId;
	-- 声明结束的时候
	IF done THEN
		LEAVE read_loop1;
	END IF;
		select replace(c01,'%','') , c07 into zxgs,zxje from t117 where id = jbtId;
		update t117 set c07 = round((ifnull(zwgz,0) +ifnull(jbgz,0))*zxgs*0.01) where id = jbtId ; 
		set stemIndex = stemIndex + 1;
	END LOOP;
	CLOSE jbtId_;
	 
	if stemIndex > 0 then 
		select sum(ifnull(c07,0)) into jbtxj from t117 where c03 = personId;
	end if;
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`no_record_fund`(in v_i_fund_month varchar(6),in v_unit_id varchar(50),
in v_unit_dataId int(11),inout resultMsg varchar(10000))
label_pro:BEGIN
/*没有变动记录时生成基金数据*/
/*基金生成-标记本次基金的变动数据(只能当月生成下个月的基金) data_data_record 变动记录表; --v_i_fund_month 基金月份传入参数;--v_unit_id 基金单位代码传入参数--v_unit_dataId 基金单位id*/
declare stemMonthNum int(11);
declare stemNum int(11);
declare stemIndex int(11);
declare stemParam varchar(20);
declare stemP varchar(20);
declare stemFundMonth varchar(20); -- 参数年月 
declare nowMonth varchar(20); -- 参数年月 
declare sysDataBase varchar(20);-- 数据库名称

DECLARE v_table VARCHAR(50);
DECLARE v_table_pre VARCHAR(50);

DECLARE v_allowance_table VARCHAR(50);
DECLARE v_allowance_table_pre VARCHAR(50);

DECLARE t_error INTEGER DEFAULT 0;
DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET t_error=1;

START TRANSACTION;
/*fund_audit_record基金审核表处理*/
/*数据插入 
--fund_month基金月份
--unit_id单位代码
--fund_status  基金状态 0未上报/1待审核/2通过/3未通过
--firstFlag 1审核人审核状态 0未上报/1已上报/2通过/3未通过
--secondFlag 2审核人审核状态 0未上报/1已上报/2通过/3未通过
--thirdFlag 3审核人审核状态 0未上报/1已上报/2通过/3未通过
--forthFlag 4审核人审核状态 0未上报/1已上报/2通过/3未通过
--fiveFlag 5审核人审核状态 0未上报/1已上报/2通过/3未通过
--sixFlag 6审核人审核状态 0未上报/1已上报/2通过/3未通过
--auditMsg 审核意见
*/


	if resultMsg = '' or length(resultMsg)<1 then 
		set @rs = '沿用基金';
	else	
		set @rs = resultMsg;
	end if;	
	select @rs;
	set resultMsg = '';
	set @commitPerson = '';-- 单位申报人，初始为‘’，下面查询时根据实际情况 查
	select content into sysDataBase from sys_s_config where enname = 'DATABASE_NAME';-- 数据库名称
	select fund_month,commitPerson  into stemParam,@commitPerson from  fund_audit_record where unit_id = concat(v_unit_dataId,'') and fund_month < v_i_fund_month and fund_status = '2'
	order by fund_month desc limit 0,1;-- stemParam 已经存在的审核通过的 基金月份
	if stemParam is null or stemParam = '' then
		leave label_pro; 
	end if;
	set stemFundMonth = stemParam;
	select PERIOD_DIFF(v_i_fund_month,stemParam) into stemMonthNum  ;-- 201612 201611 \
	select DATE_FORMAT(DATE_ADD(SYSDATE(),INTERVAL 1 MONTH),'%Y%m') into nowMonth  ;-- 当前日期

	set stemIndex = 0;
		
	-- set resultMsg = concat('v_unit_dataId:',v_unit_dataId,',v_i_fund_month:',v_i_fund_month,',stemParam:',stemParam,',stemMonthNum:',stemMonthNum);leave label_pro;
	if stemMonthNum > 0 then 
		while stemIndex<stemMonthNum do
			-- stemMonthNum = 201612-201611 = 1
			set stemIndex = stemIndex + 1;
			set stemParam = stemFundMonth;-- 循环存放上一个月份
			select DATE_FORMAT(DATE_ADD(concat(stemParam,'01'),INTERVAL 1 MONTH),'%Y%m') into stemFundMonth;-- 201612 每遍历一次，月分加一月	
			if stemFundMonth > nowMonth then 
					-- set resultMsg = concat('stemMonthNum:',stemMonthNum,',stemFundMonth:',stemFundMonth,',nowMonth:',nowMonth);
				leave label_pro;
			end if;
			-- set resultMsg = concat('stemFundMonth:',stemFundMonth);leave label_pro;
			select count(1) into stemP from fund_audit_record where unit_id = concat(v_unit_dataId,'') and fund_month = stemFundMonth and fund_status = 2 ;
			-- if stemP = 0 then
				 delete from fund_audit_record where unit_id = concat(v_unit_dataId,'') and fund_month = stemFundMonth;
				-- 插入 月分 根据循环 分别是 201606 201607 
				set @deleteVTable = concat('fund_salary_fill_',stemFundMonth);
				select count(1) into stemNum from information_schema.tables where table_schema = sysDataBase and TABLE_NAME = @deleteVTable;-- smso数据库里面对应的工资发放表信息
				if stemNum > 0 then 
					SET @sqlstr = CONCAT('delete from ',@deleteVTable,' where unit_id = \'',v_unit_dataId,'\'');
					PREPARE stmt FROM @sqlstr;
					EXECUTE stmt;
					DROP PREPARE stmt;
				end if;
				set @deleteVTable = concat('fund_salary_fill_subsidies_',stemFundMonth);
				select count(1) into stemNum from information_schema.tables where table_schema = sysDataBase and TABLE_NAME = @deleteVTable;-- smso数据库里面对应的工资发放表信息
				if stemNum > 0 then 
					SET @sqlstr = CONCAT('delete from ',@deleteVTable,' where unit_id = \'',v_unit_dataId,'\'');
					PREPARE stmt FROM @sqlstr;
					EXECUTE stmt;
					DROP PREPARE stmt;
				end if;
				set @deleteVTable = concat('fund_change_detail_',stemFundMonth);
				select count(1) into stemNum from information_schema.tables where table_schema = sysDataBase and TABLE_NAME = @deleteVTable;-- smso数据库里面对应的工资发放表信息
				if stemNum > 0 then 
					SET @sqlstr = CONCAT('delete from ',@deleteVTable,' where unit_id = \'',v_unit_dataId,'\'');
					PREPARE stmt FROM @sqlstr;
					EXECUTE stmt;
					DROP PREPARE stmt;
				end if;
				set @deleteVTable = concat('fund_change_subsidies_',stemFundMonth);
				select count(1) into stemNum from information_schema.tables where table_schema = sysDataBase and TABLE_NAME = @deleteVTable;-- smso数据库里面对应的工资发放表信息
				if stemNum > 0 then 
					SET @sqlstr = CONCAT('delete from ',@deleteVTable,' where unit_id = \'',v_unit_dataId,'\'');
					PREPARE stmt FROM @sqlstr;
					EXECUTE stmt;
					DROP PREPARE stmt;
				end if;
				set @deleteVTable = concat('fund_salary_pay_',stemFundMonth);
				select count(1) into stemNum from information_schema.tables where table_schema = sysDataBase and TABLE_NAME = @deleteVTable;-- smso数据库里面对应的工资发放表信息
				if stemNum > 0 then 
					SET @sqlstr = CONCAT('delete from ',@deleteVTable,' where unit_id = \'',v_unit_dataId,'\'');
					PREPARE stmt FROM @sqlstr;
					EXECUTE stmt;
					DROP PREPARE stmt;
				end if;
				set @deleteVTable = concat('fund_salary_subsidies_pay_',stemFundMonth);
				select count(1) into stemNum from information_schema.tables where table_schema = sysDataBase and TABLE_NAME = @deleteVTable;-- smso数据库里面对应的工资发放表信息
				if stemNum > 0 then 
					SET @sqlstr = CONCAT('delete from ',@deleteVTable,' where unit_id = \'',v_unit_dataId,'\'');
					PREPARE stmt FROM @sqlstr;
					EXECUTE stmt;
					DROP PREPARE stmt;
				end if;
				
				
				select c13 into stemP from t111 where id  = v_unit_dataId; -- t111单位基本信息表 c13 执行工资制度
				select data_value into stemP from sys_s_data where id = stemP and typename = 'wageScheme'; -- 0-机关 1-事业 2-机关事业并存
		-- 插入基金发放发
				SET v_table =  CONCAT('fund_salary_pay_',stemFundMonth);/*处理分表存储*/
				SET v_table_pre =  CONCAT('fund_salary_pay_',stemParam);-- 已经存在的 月结数据

				SET v_allowance_table =  CONCAT('fund_salary_subsidies_pay_',stemFundMonth);/*处理分表存储*/
				SET v_allowance_table_pre =  CONCAT('fund_salary_subsidies_pay_',stemParam);-- 已经存在的 月结数据
	
				select count(1) into stemNum from information_schema.tables where table_schema = sysDataBase and TABLE_NAME = v_table;-- smso数据库里面对应的工资发放表信息
				if stemNum = 0 then -- 判断是否已经存在v_i_fund_month(如201608)的工资发放表信息
					SET @sqlstr = CONCAT('CREATE TABLE ',v_table,' LIKE ', ' fund_salary_pay');
					PREPARE stmt FROM @sqlstr;
					EXECUTE stmt;
					DROP PREPARE stmt;
				else
					SET @sqlstr = CONCAT('delete from ',v_table,' where unit_id = \'',v_unit_dataId,'\' and fund_month = ',stemFundMonth);
					PREPARE stmt FROM @sqlstr;
					EXECUTE stmt; -- 删除已经存在 的本单位当月发放表数据
					DROP PREPARE stmt;
				end if;
	
				select count(1) into stemNum from information_schema.tables where table_schema = sysDataBase and TABLE_NAME = v_allowance_table;-- smso数据库里面对应的工资发放表信息
				if stemNum = 0 then -- 判断是否已经存在v_i_fund_month(如201608)的工资发放津补贴表信息
					SET @sqlstr = CONCAT('CREATE TABLE ',v_allowance_table,' LIKE ', ' fund_salary_subsidies_pay');
					PREPARE stmt FROM @sqlstr;
					EXECUTE stmt;
					DROP PREPARE stmt;
				else
					SET @sqlstr = CONCAT('delete from ',v_allowance_table,' where unit_id = \'',v_unit_dataId,'\'');
					PREPARE stmt FROM @sqlstr;
					EXECUTE stmt; -- 删除已经存在 的本单位当月发放津补贴表数据
					DROP PREPARE stmt;
				end if;
				
						-- 插入基金发放发- 通过t126.t125,t117获取
				SET @sqlstr = CONCAT('INSERT INTO ', v_table,' (fund_month,unit_id,unit_code,staff_id,staff_code,staff_name,
						staff_eduLevel,staff_standing,staff_curPost,
						-- 学历			人员身份		现任职务
						staff_actual_workRank,staff_workRank,staff_isLeader,staff_postSalRank,staff_salRankLevel,
						-- 实际职务/技术等级	工资对应职级	是否领导工资	工资级别		工资档次
						staff_jobSal,staff_levelSal,staff_teacherNurseUpTen,staff_specialTeachFifteen,staff_keepSpecialStationSal,staff_midTeacherKeeyTen,staff_keepNurseUpTen,
						-- 职务/技术等级工资 级别岗位级别工资 教师护士提高10% 特殊教育提高15%			保留特岗工资			中小学教师保留10%工资	保留护士提高10%工资
						staff_peacetimeAward,staff_basicPerfor,
						-- 平时训练奖			基础绩效
						jbt_total_salary,part_total_salary,total_salary,actual_total_salary,theory_total_salary,
						-- 津补贴小计		工资小计   工资合计  实发工资合计		实际应发工资合计
						is_finSupt,is_salUniOut,department_name,
						-- 是否财政供养 是否财政统发 部门
						staff_wageSystem,staff_isUpten,staff_plusGrade,staff_downGrade,staff_plusLevel,staff_floatLevel,staff_fixLevel,staff_downLevel,
						-- 人员工资制度 是否提高10%工资  已含高定级别  已含低定级别		已含高定档次	已含浮动档次	已含固定档次	已含低定档次
						st_sal_date,en_sal_date,staff_status,staff_sex,staff_birth,staff_degree,staff_workYears,staff_from,staff_establish,
						-- 起薪时间 停薪时间	人员状态		性别		出生日期	学位		连续工龄	人员来源	人员编制
						staff_isChuFen,staff_salaryStandard,staff_isMainPart,staff_isStop,staff_partYears,staff_isMidTeacher,
						-- 是否处分	执行工资标准			是否主力		是否停薪		入队年限		是否中小学教师
						staff_isNurse,staff_fileNum,staff_titleRank,staff_isSpecialTeach,staff_salStandardDate
						-- 是否护士		根据文号		衔级			是否特殊教育		工资标准时间
						,staff_czbm,staff_sbid,staff_mz,staff_sfz,staff_bysj
						-- 财政编码 社保号 民族 身份证号 毕业时间
						,staff_jrbdwsj,staff_cjgzsj,staff_xrzwsj,staff_jdgl
						-- 进入本单位时间 参加工作时间 现任职务时间 间断工龄
						,staff_kjsgl,staff_wjsgl,staff_jbsj,staff_dcsj
						-- 工作前可计算工龄 未计算学习工龄 级别起考年份 档次起考年份
						,staff_gddc,staff_gdyj,staff_fddc,staff_fdyj
						-- 高定档次 高定依据 浮动档次 浮动依据 
						,staff_gudingdc,staff_gudingyj,staff_dddc,staff_ddyj
						-- 固定档次 固定依据 低定档次 低定原因
						,staff_gdjb,staff_gdjbyj,staff_ddjb,staff_ddjbyj,staff_node
						-- 高定级别 高定级别依据 低定级别 低定级别依据
						)
						select ',stemFundMonth,',',v_unit_dataId,',\'',v_unit_id,'\',staff_id,staff_code,staff_name,
						staff_eduLevel,staff_standing,staff_curPost,
						-- 学历			人员身份		现任职务
						staff_actual_workRank,staff_workRank,staff_isLeader,staff_postSalRank,staff_salRankLevel,
						-- 实际职务/技术等级	工资对应职级	是否领导工资	工资级别		工资档次
						staff_jobSal,staff_levelSal,staff_teacherNurseUpTen,staff_specialTeachFifteen,staff_keepSpecialStationSal,staff_midTeacherKeeyTen,staff_keepNurseUpTen,
						-- 职务/技术等级工资 级别岗位级别工资 教师护士提高10% 特殊教育提高15%			保留特岗工资			中小学教师保留10%工资	保留护士提高10%工资
						staff_peacetimeAward,staff_basicPerfor,
						-- 平时训练奖			基础绩效
						jbt_total_salary,part_total_salary,total_salary,total_salary,total_salary,
						-- 津补贴小计		工资小计    工资合计 实发工资合计		实际应发工资合计
						is_finSupt,is_salUniOut,department_name,
						-- 是否财政供养 是否财政统发 部门
						staff_wageSystem,staff_isUpten,staff_plusGrade,staff_downGrade,staff_plusLevel,staff_floatLevel,staff_fixLevel,staff_downLevel,
						-- 人员工资制度 是否提高10%工资  已含高定级别  已含低定级别		已含高定档次	已含浮动档次	已含固定档次	已含低定档次
						st_sal_date,en_sal_date,staff_status,staff_sex,staff_birth,staff_degree,staff_workYears,staff_from,staff_establish,
						-- 起薪时间 停薪时间	人员状态		性别		出生日期	学位		连续工龄	人员来源	人员编制
						staff_isChuFen,staff_salaryStandard,staff_isMainPart,staff_isStop,staff_partYears,staff_isMidTeacher,
						-- 是否处分		执行工资标准			是否主力		是否停薪		入队年限		是否中小学教师
						staff_isNurse,staff_fileNum,staff_titleRank,staff_isSpecialTeach,staff_salStandardDate
						
						,staff_czbm,staff_sbid,staff_mz,staff_sfz,staff_bysj
						-- 财政编码 社保号 民族 身份证号 毕业时间
						,staff_jrbdwsj,staff_cjgzsj,staff_xrzwsj,staff_jdgl
						-- 进入本单位时间 参加工作时间 现任职务时间 间断工龄
						,staff_kjsgl,staff_wjsgl,staff_jbsj,staff_dcsj
						-- 工作前可计算工龄 未计算学习工龄 级别起考年份 档次起考年份
						,staff_gddc,staff_gdyj,staff_fddc,staff_fdyj
						-- 高定档次 高定依据 浮动档次 浮动依据 
						,staff_gudingdc,staff_gudingyj,staff_dddc,staff_ddyj
						-- 固定档次 固定依据 低定档次 低定原因
						,staff_gdjb,staff_gdjbyj,staff_ddjb,staff_ddjbyj,staff_node
						-- 高定级别 高定级别依据 低定级别 低定级别依据
					from ',v_table_pre,' a join data_record_t126 t126 on a.staff_id = concat(t126.dataid ,\'\')
					where 1=1 and unit_id = \'',v_unit_dataId,'\'
					and t126.c01 = unit_id
					 and not exists(select 1 from data_record_t126 a where a.dataid = t126.dataid  and a.c01 = unit_id  and a.allAuditFlag =2  and fund_month<',v_i_fund_month,'	  and  a.changetype = 10831 ) 
					  and t126.c03 = 10371 
					  and a.staff_status not in (\'','减少','\',\'','增加','\') 
					and not exists(select 1 from sys_s_data d where d.id = t126.c03 and d.typename = \'staffStatus\' and d.data_value = \'2\')
				-- 非离休人员
					-- and if(ifnull(total_salary,\'\')=\'\',0,total_salary)>0
					  GROUP BY a.staff_id
					');
				--  set resultMsg = concat('@sqlstr:',@sqlstr);leave label_pro;
				PREPARE stmt FROM @sqlstr;
				EXECUTE stmt;
				DROP PREPARE stmt;
						-- 插入基金发放-津补贴发- 通过t126.t125,t117获取
				SET @sqlstr = CONCAT('INSERT INTO ', v_allowance_table,' (fund_month,unit_id,unit_code,
						staff_id,allowance_id,allowance_title,salary_value,staff_salStandardDate
						)
						select ',stemFundMonth,',',v_unit_dataId,',\'',v_unit_id,'\',
						staff_id,allowance_id,allowance_title,salary_value,staff_salStandardDate
					from ',v_allowance_table_pre,' a join data_record_t126 t126 on a.staff_id = concat(t126.dataid ,\'\')
					where 1=1 and unit_id = \'',v_unit_dataId,'\'
					and t126.c01 = unit_id
					and not exists(select 1 from sys_s_data d where d.id = t126.c03 and d.typename = \'staffStatus\' and d.data_value = \'2\')
					-- 非离休人员
					and exists(select 1 from ',v_table,' d where d.staff_id = concat(t126.dataid,\'\')) GROUP BY a.staff_id ,a.allowance_id
					');
				PREPARE stmt FROM @sqlstr;
				EXECUTE stmt;
				DROP PREPARE stmt;
			
				-- if stemP = 0 or stemP = 2 then -- 机关
				/**	SET @sqlstr = CONCAT('INSERT INTO ', v_table,' select * from ' ,v_table_pre);
				PREPARE stmt FROM @sqlstr;
				EXECUTE stmt;
				SET @sqlstr = CONCAT('update ',v_table,' set',' fund_month = ',stemFundMonth,' and unit_id = ',v_unit_dataId);
				PREPARE stmt FROM @sqlstr;
				EXECUTE stmt;
				*/
					-- 插入机关核定表  fund_total_person_type_gov机关分类人数核定表(公务员/机关工勤)
					-- fund_total_gov 机关变动原因/类型核定表 
					--  fund_total_person_gov/机关总人数核定表  存放编制等相关信息
	
					DELETE FROM fund_total_gov WHERE  unit_id = concat(v_unit_dataId,'') and fund_month = stemFundMonth ;
					-- 上月核定工资总额
					INSERT INTO fund_total_gov(fund_month,unit_id,unit_code,change_type,change_person_num,
								total_salary,part_total_salary,zwgz_salary,gwgz_salary,ycxbkf_salary,jbt_salary
								-- 工资合计   工资小计					职务工资  级别工资  一次性补扣发 津补贴小计
								,jbt_code_salary) 
								/*,total_salary,part_total_salary,zwgz_salary,gwgz_salary,
					dszn_salary,llt_salary,ggbl_salary,hmbt_salary,jjbabt_salary,xfgzry_salary,zsjz_salary,gwygfh_salary,ycxbkf_salary*/
						select  stemFundMonth,unit_id,unit_code,'上月核定工资总额',change_person_num,
								total_salary,part_total_salary,zwgz_salary,gwgz_salary,ycxbkf_salary,jbt_salary
						-- 工资合计   工资小计 职务工资  级别工资 津补贴小计
						,jbt_code_salary
						from fund_total_gov where 1=1
						and unit_id = concat(v_unit_dataId,'') and fund_month = stemParam and change_type = '本月核定工资总额'
						;-- 根据变动类型分组 -- allAuditFlag = 9 表示 基金生成未上报
					
					-- 本月核定工资总额
					INSERT INTO fund_total_gov(fund_month,unit_id,unit_code,change_type,change_person_num,
								total_salary,part_total_salary,zwgz_salary,gwgz_salary,jbt_salary
								-- 工资合计   工资小计					职务工资  级别工资 津补贴小计 
								,jbt_code_salary) 
								/*,total_salary,part_total_salary,zwgz_salary,gwgz_salary,
				dszn_salary,llt_salary,ggbl_salary,hmbt_salary,jjbabt_salary,xfgzry_salary,zsjz_salary,gwygfh_salary,ycxbkf_salary*/
						select  stemFundMonth,v_unit_dataId,v_unit_id,'本月核定工资总额',change_person_num ,
						part_total_salary,part_total_salary,zwgz_salary,gwgz_salary,jbt_salary
						-- 工资总计 工资合计  职务工资  级别工资 津补贴小计
						,jbt_code_salary
						from fund_total_gov
						where  1=1
						and unit_id = concat(v_unit_dataId,'') and fund_month = stemParam and change_type = '本月核定工资总额'
						;-- 根据变动类型分组

					delete from fund_total_person_gov where  unit_id = concat(v_unit_dataId,'') and fund_month  = stemFundMonth ;-- 如果系统里面已经存在,先删除
	
					INSERT INTO fund_total_person_gov(fund_month,unit_id,unit_code,cz_code,czgy_num,cztf_num,xzbz_num,xzbz_sj_num,dlbz_num,dlbz_sj_num,jjbz_num,jjbz_sj_num,jzbz_num,jzbz_sj_num,zfzxbz_num,zfzxbz_sj_num,
						qebk_num,qebk_sj_num,xzzf_num,xzzf_sj_num,jggc_num,jggc_sj_num,cebk_num,cebk_sj_num,zszz_num,zszz_sj_num)
					select stemFundMonth,unit_id,unit_code,cz_code,czgy_num,cztf_num,xzbz_num,xzbz_sj_num,dlbz_num,dlbz_sj_num,jjbz_num,jjbz_sj_num,jzbz_num,jzbz_sj_num,zfzxbz_num,zfzxbz_sj_num,
						qebk_num,qebk_sj_num,xzzf_num,xzzf_sj_num,jggc_num,jggc_sj_num,cebk_num,cebk_sj_num,zszz_num,zszz_sj_num 
						from fund_total_person_gov where unit_id = concat(v_unit_dataId,'') and fund_month = stemParam  ;
	
					delete from fund_total_person_type_gov where  unit_id = concat(v_unit_dataId,'') and fund_month  = stemFundMonth ;-- 如果系统里面已经存在,先删除
	
					INSERT INTO fund_total_person_type_gov(fund_month,unit_id,person_type,pre_month_person_num,
						-- increase_part_total,dr_num,gz_num,jz_num,ftjr_num,other_incr_num,
						-- decrease_part_total,tlx_num,dc_num,cz_num,ct_num,kc_num,zdlz_num,sw_num,other_decr_num,
						this_month_person_num)
						select stemFundMonth,unit_id,person_type,this_month_person_num,
						-- 0,0,0,0,0,0,
						-- 0,0,0,0,0,0,0,0,0,
						this_month_person_num 
						from fund_total_person_type_gov where  unit_id = concat(v_unit_dataId,'') and fund_month = stemParam ;
			-- 	end if;
				
				DELETE FROM fund_total_person_ins WHERE unit_id = concat(v_unit_dataId,'') and fund_month = stemFundMonth   ;
				INSERT into fund_total_person_ins(fund_month,unit_id,unit_code,cz_code,czgy_num,cztf_num,xzbz_num,xzbz_sj_num,dlbz_num,dlbz_sj_num,
					jjbz_num,jjbz_sj_num,jzbz_num,jzbz_sj_num,zfzxbz_num,zfzxbz_sj_num,qebk_num,qebk_sj_num,xzzf_num,xzzf_sj_num,jggc_num,jggc_sj_num,
					cebk_num,cebk_sj_num,zszz_num,zszz_sj_num,glry_num,zyjs_num,gq_num,syq_num,ydy_num,
				 	this_month_person_num,pre_glry_num,pre_zyjs_num,pre_gq_num,pre_syq_num,pre_ydy_num,pre_month_person_num,gz_num,sz_num
					) 
					select stemFundMonth,unit_id,unit_code,cz_code,czgy_num,cztf_num,xzbz_num,xzbz_sj_num,dlbz_num,dlbz_sj_num,
					jjbz_num,jjbz_sj_num,jzbz_num,jzbz_sj_num,zfzxbz_num,zfzxbz_sj_num,qebk_num,qebk_sj_num,xzzf_num,xzzf_sj_num,jggc_num,jggc_sj_num,
					cebk_num,cebk_sj_num,zszz_num,zszz_sj_num,glry_num,zyjs_num,gq_num,syq_num,ydy_num,
					this_month_person_num,glry_num,zyjs_num,gq_num,syq_num,ydy_num,this_month_person_num,gz_num,sz_num
					 from fund_total_person_ins where unit_Id = concat(v_unit_dataId,'') and fund_month =  stemParam;
					 
					 
			-- 	if stemP = 1 or stemP = 2  then 
					-- CALL p_6_fund (v_i_fund_month,v_unit_id);/*基金生成-事业工资发放表*/
					-- CALL p_5_fund (v_i_fund_month,v_unit_id);/*基金生成-事业变动花名册*/
					-- CALL p_4_fund (v_i_fund_month,v_unit_id,v_unit_dataId,resultMsg);/*基金生成-事业核定表*/
					
					/**			
					INSERT INTO fund_total_person_ins(fund_month,unit_id,unit_code,cz_code,czgy_num,cztf_num,xzbz_num,xzbz_sj_num,dlbz_num,dlbz_sj_num,
					jjbz_num,jjbz_sj_num,jzbz_num,jzbz_sj_num,zfzxbz_num,zfzxbz_sj_num,
						qebk_num,qebk_sj_num,xzzf_num,xzzf_sj_num,jggc_num,jggc_sj_num,cebk_num,cebk_sj_num,zszz_num,zszz_sj_num,
						glry_num, zyjs_num, gq_num, syq_num, ydy_num,this_month_person_num,
						-- 管理人员数量  专业技术数量   工勤人员数量 试用期数量  运动员数量 本月核定人数
						pre_glry_num,pre_zyjs_num,pre_gq_num,pre_syq_num,pre_ydy_num,
						-- 上月-管理人员数量 上月-专业技术数量 上月-工勤人员数量 上月-试用期数量 上月-运动员数量
						pre_month_person_num)
					select stemFundMonth,v_unit_dataId,v_unit_id,cz_code,czgy_num,cztf_num,xzbz_num,xzbz_sj_num,dlbz_num,dlbz_sj_num,jjbz_num,jjbz_sj_num,jzbz_num,jzbz_sj_num,zfzxbz_num,zfzxbz_sj_num,
						qebk_num,qebk_sj_num,xzzf_num,xzzf_sj_num,jggc_num,jggc_sj_num,cebk_num,cebk_sj_num,zszz_num,zszz_sj_num,
						glry_num, zyjs_num, gq_num, syq_num, ydy_num,this_month_person_num,
						-- 管理人员数量  专业技术数量   工勤人员数量 试用期数量  运动员数量 本月核定人数
						glry_num,zyjs_num,gq_num,syq_num,ydy_num,
						-- 上月-管理人员数量 上月-专业技术数量 上月-工勤人员数量 上月-试用期数量 上月-运动员数量
						this_month_person_num
						from  fund_total_person_ins where 1=1 and unit_id = concat(v_unit_dataId,'') and fund_month = stemParam 
						;
						**/
				
					DELETE FROM fund_total_ins WHERE  unit_id = concat(v_unit_dataId,'') and fund_month = stemFundMonth  ;
					-- 上月核定工资总额
					INSERT INTO fund_total_ins(fund_month,unit_id,unit_code,change_type,change_person_num,
								total_salary,part_total_salary,zwgz_salary,gwgz_salary,ycxbkf_salary,jbt_salary
								-- 工资合计   工资小计					职务工资  级别工资  一次性补扣发 津补贴小计
								,jstg10 ,tsjy15 ,blzxx10
								-- 中小学教师或护士提高10%  特殊教育提高15% 退役运动员保留工资额度;-- 原 中小学教师保留10%
								 ,blhs10 ,bltg ,psxlj 
								-- 在护士岗位工作满20年并在医疗卫生机构工作的保留原提高10% 保留原特殊岗位活工资比例提高部分 运动员平时训练奖
								,jxgz
								--  绩效工资
								,jbt_code_salary) 
						select  stemFundMonth,unit_id,unit_code,'上月核定工资总额',change_person_num,
								total_salary,part_total_salary,zwgz_salary,gwgz_salary,ycxbkf_salary,jbt_salary
								-- 工资合计   工资小计 职务工资  级别工资 津补贴小计
								,jstg10 ,tsjy15 ,blzxx10
								-- 中小学教师或护士提高10%  特殊教育提高15% 退役运动员保留工资额度;-- 原 中小学教师保留10%
								 ,blhs10 ,bltg ,psxlj 
								-- 在护士岗位工作满20年并在医疗卫生机构工作的保留原提高10% 保留原特殊岗位活工资比例提高部分 运动员平时训练奖
								,jxgz
								--  绩效工资
								,jbt_code_salary
						from fund_total_ins where 1=1
						and unit_id = concat(v_unit_dataId,'') and fund_month = stemParam and change_type = '本月核定工资总额'
						;-- 根据变动类型分组 -- allAuditFlag = 9 表示 基金生成未上报
					
					
					-- 本月核定工资总额
					INSERT INTO fund_total_ins(fund_month,unit_id,unit_code,change_type,change_person_num,
							total_salary,part_total_salary,zwgz_salary,gwgz_salary,jbt_salary
							-- 工资合计   工资小计					职务工资  级别工资  津补贴小计  一次性补扣发
							,jstg10 ,tsjy15 ,blzxx10
							-- 中小学教师或护士提高10%  特殊教育提高15% 退役运动员保留工资额度;-- 原 中小学教师保留10%
							 ,blhs10 ,bltg ,psxlj 
							-- 在护士岗位工作满20年并在医疗卫生机构工作的保留原提高10% 保留原特殊岗位活工资比例提高部分 运动员平时训练奖
							,jxgz
							--  绩效工资
							,jbt_code_salary) 
							/*,total_salary,part_total_salary,zwgz_salary,gwgz_salary,
						dszn_salary,llt_salary,ggbl_salary,hmbt_salary,jjbabt_salary,xfgzry_salary,zsjz_salary,gwygfh_salary,ycxbkf_salary*/
					select  stemFundMonth,v_unit_dataId,v_unit_id,'本月核定工资总额',change_person_num ,
					part_total_salary,part_total_salary,zwgz_salary,gwgz_salary,jbt_salary
					-- 工资合计   工资小计 职务工资  级别工资 津补贴小计
					,jstg10 ,tsjy15 ,blzxx10
					-- 中小学教师或护士提高10%  特殊教育提高15% 退役运动员保留工资额度;-- 原 中小学教师保留10%
					 ,blhs10 ,bltg ,psxlj 
					-- 在护士岗位工作满20年并在医疗卫生机构工作的保留原提高10% 保留原特殊岗位活工资比例提高部分 运动员平时训练奖
					,jxgz
					--  绩效工资
					,jbt_code_salary 
					from fund_total_ins
					where unit_id = concat(v_unit_dataId,'') and fund_month = stemParam
					and change_type = '本月核定工资总额'
					;
			-- 	end if;
				
				INSERT INTO fund_audit_record(fund_month,unit_code,unit_id,fund_status,firstFlag,secondFlag,
												thirdFlag,forthFlag,fiveFlag,sixFlag,auditMsg,endTime,commitPerson) 
				values( stemFundMonth,v_unit_id,v_unit_dataId,2,2,2,2,2,2,2,@rs,now(),@commitPerson);
			-- end if;
		end while;
	-- else 
		-- call fund_init(v_i_fund_month,v_unit_id,v_unit_dataId,resultMsg); -- 前面都没有基金信息时 单位每月做第一次变动时,判断是否存在前几个月的工资数据,如果不存在,默认生成变动时间前一个月的工资基金数据
	end if;
IF t_error = 1 THEN
    ROLLBACK;
ELSE
    COMMIT;
END IF;

END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`person_insert_record`(in createrId int(11),in unitId int(11),
in personId varchar(400),
-- 人员id
inout resultMsg varchar(1000))
label_pro:BEGIN
	DECLARE stemNum int(11);-- 参数变量
	DECLARE stemParam varchar(20);-- 参数变量
	DECLARE chanType varchar(20) ; -- 变动类型
	DECLARE chanSign varchar(100);-- 变动标志
	select c40 into chanType from t126 where id = personId;
	select UNIX_TIMESTAMP() into stemParam;
	set chanSign = concat('tyscbd',stemParam,chanType,'t126',personId);-- 统一生成变动
		select count(1) into stemNum from 
		data_record_t126 t126
		where dataId = personId and t126.changeType = concat(chanType,'') 
		and ifnull(allAuditFlag,'')!='2';
		if stemNum > 0 then 
			-- 如果已经此变动类型 先删除
			delete from data_record_t126 
			where dataId = personId and changeType = chanType 
			and ifnull(allAuditFlag,'')!='2';
			delete from data_record_t125 
			where  c06 = concat(personId,'') and changeType = chanType 
			and ifnull(allAuditFlag,'')!='2'; 
			delete from data_record_t117 
			where c03 = concat(personId,'') and changeType = chanType 
			and ifnull(allAuditFlag,'')!='2'; 
		end if;
		-- 人员基本信息-变动记录
		INSERT data_record_t126 (dataId,dataclassCode,createrId,createDate,updaterId,updateDate,unitId,
			operateTime,operateId,operateType,changeSign,changeType,
			c01,c02,c03,c04,c05,c06,c07,c08,c09,c10,
			c11,c12,c13,c14,c15,c16,c17,c18,c19,c20,
			c21,c22,c23,c24,c25,c26,c27,c28,c29,c30,
			c31,c32,c33,c34,c35,c36,c37,c38,c39,c40,
			c41,c42,c43,c44,c45,c46,c47,c48,c49,c50)
		select id,dataclassCode,createrId,sysDate(),updaterId,updateDate,unitId,
	 		sysDate(),updaterId,2,chanSign,chanType,
			c01,c02,c03,c04,c05,c06,c07,c08,c09,c10,
			c11,c12,c13,c14,c15,c16,c17,c18,c19,c20,
			c21,c22,c23,c24,c25,c26,c27,c28,c29,c30,
			c31,c32,c33,c34,c35,c36,c37,c38,c39,c40,
			c41,c42,c43,c44,c45,c46,c47,c48,c49,c50
			from t126 where id = personId;
	 		

		-- 人员工资信息-变动记录
		INSERT data_record_t125 (dataId,dataclassCode,createrId,createDate,updaterId,updateDate,unitId,
			operateTime,operateId,operateType,changeSign,changeType,
			c01,c02,c03,c04,c05,c06,c07,c08,c09,c10,
			c11,c12,c13,c14,c15,c16,c17,c18,c19,c20,
			c21,c22,c23,c24,c25,c26,c27,c28,c29,c30,
			c31,c32,c33,c34,c35,c36,c37,c38,c39,c40,
			c41,c42,c43,c44,c45,c46,c47,c48,c49,c50)
		select id,dataclassCode,createrId,sysDate(),updaterId,updateDate,unitId,
	 		sysDate(),updaterId,2,chanSign,chanType,
			c01,c02,c03,'',c05,c06,c07,c08,c09,c10,
			c11,c12,c13,c14,c15,c16,c17,c18,c19,c20,
			c21,c22,c23,c24,c25,c26,c27,c28,c29,c30,
			c31,c32,c33,'',c35,c36,c37,c38,c39,c40,
			c41,c42,c43,c44,c45,c46,c47,'',c49,c50
			from t125 where c06 = concat(personId,'');						
	
		-- --  人员津补贴-变动记录
		call upRyjbtBd(personId,createrId,unitId,chanSign,chanType,resultMsg);		
end;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`produceAll`(IN unitId int(11),IN createrId int(11),IN dataclassCode varchar(200),IN c1 varchar(400),
IN c2 VARCHAR(400),IN c3 varchar(400),
	IN c4 VARCHAR(400),IN c5 varchar(400),IN c6 varchar(400),IN c7 varchar(400),
	INOUT resultMsg  varchar(20000) CHARSET utf8)
label_pro:BEGIN	

	DECLARE unitTile varchar(100);-- -- 应用功能标题
	DECLARE orgId int(11);-- -- 单位id
	DECLARE stemParam varchar(20);-- -- 临时变量
	if dataclassCode = 't111' and resultMsg = '系统初始导入数据' then 
		-- 批量导入人员后 执行
		set resultMsg = '';
		select id,c01 into orgId,@orgCode from t111 where c01 = c1;
		call p_set_gznx(orgId,resultMsg);-- 计算工龄
		call p_init_autoRecord(orgId,resultMsg);-- 生成编号index
		call p_init_autoBumen(orgId,resultMsg);-- 生成部门编号index
		select count(1) into @stem from t115 where c02 = orgId and ifnull(c03,'')!='';
		call p_init_checkRyjbt_Less(orgId,@stem,resultMsg);-- 检查人员初始化津补贴条数 小于单位津补贴的 
		call p_inis_rysf_init(orgId,resultMsg);-- 人员身份-综合类转人民警察 员额内法官/检察官
		select replace(content,'-','') into @qxsj from sys_s_config where enname = 'SALARY_QX_DATE';
		set resultMsg = '';
		CALL p_all_fund (@qxsj,@orgCode,orgId,resultMsg);/*基金生成*/
		-- call fund_audit(@qxsj,@orgCode,orgId,resultMsg);/*默认导入进来的人员*/
		leave label_pro;
	end if;
	if unitId = 0 then 
		set resultMsg = '应用功能为空';
		leave label_pro;
	end if;
	select title INTO unitTile from data_unit where id = unitId; 
	if unitTile is null THEN
		set resultMsg = '不能查询出对应的功能名称';
		leave label_pro;
	end if;
	if unitTile = '年度工龄变更 ' then 
		call p_update_gznx(unitId,createrId,c1,c2,resultMsg);
		leave label_pro;
	end if;
	if unitTile = '年度考核' then 
		call p_assess_all(unitId,createrId,dataclassCode,c1,c2,c3,c4,c5,c6,c7,resultMsg);
		leave label_pro;
	else
		if unitTile = '机关批量晋升' || unitTile = '事业批量晋升' || unitTile = '批量晋升工资' THEN
			set orgId = c7;
			-- select c13 into stemParam from t111 where id = orgId ;
			-- select data_value into stemParam from sys_s_data where id = stemParam;
			-- if stemParam = 0 or stemParam = 2 then 
				-- 机关批量晋升 t138 c01-工资变动原因 c03-起薪时间 c02-变动时间 c04-新起始考核年度 c05-根据文号 c06-工资标准时间 c07-单位代码
				call upJb(createrId,unitId,orgId,c1,c3,c2,c4,c5,resultMsg);
			-- end if;
			-- if stemParam = 1 or stemParam = 2 then 
				-- 事业批量晋升 t138 c01-工资变动原因 c02-变动时间 c03-起薪时间 c04-新起始考核年度 c05-根据文号 c06-工资标准时间 c07-单位代码
			-- 	call upJb(createrId,unitId,orgId,c01,c03,c02,c04,resultMsg);
			-- end if;
		else 
			if unitTile='津补贴标准更新' then 
				call p_sublariesUpdate(unitId,createrId,c1,c2,c3,c4,c5,c6,c7,resultMsg);
			else
				if unitTile='基本工资标准更新' then 
					call p_salaryUpdate(unitId,createrId,c1,c2,c3,c4,c5,c6,c7,resultMsg);
				end if;
			end if;
		end if;
	end if;
			
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`p_1_fund`(in v_i_fund_month varchar(6),in v_unit_id varchar(50),
in v_unit_dataId int(11),inout resultMsg varchar(10000))
label_pro:BEGIN	
/*基金生成-分支存储过程 机关总人数核定表fund_total_person_gov/fund_total_person_type_gov机关分类人数核定表(公务员/机关工勤)/机关变动原因核定表fund_total_gov*/
	DECLARE stemNum int(11);-- 参数变量
	DECLARE stempParam varchar(20);-- 参数变量
	DECLARE stempMonth varchar(20);-- 参数变量
	DECLARE stemParam varchar(20);-- 参数变量
	
	DECLARE lrxjryCode varchar(20); -- 录入新进人员codeid
	DECLARE jbxxxgCode varchar(20); -- 人员基本信息修改codeid
	DECLARE ryjsCode varchar(20); -- 人员减少-变动记录codeid
	DECLARE hfgzdyCode varchar(20); -- 恢复工资待遇-变动记录codeid

	DECLARE czbm varchar(20);-- 财政编码
	
	DECLARE czgyNum varchar(10);-- 财政供养-人数
	DECLARE cztfNum varchar(10);-- 财政统发-人数
	DECLARE xzbzNum varchar(10);-- 行政编制-编制数
	DECLARE xzbzSjNum varchar(10);-- 行政编制-实有数
	DECLARE dlbzNum varchar(10);-- 单列编制-编制数
	DECLARE dlbzSjNum varchar(10);-- 单列编制-实有数
	DECLARE jjbzNum varchar(10);-- 纪检编制-编制数
	DECLARE jjbzSjNum varchar(10);-- 纪检编制-实有数
	DECLARE jzbzNum varchar(10);-- 军转编制-编制数
	DECLARE jzbzSjNum varchar(10);-- 军转编制-实有数
	DECLARE zfzxbzNum varchar(10);-- 政法专项编制-编制数
	DECLARE zfzxbzSjNum varchar(10);-- 政法专项编制-实有数
	DECLARE qebkNum varchar(10);-- 全额拨款编制-编制数
	DECLARE qebkSjNum varchar(10);-- 全额拨款编制-实有数
	DECLARE xzzfNum varchar(10);-- 行政执法编制-编制数
	DECLARE xzzfSjNum varchar(10);-- 行政执法编制-实有数
	DECLARE jggcNum varchar(10);-- 机关工勤编制-编制数
	DECLARE jggcSjNum varchar(10);-- 机关工勤编制-实有数
	DECLARE cebkNum varchar(10);-- 差额拨款-编制数
	DECLARE cebkSjNum varchar(10);-- 差额拨款-实有数
	DECLARE zszzNum varchar(10);-- 自收自支-编制数
	DECLARE zszzSjNum varchar(10);-- 自收自支-实有数

 	DECLARE byhdrsNum int(11) default 0;-- 本月核定人数
	DECLARE zjNum int(11) default 0;-- 增加小计

	DECLARE gzNum int(11) default 0;-- 公招数量
	DECLARE szNum int(11) default 0;-- 社招数量
	DECLARE drNum int(11) default 0;-- 调入数量
	DECLARE jzgbNum int(11) default 0;-- 军转干部数量
	DECLARE ftjrNum int(11) default 0;-- 复退军人数量
	DECLARE qtzjNum int(11) default 0;-- 其他增加数量

	DECLARE jsNum int(11) default 0;-- 减少小计

	DECLARE ltxNum int(11) default 0;-- 退(离)休数量
	DECLARE dcNum int(11) default 0;-- 调出数量
	DECLARE swNum int(11) default 0;-- 死亡数量
	DECLARE czNum int(11) default 0;-- 辞职数量
	DECLARE ctNum int(11) default 0;-- 辞退数量
	DECLARE kcNum int(11) default 0;-- 开除数量
	DECLARE zdlzNum int(11) default 0;-- 自动离职数量
	DECLARE qtjsNum int(11) default 0;-- 其他减少数量
	
	-- select count(1) into stemNum from t112 where id = v_unit_dataId; -- t111 单位基本信息表
	select count(1) into stemNum from t112 where c01 = concat(v_unit_dataId,''); -- t112 基层单位编制表
	if stemNum = 0 then
		 set resultMsg = '单位编制信息获取失败';
		 leave label_pro;
	end if;

	select ifnull(content,10750) into lrxjryCode from sys_s_config where enname = 'CHANGETYPE_NEWPERSON_CODE';
	select ifnull(content,10751) into jbxxxgCode from sys_s_config where enname = 'CHANGETYPE_INFO_CODE';
	select ifnull(content,10831) into ryjsCode from sys_s_config where enname = 'RYJS_CHANGE_CODE';
	select ifnull(content,10654) into hfgzdyCode from sys_s_config where enname = 'CHANGETYPE_RECOVERYSALARY_CODE';
	
	select ifnull(t128.c01,t111.c15) into czbm from t111 left join t128 on t111.c15 = t128.id where 1=1 and t111.id = v_unit_dataId ; -- t111.c15 单位财政编码 关联 t128 单位财政编码表c01 编码 c02 名称
	select ifnull(c02,0),ifnull(c03,0),ifnull(c04,0),ifnull(c05,0),ifnull(c06,0),ifnull(c08,0),ifnull(c10,0),ifnull(c07,0),ifnull(c12,0),ifnull(c13,0) 
into xzbzNum,dlbzNum,jjbzNum,jzbzNum,zfzxbzNum,qebkNum,xzzfNum,jggcNum,cebkNum,zszzNum
	 from t112 where c01 = concat(v_unit_dataId,'');-- t112 基层单位编制表 
	-- c02-行政编制,c03-单列编制,c04-纪检编制,c05-军转编制,c06-政法专项编制,c08-全额拨款事业编制,c10-行政执法事业编制,c07-机关工勤人员控制数,c12-差额拨款编制,c13-自收自支编制

	select count(1) into czgyNum from t126,t125 b ,sys_s_data d where t126.c01 = concat(v_unit_dataId,'') 
		and concat(t126.id,'') = b.c06
		and t126.c24 = concat(d.id,'') and d.typename = 'is' and d.data_value = '1'
		-- and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' 
		-- and d.data_value in (201,206,202,203,207,208,209,210)) -- 人员工资制度为 201-公务员职级工资制 206-警察职级工资制 202 -机关技工岗位等级工资制 203-机关普工岗位工资制 207-法官职级工资制 208-检察官职级工资制 209-公安机关执法勤务警员职级工资制 210-公安机关警务技术人民警察职级工资制
		and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1') -- t126.c03 人员状态-码表 1-在职
		and not exists (select 1 from t126 d where d.id = t126.id and ifnull(d.c46,'')!='')
		-- 不是调出的人员
		;-- 财政供养-人数 t126.c24 是否财政供养

	select count(1) into cztfNum from t126,t125 b,sys_s_data d where t126.c01 = concat(v_unit_dataId,'')
		and concat(t126.id,'') = b.c06
		and t126.c22 = concat(d.id,'') and d.typename = 'is' and d.data_value = '1' -- 财政统发-人数t126.c22 是否工资统发
		-- and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem'
		-- 	and d.data_value in (201,206,202,203,207,208,209,210)) -- 人员工资制度为 201-公务员职级工资制 206-警察职级工资制 202 -机关技工岗位等级工资制 203-机关普工岗位工资制 207-法官职级工资制 208-检察官职级工资制 209-公安机关执法勤务警员职级工资制 210-公安机关警务技术人民警察职级工资制
		and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1') -- t126.c03 人员状态-码表 1-在职
		and not exists (select 1 from t126 d where d.id = t126.id and ifnull(d.c46,'')!='')
		-- 不是调出的人员
		;-- 财政供养-人数 t126.c24 是否财政供养

	select count(1) into xzbzSjNum from t126,t125 b ,sys_s_data d where t126.c01 = concat(v_unit_dataId,'') -- t126.c21 人员基本信息-人员编制
		and concat(t126.id,'') = b.c06
		and t126.c21 = concat(d.id,'') and d.typename = 'rybz' and d.data_value = '0101' -- 行政编制 实有数
		-- and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem'
		-- and d.data_value in (201,206,202,203,207,208,209,210)) -- 人员工资制度为 201-公务员职级工资制 206-警察职级工资制 202 -机关技工岗位等级工资制 203-机关普工岗位工资制 207-法官职级工资制 208-检察官职级工资制 209-公安机关执法勤务警员职级工资制 210-公安机关警务技术人民警察职级工资制
		and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1') -- t126.c03 人员状态-码表 1-在职
		and not exists (select 1 from t126 d where d.id = t126.id and ifnull(d.c46,'')!='')
		-- 不是调出的人员
		;-- 财政供养-人数 t126.c24 是否财政供养


	select count(1) into dlbzSjNum from t126 ,t125 b ,sys_s_data d where t126.c01 = concat(v_unit_dataId,'')
		and concat(t126.id,'') = b.c06
		and t126.c21 = concat(d.id,'') and d.typename = 'rybz' and d.data_value = '0102' -- 单列编制-实有数
		-- and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem'
		-- and d.data_value in (201,206,202,203,207,208,209,210)) -- 人员工资制度为 201-公务员职级工资制 206-警察职级工资制 202 -机关技工岗位等级工资制 203-机关普工岗位工资制 207-法官职级工资制 208-检察官职级工资制 209-公安机关执法勤务警员职级工资制 210-公安机关警务技术人民警察职级工资制
		and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1') -- t126.c03 人员状态-码表 1-在职
		and not exists (select 1 from t126 d where d.id = t126.id and ifnull(d.c46,'')!='')
		-- 不是调出的人员
		;-- 财政供养-人数 t126.c24 是否财政供养


	select count(1) into jjbzSjNum from t126 ,t125 b ,sys_s_data d where t126.c01 = concat(v_unit_dataId,'')
		and concat(t126.id,'') = b.c06
		and t126.c21 = concat(d.id,'') and d.typename = 'rybz' and d.data_value = '0103'-- 纪检编制-实有数
		-- and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem'
		-- and d.data_value in (201,206,202,203,207,208,209,210)) -- 人员工资制度为 201-公务员职级工资制 206-警察职级工资制 202 -机关技工岗位等级工资制 203-机关普工岗位工资制 207-法官职级工资制 208-检察官职级工资制
		and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1') -- t126.c03 人员状态-码表 1-在职
		and not exists (select 1 from t126 d where d.id = t126.id and ifnull(d.c46,'')!='')
		-- 不是调出的人员
		;-- 财政供养-人数 t126.c24 是否财政供养


	select count(1) into jzbzSjNum from t126 ,t125 b ,sys_s_data d where t126.c01 = concat(v_unit_dataId,'')
		and concat(t126.id,'') = b.c06
		and t126.c21 = concat(d.id,'') and d.typename = 'rybz' and d.data_value = '0104' -- 军转编制-实有数
		-- and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem'
		-- and d.data_value in (201,206,202,203,207,208,209,210)) -- 人员工资制度为 201-公务员职级工资制 206-警察职级工资制 202 -机关技工岗位等级工资制 203-机关普工岗位工资制 207-法官职级工资制 208-检察官职级工资制
		and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1') -- t126.c03 人员状态-码表 1-在职
		and not exists (select 1 from t126 d where d.id = t126.id and ifnull(d.c46,'')!='')
		-- 不是调出的人员
		;-- 财政供养-人数 t126.c24 是否财政供养


	select count(1) into zfzxbzSjNum from t126 ,t125 b ,sys_s_data d where t126.c01 = concat(v_unit_dataId,'')
		and concat(t126.id,'') = b.c06
		and t126.c21 = concat(d.id,'') and d.typename = 'rybz' and d.data_value in('011','0111','0112','0113','0114','0115')-- 政法专项编制-实有数
		-- and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem'
		-- and d.data_value in (201,206,202,203,207,208,209,210)) -- 人员工资制度为 201-公务员职级工资制 206-警察职级工资制 202 -机关技工岗位等级工资制 203-机关普工岗位工资制 207-法官职级工资制 208-检察官职级工资制
		and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1') -- t126.c03 人员状态-码表 1-在职
		and not exists (select 1 from t126 d where d.id = t126.id and ifnull(d.c46,'')!='')
		-- 不是调出的人员
		;-- 财政供养-人数 t126.c24 是否财政供养


	select count(1) into qebkSjNum from t126 ,t125 b ,sys_s_data d where t126.c01 = concat(v_unit_dataId,'')
		and concat(t126.id,'') = b.c06
		and t126.c21 = concat(d.id,'') and d.typename = 'rybz' and d.data_value = '0201' -- 全额拨款编制-实有数
		-- and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem'
		-- and d.data_value in (201,206,202,203,207,208,209,210)) -- 人员工资制度为 201-公务员职级工资制 206-警察职级工资制 202 -机关技工岗位等级工资制 203-机关普工岗位工资制 207-法官职级工资制 208-检察官职级工资制
		and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1') -- t126.c03 人员状态-码表 1-在职
		and not exists (select 1 from t126 d where d.id = t126.id and ifnull(d.c46,'')!='')
		-- 不是调出的人员
		;-- 财政供养-人数 t126.c24 是否财政供养


	select count(1) into xzzfSjNum from t126 ,t125 b ,sys_s_data d where t126.c01 = concat(v_unit_dataId,'')
		and concat(t126.id,'') = b.c06
		and t126.c21 = concat(d.id,'') and d.typename = 'rybz' and d.data_value = '0202' -- 行政执法编制-实有数
		-- and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem'
		-- and d.data_value in (201,206,202,203,207,208,209,210)) -- 人员工资制度为 201-公务员职级工资制 206-警察职级工资制 202 -机关技工岗位等级工资制 203-机关普工岗位工资制 207-法官职级工资制 208-检察官职级工资制
		and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1') -- t126.c03 人员状态-码表 1-在职
		and not exists (select 1 from t126 d where d.id = t126.id and ifnull(d.c46,'')!='')
		-- 不是调出的人员
		;-- 财政供养-人数 t126.c24 是否财政供养


	select count(1) into jggcSjNum from t126 ,t125 b ,sys_s_data d where t126.c01 = concat(v_unit_dataId,'')
		and concat(t126.id,'') = b.c06
		and t126.c21 = concat(d.id,'') and d.typename = 'rybz' and d.data_value = '0203' -- 机关工勤编制-实有数
		-- and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem'
		-- and d.data_value in (201,206,202,203,207,208,209,210)) -- 人员工资制度为 201-公务员职级工资制 206-警察职级工资制 202 -机关技工岗位等级工资制 203-机关普工岗位工资制 207-法官职级工资制 208-检察官职级工资制
		and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1') -- t126.c03 人员状态-码表 1-在职
		and not exists (select 1 from t126 d where d.id = t126.id and ifnull(d.c46,'')!='')
		-- 不是调出的人员
		;-- 财政供养-人数 t126.c24 是否财政供养


	select count(1) into cebkSjNum from t126 ,t125 b ,sys_s_data d where t126.c01 = concat(v_unit_dataId,'')
		and concat(t126.id,'') = b.c06
		and t126.c21 = concat(d.id,'') and d.typename = 'rybz' and d.data_value = '021' -- 差额拨款-实有数
		-- and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem'
		-- and d.data_value in (201,206,202,203,207,208,209,210)) -- 人员工资制度为 201-公务员职级工资制 206-警察职级工资制 202 -机关技工岗位等级工资制 203-机关普工岗位工资制 207-法官职级工资制 208-检察官职级工资制
		and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1') -- t126.c03 人员状态-码表 1-在职
		and not exists (select 1 from t126 d where d.id = t126.id and ifnull(d.c46,'')!='')
		-- 不是调出的人员
		;-- 财政供养-人数 t126.c24 是否财政供养


	select count(1) into zszzSjNum from t126 ,t125 b ,sys_s_data d where t126.c01 = concat(v_unit_dataId,'')
		and concat(t126.id,'') = b.c06
		and t126.c21 = concat(d.id,'') and d.typename = 'rybz' and d.data_value = '022' -- 自收自支-实有数
		-- and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem'
		-- and d.data_value in (201,206,202,203,207,208,209,210)) -- 人员工资制度为 201-公务员职级工资制 206-警察职级工资制 202 -机关技工岗位等级工资制 203-机关普工岗位工资制 207-法官职级工资制 208-检察官职级工资制
		and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1') -- t126.c03 人员状态-码表 1-在职
		and not exists (select 1 from t126 d where d.id = t126.id and ifnull(d.c46,'')!='')
		-- 不是调出的人员
		;-- 财政供养-人数 t126.c24 是否财政供养


/*数据清理*/
	DELETE FROM fund_total_person_gov WHERE  unit_id = concat(v_unit_dataId,'') and fund_month = concat(v_i_fund_month,'')  ;
	DELETE FROM fund_total_person_type_gov WHERE  unit_id = concat(v_unit_dataId,'') and fund_month = concat(v_i_fund_month,'')  ;
	DELETE FROM fund_total_gov WHERE  unit_id = concat(v_unit_dataId,'') and fund_month = concat(v_i_fund_month,'')  ;

/*数据插入*/
	select count(1) into stemNum from t126 where c01 = concat(v_unit_dataId,'') -- t126 人员基本信息 c01-单位代码
	and not exists(select 1 from sys_s_data d where d.id = t126.c03 and d.typename = 'staffStatus' and d.data_value = '2')
	-- 非离休人员
	;
	select count(1) into @stemNumRecord126 from data_record_t126 t126 where c01 = concat(v_unit_dataId,'') -- t126 人员基本信息 c01-单位代码
	and not exists(select 1 from sys_s_data d where d.id = t126.c03 and d.typename = 'staffStatus' and d.data_value = '2')
	-- 非离休人员
	and fund_month = v_i_fund_month
	;
	select count(1) into @stemNumT119 from t119 where c04 = concat(v_unit_dataId,'') -- t126 人员基本信息 c01-单位代码
	and  exists(select 1 from t126 where t119.c01 = t126.id and t126.c03!=10372 )
	-- 非离休人员
	;
	set stemNum = stemNum +@stemNumRecord126 + @stemNumT119 ;

	if stemNum = 0 then
		 set resultMsg = '当前单位没有人员信息';
		 leave label_pro;
	end if;

	select DATE_FORMAT(DATE_SUB(concat(v_i_fund_month,'01'),INTERVAL 1 MONTH),'%Y%m')  into stempMonth ;

	-- 1-公务员(参公)/2-工勤人员
	-- fund_total_person_type_gov 机关分类人数核定表(公务员/机关工勤)
	-- 所有在职公务员总人数
   SELECT count(1) into byhdrsNum from t126 ,t125,sys_s_data d
		where t125.c06 = concat(t126.id,'') and t125.c36 = concat(d.id,'') -- t125.c06人员工资表 c06人员编号关联 人员基本表t126.id
		and t126.c01 = concat(v_unit_dataId,'') and d.data_value in ( '201','206','207','208','209','210') -- t125.c36 人员工资制度为 201 -公务员职级工资 206-警察工资制  207-法官职级工资制 208-检察官职级工资制
		and EXISTS (select 1 from t136 where t126.c39 = t136.c04) -- t126.c39 执行工资标准 关联 单位工资制度与人员属性信息对应关系t136.c04 执行工资标准
		and t126.c40 != 10831
		-- 2017-1-6改成 工资标准类别 码表
	  and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
	and not exists(select 1 from sys_s_data d where d.id = t126.c03 and d.typename = 'staffStatus' and d.data_value = '2')
	-- 非离休人员
	;
	select this_month_person_num into stempParam from fund_total_person_type_gov where unit_id = concat(v_unit_dataId,'') and fund_month = stempMonth and person_type = '1';-- 上月核定人数

	-- if byhdrsNum > 0 then
		-- 调入人员数量
		select count(1) into drNum from data_record_t126 a ,data_record_t125 b where  a.c01 = concat(v_unit_dataId,'') and a.fund_month = concat(v_i_fund_month,'')
		and a.changeSign = b.changeSign and concat(a.dataId,'') = b.c06 -- 变动记录表 相同变动标志 t125.c06 关联人员信息表
		and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in ( '201','206','207','208','209','210')) -- 人员工资制度为 公务员职级工资制 警察工资制  207-法官职级工资制 208-检察官职级工资制
		and exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = 'bdlx' and d.data_value = '09' )--  接收调入人员
		and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		;

		select count(1) into stemNum from data_record_t126 a,data_record_t125 b where  a.c01 = concat(v_unit_dataId,'') and a.fund_month = concat(v_i_fund_month,'')
		and a.changeSign = b.changeSign and concat(a.dataId,'') = b.c06
		and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in ( '201','206','207','208','209','210')) -- 人员工资制度为 公务员职级工资制 警察工资制  207-法官职级工资制 208-检察官职级工资制
		and exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = 'bdlx' and d.data_value = '06' )--  录入新进人员 t126.c40 人员信息-变动类型
		and exists(select 1 from sys_s_data d where d.id = a.c16 and d.typename = 'staffFrom'and d.data_value = '5') -- 调入 -- t126.c16 人员信息-人员来源
		and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		;
		set drNum = drNum + stemNum;-- 调入人员 由接收调入人员+新进人员(人员来源为调入的)数据量

		-- 公招数量
		select count(1) into gzNum from data_record_t126 a,data_record_t125 b where  a.c01 = concat(v_unit_dataId,'') and a.fund_month = concat(v_i_fund_month,'')
		and a.changeSign = b.changeSign and concat(a.dataId,'') = b.c06
		and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in ( '201','206','207','208','209','210')) -- 人员工资制度为 公务员职级工资制 警察工资制  207-法官职级工资制 208-检察官职级工资制
		and exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = 'bdlx' and d.data_value = '06' )--  录入新进人员 t126.c40 人员信息-变动类型
		and exists(select 1 from sys_s_data d where d.id = a.c16 and d.typename = 'staffFrom'and d.data_value in('0','1','2','3','9')) -- 公招 -- t126.c16 人员信息-人员来源
		and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		;


		-- 社招数量
		select count(1) into szNum from data_record_t126 a,data_record_t125 b where  a.c01 = concat(v_unit_dataId,'') and a.fund_month = concat(v_i_fund_month,'')
		and a.changeSign = b.changeSign and concat(a.dataId,'') = b.c06
		and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in ( '201','206','207','208','209','210')) -- 人员工资制度为 公务员职级工资制 警察工资制  207-法官职级工资制 208-检察官职级工资制
		and exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = 'bdlx' and d.data_value = '06' )--  录入新进人员 t126.c40 人员信息-变动类型
		and exists(select 1 from sys_s_data d where d.id = a.c16 and d.typename = 'staffFrom'and d.data_value = '4')  -- 社招 -- t126.c16 人员信息-人员来源
		and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		;
		-- 军转干部数量
		select count(1) into jzgbNum from data_record_t126 a,data_record_t125 b where  a.c01 = concat(v_unit_dataId,'') and a.fund_month = concat(v_i_fund_month,'')
		and a.changeSign = b.changeSign and concat(a.dataId,'') = b.c06
		and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in ( '201','206','207','208','209','210')) -- 人员工资制度为 公务员职级工资制 警察工资制  207-法官职级工资制 208-检察官职级工资制
		and exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = 'bdlx' and d.data_value = '06' )--  录入新进人员 t126.c40 人员信息-变动类型
		and exists(select 1 from sys_s_data d where d.id = a.c16 and d.typename = 'staffFrom'and d.data_value = '6') -- 军转干部 -- t126.c16 人员信息-人员来源
		and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		;
		-- 复退军人数量
		select count(1) into ftjrNum from data_record_t126 a,data_record_t125 b where  a.c01 = concat(v_unit_dataId,'') and a.fund_month = concat(v_i_fund_month,'')
		and a.changeSign = b.changeSign and concat(a.dataId,'') = b.c06
		and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in ( '201','206','207','208','209','210')) -- 人员工资制度为 公务员职级工资制 警察工资制 207-法官职级工资制 208-检察官职级工资制
		and exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = 'bdlx' and d.data_value = '06' )--  录入新进人员 t126.c40 人员信息-变动类型
		and exists(select 1 from sys_s_data d where d.id = a.c16 and d.typename = 'staffFrom'and d.data_value = '7') -- 复退军人 -- t126.c16 人员信息-人员来源
		and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		;
		-- 其它增加数量
		select count(1) into qtzjNum from data_record_t126 a,data_record_t125 b where  a.c01 = concat(v_unit_dataId,'') and a.fund_month = concat(v_i_fund_month,'')
		and a.changeSign = b.changeSign and concat(a.dataId,'') = b.c06
		and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in ( '201','206','207','208','209','210')) -- 人员工资制度为 公务员职级工资制 警察工资制 207-法官职级工资制 208-检察官职级工资制
		and exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = 'bdlx' and d.data_value = '06' )--  录入新进人员 t126.c40 人员信息-变动类型
		and exists(select 1 from sys_s_data d where d.id = a.c16 and d.typename = 'staffFrom'and d.data_value = '8') -- 其他
		and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		;
		select count(1) into @stemNum from data_record_t126 a ,data_record_t125 b where  a.c01 = concat(v_unit_dataId,'') and a.fund_month = concat(v_i_fund_month,'')
		and a.changeSign = b.changeSign and concat(a.dataId,'') = b.c06 -- 变动记录表 相同变动标志 t125.c06 关联人员信息表
		and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in ( '201','206','207','208','209','210')) -- 人员工资制度为 公务员职级工资制 警察工资制  207-法官职级工资制 208-检察官职级工资制
		and exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = 'bdlx' and d.data_value = '16' ) --  恢复发放工资
		and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		;
		-- 转岗公务员  和 不同职务序列
		select count(1) into @zhuanRenGWYNum from data_record_t126 a ,data_record_t125 b,data_record_t125 c where  a.c01 = concat(v_unit_dataId,'') and a.fund_month = concat(v_i_fund_month,'')
		and a.changeSign = b.changeSign and concat(a.dataId,'') = b.c06   and  concat(a.dataId,'') = c.c06 -- 变动记录表 相同变动标志 t125.c06 关联人员信息表
		and c.id =(select MAX(id) from data_record_t125 d where d.c06=b.c06 and d.id<b.id)
		and c.c36  in (10472,10473,10470,10471)  -- 事业  体育  机关工人  普通工
		and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in ( '201','206','207','208','209','210')) -- 人员工资制度为 公务员职级工资制 警察工资制  207-法官职级工资制 208-检察官职级工资制
		and exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = 'bdlx' and d.data_value in (0101,0107,8002,0112,0113,0114,0117,0118) ) --  转任公务员...
		and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		;
		set qtzjNum = qtzjNum + @stemNum+@zhuanRenGWYNum;

		set zjNum = drNum + gzNum + szNum + jzgbNum + ftjrNum + qtzjNum;
	-- end if;

	--  人员减少

	-- 退(离)休数量
	select count(1) into ltxNum from data_record_t126 a ,data_record_t125 b where  a.c01 = concat(v_unit_dataId,'') and a.fund_month = concat(v_i_fund_month,'')
	and a.changeSign = b.changeSign and concat(a.dataId,'') = b.c06 -- 变动记录表 相同变动标志 t125.c06 关联人员信息表
	and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in ( '201','206','207','208','209','210')) -- 人员工资制度为 公务员职级工资制 警察工资制
	and exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = 'bdlx' and d.data_value = '08' )
	and exists(select 1 from sys_s_data d where d.id = a.c46 and d.typename = 'ryqx' and d.data_value in ('1','2')) -- t126.c46 人员去向 1,离休 2-退休
	and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
	-- 非离休人员
	;
	-- 调出数量
	select count(1) into dcNum from data_record_t126 a ,data_record_t125 b where  a.c01 = concat(v_unit_dataId,'') and a.fund_month = concat(v_i_fund_month,'')
	and a.changeSign = b.changeSign and concat(a.dataId,'') = b.c06 -- 变动记录表 相同变动标志 t125.c06 关联人员信息表
	and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in ( '201','206','207','208','209','210')) -- 人员工资制度为 公务员职级工资制 警察工资制 207-法官职级工资制 208-检察官职级工资制
	and exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = 'bdlx' and d.data_value = '08' )
	and exists(select 1 from sys_s_data d where d.id = a.c46 and d.typename = 'ryqx' and d.data_value = '3') -- t126.c46 人员去向 3-调出
	and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
	-- 非离休人员
	;

	-- 死亡数量
	select count(1) into swNum from data_record_t126 a ,data_record_t125 b where  a.c01 = concat(v_unit_dataId,'') and a.fund_month = concat(v_i_fund_month,'')
	and a.changeSign = b.changeSign and concat(a.dataId,'') = b.c06 -- 变动记录表 相同变动标志 t125.c06 关联人员信息表
	and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in ( '201','206','207','208','209','210')) -- 人员工资制度为 公务员职级工资制 警察工资制 207-法官职级工资制 208-检察官职级工资制
	and exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = 'bdlx' and d.data_value = '08' )
	and exists(select 1 from sys_s_data d where d.id = a.c46 and d.typename = 'ryqx' and d.data_value = '10') -- t126.c46 人员去向 10-死亡
	and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
	-- 非离休人员
	;
	-- 辞职数量
	select count(1) into czNum from data_record_t126 a ,data_record_t125 b where  a.c01 = concat(v_unit_dataId,'') and a.fund_month = concat(v_i_fund_month,'')
	and a.changeSign = b.changeSign and concat(a.dataId,'') = b.c06 -- 变动记录表 相同变动标志 t125.c06 关联人员信息表
	and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in ( '201','206','207','208','209','210')) -- 人员工资制度为 公务员职级工资制 警察工资制 207-法官职级工资制 208-检察官职级工资制
	and exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = 'bdlx' and d.data_value = '08' )
	and exists(select 1 from sys_s_data d where d.id = a.c46 and d.typename = 'ryqx' and d.data_value = '6') -- t126.c46 人员去向 6-辞职
	and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
	-- 非离休人员
	;

	-- 辞退数量
	select count(1) into ctNum from data_record_t126 a ,data_record_t125 b where  a.c01 = concat(v_unit_dataId,'') and a.fund_month = concat(v_i_fund_month,'')
	and a.changeSign = b.changeSign and concat(a.dataId,'') = b.c06 -- 变动记录表 相同变动标志 t125.c06 关联人员信息表
	and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in ( '201','206','207','208','209','210')) -- 人员工资制度为 公务员职级工资制 警察工资制 207-法官职级工资制 208-检察官职级工资制
	and exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = 'bdlx' and d.data_value = '08' )
	and exists(select 1 from sys_s_data d where d.id = a.c46 and d.typename = 'ryqx' and d.data_value = '7') -- t126.c46 人员去向 7-辞退
	and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
	-- 非离休人员
	;
	-- 开除数量
	select count(1) into kcNum from data_record_t126 a ,data_record_t125 b where  a.c01 = concat(v_unit_dataId,'') and a.fund_month = concat(v_i_fund_month,'')
	and a.changeSign = b.changeSign and concat(a.dataId,'') = b.c06 -- 变动记录表 相同变动标志 t125.c06 关联人员信息表
	and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in ( '201','206','207','208','209','210')) -- 人员工资制度为 公务员职级工资制 警察工资制 207-法官职级工资制 208-检察官职级工资制
	and exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = 'bdlx' and d.data_value = '08' )
	and exists(select 1 from sys_s_data d where d.id = a.c46 and d.typename = 'ryqx' and d.data_value = '8') -- t126.c46 人员去向 8-开除
	and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
	-- 非离休人员
	;
	-- 自动离职数量
	select count(1) into zdlzNum from data_record_t126 a ,data_record_t125 b where  a.c01 = concat(v_unit_dataId,'') and a.fund_month = concat(v_i_fund_month,'')
	and a.changeSign = b.changeSign and concat(a.dataId,'') = b.c06 -- 变动记录表 相同变动标志 t125.c06 关联人员信息表
	and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in ( '201','206','207','208','209','210')) -- 人员工资制度为 公务员职级工资制 警察工资制 207-法官职级工资制 208-检察官职级工资制
	and exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = 'bdlx' and d.data_value = '08' )
	and exists(select 1 from sys_s_data d where d.id = a.c46 and d.typename = 'ryqx' and d.data_value = '9') -- t126.c46 人员去向 9-自动离职
	and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
	-- 非离休人员
	;

	-- 其他减少数量数量
	select count(1) into qtjsNum from data_record_t126 a ,data_record_t125 b where  a.c01 = concat(v_unit_dataId,'') and a.fund_month = concat(v_i_fund_month,'')
	and a.changeSign = b.changeSign and concat(a.dataId,'') = b.c06 -- 变动记录表 相同变动标志 t125.c06 关联人员信息表
	and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in ( '201','206','207','208','209','210')) -- 人员工资制度为 公务员职级工资制 警察工资制 207-法官职级工资制 208-检察官职级工资制
	and exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = 'bdlx' and d.data_value = '08' )
	and exists(select 1 from sys_s_data d where d.id = a.c46 and d.typename = 'ryqx' and d.data_value in('4','5','11','15')) -- t126.c46 人员去向 -其他减少数量 4-辞聘 5-解聘 11-解除(终止)合同
	and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
	-- 非离休人员
	;
	-- 机关转事业或机关工人转岗减少人员 and 不同职务序列
	select count(1) into @zhuanGangjsNum from data_record_t126 a ,data_record_t125 b,data_record_t125 c where  a.c01 = concat(v_unit_dataId,'') and a.fund_month = concat(v_i_fund_month,'')
	and a.changeSign = b.changeSign and concat(a.dataId,'') = b.c06  and  concat(a.dataId,'') = c.c06 -- 变动记录表 相同变动标志 t125.c06 关联人员信息表
	and c.id =(select MAX(id) from data_record_t125 d where d.c06=b.c06 and d.id<b.id)
	and c.c36  in (10469,11172,11270,11271,11543,11544)  -- 公务员工资制 ， 警察，  法 ， 检  工资制
	and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value  in ( '202','203','204','205')) -- 人员工资制度机关工人 普通工，事业，体育
	and exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = 'bdlx' and d.data_value in( '0102','0103','0104','0105','8002') )
	and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
	-- 非离休人员
	;
	-- 20171130 确认问题：核定表减少人数不计算停发工资人员  也就是说停发工资人员不是减少类型
	/*select count(1) into @stemNum from data_record_t126 a ,data_record_t125 b where  a.c01 = concat(v_unit_dataId,'') and a.fund_month = concat(v_i_fund_month,'')
		and a.changeSign = b.changeSign and concat(a.dataId,'') = b.c06 -- 变动记录表 相同变动标志 t125.c06 关联人员信息表
		and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in ( '201','206','207','208','209','210')) -- 人员工资制度为 公务员职级工资制 警察工资制  207-法官职级工资制 208-检察官职级工资制
		and exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = 'bdlx' and d.data_value = '15' ) --  停发工资
		and not exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = 'bdlx' and d.data_value = '08' )
		and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		;*/
	set qtjsNum = qtjsNum + @zhuanGangjsNum;

	set jsNum = ltxNum + dcNum + swNum + czNum + ctNum + kcNum + zdlzNum + qtjsNum ;

	delete from fund_total_person_type_gov where fund_month  = concat(v_i_fund_month,'') and unit_id = concat(v_unit_dataId,'') and person_type = '1';-- 如果系统里面已经存在,先删除

	INSERT INTO fund_total_person_type_gov(fund_month,unit_id,unit_code,person_type,pre_month_person_num,
	increase_part_total,dr_num,gz_num,sz_num,jz_num,ftjr_num,other_incr_num,
	decrease_part_total,tlx_num,dc_num,cz_num,ct_num,kc_num,zdlz_num,sw_num,other_decr_num,
	this_month_person_num)
	values( v_i_fund_month,v_unit_dataId,v_unit_id,'1' ,stempParam,
	zjNum,drNum,gzNum,szNum,jzgbNum,ftjrNum,qtzjNum,
	jsNum,ltxNum,dcNum,czNum,ctNum,kcNum,zdlzNum,swNum,qtjsNum,
	byhdrsNum );-- 公务员(参公)
/*相关数据设为0  避免后面身份使用时不为0*/
	set zjNum = 0,stempParam=0,drNum=0,gzNum=0,szNum=0,jzgbNum=0,ftjrNum=0,qtzjNum=0,
	jsNum=0,ltxNum=0,dcNum=0,czNum=0,ctNum=0,kcNum=0,zdlzNum=0,swNum=0,qtjsNum=0,
	byhdrsNum=0;

	-- 所有 机关工人 总人数
	SELECT count(1) into byhdrsNum from t126 ,t125,sys_s_data d
		where t125.c06 = concat(t126.id,'') and t126.c01 = concat(v_unit_dataId,'')
		and t125.c36 = concat(d.id,'') and  d.data_value in (202,203) -- t125.c36 人员工资制度为 202 -机关技工岗位等级工资制 203-机关普工岗位工资制
		and EXISTS (select 1 from t136 where t126.c39 = t136.c04) -- t126.c39 执行工资标准 关联 单位工资制度与人员属性信息对应关系t136.c04 执行工资标准
		and t126.c40 != 10831
		-- 2017-1-6改成 工资标准类别 码表
		and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1') -- t126.c03 人员状态-码表 1-在职
		-- and not exists (select 1 from sys_s_data d where d.id = t126.c43 and d.typename = 'is' and d.data_value = '1') -- 不是停发工资的人员
		and not exists(select 1 from sys_s_data d where d.id = t126.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		;

	select count(1) into stempParam from fund_total_person_type_gov where unit_id = concat(v_unit_dataId,'') and fund_month = stempMonth and person_type = '2';-- 上月核定人数
	if stempParam > 0 then
		select ifnull(this_month_person_num,'') into stempParam from fund_total_person_type_gov where unit_id = concat(v_unit_dataId,'') and fund_month = stempMonth and person_type = '2';-- 上月核定人数
	end if;

	-- if byhdrsNum > 0 then
		-- 调入人员数量
		select count(1) into drNum from data_record_t126 a ,data_record_t125 b where  a.c01 = concat(v_unit_dataId,'') and a.fund_month = concat(v_i_fund_month,'')
		and a.changeSign = b.changeSign and concat(a.dataId,'') = b.c06 -- 变动记录表 相同变动标志 t125.c06 关联人员信息表
		and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in (202,203)) -- 人员工资制度为 202 -机关技工岗位等级工资制 203-机关普工岗位工资制
		and exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = 'bdlx' and d.data_value = '09' ) --  接收调入人员
		and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		;
		select count(1) into stemNum from data_record_t126 a,data_record_t125 b where  a.c01 = concat(v_unit_dataId,'') and a.fund_month = concat(v_i_fund_month,'')
		and a.changeSign = b.changeSign and concat(a.dataId,'') = b.c06
		and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in (202,203)) -- 人员工资制度为 202 -机关技工岗位等级工资制 203-机关普工岗位工资制
		and exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = 'bdlx' and d.data_value = '06' )--  录入新进人员 t126.c40 人员信息-变动类型
		and exists(select 1 from sys_s_data d where d.id = a.c16 and d.typename = 'staffFrom'and d.data_value = '5') -- 调入 -- t126.c16 人员信息-人员来源
		and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		;
		set drNum = drNum + stemNum;-- 调入人员 由接收调入人员+新进人员(人员来源为调入的)数据量

		-- 公招数量
		select count(1) into gzNum from data_record_t126 a,data_record_t125 b where  a.c01 = concat(v_unit_dataId,'') and a.fund_month = concat(v_i_fund_month,'')
		and a.changeSign = b.changeSign and concat(a.dataId,'') = b.c06
		and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in (202,203)) -- 人员工资制度为 202 -机关技工岗位等级工资制 203-机关普工岗位工资制
		and exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = 'bdlx' and d.data_value = '06' )--  录入新进人员 t126.c40 人员信息-变动类型
		and exists(select 1 from sys_s_data d where d.id = a.c16 and d.typename = 'staffFrom'and d.data_value in('0','1','2','3','9')) -- 公招 -- t126.c16 人员信息-人员来源
		and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		;

		-- 社招数量
		select count(1) into szNum from data_record_t126 a,data_record_t125 b where  a.c01 = concat(v_unit_dataId,'') and a.fund_month = concat(v_i_fund_month,'')
		and a.changeSign = b.changeSign and concat(a.dataId,'') = b.c06
		and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in (202,203)) -- 人员工资制度为 202 -机关技工岗位等级工资制 203-机关普工岗位工资制
		and exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = 'bdlx' and d.data_value = '06' )--  录入新进人员 t126.c40 人员信息-变动类型
		and exists(select 1 from sys_s_data d where d.id = a.c16 and d.typename = 'staffFrom'and d.data_value = '4')  -- 社招 -- t126.c16 人员信息-人员来源
		and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		;
		-- 军转干部数量
		select count(1) into jzgbNum from data_record_t126 a,data_record_t125 b where  a.c01 = concat(v_unit_dataId,'') and a.fund_month = concat(v_i_fund_month,'')
		and a.changeSign = b.changeSign and concat(a.dataId,'') = b.c06
		and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in (202,203)) -- 人员工资制度为 202 -机关技工岗位等级工资制 203-机关普工岗位工资制
		and exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = 'bdlx' and d.data_value = '06' )--  录入新进人员 t126.c40 人员信息-变动类型
		and exists(select 1 from sys_s_data d where d.id = a.c16 and d.typename = 'staffFrom'and d.data_value = '6') -- 军转干部 -- t126.c16 人员信息-人员来源
		and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		;
		-- 复退军人数量
		select count(1) into ftjrNum from data_record_t126 a,data_record_t125 b where  a.c01 = concat(v_unit_dataId,'') and a.fund_month = concat(v_i_fund_month,'')
		and a.changeSign = b.changeSign and concat(a.dataId,'') = b.c06
		and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in (202,203)) -- 人员工资制度为 202 -机关技工岗位等级工资制 203-机关普工岗位工资制
		and exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = 'bdlx' and d.data_value = '06' )--  录入新进人员 t126.c40 人员信息-变动类型
		and exists(select 1 from sys_s_data d where d.id = a.c16 and d.typename = 'staffFrom'and d.data_value = '7') -- 复退军人 -- t126.c16 人员信息-人员来源
		and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		;
		-- 其它增加数量
		select count(1) into qtzjNum from data_record_t126 a,data_record_t125 b where  a.c01 = concat(v_unit_dataId,'') and a.fund_month = concat(v_i_fund_month,'')
		and a.changeSign = b.changeSign and concat(a.dataId,'') = b.c06
		and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in (202,203)) -- 人员工资制度为 202 -机关技工岗位等级工资制 203-机关普工岗位工资制
		and exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = 'bdlx' and d.data_value = '06' )--  录入新进人员 t126.c40 人员信息-变动类型
		and exists(select 1 from sys_s_data d where d.id = a.c16 and d.typename = 'staffFrom'and d.data_value = '8')  -- 社招 其他
		and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		;
		-- 转任机关工人 and 处分成机关工人 不同职务序列
		select count(1) into @zhuanRenJGGR from data_record_t126 a,data_record_t125 b,data_record_t125 c where  a.c01 = concat(v_unit_dataId,'') and a.fund_month = concat(v_i_fund_month,'')
		and a.changeSign = b.changeSign and concat(a.dataId,'') = b.c06  and  concat(a.dataId,'') = c.c06
		and c.id =(select MAX(id) from data_record_t125 d where d.c06=b.c06 and d.id<b.id)
		and c.c36 not  in (10470,10471)  --   工人  普通工
		and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in (202,203)) -- 人员工资制度为 202 -机关技工岗位等级工资制 203-机关普工岗位工资制
		and exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = 'bdlx' and d.data_value in( '0105' ,'8002'))--
		and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		;

		select count(1) into @stemNum from data_record_t126 a ,data_record_t125 b where  a.c01 = concat(v_unit_dataId,'') and a.fund_month = concat(v_i_fund_month,'')
		and a.changeSign = b.changeSign and concat(a.dataId,'') = b.c06 -- 变动记录表 相同变动标志 t125.c06 关联人员信息表
		and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in (202,203)) -- 人员工资制度为 202 -机关技工岗位等级工资制 203-机关普工岗位工资制
		and exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = 'bdlx' and d.data_value = '16' ) --  恢复发放工资
		and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		;
		set qtzjNum = qtzjNum + @stemNum+@zhuanRenJGGR;

		set zjNum = drNum + gzNum + szNum + jzgbNum + ftjrNum + qtzjNum;

	-- end if;


		--  人员减少

		-- 退(离)休数量
		select count(1) into ltxNum from data_record_t126 a ,data_record_t125 b where  a.c01 = concat(v_unit_dataId,'') and a.fund_month = concat(v_i_fund_month,'')
		and a.changeSign = b.changeSign and concat(a.dataId,'') = b.c06 -- 变动记录表 相同变动标志 t125.c06 关联人员信息表
		and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in (202,203)) -- 人员工资制度为 202 -机关技工岗位等级工资制 203-机关普工岗位工资制
		and exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = 'bdlx' and d.data_value = '08' )
		and exists(select 1 from sys_s_data d where d.id = a.c46 and d.typename = 'ryqx' and d.data_value in ('1','2')) -- t126.c46 人员去向 1,离休 2-退休
		and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		;
		-- 调出数量
		select count(1) into dcNum from data_record_t126 a ,data_record_t125 b where  a.c01 = concat(v_unit_dataId,'') and a.fund_month = concat(v_i_fund_month,'')
		and a.changeSign = b.changeSign and concat(a.dataId,'') = b.c06 -- 变动记录表 相同变动标志 t125.c06 关联人员信息表
		and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in (202,203)) -- 人员工资制度为 202 -机关技工岗位等级工资制 203-机关普工岗位工资制
		and exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = 'bdlx' and d.data_value = '08' )
		and exists(select 1 from sys_s_data d where d.id = a.c46 and d.typename = 'ryqx' and d.data_value = '3') -- t126.c46 人员去向 3-调出
		and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		;
		-- 死亡数量
		select count(1) into swNum from data_record_t126 a ,data_record_t125 b where  a.c01 = concat(v_unit_dataId,'') and a.fund_month = concat(v_i_fund_month,'')
		and a.changeSign = b.changeSign and concat(a.dataId,'') = b.c06 -- 变动记录表 相同变动标志 t125.c06 关联人员信息表
		and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in (202,203)) -- 人员工资制度为 202 -机关技工岗位等级工资制 203-机关普工岗位工资制
		and exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = 'bdlx' and d.data_value = '08' )
		and exists(select 1 from sys_s_data d where d.id = a.c46 and d.typename = 'ryqx' and d.data_value = '10')-- t126.c46 人员去向 10-死亡
		and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		;
		-- 辞职数量
		select count(1) into czNum from data_record_t126 a ,data_record_t125 b where  a.c01 = concat(v_unit_dataId,'') and a.fund_month = concat(v_i_fund_month,'')
		and a.changeSign = b.changeSign and concat(a.dataId,'') = b.c06 -- 变动记录表 相同变动标志 t125.c06 关联人员信息表
		and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in (202,203)) -- 人员工资制度为 202 -机关技工岗位等级工资制 203-机关普工岗位工资制
		and exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = 'bdlx' and d.data_value = '08' )
		and exists(select 1 from sys_s_data d where d.id = a.c46 and d.typename = 'ryqx' and d.data_value = '6') -- t126.c46 人员去向 6-辞职
		and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		;
		-- 辞退数量
		select count(1) into ctNum from data_record_t126 a ,data_record_t125 b where  a.c01 = concat(v_unit_dataId,'') and a.fund_month = concat(v_i_fund_month,'')
		and a.changeSign = b.changeSign and concat(a.dataId,'') = b.c06 -- 变动记录表 相同变动标志 t125.c06 关联人员信息表
		and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in (202,203)) -- 人员工资制度为 202 -机关技工岗位等级工资制 203-机关普工岗位工资制
		and exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = 'bdlx' and d.data_value = '08' )
		and exists(select 1 from sys_s_data d where d.id = a.c46 and d.typename = 'ryqx' and d.data_value = '7') -- t126.c46 人员去向 7-辞退
		and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		;
		-- 开除数量
		select count(1) into kcNum from data_record_t126 a ,data_record_t125 b where  a.c01 = concat(v_unit_dataId,'') and a.fund_month = concat(v_i_fund_month,'')
		and a.changeSign = b.changeSign and concat(a.dataId,'') = b.c06 -- 变动记录表 相同变动标志 t125.c06 关联人员信息表
		and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in (202,203)) -- 人员工资制度为 202 -机关技工岗位等级工资制 203-机关普工岗位工资制
		and exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = 'bdlx' and d.data_value = '08' )
		and exists(select 1 from sys_s_data d where d.id = a.c46 and d.typename = 'ryqx' and d.data_value = '8') -- t126.c46 人员去向 8-开除
		and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		;
		-- 自动离职数量
		select count(1) into zdlzNum from data_record_t126 a ,data_record_t125 b where  a.c01 = concat(v_unit_dataId,'') and a.fund_month = concat(v_i_fund_month,'')
		and a.changeSign = b.changeSign and concat(a.dataId,'') = b.c06 -- 变动记录表 相同变动标志 t125.c06 关联人员信息表
		and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in (202,203)) -- 人员工资制度为 202 -机关技工岗位等级工资制 203-机关普工岗位工资制
		and exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = 'bdlx' and d.data_value = '08' )
		and exists(select 1 from sys_s_data d where d.id = a.c46 and d.typename = 'ryqx' and d.data_value = '9') -- t126.c46 人员去向 9-自动离职
		and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		;
		-- 其他减少数量数量
		select count(1) into qtjsNum from data_record_t126 a ,data_record_t125 b where  a.c01 = concat(v_unit_dataId,'') and a.fund_month = concat(v_i_fund_month,'')
		and a.changeSign = b.changeSign and concat(a.dataId,'') = b.c06 -- 变动记录表 相同变动标志 t125.c06 关联人员信息表
		and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in (202,203)) -- 人员工资制度为 202 -机关技工岗位等级工资制 203-机关普工岗位工资制
		and exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = 'bdlx' and d.data_value = '08' )
		and exists(select 1 from sys_s_data d where d.id = a.c46 and d.typename = 'ryqx' and d.data_value in('4','5','11','15')) -- t126.c46 人员去向 -其他减少数量 4-辞聘 5-解聘
		and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		;
		-- 机关工人转岗其他和处分
		select count(1) into @ZGandCF from data_record_t126 a ,data_record_t125 b,data_record_t125 c where  a.c01 = concat(v_unit_dataId,'') and a.fund_month = concat(v_i_fund_month,'')
		and a.changeSign = b.changeSign and concat(a.dataId,'') = b.c06   and  concat(a.dataId,'') = c.c06 -- 变动记录表 相同变动标志 t125.c06 关联人员信息表
		and c.id =(select MAX(id) from data_record_t125 d where d.c06=b.c06 and d.id<b.id)
		and c.c36  in (10470,10471)  -- 机关工人  普通工
		and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value not in (202,203)) -- 人员工资制度为 202 -机关技工岗位等级工资制 203-机关普工岗位工资制
		and exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = 'bdlx' and d.data_value in( '0101','0102','0103','0104','0107','8002','0112','0113','0114','0115','0116','0117','0118') )
		and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		;
		/*select count(1) into @stemNum from data_record_t126 a ,data_record_t125 b where  a.c01 = concat(v_unit_dataId,'') and a.fund_month = concat(v_i_fund_month,'')
		and a.changeSign = b.changeSign and concat(a.dataId,'') = b.c06 -- 变动记录表 相同变动标志 t125.c06 关联人员信息表
		and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in (202,203)) -- 人员工资制度为 202 -机关技工岗位等级工资制 203-机关普工岗位工资制
		and exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = 'bdlx' and d.data_value = '15' ) -- 停发工资
		and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		;*/
		set qtjsNum = qtjsNum + @ZGandCF;

		set jsNum = ltxNum + dcNum + swNum + czNum + ctNum + kcNum + zdlzNum + qtjsNum ;

	delete from fund_total_person_type_gov where fund_month  = concat(v_i_fund_month,'') and unit_id = concat(v_unit_dataId,'')
	and person_type = '2';-- 如果系统里面已经存在,先删除
	 if byhdrsNum > 0 || jsNum >0 then -- 机关工勤人员人数为0 或减少人员大于0
		 INSERT INTO fund_total_person_type_gov(fund_month,unit_id,unit_code,person_type,pre_month_person_num,
			increase_part_total,dr_num,gz_num,sz_num,jz_num,ftjr_num,other_incr_num,
			decrease_part_total,tlx_num,dc_num,cz_num,ct_num,kc_num,zdlz_num,sw_num,other_decr_num,
			this_month_person_num)
			values( v_i_fund_month,v_unit_dataId,v_unit_id,'2' ,stempParam,
			zjNum,drNum,gzNum,szNum,jzgbNum,ftjrNum,qtzjNum,
			jsNum,ltxNum,dcNum,czNum,ctNum,kcNum,zdlzNum,swNum,qtjsNum,
			byhdrsNum );-- 机关工勤
	 end if;

	-- fund_total_person_gov  机关总人数核定表  存放编制等相关信息

	delete from fund_total_person_gov where unit_id = concat(v_unit_dataId,'') and fund_month  = concat(v_i_fund_month,'') ;-- 如果系统里面已经存在,先删除

	INSERT INTO fund_total_person_gov(fund_month,unit_id,unit_code,cz_code,czgy_num,cztf_num,xzbz_num,xzbz_sj_num,dlbz_num,dlbz_sj_num,jjbz_num,jjbz_sj_num,jzbz_num,jzbz_sj_num,zfzxbz_num,zfzxbz_sj_num,
		qebk_num,qebk_sj_num,xzzf_num,xzzf_sj_num,jggc_num,jggc_sj_num,cebk_num,cebk_sj_num,zszz_num,zszz_sj_num)
	values(v_i_fund_month,v_unit_dataId,v_unit_id,czbm,czgyNum,cztfNum,xzbzNum,xzbzSjNum,dlbzNum,dlbzSjNum,jjbzNum,jjbzSjNum,jzbzNum,jzbzSjNum,zfzxbzNum,zfzxbzSjNum,
		qebkNum,qebkSjNum,xzzfNum,xzzfSjNum,jggcNum,jggcSjNum,cebkNum,cebkSjNum,zszzNum,zszzSjNum);

	delete from fund_total_gov where fund_month  = concat(v_i_fund_month,'') and unit_id = concat(v_unit_dataId,'');-- 如果系统里面已经存在,先删除

	select  DATE_FORMAT( DATE_SUB(concat(v_i_fund_month,'01'),INTERVAL 1 month),'%Y%m') into stempParam; -- 上一个月的月结算工资数据
	-- 上月核定工资总额
	INSERT INTO fund_total_gov(fund_month,unit_id,unit_code,change_type,change_person_num,
				total_salary,part_total_salary,zwgz_salary,gwgz_salary,ycxbkf_salary,jbt_salary
				,jbt_code_salary)
				-- 工资合计   工资小计					职务工资  级别工资  一次性补扣发 津补贴小计
				/*,total_salary,part_total_salary,zwgz_salary,gwgz_salary,
		dszn_salary,llt_salary,ggbl_salary,hmbt_salary,jjbabt_salary,xfgzry_salary,zsjz_salary,gwygfh_salary,ycxbkf_salary*/
		select  v_i_fund_month,unit_id,unit_code,'上月核定工资总额',change_person_num,
				total_salary,part_total_salary,zwgz_salary,gwgz_salary,ycxbkf_salary,jbt_salary
		-- 工资合计   工资小计 职务工资  级别工资 津补贴小计
			,jbt_code_salary
		from fund_total_gov where 1=1
		and unit_id = concat(v_unit_dataId,'') and fund_month = stempParam and change_type = '本月核定工资总额'
		;-- 根据变动类型分组 -- allAuditFlag = 9 表示 基金生成未上报

	-- fund_total_gov 机关变动原因/类型核定表
	select count(1) into stemNum from data_record_t126 where  c01 = concat(v_unit_dataId,'')
	 and ifnull(allAuditFlag,'')!='2';-- 查询本次月报所有变动记录(前面所有未审核通过的都是)

	if stemNum > 0 then -- 变动记录>0
		-- 录入新进人员
		/*
		INSERT INTO fund_total_gov(fund_month,unit_id,unit_code,change_type,changetype_name,change_person_num,
				total_salary,part_total_salary,zwgz_salary,gwgz_salary,jbt_salary,ycxbkf_salary)
				-- 工资合计   工资小计					职务工资  级别工资 津补贴小计  一次性补扣发
				-- ,total_salary,part_total_salary,zwgz_salary,gwgz_salary,
		-- dszn_salary,llt_salary,ggbl_salary,hmbt_salary,jjbabt_salary,xfgzry_salary,zsjz_salary,gwygfh_salary,ycxbkf_salary
		select  v_i_fund_month,v_unit_dataId,v_unit_id,a.changeType,concat('起薪','(',(select d.name from sys_s_data d where d.id = a.c16),')'),count(1) ,
		case when PERIOD_DIFF(v_i_fund_month,replace(b.c02,'-',''))>0 then sum(PERIOD_DIFF(v_i_fund_month,replace(b.c02,'-',''))*b.c32)
		else sum(b.c32) end,
		sum(c.total_salary_bf),sum(c.total_salary),sum(c.zwgz), sum(c.gwgz),sum(c.jbt_salary)
		-- 工资总计   工资合计  职务工资  级别工资 津补贴小计
		from data_data_record a join data_data_record b on a.dataId = b.c06 left join fund_salary_fill_',v_i_fund_month,' c
		on a.changeSign = c.changeSign
		where a.dataclassCode = 't126' and b.dataclassCode = 't125' and b.c06 = a.dataId
		 and  a.allAuditFlag='9' and a.c01 = v_unit_dataId  and a.changeSign = b.changeSign
		and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in (201,206,202,203,207,208,209,210)) -- 人员工资制度为 201-公务员职级工资制 206-警察职级工资制 202 -机关技工岗位等级工资制 203-机关普工岗位工资制  207-法官职级工资制 208-检察官职级工资制
		and a.changeType = 10750 -- 录入新进人员
		group by concat(a.changeType,a.c16); -- 根据变动类型分组 -- allAuditFlag = 9 表示 基金生成未上报
		*/

		-- 录入新进人员
		INSERT INTO fund_total_gov(fund_month,unit_id,unit_code,change_type,changetype_name,change_person_num,
				total_salary,part_total_salary,zwgz_salary,gwgz_salary,jbt_salary,ycxbkf_salary,jbt_code_salary)
				-- 工资合计   工资小计					职务工资  级别工资 津补贴小计  一次性补扣发 津补贴项目金额
				/*,total_salary,part_total_salary,zwgz_salary,gwgz_salary,
		dszn_salary,llt_salary,ggbl_salary,hmbt_salary,jjbabt_salary,xfgzry_salary,zsjz_salary,gwygfh_salary,ycxbkf_salary*/
		select  v_i_fund_month,v_unit_dataId,v_unit_id,a.changeType,concat('起薪','(',(select d.name from sys_s_data d where d.id = a.c16),')'),count(1) ,
		sum((PERIOD_DIFF(v_i_fund_month,replace(b.c02,'-',''))+1)*b.c32),
		sum(b.c32),sum(b.c25),sum(b.c26), sum(b.c27),sum(PERIOD_DIFF(v_i_fund_month,replace(b.c02,'-',''))*b.c32),
		(select group_concat(z.c02,'-',case when round(z.je ,2) = 0 then '' else round(z.je ,2) end ) from (
			select t116.c02,sum(c.c07) as je,concat(a.changeType,a.c16) as changeName from data_record_t126 a
		join data_record_t125 b on a.changeSign = b.changeSign
		join data_record_t117 c
			on  c.changeSign = a.changeSign join t116 on c.c04=t116.id
			where c.dataclassCode= 't117' and  a.dataclassCode = 't126' and b.dataclassCode = 't125'
		 	and a.c01 = concat(v_unit_dataId,'') and  a.allAuditFlag='9'
		 	and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in(201,206,202,203,207,208,209,210)) -- 人员工资制度为 201-公务员职级工资制 206-警察职级工资制 202 -机关技工岗位等级工资制 203-机关普工岗位工资制  207-法官职级工资制 208-检察官职级工资制 209-公安机关执法勤务警员职级工资制 210-公安机关警务技术人民警察职级工资制
			and a.changeType = lrxjryCode -- 录入新进人员
			group by t116.c02,concat(a.changeType,a.c16))
		z where z.changeName = concat(a.changeType,a.c16))
		-- 工资合计   工资小计 职务工资  级别工资 津补贴小计
		from data_record_t126 a ,data_record_t125 b
		where a.dataclassCode = 't126' and b.dataclassCode = 't125' and b.c06 = a.dataId
		 and a.c01 = concat(v_unit_dataId,'') and  a.allAuditFlag='9'  and a.changeSign = b.changeSign
		and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in(201,206,202,203,207,208,209,210)) -- 人员工资制度为 201-公务员职级工资制 206-警察职级工资制 202 -机关技工岗位等级工资制 203-机关普工岗位工资制  207-法官职级工资制 208-检察官职级工资制 209-公安机关执法勤务警员职级工资制 210-公安机关警务技术人民警察职级工资制
		and a.changeType = lrxjryCode -- 录入新进人员
		and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		group by concat(a.changeType,a.c16); -- 根据变动类型分组 -- allAuditFlag = 9 表示 基金生成未上报

		-- 恢复发放工资
	/**
		set @sqlstr = concat('INSERT INTO fund_total_gov(fund_month,unit_id,unit_code,change_type,changetype_name,change_person_num,
				total_salary,part_total_salary,zwgz_salary,gwgz_salary,jbt_salary,ycxbkf_salary,jbt_code_salary)
				-- 工资总计   工资合计					职务工资  级别工资 津补贴小计  一次性补扣发 津补贴项目金额

		select  ',v_i_fund_month,',',v_unit_dataId,',',v_unit_id,',a.changeType,e.name,count(1) ,
		-- case when PERIOD_DIFF(v_i_fund_month,replace(b.c02,\'-\',\'\'))>0 then sum(PERIOD_DIFF(v_i_fund_month,replace(b.c02,\'-\',\'\'))*b.c32)
		-- else sum(b.c32) end,
		sum(c.total_salary_bf),sum(c.part_total_salary),sum(c.zwgz), sum(c.gwgz),sum(c.jbt_salary),sum(c.total_salary_bf),
		-- 工资总计   工资合计  职务工资  级别工资 津补贴小计
		(select group_concat(t116.c02,\'-\',c.c07) from data_data_record c join t116 on c.c04=t116.id
			where c.dataclassCode= \'t117\' and c.changeSign = a.changeSign)
		from data_data_record a join data_data_record b on a.changeSign = b.changeSign join sys_s_data e
		on a.changeType = e.id
		left join fund_salary_fill_',v_i_fund_month,' c
		on a.changeSign = c.changeSign
		where a.dataclassCode = \'t126\' and b.dataclassCode = \'t125\' and b.c06 = a.dataId
		 and  a.allAuditFlag=\'9\' and a.c01 = ',v_unit_dataId,'  and a.changeSign = b.changeSign
		and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = \'wageSystem\' and d.data_value in (201,206,202,203,207,208,209,210)) -- 人员工资制度为 201-公务员职级工资制 206-警察职级工资制 202 -机关技工岗位等级工资制 203-机关普工岗位工资制  207-法官职级工资制 208-检察官职级工资制
		and e.data_value = \'16\' -- 恢复发放工资
		group by concat(a.changeType,a.c16)'); -- 根据变动类型分组 -- allAuditFlag = 9 表示 基金生成未上报

		PREPARE stmt FROM @sqlstr;
		EXECUTE stmt;
		*/


		-- 人员基本信息修改
		INSERT INTO fund_total_gov(fund_month,unit_id,unit_code,change_type,change_person_num
				-- ,total_salary,part_total_salary,zwgz_salary,gwgz_salary,jbt_salary
		)
				-- 工资合计   工资小计					职务工资  级别工资 津补贴小计  一次性补扣发
				/*,total_salary,part_total_salary,zwgz_salary,gwgz_salary,
		dszn_salary,llt_salary,ggbl_salary,hmbt_salary,jjbabt_salary,xfgzry_salary,zsjz_salary,gwygfh_salary,ycxbkf_salary*/
		select  v_i_fund_month,v_unit_dataId,v_unit_id,a.changeType,count(1)
		-- ,sum(b.c32),sum(b.c32),sum(b.c25),sum(b.c26), sum(b.c27)
		-- 工资合计   工资小计 职务工资  级别工资 津补贴小计
		from data_record_t126 a ,data_record_t125 b
		where a.dataclassCode = 't126' and b.dataclassCode = 't125' and b.c06 = a.dataId
		 and  a.c01 = concat(v_unit_dataId,'') and a.allAuditFlag='9'  and a.changeSign = b.changeSign
		and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in (201,206,202,203,207,208,209,210)) -- 人员工资制度为 201-公务员职级工资制 206-警察职级工资制 202 -机关技工岗位等级工资制 203-机关普工岗位工资制 207-法官职级工资制 208-检察官职级工资制 209-公安机关执法勤务警员职级工资制 210-公安机关警务技术人民警察职级工资制
		and a.changeType = jbxxxgCode -- 人员基本信息修改
		and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		group by a.changeType; -- 根据变动类型分组 -- allAuditFlag = 9 表示 基金生成未上报

		-- 人员减少
		SET @sqlstr = CONCAT('INSERT INTO fund_total_gov(fund_month,unit_id,unit_code,change_type,changetype_name,change_person_num,
				total_salary,part_total_salary,zwgz_salary,gwgz_salary,jbt_salary,ycxbkf_salary
				-- 工资合计   工资小计					职务工资  级别工资 津补贴小计  一次性补扣发
				-- ,jstg10 ,tsjy15 ,blzxx10
				-- 中小学教师或护士提高10%  特殊教育提高15% 退役运动员保留工资额度;-- 原 中小学教师保留10%
				-- ,blhs10 ,bltg ,psxlj
				-- 在护士岗位工作满20年并在医疗卫生机构工作的保留原提高10% 保留原特殊岗位活工资比例提高部分 运动员平时训练奖
				-- ,jxgz
				--  绩效工资
				,jbt_code_salary  )
				-- 津补贴项目-金额
				/*,total_salary,part_total_salary,zwgz_salary,gwgz_salary,
			dszn_salary,llt_salary,ggbl_salary,hmbt_salary,jjbabt_salary,xfgzry_salary,zsjz_salary,gwygfh_salary,ycxbkf_salary*/
		select  ',v_i_fund_month,',',v_unit_dataId,',\'',v_unit_id,'\',a.changeType,concat(\'人员减少\',\'(\',(select d.name from sys_s_data d where d.id = a.c46),\')\'),count(1) ,
			sum(ifnull(c.total_salary_bf,0)+ifnull(c.total_salary_ce,0)),sum(c.part_total_salary_ce),sum(c.zwgz_ce),sum(c.gwgz_ce),sum(c.jbt_salary_ce),sum(c.total_salary_bf)
		-- 工资总计-如果没有则算差额,差额情况不计入补扣发 工资合计  职务工资  级别工资 津补贴小计 一次性补扣发
	    --  ,sum(ifnull(c.jshstg_bf,c.jshstg_ce)),sum(ifnull(c.tsjytg_bf,c.tsjytg_ce)),sum(ifnull(c.jsblgz_bf,c.jsblgz_ce))
		-- 中小学教师或护士提高10%  特殊教育提高15%  退役运动员保留工资额度;-- 原 中小学教师保留10%
	    --  ,sum(ifnull(c.hsblgz_bf,c.hsblgz_ce)),sum(ifnull(c.bltggz_bf,c.bltggz_ce)),sum(ifnull(c.psxlj_bf,c.psxlj_ce))
		-- 在护士岗位工作满20年并在医疗卫生机构工作的保留原提高10% 保留原特殊岗位活工资比例提高部分 运动员平时训练奖
		-- ,sum(ifnull(c.jxgz_bf,c.jxgz_ce))
		-- 绩效工资
		,(select group_concat(z.c02,\'-\',case when round(z.je ,2) =0 then \'\' else round(z.je ,2)  end  ) from (
				select t116.c02,sum(ifnull(d.jbt_salary_ce,0)) as je,concat(a.changeType,a.c46) as changeName
				from data_record_t126 a
				join data_record_t125 b on a.changeSign = b.changeSign
				join data_record_t117 c on a.changeSign = c.changeSign join t116 on c.c04=t116.id
				left join fund_salary_fill_subsidies_',v_i_fund_month,' d
					on d.changeSign = a.changeSign and d.jbt_id = t116.id
					where c.dataclassCode= \'t117\' and  a.dataclassCode = \'t126\' and b.dataclassCode = \'t125\'
				 	and a.c01 = \'',v_unit_dataId,'\' and  a.allAuditFlag=9
				 	and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = \'wageSystem\' and d.data_value in(201,206,202,203,207,208,209,210))
					and a.changeType = ',ryjsCode,' -- 等于人员减少
					group by t116.c02,concat(a.changeType,a.c46)
				) z  where z.changeName = concat(a.changeType,a.c46)
			)
		from data_record_t126 a join data_record_t125 b  on a.changeSign = b.changeSign
		left join fund_salary_fill_',v_i_fund_month,' c
		on a.changeSign = c.changeSign
		where a.dataclassCode = \'t126\' and b.dataclassCode = \'t125\' and b.c06 = a.dataId
		 and a.c01 = \'',v_unit_dataId,'\' and  a.allAuditFlag=9  and a.changeSign = b.changeSign
		and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = \'wageSystem\' and d.data_value in(201,206,202,203,207,208,209,210))
		and a.changeType = ',ryjsCode,' -- 等于人员减少
		and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = \'staffStatus\' and d.data_value = \'2\')
		-- 非离休人员
		-- and not exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = \'bdlx\' and d.data_value like \'01%\' ) -- 不是重新确定工资
		group by concat(a.changeType,a.c46) ');
		-- set resultMsg = concat('@sqlstr:',@sqlstr);leave label_pro;
		PREPARE stmt FROM @sqlstr;
		EXECUTE stmt;
		DROP PREPARE stmt;

		/*
		-- 重新确定工资及下面子变动
		INSERT INTO fund_total_gov(fund_month,unit_id,unit_code,change_type,change_person_num,
				total_salary,part_total_salary,zwgz_salary,gwgz_salary,jbt_salary,jbt_code_salary)
				-- 工资合计   工资小计					职务工资  级别工资 津补贴小计  津补贴项目金额
		select  v_i_fund_month,v_unit_dataId,v_unit_id,a.changeType,count(1) ,
		sum(b.c32),sum(b.c32),sum(b.c25),sum(b.c26), sum(b.c27),
		-- 工资合计   工资小计 职务工资  级别工资 津补贴小计
		(select group_concat(t116.c02,'-',c.c07) from data_data_record c join t116 on c.c04=t116.id
			where c.dataclassCode= 't117' and c.changeSign = a.changeSign)
		from data_data_record a ,data_data_record b
		where a.dataclassCode = 't126' and b.dataclassCode = 't125' and b.c06 = a.dataId
		 and  a.allAuditFlag='9' and a.c01 = v_unit_dataId  and a.changeSign = b.changeSign
		and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in (201,206,202,203,207,208,209,210)) -- 人员工资制度为 201-公务员职级工资制 206-警察职级工资制 202 -机关技工岗位等级工资制 203-机关普工岗位工资制 207-法官职级工资制 208-检察官职级工资制
		and exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = 'bdlx' and d.data_value like '01%' ) -- 重新确定工资以下面子变动
		group by a.changeType; -- 根据变动类型分组 -- allAuditFlag = 9 表示 基金生成未上报
		*/
		-- 其它要计算补扣发的变动
	/*
		INSERT INTO fund_total_gov(fund_month,unit_id,unit_code,change_type,change_person_num,
				total_salary,part_total_salary,zwgz_salary,gwgz_salary,jbt_salary,ycxbkf_salary)
				-- 工资合计   工资小计					职务工资  级别工资 津补贴小计  一次性补扣发
				-- ,total_salary,part_total_salary,zwgz_salary,gwgz_salary,
		dszn_salary,llt_salary,ggbl_salary,hmbt_salary,jjbabt_salary,xfgzry_salary,zsjz_salary,gwygfh_salary,ycxbkf_salary
		select  v_i_fund_month,v_unit_dataId,v_unit_id,a.changeType,count(1) ,
		sum(b.c32),sum(b.c32),sum(b.c25),sum(b.c26), sum(b.c27),sum(b.c32)
		-- 工资合计   工资小计 职务工资  级别工资 津补贴小计
		from data_data_record a ,data_data_record b
		where a.dataclassCode = 't126' and b.dataclassCode = 't125' and b.c06 = a.dataId
		 and  a.allAuditFlag='9' and a.c01 = v_unit_dataId  and a.changeSign = b.changeSign
		and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in (201,206,202,203)) -- 人员工资制度为 201-公务员职级工资制 206-警察职级工资制 202 -机关技工岗位等级工资制 203-机关普工岗位工资制
		and a.changeType != lrxjryCode -- 不等于录入新进人员
		and a.changeType != jbxxxgCode -- 不等于人员基本信息修改
		and not exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = 'bdlx' and d.data_value like '01%' ) -- 不是重新确定工资
		group by a.changeType ;-- 根据变动类型分组 -- allAuditFlag = 9 表示 基金生成未上报
		*/
		-- 恢复发放工资
			SET @sqlstr = CONCAT('INSERT INTO fund_total_gov(fund_month,unit_id,unit_code,change_type,change_person_num,
					total_salary,part_total_salary,zwgz_salary,gwgz_salary,jbt_salary,ycxbkf_salary,jbt_code_salary)
					-- 工资合计   工资小计					职务工资  级别工资 津补贴小计  一次性补扣发
					/*,total_salary,part_total_salary,zwgz_salary,gwgz_salary,
			dszn_salary,llt_salary,ggbl_salary,hmbt_salary,jjbabt_salary,xfgzry_salary,zsjz_salary,gwygfh_salary,ycxbkf_salary*/
			select  ',v_i_fund_month,',',v_unit_dataId,',\'',v_unit_id,'\',a.changeType,count(1) ,
		--		sum(ifnull(c.total_salary_bf,c.total_salary_ce)),sum(ifnull(c.part_total_salary_bf,c.part_total_salary_ce)),sum(ifnull(c.zwgz_bf,c.zwgz_ce)),sum(ifnull(c.gwgz_bf,c.gwgz_ce)),sum(ifnull(c.jbt_salary_bf,c.jbt_salary_ce)),sum(c.total_salary_bf)
				sum(ifnull(c.total_salary_bf,0)+ifnull(c.total_salary_ce,0)),sum(c.part_total_salary_ce),sum(c.zwgz_ce),sum(c.gwgz_ce),sum(c.jbt_salary_ce),sum(c.total_salary_bf)
			-- sum(b.c32),sum(b.c32),sum(b.c25),sum(b.c26), sum(b.c27),sum(b.c32)
			-- 工资总计-如果没有则算差额,差额情况不计入补扣发 工资合计  职务工资  级别工资 津补贴小计
		,(select group_concat(z.c02,\'-\',case when round(z.je ,2) =0 then \'\' else round(z.je ,2)  end ) from (
			select t116.c02,sum(ifnull(d.jbt_salary_ce,0)) as je,a.changeType from data_record_t126 a
			join data_record_t125 b on a.changeSign = b.changeSign
			join data_record_t117 c on a.changeSign = c.changeSign join t116 on c.c04=t116.id
			left join fund_salary_fill_subsidies_',v_i_fund_month,' d
				on d.changeSign = a.changeSign and d.jbt_id = t116.id
				where c.dataclassCode= \'t117\' and  a.dataclassCode = \'t126\' and b.dataclassCode = \'t125\'
			 	and a.c01 = \'',v_unit_dataId,'\' and  a.allAuditFlag in(0,9)
			 	and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = \'wageSystem\' and d.data_value in(201,206,202,203,207,208,209,210)) -- 人员工资制度为 201-公务员职级工资制 206-警察职级工资制 202 -机关技工岗位等级工资制 203-机关普工岗位工资制  207-法官职级工资制 208-检察官职级工资制 209-公安机关执法勤务警员职级工资制 210-公安机关警务技术人民警察职级工资制
				and a.changeType = ',hfgzdyCode,' -- 等于恢复发放工资
				group by t116.c02,a.changeType)
			z  where z.changeType = a.changeType)
			from data_record_t126 a join data_record_t125 b  on a.changeSign = b.changeSign
			left join fund_salary_fill_',v_i_fund_month,' c
			on a.changeSign = c.changeSign
			where a.dataclassCode = \'t126\' and b.dataclassCode = \'t125\' and b.c06 = a.dataId
			and a.c01 = \'',v_unit_dataId,'\' and  a.allAuditFlag in(0,9)   and a.changeSign = b.changeSign
			and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = \'wageSystem\' and d.data_value in (201,206,202,203,207,208,209,210)) -- 人员工资制度为 201-公务员职级工资制 206-警察职级工资制 202 -机关技工岗位等级工资制 203-机关普工岗位工资制 207-法官职级工资制 208-检察官职级工资制 209-公安机关执法勤务警员职级工资制 210-公安机关警务技术人民警察职级工资制
			and a.changeType = ',hfgzdyCode,' -- 等于恢复发放工资
			and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = \'staffStatus\' and d.data_value = \'2\')
			-- 非离休人员
			-- and not exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = \'bdlx\' and d.data_value like \'01%\' ) -- 不是重新确定工资
			group by a.changeType ');
		PREPARE stmt FROM @sqlstr;
		EXECUTE stmt;
		DROP PREPARE stmt;
		-- 个别变动
			SET @sqlstr = CONCAT('INSERT INTO fund_total_gov(fund_month,unit_id,unit_code,change_type,change_person_num,
					total_salary,part_total_salary,zwgz_salary,gwgz_salary,jbt_salary,ycxbkf_salary,jbt_code_salary)
					-- 工资合计   工资小计					职务工资  级别工资 津补贴小计  一次性补扣发
					/*,total_salary,part_total_salary,zwgz_salary,gwgz_salary,
			dszn_salary,llt_salary,ggbl_salary,hmbt_salary,jjbabt_salary,xfgzry_salary,zsjz_salary,gwygfh_salary,ycxbkf_salary*/
			select  ',v_i_fund_month,',',v_unit_dataId,',\'',v_unit_id,'\',a.changeType,count(1) ,
		--		sum(ifnull(c.total_salary_bf,c.total_salary_ce)),sum(ifnull(c.part_total_salary_bf,c.part_total_salary_ce)),sum(ifnull(c.zwgz_bf,c.zwgz_ce)),sum(ifnull(c.gwgz_bf,c.gwgz_ce)),sum(ifnull(c.jbt_salary_bf,c.jbt_salary_ce)),sum(c.total_salary_bf)
				sum(ifnull(c.total_salary_bf,0)+ifnull(c.total_salary_ce,0)),sum(c.part_total_salary_ce),sum(c.zwgz_ce),sum(c.gwgz_ce),sum(c.jbt_salary_ce),sum(c.total_salary_bf)
			-- sum(b.c32),sum(b.c32),sum(b.c25),sum(b.c26), sum(b.c27),sum(b.c32)
			-- 工资总计-如果没有则算差额,差额情况不计入补扣发 工资合计  职务工资  级别工资 津补贴小计
		,(select group_concat(z.c02,\'-\',round(z.je ,2)) from (
			select t116.c02,sum(ifnull(d.salary_value,0)) as je,a.changeType from data_record_t126 a
			join data_record_t125 b on a.changeSign = b.changeSign
			join data_record_t117 c on a.changeSign = c.changeSign join t116 on c.c04=t116.id
			left join fund_salary_fill_subsidies_',v_i_fund_month,' d
				on d.changeSign = a.changeSign and d.jbt_id = t116.id
				where   a.allAuditFlag in(0,9) and a.c01 = \'',v_unit_dataId,'\'
			 	and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = \'wageSystem\' and d.data_value in(201,206,202,203,207,208,209,210)) -- 人员工资制度为 201-公务员职级工资制 206-警察职级工资制 202 -机关技工岗位等级工资制 203-机关普工岗位工资制  207-法官职级工资制 208-检察官职级工资制 209-公安机关执法勤务警员职级工资制 210-公安机关警务技术人民警察职级工资制
				and a.changeType != ',lrxjryCode,' -- 不等于录入新进人员
				and a.changeType != ',ryjsCode,' -- 不等于人员减少
				and a.changeType != ',jbxxxgCode,' -- 不等于人员基本信息修改
				and a.changeType != ',hfgzdyCode,' -- 不等于恢复发放工资
				and a.changeType = 10832   -- 不等于转岗 管理 专技 事业工人  处分不同序列
				group by t116.c02,a.changeType)
			z  where z.changeType = a.changeType)
			from data_record_t126 a join data_record_t125 b  on a.changeSign = b.changeSign
			left join fund_salary_fill_',v_i_fund_month,' c
			on a.changeSign = c.changeSign
			where a.dataclassCode = \'t126\' and b.dataclassCode = \'t125\' and b.c06 = a.dataId
			 and  a.allAuditFlag in(0,9) and a.c01 = \'',v_unit_dataId,'\'  and a.changeSign = b.changeSign
			and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = \'wageSystem\' and d.data_value in (201,206,202,203,207,208,209,210)) -- 人员工资制度为 201-公务员职级工资制 206-警察职级工资制 202 -机关技工岗位等级工资制 203-机关普工岗位工资制 207-法官职级工资制 208-检察官职级工资制 209-公安机关执法勤务警员职级工资制 210-公安机关警务技术人民警察职级工资制
			and a.changeType != ',lrxjryCode,' -- 不等于录入新进人员
			and a.changeType != ',ryjsCode,' -- 不等于人员减少
			and a.changeType != ',jbxxxgCode,' -- 不等于人员基本信息修改
			and a.changeType != ',hfgzdyCode,' -- 不等于恢复发放工资
			and a.changeType = 10832   -- 不等于转岗 管理 专技 事业工人  处分不同序列
			and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = \'staffStatus\' and d.data_value = \'2\')
			-- 非离休人员
			-- and not exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = \'bdlx\' and d.data_value like \'01%\' ) -- 不是重新确定工资
			group by a.changeType ');
		PREPARE stmt FROM @sqlstr;
		EXECUTE stmt;
		DROP PREPARE stmt;
		-- 个别变动   不考虑转岗
			SET @sqlstr = CONCAT('INSERT INTO fund_total_gov(fund_month,unit_id,unit_code,change_type,change_person_num,
					total_salary,part_total_salary,zwgz_salary,gwgz_salary,jbt_salary,ycxbkf_salary,jbt_code_salary)
					-- 工资合计   工资小计					职务工资  级别工资 津补贴小计  一次性补扣发
					/*,total_salary,part_total_salary,zwgz_salary,gwgz_salary,
			dszn_salary,llt_salary,ggbl_salary,hmbt_salary,jjbabt_salary,xfgzry_salary,zsjz_salary,gwygfh_salary,ycxbkf_salary*/
			select  ',v_i_fund_month,',',v_unit_dataId,',\'',v_unit_id,'\',a.changeType,count(1) ,
		--		sum(ifnull(c.total_salary_bf,c.total_salary_ce)),sum(ifnull(c.part_total_salary_bf,c.part_total_salary_ce)),sum(ifnull(c.zwgz_bf,c.zwgz_ce)),sum(ifnull(c.gwgz_bf,c.gwgz_ce)),sum(ifnull(c.jbt_salary_bf,c.jbt_salary_ce)),sum(c.total_salary_bf)
				sum(ifnull(c.total_salary_bf,0)+ifnull(c.total_salary_ce,0)),sum(c.part_total_salary_ce),sum(c.zwgz_ce),sum(c.gwgz_ce),sum(c.jbt_salary_ce),sum(c.total_salary_bf)
			-- sum(b.c32),sum(b.c32),sum(b.c25),sum(b.c26), sum(b.c27),sum(b.c32)
			-- 工资总计-如果没有则算差额,差额情况不计入补扣发 工资合计  职务工资  级别工资 津补贴小计
		,(select group_concat(z.c02,\'-\',round(z.je ,2)) from (
			select t116.c02,sum(ifnull(d.jbt_salary_ce,0)) as je,a.changeType from data_record_t126 a
			join data_record_t125 b on a.changeSign = b.changeSign
			join data_record_t117 c on a.changeSign = c.changeSign join t116 on c.c04=t116.id
			left join fund_salary_fill_subsidies_',v_i_fund_month,' d
				on d.changeSign = a.changeSign and d.jbt_id = t116.id
				where c.dataclassCode= \'t117\' and  a.dataclassCode = \'t126\' and b.dataclassCode = \'t125\'
			 	and  a.allAuditFlag in(0,9) and a.c01 = \'',v_unit_dataId,'\'
			 	and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = \'wageSystem\' and d.data_value in(201,206,202,203,207,208,209,210)) -- 人员工资制度为 201-公务员职级工资制 206-警察职级工资制 202 -机关技工岗位等级工资制 203-机关普工岗位工资制  207-法官职级工资制 208-检察官职级工资制 209-公安机关执法勤务警员职级工资制 210-公安机关警务技术人民警察职级工资制
				and a.changeType != ',lrxjryCode,' -- 不等于录入新进人员
				and a.changeType != ',ryjsCode,' -- 不等于人员减少
				and a.changeType != ',jbxxxgCode,' -- 不等于人员基本信息修改
				and a.changeType != ',hfgzdyCode,' -- 不等于恢复发放工资
				and a.changeType not in(10647,10648,10649,10745,10646,10650,10652,11321,11322,11323,10832,11483,11523,11572,11573)  -- 不等于转岗 管理 专技 事业工人  处分不同序列
				group by t116.c02,a.changeType)
			z  where z.changeType = a.changeType)
			from data_record_t126 a join data_record_t125 b  on a.changeSign = b.changeSign
			left join fund_salary_fill_',v_i_fund_month,' c
			on a.changeSign = c.changeSign
			where a.dataclassCode = \'t126\' and b.dataclassCode = \'t125\' and b.c06 = a.dataId
			 and  a.allAuditFlag in(0,9) and a.c01 = \'',v_unit_dataId,'\'  and a.changeSign = b.changeSign
			and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = \'wageSystem\' and d.data_value in (201,206,202,203,207,208,209,210)) -- 人员工资制度为 201-公务员职级工资制 206-警察职级工资制 202 -机关技工岗位等级工资制 203-机关普工岗位工资制 207-法官职级工资制 208-检察官职级工资制 209-公安机关执法勤务警员职级工资制 210-公安机关警务技术人民警察职级工资制
			and a.changeType != ',lrxjryCode,' -- 不等于录入新进人员
			and a.changeType != ',ryjsCode,' -- 不等于人员减少
			and a.changeType != ',jbxxxgCode,' -- 不等于人员基本信息修改
			and a.changeType != ',hfgzdyCode,' -- 不等于恢复发放工资
			and a.changeType not in(10647,10648,10649,10745,10646,10650,10652,11321,11322,11323,10832,11483,11523,11572,11573,10832)  -- 不等于转岗 管理 专技 事业工人  处分不同序列
			and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = \'staffStatus\' and d.data_value = \'2\')
			-- 非离休人员
			-- and not exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = \'bdlx\' and d.data_value like \'01%\' ) -- 不是重新确定工资
			group by a.changeType ');
		PREPARE stmt FROM @sqlstr;
		EXECUTE stmt;
		DROP PREPARE stmt;
		-- 个别变动  同工资制度转岗
			SET @sqlstr = CONCAT('INSERT INTO fund_total_gov(fund_month,unit_id,unit_code,change_type,change_person_num,
					total_salary,part_total_salary,zwgz_salary,gwgz_salary,jbt_salary,ycxbkf_salary,jbt_code_salary)
					-- 工资合计   工资小计					职务工资  级别工资 津补贴小计  一次性补扣发
					/*,total_salary,part_total_salary,zwgz_salary,gwgz_salary,
			dszn_salary,llt_salary,ggbl_salary,hmbt_salary,jjbabt_salary,xfgzry_salary,zsjz_salary,gwygfh_salary,ycxbkf_salary*/
			select  ',v_i_fund_month,',',v_unit_dataId,',\'',v_unit_id,'\',(select d.name from sys_s_data d where d.id = a.changeType),count(1) ,
		--		sum(ifnull(c.total_salary_bf,c.total_salary_ce)),sum(ifnull(c.part_total_salary_bf,c.part_total_salary_ce)),sum(ifnull(c.zwgz_bf,c.zwgz_ce)),sum(ifnull(c.gwgz_bf,c.gwgz_ce)),sum(ifnull(c.jbt_salary_bf,c.jbt_salary_ce)),sum(c.total_salary_bf)
				sum(ifnull(c.total_salary_bf,0)+ifnull(c.total_salary_ce,0)),sum(c.part_total_salary_ce),sum(c.zwgz_ce),sum(c.gwgz_ce),sum(c.jbt_salary_ce),sum(c.total_salary_bf)
			-- sum(b.c32),sum(b.c32),sum(b.c25),sum(b.c26), sum(b.c27),sum(b.c32)
			-- 工资总计-如果没有则算差额,差额情况不计入补扣发 工资合计  职务工资  级别工资 津补贴小计
		,(select group_concat(z.c02,\'-\',round(z.je ,2)) from (
			select t116.c02,sum(ifnull(d.jbt_salary_ce,0)) as je,a.changeType from data_record_t126 a
			join data_record_t125 b on a.changeSign = b.changeSign
			join data_record_t117 c on a.changeSign = c.changeSign join t116 on c.c04=t116.id
			left join fund_salary_fill_subsidies_',v_i_fund_month,' d
				on d.changeSign = a.changeSign and d.jbt_id = t116.id
				LEFT JOIN data_record_t125 g on g.c06=b.c06 and g.id=(select max(h.id) from data_record_t125 h  where h.c06=b.c06 and h.id <b.id)
				where c.dataclassCode= \'t117\' and  a.dataclassCode = \'t126\' and b.dataclassCode = \'t125\'
			 	and  a.allAuditFlag in(0,9) and a.c01 = \'',v_unit_dataId,'\'
			 	and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = \'wageSystem\' and d.data_value in(201,206,202,203,207,208,209,210)) -- 人员工资制度为 201-公务员职级工资制 206-警察职级工资制 202 -机关技工岗位等级工资制 203-机关普工岗位工资制  207-法官职级工资制 208-检察官职级工资制 209-公安机关执法勤务警员职级工资制 210-公安机关警务技术人民警察职级工资制
				and a.changeType != ',lrxjryCode,' -- 不等于录入新进人员
				and a.changeType != ',ryjsCode,' -- 不等于人员减少
				and a.changeType != ',jbxxxgCode,' -- 不等于人员基本信息修改
				and a.changeType != ',hfgzdyCode,' -- 不等于恢复发放工资
				and a.changeType  in(10646,10650,10652,11321,11322,11323,10745,11483,11484,11572,11573)  -- 同职务序列转岗
				and   g.c36 not  in (10472,10473)	-- 上一变动不是事业工资制度
				group by t116.c02,a.changeType)
			z  where z.changeType = a.changeType)
			from data_record_t126 a join data_record_t125 b  on a.changeSign = b.changeSign
			left join fund_salary_fill_',v_i_fund_month,' c
			on a.changeSign = c.changeSign
			LEFT JOIN data_record_t125 g on g.c06=b.c06 and g.id=(select max(h.id) from data_record_t125 h  where h.c06=b.c06 and h.id <b.id)
			where a.dataclassCode = \'t126\' and b.dataclassCode = \'t125\' and b.c06 = a.dataId
			 and  a.allAuditFlag in(0,9) and a.c01 = \'',v_unit_dataId,'\'  and a.changeSign = b.changeSign
			and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = \'wageSystem\' and d.data_value in (201,206,202,203,207,208)) -- 人员工资制度为 201-公务员职级工资制 206-警察职级工资制 202 -机关技工岗位等级工资制 203-机关普工岗位工资制 207-法官职级工资制 208-检察官职级工资制
			and a.changeType != ',lrxjryCode,' -- 不等于录入新进人员
			and a.changeType != ',ryjsCode,' -- 不等于人员减少
			and a.changeType != ',jbxxxgCode,' -- 不等于人员基本信息修改
			and a.changeType != ',hfgzdyCode,' -- 不等于恢复发放工资
			and a.changeType in(10646,10650,10652,11321,11322,11323,10745,11483,11484,11572,11573)  -- 同职务序列转岗
			and   g.c36 not  in (10472,10473)	-- 上一变动不是事业工资制度
			and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = \'staffStatus\' and d.data_value = \'2\')
			-- 非离休人员
			-- and not exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = \'bdlx\' and d.data_value like \'01%\' ) -- 不是重新确定工资
			group by a.changeType ');
		PREPARE stmt FROM @sqlstr;
		EXECUTE stmt;
		DROP PREPARE stmt;
		--  不同职务序列转岗  机关转事业
			SET @sqlstr = CONCAT('INSERT INTO fund_total_gov(fund_month,unit_id,unit_code,change_type,change_person_num,
					total_salary,part_total_salary,zwgz_salary,gwgz_salary,jbt_salary,ycxbkf_salary,jbt_code_salary)
					-- 工资合计   工资小计					职务工资  级别工资 津补贴小计  一次性补扣发
					/*,total_salary,part_total_salary,zwgz_salary,gwgz_salary,
			dszn_salary,llt_salary,ggbl_salary,hmbt_salary,jjbabt_salary,xfgzry_salary,zsjz_salary,gwygfh_salary,ycxbkf_salary*/
			-- select  ',v_i_fund_month,',',v_unit_dataId,',\'',v_unit_id,'\',concat(\'机关\',(select d.name from sys_s_data d where d.id = a.changeType)),count(1) ,
			select  ',v_i_fund_month,',',v_unit_dataId,',\'',v_unit_id,'\',case when a.changeType = \'10745\' then (select d.name from sys_s_data d where d.id = a.changeType) else  concat(\'机关\',(select d.name from sys_s_data d where d.id = a.changeType)) end,count(1) ,
		--		sum(ifnull(c.total_salary_bf,c.total_salary_ce)),sum(ifnull(c.part_total_salary_bf,c.part_total_salary_ce)),sum(ifnull(c.zwgz_bf,c.zwgz_ce)),sum(ifnull(c.gwgz_bf,c.gwgz_ce)),sum(ifnull(c.jbt_salary_bf,c.jbt_salary_ce)),sum(c.total_salary_bf)
				sum(ifnull(c.total_salary_ce,0)-ifnull(c.total_salary,0)),sum(c.part_total_salary_ce-c.part_total_salary),sum(c.zwgz_ce-c.zwgz),sum(c.gwgz_ce-c.gwgz),sum(c.jbt_salary_ce-c.jbt_salary),0
			-- sum(b.c32),sum(b.c32),sum(b.c25),sum(b.c26), sum(b.c27),sum(b.c32)
			-- 工资总计-如果没有则算差额,差额情况不计入补扣发 工资合计  职务工资  级别工资 津补贴小计
		,(select group_concat(z.c02,\'-\',round(z.je ,2)) from (
			select t116.c02,sum(ifnull(d.jbt_salary_ce,0) - ifnull(d.salary_value,0)) as je,a.changeType from data_record_t126 a
			join data_record_t125 b on a.changeSign = b.changeSign
			join data_record_t117 c on a.changeSign = c.changeSign join t116 on c.c04=t116.id
			left join fund_salary_fill_subsidies_',v_i_fund_month,' d
				on d.changeSign = a.changeSign and d.jbt_id = t116.id
				LEFT JOIN data_record_t125 g on g.c06=b.c06 and g.id=(select max(h.id) from data_record_t125 h  where h.c06=b.c06 and h.id <b.id)
				where c.dataclassCode= \'t117\' and  a.dataclassCode = \'t126\' and b.dataclassCode = \'t125\'
			 	and  a.allAuditFlag in(0,9) and a.c01 = \'',v_unit_dataId,'\'
			 	and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = \'wageSystem\' and d.data_value in(204,205)) -- 人员工资制度为 事业工资制度
				and a.changeType != ',lrxjryCode,' -- 不等于录入新进人员
				and a.changeType != ',ryjsCode,' -- 不等于人员减少
				and a.changeType != ',jbxxxgCode,' -- 不等于人员基本信息修改
				and a.changeType != ',hfgzdyCode,' -- 不等于恢复发放工资
				and a.changeType  in(10647,10648,10649,10745)  -- 等于转岗 管理 专技 事业工人  处分不同序列
				and   g.c36 not  in (10472,10473)	-- 上一变动不是事业工资制度
				group by t116.c02,a.changeType)
			z  where z.changeType = a.changeType)
			from data_record_t126 a join data_record_t125 b  on a.changeSign = b.changeSign
			left join fund_salary_fill_',v_i_fund_month,' c
			on a.changeSign = c.changeSign
			LEFT JOIN data_record_t125 g on g.c06=b.c06 and g.id=(select max(h.id) from data_record_t125 h  where h.c06=b.c06 and h.id <b.id)
			where a.dataclassCode = \'t126\' and b.dataclassCode = \'t125\' and b.c06 = a.dataId
			 and  a.allAuditFlag in(0,9) and a.c01 = \'',v_unit_dataId,'\'  and a.changeSign = b.changeSign
			and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = \'wageSystem\' and d.data_value in (204,205)) -- 人员工资制度为 事业工资制度
			and a.changeType != ',lrxjryCode,' -- 不等于录入新进人员
			and a.changeType != ',ryjsCode,' -- 不等于人员减少
			and a.changeType != ',jbxxxgCode,' -- 不等于人员基本信息修改
			and a.changeType != ',hfgzdyCode,' -- 不等于恢复发放工资
			and a.changeType  in(10647,10648,10649,10745)  -- 等于转岗 管理 专技 事业工人  处分不同序列
			and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = \'staffStatus\' and d.data_value = \'2\')
			and   g.c36 not  in (10472,10473)	-- 上一变动不是事业工资制度
			-- 非离休人员
			-- and not exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = \'bdlx\' and d.data_value like \'01%\' ) -- 不是重新确定工资
			group by a.changeType ');
		PREPARE stmt FROM @sqlstr;
		EXECUTE stmt;
		DROP PREPARE stmt;

		--  不同职务序列转岗  事业转机关
			SET @sqlstr = CONCAT('INSERT INTO fund_total_gov(fund_month,unit_id,unit_code,change_type,change_person_num,
					total_salary,part_total_salary,zwgz_salary,gwgz_salary,jbt_salary,ycxbkf_salary,jbt_code_salary)
					-- 工资合计   工资小计					职务工资  级别工资 津补贴小计  一次性补扣发
					/*,total_salary,part_total_salary,zwgz_salary,gwgz_salary,
			dszn_salary,llt_salary,ggbl_salary,hmbt_salary,jjbabt_salary,xfgzry_salary,zsjz_salary,gwygfh_salary,ycxbkf_salary*/
			-- select  ',v_i_fund_month,',',v_unit_dataId,',\'',v_unit_id,'\',concat(\'事业\',(select d.name from sys_s_data d where d.id = a.changeType)),count(1) ,
			select  ',v_i_fund_month,',',v_unit_dataId,',\'',v_unit_id,'\',case when a.changeType =\'10745\' then (select d.name from sys_s_data d where d.id = a.changeType) else concat(\'事业\',(select d.name from sys_s_data d where d.id = a.changeType)) end,count(1) ,
		--		sum(ifnull(c.total_salary_bf,c.total_salary_ce)),sum(ifnull(c.part_total_salary_bf,c.part_total_salary_ce)),sum(ifnull(c.zwgz_bf,c.zwgz_ce)),sum(ifnull(c.gwgz_bf,c.gwgz_ce)),sum(ifnull(c.jbt_salary_bf,c.jbt_salary_ce)),sum(c.total_salary_bf)
				sum(ifnull(c.total_salary,0)),sum(c.part_total_salary),sum(c.zwgz),sum(c.gwgz),sum(c.jbt_salary),0
			-- sum(b.c32),sum(b.c32),sum(b.c25),sum(b.c26), sum(b.c27),sum(b.c32)
			-- 工资总计-如果没有则算差额,差额情况不计入补扣发 工资合计  职务工资  级别工资 津补贴小计
		,(select group_concat(z.c02,\'-\',round(z.je ,2)) from (
			select t116.c02,sum( ifnull(d.salary_value,0)) as je,a.changeType from data_record_t126 a
			join data_record_t125 b on a.changeSign = b.changeSign
			join data_record_t117 c on a.changeSign = c.changeSign join t116 on c.c04=t116.id
			left join fund_salary_fill_subsidies_',v_i_fund_month,' d
				on d.changeSign = a.changeSign and d.jbt_id = t116.id
				LEFT JOIN data_record_t125 g on g.c06=b.c06 and g.id=(select max(h.id) from data_record_t125 h  where h.c06=b.c06 and h.id <b.id)
				where c.dataclassCode= \'t117\' and  a.dataclassCode = \'t126\' and b.dataclassCode = \'t125\'
			 	and  a.allAuditFlag in(0,9) and a.c01 = \'',v_unit_dataId,'\'
			 	and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = \'wageSystem\' and d.data_value in(201,206,202,203,207,208,209,210)) -- 人员工资制度为 事业工资制度
				and a.changeType != ',lrxjryCode,' -- 不等于录入新进人员
				and a.changeType != ',ryjsCode,' -- 不等于人员减少
				and a.changeType != ',jbxxxgCode,' -- 不等于人员基本信息修改
				and a.changeType != ',hfgzdyCode,' -- 不等于恢复发放工资
				and a.changeType  in(10646,10650,10652,10745,11321,11322,11323,11483,11484,11572,11573)  -- 等于转岗 转为机关  10745处分为机关
				and   g.c36   in (10472,10473)	-- 上一变动是事业工资制度
				group by t116.c02,a.changeType)
			z  where z.changeType = a.changeType)
			from data_record_t126 a join data_record_t125 b  on a.changeSign = b.changeSign
			left join fund_salary_fill_',v_i_fund_month,' c
			on a.changeSign = c.changeSign
			LEFT JOIN data_record_t125 g on g.c06=b.c06 and g.id=(select max(h.id) from data_record_t125 h  where h.c06=b.c06 and h.id <b.id)
			where a.dataclassCode = \'t126\' and b.dataclassCode = \'t125\' and b.c06 = a.dataId
			 and  a.allAuditFlag in(0,9) and a.c01 = \'',v_unit_dataId,'\'  and a.changeSign = b.changeSign
			and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = \'wageSystem\' and d.data_value in (201,206,202,203,207,208,209,210)) -- 人员工资制度为 事业工资制度
			and a.changeType != ',lrxjryCode,' -- 不等于录入新进人员
			and a.changeType != ',ryjsCode,' -- 不等于人员减少
			and a.changeType != ',jbxxxgCode,' -- 不等于人员基本信息修改
			and a.changeType != ',hfgzdyCode,' -- 不等于恢复发放工资
			and a.changeType  in(10646,10650,10652,10745,11321,11322,11323,11483,11484,11572,11573)  -- 等于转岗 转为机关
			and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = \'staffStatus\' and d.data_value = \'2\')
			and   g.c36   in (10472,10473)	-- 上一变动是事业工资制度
			-- 非离休人员
			-- and not exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = \'bdlx\' and d.data_value like \'01%\' ) -- 不是重新确定工资
			group by a.changeType ');
		PREPARE stmt FROM @sqlstr;
		EXECUTE stmt;
		DROP PREPARE stmt;
	end if;

	-- 基金生成未上报code
	select ifnull(content,11208) into @noApplyAuditCode from sys_s_config where enname = 'NOAPPLY_AUDIT_CODE';
	-- 未处理code
	select ifnull(content,11202) into @noAuditCode from sys_s_config where enname = 'NO_AUDIT_CODE';
	-- 年终奖金发放
	-- 更新当前单位 未审核通过的年终奖金发放管理表数据
	set @yearHj = 0;
	select count(1) into stemNum from t151 where c01 = concat(v_unit_dataId,'')
	and (exists (select 1 from sys_s_data d where d.typename = 'ybshzt' and d.data_value != '2' and d.id = ifnull(t151.c03,''))
		or ifnull(t151.c03,'') = ''
	);
	set stemParam = 0;
	-- 月报审核状态  0-未处理 1-待审核 2-通过 3-未通过 7-撤回申请中 8-撤回 9-生成基金未上报
	if stemNum > 0 then
		select ifnull(content,11263) into @yearAwardCode from sys_s_config where enname = 'YEAR_AWARD_CODE';
		update t151 ,sys_s_data d set t151.c03 = d.id,t151.c04=concat(v_i_fund_month,'')
		 where t151.c01 = concat(v_unit_dataId,'') and t151.c03 != 11204 -- sys_s_data 11204 月报审核状态 -审核通过
		and d.typename = 'ybshzt' and d.data_value= '9' ;

		update t154,t151 set t154.c04=concat(v_i_fund_month,'') where t154.c09=t151.id
		and t151.c01 = concat(v_unit_dataId,'') and t151.c04=concat(v_i_fund_month,'');-- 更新年终奖金发放表的基金月份/发放时间
		select id into stempParam from t151 where c01 = concat(v_unit_dataId,'') and c03 = @noApplyAuditCode limit 0,1; -- 11208 生成基金未上报
		-- 年终奖金发放表
		select
			sum(b.c07) into @yearHj
			from t154 b where c09 = stempParam
			and exists(select 1 from t125,sys_s_data d where d.id = t125.c36 and t125.c06=b.c02 and d.typename = 'wageSystem' and d.data_value in (201,206,202,203,207,208,209,210))
			;-- 发放编号

		INSERT INTO fund_total_gov(fund_month,unit_id,unit_code,change_type,change_person_num,
						total_salary,part_total_salary,zwgz_salary,gwgz_salary,jbt_salary,ycxbkf_salary)
						-- 工资合计   工资小计					职务工资  级别工资  一次性补扣发 津补贴小计
						/*,total_salary,part_total_salary,zwgz_salary,gwgz_salary,
		dszn_salary,llt_salary,ggbl_salary,hmbt_salary,jjbabt_salary,xfgzry_salary,zsjz_salary,gwygfh_salary,ycxbkf_salary*/
			select  v_i_fund_month,v_unit_dataId,v_unit_id,@yearAwardCode,count(1) ,
				sum(b.c07),0,0,0,0,sum(b.c07)
			--  工资总计 工资合计  职务工资  级别工资 津补贴小计
				from t154 b where c09 = stempParam
				and exists(select 1 from t125,sys_s_data d where d.id = t125.c36 and t125.c06=b.c02 and d.typename = 'wageSystem' and d.data_value in (201,206,202,203,207,208,209,210))
				;-- 发放编号
		-- select sum(ycxbkf_salary) into stemParam -- 获取基金月份对应的年终奖金补扣发之和
		-- 	from fund_total_gov where unit_id =v_unit_dataId and fund_month = v_i_fund_month and change_type = @yearAwardCode;

	end if;

	-- 警察加班补贴
	-- 更新当前单位 未审核通过的警察加班补贴表数据
	select count(1) into stemNum from t152 where c01 = concat(v_unit_dataId,'')
	and (exists (select 1 from sys_s_data d where d.typename = 'ybshzt' and d.data_value != '2' and d.id = ifnull(t152.c13,''))
		or ifnull(t152.c13,'') = ''
	);
	-- 月报审核状态  0-未处理 1-待审核 2-通过 3-未通过 7-撤回申请中 8-撤回 9-生成基金未上报
	if stemNum > 0 then
		select ifnull(content,11307) into @policeExtraCode from sys_s_config where enname = 'POLICE_EXTRA_CODE';
		update t152 ,sys_s_data d set t152.c13 = d.id,t152.c12=concat(v_i_fund_month,'')
		 where t152.c01 = concat(v_unit_dataId,'') and t152.c13 != 11204 -- sys_s_data 11204 月报审核状态 -审核通过
		and d.typename = 'ybshzt' and d.data_value= '9' ;

		select id into stempParam from t152 where c01 = concat(v_unit_dataId,'') and c13 = @noApplyAuditCode limit 0,1; -- 11208 生成基金未上报
		-- 警察加班补贴 表
		INSERT INTO fund_total_gov(fund_month,unit_id,unit_code,change_type,change_person_num,
						total_salary,part_total_salary,zwgz_salary,gwgz_salary,jbt_salary,ycxbkf_salary)
						-- 工资合计   工资小计					职务工资  级别工资  津补贴小计  一次性补扣发
						/*,total_salary,part_total_salary,zwgz_salary,gwgz_salary,
		dszn_salary,llt_salary,ggbl_salary,hmbt_salary,jjbabt_salary,xfgzry_salary,zsjz_salary,gwygfh_salary,ycxbkf_salary*/
			select  v_i_fund_month,v_unit_dataId,v_unit_id,@policeExtraCode,count(1) ,
				sum(b.c10),0,0,0,0,sum(b.c10)
			--  工资总计 工资合计  职务工资  级别工资 津补贴小计   一次性补扣发
				from t152 b where c12 = v_i_fund_month and c01 = concat(v_unit_dataId,'') ;-- 发放编号
		-- select sum(ycxbkf_salary+stemParam) into stemParam -- 获取基金月份对应的 警察加班补贴 补扣发费用之和
		-- 	from fund_total_gov where unit_id =v_unit_dataId and fund_month = v_i_fund_month and change_type = @policeExtraCode;
	end if;

	-- 警察执勤津补贴
	-- 更新当前单位 未审核通过的 警察执勤津补贴 表数据
	select count(1) into stemNum from t153 where c01 = concat(v_unit_dataId,'')
	and (exists (select 1 from sys_s_data d where d.typename = 'ybshzt' and d.data_value != '2' and d.id = ifnull(t153.c17,''))
		or ifnull(t153.c17,'') = ''
	);
	-- 月报审核状态  0-未处理 1-待审核 2-通过 3-未通过 7-撤回申请中 8-撤回 9-生成基金未上报
	if stemNum > 0 then
		select ifnull(content,11306) into @policeDutyCode from sys_s_config where enname = 'POLICE_DUTY_CODE';
		update t153 ,sys_s_data d set t153.c17 = d.id,t153.c14=concat(v_i_fund_month,'')
		 where t153.c01 = concat(v_unit_dataId,'') and t153.c17 != 11204 -- sys_s_data 11204 月报审核状态 -审核通过
		and d.typename = 'ybshzt' and d.data_value= '9' ;

		select id into stempParam from t153 where c01 = concat(v_unit_dataId,'') and c17 = @noApplyAuditCode limit 0,1; -- 11208 生成基金未上报
		--  警察执勤津补贴 表
		INSERT INTO fund_total_gov(fund_month,unit_id,unit_code,change_type,change_person_num,
						total_salary,part_total_salary,zwgz_salary,gwgz_salary,jbt_salary,ycxbkf_salary)
						-- 工资合计   工资小计					职务工资  级别工资  津补贴小计  一次性补扣发
						/*,total_salary,part_total_salary,zwgz_salary,gwgz_salary,
		dszn_salary,llt_salary,ggbl_salary,hmbt_salary,jjbabt_salary,xfgzry_salary,zsjz_salary,gwygfh_salary,ycxbkf_salary*/
			select  v_i_fund_month,v_unit_dataId,v_unit_id,@policeDutyCode,count(1) ,
				sum(b.c12),0,0,0,0,sum(b.c12)
			--  工资总计 工资合计  职务工资  级别工资 津补贴小计   一次性补扣发
				from t153 b where c14 = concat(v_i_fund_month,'') and c01 = concat(v_unit_dataId,'') ;-- 发放编号
		-- select sum(ycxbkf_salary+stemParam) into stemParam -- 获取基金月份对应的 警察执勤津补贴 补扣发费用之和
		-- 	from fund_total_gov where unit_id =v_unit_dataId and fund_month = v_i_fund_month and change_type = @policeDutyCode;
	end if;

	-- 艰苦边远地区津补贴补扣发
	-- 更新当前单位 未审核通过的 艰苦边远地区津补贴补扣发 表数据
	select count(1) into stemNum from t164 where c01 = concat(v_unit_dataId,'')
	and exists(select 1 from t125 b,sys_s_data d where d.id = b.c36 and b.c06=t164.c03 and d.typename = 'wageSystem' and d.data_value in (201,206,202,203,207,208,209,210))
	and (exists (select 1 from sys_s_data d where d.typename = 'ybshzt' and d.data_value != '2' and d.id = ifnull(t164.c10,''))
		or ifnull(t164.c10,'') = ''
	);
	-- 月报审核状态  0-未处理 1-待审核 2-通过 3-未通过 7-撤回申请中 8-撤回 9-生成基金未上报
	if stemNum > 0 then
		select ifnull(content,11315) into @hardMoteCode from sys_s_config where enname = 'HARD_MOTE_CODE';
		update t164 ,sys_s_data d set t164.c10 = d.id,t164.c11=concat(v_i_fund_month,'')
		 where t164.c01 = concat(v_unit_dataId,'') and t164.c10 != 11204 -- sys_s_data 11204 月报审核状态 -审核通过
		and exists(select 1 from t125 b,sys_s_data d where d.id = b.c36 and b.c06=t164.c03 and d.typename = 'wageSystem' and d.data_value in (201,206,202,203,207,208,209,210))
		and d.typename = 'ybshzt' and d.data_value= '9' ;

		-- 艰边津补贴表
		INSERT INTO fund_total_gov(fund_month,unit_id,unit_code,change_type,change_person_num,
						total_salary,part_total_salary,zwgz_salary,gwgz_salary,jbt_salary,ycxbkf_salary)
						-- 工资合计   工资小计					职务工资  级别工资  津补贴小计  一次性补扣发
						/*,total_salary,part_total_salary,zwgz_salary,gwgz_salary,
		dszn_salary,llt_salary,ggbl_salary,hmbt_salary,jjbabt_salary,xfgzry_salary,zsjz_salary,gwygfh_salary,ycxbkf_salary*/
			select  v_i_fund_month,v_unit_dataId,v_unit_id,@hardMoteCode,count(1) ,
				sum(c09),0,0,0,0,sum(c09)
			--  工资总计 工资合计  职务工资  级别工资 津补贴小计   一次性补扣发
				from t164 where c01 = concat(v_unit_dataId,'') and c11 = concat(v_i_fund_month,'')
				and exists(select 1 from t125 b,sys_s_data d where d.id = b.c36 and b.c06=t164.c03 and d.typename = 'wageSystem' and d.data_value in (201,206,202,203,207,208,209,210))
				;
		-- select sum(ycxbkf_salary+stemParam) into stemParam -- 获取基金月份对应的 艰苦边远地区津补贴补扣发 补扣发费用之和
		-- 	from fund_total_gov where unit_id =v_unit_dataId and fund_month = v_i_fund_month and change_type = @hardMoteCode;
	end if;

	-- 其它一次性补扣发
	-- 更新当前单位 未审核通过的其它一次性补扣发管理表数据
	select count(1) into stemNum from t119 where c04 = concat(v_unit_dataId,'')
	-- and EXISTS (select 1 from t126,sys_s_data d where d.id = t126.c03 and t126.id = t119.c01 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
	and exists(select 1 from sys_s_data d,t125 b where d.id = b.c36 and t119.c01 = b.c06 and d.typename = 'wageSystem' and d.data_value in (201,206,202,203,207,208,209,210))
	and (exists (select 1 from sys_s_data d where d.typename = 'ybshzt' and d.data_value != '2' and d.id = ifnull(t119.c21,''))
		or ifnull(t119.c21,'') = ''
	)
	and not exists(select 1 from t126,sys_s_data d where t126.id = t119.c01 and d.id =t126.c03 and d.typename = 'staffStatus' and d.data_value = '2')
	-- 非离休人员
	;
	-- 月报审核状态  0-未处理 1-待审核 2-通过 3-未通过 7-撤回申请中 8-撤回 9-生成基金未上报
	if stemNum > 0 then
		select ifnull(content,11264) into @otherFillCode from sys_s_config where enname = 'OTHER_FILL_CODE';-- 11264其它一次性补扣发
		select count(1) into stemNum from t119,t125 b where t119.c01=b.c06
		and t119.c04 = concat(v_unit_dataId,'') and t119.c21 != 11204  -- sys_s_data 11204 月报审核状态 -审核通过
		and not exists(select 1 from t126,sys_s_data d where t126.id = t119.c01 and d.id = t126.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in (201,206,202,203,207,208,209,210));
		if stemNum > 0 then
			update t119,t125 b ,sys_s_data d set t119.c21 = d.id,t119.c20=concat(v_i_fund_month,'')
			 where t119.c04 = concat(v_unit_dataId,'') and ifnull(t119.c21,'') != 11204 -- sys_s_data 11204 月报审核状态 -审核通过
			and d.typename = 'ybshzt' and d.data_value= '9'
			and t119.c01=b.c06
			and not exists(select 1 from t126,sys_s_data d where t126.id = t119.c01 and d.id =t126.c03 and d.typename = 'staffStatus' and d.data_value = '2')
			-- 非离休人员
			and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in (201,206,202,203,207,208,209,210));

			-- 其它一次性补扣发
			INSERT INTO fund_total_gov(fund_month,unit_id,unit_code,change_type,changetype_name,change_person_num,
							jstg10,tsjy15,blzxx10,blhs10,bltg,psxlj,
							-- 教师护士提高10%,特殊教育提高15%, 中小学教师保留10% 保留护士提高10%  保留特岗 平时训练奖
							total_salary,/*part_total_salary,*/zwgz_salary,gwgz_salary,jbt_salary,ycxbkf_salary,jbt_code_salary)
							-- 其它人员一次性补扣发 不计算工资小计
							-- 工资合计   工资小计					职务工资  级别工资  一次性补扣发 津补贴小计
			select  v_i_fund_month,v_unit_dataId,v_unit_id,@otherFillCode,t119.c05,count(1) ,
				-- sum(t119.c11),sum(t119.c12),sum(t119.c13),sum(t119.c14),sum(t119.c15),sum(t119.c16),
				0,0,0,0,0,0,
				sum(t119.c22),/*sum(t119.c09),*/0/*sum(t119.c06)*/,0/*sum(t119.c07)*/,0/*round(sum(t119.c08),2)*/,sum(t119.c22)
				-- 其它人员一次性补扣发 不计算工资小计  不计算津补贴小计  不计算津补贴细项
				-- 工资总计 工资合计 职务工资  级别工资 津补贴小计 一次性补扣发
				,''/*
				(select group_concat(c02,'-',round(je ,2)) from
			(	select t119.c05,t116.c02,sum(t150.c04 ) as je
				from t150  join t119 on t119.id = t150.c01 join t116 on t150.c02 = t116.id
				where  t150.c01 = t119.id
				and exists(select 1 from sys_s_data d,t125 c
					where t119.c01 = c.c06 and d.id = c.c36
					and d.typename = 'wageSystem' and d.data_value in (201,206,202,203,207,208,209,210))
				and t119.c04 = concat(v_unit_dataId,'')  and t119.c21 = @noApplyAuditCode group by t116.c02,t119.c05
				) a where a.c05 = t119.c05) */

				from t119 ,t125 c
				where t119.c01 = c.c06
				and exists(select 1 from sys_s_data d where d.id = c.c36 and d.typename = 'wageSystem' and d.data_value in (201,206,202,203,207,208,209,210)) -- 201-公务员职级工资制 206-警察工资制 202-机关工人 203-机关普工 207-法官职级工资制 208-检察官职级工资制
				-- and EXISTS (select 1 from t126,sys_s_data d where d.id = t126.c03 and t126.id = t119.c01 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
				and t119.c04 = concat(v_unit_dataId,'') and t119.c21 = @noApplyAuditCode
				and not exists(select 1 from t126,sys_s_data d where t126.id = t119.c01 and d.id = t126.c03 and d.typename = 'staffStatus' and d.data_value = '2')
				-- 非离休人员
				group by t119.c04,t119.c05; -- 11208 生成基金未上报
			-- select sum(ycxbkf_salary+stemParam) into stemParam -- 获取基金月份对应的一次性补扣发费用之和
			-- 	from fund_total_gov where unit_id =v_unit_dataId and fund_month = v_i_fund_month and change_type = @otherFillCode;

		end if;
	end if;

	-- CALL getFundTotalJbt ('fund_total_gov',v_unit_dataId,v_i_fund_month,resultMsg);/*基金计算津补贴*/
	select group_concat(z.c02,'-',round(z.je ,2)) into resultMsg from ( select t116.c02,SUM(t117.c07) as je from
	t126,t117,t116 where t126.c01 = concat(v_unit_dataId,'') and concat(t126.id,'') = t117.c03 and t116.id = t117.c04
	and  t126.c03 ='10371' and t126.c40 not in('10647','10648','10649','10831','10855') and t126.c28 in ('10512','10513','10514','10515','10516','11180','11181','11182','11376','11377','11539','11540') GROUP BY t116.c02
	) z ;
	set @jbt_code_salary = resultMsg;
	set resultMsg = '';

	select sum(ifnull(ycxbkf_salary,0)) into stemParam
			from fund_total_gov where unit_id =concat(v_unit_dataId,'') and fund_month = concat(v_i_fund_month,'')
			 and change_type not in( '本月核定工资总额','上月核定工资总额');

	select sum(ifnull(total_salary,0)),ifnull(sum(part_total_salary),0),
			sum(ifnull(zwgz_salary,0)),sum(ifnull(gwgz_salary,0)),sum(ifnull(jbt_salary,0))
			 into @stemBkfHj,@stemBkfXj,@stemBkfZwgz,@stemBkfJbgz,@stemBkfJbtXj
			from fund_total_gov where unit_id =concat(v_unit_dataId,'') and fund_month = concat(v_i_fund_month,'')
			 and change_type = 11264;-- 其它一次性补扣发
	set @stemBkfHj = @yearHj+ifnull(@stemBkfHj,0)+0;
	-- 本月核定工资总额
	INSERT INTO fund_total_gov(fund_month,unit_id,unit_code,change_type,change_person_num,
				total_salary,part_total_salary,zwgz_salary,gwgz_salary,jbt_salary,ycxbkf_salary
				,jbt_code_salary)
				-- 工资合计   工资小计					职务工资  级别工资 津补贴小计  一次性补扣发
				/*,total_salary,part_total_salary,zwgz_salary,gwgz_salary,
		dszn_salary,llt_salary,ggbl_salary,hmbt_salary,jjbabt_salary,xfgzry_salary,zsjz_salary,gwygfh_salary,ycxbkf_salary*/
		select  v_i_fund_month,v_unit_dataId,v_unit_id,'本月核定工资总额',count(1) ,
		ROUND(sum(b.c32)+ifnull(stemParam,0),2),
		ROUND(sum(b.c32)+ifnull(@stemBkfXj,0),2),
		ROUND(sum(b.c25)+ifnull(@stemBkfZwgz,0),2),
		ROUND(sum(b.c26)+ifnull(@stemBkfJbgz,0),2),
		ROUND(sum(b.c27)+ifnull(@stemBkfJbtXj,0),2),stemParam
		,@jbt_code_salary
		-- 工资总计 工资合计  职务工资  级别工资 津补贴小计
		from t126 a join t125 b on b.c06 = concat(a.id,'')
		where  1=1
		and a.c01 = concat(v_unit_dataId,'')
		and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in (201,206,202,203,207,208,209,210)) -- 人员工资制度为 201-公务员职级工资制 206-警察职级工资制 202 -机关技工岗位等级工资制 203-机关普工岗位工资制 207-法官职级工资制 208-检察官职级工资制
		and EXISTS (select 1 from sys_s_data d where d.id = a.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
		-- and not exists (select 1 from sys_s_data d where d.id = a.c43 and d.typename = 'is' and d.data_value = '1') -- 不是停发工资的人员   20171130：核定变动人数要计算停发工资人员
		and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		and ifnull(a.c46,'')=''
		;-- 根据变动类型分组
-- 统一处理小数位数   00000001
	update fund_total_gov set total_salary =round(total_salary ,2) where fund_month = concat(v_i_fund_month,'') and unit_id =concat(v_unit_dataId,'');
	update fund_total_gov set part_total_salary =round(part_total_salary ,2) where fund_month = concat(v_i_fund_month,'') and unit_id =concat(v_unit_dataId,'');
	update fund_total_gov set jbt_salary =round(jbt_salary ,2) where fund_month = concat(v_i_fund_month,'') and unit_id =concat(v_unit_dataId,'');
	update fund_total_gov set ycxbkf_salary =round(ycxbkf_salary ,2) where fund_month = concat(v_i_fund_month,'') and unit_id =concat(v_unit_dataId,'');
	update fund_total_gov set zwgz_salary =round(zwgz_salary ,2) where fund_month = concat(v_i_fund_month,'') and unit_id =concat(v_unit_dataId,'');
	update fund_total_gov set gwgz_salary =round(gwgz_salary ,2) where fund_month = concat(v_i_fund_month,'') and unit_id =concat(v_unit_dataId,'');
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`p_2_fund`(in v_i_fund_month varchar(6),in v_unit_id varchar(50),
in v_unit_dataId int(11),inout resultMsg varchar(10000))
label_pro:BEGIN
	/*基金生成-分支存储过程 基金变动花名册fund_change_detail*/
	DECLARE stemNum int(11);
	DECLARE stempNum int(11);
	DECLARE sTemRecordId int(11);
	DECLARE sTemPreRecordId int(11);
	DECLARE sTemPersonId varchar(30);
	DECLARE chanType VARCHAR(30);
	DECLARE chanSign VARCHAR(100);
	DECLARE sftx VARCHAR(100);-- 是否停薪
	DECLARE v_table VARCHAR(50);
	DECLARE v_allowance_table VARCHAR(50);
	declare sysDataBase varchar(20);-- 数据库名称


	DECLARE lrxjryCode varchar(20); -- 录入新进人员codeid
	DECLARE jsdrryCode varchar(20); -- 接受调入人员codeid
	DECLARE jbxxxgCode varchar(20); -- 人员基本信息修改codeid
	DECLARE ryjsCode varchar(20); -- 人员减少-变动记录codeid
	DECLARE hfgzdyCode varchar(20); -- 恢复工资待遇-变动记录codeid
	
	DECLARE done INT DEFAULT FALSE;
    
	-- 所有未生成基金补扣发的变动记录(未审核通过的)
	DECLARE recordId_ CURSOR FOR
   SELECT distinct t126.id from data_record_t126 t126 left join t136 on t126.c28 = t136.c02 -- 人员身份
	where 1=1 and t126.dataclassCode = 't126' and  ifnull(allAuditFlag,'')!='2' -- 未审核通过的数据
	and t126.c01 = concat(v_unit_dataId,'') -- t125.c36 人员工资制度为 201 -公务员职级工资
	and not exists(select 1 from sys_s_data d where d.id = t126.c03 and d.typename = 'staffStatus' and d.data_value = '2')
	-- 非离休人员
	order by t136.c06,t126.c02,t126.id
		 -- 人员身份类型 先机关后事业  人员编号 
	;
 	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
 	
	select content into sysDataBase from sys_s_config where enname = 'DATABASE_NAME';-- 数据库名称

	select ifnull(content,10750) into lrxjryCode from sys_s_config where enname = 'CHANGETYPE_NEWPERSON_CODE';
	select ifnull(content,10832) into jsdrryCode from sys_s_config where enname = 'CHANGETYPE_ACCEPTCOME_CODE';
	select ifnull(content,10751) into jbxxxgCode from sys_s_config where enname = 'CHANGETYPE_INFO_CODE';
	select ifnull(content,10831) into ryjsCode from sys_s_config where enname = 'RYJS_CHANGE_CODE';
	select ifnull(content,10654) into hfgzdyCode from sys_s_config where enname = 'CHANGETYPE_RECOVERYSALARY_CODE';
	
	

	SET v_table =  CONCAT('fund_change_detail_',v_i_fund_month);/*处理分表存储*/
	SET v_allowance_table =  CONCAT('fund_change_subsidies_',v_i_fund_month);/*处理分表存储*/
	
	/*判断是否已经存在基金月分对应变动表*/
	select count(1) into stempNum from information_schema.tables where table_schema = sysDataBase and TABLE_NAME = v_table;-- smso数据库里面对应的工资变动表信息
	
	if stempNum < 1 then -- 判断是否已经存在v_i_fund_month(如201608)的工资发放表信息
		SET @sqlstr = CONCAT('CREATE TABLE ',v_table,' LIKE ', ' fund_change_detail');
		PREPARE stmt FROM @sqlstr;
		EXECUTE stmt;
		DROP PREPARE stmt;
	end if;
	select count(1) into stempNum from information_schema.tables where table_schema = sysDataBase and TABLE_NAME = v_allowance_table;-- smso数据库里面对应的津补贴变动表信息
	if stempNum < 1 then -- 判断是否已经存在v_i_fund_month(如201608)的工资发放表信息
		SET @sqlstr = CONCAT('CREATE TABLE ',v_allowance_table,' LIKE ', ' fund_change_subsidies');
		PREPARE stmt FROM @sqlstr;
		EXECUTE stmt;
		DROP PREPARE stmt;
		-- call p_fund_addIndex(v_i_fund_month,'fund_change_detail',resultMsg);-- 变动花名册表生成索引
	end if;

	/*数据清理*/
	SET @sqlstr = CONCAT('delete from  ', v_table,' where  unit_id=\'',v_unit_dataId,'\' and fund_month=',v_i_fund_month,' ');
	PREPARE stmt FROM @sqlstr;
	EXECUTE stmt;
	DROP PREPARE stmt;
	SET @sqlstr = CONCAT('delete from  ', v_allowance_table,' where  unit_id=\'',v_unit_dataId,'\' and fund_month=',v_i_fund_month,' ');
	PREPARE stmt FROM @sqlstr;
	EXECUTE stmt;
	DROP PREPARE stmt;
	
	-- 基金生成未上报code
	select ifnull(content,11208) into @noApplyAuditCode from sys_s_config where enname = 'NOAPPLY_AUDIT_CODE';
	-- 年终奖金发放
	select count(1) into stemNum from t151 where c01 = concat(v_unit_dataId,'') 
	and (exists (select 1 from sys_s_data d where d.typename = 'ybshzt' and d.data_value != '2' and d.id = ifnull(t151.c03,''))
		or ifnull(t151.c03,'') = ''
	);
	if stemNum > 0 then 
		select ifnull(content,11263) into @yearAwardCode from sys_s_config where enname = 'YEAR_AWARD_CODE';
		SET @sqlstr = CONCAT('INSERT INTO ', v_table,' (fund_month,unit_id,unit_code,data_type,change_type,changeSign,staff_id,staff_code,staff_name,
				staff_eduLevel,staff_standing,staff_curPost,
				-- 学历			人员身份		现任职务
				staff_actual_workRank,-- staff_workRank,
				-- 实际职务/技术等级	工资对应职级	
				staff_jobSal,staff_levelSal,syq_salary,
				-- 职务/技术等级工资 级别岗位级别工资 教师护士提高10% 特殊教育提高15%			保留特岗工资			中小学教师保留10%工资	保留护士提高10%工资
				salary_value,
				-- 工资补扣发
				is_finSupt,is_salUniOut,department_name,
				-- 是否财政供养 是否财政统发 部门
				staff_titleRank,changetype_name,change_time)
				-- 衔级 变动原因 变动时间
				select ',v_i_fund_month,',',v_unit_dataId,',\'',v_unit_id,'\',\'增减资\',',@yearAwardCode,',
				concat(UNIX_TIMESTAMP(),',@yearAwardCode,',\'t126\',t126.id,\'t154\',t154.id),t126.id,t126.c02,t126.c04,
					-- 基金月分		单位代码	变动前后  变动类型 人员id	人员改名
				t126.c09,ifnull(t154.c12,t126.c28),t126.c19,
				-- 学历			人员身份		现任职务
				t126.c36,-- t126.c17,
				-- 实际职务/技术等级 工资对应职级
					-- cast(t154.c05 as decimal(10,2)),cast(t154.c06 as decimal(10,2)),
					case when (select 1 from sys_s_data where id = t126.c36 and name like \'%期%\') then \'\' else round(t154.c05,2)  end , -- 职务工资
					case when (select 1 from sys_s_data where id = t126.c36 and name like \'%期%\') then \'\' else round(t154.c06,2)  end , -- 级别工资
					case when (select 1 from sys_s_data where id = t126.c36 and name like \'%期%\') then round(ifnull(t154.c05,0),2)+round(ifnull(t154.c06,0),2) else \'\' end , -- 试用期工资
				-- 	round(t154.c05,2),round(t154.c06,2),
				-- 职务/技术等级工资 级别岗位级别工资 
					-- cast(t154.c07 as decimal(10,2)),
					round(t154.c07,2),
				-- 工资补扣发 
				t126.c24,t126.c22,(select c03 from t113 where id=t126.c15),
				-- 是否财政供养 是否财政统发 部门
				t125.c24,\'年终一次性奖金\',DATE_FORMAT(t151.createDate,\'%Y-%m-%d\')
				--  衔级
			from t126,t125,t154,t151
			where 1=1 and t154.c01 = \'',v_unit_dataId,'\' and  t154.c02 = t126.id 
				 and  t125.c06 = concat(t126.id ,\'\') and  t154.c09 = t151.id -- 年终奖金发放编号
			   and t154.c04=',v_i_fund_month,' and t151.c03 = ',@noApplyAuditCode);-- 11208 生成基金未上报
			PREPARE stmt FROM @sqlstr;
			EXECUTE stmt;
			DROP PREPARE stmt;	
	end if;

	-- 警察加班补贴
	select count(1) into stemNum from t152 where c01 = concat(v_unit_dataId,'') 
	and (exists (select 1 from sys_s_data d where d.typename = 'ybshzt' and d.data_value != '2' and d.id = ifnull(t152.c13,''))
		or ifnull(t152.c13,'') = ''
	);
	-- 月报审核状态  0-未处理 1-待审核 2-通过 3-未通过 7-撤回申请中 8-撤回 9-生成基金未上报
	if stemNum > 0 then
		select ifnull(content,11307) into @policeExtraCode from sys_s_config where enname = 'POLICE_EXTRA_CODE';
		SET @sqlstr = CONCAT('INSERT INTO ', v_table,' (fund_month,unit_id,unit_code,data_type,change_type,changeSign,staff_id,staff_code,staff_name,
			staff_eduLevel,staff_standing,staff_curPost,
				-- 学历			人员身份		现任职务
				staff_actual_workRank,-- staff_workRank,
				-- 实际职务/技术等级	工资对应职级	
				salary_value,
				-- 工资补扣发
				is_finSupt,is_salUniOut,department_name,
				-- 是否财政供养 是否财政统发 部门
				staff_titleRank,changetype_name,change_time)
				-- 衔级 变动原因 变动时间
				select ',v_i_fund_month,',',v_unit_dataId,',\'',v_unit_id,'\',\'增减资\',',@policeExtraCode,',concat(UNIX_TIMESTAMP(),',@policeExtraCode,',\'t126\',t126.id,\'t152\',t152.id),t126.id,t126.c02,t126.c04,
					-- 基金月分		单位代码	变动前后  变动类型 人员id	人员改名
				t126.c09,\'\',t126.c19,
				-- 学历			人员身份		现任职务
				t126.c36,-- t126.c17,
				-- 实际职务/技术等级
				-- cast(t152.c10 as decimal(10,2)),
				round(t152.c10,2),
				-- 工资补扣发 
				t126.c24,t126.c22,(select c03 from t113 where id=t126.c15),
				-- 是否财政供养 是否财政统发 部门
				t125.c24,\'警察加班补贴\',DATE_FORMAT(t152.createDate,\'%Y-%m-%d\') 
				--  衔级
			from t126,t125,t152
			where 1=1 and  t125.c06 = concat(t126.id,\'\')  and  t152.c03= concat(t126.id,\'\')
			  and t152.c01 = \'',v_unit_dataId,'\' and t152.c12=',v_i_fund_month,' and t152.c13 = ',@noApplyAuditCode);-- 11208 生成基金未上报
			PREPARE stmt FROM @sqlstr;
			EXECUTE stmt;
			DROP PREPARE stmt;	
	end if;
	
	-- 警察执勤津补贴
	-- 更新当前单位 未审核通过的 警察执勤津补贴 表数据
	select count(1) into stemNum from t153 where c01 = concat(v_unit_dataId,'') 
	and (exists (select 1 from sys_s_data d where d.typename = 'ybshzt' and d.data_value != '2' and d.id = ifnull(t153.c17,''))
		or ifnull(t153.c17,'') = ''
	);
	-- 月报审核状态  0-未处理 1-待审核 2-通过 3-未通过 7-撤回申请中 8-撤回 9-生成基金未上报
	if stemNum > 0 then
		select ifnull(content,11306) into @policeDutyCode from sys_s_config where enname = 'POLICE_DUTY_CODE';
		SET @sqlstr = CONCAT('INSERT INTO ', v_table,' (fund_month,unit_id,unit_code,data_type,change_type,changeSign,staff_id,staff_code,staff_name,
				staff_eduLevel,staff_standing,staff_curPost,
				-- 学历			人员身份		现任职务
				staff_actual_workRank,-- staff_workRank,
				-- 实际职务/技术等级	工资对应职级	
				salary_value,
				-- 工资补扣发
				is_finSupt,is_salUniOut,department_name,
				-- 是否财政供养 是否财政统发 部门
				staff_titleRank,changetype_name,change_time,change_attachment)
				-- 衔级 变动原因 变动时间
				select ',v_i_fund_month,',',v_unit_dataId,',\'',v_unit_id,'\',\'增减资\',',@policeDutyCode,',concat(UNIX_TIMESTAMP(),',@policeDutyCode,',\'t126\',t126.id,\'t153\',t153.id),t126.id,t126.c02,t126.c04,
					-- 基金月分		单位代码	变动前后  变动类型 人员id	人员改名
					t126.c09,ifnull(t153.c33,t126.c28),t126.c19,
				-- 学历			人员身份		现任职务
				t126.c36,-- t126.c17,
				-- 实际职务/技术等级
				-- cast(t153.c12 as decimal(10,2)),
				round(t153.c12,2),
				-- 工资补扣发 
				t126.c24,t126.c22,(select c03 from t113 where id=t126.c15),
				-- 是否财政供养 是否财政统发 部门
				t125.c24,\'警察值勤补贴\',DATE_FORMAT(t153.createDate,\'%Y-%m-%d\'),t153.c32 
				--  衔级
			from t126,t125,t153
			where 1=1 and  t125.c06 = concat(t126.id,\'\')  and t153.c03 = concat(t126.id,\'\')
			  and t153.c01 = \'',v_unit_dataId,'\' and t153.c14=',v_i_fund_month,' and t153.c17 = ',@noApplyAuditCode);-- 11208 生成基金未上报
			PREPARE stmt FROM @sqlstr;
			EXECUTE stmt;
			DROP PREPARE stmt;
	end if;

	-- 艰苦边远地区津补贴补扣发
	-- 更新当前单位 未审核通过的 艰苦边远地区津补贴补扣发 表数据
	select count(1) into stemNum from t164 where c01 = concat(v_unit_dataId,'') 
	and exists(select 1 from t125 b,sys_s_data d where d.id = b.c36 and b.c06=t164.c03 and d.typename = 'wageSystem' and d.data_value in (201,206,202,203,204,207,208))
	and (exists (select 1 from sys_s_data d where d.typename = 'ybshzt' and d.data_value != '2' and d.id = ifnull(t164.c10,''))
		or ifnull(t164.c10,'') = ''
	);
	-- 月报审核状态  0-未处理 1-待审核 2-通过 3-未通过 7-撤回申请中 8-撤回 9-生成基金未上报
	if stemNum > 0 then
		select ifnull(content,11315) into @hardMoteCode from sys_s_config where enname = 'HARD_MOTE_CODE';
		SET @sqlstr = CONCAT('INSERT INTO ', v_table,' (fund_month,unit_id,unit_code,data_type,change_type,changeSign,staff_id,staff_code,staff_name,
				staff_eduLevel,staff_standing,staff_curPost,
				-- 学历			人员身份		现任职务
				staff_actual_workRank,-- staff_workRank,
				-- 实际职务/技术等级	工资对应职级	
				salary_value,
				-- 工资补扣发
				is_finSupt,is_salUniOut,department_name,
				-- 是否财政供养 是否财政统发 部门
				staff_titleRank,changetype_name,change_time,change_attachment)
				-- 衔级 变动原因 变动时间
				select ',v_i_fund_month,',',v_unit_dataId,',\'',v_unit_id,'\',\'增减资\',',@hardMoteCode,',concat(UNIX_TIMESTAMP(),',@hardMoteCode,',\'t126\',t126.id,\'t164\',t164.id),t126.id,t126.c02,t126.c04,
					-- 基金月分		单位代码	变动前后  变动类型 人员id	人员改名
					t126.c09,ifnull(t164.c27,t126.c28),t126.c19,
				-- 学历			人员身份		现任职务
				t126.c36,-- t126.c17,
				-- 实际职务/技术等级
				-- cast(t164.c09 as decimal(10,2)),
				round(t164.c09,2),
				-- 工资补扣发 
				t126.c24,t126.c22,(select c03 from t113 where id=t126.c15),
				-- 是否财政供养 是否财政统发 部门
				t125.c24,\'艰苦边远地区津补贴补扣发\',DATE_FORMAT(t164.createDate,\'%Y-%m-%d\'),t164.c26 
				--  衔级
			from t126,t125,t164
			where 1=1 and  t125.c06 = concat(t126.id,\'\') and  t164.c03 = concat(t126.id,\'\')
			  and t164.c01 = \'',v_unit_dataId,'\' and t164.c11=',v_i_fund_month,' and t164.c10 = ',@noApplyAuditCode);-- 11208 生成基金未上报
			PREPARE stmt FROM @sqlstr;
			EXECUTE stmt;
			DROP PREPARE stmt;
	end if;

	-- 其它一次性补扣发
	-- 更新当前单位 未审核通过的其它一次性补扣发管理表数据
	select count(1) into stemNum from t119 where c04 = concat(v_unit_dataId,'') 
	-- and EXISTS (select 1 from t126,sys_s_data d where d.id = t126.c03 and t126.id = t119.c01 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
	and (exists (select 1 from sys_s_data d where d.typename = 'ybshzt' and d.data_value != '2' and d.id = ifnull(t119.c21,''))
		or ifnull(t119.c21,'') = ''
	)
	and not exists(select 1 from t126,sys_s_data d where t126.id = t119.c01 and d.id = t126.c03 and d.typename = 'staffStatus' and d.data_value = '2')
	-- 非离休人员
	;

	-- 月报审核状态  0-未处理 1-待审核 2-通过 3-未通过 7-撤回申请中 8-撤回 9-生成基金未上报
	if stemNum > 0 then
		select ifnull(content,11264) into @otherFillCode from sys_s_config where enname = 'OTHER_FILL_CODE';-- 11264其它一次性补扣发
		
		SET @sqlstr = CONCAT('INSERT INTO ', v_table,' (fund_month,unit_id,unit_code,data_type,change_type,
				changeSign,staff_id,staff_code,staff_name,
				-- 补扣发原因   变动标志    人员id 人员编码  人员姓名 
				staff_eduLevel,staff_standing,staff_curPost,
				-- 学历			人员身份		现任职务
				staff_actual_workRank,-- staff_workRank,
				-- 实际职务/技术等级	工资对应职级	
				salary_value,
				-- 工资补扣发
				is_finSupt,is_salUniOut,department_name,
				-- 是否财政供养 是否财政统发 部门
				staff_titleRank,changetype_name,
				-- 衔级		变动原因
				staff_jobSal,staff_levelSal,jbt_total_salary,
				-- 职务工资   级别/岗位工资 津补贴小计
				staff_teacherNurseUpTen,staff_specialTeachFifteen,
				-- 教师护士提高10%,特殊教育提高15%,
				staff_midTeacherKeeyTen,staff_keepNurseUpTen,
				-- 中小学教师保留10% 保留护士提高10%  
				staff_keepSpecialStationSal,staff_peacetimeAward,staff_basicPerfor
				--  保留特岗 平时训练奖 绩效工资
				,change_time,change_attachment
				-- 变动时间
				)
				select ',v_i_fund_month,',',v_unit_dataId,',\'',v_unit_id,'\',\'增减资\',',@otherFillCode,',
					-- 基金月分	单位id	单位代码	变动前后  变动类型 
				concat(UNIX_TIMESTAMP(),',@otherFillCode,',\'t126\',t126.id,\'t119\',t119.id),t126.id,t126.c02,t126.c04,
				-- 补扣发原因   变动标志    人员id 人员编码  人员姓名 
					t126.c09,ifnull(t119.c42,t126.c28),t126.c19,
				-- 学历			人员身份		现任职务
				t126.c36,-- t126.c17,
				-- 实际职务/技术等级
				-- cast(t119.c22 as decimal(10,2)),
				round(t119.c22,2),
				-- 工资补扣发 
				t126.c24,t126.c22,(select c03 from t113 where id=t126.c15),
				-- 是否财政供养 是否财政统发 部门
				t125.c24,t119.c05,0,0,0,0,0,0,0,0,0,0
				--  衔级  变动原因
				/*case when t119.c06 REGEXP \'','^[0-9/-]','\' then round(t119.c06,2) else t119.c06 end,
				case when t119.c07 REGEXP \'','^[0-9/-]','\' then round(t119.c07,2) else t119.c07 end,
				case when t119.c08 REGEXP \'','^[0-9/-]','\' then round(t119.c08,2) else t119.c08 end,
				-- 职务工资   级别/岗位工资 津补贴小计
				-- cast(t119.c11 as decimal(10,2)),cast(t119.c12 as decimal(10,2)),cast(t119.c13 as decimal(10,2)),
				case when t119.c11 REGEXP \'','^[0-9/-]','\' then round(t119.c11,2) else t119.c11 end,
				case when t119.c12 REGEXP \'','^[0-9/-]','\' then round(t119.c12,2) else t119.c12 end,
				case when t119.c13 REGEXP \'','^[0-9/-]','\' then round(t119.c13,2) else t119.c13 end,
				-- cast(t119.c14 as decimal(10,2)),cast(t119.c15 as decimal(10,2)),cast(t119.c16 as decimal(10,2)),cast(t119.c26 as decimal(10,2))
				case when t119.c14 REGEXP \'','^[0-9/-]','\' then round(t119.c14,2) else t119.c14 end,
				case when t119.c15 REGEXP \'','^[0-9/-]','\' then round(t119.c15,2) else t119.c15 end,
				case when t119.c16 REGEXP \'','^[0-9/-]','\' then round(t119.c16,2) else t119.c16 end,
				case when t119.c26 REGEXP \'','^[0-9/-]','\' then round(t119.c26,2) else t119.c26 end*/
				-- 11教师护士提高10%,12特殊教育提高15%,  13退役运动员保留工资额度 14在护士岗20年   15：保留原特岗比例提高   16 ：运动员平时训练奖   26：绩效工资中小学教师保留10% -改名为:退役运动员保留工资额度 保留护士提高10%  保留特岗 平时训练奖 绩效工资
				,DATE_FORMAT(t119.createDate,\'%Y-%m-%d\'),t119.c27 
			from t126,t125,t119
			where 1=1 and t125.c06 = concat(t126.id,\'\') and  t119.c01 = t126.id 
			 and not exists(select 1 from sys_s_data d where d.id = t126.c03 and d.typename = \'staffStatus\' and d.data_value = \'2\')
		-- 非离休人员
			  and t119.c04 = \'',v_unit_dataId,'\' and t119.c20=',v_i_fund_month,' and t119.c21 = ',@noApplyAuditCode);-- 11208 生成基金未上报
			PREPARE stmt FROM @sqlstr;
			EXECUTE stmt;
			DROP PREPARE stmt;
			select count(1) into @stemJbt from t119 where c04 = concat(v_unit_dataId,'') and c20 = v_i_fund_month and c21 = @noApplyAuditCode;
			if @stemJbt != 0 then -- 津补贴小计不等于0
				SET @sqlstr = CONCAT('INSERT INTO ', v_allowance_table,'(fund_month,unit_id,unit_code,data_type,
					changeSign,staff_id,
					allowance_id,allowance_title,salary_value)
					-- 津补贴id  津补贴名称  津补贴金额  津补贴当月实际补发 津补贴后续补发  津补贴标准时间
				select ',v_i_fund_month,',',v_unit_dataId,',\'',v_unit_id,'\',\'增减资\',b.changeSign,t150.c05,
					-- 基金月分 	   单位id		单位代码(51036000) 人员id 
				t150.c02,t116.c03,0-- round(t150.c04,2) -- cast(t150.c04 as decimal(10,2)) 
				-- 津补贴id  津补贴名称 津补贴金额 津补贴当月实际补发 津补贴后续补发  津补贴标准时间
				from t119,t150,t116,',v_table,' b
				where 1=1 and t119.id = t150.c01 and t119.c04 = \'',v_unit_dataId,'\' and t119.c21 = ',@noApplyAuditCode,' 
				and t150.c02 = t116.id-- 津补贴编号
				and t119.c01=b.staff_id and t119.c05=b.changetype_name and b.change_type = ',@otherFillCode,'
				and t150.c04+0!=0
			 	and not exists(select 1 from t126,sys_s_data d where t126.id = t119.c01 and d.id = t126.c03 and d.typename = \'staffStatus\' and d.data_value = \'2\')
				-- 非离休人员
				group by t119.c05,t150.c05,t116.id');
				PREPARE stmt FROM @sqlstr;
				EXECUTE stmt;
				DROP PREPARE stmt;
			end if;	
	end if;

 OPEN recordId_;  
  -- 开始循环
  read_loop: LOOP
    -- 提取游标里的数据，这里只有一个，多个的话也一样；

    FETCH recordId_ INTO sTemRecordId;

    -- 声明结束的时候
    IF done THEN
      LEAVE read_loop;
    END IF;
    set @done = done;


    select a.dataId,a.changeType,a.changeSign,b.c36 into sTemPersonId,chanType ,chanSign,@nowGzzd from data_record_t126 a,data_record_t125 b
    where a.id = sTemRecordId and  b.changesign =a.changesign;
    -- set resultMsg = concat('lrxjryCode:',lrxjryCode,',chanType:',chanType,',jsdrryCode:',jsdrryCode);leave label_pro;
    if chanType = lrxjryCode or chanType = jsdrryCode then -- 录入新进人员或接收调入人员
		SET @sqlstr = CONCAT('INSERT INTO ', v_table,' (fund_month,unit_id,unit_code,data_type,change_type,
					-- 基金月分	单位id	单位代码	变动前后  变动类型 
			changetype_name,changeSign,staff_id,staff_code,staff_name,
				-- 变动原因   变动标志    人员id 人员编码  人员姓名 
			staff_eduLevel,staff_standing,staff_curPost,
			-- 学历			人员身份		现任职务
			staff_actual_workRank,staff_workRank,staff_isLeader,staff_postSalRank,staff_salRankLevel,
			-- 实际职务/技术等级	工资对应职级	是否领导工资	工资级别		工资档次
			staff_jobSal,staff_levelSal,syq_salary,staff_teacherNurseUpTen,staff_specialTeachFifteen,staff_keepSpecialStationSal,staff_midTeacherKeeyTen,staff_keepNurseUpTen,
			-- 职务/技术等级工资 级别岗位级别工资 教师护士提高10% 特殊教育提高15%			保留特岗工资			中小学教师保留10%工资	保留护士提高10%工资
			staff_peacetimeAward,staff_basicPerfor,
			-- 平时训练奖			基础绩效
			jbt_total_salary,actual_total_salary,salary_value,theory_total_salary,
			-- 津补贴小计		实发工资合计		工资补扣发		实际应发工资合计
			is_finSupt,is_salUniOut,department_name,
			-- 是否财政供养 是否财政统发 部门
			staff_wageSystem,staff_isUpten,staff_plusGrade,staff_downGrade,staff_plusLevel,staff_floatLevel,staff_fixLevel,staff_downLevel,
			-- 人员工资制度 是否提高10%工资  已含高定级别  已含低定级别		已含高定档次	已含浮动档次	已含固定档次	已含低定档次
			st_sal_date,en_sal_date,staff_status,staff_sex,staff_birth,staff_degree,staff_workYears,staff_from,staff_establish,
			-- 起薪时间 停薪时间	人员状态		性别		出生日期	学位		连续工龄	人员来源	人员编制
			staff_isFullTeacher,staff_salaryStandard,staff_isMainPart,staff_isStop,staff_partYears,staff_isMidTeacher,
			-- 是否专职教师		执行工资标准			是否主力		是否停薪		入队年限		是否中小学教师
			staff_isNurse,staff_fileNum,staff_titleRank,staff_isSpecialTeach,staff_salStandardDate
			-- 是否护士		根据文号		衔级			是否特殊教育		工资标准时间
			,change_time)
			-- 变动时间
			select ',v_i_fund_month,',',v_unit_dataId,',\'',v_unit_id,'\',\'变动后\',t126.c40,
				-- 基金月分	单位id	单位代码	变动前后  变动类型  
				(case ',chanType,' when ',lrxjryCode,' then  
					concat(\'起薪\',\'(\',(select d.name from sys_s_data d where d.id = t126.c16),\')\')
				else 
					(select d.name from sys_s_data d where d.id = ',chanType,') 
				end) changeTypeName ,
				\'',chanSign,'\',t126.dataId,t126.c02,t126.c04,
			-- 变动原因 变动标志 人员id	人员改名
				t126.c09,t126.c28,t126.c19,
			-- 学历			人员身份		现任职务
				t126.c36,t126.c17,t126.c27,t125.c07,t125.c09,
			-- 实际职务/技术等级	工资对应职级	是否领导工资	工资级别		工资档次
				-- cast(t125.c25 as decimal(10,2)),cast(t125.c26 as decimal(10,2)),cast(t125.c28 as decimal(10,2)),
				-- round(t125.c25,2),round(t125.c26,2),
					case when (select 1 from sys_s_data where id = t126.c36 and name like \'%期%\') then \'\' else round(t125.c25,2)  end , -- 职务工资
					case when (select 1 from sys_s_data where id = t126.c36 and name like \'%期%\') then \'\' else round(t125.c26,2)  end , -- 级别工资
					case when (select 1 from sys_s_data where id = t126.c36 and name like \'%期%\') then round(ifnull(t125.c25,0),2)+round(ifnull(t125.c26,0),2) else \'\'  end , -- 试用期工资
				
				round(t125.c28,2),
				-- cast(t125.c29 as decimal(10,2)),cast(t125.c30 as decimal(10,2)),cast(t125.c44 as decimal(10,2)),cast(t125.c45 as decimal(10,2)),
				round(t125.c29,2),round(t125.c30,2),round(t125.c44,2),round(t125.c45,2),
			-- 职务/技术等级工资 级别岗位级别工资 教师护士提高10% 特殊教育提高15%			保留特岗工资			中小学教师保留10%工资	保留护士提高10%工资
				-- cast(t125.c47 as decimal(10,2)),cast(t125.c31 as decimal(10,2)),
				round(t125.c47,2),round(t125.c31,2),
			-- 平时训练奖			基础绩效
				-- cast(t125.c27 as decimal(10,2)),cast(t125.c32 as decimal(10,2)),0,cast(t125.c32 as decimal(10,2))+0,
				round(t125.c27,2),round(t125.c32,2),0,round(t125.c32,2),
			-- 津补贴小计		实发工资合计		工资补扣发		实际应发工资合计
			t126.c24,t126.c22,(select c03 from t113 where id=t126.c15),
			-- 是否财政供养 是否财政统发 部门
			t125.c36,t125.c23,t125.c11,t125.c13,t125.c15,t125.c17,t125.c19,t125.c21,
			-- 人员工资制度 是否提高10%工资  已含高定级别  已含低定级别		已含高定档次	已含浮动档次	已含固定档次	已含低定档次
			t125.c02,t125.c38,t126.c03,t126.c05,t126.c08,t126.c10,t126.c14,t126.c16,t126.c21,
			-- 起薪时间 停薪时间	人员状态		性别		出生日期	学位		连续工龄	人员来源	人员编制
			t125.c39,t126.c39,t126.c42,t126.c43,t126.c45,t125.c01,
			-- 是否专职教师		执行工资标准			是否主力		是否停薪		入队年限		是否中小学教师
			t125.c03,t125.c04,t125.c24,t125.c35,t125.c49
			-- 是否护士		根据文号		衔级			是否特殊教育		工资标准时间
			,DATE_FORMAT(t126.createDate,\'%Y-%m-%d\') 
		from data_record_t126 t126,data_record_t125 t125 
		where 1=1 and t126.changeSign = t125.changeSign
		  	and  t125.c06 = concat(t126.dataid,\'\') and t126.id = ',sTemRecordId);

		PREPARE stmt FROM @sqlstr;
		EXECUTE stmt;
		DROP PREPARE stmt;	

		SET @sqlstr = CONCAT('INSERT INTO ', v_allowance_table,'(fund_month,unit_id,unit_code,staff_id,data_type,
				changeSign,allowance_id,allowance_title,salary_value,staff_salStandardDate)
				-- 津补贴id 		津补贴名称 	 津补贴金额  津补贴当月实际补发 津补贴后续补发  津补贴标准时间
			select ',v_i_fund_month,',',v_unit_dataId,',\'',v_unit_id,'\',t117.c03,\'变动后\',
				\'',chanSign,'\',t117.c04,t116.c03,round(t117.c07,2),t117.c01-- cast(t117.c07 as decimal(10,2)) ,t117.c01
					-- 基金月分 	 单位代码(51036000) 人员id 津补贴id  津补贴名称 津补贴金额	津补贴标准时间
			from data_record_t117 t117 ,data_record_t126 t126,t116
			where 1=1  and  t117.c03 =concat(t126.dataid ,\'\')
			and t126.c01 = \'',v_unit_dataId,'\'
		  	 and t126.fund_month = ',v_i_fund_month,'
			and t126.changeSign = t117.changeSign
			and t117.c04 = t116.id and t126.id = ',sTemRecordId);
		PREPARE stmt FROM @sqlstr;
		EXECUTE stmt;
		DROP PREPARE stmt;	

		/*数据插入-增减资*/
		SET @sqlstr = CONCAT('INSERT INTO ', v_table,' (fund_month,unit_id,unit_code,data_type,change_type,
					-- 基金月分	单位id	单位代码	变动前后  变动类型 
			changetype_name,changeSign,staff_id,staff_code,staff_name,
				-- 变动原因   变动标志    人员id 人员编码  人员姓名 
				staff_eduLevel,staff_standing,staff_curPost,
				-- 学历			人员身份		现任职务
				staff_actual_workRank,staff_workRank,staff_isLeader,staff_postSalRank,staff_salRankLevel,
				-- 实际职务/技术等级	工资对应职级	是否领导工资	工资级别		工资档次
				staff_jobSal,staff_levelSal,syq_salary,staff_teacherNurseUpTen,staff_specialTeachFifteen,staff_keepSpecialStationSal,staff_midTeacherKeeyTen,staff_keepNurseUpTen,
				-- 职务/技术等级工资 级别岗位级别工资 教师护士提高10% 特殊教育提高15%			保留特岗工资			中小学教师保留10%工资	保留护士提高10%工资
				staff_peacetimeAward,staff_basicPerfor,
				-- 平时训练奖			基础绩效
				jbt_total_salary,actual_total_salary,salary_value,theory_total_salary,
				-- 津补贴小计		实发工资合计		工资补扣发		实际应发工资合计
				is_finSupt,is_salUniOut,department_name,
				-- 是否财政供养 是否财政统发 部门
				staff_wageSystem,staff_isUpten,staff_plusGrade,staff_downGrade,staff_plusLevel,staff_floatLevel,staff_fixLevel,staff_downLevel,
				-- 人员工资制度 是否提高10%工资  已含高定级别  已含低定级别		已含高定档次	已含浮动档次	已含固定档次	已含低定档次
				st_sal_date,en_sal_date,staff_status,staff_sex,staff_birth,staff_degree,staff_workYears,staff_from,staff_establish,
				-- 起薪时间 停薪时间	人员状态		性别		出生日期	学位		连续工龄	人员来源	人员编制
				staff_isFullTeacher,staff_salaryStandard,staff_isMainPart,staff_isStop,staff_partYears,staff_isMidTeacher,
				-- 是否专职教师		执行工资标准			是否主力		是否停薪		入队年限		是否中小学教师
				staff_isNurse,staff_fileNum,staff_titleRank,staff_isSpecialTeach,staff_salStandardDate
				-- 是否护士		根据文号		衔级			是否特殊教育		工资标准时间
				,change_time,change_attachment)
				-- 变动时间
				select ',v_i_fund_month,',',v_unit_dataId,',\'',v_unit_id,'\',\'增减资\',t126.c40,
					-- 基金月分	单位id	单位代码	变动前后  变动类型 
				(case ',chanType,' when ',lrxjryCode,' then  
					concat(\'起薪\',\'(\',(select d.name from sys_s_data d where d.id = t126.c16),\')\')
				else 
					(select d.name from sys_s_data d where d.id = ',chanType,') 
				end) changeTypeName ,
				\'',chanSign,'\',t126.dataId,t126.c02,t126.c04,
					-- 变动原因 变动标志 人员id 人员编码 人员姓名
					t126.c09,t126.c28,t126.c19,
				-- 学历			人员身份		现任职务
					t126.c36,t126.c17,t126.c27,t125.c07,t125.c09,
				-- 实际职务/技术等级	工资对应职级	是否领导工资	工资级别		工资档次
					-- cast(t125.c25 as decimal(10,2)),cast(t125.c26 as decimal(10,2)),cast(t125.c28 as decimal(10,2)),
					-- round(t125.c25,2),round(t125.c26,2),
					case when (select 1 from sys_s_data where id = t126.c36 and name like \'%期%\') then \'\' else round(t125.c25,2)  end , -- 职务工资
					case when (select 1 from sys_s_data where id = t126.c36 and name like \'%期%\') then \'\' else round(t125.c26,2)  end , -- 级别工资
					case when (select 1 from sys_s_data where id = t126.c36 and name like \'%期%\') then round(ifnull(t125.c25,0),2)+round(ifnull(t125.c26,0),2) else \'\'  end , -- 试用期工资
					round(t125.c28,2),
					-- cast(t125.c29 as decimal(10,2)),cast(t125.c30 as decimal(10,2)),cast(t125.c44 as decimal(10,2)),cast(t125.c45 as decimal(10,2)),
					round(t125.c29,2),round(t125.c30,2),round(t125.c44,2),round(t125.c45,2),
				-- 职务/技术等级工资 级别岗位级别工资 教师护士提高10% 特殊教育提高15%			保留特岗工资			中小学教师保留10%工资	保留护士提高10%工资
					-- cast(t125.c47 as decimal(10,2)),cast(t125.c31 as decimal(10,2)),
					round(t125.c47,2),round(t125.c31,2),
				-- 平时训练奖			基础绩效
					-- cast(t125.c27 as decimal(10,2)),cast(t125.c32 as decimal(10,2)),ifnull(cast(c.total_salary_bf as decimal(10,2)),0),cast(t125.c32 as decimal(10,2))+0,
					round(t125.c27,2),round(t125.c32,2),ifnull(round(c.total_salary_bf,2),0),round(t125.c32,2),
				-- 津补贴小计		实发工资合计		工资补扣发		实际应发工资合计
				t126.c24,t126.c22,(select c03 from t113 where id=t126.c15),
				-- 是否财政供养 是否财政统发 部门
				t125.c36,t125.c23,t125.c11,t125.c13,t125.c15,t125.c17,t125.c19,t125.c21,
				-- 人员工资制度 是否提高10%工资  已含高定级别  已含低定级别		已含高定档次	已含浮动档次	已含固定档次	已含低定档次
				t125.c02,t125.c38,t126.c03,t126.c05,t126.c08,t126.c10,t126.c14,t126.c16,t126.c21,
				-- 起薪时间 停薪时间	人员状态		性别		出生日期	学位		连续工龄	人员来源	人员编制
				t125.c39,t126.c39,t126.c42,t126.c43,t126.c45,t125.c01,
				-- 是否专职教师		执行工资标准			是否主力		是否停薪		入队年限		是否中小学教师
				t125.c03,t125.c04,t125.c24,t125.c35,t125.c49
				-- 是否护士		根据文号		衔级			是否特殊教育		工资标准时间
				,DATE_FORMAT(t126.createDate,\'%Y-%m-%d\'),t125.c48
			from data_record_t126 t126 join data_record_t125 t125 on t126.changeSign = t125.changeSign
		left join fund_salary_fill_',v_i_fund_month,' c on t126.changeSign = c.changeSign
			where 1=1 
			  	and   t125.c06 = concat(t126.dataid,\'\') and t126.id = ',sTemRecordId);
			PREPARE stmt FROM @sqlstr;
			EXECUTE stmt;
			DROP PREPARE stmt;	
		
			
		SET @sqlstr = CONCAT('INSERT INTO ', v_allowance_table,'(fund_month,unit_id,unit_code,staff_id,data_type,
				changeSign,allowance_id,allowance_title,salary_value,staff_salStandardDate)
				-- 津补贴id 		津补贴名称 	 津补贴金额  津补贴当月实际补发 津补贴后续补发  津补贴标准时间
			select ',v_i_fund_month,',',v_unit_dataId,',\'',v_unit_id,'\',t117.c03,\'增减资\',
				\'',chanSign,'\',t117.c04,t116.c03,round(t117.c07 ,2),t117.c01
					-- 基金月分 	 单位代码(51036000) 人员id 津补贴id  津补贴名称 津补贴金额	津补贴标准时间
			from data_record_t117 t117 ,data_record_t126 t126,t116
			where 1=1  and   t117.c03 = concat(t126.dataid,\'\')
			and t126.c01 = \'',v_unit_dataId,'\'  
		  	and t126.fund_month = \'',v_i_fund_month,'\'
			and t126.changeSign = t117.changeSign
			and t117.c04 = t116.id and t126.id = ',sTemRecordId);

		PREPARE stmt FROM @sqlstr;
		EXECUTE stmt;
		DROP PREPARE stmt;	

	else
		select t126.id,ifnull(t126.c43,''),t125.c36  into sTemPreRecordId,sftx,@perGzzd from data_record_t126 t126 , data_record_t125 t125
		where  t126.dataId = sTemPersonId and t125.changesign = t126.changesign 
		and t126.id < sTemRecordId
		order by t126.id desc 
		limit 0,1; -- 获取当前变动记录上一条记录	

		set @perString = '';-- 机关转事业或事业转机关前缀名称
		-- 机关事业间转岗
		if (select @nowGzzd in (10472,10473) and  @perGzzd not in (10472,10473)) 
			 and (select chanType in (10646,10647,10648,10649,10650,10652,11321,11322,11323)) then
			set @perString = '机关';
		end if;
		if  (select @nowGzzd not in (10472,10473) and  @perGzzd  in (10472,10473))
			 and (select chanType in (10646,10647,10648,10649,10650,10652,11321,11322,11323)) then 	
			 set @perString = '事业';
		end if;
	
		
		SET @sqlstr = CONCAT('INSERT INTO ', v_table,' (fund_month,unit_id,unit_code,data_type,change_type,
			changetype_name,
			changeSign,staff_id,staff_code,staff_name,
			staff_eduLevel,staff_standing,staff_curPost,
			-- 学历			人员身份		现任职务
			staff_actual_workRank,staff_workRank,staff_isLeader,staff_postSalRank,staff_salRankLevel,
			-- 实际职务/技术等级	工资对应职级	是否领导工资	工资级别		工资档次
			staff_jobSal,staff_levelSal,syq_salary,staff_teacherNurseUpTen,staff_specialTeachFifteen,staff_keepSpecialStationSal,staff_midTeacherKeeyTen,staff_keepNurseUpTen,
			-- 职务/技术等级工资 级别岗位级别工资 教师护士提高10% 特殊教育提高15%			保留特岗工资			中小学教师保留10%工资	保留护士提高10%工资
			staff_peacetimeAward,staff_basicPerfor,
			-- 平时训练奖			基础绩效
			jbt_total_salary,actual_total_salary,salary_value,theory_total_salary,
			-- 津补贴小计		实发工资合计		工资补扣发		实际应发工资合计
			is_finSupt,is_salUniOut,department_name,
			-- 是否财政供养 是否财政统发 部门
			staff_wageSystem,staff_isUpten,staff_plusGrade,staff_downGrade,staff_plusLevel,staff_floatLevel,staff_fixLevel,staff_downLevel,
			-- 人员工资制度 是否提高10%工资  已含高定级别  已含低定级别		已含高定档次	已含浮动档次	已含固定档次	已含低定档次
			st_sal_date,en_sal_date,staff_status,staff_sex,staff_birth,staff_degree,staff_workYears,staff_from,staff_establish,
			-- 起薪时间 停薪时间	人员状态		性别		出生日期	学位		连续工龄	人员来源	人员编制
			staff_isFullTeacher,staff_salaryStandard,staff_isMainPart,staff_isStop,staff_partYears,staff_isMidTeacher,
			-- 是否专职教师		执行工资标准			是否主力		是否停薪		入队年限		是否中小学教师
			staff_isNurse,staff_fileNum,staff_titleRank,staff_isSpecialTeach,staff_salStandardDate
			-- 是否护士		根据文号		衔级			是否特殊教育		工资标准时间
			,change_time)
			-- 变动时间
			select ',v_i_fund_month,',',v_unit_dataId,',\'',v_unit_id,'\',\'变动前\',',chanType,',
				-- 基金月分	单位id	单位代码	变动前后  变动类型 
				-- (select d.name from sys_s_data d where d.id = ',chanType,') ,
				(case ',chanType,' when ',ryjsCode,' then  
					concat(\'人员减少\',\'(\',(select d.name from sys_s_data d,data_record_t126 t where d.id = t.c46 and t.id = ',sTemRecordId,'),\')\')
				else 
					(select concat(\'',@perString,'\',d.name) from sys_s_data d where d.id = ',chanType,') 
				end) a ,
			
				-- 变动原因  
				\'',chanSign,'\',t126.dataId,t126.c02,t126.c04,
				--   变动标志 人员id 人员编码	人员改名
				t126.c09,t126.c28,t126.c19,
			-- 学历			人员身份		现任职务
				t126.c36,t126.c17,t126.c27,t125.c07,t125.c09,
			-- 实际职务/技术等级	工资对应职级	是否领导工资	工资级别		工资档次
				-- cast(t125.c25 as decimal(10,2)),cast(t125.c26 as decimal(10,2)),cast(t125.c28 as decimal(10,2)),cast(t125.c29 as decimal(10,2)),
				-- round(t125.c25,2),round(t125.c26,2),
				case when (select 1 from sys_s_data where id = t126.c36 and name like \'%期%\') then \'\' else round(t125.c25,2)  end , -- 职务工资
					case when (select 1 from sys_s_data where id = t126.c36 and name like \'%期%\') then \'\' else round(t125.c26,2)  end , -- 级别工资
					case when (select 1 from sys_s_data where id = t126.c36 and name like \'%期%\') then round(ifnull(t125.c25,0),2)+round(ifnull(t125.c26,0),2) else \'\'  end , -- 试用期工资
				round(t125.c28,2),round(t125.c29,2),
				-- cast(t125.c30 as decimal(10,2)),cast(t125.c44 as decimal(10,2)),cast(t125.c45 as decimal(10,2)),
				round(t125.c30,2),round(t125.c44,2),round(t125.c45,2),
			-- 职务/技术等级工资 级别岗位级别工资 教师护士提高10% 特殊教育提高15%			保留特岗工资			中小学教师保留10%工资	保留护士提高10%工资
				-- cast(t125.c47 as decimal(10,2)),cast(t125.c31 as decimal(10,2)),
				round(t125.c47,2),round(t125.c31,2),
			-- 平时训练奖			基础绩效
				-- cast(t125.c27 as decimal(10,2)),cast(t125.c32 as decimal(10,2)),0,cast(t125.c32 as decimal(10,2))+0,
				round(t125.c27,2),round(t125.c32,2),0,round(t125.c32,2),
			-- 津补贴小计 实发工资合计 工资补扣发 实际应发工资合计
			t126.c24,t126.c22,(select c03 from t113 where id=t126.c15),
			-- 是否财政供养 是否财政统发 部门
			t125.c36,t125.c23,t125.c11,t125.c13,t125.c15,t125.c17,t125.c19,t125.c21,
			-- 人员工资制度 是否提高10%工资  已含高定级别  已含低定级别		已含高定档次	已含浮动档次	已含固定档次	已含低定档次
			t125.c02,t125.c38,t126.c03,t126.c05,t126.c08,t126.c10,t126.c14,t126.c16,t126.c21,
			-- 起薪时间 停薪时间	人员状态		性别		出生日期	学位		连续工龄	人员来源	人员编制
			t125.c39,t126.c39,t126.c42,t126.c43,t126.c45,t125.c01,
			-- 是否专职教师		执行工资标准			是否主力		是否停薪		入队年限		是否中小学教师
			t125.c03,t125.c04,t125.c24,t125.c35,t125.c49
			-- 是否护士		根据文号		衔级			是否特殊教育		工资标准时间
			,( select DATE_FORMAT(t126_N.createDate,\'%Y-%m-%d\') from data_record_t126 t126_N where id = ',sTemRecordId,')
		from data_record_t126 t126,data_record_t125 t125 
		where 1=1 and t126.changeSign = t125.changeSign
		  	and   t125.c06 = concat(t126.dataid,\'\') and t126.id = ',sTemPreRecordId);
	-- set resultMsg = concat('@sqlstr:',@sqlstr);leave label_pro;
		PREPARE stmt FROM @sqlstr;
		EXECUTE stmt;
		DROP PREPARE stmt;	
		
		SET @sqlstr = CONCAT('INSERT INTO ', v_allowance_table,'(fund_month,unit_id,unit_code,staff_id,data_type,
				changeSign,allowance_id,allowance_title,salary_value)
				-- 津补贴id 		津补贴名称 	 津补贴金额  津补贴当月实际补发 津补贴后续补发  津补贴标准时间
			select ',v_i_fund_month,',',v_unit_dataId,',\'',v_unit_id,'\',t117.c03,\'变动前\',
			\'',chanSign,'\',t117.c04,t116.c03,round(t117.c07,2)/**,ifnull(t117.c01,DATE_FORMAT(ifnull(t117.updateDate,t117.createDate),\'%Y-%m-%d\'))*/
					-- 基金月分 	 单位代码(51036000) 人员id 津补贴id  津补贴名称 津补贴金额	津补贴标准时间
			from data_record_t117 t117 ,data_record_t126 t126,t116
			where 1=1  and  t117.c03  = concat(t126.dataid,\'\')
			and t126.c01 = \'',v_unit_dataId,'\' 
		  	-- and t126.fund_month = ',v_i_fund_month,'
			and t126.changeSign = t117.changeSign
			and t117.c04 = t116.id and t126.id = ',sTemPreRecordId);
		PREPARE stmt FROM @sqlstr;
		EXECUTE stmt;
		DROP PREPARE stmt;	

		
		SET @sqlstr = CONCAT('INSERT INTO ', v_table,' (fund_month,unit_id,unit_code,data_type,change_type,
			changetype_name,
			changeSign,staff_id,staff_code,staff_name,
			staff_eduLevel,staff_standing,staff_curPost,
			-- 学历			人员身份		现任职务
			staff_actual_workRank,staff_workRank,staff_isLeader,staff_postSalRank,staff_salRankLevel,
			-- 实际职务/技术等级	工资对应职级	是否领导工资	工资级别		工资档次
			staff_jobSal,staff_levelSal,syq_salary,staff_teacherNurseUpTen,staff_specialTeachFifteen,staff_keepSpecialStationSal,staff_midTeacherKeeyTen,staff_keepNurseUpTen,
			-- 职务/技术等级工资 级别岗位级别工资 教师护士提高10% 特殊教育提高15%			保留特岗工资			中小学教师保留10%工资	保留护士提高10%工资
			staff_peacetimeAward,staff_basicPerfor,
			-- 平时训练奖			基础绩效
			jbt_total_salary,actual_total_salary,salary_value,theory_total_salary,
			-- 津补贴小计		实发工资合计		工资补扣发		实际应发工资合计
			is_finSupt,is_salUniOut,department_name,
			-- 是否财政供养 是否财政统发 部门
			staff_wageSystem,staff_isUpten,staff_plusGrade,staff_downGrade,staff_plusLevel,staff_floatLevel,staff_fixLevel,staff_downLevel,
			-- 人员工资制度 是否提高10%工资  已含高定级别  已含低定级别		已含高定档次	已含浮动档次	已含固定档次	已含低定档次
			st_sal_date,en_sal_date,staff_status,staff_sex,staff_birth,staff_degree,staff_workYears,staff_from,staff_establish,
			-- 起薪时间 停薪时间	人员状态		性别		出生日期	学位		连续工龄	人员来源	人员编制
			staff_isFullTeacher,staff_salaryStandard,staff_isMainPart,staff_isStop,staff_partYears,staff_isMidTeacher,
			-- 是否专职教师		执行工资标准			是否主力		是否停薪		入队年限		是否中小学教师
			staff_isNurse,staff_fileNum,staff_titleRank,staff_isSpecialTeach,staff_salStandardDate
			-- 是否护士		根据文号		衔级			是否特殊教育		工资标准时间
			,change_time)
			-- 变动时间
			select ',v_i_fund_month,',',v_unit_dataId,',\'',v_unit_id,'\',\'变动后\',',chanType,',
				-- 基金月分	单位id	单位代码	变动前后  变动类型 
				(case ',chanType,' when ',ryjsCode,' then  
					concat(\'人员减少\',\'(\',(select d.name from sys_s_data d where d.id = t126.c46),\')\')
				else 
					(select concat(\'',@perString,'\',d.name) from sys_s_data d where d.id = ',chanType,') 
				end) a ,
				\'',chanSign,'\',t126.dataId,t126.c02,t126.c04,
				-- 变动原因  变动标志 人员id 人员编码	人员改名
				t126.c09,t126.c28,t126.c19,
			-- 学历			人员身份		现任职务
				t126.c36,t126.c17,t126.c27,t125.c07,t125.c09,
			-- 实际职务/技术等级	工资对应职级	是否领导工资	工资级别		工资档次
				case t126.c43 when 10487 then 0 else 
						case when (select 1 from sys_s_data where id = t126.c36 and name like \'%期%\') then \'\' else round(t125.c25,2)  end 
				 end ,
			-- 如果已经停薪则为0 职务/技术等级工资
			case t126.c43 when 10487 then 0 else 
						case when (select 1 from sys_s_data where id = t126.c36 and name like \'%期%\') then \'\' else round(t125.c26,2)  end 
			 end ,
			-- 试用期工资
			case t126.c43 when 10487 then 0 else 
						case when (select 1 from sys_s_data where id = t126.c36 and name like \'%期%\') then round(ifnull(t125.c25,0),2)+round(ifnull(t125.c26,0),2) else \'\'  end
			 end ,
			-- 级别岗位级别工资
			case t126.c43 when 10487 then 0 else round(t125.c28,2) end ,
			-- 教师护士提高10%
			case t126.c43 when 10487 then 0 else round(t125.c29,2) end ,
			-- 特殊教育提高15%
			case t126.c43 when 10487 then 0 else round(t125.c30,2) end ,
			-- 保留特岗工资
			case t126.c43 when 10487 then 0 else round(t125.c44,2) end ,
			-- 中小学教师保留10%工资
			case t126.c43 when 10487 then 0 else round(t125.c45,2) end ,
			-- 保留护士提高10%工资
			case t126.c43 when 10487 then 0 else round(t125.c47,2) end ,
			-- 平时训练奖
			case t126.c43 when 10487 then 0 else round(t125.c31,2) end ,
			-- 	基础绩效
			case t126.c43 when 10487 then 0 else round(t125.c27,2) end ,
			-- 津补贴小计
			case t126.c43 when 10487 then 0 else round(t125.c32,2) end ,
			-- 工资小计
			0,case t126.c43 when 10487 then 0 else round(t125.c32,2) end,
			-- 工资补扣发		实际应发工资合计
			t126.c24,t126.c22,(select c03 from t113 where id=t126.c15),
			-- 是否财政供养 是否财政统发 部门
			t125.c36,t125.c23,t125.c11,t125.c13,t125.c15,t125.c17,t125.c19,t125.c21,
			-- 人员工资制度 是否提高10%工资  已含高定级别  已含低定级别		已含高定档次	已含浮动档次	已含固定档次	已含低定档次
			t125.c02,t125.c38,t126.c03,t126.c05,t126.c08,t126.c10,t126.c14,t126.c16,t126.c21,
			-- 起薪时间 停薪时间	人员状态		性别		出生日期	学位		连续工龄	人员来源	人员编制
			t125.c39,t126.c39,t126.c42,t126.c43,t126.c45,t125.c01,
			-- 是否专职教师		执行工资标准			是否主力		是否停薪		入队年限		是否中小学教师
			t125.c03,t125.c04,t125.c24,t125.c35,t125.c49
			-- 是否护士		根据文号		衔级			是否特殊教育		工资标准时间
			,DATE_FORMAT(t126.createDate,\'%Y-%m-%d\')
		from data_record_t126 t126,data_record_t125 t125 
		where 1=1 and t126.changeSign = t125.changeSign
		  	and  t125.c06 = concat(t126.dataid ,\'\') and t126.id = ',sTemRecordId);
		PREPARE stmt FROM @sqlstr;
		EXECUTE stmt;
		DROP PREPARE stmt;	
		
		SET @sqlstr = CONCAT('INSERT INTO ', v_allowance_table,'(fund_month,unit_id,unit_code,staff_id,data_type,
				changeSign,allowance_id,allowance_title,salary_value)
				-- 津补贴id 		津补贴名称 	 津补贴金额  津补贴当月实际补发 津补贴后续补发  津补贴标准时间
			select ',v_i_fund_month,',',v_unit_dataId,',\'',v_unit_id,'\',t117.c03,\'变动后\',
			\'',chanSign,'\',t117.c04,t116.c03,case t126.c43 when 10487 then 0 else round(t117.c07,2) end
					-- 基金月分 	 单位代码(51036000) 人员id 津补贴id  津补贴名称 津补贴金额	津补贴标准时间
			from data_record_t117 t117 ,data_record_t126 t126,t116
			where 1=1  and  t117.c03 =concat(t126.dataid,\'\')
			and t126.c01 = \'',v_unit_dataId,'\'
		  	-- and t126.fund_month = ',v_i_fund_month,'
			and t126.changeSign = t117.changeSign
			 and t117.c04 = t116.id and t126.id = ',sTemRecordId);
		PREPARE stmt FROM @sqlstr;
		EXECUTE stmt;
		DROP PREPARE stmt;	
		-- 10487 是否标准 t126.c43 是否停薪
		/*数据插入-增减资*/
		SET @sqlstr = CONCAT('INSERT INTO ',v_table,'(fund_month,unit_id,unit_code,data_type,change_type,
			changetype_name,changeSign,staff_id,staff_code,staff_name,
			staff_eduLevel,staff_standing,staff_actual_workRank,staff_workRank,staff_isLeader,staff_postSalRank,staff_salRankLevel,
			staff_jobSal,staff_levelSal,syq_salary,staff_teacherNurseUpTen,
			-- 职务/技术等级工资 级别岗位级别工资 教师护士提高10%
			staff_specialTeachFifteen,staff_keepSpecialStationSal,staff_midTeacherKeeyTen,
			-- 特殊教育提高15%			保留特岗工资				中小学教师保留10%
			staff_keepNurseUpTen,staff_peacetimeAward,staff_basicPerfor,
			-- 保留护士提高10%		平时训练奖			基础绩效
			jbt_total_salary,actual_total_salary,salary_value,theory_total_salary,
			-- 津补贴小计		实发工资合计	工资补扣发	实际应发工资合计	
			is_finSupt,is_salUniOut,department_name,st_sal_date,en_sal_date,change_time,change_attachment)
			-- 是否财政供养  是否财政统发 部门		起薪时间	停薪时间 变动时间
		select t1.fund_month,t1.unit_id,t1.unit_code,\'增减资\',t1.change_type,
			t1.changetype_name,\'',chanSign,'\',t1.staff_id,t1.staff_code,t1.staff_name,
				-- 基金月分		单位代码	增减资	人员id		人员姓名		变动类型 
				t1.staff_eduLevel,t1.staff_standing,\'\',\'\',\'\',\'\',\'\',
				-- 学历				人员身份
				round((ifnull(t1.staff_jobSal,0)-ifnull(t2.staff_jobSal,0)),2),
				-- 职务/技术等级工资
				-- case t1.staff_levelSal-t2.staff_levelSal when 0 then \'\' else ifnull(t1.staff_levelSal,\'\')-ifnull(t2.staff_levelSal,\'\') end  ,
				round((ifnull(t1.staff_levelSal,0)-ifnull(t2.staff_levelSal,0)),2),
				-- 级别岗位级别工资
				round((ifnull(t1.syq_salary,0)-ifnull(t2.syq_salary,0)),2),
				-- 试用期工资
				-- case t1.staff_teacherNurseUpTen-t2.staff_teacherNurseUpTen when 0 then \'\' else ifnull(t1.staff_teacherNurseUpTen,\'\')-ifnull(t2.staff_teacherNurseUpTen,\'\') end  ,
				round((ifnull(t1.staff_teacherNurseUpTen,0)-ifnull(t2.staff_teacherNurseUpTen,0)),2),
				-- 	教师护士提高10%
				round(( ifnull(t1.staff_specialTeachFifteen,0)-ifnull(t2.staff_specialTeachFifteen,0)),2)   ,
				-- 特殊教育提高15%													
				-- case t1.staff_keepSpecialStationSal-t2.staff_keepSpecialStationSal when 0 then \'\' else ifnull(t1.staff_keepSpecialStationSal,\'\')-ifnull(t2.staff_keepSpecialStationSal,\'\') end  ,
				round((ifnull(t1.staff_keepSpecialStationSal,0)-ifnull(t2.staff_keepSpecialStationSal,0)),2),
				-- 保留特岗工资
				-- case t1.staff_midTeacherKeeyTen-t2.staff_midTeacherKeeyTen when 0 then \'\' else ifnull(t1.staff_midTeacherKeeyTen,\'\')-ifnull(t2.staff_midTeacherKeeyTen,\'\') end  ,
				round((ifnull(t1.staff_midTeacherKeeyTen,0)-ifnull(t2.staff_midTeacherKeeyTen,0)),2),
				-- 中小学教师保留10%		
				-- case t1.staff_keepNurseUpTen-t2.staff_keepNurseUpTen when 0 then \'\' else ifnull(t1.staff_keepNurseUpTen,\'\')-ifnull(t2.staff_keepNurseUpTen,\'\') end  ,
				round((ifnull(t1.staff_keepNurseUpTen,0)-ifnull(t2.staff_keepNurseUpTen,0)),2),
				-- 保留护士提高10%
				-- case t1.staff_peacetimeAward-t2.staff_peacetimeAward when 0 then \'\' else ifnull(t1.staff_peacetimeAward,\'\')-ifnull(t2.staff_peacetimeAward,\'\') end  ,
				round((ifnull(t1.staff_peacetimeAward,0)-ifnull(t2.staff_peacetimeAward,0)),2),
				-- 平时训练奖
				-- case t1.staff_basicPerfor-t2.staff_basicPerfor when 0 then \'\' else ifnull(t1.staff_basicPerfor,\'\')-ifnull(t2.staff_basicPerfor,\'\') end  ,
				round((ifnull(t1.staff_basicPerfor,0)-ifnull(t2.staff_basicPerfor,0)),2),
				--  基础绩效
				-- case t1.jbt_total_salary-t2.jbt_total_salary when 0 then \'\' else ifnull(t1.jbt_total_salary,\'\')-ifnull(t2.jbt_total_salary,\'\') end  ,
				round((ifnull(t1.jbt_total_salary,0)-ifnull(t2.jbt_total_salary,0)),2),
				-- 津补贴小计	
				case ifnull(c.total_salary_bf,0) when 0 then 
					case t1.actual_total_salary-t2.actual_total_salary when 0 then \'\' else round((t1.actual_total_salary-t2.actual_total_salary),2) end
					when \'\' then \'\'
				else 
					case t1.actual_total_salary-t2.actual_total_salary when 0 then \'\' else round((t1.actual_total_salary-t2.actual_total_salary),2) end
				end ,
				--  实发工资合计
				ifnull(c.total_salary_bf,0) ,
				-- 工资补扣发
				case ifnull(c.total_salary_bf,0) when 0 then
					case t126.c43 when 10487 then 0 else 
						case t1.theory_total_salary-t2.theory_total_salary when 0 then \'\' else round((t1.theory_total_salary-t2.theory_total_salary),2) end
					end
				else 
					case t1.theory_total_salary-t2.theory_total_salary when 0 then \'\' else round((t1.theory_total_salary-t2.theory_total_salary),2) end
				end ,
				-- 实际应发工资合计
				t1.is_finSupt,t1.is_salUniOut,t1.department_name,t1.st_sal_date,t1.en_sal_date 
				-- 是否财政供养 		是否财政统发		部门			起薪时间		停薪时间
				,t1.change_time,t125.c48
			from ',v_table,' t1 join ',v_table,' t2 on t1.changeSign = t2.changeSign
			join data_record_t126 t126 on t126.changeSign = t1.changeSign 
			join data_record_t125 t125 on t125.changeSign = t1.changeSign 
			left join fund_salary_fill_',v_i_fund_month,' c on t1.changeSign = c.changeSign
			where 1=1 
			and t1.fund_month = t2.fund_month 
			and t1.unit_id = t2.unit_id
			and t1.data_type = \'变动后\' 
			and t2.data_type = \'变动前\' and t1.changeSign = \'',chanSign,'\'
			and  t1.fund_month = ',v_i_fund_month,' and t1.unit_id = \'',v_unit_dataId,'\'');
		PREPARE stmt FROM @sqlstr;
		EXECUTE stmt;
		DROP PREPARE stmt;
			
		/*津补贴插入-增减资*/
		SET @sqlstr = CONCAT('INSERT INTO ', v_allowance_table,'(fund_month,unit_id,unit_code,staff_id,data_type,
				changeSign,allowance_id,allowance_title,salary_value)
				-- 津补贴id 		津补贴名称 	 津补贴金额  津补贴当月实际补发 津补贴后续补发  津补贴标准时间
			select ',v_i_fund_month,',',v_unit_dataId,',\'',v_unit_id,'\',t1.staff_id,\'增减资\',
			\'',chanSign,'\',t1.allowance_id,t1.allowance_title,
			case t1.salary_value-ifnull(t2.salary_value,0) 
				when 0 then \'\' else   round(t1.salary_value-ifnull(t2.salary_value,0) ,2) end                              -- cast(t1.salary_value-ifnull(t2.salary_value,0) as decimal(10,2)) end  -- round(t117.c07,2),
			-- 基金月分 	 单位代码(51036000) 人员id 津补贴id  津补贴名称 津补贴金额	津补贴标准时间
			from ',v_allowance_table,' t1 left join ',v_allowance_table,' t2 
			on t1.changeSign = t2.changeSign 
			and t1.fund_month = t2.fund_month and t1.unit_id = t2.unit_id
			and t1.allowance_id = t2.allowance_id and t1.staff_id = t2.staff_id 
			and t2.data_type = \'变动前\'
			join data_record_t126 t126 on t126.changeSign = t1.changeSign
			where 1=1 
			and t1.data_type = \'变动后\' and t1.changeSign = \'',chanSign,'\'
			and  t1.fund_month = ',v_i_fund_month,' and t1.unit_id = \'',v_unit_dataId,'\'');
	-- set resultMsg = concat('@sqlstr:',@sqlstr);leave label_pro;
		PREPARE stmt FROM @sqlstr;
		EXECUTE stmt;
		DROP PREPARE stmt;
    end if;
    set done = @done;
  END LOOP;
  -- 关闭游标
  CLOSE recordId_;
  
  
  
  
  
		SET @sqlstr = CONCAT('update ', v_table,' set jbt_total_salary =round(jbt_total_salary,2) ,
				salary_value = round(salary_value,2),
				actual_total_salary = round(actual_total_salary,2),
				 theory_total_salary = round(theory_total_salary,2),
				 staff_jobSal = round(staff_jobSal,2),
				staff_levelSal = round(staff_levelSal,2) 
				 where fund_month = ',v_i_fund_month,'  and unit_id =\'',v_unit_dataId,'\'' );

	-- set resultMsg = concat('@sqlstr:',@sqlstr);leave label_pro;
		PREPARE stmt FROM @sqlstr;
		EXECUTE stmt;
		DROP PREPARE stmt;
  

END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`p_3_fund`(in v_i_fund_month varchar(6),in v_unit_id varchar(50),
in v_unit_dataId int(11),inout resultMsg varchar(10000))
label_pro:BEGIN
/*基金生成-分支存储过程 工资发放表fund_salary_pay__201607*/
DECLARE stempNum int(11);
DECLARE v_table VARCHAR(50);
DECLARE v_allowance_table VARCHAR(50);
declare sysDataBase varchar(20);-- 数据库名称

SET v_table =  CONCAT('fund_salary_pay_',v_i_fund_month);/*处理分表存储*/
SET v_allowance_table =  CONCAT('fund_salary_subsidies_pay_',v_i_fund_month);/*处理分表存储*/

	
-- SET @sqlstr = CONCAT('DROP TABLE IF EXISTS ', v_table);
-- PREPARE stmt FROM @sqlstr;
-- EXECUTE stmt;

	select content into sysDataBase from sys_s_config where enname = 'DATABASE_NAME';-- 数据库名称

select count(1) into stempNum from information_schema.tables where table_schema = sysDataBase and TABLE_NAME = v_table;-- smso数据库里面对应的工资发放表信息

if stempNum < 1 then -- 判断是否已经存在v_i_fund_month(如201608)的工资发放表信息
	SET @sqlstr = CONCAT('CREATE TABLE ',v_table,' LIKE ', ' fund_salary_pay');
	PREPARE stmt FROM @sqlstr;
	EXECUTE stmt;
	DROP PREPARE stmt;
end if;
select count(1) into stempNum from information_schema.tables where table_schema = sysDataBase and TABLE_NAME = v_allowance_table;-- smso数据库里面对应的津补贴发放表信息
if stempNum < 1 then -- 判断是否已经存在v_i_fund_month(如201608)的工资发放表信息
	SET @sqlstr = CONCAT('CREATE TABLE ',v_allowance_table,' LIKE ', ' fund_salary_subsidies_pay');
	PREPARE stmt FROM @sqlstr;
	EXECUTE stmt;
	DROP PREPARE stmt;
	-- call p_fund_addIndex(v_i_fund_month,'fund_salary_pay',resultMsg);-- 发放表生成索引
end if;

/*数据插入*/
/*
--t126.c02人员编号
--t126.c04人员姓名
--t126.c09学历
--t126.c28人员身份
--t126.c19现任职务
--t126.c36实际职务/技术等级
--t126.c17工资对应职级
--t126.c27是否领导工资
-- t125.c07工资级别
--t125.c09工资档次
--t125.c25职务/技术等级工资
--t125.c26级别岗位级别工资;
--t125.c28教师护士提高10%;
--t125.c29特殊教育提高15%;
--t125.c30保留特岗工资;
--t125.c44中小学教师保留10%工资;-> 退役运动员保留工资额度;
--t125.c45保留护士提高10%工资;
--t125.c47平时训练奖;
--t125.c31基础绩效;
--t125.c27津补贴小计;
--t125.c32实发工资合计;
-- 0 工资补扣发;
--t125.c32+0实际应发工资合计
--(select name from sys_s_data where id=t126.c24)财政供养
--(select name from sys_s_data where id=t126.c22)财政统发
--(select c03 from t113 where id=t126.c15)部门
*/
SET @sqlstr = CONCAT('delete from  ', v_table,' where unit_id=\'',v_unit_dataId,'\'');
PREPARE stmt FROM @sqlstr;
EXECUTE stmt;
DROP PREPARE stmt;
SET @sqlstr = CONCAT('delete from  ', v_allowance_table,' where unit_id=\'',v_unit_dataId,'\'');
PREPARE stmt FROM @sqlstr;
EXECUTE stmt;
DROP PREPARE stmt;

SET @sqlstr = CONCAT('INSERT INTO ', v_table,' (fund_month,unit_id,unit_code,staff_id,staff_code,staff_name,
		staff_eduLevel,staff_standing,staff_curPost,
		-- 学历			人员身份		现任职务
		staff_actual_workRank,staff_workRank,staff_isLeader,staff_postSalRank,staff_salRankLevel,
		-- 实际职务/技术等级	工资对应职级	是否领导工资	工资级别		工资档次
		staff_jobSal,staff_levelSal,staff_teacherNurseUpTen,staff_specialTeachFifteen,staff_keepSpecialStationSal,staff_midTeacherKeeyTen,staff_keepNurseUpTen,
		-- 职务/技术等级工资 级别岗位级别工资 教师护士提高10% 特殊教育提高15%			保留特岗工资		中小学教师保留10%工资/退役运动员保留工资额度	保留护士提高10%工资
		staff_peacetimeAward,staff_basicPerfor,
		-- 平时训练奖			基础绩效
		jbt_total_salary,part_total_salary,total_salary,actual_total_salary,salary_value,theory_total_salary,
		-- 津补贴小计	工资小计  工资合计	实发工资合计		工资补扣发		实际应发工资合计
		is_finSupt,is_salUniOut,department_name,
		-- 是否财政供养 是否财政统发 部门
		staff_wageSystem,staff_isUpten,staff_plusGrade,staff_downGrade,staff_plusLevel,staff_floatLevel,staff_fixLevel,staff_downLevel,
		-- 人员工资制度 是否提高10%工资  已含高定级别  已含低定级别		已含高定档次	已含浮动档次	已含固定档次	已含低定档次
		st_sal_date,en_sal_date,staff_status,staff_sex,staff_birth,staff_degree,staff_workYears,staff_from,staff_establish,
		-- 起薪时间 停薪时间	人员状态		性别		出生日期	学位		连续工龄	人员来源	人员编制
		staff_isChuFen,staff_salaryStandard,staff_isMainPart,staff_isStop,staff_partYears,staff_isMidTeacher,
		-- 是否处分		执行工资标准			是否主力		是否停薪		入队年限		是否中小学教师
		staff_isNurse,staff_fileNum,staff_titleRank,staff_isSpecialTeach,staff_salStandardDate
		-- 是否护士		根据文号		衔级			是否特殊教育		工资标准时间
		,staff_czbm,staff_sbid,staff_mz,staff_sfz,staff_bysj
		-- 财政编码 社保号 民族 身份证号 毕业时间
		,staff_jrbdwsj,staff_cjgzsj,staff_xrzwsj,staff_jdgl
		-- 进入本单位时间 参加工作时间 现任职务时间 间断工龄
		,staff_kjsgl,staff_wjsgl,staff_jbsj,staff_dcsj
		-- 工作前可计算工龄 未计算学习工龄 级别起考年份 档次起考年份
		,staff_gddc,staff_gdyj,staff_fddc,staff_fdyj
		-- 高定档次 高定依据 浮动档次 浮动依据 
		,staff_gudingdc,staff_gudingyj,staff_dddc,staff_ddyj
		-- 固定档次 固定依据 低定档次 低定原因
		,staff_gdjb,staff_gdjbyj,staff_ddjb,staff_ddjbyj,staff_node
		-- 高定级别 高定级别依据 低定级别 低定级别依据
		)
		select ',v_i_fund_month,',',v_unit_dataId,',\'',v_unit_id,'\',t126.dataid,t126.c02,t126.c04,
			ifnull((select d.name from sys_s_data d where d.id = t126.c09),t126.c09),ifnull((select d.name from sys_s_data d where d.id = t126.c28),t126.c28),t126.c19,
		-- 学历			人员身份		现任职务
			ifnull((select d.name from sys_s_data d where d.id = t126.c36),t126.c36),(select t127.c05 from t127 where t127.id = t126.c17),
		-- 实际职务/技术等级	工资对应职级	
			(select t127.c04 from t127 where t127.id = t126.c27),(select t127.c05 from t127 where t127.id = t125.c07),(select t127.c04 from t127 where t127.id = t125.c09),
		-- 是否领导工资	工资级别		工资档次
			case t126.c43 when 10487 then \'\' else t125.c25 end ,
			-- 如果已经停薪则为0 职务/技术等级工资
			case t126.c43 when 10487 then \'\' else t125.c26 end ,
			-- 级别岗位级别工资
			case t126.c43 when 10487 then \'\' else t125.c28 end ,
			-- 教师护士提高10%
			case t126.c43 when 10487 then \'\' else t125.c29 end ,
			-- 特殊教育提高15%
			case t126.c43 when 10487 then \'\' else t125.c30 end ,
			-- 保留特岗工资
			case t126.c43 when 10487 then \'\' else t125.c44 end ,
			-- 中小学教师保留10%工资/退役运动员保留工资额度
			case t126.c43 when 10487 then \'\' else t125.c45 end ,
			-- 保留护士提高10%工资
			case t126.c43 when 10487 then \'\' else t125.c47 end ,
			-- 平时训练奖
			case t126.c43 when 10487 then \'\' else t125.c31 end ,
			-- 	基础绩效
			case t126.c43 when 10487 then 0 else t125.c27 end ,
			-- 津补贴小计
			case t126.c43 when 10487 then 0 else t125.c32 end ,
			-- 工资小计
			case t126.c43 when 10487 then 0 else t125.c32 end ,
			-- 工资合计
			case t126.c43 when 10487 then 0+sum(ifnull(c.total_salary_bf,0)) else t125.c32+sum(ifnull(c.total_salary_bf,0)) end,
			-- 实发工资合计
			sum(c.total_salary_bf),
			-- 工资补扣发
			case t126.c43 when 10487 then \'\' else t125.c32+0 end ,
			--   实际应发工资合计
			ifnull((select d.name from sys_s_data d where d.id = t126.c24),t126.c24),ifnull((select d.name from sys_s_data d where d.id = t126.c22),t126.c22),(select c03 from t113 where id=t126.c15),
			-- 是否财政供养 是否财政统发 部门
			ifnull((select d.name from sys_s_data d where d.id = t125.c36),t125.c36),ifnull((select d.name from sys_s_data d where d.id = t125.c23),t125.c23)
			-- 人员工资制度 是否提高10%工资
			,t125.c11,t125.c13,t125.c15,t125.c17,t125.c19,t125.c21,
			--    已含高定级别  已含低定级别		已含高定档次	已含浮动档次	已含固定档次	已含低定档次
			t125.c02,t125.c38,ifnull((select d.name from sys_s_data d where d.id = t126.c03),t126.c03),
			-- 起薪时间 停薪时间	人员状态		
			ifnull((select d.name from sys_s_data d where d.id = t126.c05),t126.c05),t126.c08,ifnull((select d.name from sys_s_data d where d.id = t126.c10),t126.c10),
			-- 性别		出生日期	学位		
			t126.c14,ifnull((select d.name from sys_s_data d where d.id = t126.c16),t126.c16),ifnull((select d.name from sys_s_data d where d.id = t126.c21),t126.c21),
			-- 连续工龄	人员来源	人员编制
			ifnull((select d.name from sys_s_data d where d.id = t125.c39),t125.c39),ifnull((select d.name from sys_s_data d where d.id = t126.c39),t126.c39),
			-- 是否处分  执行工资标准/工资标准类别
			ifnull((select d.name from sys_s_data d where d.id = t126.c42),t126.c42),ifnull((select d.name from sys_s_data d where d.id = t126.c43),t126.c43),
			--   是否主力		是否停薪	
			t126.c45,ifnull((select d.name from sys_s_data d where d.id = t125.c01),t125.c01),
			--	入队年限		是否中小学教师
			ifnull((select d.name from sys_s_data d where d.id = t125.c03),t125.c03),t125.c04,
			-- 是否护士		根据文号		
			ifnull((select d.name from sys_s_data d where d.id = t125.c24),t125.c24),ifnull((select d.name from sys_s_data d where d.id = t125.c35),t125.c35),t125.c49
			-- 衔级			是否特殊教育		工资标准时间
			,t126.c23,t126.c25,t126.c06,t126.c07,t126.c11
			-- 财政编码 社保号 民族 身份证号 毕业时间
			,t126.c13,t126.c12,t126.c20,concat(t126.c34,\'.\',t126.c35)
			-- 进入本单位时间 参加工作时间 现任职务时间 间断工龄
			,concat(t126.c32,\'.\',t126.c33),concat(t126.c30,\'.\',t126.c31),t125.c08,t125.c10
			-- 工作前可计算工龄 未计算学习工龄 级别起考年份 档次起考年份
			,t125.c15,t125.c16,t125.c17,t125.c18
			-- 高定档次 高定依据 浮动档次 浮动依据 
			,t125.c19,t125.c20,t125.c21,t125.c22
			-- 固定档次 固定依据 低定档次 低定原因
			,t125.c11,t125.c12,t125.c13,t125.c14,t126.c29
			-- 高定级别 高定级别依据 低定级别 低定级别依据
	-- from data_record_t126 t126 join data_record_t125 t125 on concat(t126.dataid,\'\') = t125.c06  left join fund_salary_fill_',v_i_fund_month,' c on t126.dataid = c.staff_id and c.unit_id = \'',v_unit_dataId,'\'
	 from (select * from (select * from data_record_t126 where c01 = \'',v_unit_dataId,'\' order by id desc) a 
			GROUP BY dataid) t126 join data_record_t125 t125 
		on t126.changesign = t125.changesign
		 left join fund_salary_fill_',v_i_fund_month,' c on t126.dataid = c.staff_id
		 and c.unit_id = \'',v_unit_dataId,'\' 
	where t126.c01 = \'',v_unit_dataId,'\'  
	and t126.c03 = \'10371\'-- 在职的人员
	-- and ifnull(t126.c43,\'\')!=10487 -- 是否停薪 排除已经停薪了的人
	 and t126.changeType != \'10831\' -- 排除人员减少的数据
	 group by t126.dataid   order by t126.dataid');
PREPARE stmt FROM @sqlstr;
EXECUTE stmt;
DROP PREPARE stmt;	

SET @sqlstr = CONCAT('INSERT INTO ', v_table,' (fund_month,unit_id,unit_code,staff_id,staff_code,staff_name,
		staff_eduLevel,staff_standing,staff_curPost,
		-- 学历			人员身份		现任职务
		staff_actual_workRank,staff_workRank,staff_isLeader,staff_postSalRank,staff_salRankLevel,
		-- 实际职务/技术等级	工资对应职级	是否领导工资	工资级别		工资档次
		staff_jobSal,staff_levelSal,staff_teacherNurseUpTen,staff_specialTeachFifteen,staff_keepSpecialStationSal,staff_midTeacherKeeyTen,staff_keepNurseUpTen,
		-- 职务/技术等级工资 级别岗位级别工资 教师护士提高10% 特殊教育提高15%			保留特岗工资		中小学教师保留10%工资/退役运动员保留工资额度	保留护士提高10%工资
		staff_peacetimeAward,staff_basicPerfor,
		-- 平时训练奖			基础绩效
		jbt_total_salary,part_total_salary,total_salary,actual_total_salary,salary_value,theory_total_salary,
		-- 津补贴小计	工资小计  工资合计	实发工资合计		工资补扣发		实际应发工资合计
		is_finSupt,is_salUniOut,department_name,
		-- 是否财政供养 是否财政统发 部门
		staff_wageSystem,staff_isUpten,staff_plusGrade,staff_downGrade,staff_plusLevel,staff_floatLevel,staff_fixLevel,staff_downLevel,
		-- 人员工资制度 是否提高10%工资  已含高定级别  已含低定级别		已含高定档次	已含浮动档次	已含固定档次	已含低定档次
		st_sal_date,en_sal_date,staff_status,staff_sex,staff_birth,staff_degree,staff_workYears,staff_from,staff_establish,
		-- 起薪时间 停薪时间	人员状态		性别		出生日期	学位		连续工龄	人员来源	人员编制
		staff_isChuFen,staff_salaryStandard,staff_isMainPart,staff_isStop,staff_partYears,staff_isMidTeacher,
		-- 是否处分		执行工资标准			是否主力		是否停薪		入队年限		是否中小学教师
		staff_isNurse,staff_fileNum,staff_titleRank,staff_isSpecialTeach,staff_salStandardDate
		-- 是否护士		根据文号		衔级			是否特殊教育		工资标准时间
		,staff_czbm,staff_sbid,staff_mz,staff_sfz,staff_bysj
		-- 财政编码 社保号 民族 身份证号 毕业时间
		,staff_jrbdwsj,staff_cjgzsj,staff_xrzwsj,staff_jdgl
		-- 进入本单位时间 参加工作时间 现任职务时间 间断工龄
		,staff_kjsgl,staff_wjsgl,staff_jbsj,staff_dcsj
		-- 工作前可计算工龄 未计算学习工龄 级别起考年份 档次起考年份
		,staff_gddc,staff_gdyj,staff_fddc,staff_fdyj
		-- 高定档次 高定依据 浮动档次 浮动依据 
		,staff_gudingdc,staff_gudingyj,staff_dddc,staff_ddyj
		-- 固定档次 固定依据 低定档次 低定原因
		,staff_gdjb,staff_gdjbyj,staff_ddjb,staff_ddjbyj
		-- 高定级别 高定级别依据 低定级别 低定级别依据
		)
		select ',v_i_fund_month,',',v_unit_dataId,',\'',v_unit_id,'\',t126.dataid,t126.c02,t126.c04,
			ifnull((select d.name from sys_s_data d where d.id = t126.c09),t126.c09),ifnull((select d.name from sys_s_data d where d.id = t126.c28),t126.c28),t126.c19,
		-- 学历			人员身份		现任职务
			ifnull((select d.name from sys_s_data d where d.id = t126.c36),t126.c36),(select t127.c05 from t127 where t127.id = t126.c17),
		-- 实际职务/技术等级	工资对应职级	
			(select t127.c04 from t127 where t127.id = t126.c27),(select t127.c05 from t127 where t127.id = t125.c07),(select t127.c04 from t127 where t127.id = t125.c09),
		-- 是否领导工资	工资级别		工资档次
			0 ,
			-- 如果已经停薪则为0 职务/技术等级工资
			0 ,
			-- 级别岗位级别工资
			0 ,
			-- 教师护士提高10%
			0 ,
			-- 特殊教育提高15%
			0 ,
			-- 保留特岗工资
			0 ,
			-- 中小学教师保留10%工资/退役运动员保留工资额度
			0 ,
			-- 保留护士提高10%工资
			0 ,
			-- 平时训练奖
			0 ,
			-- 	基础绩效
			0 ,
			-- 津补贴小计
			0 ,
			-- 工资小计
			0 ,
			-- 工资合计
			sum(c.total_salary_bf),
			-- 实发工资合计
			sum(c.total_salary_bf),
			-- 工资补扣发
			0 ,
			--   实际应发工资合计
			ifnull((select d.name from sys_s_data d where d.id = t126.c24),t126.c24),ifnull((select d.name from sys_s_data d where d.id = t126.c22),t126.c22),(select c03 from t113 where id=t126.c15),
			-- 是否财政供养 是否财政统发 部门
			ifnull((select d.name from sys_s_data d where d.id = t125.c36),t125.c36),ifnull((select d.name from sys_s_data d where d.id = t125.c23),t125.c23)
			-- 人员工资制度 是否提高10%工资
			,t125.c11,t125.c13,t125.c15,t125.c17,t125.c19,t125.c21,
			--    已含高定级别  已含低定级别		已含高定档次	已含浮动档次	已含固定档次	已含低定档次
			t125.c02,t125.c38,\'减少\',
			-- 起薪时间 停薪时间	人员状态		
			ifnull((select d.name from sys_s_data d where d.id = t126.c05),t126.c05),t126.c08,ifnull((select d.name from sys_s_data d where d.id = t126.c10),t126.c10),
			-- 性别		出生日期	学位		
			t126.c14,ifnull((select d.name from sys_s_data d where d.id = t126.c16),t126.c16),ifnull((select d.name from sys_s_data d where d.id = t126.c21),t126.c21),
			-- 连续工龄	人员来源	人员编制
			ifnull((select d.name from sys_s_data d where d.id = t125.c39),t125.c39),ifnull((select d.name from sys_s_data d where d.id = t126.c39),t126.c39),
			-- 是否处分  执行工资标准/工资标准类别
			ifnull((select d.name from sys_s_data d where d.id = t126.c42),t126.c42),ifnull((select d.name from sys_s_data d where d.id = t126.c43),t126.c43),
			--   是否主力		是否停薪	
			t126.c45,ifnull((select d.name from sys_s_data d where d.id = t125.c01),t125.c01),
			--	入队年限		是否中小学教师
			ifnull((select d.name from sys_s_data d where d.id = t125.c03),t125.c03),t125.c04,
			-- 是否护士		根据文号		
			ifnull((select d.name from sys_s_data d where d.id = t125.c24),t125.c24),ifnull((select d.name from sys_s_data d where d.id = t125.c35),t125.c35),t125.c49
			-- 衔级			是否特殊教育		工资标准时间
			,t126.c23,t126.c25,t126.c06,t126.c07,t126.c11
			-- 财政编码 社保号 民族 身份证号 毕业时间
			,t126.c13,t126.c12,t126.c20,concat(t126.c34,\'.\',t126.c35)
			-- 进入本单位时间 参加工作时间 现任职务时间 间断工龄
			,concat(t126.c32,\'.\',t126.c33),concat(t126.c30,\'.\',t126.c31),t125.c08,t125.c10
			-- 工作前可计算工龄 未计算学习工龄 级别起考年份 档次起考年份
			,t125.c15,t125.c16,t125.c17,t125.c18
			-- 高定档次 高定依据 浮动档次 浮动依据 
			,t125.c19,t125.c20,t125.c21,t125.c22
			-- 固定档次 固定依据 低定档次 低定原因
			,t125.c11,t125.c12,t125.c13,t125.c14
			-- 高定级别 高定级别依据 低定级别 低定级别依据
	-- from data_record_t126 t126 join data_record_t125 t125 on concat(t126.dataid,\'\') = t125.c06  left join fund_salary_fill_',v_i_fund_month,' c on t126.dataid = c.staff_id and c.unit_id = \'',v_unit_dataId,'\'
			from (select * from (select * from data_record_t126 where c01 = \'',v_unit_dataId,'\' order by id desc) a  GROUP BY dataid ) t126 join data_record_t125 t125 
-- on concat(t126.dataid,'') = t125.c06 
			on t126.changesign = t125.changesign
			  join fund_salary_fill_',v_i_fund_month,'  c on t126.dataid = c.staff_id
			 and c.unit_id =\'',v_unit_dataId,'\' 	
	where 
	  t126.dataid = c.staff_id 
	 and t126.c01 = \'',v_unit_dataId,'\'  
	 and t126.changeType = \'10831\' -- 变动类型为人员减少 
	 and t126.allAuditFlag != 2 -- 审核不通过   以前的月份的减少人员才能做减少人员补扣发，才能添加到发放表（传输财政减少人员补扣发只传以前月份减少的人员的补扣发）
	and not exists(select 1 from sys_s_data d where d.id = t126.c03 and d.typename = \'staffStatus\' and d.data_value = \'2\')
	-- 非离休人员
	 group by t126.dataid order by t126.dataid ');
PREPARE stmt FROM @sqlstr;
EXECUTE stmt;
DROP PREPARE stmt;	
 -- 以前月份的减少人员做减少人员一次性补扣发
SET @sqlstr = CONCAT('INSERT INTO ', v_table,' (fund_month,unit_id,unit_code,staff_id,staff_code,staff_name,
		staff_eduLevel,staff_standing,staff_curPost,
		-- 学历			人员身份		现任职务
		staff_actual_workRank,staff_workRank,staff_isLeader,staff_postSalRank,staff_salRankLevel,
		-- 实际职务/技术等级	工资对应职级	是否领导工资	工资级别		工资档次
		staff_jobSal,staff_levelSal,staff_teacherNurseUpTen,staff_specialTeachFifteen,staff_keepSpecialStationSal,staff_midTeacherKeeyTen,staff_keepNurseUpTen,
		-- 职务/技术等级工资 级别岗位级别工资 教师护士提高10% 特殊教育提高15%			保留特岗工资		中小学教师保留10%工资/退役运动员保留工资额度	保留护士提高10%工资
		staff_peacetimeAward,staff_basicPerfor,
		-- 平时训练奖			基础绩效
		jbt_total_salary,part_total_salary,total_salary,actual_total_salary,salary_value,theory_total_salary,
		-- 津补贴小计	工资小计  工资合计	实发工资合计		工资补扣发		实际应发工资合计
		is_finSupt,is_salUniOut,department_name,
		-- 是否财政供养 是否财政统发 部门
		staff_wageSystem,staff_isUpten,staff_plusGrade,staff_downGrade,staff_plusLevel,staff_floatLevel,staff_fixLevel,staff_downLevel,
		-- 人员工资制度 是否提高10%工资  已含高定级别  已含低定级别		已含高定档次	已含浮动档次	已含固定档次	已含低定档次
		st_sal_date,en_sal_date,staff_status,staff_sex,staff_birth,staff_degree,staff_workYears,staff_from,staff_establish,
		-- 起薪时间 停薪时间	人员状态		性别		出生日期	学位		连续工龄	人员来源	人员编制
		staff_isChuFen,staff_salaryStandard,staff_isMainPart,staff_isStop,staff_partYears,staff_isMidTeacher,
		-- 是否处分		执行工资标准			是否主力		是否停薪		入队年限		是否中小学教师
		staff_isNurse,staff_fileNum,staff_titleRank,staff_isSpecialTeach,staff_salStandardDate
		-- 是否护士		根据文号		衔级			是否特殊教育		工资标准时间
		,staff_czbm,staff_sbid,staff_mz,staff_sfz,staff_bysj
		-- 财政编码 社保号 民族 身份证号 毕业时间
		,staff_jrbdwsj,staff_cjgzsj,staff_xrzwsj,staff_jdgl
		-- 进入本单位时间 参加工作时间 现任职务时间 间断工龄
		,staff_kjsgl,staff_wjsgl,staff_jbsj,staff_dcsj
		-- 工作前可计算工龄 未计算学习工龄 级别起考年份 档次起考年份
		,staff_gddc,staff_gdyj,staff_fddc,staff_fdyj
		-- 高定档次 高定依据 浮动档次 浮动依据 
		,staff_gudingdc,staff_gudingyj,staff_dddc,staff_ddyj
		-- 固定档次 固定依据 低定档次 低定原因
		,staff_gdjb,staff_gdjbyj,staff_ddjb,staff_ddjbyj,staff_node
		-- 高定级别 高定级别依据 低定级别 低定级别依据
		)
		select ',v_i_fund_month,',',v_unit_dataId,',\'',v_unit_id,'\',t126.dataid,t126.c02,t126.c04,
			ifnull((select d.name from sys_s_data d where d.id = t126.c09),t126.c09),ifnull((select d.name from sys_s_data d where d.id = t126.c28),t126.c28),t126.c19,
		-- 学历			人员身份		现任职务
			ifnull((select d.name from sys_s_data d where d.id = t126.c36),t126.c36),(select t127.c05 from t127 where t127.id = t126.c17),
		-- 实际职务/技术等级	工资对应职级	
			(select t127.c04 from t127 where t127.id = t126.c27),(select t127.c05 from t127 where t127.id = t125.c07),(select t127.c04 from t127 where t127.id = t125.c09),
		-- 是否领导工资	工资级别		工资档次
			0 ,
			-- 如果已经停薪则为0 职务/技术等级工资
			0 ,
			-- 级别岗位级别工资
			0 ,
			-- 教师护士提高10%
			0 ,
			-- 特殊教育提高15%
			0 ,
			-- 保留特岗工资
			0 ,
			-- 中小学教师保留10%工资/退役运动员保留工资额度
			0 ,
			-- 保留护士提高10%工资
			0 ,
			-- 平时训练奖
			0 ,
			-- 	基础绩效
			0 ,
			-- 津补贴小计
			0 ,
			-- 工资小计
			0 ,
			-- 工资合计
			sum(c.total_salary_bf),
			-- 实发工资合计
			sum(c.total_salary_bf),
			-- 工资补扣发
			0 ,
			--   实际应发工资合计
			ifnull((select d.name from sys_s_data d where d.id = t126.c24),t126.c24),ifnull((select d.name from sys_s_data d where d.id = t126.c22),t126.c22),(select c03 from t113 where id=t126.c15),
			-- 是否财政供养 是否财政统发 部门
			ifnull((select d.name from sys_s_data d where d.id = t125.c36),t125.c36),ifnull((select d.name from sys_s_data d where d.id = t125.c23),t125.c23)
			-- 人员工资制度 是否提高10%工资
			,t125.c11,t125.c13,t125.c15,t125.c17,t125.c19,t125.c21,
			--    已含高定级别  已含低定级别		已含高定档次	已含浮动档次	已含固定档次	已含低定档次
			t125.c02,t125.c38,\'减少\',
			-- 起薪时间 停薪时间	人员状态		
			ifnull((select d.name from sys_s_data d where d.id = t126.c05),t126.c05),t126.c08,ifnull((select d.name from sys_s_data d where d.id = t126.c10),t126.c10),
			-- 性别		出生日期	学位		
			t126.c14,ifnull((select d.name from sys_s_data d where d.id = t126.c16),t126.c16),ifnull((select d.name from sys_s_data d where d.id = t126.c21),t126.c21),
			-- 连续工龄	人员来源	人员编制
			ifnull((select d.name from sys_s_data d where d.id = t125.c39),t125.c39),ifnull((select d.name from sys_s_data d where d.id = t126.c39),t126.c39),
			-- 是否处分  执行工资标准/工资标准类别
			ifnull((select d.name from sys_s_data d where d.id = t126.c42),t126.c42),ifnull((select d.name from sys_s_data d where d.id = t126.c43),t126.c43),
			--   是否主力		是否停薪	
			t126.c45,ifnull((select d.name from sys_s_data d where d.id = t125.c01),t125.c01),
			--	入队年限		是否中小学教师
			ifnull((select d.name from sys_s_data d where d.id = t125.c03),t125.c03),t125.c04,
			-- 是否护士		根据文号		
			ifnull((select d.name from sys_s_data d where d.id = t125.c24),t125.c24),ifnull((select d.name from sys_s_data d where d.id = t125.c35),t125.c35),t125.c49
			-- 衔级			是否特殊教育		工资标准时间
			,t126.c23,t126.c25,t126.c06,t126.c07,t126.c11
			-- 财政编码 社保号 民族 身份证号 毕业时间
			,t126.c13,t126.c12,t126.c20,concat(t126.c34,\'.\',t126.c35)
			-- 进入本单位时间 参加工作时间 现任职务时间 间断工龄
			,concat(t126.c32,\'.\',t126.c33),concat(t126.c30,\'.\',t126.c31),t125.c08,t125.c10
			-- 工作前可计算工龄 未计算学习工龄 级别起考年份 档次起考年份
			,t125.c15,t125.c16,t125.c17,t125.c18
			-- 高定档次 高定依据 浮动档次 浮动依据 
			,t125.c19,t125.c20,t125.c21,t125.c22
			-- 固定档次 固定依据 低定档次 低定原因
			,t125.c11,t125.c12,t125.c13,t125.c14,\'人员 减少\' 
			-- 高定级别 高定级别依据 低定级别 低定级别依据
	-- from data_record_t126 t126 join data_record_t125 t125 on concat(t126.dataid,\'\') = t125.c06  left join fund_salary_fill_',v_i_fund_month,' c on t126.dataid = c.staff_id and c.unit_id = \'',v_unit_dataId,'\'
			from (select * from (select * from data_record_t126 where c01 = \'',v_unit_dataId,'\' order by id desc) a  GROUP BY dataid ) t126 join data_record_t125 t125 
-- on concat(t126.dataid,'') = t125.c06 
			on t126.changesign = t125.changesign
			  join fund_salary_fill_',v_i_fund_month,'  c on t126.dataid = c.staff_id
			 and c.unit_id =\'',v_unit_dataId,'\' 	
	where 
	  t126.dataid = c.staff_id 
	 and t126.c01 = \'',v_unit_dataId,'\'  
	 and t126.changeType = \'10831\' -- 变动类型为人员减少 
	 and t126.allAuditFlag = 2 -- 审核不通过   以前的月份的减少人员才能做减少人员补扣发，才能添加到发放表（传输财政减少人员补扣发只传以前月份减少的人员的补扣发）
	and t126.fund_month != ',v_i_fund_month,'
	and not exists(select 1 from sys_s_data d where d.id = t126.c03 and d.typename = \'staffStatus\' and d.data_value = \'2\')
	-- 非离休人员
	 group by t126.dataid order by t126.dataid ');
PREPARE stmt FROM @sqlstr;
EXECUTE stmt;
DROP PREPARE stmt;	

/*
SET @sqlstr = CONCAT('INSERT INTO ', v_allowance_table,'(fund_month,unit_id,unit_code,staff_id,
		allowance_id,allowance_title,salary_value,salary_sj_bf,salary_hx_bf ,staff_salStandardDate)
		-- 津补贴id 		津补贴名称 	 津补贴金额  津补贴当月实际补发 津补贴后续补发  津补贴标准时间
	select ',v_i_fund_month,',',v_unit_dataId,',\'',v_unit_id,'\',t117.c03,t117.c04,t116.c03,
			-- 基金月分 	   单位代码(51036000) 人员id 津补贴id  津补贴名称
	case t126.c43 when 10487 then \'\' else t117.c07 end,sum(c.salary_sj_bf),0  ,t117.c01
	--  津补贴金额 津补贴当月实际补发 津补贴后续补发  津补贴标准时间
	from t117 join t116 on t117.c04 = concat(t116.id,\'\') join data_record_t126 on t117.c03 = concat(t126.dataid,\'\')
	left join fund_salary_fill_subsidies_',v_i_fund_month,' c on t126.dataid = c.staff_id and c.jbt_id = t116.id
	where 1=1 and t126.c01 = \'',v_unit_dataId,'\'
	-- and ifnull(t126.c43,\'\')!=10487 -- 是否停薪 排除已经停薪了的人
	and (t126.c03 = \'10371\' 
		or exists(select 1 from data_record_t126 d where d.dataId = t126.id and allAuditFlag != 2)
		or exists(select 1 from fund_salary_fill_',v_i_fund_month,' d where d.staff_id = t126.id )
	)
	and not exists(select 1 from sys_s_data d where d.id = t126.c03 and d.typename = \'staffStatus\' and d.data_value = \'2\')
	-- 非离休人员
	group by t126.id,t116.id ');
PREPARE stmt FROM @sqlstr;
EXECUTE stmt;
DROP PREPARE stmt;*/


SET @sqlstr = CONCAT('INSERT INTO ', v_allowance_table,'(fund_month,unit_id,unit_code,staff_id,
		allowance_id,allowance_title,salary_value,salary_sj_bf,salary_hx_bf ,staff_salStandardDate)
		-- 津补贴id 		津补贴名称 	 津补贴金额  津补贴当月实际补发 津补贴后续补发  津补贴标准时间
	select ',v_i_fund_month,',',v_unit_dataId,',\'',v_unit_id,'\',t117.c03,t117.c04,t116.c03,
			-- 基金月分 	   单位代码(51036000) 人员id 津补贴id  津补贴名称
	case t126.c43 when 10487 then \'\' else t117.c07 end,sum(c.salary_sj_bf),0  ,t117.c01
	--  津补贴金额 津补贴当月实际补发 津补贴后续补发  津补贴标准时间
	from t117 join t116 on t117.c04 = concat(t116.id,\'\') 
		join (select * from (select * from data_record_t126 where c01 = \'',v_unit_dataId,'\' order by id desc) a 
			GROUP BY dataid) t126 on t117.c03 = concat(t126.dataid,\'\')
		left join fund_salary_fill_subsidies_',v_i_fund_month,' c on t126.dataid = c.staff_id and c.jbt_id = t116.id
	where 1=1 and t126.c01 = \'',v_unit_dataId,'\'
	-- and ifnull(t126.c43,\'\')!=10487 -- 是否停薪 排除已经停薪了的人
	and t126.c03 = \'10371\'-- 在职的人员
	and t126.changeType != \'10831\' -- 排除人员减少的数据	
	-- 非离休人员
	group by t126.dataid,t116.id ');
PREPARE stmt FROM @sqlstr;
EXECUTE stmt;
DROP PREPARE stmt;


SET @sqlstr = CONCAT('INSERT INTO ', v_allowance_table,'(fund_month,unit_id,unit_code,staff_id,
		allowance_id,allowance_title,salary_value,salary_sj_bf,salary_hx_bf ,staff_salStandardDate)
		-- 津补贴id 		津补贴名称 	 津补贴金额  津补贴当月实际补发 津补贴后续补发  津补贴标准时间
	select ',v_i_fund_month,',',v_unit_dataId,',\'',v_unit_id,'\',t117.c03,t117.c04,t116.c03,
			-- 基金月分 	   单位代码(51036000) 人员id 津补贴id  津补贴名称
	case t126.c43 when 10487 then \'\' else t117.c07 end,sum(c.salary_sj_bf),0  ,t117.c01
	--  津补贴金额 津补贴当月实际补发 津补贴后续补发  津补贴标准时间
	from t117 join t116 on t117.c04 = concat(t116.id,\'\') 
		join (select * from (select * from data_record_t126 where c01 = \'',v_unit_dataId,'\' order by id desc) a 
			GROUP BY dataid) t126 on t117.c03 = concat(t126.dataid,\'\')
		left join fund_salary_fill_subsidies_',v_i_fund_month,' c on t126.dataid = c.staff_id and c.jbt_id = t116.id
	where 1=1 and t126.c01 = \'',v_unit_dataId,'\'
	-- and ifnull(t126.c43,\'\')!=10487 -- 是否停薪 排除已经停薪了的人
	and t126.changeType = \'10831\' -- 变动类型为人员减少 
	 and t126.allAuditFlag != 2 -- 未审核通过
	and not exists(select 1 from sys_s_data d where d.id = t126.c03 and d.typename = \'staffStatus\' and d.data_value = \'2\')	
	-- 非离休人员
	group by t126.dataid,t116.id order by t126.dataid');
PREPARE stmt FROM @sqlstr;
EXECUTE stmt;
DROP PREPARE stmt;
	-- update v_table set jbt_total_salary =cast(jbt_total_salary as decimal(10,2)) where fund_month = v_i_fund_month and unit_id =v_unit_dataId;
	-- update v_table set salary_value =cast(salary_value as decimal(10,2)) where fund_month = v_i_fund_month and unit_id =v_unit_dataId;
	-- update v_table set actual_total_salary =cast(actual_total_salary as decimal(10,2)) where fund_month = v_i_fund_month and unit_id =v_unit_dataId;
	-- update v_table set theory_total_salary =cast(theory_total_salary as decimal(10,2)) where fund_month = v_i_fund_month and unit_id =v_unit_dataId;
	
		SET @sqlstr = CONCAT('update ', v_table,' set jbt_total_salary = round(jbt_total_salary,2) ,
	salary_value = round(salary_value,2),
	 actual_total_salary = round(actual_total_salary,2),
 theory_total_salary = round(theory_total_salary,2)
 where  unit_id =\'',v_unit_dataId,'\'' );

	-- set resultMsg = concat('@sqlstr:',@sqlstr);leave label_pro;
		PREPARE stmt FROM @sqlstr;
		EXECUTE stmt;
		DROP PREPARE stmt;
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`p_4_fund`(in v_i_fund_month varchar(6),in v_unit_id varchar(50),
in v_unit_dataId int(11),inout resultMsg varchar(10000))
label_pro:BEGIN
/*基金生成-分支存储过程 事业人数核定表fund_total_person_ins/事业核定表fund_total_ins*/
	DECLARE stemNum int(11);-- 参数变量
	DECLARE stempParam varchar(20);-- 参数变量
	DECLARE stempMonth varchar(20);-- 参数变量 
	DECLARE stemParam varchar(20);-- 参数变量

	DECLARE lrxjryCode varchar(20);-- 录入新进人员code
	DECLARE jbxxxgCode varchar(20);-- 人员基本信息修改codeid
	DECLARE ryjsCode varchar(20);-- 人员减少-变动记录codeid
	DECLARE hfgzdyCode varchar(20);-- 恢复工资待遇-变动记录codeid

	DECLARE czbm varchar(20);-- 财政编码
 	
	DECLARE czgyNum varchar(10);-- 财政供养-人数
	DECLARE cztfNum varchar(10);-- 财政统发-人数
	DECLARE xzbzNum varchar(10);-- 行政编制-编制数
	DECLARE xzbzSjNum varchar(10);-- 行政编制-实有数
	DECLARE dlbzNum varchar(10);-- 单列编制-编制数
	DECLARE dlbzSjNum varchar(10);-- 单列编制-实有数
	DECLARE jjbzNum varchar(10);-- 纪检编制-编制数
	DECLARE jjbzSjNum varchar(10);-- 纪检编制-实有数
	DECLARE jzbzNum varchar(10);-- 军转编制-编制数
	DECLARE jzbzSjNum varchar(10);-- 军转编制-实有数
	DECLARE zfzxbzNum varchar(10);-- 政法专项编制-编制数
	DECLARE zfzxbzSjNum varchar(10);-- 政法专项编制-实有数
	DECLARE qebkNum varchar(10);-- 全额拨款编制-编制数
	DECLARE qebkSjNum varchar(10);-- 全额拨款编制-实有数
	DECLARE xzzfNum varchar(10);-- 行政执法编制-编制数
	DECLARE xzzfSjNum varchar(10);-- 行政执法编制-实有数
	DECLARE jggcNum varchar(10);-- 机关工勤编制-编制数
	DECLARE jggcSjNum varchar(10);-- 机关工勤编制-实有数
	DECLARE cebkNum varchar(10);-- 差额拨款-编制数
	DECLARE cebkSjNum varchar(10);-- 差额拨款-实有数
	DECLARE zszzNum varchar(10);-- 自收自支-编制数
	DECLARE zszzSjNum varchar(10);-- 自收自支-实有数
 	
 	DECLARE byhdrsNum int(11);-- 本月核定人数
 	
 	DECLARE sybzNum int(11);-- 核定事业编制数（人员控制数）
	DECLARE qeNum int(11);--  全额-人数
	DECLARE ceNum int(11);-- 差额-人数
	-- DECLARE zszzNum int(11);-- 自收自支-人数
	-- DECLARE czgyNum int(11);-- 财政供养-人数
	-- DECLARE cztfNum int(11);-- 财政统发-人数 
	
	DECLARE glryNum int(11);-- 管理人员数量
	DECLARE zyjsNum int(11);-- 专业技术数量
	DECLARE gcryNum int(11);-- 工勤人员数量
	DECLARE syqNum int(11);-- 试用期人员数量
	DECLARE ydyNum int(11);-- 运动员数量

	DECLARE zjNum int(11);-- 增加小计

	DECLARE kszpNum int(11);-- 考试招聘数量
	DECLARE khzpNum int(11);-- 考核招聘数量
	DECLARE gzNum int(11);-- 公招 数量
	DECLARE szNum int(11);-- 社招 数量
	DECLARE drNum int(11);-- 调入数量
	DECLARE jzgbNum int(11);-- 军转干部数量
	DECLARE ftjrNum int(11);-- 复退军人数量
	DECLARE qtzjNum int(11);-- 其他增加数量

	DECLARE jsNum int(11);-- 减少小计

	DECLARE ltxNum int(11);-- 退(离)休数量
	DECLARE dcNum int(11);-- 调出数量
	DECLARE swNum int(11);-- 死亡数量
	DECLARE cpNum int(11);-- 辞聘数量
	DECLARE jpNum int(11);-- 解聘数量
	DECLARE kcNum int(11);-- 开除数量
	DECLARE zzhtNum int(11);-- 中止合同数量
	DECLARE zdlzNum int(11);-- 自动离职数量
	DECLARE qtjsNum int(11);-- 其他减少数量

	-- select count(1) into stemNum from t112 where id = v_unit_dataId; -- t111 单位基本信息表
	select count(1) into stemNum from t112 where c01 = concat(v_unit_dataId,''); -- t112 基层单位编制表
	if stemNum = 0 then
		 set resultMsg = '单位编制信息获取失败';
		 leave label_pro;
	end if;

	select count(1) into stemNum from t126 where c01 = concat(v_unit_dataId,'') -- t126 人员基本信息 c01-单位代码
	and not exists(select 1 from sys_s_data d where d.id = t126.c03 and d.typename = 'staffStatus' and d.data_value = '2')
	-- 非离休人员
	;  
	select count(1) into @stemNumRecord126 from data_record_t126 t126 where c01 = concat(v_unit_dataId,'') -- t126 人员基本信息 c01-单位代码
	and not exists(select 1 from sys_s_data d where d.id = t126.c03 and d.typename = 'staffStatus' and d.data_value = '2')
	-- 非离休人员
	and fund_month = v_i_fund_month
	; 
	select count(1) into @stemNumT119 from t119 where c04 = concat(v_unit_dataId,'') -- t126 人员基本信息 c01-单位代码
	and  exists(select 1 from t126 where t119.c01 = t126.id and t126.c03!=10372 )
	-- 非离休人员
	; 
	set stemNum = stemNum +@stemNumRecord126 + @stemNumT119 ;



	if stemNum = 0 then
		 set resultMsg = '当前单位没有人员信息';
		 leave label_pro;
	end if;	

	
	set @maxMonth = 0 ;
	select max(fund_month) into @maxMonth from fund_total_person_ins where unit_id = v_unit_dataId;
	if @maxMonth != 0 then 
		select @maxMonth - v_i_fund_month into @countMonth;
		if @countMonth > 0 and @countMonth < 12 then 
			set @tempMonth = @maxMonth;
				WHILE @tempMonth < v_i_fund_month DO
					set @tempMonth = @tempMonth+1;
					INSERT into fund_total_person_ins(fund_month,unit_id,unit_code,cz_code,czgy_num,cztf_num,xzbz_num,xzbz_sj_num,dlbz_num,dlbz_sj_num,
					jjbz_num,jjbz_sj_num,jzbz_num,jzbz_sj_num,zfzxbz_num,zfzxbz_sj_num,qebk_num,qebk_sj_num,xzzf_num,xzzf_sj_num,jggc_num,jggc_sj_num,
					cebk_num,cebk_sj_num,zszz_num,zszz_sj_num,glry_num,zyjs_num,gq_num,syq_num,ydy_num,increase_part_total,kszp_num,khzp_num,dr_num,
					jz_num,ftjr_num,other_incr_num,decrease_part_total,tlx_num,dc_num,sw_num,cp_num,jp_num,kc_num,zdlz_num,zzht_num,other_decr_num,
					this_month_person_num,gz_kenum,pre_glry_num,pre_zyjs_num,pre_gq_num,pre_syq_num,pre_ydy_num,pre_month_person_num,gz_num,sz_num
					) select @tempMonth,
					unit_id,unit_code,cz_code,czgy_num,cztf_num,xzbz_num,xzbz_sj_num,dlbz_num,dlbz_sj_num,
					jjbz_num,jjbz_sj_num,jzbz_num,jzbz_sj_num,zfzxbz_num,zfzxbz_sj_num,qebk_num,qebk_sj_num,xzzf_num,xzzf_sj_num,jggc_num,jggc_sj_num,
					cebk_num,cebk_sj_num,zszz_num,zszz_sj_num,glry_num,zyjs_num,gq_num,syq_num,ydy_num,increase_part_total,kszp_num,khzp_num,dr_num,
					jz_num,ftjr_num,other_incr_num,decrease_part_total,tlx_num,dc_num,sw_num,cp_num,jp_num,kc_num,zdlz_num,zzht_num,other_decr_num,
					this_month_person_num,gz_kenum,pre_glry_num,pre_zyjs_num,pre_gq_num,pre_syq_num,pre_ydy_num,pre_month_person_num,gz_num,sz_num
					 from fund_total_person_ins where unit_Id = concat(v_unit_dataId,'') and fund_month =  @maxMonth;
										
				END WHILE;
		 elseif	 @countMonth >= 12	then				
			select  12-SUBSTR(@maxMonth FROM 5) into @loopCountPer;
			select   SUBSTR(v_i_fund_month FROM 5) into @loopCountAfter;
			set @tempCount = 0;
			WHILE @tempCount < @loopCountPer DO
					set @tempCount = @tempCount+1;
					INSERT into fund_total_person_ins(fund_month,unit_id,unit_code,cz_code,czgy_num,cztf_num,xzbz_num,xzbz_sj_num,dlbz_num,dlbz_sj_num,
					jjbz_num,jjbz_sj_num,jzbz_num,jzbz_sj_num,zfzxbz_num,zfzxbz_sj_num,qebk_num,qebk_sj_num,xzzf_num,xzzf_sj_num,jggc_num,jggc_sj_num,
					cebk_num,cebk_sj_num,zszz_num,zszz_sj_num,glry_num,zyjs_num,gq_num,syq_num,ydy_num,increase_part_total,kszp_num,khzp_num,dr_num,
					jz_num,ftjr_num,other_incr_num,decrease_part_total,tlx_num,dc_num,sw_num,cp_num,jp_num,kc_num,zdlz_num,zzht_num,other_decr_num,
					this_month_person_num,gz_kenum,pre_glry_num,pre_zyjs_num,pre_gq_num,pre_syq_num,pre_ydy_num,pre_month_person_num,gz_num,sz_num
					) select @maxMonth*1+@tempCount,
					unit_id,unit_code,cz_code,czgy_num,cztf_num,xzbz_num,xzbz_sj_num,dlbz_num,dlbz_sj_num,
					jjbz_num,jjbz_sj_num,jzbz_num,jzbz_sj_num,zfzxbz_num,zfzxbz_sj_num,qebk_num,qebk_sj_num,xzzf_num,xzzf_sj_num,jggc_num,jggc_sj_num,
					cebk_num,cebk_sj_num,zszz_num,zszz_sj_num,glry_num,zyjs_num,gq_num,syq_num,ydy_num,increase_part_total,kszp_num,khzp_num,dr_num,
					jz_num,ftjr_num,other_incr_num,decrease_part_total,tlx_num,dc_num,sw_num,cp_num,jp_num,kc_num,zdlz_num,zzht_num,other_decr_num,
					this_month_person_num,gz_kenum,pre_glry_num,pre_zyjs_num,pre_gq_num,pre_syq_num,pre_ydy_num,pre_month_person_num,gz_num,sz_num
					 from fund_total_person_ins where unit_Id = concat(v_unit_dataId,'') and fund_month =  @maxMonth;
										
				END WHILE;
				
			set @tempCount = 0;
			select SUBSTR(v_i_fund_month FROM 1 for 4) into @nowYear;
			WHILE @tempCount < @loopCountAfter DO
					set @tempCount = @tempCount+1;
					if @tempCount < 10 then
						set @tempCount = concat('0',@tempCount);
					end if;	
					INSERT into fund_total_person_ins(fund_month,unit_id,unit_code,cz_code,czgy_num,cztf_num,xzbz_num,xzbz_sj_num,dlbz_num,dlbz_sj_num,
					jjbz_num,jjbz_sj_num,jzbz_num,jzbz_sj_num,zfzxbz_num,zfzxbz_sj_num,qebk_num,qebk_sj_num,xzzf_num,xzzf_sj_num,jggc_num,jggc_sj_num,
					cebk_num,cebk_sj_num,zszz_num,zszz_sj_num,glry_num,zyjs_num,gq_num,syq_num,ydy_num,increase_part_total,kszp_num,khzp_num,dr_num,
					jz_num,ftjr_num,other_incr_num,decrease_part_total,tlx_num,dc_num,sw_num,cp_num,jp_num,kc_num,zdlz_num,zzht_num,other_decr_num,
					this_month_person_num,gz_kenum,pre_glry_num,pre_zyjs_num,pre_gq_num,pre_syq_num,pre_ydy_num,pre_month_person_num,gz_num,sz_num
					) select concat(@nowYear,@tempCount),
					unit_id,unit_code,cz_code,czgy_num,cztf_num,xzbz_num,xzbz_sj_num,dlbz_num,dlbz_sj_num,
					jjbz_num,jjbz_sj_num,jzbz_num,jzbz_sj_num,zfzxbz_num,zfzxbz_sj_num,qebk_num,qebk_sj_num,xzzf_num,xzzf_sj_num,jggc_num,jggc_sj_num,
					cebk_num,cebk_sj_num,zszz_num,zszz_sj_num,glry_num,zyjs_num,gq_num,syq_num,ydy_num,increase_part_total,kszp_num,khzp_num,dr_num,
					jz_num,ftjr_num,other_incr_num,decrease_part_total,tlx_num,dc_num,sw_num,cp_num,jp_num,kc_num,zdlz_num,zzht_num,other_decr_num,
					this_month_person_num,gz_kenum,pre_glry_num,pre_zyjs_num,pre_gq_num,pre_syq_num,pre_ydy_num,pre_month_person_num,gz_num,sz_num
					 from fund_total_person_ins where unit_Id = concat(v_unit_dataId,'') and fund_month =  @maxMonth;
										
				END WHILE;
		end if;
	end if;
	
	select ifnull(content,10750) into lrxjryCode from sys_s_config where enname = 'CHANGETYPE_NEWPERSON_CODE';
	select ifnull(content,10751) into jbxxxgCode from sys_s_config where enname = 'CHANGETYPE_INFO_CODE';
	select ifnull(content,10831) into ryjsCode from sys_s_config where enname = 'RYJS_CHANGE_CODE';
	select ifnull(content,10654) into hfgzdyCode from sys_s_config where enname = 'CHANGETYPE_RECOVERYSALARY_CODE';
	
	select ifnull(t128.c01,t111.c15) into czbm from t111 left join t128 on t111.c15 = t128.id where 1=1 and t111.id = v_unit_dataId ; -- t111.c15 单位财政编码 关联 t128 单位财政编码表c01 编码 c02 名称
	select ifnull(c02,0),ifnull(c03,0),ifnull(c04,0),ifnull(c05,0),ifnull(c06,0),ifnull(c08,0),ifnull(c10,0),ifnull(c07,0),ifnull(c12,0),ifnull(c13,0) 
	into xzbzNum,dlbzNum,jjbzNum,jzbzNum,zfzxbzNum,qebkNum,xzzfNum,jggcNum,cebkNum,zszzNum
	 from t112 where c01 = concat(v_unit_dataId,'');-- t112 基层单位编制表 
	-- c02-行政编制,c03-单列编制,c04-纪检编制,c05-军转编制,c06-政法专项编制,c08-全额拨款事业编制,c10-行政执法事业编制,c07-机关工勤人员控制数,c12-差额拨款编制,c13-自收自支编制

	select count(1) into czgyNum from t126,t125 b ,sys_s_data d where t126.c01 = concat(v_unit_dataId,'') 
		and concat(t126.id,'') = b.c06
		and t126.c24 = d.id and d.typename = 'is' and d.data_value = '1'
		-- and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in( 204,205)); -- 人员工资制度为  204 -事业岗位绩效工资制 205-体育津贴奖金制
		and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1') -- t126.c03 人员状态-码表 1-在职
		and not exists (select 1 from t126 d where d.id = t126.id and ifnull(d.c46,'')!='') 
		-- 不是调出的人员
		;
		
	select count(1) into cztfNum from t126,t125 b,sys_s_data d where t126.c01 = concat(v_unit_dataId,'') 
		and concat(t126.id,'') = b.c06
		and t126.c22 = d.id and d.typename = 'is' and d.data_value = '1' -- 财政统发-人数t126.c22 是否工资统发
		-- and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in( 204,205)); -- 人员工资制度为  204 -事业岗位绩效工资制 205-体育津贴奖金制
		and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1') -- t126.c03 人员状态-码表 1-在职
		and not exists (select 1 from t126 d where d.id = t126.id and ifnull(d.c46,'')!='') 
		-- 不是调出的人员
		;
	select count(1) into xzbzSjNum from t126,t125 b ,sys_s_data d where t126.c01 = concat(v_unit_dataId,'') -- t126.c21 人员基本信息-人员编制
		and concat(t126.id,'') = b.c06
		and t126.c21 = concat(d.id,'') and d.typename = 'rybz' and d.data_value = '0101' -- 行政编制 实有数 
		-- and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in( 204,205))  -- 人员工资制度为  204 -事业岗位绩效工资制 205-体育津贴奖金制
		and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1') -- t126.c03 人员状态-码表 1-在职
		and not exists (select 1 from t126 d where d.id = t126.id and ifnull(d.c46,'')!='') 
		-- 不是调出的人员
		;
	select count(1) into dlbzSjNum from t126 ,t125 b ,sys_s_data d where t126.c01 = concat(v_unit_dataId,'') 
		and concat(t126.id,'') = b.c06
		and t126.c21 = concat(d.id,'') and d.typename = 'rybz' and d.data_value = '0102' -- 单列编制-实有数 
		-- and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in( 204,205))  -- 人员工资制度为  204 -事业岗位绩效工资制 205-体育津贴奖金制
		and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1') -- t126.c03 人员状态-码表 1-在职
		and not exists (select 1 from t126 d where d.id = t126.id and ifnull(d.c46,'')!='') 
		-- 不是调出的人员
		;
	select count(1) into jjbzSjNum from t126 ,t125 b ,sys_s_data d where t126.c01 = concat(v_unit_dataId,'') 
		and concat(t126.id,'') = b.c06
		and t126.c21 = concat(d.id,'') and d.typename = 'rybz' and d.data_value = '0103'-- 纪检编制-实有数 
		-- and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in( 204,205)) -- 人员工资制度为  204 -事业岗位绩效工资制 205-体育津贴奖金制
		and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1') -- t126.c03 人员状态-码表 1-在职
		and not exists (select 1 from t126 d where d.id = t126.id and ifnull(d.c46,'')!='') 
		-- 不是调出的人员
		;
	select count(1) into jzbzSjNum from t126 ,t125 b ,sys_s_data d where t126.c01 = concat(v_unit_dataId,'') 
		and concat(t126.id,'') = b.c06
		and t126.c21 = concat(d.id,'') and d.typename = 'rybz' and d.data_value = '0104' -- 军转编制-实有数
		-- and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in( 204,205)); -- 人员工资制度为  204 -事业岗位绩效工资制 205-体育津贴奖金制
		and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1') -- t126.c03 人员状态-码表 1-在职
		and not exists (select 1 from t126 d where d.id = t126.id and ifnull(d.c46,'')!='') 
		-- 不是调出的人员
		;
	select count(1) into zfzxbzSjNum from t126 ,t125 b ,sys_s_data d where t126.c01 = concat(v_unit_dataId,'') 
		and concat(t126.id,'') = b.c06
		and t126.c21 = concat(d.id,'') and d.typename = 'rybz' and d.data_value in('011','0111','0112','0113','0114','0115')-- 政法专项编制-实有数
		-- and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in( 204,205)) -- 人员工资制度为  204 -事业岗位绩效工资制 205-体育津贴奖金制
		and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1') -- t126.c03 人员状态-码表 1-在职
		and not exists (select 1 from t126 d where d.id = t126.id and ifnull(d.c46,'')!='') 
		-- 不是调出的人员
		;
	select count(1) into qebkSjNum from t126 ,t125 b ,sys_s_data d where t126.c01 = concat(v_unit_dataId,'') 
		and concat(t126.id,'') = b.c06
		and t126.c21 = concat(d.id,'') and d.typename = 'rybz' and d.data_value = '0201' -- 全额拨款编制-实有数
		-- and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in( 204,205))  -- 人员工资制度为  204 -事业岗位绩效工资制 205-体育津贴奖金制
		and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1') -- t126.c03 人员状态-码表 1-在职
		and not exists (select 1 from t126 d where d.id = t126.id and ifnull(d.c46,'')!='') 
		-- 不是调出的人员
		;
	select count(1) into xzzfSjNum from t126 ,t125 b ,sys_s_data d where t126.c01 = concat(v_unit_dataId,'') 
		and concat(t126.id,'') = b.c06
		and t126.c21 = concat(d.id,'') and d.typename = 'rybz' and d.data_value = '0202' -- 行政执法编制-实有数
		-- and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in( 204,205))  -- 人员工资制度为  204 -事业岗位绩效工资制 205-体育津贴奖金制
		and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1') -- t126.c03 人员状态-码表 1-在职
		and not exists (select 1 from t126 d where d.id = t126.id and ifnull(d.c46,'')!='') 
		-- 不是调出的人员
		;
	select count(1) into jggcSjNum from t126 ,t125 b ,sys_s_data d where t126.c01 = concat(v_unit_dataId,'') 
		and concat(t126.id,'') = b.c06
		and t126.c21 = concat(d.id,'') and d.typename = 'rybz' and d.data_value = '0203' -- 机关工勤编制-实有数
		-- and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in( 204,205))  -- 人员工资制度为  204 -事业岗位绩效工资制 205-体育津贴奖金制
		and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1') -- t126.c03 人员状态-码表 1-在职
		and not exists (select 1 from t126 d where d.id = t126.id and ifnull(d.c46,'')!='') 
		-- 不是调出的人员
		;
	select count(1) into cebkSjNum from t126 ,t125 b ,sys_s_data d where t126.c01 = concat(v_unit_dataId,'') 
		and concat(t126.id,'') = b.c06
		and t126.c21 = concat(d.id,'') and d.typename = 'rybz' and d.data_value = '021' -- 差额拨款-实有数
		-- and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in( 204,205))  -- 人员工资制度为  204 -事业岗位绩效工资制 205-体育津贴奖金制
		and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1') -- t126.c03 人员状态-码表 1-在职
		and not exists (select 1 from t126 d where d.id = t126.id and ifnull(d.c46,'')!='') 
		-- 不是调出的人员
		;
	select count(1) into zszzSjNum from t126 ,t125 b ,sys_s_data d where t126.c01 = concat(v_unit_dataId,'') 
		and concat(t126.id,'') = b.c06
		and t126.c21 = concat(d.id,'') and d.typename = 'rybz' and d.data_value = '022' -- 自收自支-实有数 
		-- and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in( 204,205))  -- 人员工资制度为  204 -事业岗位绩效工资制 205-体育津贴奖金制
		and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1') -- t126.c03 人员状态-码表 1-在职
		and not exists (select 1 from t126 d where d.id = t126.id and ifnull(d.c46,'')!='') 
		-- 不是调出的人员
		;
	select DATE_FORMAT(DATE_SUB(concat(v_i_fund_month,'01'),INTERVAL 1 MONTH),'%Y%m')  into stempMonth ;
	
/*数据清理*/
	DELETE FROM fund_total_person_ins WHERE fund_month = concat(v_i_fund_month,'') and unit_id = concat(v_unit_dataId,'') ;
	DELETE FROM fund_total_ins WHERE fund_month = concat(v_i_fund_month,'') and unit_id = concat(v_unit_dataId,'') ;
	

	INSERT INTO fund_total_person_ins(fund_month,unit_id,unit_code,cz_code,czgy_num,cztf_num,xzbz_num,xzbz_sj_num,dlbz_num,dlbz_sj_num,jjbz_num,jjbz_sj_num,jzbz_num,jzbz_sj_num,zfzxbz_num,zfzxbz_sj_num,
		qebk_num,qebk_sj_num,xzzf_num,xzzf_sj_num,jggc_num,jggc_sj_num,cebk_num,cebk_sj_num,zszz_num,zszz_sj_num)
	values(v_i_fund_month,v_unit_dataId,v_unit_id,czbm,czgyNum,cztfNum,xzbzNum,xzbzSjNum,dlbzNum,dlbzSjNum,jjbzNum,jjbzSjNum,jzbzNum,jzbzSjNum,zfzxbzNum,zfzxbzSjNum,
		qebkNum,qebkSjNum,xzzfNum,xzzfSjNum,jggcNum,jggcSjNum,cebkNum,cebkSjNum,zszzNum,zszzSjNum); 
	
	SELECT count(1) into byhdrsNum from t126 ,t125,sys_s_data d 
		where t125.c06 = concat(t126.id,'') and t125.c36 = concat(d.id,'') 
		and t126.c01 = concat(v_unit_dataId,'') and  d.data_value in (204,205) -- t125.c36 人员工资制度为 204-事业岗位 205-体育津贴奖金制
		and EXISTS (select 1 from t136 where t126.c39 = t136.c04) -- t126.c39 执行工资标准 关联 单位工资制度与人员属性信息对应关系t136.c04 执行工资标准
		and t126.c40 != 10831 
		-- 2017-1-6改成 工资标准类别 码表 
		and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1') -- t126.c03 人员状态-码表 1-在职
		and not exists (select 1 from t126 d where d.id = t126.id and ifnull(d.c46,'')!='') 
		-- 不是调出的人员
		and not exists(select 1 from sys_s_data d where d.id = t126.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
	;
	-- if byhdrsNum > 0 then 
	
		-- 调入人员数量
		select count(1) into drNum from data_record_t126 a ,data_record_t125 b where a.c01 = concat(v_unit_dataId,'') and a.fund_month = concat(v_i_fund_month,'')    
		and a.changeSign = b.changeSign and concat(a.dataId,'') = b.c06 -- 变动记录表 相同变动标志 t125.c06 关联人员信息表 
		and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in (204,205)) -- t125.c36 人员工资制度为 204-事业岗位 205-体育津贴奖金制
		and exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = 'bdlx' and d.data_value = '09' ) --  接收调入人员
		and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		;
		select count(1) into stemNum from data_record_t126 a,data_record_t125 b where a.c01 = concat(v_unit_dataId,'') and a.fund_month = concat(v_i_fund_month,'')     
		and a.changeSign = b.changeSign and concat(a.dataId,'') = b.c06
		and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in (204,205)) -- t125.c36 人员工资制度为 204-事业岗位 205-体育津贴奖金制
		and exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = 'bdlx' and d.data_value = '06' )--  录入新进人员 t126.c40 人员信息-变动类型
		and exists(select 1 from sys_s_data d where d.id = a.c16 and d.typename = 'staffFrom'and d.data_value = '5')  -- 调入 -- t126.c16 人员信息-人员来源
		and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		;
		set drNum = drNum + stemNum;-- 调入人员 由接收调入人员+新进人员(人员来源为调入的)数据量
		
			-- 公招数量 
		select count(1) into gzNum from data_record_t126 a,data_record_t125 b where a.c01 = concat(v_unit_dataId,'') and a.fund_month = concat(v_i_fund_month,'')     
		and a.changeSign = b.changeSign and concat(a.dataId,'') = b.c06
		and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in (204,205)) -- 人员工资制度为 公务员职级工资制 警察工资制  207-法官职级工资制 208-检察官职级工资制
		and exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = 'bdlx' and d.data_value = '06' )--  录入新进人员 t126.c40 人员信息-变动类型
		and exists(select 1 from sys_s_data d where d.id = a.c16 and d.typename = 'staffFrom'and d.data_value in('0','1','2','3','9')) -- 公招 -- t126.c16 人员信息-人员来源
		and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		;
		-- 社招数量 
		select count(1) into szNum from data_record_t126 a,data_record_t125 b where a.c01 = concat(v_unit_dataId,'') and a.fund_month = concat(v_i_fund_month,'')     
		and a.changeSign = b.changeSign and concat(a.dataId,'') = b.c06
		and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in (204,205)) -- 人员工资制度为 公务员职级工资制 警察工资制  207-法官职级工资制 208-检察官职级工资制
		and exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = 'bdlx' and d.data_value = '06' )--  录入新进人员 t126.c40 人员信息-变动类型
		and exists(select 1 from sys_s_data d where d.id = a.c16 and d.typename = 'staffFrom'and d.data_value = '4') -- 社招 -- t126.c16 人员信息-人员来源
		and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		;
		
		-- 公招-考试招入-数量 
		select count(1) into kszpNum from data_record_t126 a,data_record_t125 b where a.c01 = concat(v_unit_dataId,'') and a.fund_month = concat(v_i_fund_month,'')   
		and a.changeSign = b.changeSign and concat(a.dataId,'') = b.c06
		and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in (204,205)) -- t125.c36 人员工资制度为 204-事业岗位 205-体育津贴奖金制
		and exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = 'bdlx' and d.data_value = '06' )--  录入新进人员 t126.c40 人员信息-变动类型
		and exists(select 1 from sys_s_data d where d.id = a.c16 and d.typename = 'staffFrom'and d.data_value in('0','1','2','9')) -- 公招-考试招入 -- t126.c16 人员信息-人员来源
		and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		;
		-- 公招-考核招入 数量 
		select count(1) into @gzKeNum from data_record_t126 a,data_record_t125 b where a.c01 = concat(v_unit_dataId,'') and a.fund_month = concat(v_i_fund_month,'')     
		and a.changeSign = b.changeSign and concat(a.dataId,'') = b.c06
		and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in (204,205)) -- t125.c36 人员工资制度为 204-事业岗位 205-体育津贴奖金制
		and exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = 'bdlx' and d.data_value = '06' )--  录入新进人员 t126.c40 人员信息-变动类型
		and exists(select 1 from sys_s_data d where d.id = a.c16 and d.typename = 'staffFrom'and d.data_value ='3') -- 公招-考核招入 -- t126.c16 人员信息-人员来源
		and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		;
		-- 军转干部数量
		select count(1) into jzgbNum from data_record_t126 a,data_record_t125 b where a.c01 = concat(v_unit_dataId,'') and a.fund_month = concat(v_i_fund_month,'')     
		and a.changeSign = b.changeSign and concat(a.dataId,'') = b.c06
		and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in (204,205)) -- t125.c36 人员工资制度为 204-事业岗位 205-体育津贴奖金制 
		and exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = 'bdlx' and d.data_value = '06' )--  录入新进人员 t126.c40 人员信息-变动类型
		and exists(select 1 from sys_s_data d where d.id = a.c16 and d.typename = 'staffFrom'and d.data_value = '6') -- 军转干部 -- t126.c16 人员信息-人员来源
		and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		;
		-- 复退军人数量
		select count(1) into ftjrNum from data_record_t126 a,data_record_t125 b where a.c01 = concat(v_unit_dataId,'') and a.fund_month = concat(v_i_fund_month,'')     
		and a.changeSign = b.changeSign and concat(a.dataId,'') = b.c06
		and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in (204,205)) -- t125.c36 人员工资制度为 204-事业岗位 205-体育津贴奖金制 
		and exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = 'bdlx' and d.data_value = '06' )--  录入新进人员 t126.c40 人员信息-变动类型
		and exists(select 1 from sys_s_data d where d.id = a.c16 and d.typename = 'staffFrom'and d.data_value = '7')  -- 复退军人 -- t126.c16 人员信息-人员来源
		and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		;
		-- 其它增加数量
		select count(1) into qtzjNum from data_record_t126 a,data_record_t125 b where a.c01 = concat(v_unit_dataId,'') and a.fund_month = concat(v_i_fund_month,'')     
		and a.changeSign = b.changeSign and concat(a.dataId,'') = b.c06
		and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in (204,205)) -- t125.c36 人员工资制度为 204-事业岗位 205-体育津贴奖金制 
		and exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = 'bdlx' and d.data_value = '06' )--  录入新进人员 t126.c40 人员信息-变动类型
		and exists(select 1 from sys_s_data d where d.id = a.c16 and d.typename = 'staffFrom'and d.data_value ='8')  -- 社招 其他
		and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		;
		select count(1) into @stemNum from data_record_t126 a ,data_record_t125 b where a.c01 = concat(v_unit_dataId,'') and a.fund_month = concat(v_i_fund_month,'')    
		and a.changeSign = b.changeSign and concat(a.dataId,'') = b.c06-- 变动记录表 相同变动标志 t125.c06 关联人员信息表 
		and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in (204,205)) -- t125.c36 人员工资制度为 204-事业岗位 205-体育津贴奖金制
		and exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = 'bdlx' and d.data_value = '16' ) --  恢复发放工资
		and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		;
		-- 转岗和处分（不同序列
		select count(1) into @ZGandCFNum from data_record_t126 a ,data_record_t125 b,data_record_t125 c where a.c01 = concat(v_unit_dataId,'') and a.fund_month = concat(v_i_fund_month,'')    
		and a.changeSign = b.changeSign and concat(a.dataId,'') = b.c06   and  concat(a.dataId,'') = c.c06-- 变动记录表 相同变动标志 t125.c06 关联人员信息表
		and c.id =(select MAX(id) from data_record_t125 d where d.c06=b.c06 and d.id<b.id)
		and c.c36 not in (10472,10473)  -- 事业
		and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in (204,205)) -- t125.c36 人员工资制度为 204-事业岗位 205-体育津贴奖金制
		and exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = 'bdlx' and d.data_value in ('0102','0103','0104','8002') ) --  恢复发放工资
		and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		;
		set qtzjNum = qtzjNum + @stemNum +@ZGandCFNum ;
		
		-- set zjNum = drNum + kszpNum + jzgbNum + ftjrNum + qtzjNum + @gzKeNum;
		set zjNum = drNum + gzNum + szNum + jzgbNum + ftjrNum + qtzjNum;
	-- end if;
	
		--  人员减少
		
		-- 退(离)休数量
		select count(1) into ltxNum from data_record_t126 a ,data_record_t125 b where a.c01 = concat(v_unit_dataId,'') and a.fund_month = concat(v_i_fund_month,'')    
		and a.changeSign = b.changeSign and concat(a.dataId,'') = b.c06-- 变动记录表 相同变动标志 t125.c06 关联人员信息表 
		and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in( 204,205)) -- 人员工资制度为  204 -事业岗位绩效工资制 205-体育津贴奖金制
		and exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = 'bdlx' and d.data_value = '08' )
		and exists(select 1 from sys_s_data d where d.id = a.c46 and d.typename = 'ryqx' and d.data_value in ('1','2')) -- t126.c46 人员去向 1,离休 2-退休
		and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		;
		-- 调出数量
		select count(1) into dcNum from data_record_t126 a ,data_record_t125 b where a.c01 = concat(v_unit_dataId,'') and a.fund_month = concat(v_i_fund_month,'')    
		and a.changeSign = b.changeSign and concat(a.dataId,'') = b.c06-- 变动记录表 相同变动标志 t125.c06 关联人员信息表 
		and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in( 204,205)) -- 人员工资制度为  204 -事业岗位绩效工资制 205-体育津贴奖金制
		and exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = 'bdlx' and d.data_value = '08' )
		and exists(select 1 from sys_s_data d where d.id = a.c46 and d.typename = 'ryqx' and d.data_value = '3') -- t126.c46 人员去向 3-调出
		and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		;
		-- 死亡数量
		select count(1) into swNum from data_record_t126 a ,data_record_t125 b where a.c01 = concat(v_unit_dataId,'') and a.fund_month = concat(v_i_fund_month,'')    
		and a.changeSign = b.changeSign and concat(a.dataId,'') = b.c06-- 变动记录表 相同变动标志 t125.c06 关联人员信息表 
		and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in( 204,205)) -- 人员工资制度为  204 -事业岗位绩效工资制 205-体育津贴奖金制
		and exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = 'bdlx' and d.data_value = '08' )
		and exists(select 1 from sys_s_data d where d.id = a.c46 and d.typename = 'ryqx' and d.data_value = '10') -- t126.c46 人员去向 10-死亡
		and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		;
		-- 辞聘数量
		select count(1) into cpNum from data_record_t126 a ,data_record_t125 b where a.c01 = concat(v_unit_dataId,'') and a.fund_month = concat(v_i_fund_month,'')    
		and a.changeSign = b.changeSign and concat(a.dataId,'') = b.c06-- 变动记录表 相同变动标志 t125.c06 关联人员信息表 
		and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in( 204,205)) -- 人员工资制度为  204 -事业岗位绩效工资制 205-体育津贴奖金制
		and exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = 'bdlx' and d.data_value = '08' )
		and exists(select 1 from sys_s_data d where d.id = a.c46 and d.typename = 'ryqx' and d.data_value = '4') -- t126.c46 人员去向  4-辞聘
		and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		;
		-- 解聘数量
		select count(1) into jpNum from data_record_t126 a ,data_record_t125 b where a.c01 = concat(v_unit_dataId,'') and a.fund_month = concat(v_i_fund_month,'')    
		and a.changeSign = b.changeSign and concat(a.dataId,'') = b.c06-- 变动记录表 相同变动标志 t125.c06 关联人员信息表 
		and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in( 204,205)) -- 人员工资制度为  204 -事业岗位绩效工资制 205-体育津贴奖金制
		and exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = 'bdlx' and d.data_value = '08' )
		and exists(select 1 from sys_s_data d where d.id = a.c46 and d.typename = 'ryqx' and d.data_value = '5') -- t126.c46 人员去向  5-解聘
		and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		;
		-- 开除数量
		select count(1) into kcNum from data_record_t126 a ,data_record_t125 b where a.c01 = concat(v_unit_dataId,'') and a.fund_month = concat(v_i_fund_month,'')    
		and a.changeSign = b.changeSign and concat(a.dataId,'') = b.c06-- 变动记录表 相同变动标志 t125.c06 关联人员信息表 
		and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in( 204,205)) -- 人员工资制度为  204 -事业岗位绩效工资制 205-体育津贴奖金制
		and exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = 'bdlx' and d.data_value = '08' )
		and exists(select 1 from sys_s_data d where d.id = a.c46 and d.typename = 'ryqx' and d.data_value = '8') -- t126.c46 人员去向 8-开除
		and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		;
		-- 自动离职数量
		select count(1) into zdlzNum from data_record_t126 a ,data_record_t125 b where a.c01 = concat(v_unit_dataId,'') and a.fund_month = concat(v_i_fund_month,'')    
		and a.changeSign = b.changeSign and concat(a.dataId,'') = b.c06-- 变动记录表 相同变动标志 t125.c06 关联人员信息表 
		and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in( 204,205)) -- 人员工资制度为  204 -事业岗位绩效工资制 205-体育津贴奖金制
		and exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = 'bdlx' and d.data_value = '08' )
		and exists(select 1 from sys_s_data d where d.id = a.c46 and d.typename = 'ryqx' and d.data_value = '9') -- t126.c46 人员去向 9-自动离职
		and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		;
		
		-- 终止合同数量
		select count(1) into zzhtNum from data_record_t126 a ,data_record_t125 b where a.c01 = concat(v_unit_dataId,'') and a.fund_month = concat(v_i_fund_month,'')    
		and a.changeSign = b.changeSign and concat(a.dataId,'') = b.c06-- 变动记录表 相同变动标志 t125.c06 关联人员信息表 
		and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in( 204,205)) -- 人员工资制度为  204 -事业岗位绩效工资制 205-体育津贴奖金制
		and exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = 'bdlx' and d.data_value = '08' )
		and exists(select 1 from sys_s_data d where d.id = a.c46 and d.typename = 'ryqx' and d.data_value = '11') -- t126.c46 人员去向 11-终止合同
		and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		;
		-- 其他减少数量数量
		select count(1) into qtjsNum from data_record_t126 a ,data_record_t125 b where a.c01 = concat(v_unit_dataId,'') and a.fund_month = concat(v_i_fund_month,'')    
		and a.changeSign = b.changeSign and concat(a.dataId,'') = b.c06-- 变动记录表 相同变动标志 t125.c06 关联人员信息表 
		and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in( 204,205)) -- 人员工资制度为  204 -事业岗位绩效工资制 205-体育津贴奖金制
		and exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = 'bdlx' and d.data_value = '08' )
		and exists(select 1 from sys_s_data d where d.id = a.c46 and d.typename = 'ryqx' and d.data_value in('6','7')) -- t126.c46 人员去向 -其他减少数量  6-辞职 7-辞退 
		and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		;
		-- 转岗机关和处分不同序列
		select count(1) into @ZGandCFNum from data_record_t126 a ,data_record_t125 b,data_record_t125 c where a.c01 = concat(v_unit_dataId,'') and a.fund_month = concat(v_i_fund_month,'')    
		and a.changeSign = b.changeSign and concat(a.dataId,'') = b.c06 and  concat(a.dataId,'') = c.c06  -- 变动记录表 相同变动标志 t125.c06 关联人员信息表
 		and c.id =(select MAX(id) from data_record_t125 d where d.c06=b.c06 and d.id<b.id)
		and c.c36  in (10472,10473)  -- 事业  体育 
		and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value not in( 204,205)) -- 人员工资制度为  204 -事业岗位绩效工资制 205-体育津贴奖金制
		and exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = 'bdlx' and d.data_value in(0101,0105,0107,8002,0112,0113,0114)) -- 转任公务员，综合类公务员，机关工人，不同职务序列，警察，法，检
		and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		;
		/*select count(1) into @stemNum from data_record_t126 a ,data_record_t125 b where a.c01 = concat(v_unit_dataId,'') and a.fund_month = concat(v_i_fund_month,'')    
		and a.changeSign = b.changeSign and concat(a.dataId,'') = b.c06-- 变动记录表 相同变动标志 t125.c06 关联人员信息表 
		and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in( 204,205)) -- 人员工资制度为  204 -事业岗位绩效工资制 205-体育津贴奖金制
		and exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = 'bdlx' and d.data_value = '15' ) -- 停发工资
		and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		;*/
		set qtjsNum = qtjsNum + @ZGandCFNum;
		
		set jsNum = ltxNum + dcNum + swNum + cpNum + kcNum + zdlzNum + qtjsNum + jpNum ;
		
		-- 更新人员核定表
		update fund_total_person_ins
		set 
			increase_part_total=zjNum,dr_num=drNum,gz_num=gzNum,sz_num=szNum,kszp_num=kszpNum,khzp_num=@gzKeNum,
			jz_num=jzgbNum,ftjr_num=ftjrNum,other_incr_num=qtzjNum,
			decrease_part_total=jsNum,tlx_num=ltxNum,dc_num=dcNum,sw_num=swNum,
			cp_num=cpNum,jp_num=jpNum,
			kc_num=kcNum,zdlz_num=zdlzNum,zzht_num=zzhtNum,other_decr_num=qtjsNum,
			this_month_person_num=byhdrsNum
		where fund_month = concat(v_i_fund_month,'') and  unit_id = concat(v_unit_dataId,'') ;
	
	-- 所有在职管理人员总人数
   SELECT count(1) into glryNum from t126 ,t125,sys_s_data f 
		where t125.c06 = concat(t126.id,'') and t126.c01 = concat(v_unit_dataId,'')
		and t125.c36 = concat(f.id,'') and f.data_value = '204' -- t125.c36 人员工资制度为 204 -事业岗位绩效工资制
		and EXISTS (select 1 from t127 d where d.id = t126.c17  and d.c05 not like '%期%') -- t126.c39 执行工资标准 关联 单位工资制度与人员属性信息对应关系t136.c04 执行工资标准
	  and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1') -- t126.c03 人员状态-码表 1-在职
		and not exists (select 1 from t126 d where d.id = t126.id and ifnull(d.c46,'')!='') 
		-- 不是调出的人员
		and exists(select 1 from sys_s_data d where d.id=t126.c28 and d.name='管理人员') -- t126.c28 人员身份 关联单位工资制度与人员属性对应关系 t136.c02人员身份
		and not exists(select 1 from sys_s_data d where d.id = t126.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		;
	-- 所有  专业技术人员 总人数
	   SELECT count(1) into zyjsNum from t126 ,t125,sys_s_data f
		where t125.c06 = concat(t126.id,'') and t126.c01 = concat(v_unit_dataId,'')
		and t125.c36 = concat(f.id,'') and f.data_value = '204' -- t125.c36 人员工资制度为 204 -事业岗位绩效工资制
		and EXISTS (select 1 from t127 d where d.id = t126.c17  and d.c05 not like '%期%') -- t126.c39 执行工资标准 关联 单位工资制度与人员属性信息对应关系t136.c04 执行工资标准
	  and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1') -- t126.c03 人员状态-码表 1-在职
		and not exists (select 1 from t126 d where d.id = t126.id and ifnull(d.c46,'')!='') 
		-- 不是调出的人员
		and exists(select 1 from sys_s_data d where d.id=t126.c28 and d.name='专业技术人员') -- t126.c28 人员身份 关联单位工资制度与人员属性对应关系 t136.c02人员身份
		and not exists(select 1 from sys_s_data d where d.id = t126.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		;
	-- 所有  工勤人员 总人数
	   SELECT count(1) into gcryNum from t126 ,t125,sys_s_data f 
		where t125.c06 = concat(t126.id,'') and t126.c01 = concat(v_unit_dataId,'')
		and t125.c36 = concat(f.id,'') and f.data_value = '204' -- t125.c36 人员工资制度为 204 -事业岗位绩效工资制
		and EXISTS (select 1 from t127 d where d.id = t126.c17  and d.c05 not like '%期%') -- t126.c39 执行工资标准 关联 单位工资制度与人员属性信息对应关系t136.c04 执行工资标准
	  and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1') -- t126.c03 人员状态-码表 1-在职
		-- and not exists (select 1 from sys_s_data d where d.id = t126.c43 and d.typename = 'is' and d.data_value = '1') 
		-- 不是停发工资的人员
		and not exists (select 1 from t126 d where d.id = t126.id and ifnull(d.c46,'')!='') 
		-- 不是调出的人员
		and exists(select 1 from sys_s_data d where d.id=t126.c28 and d.name ='事业工人') -- t126.c28 人员身份 关联单位工资制度与人员属性对应关系 t136.c02人员身份
		and not exists(select 1 from sys_s_data d where d.id = t126.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		;

	-- 所有 试用期 总人数
	   SELECT count(1) into syqNum from t126 ,t125,sys_s_data f 
		where t125.c06 = concat(t126.id,'') and t126.c01 = concat(v_unit_dataId,'')
		and t125.c36 = concat(f.id,'') and f.data_value in('204', '205') -- t125.c36 人员工资制度为 204 -事业岗位绩效工资制 205 运动员津贴奖金制
		and EXISTS (select 1 from t127 d where d.id = t126.c17  and d.c05 like '%期%') -- t126.c39 执行工资标准 关联 单位工资制度与人员属性信息对应关系t136.c04 执行工资标准
	  and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1') -- t126.c03 人员状态-码表 1-在职
		and not exists (select 1 from t126 d where d.id = t126.id and ifnull(d.c46,'')!='') 
		-- 不是调出的人员
		and not exists(select 1 from sys_s_data d where d.id = t126.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		;-- t126.c28 人员身份 关联单位工资制度与人员属性对应关系 t136.c02人员身份
	
	-- 所有  运动员 总人数
	   SELECT count(1) into ydyNum from t126 ,t125,sys_s_data f 
		where t125.c06 = concat(t126.id,'') and t126.c01 = concat(v_unit_dataId,'')
		and t125.c36 = concat(f.id,'') and f.data_value = 205 -- t125.c36 人员工资制度为 205 - 体育津贴奖金制
		and not EXISTS (select 1 from t127 d where d.id = t126.c17  and d.c05 like '%期%') -- t126.c39 执行工资标准 关联 单位工资制度与人员属性信息对应关系t136.c04 执行工资标准
	  and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1') -- t126.c03 人员状态-码表 1-在职
		and not exists (select 1 from t126 d where d.id = t126.id and ifnull(d.c46,'')!='') 
		-- 不是调出的人员
		and exists(select 1 from sys_s_data d where d.id=t126.c28 and d.name='运动员') -- t126.c28 人员身份 关联单位工资制度与人员属性对应关系 t136.c02人员身份
		and not exists(select 1 from sys_s_data d where d.id = t126.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		;
		set @preGlryNum = 0,@preZyjsNum=0,@preGqNum=0,@preSyqNum=0,@preYdyNum=0,@prePersonNum=0;
		
	select glry_num ,zyjs_num,gq_num,syq_num,ydy_num,this_month_person_num
		into @preGlryNum,@preZyjsNum,@preGqNum,@preSyqNum,@preYdyNum,@prePersonNum
	from fund_total_person_ins where  unit_id = concat(v_unit_dataId,'') and fund_month < v_i_fund_month order by id desc limit 0,1;
	-- 更新人员核定表 本月人员数据
		update fund_total_person_ins
		set  glry_num=glryNum, zyjs_num=zyjsNum, gq_num=gcryNum, syq_num=syqNum, ydy_num=ydyNum,
		-- 管理人员数量 			专业技术数量  		工勤人员数量 		试用期数量 		运动员数量
		pre_glry_num=@preGlryNum,pre_zyjs_num=@preZyjsNum,pre_gq_num=@preGqNum,pre_syq_num=@preSyqNum,pre_ydy_num=@preYdyNum,
		-- 上月-管理人员数量 			上月-专业技术数量  		上月-工勤人员数量 		上月-试用期数量 		上月-运动员数量
		pre_month_person_num=@prePersonNum
		where fund_month = concat(v_i_fund_month,'') and  unit_id = concat(v_unit_dataId,'') ;
	
	
	select  DATE_FORMAT( DATE_SUB(concat(v_i_fund_month,'01'),INTERVAL 1 month),'%Y%m') into stempParam; -- 上一个月的月结算工资数据
	
		
	delete from fund_total_ins where fund_month  = concat(v_i_fund_month,'') and unit_id = concat(v_unit_dataId,'');-- 如果系统里面已经存在,先删除
	
	-- 上月核定工资总额
	INSERT INTO fund_total_ins(fund_month,unit_id,unit_code,change_type,change_person_num,
				total_salary,part_total_salary,zwgz_salary,gwgz_salary,ycxbkf_salary,jbt_salary
				-- 工资合计   工资小计					职务工资  级别工资  一次性补扣发 津补贴小计
				,jbt_code_salary -- 津补贴code及金额
				,jstg10,tsjy15,blzxx10
				-- 中小学教师或护士提高10% 特殊教育提高15%  退役运动员保留工资额度   原 中小学教师保留10%
				,blhs10,bltg,psxlj,jxgz
				-- 在护士岗位工作满20年并在医疗卫生机构工作的保留原提高10% 保留原特殊岗位活工资比例提高部分 运动员平时训练奖 绩效工资
				) 
				/*,total_salary,part_total_salary,zwgz_salary,gwgz_salary,
		dszn_salary,llt_salary,ggbl_salary,hmbt_salary,jjbabt_salary,xfgzry_salary,zsjz_salary,gwygfh_salary,ycxbkf_salary*/
		select  v_i_fund_month,unit_id,unit_code,'上月核定工资总额',change_person_num,
				total_salary,part_total_salary,zwgz_salary,gwgz_salary,ycxbkf_salary,jbt_salary
		-- 工资合计   工资小计 职务工资  级别工资 津补贴小计
		,jbt_code_salary
		,jstg10,tsjy15,blzxx10
		-- 中小学教师或护士提高10% 特殊教育提高15%  退役运动员保留工资额度   原 中小学教师保留10%
		,blhs10,bltg,psxlj,jxgz
		-- 在护士岗位工作满20年并在医疗卫生机构工作的保留原提高10% 保留原特殊岗位活工资比例提高部分 运动员平时训练奖 绩效工资
		from fund_total_ins where 1=1
		and unit_id = concat(v_unit_dataId,'') and fund_month = concat(stempParam,'') and change_type = '本月核定工资总额'
		;
		-- 录入新进人员
		INSERT INTO fund_total_ins(fund_month,unit_id,unit_code,change_type,changetype_name,change_person_num,
				total_salary,part_total_salary,zwgz_salary,gwgz_salary,jbt_salary,ycxbkf_salary
				,jstg10 ,tsjy15 ,blzxx10
				-- 中小学教师或护士提高10%  特殊教育提高15% 退役运动员保留工资额度;-- 原 中小学教师保留10%
				 ,blhs10 ,bltg ,psxlj 
				-- 在护士岗位工作满20年并在医疗卫生机构工作的保留原提高10% 保留原特殊岗位活工资比例提高部分 运动员平时训练奖
				,jxgz
				--  绩效工资
				,jbt_code_salary 
				-- 工资合计   工资小计					职务工资  级别工资 津补贴小计  一次性补扣发
				)
				/*,total_salary,part_total_salary,zwgz_salary,gwgz_salary,
		dszn_salary,llt_salary,ggbl_salary,hmbt_salary,jjbabt_salary,xfgzry_salary,zsjz_salary,gwygfh_salary,ycxbkf_salary*/
		select  v_i_fund_month,v_unit_dataId,v_unit_id,a.changeType,concat('起薪','(',(select d.name from sys_s_data d where d.id = a.c16),')'),count(1) ,
		sum((PERIOD_DIFF(v_i_fund_month,replace(b.c02,'-',''))+1)*b.c32),
		sum(b.c32),sum(b.c25),sum(b.c26), sum(b.c27),sum(PERIOD_DIFF(v_i_fund_month,replace(b.c02,'-',''))*b.c32),
		sum(b.c28),sum(b.c29),sum(b.c44),
		-- 中小学教师或护士提高10%  特殊教育提高15% 退役运动员保留工资额度 原 中小学教师保留10%
		sum(b.c45),sum(b.c30),sum(b.c47),
		-- 在护士岗位工作满20年并在医疗卫生机构工作的保留原提高10% 保留原特殊岗位活工资比例提高部分 运动员平时训练奖
		sum(b.c31),
		--  绩效工资
		(select group_concat(z.c02,'-',case when round(z.je ,2) =0 then '' else round(z.je ,2) end   ) from (	
			select t116.c02,sum(c.c07) as je,concat(a.changeType,a.c16) as changeName from data_record_t126 a 
		join data_record_t125 b on a.changeSign = b.changeSign 
		join data_record_t117 c 
			on  c.changeSign = a.changeSign join t116 on c.c04=t116.id
			where -- c.dataclassCode= 't117' and  a.dataclassCode = 't126' and b.dataclassCode = 't125'
		 	-- and  
		 	a.allAuditFlag='9' and a.c01 = concat(v_unit_dataId,'')
		 	and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in('204','205')) -- 人员工资制度为 201-公务员职级工资制 206-警察职级工资制 202 -机关技工岗位等级工资制 203-机关普工岗位工资制  207-法官职级工资制 208-检察官职级工资制
			and a.changeType = lrxjryCode -- 录入新进人员
			group by t116.c02,concat(a.changeType,a.c16)) 
		z where z.changeName = concat(a.changeType,a.c16)
		-- 工资合计   工资小计 职务工资  级别工资 津补贴小计
		)
		from data_record_t126 a ,data_record_t125 b 
		where b.c06 = concat(a.dataId,'')
		 and  a.allAuditFlag='9' and a.c01 = concat(v_unit_dataId,'')  and a.changeSign = b.changeSign
		and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in( '204','205')) -- 204事业绩效岗位工资制
		and a.changeType = lrxjryCode -- 录入新进人员
		and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		group by concat(a.changeType,a.c16); -- 根据变动类型分组 -- allAuditFlag = 9 表示 基金生成未上报
		
		-- 人员基本信息修改
		INSERT INTO fund_total_ins(fund_month,unit_id,unit_code,change_type,change_person_num
				-- ,total_salary,part_total_salary,zwgz_salary,gwgz_salary,jbt_salary
		) 
				-- 工资合计   工资小计					职务工资  级别工资 津补贴小计  一次性补扣发
				/*,total_salary,part_total_salary,zwgz_salary,gwgz_salary,
		dszn_salary,llt_salary,ggbl_salary,hmbt_salary,jjbabt_salary,xfgzry_salary,zsjz_salary,gwygfh_salary,ycxbkf_salary*/
		select  v_i_fund_month,v_unit_dataId,v_unit_id,a.changeType,count(1) 
		-- ,sum(b.c32),sum(b.c32),sum(b.c25),sum(b.c26), sum(b.c27)
		-- 工资合计   工资小计 职务工资  级别工资 津补贴小计
		from data_record_t126 a ,data_record_t125 b 
		where  b.c06 = concat(a.dataId,'')
		 and  a.allAuditFlag='9' and a.c01 = concat(v_unit_dataId,'')  and a.changeSign = b.changeSign
		and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in ('204','205')) -- 204事业绩效岗位工资制
		and a.changeType = jbxxxgCode -- 人员基本信息修改
		and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		group by a.changeType; -- 根据变动类型分组 -- allAuditFlag = 9 表示 基金生成未上报
		
		
		-- 人员减少
		SET @sqlstr = CONCAT('INSERT INTO fund_total_ins(fund_month,unit_id,unit_code,change_type,changetype_name,change_person_num,
				total_salary,part_total_salary,zwgz_salary,gwgz_salary,jbt_salary,ycxbkf_salary
				-- 工资合计   工资小计					职务工资  级别工资 津补贴小计  一次性补扣发 
				,jstg10 ,tsjy15 ,blzxx10
				-- 中小学教师或护士提高10%  特殊教育提高15% 退役运动员保留工资额度;-- 原 中小学教师保留10%
				,blhs10 ,bltg ,psxlj 
				-- 在护士岗位工作满20年并在医疗卫生机构工作的保留原提高10% 保留原特殊岗位活工资比例提高部分 运动员平时训练奖
				,jxgz
				--  绩效工资
				,jbt_code_salary  )
				-- 津补贴项目-金额
				/*,total_salary,part_total_salary,zwgz_salary,gwgz_salary,
			dszn_salary,llt_salary,ggbl_salary,hmbt_salary,jjbabt_salary,xfgzry_salary,zsjz_salary,gwygfh_salary,ycxbkf_salary*/
		select  ',v_i_fund_month,',',v_unit_dataId,',\'',v_unit_id,'\',a.changeType,concat(\'人员减少\',\'(\',(select d.name from sys_s_data d where d.id = a.c46),\')\'),count(1) ,
			sum(ifnull(c.total_salary_bf,0)+ifnull(c.total_salary_ce,0)),sum(c.part_total_salary_ce),sum(c.zwgz_ce),sum(c.gwgz_ce),sum(c.jbt_salary_ce),sum(c.total_salary_bf)
		-- 工资总计-如果没有则算差额,差额情况不计入补扣发 工资合计  职务工资  级别工资 津补贴小计 一次性补扣发
	    ,sum(ifnull(c.jshstg_ce,0)),sum(ifnull(c.tsjytg_ce,0)),sum(ifnull(c.jsblgz_ce,0))
		-- 中小学教师或护士提高10%  特殊教育提高15%  退役运动员保留工资额度;-- 原 中小学教师保留10%
	    ,sum(ifnull(c.hsblgz_ce,0)),sum(ifnull(c.bltggz_ce,0)),sum(ifnull(c.psxlj_ce,0))
		-- 在护士岗位工作满20年并在医疗卫生机构工作的保留原提高10% 保留原特殊岗位活工资比例提高部分 运动员平时训练奖
		,sum(ifnull(c.jxgz_ce,0))
		-- 绩效工资
		,(select group_concat(z.c02,\'-\', case when round(z.je ,2)=0 then \'\' else round(z.je ,2) end ) from (	
				select t116.c02,sum(ifnull(d.jbt_salary_ce,0)) as je,concat(a.changeType,a.c46) as changeName 
				from data_record_t126 a 
				join data_record_t125 b on a.changeSign = b.changeSign 
				join data_record_t117 c on a.changeSign = c.changeSign join t116 on c.c04=t116.id
				left join fund_salary_fill_subsidies_',v_i_fund_month,' d 
					on d.changeSign = a.changeSign and d.jbt_id = t116.id  
					where  a.c01 = \'',v_unit_dataId,'\' and b.changeSign = a.changeSign and a.allAuditFlag in(0,9) 
					-- and c.dataclassCode= \'t117\' and  a.dataclassCode = \'t126\' and b.dataclassCode = \'t125\'
				 	and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = \'wageSystem\' and d.data_value in(\'204\',\'205\'))
					and a.changeType = ',ryjsCode,' -- 等于人员减少
					group by t116.c02,concat(a.changeType,a.c46)
				) z  where z.changeName = concat(a.changeType,a.c46)
			)
		from data_record_t126 a join data_record_t125 b  on a.changeSign = b.changeSign
		left join fund_salary_fill_',v_i_fund_month,' c
		on a.changeSign = c.changeSign
		where  a.c01 = \'',v_unit_dataId,'\' 
		and b.c06 = concat(a.dataId,\'\')
		 and  a.allAuditFlag in(0,9) and a.changeSign = b.changeSign 
		and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = \'wageSystem\' and d.data_value in(\'204\',\'205\'))
		and a.changeType = ',ryjsCode,' -- 等于人员减少
		and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = \'staffStatus\' and d.data_value = \'2\')
		-- 非离休人员
		-- and not exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = \'bdlx\' and d.data_value like \'01%\' ) -- 不是重新确定工资
		group by concat(a.changeType,a.c46) '); 
		-- set resultMsg = concat('@sqlstr:',@sqlstr);leave label_pro;
		PREPARE stmt FROM @sqlstr;
		EXECUTE stmt;
		DROP PREPARE stmt;
		
	-- 其它要计算补扣发的变动   
	SET @sqlstr = CONCAT('INSERT INTO fund_total_ins(fund_month,unit_id,unit_code,change_type,change_person_num,
			total_salary,part_total_salary,zwgz_salary,gwgz_salary,jbt_salary,ycxbkf_salary
			-- 工资合计   工资小计					职务工资  级别工资 津补贴小计  一次性补扣发 
			,jstg10 ,tsjy15 ,blzxx10
			-- 中小学教师或护士提高10%  特殊教育提高15% 退役运动员保留工资额度;-- 原 中小学教师保留10%
			 ,blhs10 ,bltg ,psxlj 
			-- 在护士岗位工作满20年并在医疗卫生机构工作的保留原提高10% 保留原特殊岗位活工资比例提高部分 运动员平时训练奖
			,jxgz
			--  绩效工资
			,jbt_code_salary  )
			-- 津补贴项目-金额
			/*,total_salary,part_total_salary,zwgz_salary,gwgz_salary,
			dszn_salary,llt_salary,ggbl_salary,hmbt_salary,jjbabt_salary,xfgzry_salary,zsjz_salary,gwygfh_salary,ycxbkf_salary*/
	select  ',v_i_fund_month,',',v_unit_dataId,',\'',v_unit_id,'\',a.changeType,count(1) ,
		-- sum(ifnull(c.total_salary_bf,c.total_salary_ce)),sum(ifnull(c.part_total_salary_bf,c.part_total_salary_ce)),sum(ifnull(c.zwgz_bf,c.zwgz_ce)),sum(ifnull(c.gwgz_bf,c.gwgz_ce)),sum(ifnull(c.jbt_salary_bf,c.jbt_salary_ce)),sum(c.total_salary_bf)
		sum(ifnull(c.total_salary_bf,0)+ifnull(c.total_salary_ce,0)),sum(c.part_total_salary_ce),sum(c.zwgz_ce),sum(c.gwgz_ce),sum(c.jbt_salary_ce),sum(c.total_salary_bf)
	-- sum(b.c32),sum(b.c32),sum(b.c25),sum(b.c26), sum(b.c27),sum(b.c32)
	-- 工资总计-如果没有则算差额,差额情况不计入补扣发 工资合计  职务工资  级别工资 津补贴小计 一次性补扣发
     ,sum(ifnull(c.jshstg_ce,0)),sum(ifnull(c.tsjytg_ce,0)),sum(ifnull(c.jsblgz_ce,0))
	-- 中小学教师或护士提高10%  特殊教育提高15%  退役运动员保留工资额度;-- 原 中小学教师保留10%
     ,sum(ifnull(c.hsblgz_ce,0)),sum(ifnull(c.bltggz_ce,0)),sum(ifnull(c.psxlj_ce,0))
	-- 在护士岗位工作满20年并在医疗卫生机构工作的保留原提高10% 保留原特殊岗位活工资比例提高部分 运动员平时训练奖
	,sum(ifnull(c.jxgz_ce,00))
	-- 绩效工资
	,(select group_concat(z.c02,\'-\',case when round(z.je ,2)=0 then \'\' else round(z.je ,2) end) from (	
			select t116.c02,sum(ifnull(d.salary_value,0)) as je,a.changeType from data_record_t126 a 
			join data_record_t125 b on a.changeSign = b.changeSign 
			join data_record_t117 c on a.changeSign = c.changeSign join t116 on c.c04=t116.id
			left join fund_salary_fill_subsidies_',v_i_fund_month,' d 
				on d.changeSign = a.changeSign and d.jbt_id = t116.id  
				where a.c01 = \'',v_unit_dataId,'\'
			 	and  a.allAuditFlag=9 
			 	and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = \'wageSystem\' and d.data_value in( \'204\',\'205\')) -- 人员工资制度为 204事业人员
				and a.changeType != ',lrxjryCode,' -- 不等于录入新进人员
				and a.changeType != ',ryjsCode,' -- 不等于人员减少
				and a.changeType != ',jbxxxgCode,' -- 不等于人员基本信息修改
				and a.changeType != ',hfgzdyCode,' -- 不等于恢复发放工资
				and a.changeType not in(10647,10648,10649,10745,10646,10650,10652,11321,11322,11323)  -- 不等于转岗为 机关序列和处分不同职务序列
				group by t116.c02,a.changeType) 
			z  where z.changeType = a.changeType)
	from data_record_t126 a join data_record_t125 b  on a.changeSign = b.changeSign
	left join fund_salary_fill_',v_i_fund_month,' c
	on a.changeSign = c.changeSign
	where a.c01 = \'',v_unit_dataId,'\'
	 and  a.allAuditFlag=9  and a.changeSign = b.changeSign 
	and b.c06 = concat(a.dataId,\'\')
	and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = \'wageSystem\' and d.data_value in( \'204\',\'205\')) -- 人员工资制度为 204事业人员
	and a.changeType != ',lrxjryCode,' -- 不等于录入新进人员
	and a.changeType != ',jbxxxgCode,' -- 不等于人员基本信息修改
	and a.changeType != ',hfgzdyCode,' -- 不等于恢复发放工资
	and a.changeType != ',ryjsCode,' -- 不等于人员减少
	and a.changeType =10832   -- 不等于转岗为 机关序列和处分不同职务序列
	and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = \'staffStatus\' and d.data_value = \'2\')
	-- 非离休人员
	-- and not exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = \'bdlx\' and d.data_value like \'01%\' ) -- 不是重新确定工资
	group by a.changeType '); 
PREPARE stmt FROM @sqlstr;
EXECUTE stmt;
DROP PREPARE stmt;
	-- 恢复发放工资
	SET @sqlstr = CONCAT('INSERT INTO fund_total_ins(fund_month,unit_id,unit_code,change_type,change_person_num,
			total_salary,part_total_salary,zwgz_salary,gwgz_salary,jbt_salary,ycxbkf_salary
			-- 工资合计   工资小计					职务工资  级别工资 津补贴小计  一次性补扣发 
			,jstg10 ,tsjy15 ,blzxx10
			-- 中小学教师或护士提高10%  特殊教育提高15% 退役运动员保留工资额度;-- 原 中小学教师保留10%
			 ,blhs10 ,bltg ,psxlj 
			-- 在护士岗位工作满20年并在医疗卫生机构工作的保留原提高10% 保留原特殊岗位活工资比例提高部分 运动员平时训练奖
			,jxgz
			--  绩效工资
			,jbt_code_salary  )
			-- 津补贴项目-金额
			/*,total_salary,part_total_salary,zwgz_salary,gwgz_salary,
			dszn_salary,llt_salary,ggbl_salary,hmbt_salary,jjbabt_salary,xfgzry_salary,zsjz_salary,gwygfh_salary,ycxbkf_salary*/
	select  ',v_i_fund_month,',',v_unit_dataId,',\'',v_unit_id,'\',a.changeType,count(1) ,
		-- sum(ifnull(c.total_salary_bf,c.total_salary_ce)),sum(ifnull(c.part_total_salary_bf,c.part_total_salary_ce)),sum(ifnull(c.zwgz_bf,c.zwgz_ce)),sum(ifnull(c.gwgz_bf,c.gwgz_ce)),sum(ifnull(c.jbt_salary_bf,c.jbt_salary_ce)),sum(c.total_salary_bf)
		sum(ifnull(c.total_salary_bf,0)+ifnull(c.total_salary_ce,0)),sum(c.part_total_salary_ce),sum(c.zwgz_ce),sum(c.gwgz_ce),sum(c.jbt_salary_ce),sum(c.total_salary_bf)
	-- sum(b.c32),sum(b.c32),sum(b.c25),sum(b.c26), sum(b.c27),sum(b.c32)
	-- 工资总计-如果没有则算差额,差额情况不计入补扣发 工资合计  职务工资  级别工资 津补贴小计 一次性补扣发
     ,sum(ifnull(c.jshstg_ce,0)),sum(ifnull(c.tsjytg_ce,0)),sum(ifnull(c.jsblgz_ce,0))
	-- 中小学教师或护士提高10%  特殊教育提高15%  退役运动员保留工资额度;-- 原 中小学教师保留10%
     ,sum(ifnull(c.hsblgz_ce,0)),sum(ifnull(c.bltggz_ce,0)),sum(ifnull(c.psxlj_ce,0))
	-- 在护士岗位工作满20年并在医疗卫生机构工作的保留原提高10% 保留原特殊岗位活工资比例提高部分 运动员平时训练奖
	,sum(ifnull(c.jxgz_ce,00))
	-- 绩效工资
	,(select group_concat(z.c02,\'-\',case when round(z.je ,2)=0 then \'\' else round(z.je ,2) end) from (	
			select t116.c02,sum(ifnull(d.jbt_salary_ce,0)) as je,a.changeType from data_record_t126 a 
			join data_record_t125 b on a.changeSign = b.changeSign 
			join data_record_t117 c on a.changeSign = c.changeSign join t116 on c.c04=t116.id
			left join fund_salary_fill_subsidies_',v_i_fund_month,' d 
				on d.changeSign = a.changeSign and d.jbt_id = t116.id  
				where a.c01 = \'',v_unit_dataId,'\'
			 	and  a.allAuditFlag=9 
			 	and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = \'wageSystem\' and d.data_value in( \'204\',\'205\')) -- 人员工资制度为 204事业人员
				and a.changeType = ',hfgzdyCode,' -- 等于恢复发放工资
				group by t116.c02,a.changeType) 
			z  where z.changeType = a.changeType)
	from data_record_t126 a join data_record_t125 b  on a.changeSign = b.changeSign
	left join fund_salary_fill_',v_i_fund_month,' c
	on a.changeSign = c.changeSign
	where a.c01 = \'',v_unit_dataId,'\'
	 and  a.allAuditFlag=9  and a.changeSign = b.changeSign 
	and b.c06 = concat(a.dataId,\'\')
	and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = \'wageSystem\' and d.data_value in( \'204\',\'205\')) -- 人员工资制度为 204事业人员
	and a.changeType = ',hfgzdyCode,' -- 等于恢复发放工资
	and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = \'staffStatus\' and d.data_value = \'2\')
	-- 非离休人员
	-- and not exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = \'bdlx\' and d.data_value like \'01%\' ) -- 不是重新确定工资
	group by a.changeType '); 
PREPARE stmt FROM @sqlstr;
EXECUTE stmt;
DROP PREPARE stmt;
	-- 其它要计算补扣发的变动   不考虑转岗
	SET @sqlstr = CONCAT('INSERT INTO fund_total_ins(fund_month,unit_id,unit_code,change_type,change_person_num,
			total_salary,part_total_salary,zwgz_salary,gwgz_salary,jbt_salary,ycxbkf_salary
			-- 工资合计   工资小计					职务工资  级别工资 津补贴小计  一次性补扣发 
			,jstg10 ,tsjy15 ,blzxx10
			-- 中小学教师或护士提高10%  特殊教育提高15% 退役运动员保留工资额度;-- 原 中小学教师保留10%
			 ,blhs10 ,bltg ,psxlj 
			-- 在护士岗位工作满20年并在医疗卫生机构工作的保留原提高10% 保留原特殊岗位活工资比例提高部分 运动员平时训练奖
			,jxgz
			--  绩效工资
			,jbt_code_salary  )
			-- 津补贴项目-金额
			/*,total_salary,part_total_salary,zwgz_salary,gwgz_salary,
			dszn_salary,llt_salary,ggbl_salary,hmbt_salary,jjbabt_salary,xfgzry_salary,zsjz_salary,gwygfh_salary,ycxbkf_salary*/
	select  ',v_i_fund_month,',',v_unit_dataId,',\'',v_unit_id,'\',a.changeType,count(1) ,
		-- sum(ifnull(c.total_salary_bf,c.total_salary_ce)),sum(ifnull(c.part_total_salary_bf,c.part_total_salary_ce)),sum(ifnull(c.zwgz_bf,c.zwgz_ce)),sum(ifnull(c.gwgz_bf,c.gwgz_ce)),sum(ifnull(c.jbt_salary_bf,c.jbt_salary_ce)),sum(c.total_salary_bf)
		sum(ifnull(c.total_salary_bf,0)+ifnull(c.total_salary_ce,0)),sum(c.part_total_salary_ce),sum(c.zwgz_ce),sum(c.gwgz_ce),sum(c.jbt_salary_ce),sum(c.total_salary_bf)
	-- sum(b.c32),sum(b.c32),sum(b.c25),sum(b.c26), sum(b.c27),sum(b.c32)
	-- 工资总计-如果没有则算差额,差额情况不计入补扣发 工资合计  职务工资  级别工资 津补贴小计 一次性补扣发
     ,sum(ifnull(c.jshstg_ce,0)),sum(ifnull(c.tsjytg_ce,0)),sum(ifnull(c.jsblgz_ce,0))
	-- 中小学教师或护士提高10%  特殊教育提高15%  退役运动员保留工资额度;-- 原 中小学教师保留10%
     ,sum(ifnull(c.hsblgz_ce,0)),sum(ifnull(c.bltggz_ce,0)),sum(ifnull(c.psxlj_ce,0))
	-- 在护士岗位工作满20年并在医疗卫生机构工作的保留原提高10% 保留原特殊岗位活工资比例提高部分 运动员平时训练奖
	,sum(ifnull(c.jxgz_ce,00))
	-- 绩效工资
	,(select group_concat(z.c02,\'-\',case when round(z.je ,2)=0 then \'\' else round(z.je ,2) end) from (	
			select t116.c02,sum(ifnull(d.jbt_salary_ce,0)) as je,a.changeType from data_record_t126 a 
			join data_record_t125 b on a.changeSign = b.changeSign 
			join data_record_t117 c on a.changeSign = c.changeSign join t116 on c.c04=t116.id
			left join fund_salary_fill_subsidies_',v_i_fund_month,' d 
				on d.changeSign = a.changeSign and d.jbt_id = t116.id  
				where a.c01 = \'',v_unit_dataId,'\'
			 	and  a.allAuditFlag=9 
			 	and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = \'wageSystem\' and d.data_value in( \'204\',\'205\')) -- 人员工资制度为 204事业人员
				and a.changeType != ',lrxjryCode,' -- 不等于录入新进人员
				and a.changeType != ',ryjsCode,' -- 不等于人员减少
				and a.changeType != ',jbxxxgCode,' -- 不等于人员基本信息修改
				and a.changeType != ',hfgzdyCode,' -- 不等于恢复发放工资
				and a.changeType not in(10647,10648,10649,10745,10646,10650,10652,11321,11322,11323)  -- 不等于转岗为 机关序列和处分不同职务序列
				group by t116.c02,a.changeType) 
			z  where z.changeType = a.changeType)
	from data_record_t126 a join data_record_t125 b  on a.changeSign = b.changeSign
	left join fund_salary_fill_',v_i_fund_month,' c
	on a.changeSign = c.changeSign
	where a.c01 = \'',v_unit_dataId,'\'
	 and  a.allAuditFlag=9  and a.changeSign = b.changeSign 
	and b.c06 = concat(a.dataId,\'\')
	and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = \'wageSystem\' and d.data_value in( \'204\',\'205\')) -- 人员工资制度为 204事业人员
	and a.changeType != ',lrxjryCode,' -- 不等于录入新进人员
	and a.changeType != ',jbxxxgCode,' -- 不等于人员基本信息修改
	and a.changeType != ',hfgzdyCode,' -- 不等于恢复发放工资
	and a.changeType != ',ryjsCode,' -- 不等于人员减少
	and a.changeType not in(10647,10648,10649,10745,10646,10650,10652,11321,11322,11323,10832)  -- 不等于转岗为 机关序列和处分不同职务序列
	and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = \'staffStatus\' and d.data_value = \'2\')
	-- 非离休人员
	-- and not exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = \'bdlx\' and d.data_value like \'01%\' ) -- 不是重新确定工资
	group by a.changeType '); 
PREPARE stmt FROM @sqlstr;
EXECUTE stmt;
DROP PREPARE stmt;
	-- 其它要计算补扣发的变动  事业转事业
	SET @sqlstr = CONCAT('INSERT INTO fund_total_ins(fund_month,unit_id,unit_code,change_type,change_person_num,
			total_salary,part_total_salary,zwgz_salary,gwgz_salary,jbt_salary,ycxbkf_salary
			-- 工资合计   工资小计					职务工资  级别工资 津补贴小计  一次性补扣发 
			,jstg10 ,tsjy15 ,blzxx10
			-- 中小学教师或护士提高10%  特殊教育提高15% 退役运动员保留工资额度;-- 原 中小学教师保留10%
			 ,blhs10 ,bltg ,psxlj 
			-- 在护士岗位工作满20年并在医疗卫生机构工作的保留原提高10% 保留原特殊岗位活工资比例提高部分 运动员平时训练奖
			,jxgz
			--  绩效工资
			,jbt_code_salary  )
			-- 津补贴项目-金额
			/*,total_salary,part_total_salary,zwgz_salary,gwgz_salary,
			dszn_salary,llt_salary,ggbl_salary,hmbt_salary,jjbabt_salary,xfgzry_salary,zsjz_salary,gwygfh_salary,ycxbkf_salary*/
	select  ',v_i_fund_month,',',v_unit_dataId,',\'',v_unit_id,'\',(select d.name from sys_s_data d where d.id = a.changeType),count(1) ,
		-- sum(ifnull(c.total_salary_bf,c.total_salary_ce)),sum(ifnull(c.part_total_salary_bf,c.part_total_salary_ce)),sum(ifnull(c.zwgz_bf,c.zwgz_ce)),sum(ifnull(c.gwgz_bf,c.gwgz_ce)),sum(ifnull(c.jbt_salary_bf,c.jbt_salary_ce)),sum(c.total_salary_bf)
		sum(ifnull(c.total_salary_bf,0)+ifnull(c.total_salary_ce,0)),sum(c.part_total_salary_ce),sum(c.zwgz_ce),sum(c.gwgz_ce),sum(c.jbt_salary_ce),sum(c.total_salary_bf)
	-- sum(b.c32),sum(b.c32),sum(b.c25),sum(b.c26), sum(b.c27),sum(b.c32)
	-- 工资总计-如果没有则算差额,差额情况不计入补扣发 工资合计  职务工资  级别工资 津补贴小计 一次性补扣发
     ,sum(ifnull(c.jshstg_ce,0)),sum(ifnull(c.tsjytg_ce,0)),sum(ifnull(c.jsblgz_ce,0))
	-- 中小学教师或护士提高10%  特殊教育提高15%  退役运动员保留工资额度;-- 原 中小学教师保留10%
     ,sum(ifnull(c.hsblgz_ce,0)),sum(ifnull(c.bltggz_ce,0)),sum(ifnull(c.psxlj_ce,0))
	-- 在护士岗位工作满20年并在医疗卫生机构工作的保留原提高10% 保留原特殊岗位活工资比例提高部分 运动员平时训练奖
	,sum(ifnull(c.jxgz_ce,00))
	-- 绩效工资
	,(select group_concat(z.c02,\'-\',case when round(z.je ,2)=0 then \'\' else round(z.je ,2) end) from (	
			select t116.c02,sum(ifnull(d.jbt_salary_ce,0)) as je,a.changeType from data_record_t126 a 
			join data_record_t125 b on a.changeSign = b.changeSign 
			join data_record_t117 c on a.changeSign = c.changeSign join t116 on c.c04=t116.id
			left join fund_salary_fill_subsidies_',v_i_fund_month,' d 
				on d.changeSign = a.changeSign and d.jbt_id = t116.id
			LEFT JOIN data_record_t125 g on g.c06=b.c06 and g.id=(select max(h.id) from data_record_t125 h  where h.c06=b.c06 and h.id <b.id)
				where a.c01 = \'',v_unit_dataId,'\'
			 	and  a.allAuditFlag=9 
			 	and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = \'wageSystem\' and d.data_value in( \'204\',\'205\')) -- 人员工资制度为 204事业人员
				and a.changeType != ',lrxjryCode,' -- 不等于录入新进人员
				and a.changeType != ',ryjsCode,' -- 不等于人员减少
				and a.changeType != ',jbxxxgCode,' -- 不等于人员基本信息修改
				and a.changeType != ',hfgzdyCode,' -- 不等于恢复发放工资
				and a.changeType  in(10647,10648,10649,10745)  --   转岗
				and   g.c36   in (10472,10473)  -- 上一条变动是事业工资制度
				group by t116.c02,a.changeType) 
			z  where z.changeType = a.changeType)
	from data_record_t126 a join data_record_t125 b  on a.changeSign = b.changeSign
	left join fund_salary_fill_',v_i_fund_month,' c
	on a.changeSign = c.changeSign
	LEFT JOIN data_record_t125 g on g.c06=b.c06 and g.id=(select max(h.id) from data_record_t125 h  where h.c06=b.c06 and h.id <b.id)
	where a.c01 = \'',v_unit_dataId,'\'
	 and  a.allAuditFlag=9  and a.changeSign = b.changeSign 
	and b.c06 = concat(a.dataId,\'\')
	and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = \'wageSystem\' and d.data_value in( \'204\',\'205\')) -- 人员工资制度为 204事业人员
	and a.changeType != ',lrxjryCode,' -- 不等于录入新进人员
	and a.changeType != ',jbxxxgCode,' -- 不等于人员基本信息修改
	and a.changeType != ',hfgzdyCode,' -- 不等于恢复发放工资
	and a.changeType != ',ryjsCode,' -- 不等于人员减少
	and a.changeType  in(10647,10648,10649,10745)  -- 同职务序列转岗
	and   g.c36   in (10472,10473) -- 上一条变动是事业工资制度
	and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = \'staffStatus\' and d.data_value = \'2\')
	-- 非离休人员
	-- and not exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = \'bdlx\' and d.data_value like \'01%\' ) -- 不是重新确定工资
	group by a.changeType '); 
PREPARE stmt FROM @sqlstr;
EXECUTE stmt;
DROP PREPARE stmt;
	-- 不同职务序列转岗    机关转事业
	SET @sqlstr = CONCAT('INSERT INTO fund_total_ins(fund_month,unit_id,unit_code,change_type,change_person_num,
			total_salary,part_total_salary,zwgz_salary,gwgz_salary,jbt_salary,ycxbkf_salary
			-- 工资合计   工资小计					职务工资  级别工资 津补贴小计  一次性补扣发 
			,jstg10 ,tsjy15 ,blzxx10
			-- 中小学教师或护士提高10%  特殊教育提高15% 退役运动员保留工资额度;-- 原 中小学教师保留10%
			 ,blhs10 ,bltg ,psxlj 
			-- 在护士岗位工作满20年并在医疗卫生机构工作的保留原提高10% 保留原特殊岗位活工资比例提高部分 运动员平时训练奖
			,jxgz
			--  绩效工资
			,jbt_code_salary  )
			-- 津补贴项目-金额
			/*,total_salary,part_total_salary,zwgz_salary,gwgz_salary,
			dszn_salary,llt_salary,ggbl_salary,hmbt_salary,jjbabt_salary,xfgzry_salary,zsjz_salary,gwygfh_salary,ycxbkf_salary*/
	select  ',v_i_fund_month,',',v_unit_dataId,',\'',v_unit_id,'\', case when a.changeType = \'10745\' then (select d.name from sys_s_data d where d.id = a.changeType) else concat(\'机关\',(select d.name from sys_s_data d where d.id = a.changeType)) end,count(1) ,
		-- sum(ifnull(c.total_salary_bf,c.total_salary_ce)),sum(ifnull(c.part_total_salary_bf,c.part_total_salary_ce)),sum(ifnull(c.zwgz_bf,c.zwgz_ce)),sum(ifnull(c.gwgz_bf,c.gwgz_ce)),sum(ifnull(c.jbt_salary_bf,c.jbt_salary_ce)),sum(c.total_salary_bf)
		-- sum(ifnull(c.total_salary_ce,0)-ifnull(c.total_salary,0)),sum(c.part_total_salary_ce),sum(c.zwgz_ce),sum(c.gwgz_ce),sum(c.jbt_salary_ce),sum(c.total_salary_bf)
		sum(ifnull(c.total_salary,0)),sum(c.part_total_salary),sum(c.zwgz),sum(c.gwgz),sum(c.jbt_salary),0
	-- sum(b.c32),sum(b.c32),sum(b.c25),sum(b.c26), sum(b.c27),sum(b.c32)
	-- 工资总计-如果没有则算差额,差额情况不计入补扣发 工资合计  职务工资  级别工资 津补贴小计 一次性补扣发
     ,sum(ifnull(c.jshstg,0)),sum(ifnull(c.tsjytg,0)),sum(ifnull(c.jsblgz,0))
	-- 中小学教师或护士提高10%  特殊教育提高15%  退役运动员保留工资额度;-- 原 中小学教师保留10%
     ,sum(ifnull(c.hsblgz,0)),sum(ifnull(c.bltggz,0)),sum(ifnull(c.psxlj,0))
	-- 在护士岗位工作满20年并在医疗卫生机构工作的保留原提高10% 保留原特殊岗位活工资比例提高部分 运动员平时训练奖
	,sum(ifnull(c.jxgz,00))
	-- 绩效工资
	,(select group_concat(z.c02,\'-\',case when round(z.je ,2)=0 then \'\' else round(z.je ,2) end) from (	
			select t116.c02,sum(ifnull(d.salary_value,0)) as je,a.changeType from data_record_t126 a 
			join data_record_t125 b on a.changeSign = b.changeSign 
			join data_record_t117 c on a.changeSign = c.changeSign join t116 on c.c04=t116.id
			left join fund_salary_fill_subsidies_',v_i_fund_month,' d 
				on d.changeSign = a.changeSign and d.jbt_id = t116.id 
				LEFT JOIN data_record_t125 g on g.c06=b.c06 and g.id=(select max(h.id) from data_record_t125 h  where h.c06=b.c06 and h.id <b.id)
				where a.c01 = \'',v_unit_dataId,'\'
			 	and  a.allAuditFlag=9 
			 	and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = \'wageSystem\' and d.data_value in( \'204\',\'205\')) -- 人员工资制度为 204事业人员
				and a.changeType != ',lrxjryCode,' -- 不等于录入新进人员
				and a.changeType != ',ryjsCode,' -- 不等于人员减少
				and a.changeType != ',jbxxxgCode,' -- 不等于人员基本信息修改
				and a.changeType != ',hfgzdyCode,' -- 不等于恢复发放工资
				and a.changeType  in(10647,10648,10649,10745)  -- 等于转岗为 事业
				and   g.c36  not in (10472,10473)	-- 上一变动是机关工资制度
				group by t116.c02,a.changeType) 
			z  where z.changeType = a.changeType)
	from data_record_t126 a join data_record_t125 b  on a.changeSign = b.changeSign
	left join fund_salary_fill_',v_i_fund_month,' c
	on a.changeSign = c.changeSign
	LEFT JOIN data_record_t125 g on g.c06=b.c06 and g.id=(select max(h.id) from data_record_t125 h  where h.c06=b.c06 and h.id <b.id)
	where a.c01 = \'',v_unit_dataId,'\'
	 and  a.allAuditFlag=9  and a.changeSign = b.changeSign 
	and b.c06 = concat(a.dataId,\'\')
	and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = \'wageSystem\' and d.data_value in( \'204\',\'205\')) -- 人员工资制度为 204事业人员
	and a.changeType != ',lrxjryCode,' -- 不等于录入新进人员
	and a.changeType != ',jbxxxgCode,' -- 不等于人员基本信息修改
	and a.changeType != ',hfgzdyCode,' -- 不等于恢复发放工资
	and a.changeType != ',ryjsCode,' -- 不等于人员减少
	and a.changeType  in(10647,10648,10649,10745)  -- 等于转岗为 事业
	and   g.c36  not in (10472,10473)	-- 上一变动是机关工资制度
	and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = \'staffStatus\' and d.data_value = \'2\')
	-- 非离休人员
	-- and not exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = \'bdlx\' and d.data_value like \'01%\' ) -- 不是重新确定工资
	group by a.changeType '); 
PREPARE stmt FROM @sqlstr;
EXECUTE stmt;
DROP PREPARE stmt;

	-- 不同职务序列转岗   事业转机关
	SET @sqlstr = CONCAT('INSERT INTO fund_total_ins(fund_month,unit_id,unit_code,change_type,change_person_num,
			total_salary,part_total_salary,zwgz_salary,gwgz_salary,jbt_salary,ycxbkf_salary
			-- 工资合计   工资小计					职务工资  级别工资 津补贴小计  一次性补扣发 
			,jstg10 ,tsjy15 ,blzxx10
			-- 中小学教师或护士提高10%  特殊教育提高15% 退役运动员保留工资额度;-- 原 中小学教师保留10%
			 ,blhs10 ,bltg ,psxlj 
			-- 在护士岗位工作满20年并在医疗卫生机构工作的保留原提高10% 保留原特殊岗位活工资比例提高部分 运动员平时训练奖
			,jxgz
			--  绩效工资
			,jbt_code_salary  )
			-- 津补贴项目-金额
			/*,total_salary,part_total_salary,zwgz_salary,gwgz_salary,
			dszn_salary,llt_salary,ggbl_salary,hmbt_salary,jjbabt_salary,xfgzry_salary,zsjz_salary,gwygfh_salary,ycxbkf_salary*/
	select  ',v_i_fund_month,',',v_unit_dataId,',\'',v_unit_id,'\',case when a.changeType =\'10745\' then (select d.name from sys_s_data d where d.id = a.changeType) else concat(\'事业\',(select d.name from sys_s_data d where d.id = a.changeType)) end,count(1) ,
		-- sum(ifnull(c.total_salary_bf,c.total_salary_ce)),sum(ifnull(c.part_total_salary_bf,c.part_total_salary_ce)),sum(ifnull(c.zwgz_bf,c.zwgz_ce)),sum(ifnull(c.gwgz_bf,c.gwgz_ce)),sum(ifnull(c.jbt_salary_bf,c.jbt_salary_ce)),sum(c.total_salary_bf)
		sum(ifnull(c.total_salary_ce,0)-ifnull(c.total_salary,0)),sum(ifnull(c.part_total_salary_ce,0) - ifnull(c.part_total_salary,0)),sum(ifnull(c.zwgz_ce,0) - ifnull(c.zwgz,0)),sum(ifnull(c.gwgz_ce,0) -ifnull(c.gwgz,0) ),sum(ifnull(c.jbt_salary_ce,0) - ifnull(c.jbt_salary,0)),0
	-- sum(b.c32),sum(b.c32),sum(b.c25),sum(b.c26), sum(b.c27),sum(b.c32)
	-- 工资总计-如果没有则算差额,差额情况不计入补扣发 工资合计  职务工资  级别工资 津补贴小计 一次性补扣发
     ,sum(ifnull(c.jshstg_ce,0) - ifnull(c.jshstg,0)),sum(ifnull(c.tsjytg_ce,0)-ifnull(c.tsjytg,0)),sum(ifnull(c.jsblgz_ce,0)-ifnull(c.jsblgz,0))
	-- 中小学教师或护士提高10%  特殊教育提高15%  退役运动员保留工资额度;-- 原 中小学教师保留10%
     ,sum(ifnull(c.hsblgz_ce,0)-ifnull(c.hsblgz,0)),sum(ifnull(c.bltggz_ce,0)-ifnull(c.bltggz,0)),sum(ifnull(c.psxlj_ce,0)-ifnull(c.psxlj,0))
	-- 在护士岗位工作满20年并在医疗卫生机构工作的保留原提高10% 保留原特殊岗位活工资比例提高部分 运动员平时训练奖
	,sum(ifnull(c.jxgz_ce,00)-ifnull(c.jxgz,00))
	-- 绩效工资
	,(select group_concat(z.c02,\'-\',case when round(z.je ,2)=0 then \'\' else round(z.je ,2) end) from (	
			select t116.c02,sum(ifnull(d.jbt_salary_ce,0) - ifnull(d.salary_value,0)) as je,a.changeType from data_record_t126 a 
			join data_record_t125 b on a.changeSign = b.changeSign 
			join data_record_t117 c on a.changeSign = c.changeSign join t116 on c.c04=t116.id
			left join fund_salary_fill_subsidies_',v_i_fund_month,' d 
				on d.changeSign = a.changeSign and d.jbt_id = t116.id
				LEFT JOIN data_record_t125 g on g.c06=b.c06 and g.id=(select max(h.id) from data_record_t125 h  where h.c06=b.c06 and h.id <b.id) 
				where a.c01 = \'',v_unit_dataId,'\'
			 	and  a.allAuditFlag=9 
			 	and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = \'wageSystem\' and d.data_value in(201,206,202,203,207,208)) -- 人员工资制度为 204事业人员
				and a.changeType != ',lrxjryCode,' -- 不等于录入新进人员
				and a.changeType != ',ryjsCode,' -- 不等于人员减少
				and a.changeType != ',jbxxxgCode,' -- 不等于人员基本信息修改
				and a.changeType != ',hfgzdyCode,' -- 不等于恢复发放工资
				and a.changeType  in(10646,10650,10652,10745,11321,11322,11323)  -- 等于转岗为 机关序列和处分不同职务序列
				and   g.c36   in (10472,10473)	-- 上一变动是事业工资制度
				group by t116.c02,a.changeType) 
			z  where z.changeType = a.changeType)
	from data_record_t126 a join data_record_t125 b  on a.changeSign = b.changeSign
	left join fund_salary_fill_',v_i_fund_month,' c
	on a.changeSign = c.changeSign
	LEFT JOIN data_record_t125 g on g.c06=b.c06 and g.id=(select max(h.id) from data_record_t125 h  where h.c06=b.c06 and h.id <b.id)
	where a.c01 = \'',v_unit_dataId,'\'
	 and  a.allAuditFlag=9  and a.changeSign = b.changeSign 
	and b.c06 = concat(a.dataId,\'\')
	and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = \'wageSystem\' and d.data_value in(201,206,202,203,207,208)) -- 人员工资制度为 204事业人员
	and a.changeType != ',lrxjryCode,' -- 不等于录入新进人员
	and a.changeType != ',jbxxxgCode,' -- 不等于人员基本信息修改
	and a.changeType != ',hfgzdyCode,' -- 不等于恢复发放工资
	and a.changeType != ',ryjsCode,' -- 不等于人员减少
	and a.changeType  in(10646,10650,10652,10745,11321,11322,11323)  -- 等于转岗为 机关序列和处分不同职务序列
	and   g.c36   in (10472,10473)	-- 上一变动是事业工资制度
	and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = \'staffStatus\' and d.data_value = \'2\')
	-- 非离休人员
	-- and not exists(select 1 from sys_s_data d where d.id = a.c40 and d.typename = \'bdlx\' and d.data_value like \'01%\' ) -- 不是重新确定工资
	group by a.changeType '); 
PREPARE stmt FROM @sqlstr;
EXECUTE stmt;
DROP PREPARE stmt;
	
	-- 基金生成未上报code
	select ifnull(content,11208) into @noApplyAuditCode from sys_s_config where enname = 'NOAPPLY_AUDIT_CODE';
	
	-- 年终奖金发放
	-- 更新当前单位 未审核通过的年终奖金发放管理表数据
	select count(1) into stemNum from t151 ,t154 where t151.id = t154.c09 and t151.c01 = concat(v_unit_dataId,'') 
	and exists(select 1 from t125,sys_s_data d where d.id = t125.c36 and t125.c06=t154.c02 and d.typename = 'wageSystem' and d.data_value in ('204','205'))
	and (exists (select 1 from sys_s_data d where d.typename = 'ybshzt' and d.data_value != '2' and d.id = ifnull(t151.c03,''))
		or ifnull(t151.c03,'') = ''
	);
	set @yearHj = 0;
	set stemParam = 0;
	-- 月报审核状态  0-未处理 1-待审核 2-通过 3-未通过 7-撤回申请中 8-撤回 9-生成基金未上报
	if stemNum > 0 then
		select ifnull(content,11263) into @yearAwardCode from sys_s_config where enname = 'YEAR_AWARD_CODE';
		update t151 ,sys_s_data d set t151.c03 = d.id,t151.c04=concat(v_i_fund_month,'')
		 where t151.c01 = concat(v_unit_dataId,'') and t151.c03 != 11204 -- sys_s_data 11204 月报审核状态 -审核通过 
		and d.typename = 'ybshzt' and d.data_value= '9' ; 
		 
		update t154,t151 set t154.c04=concat(v_i_fund_month,'') where t154.c09=t151.id 
		and t151.c01 = concat(v_unit_dataId,'') and t151.c04=concat(v_i_fund_month,'');-- 更新年终奖金发放表的基金月份/发放时间
		select id into stempParam from t151 where c01 = concat(v_unit_dataId,'') and c03 = @noApplyAuditCode limit 0,1; -- 11208 生成基金未上报
		-- 年终奖金发放表

		select  
			sum(b.c07) into @yearHj
			from t154 b where c09 = stempParam
			and exists(select 1 from t125,sys_s_data d where d.id = t125.c36 and t125.c06=b.c02 and d.typename = 'wageSystem' and d.data_value in ('204','205'))
			;-- 发放编号 

		INSERT INTO fund_total_ins(fund_month,unit_id,unit_code,change_type,change_person_num,
						total_salary,part_total_salary,zwgz_salary,gwgz_salary,jbt_salary,ycxbkf_salary) 
						-- 工资合计   工资小计					职务工资  级别工资  一次性补扣发 津补贴小计
						/*,total_salary,part_total_salary,zwgz_salary,gwgz_salary,
		dszn_salary,llt_salary,ggbl_salary,hmbt_salary,jjbabt_salary,xfgzry_salary,zsjz_salary,gwygfh_salary,ycxbkf_salary*/
			select  v_i_fund_month,v_unit_dataId,v_unit_id,@yearAwardCode,count(1) ,
				sum(b.c07),0,0,0,0,sum(b.c07)
			--  工资总计 工资合计  职务工资  级别工资 津补贴小计
				from t154 b where c09 = stempParam
				and exists(select 1 from t125,sys_s_data d where d.id = t125.c36 and t125.c06=b.c02 and d.typename = 'wageSystem' and d.data_value in ('204','205'))
				;-- 发放编号 
		-- select sum(ycxbkf_salary) into stemParam -- 获取基金月份对应的年终奖金补扣发之和
		-- 	from fund_total_ins where unit_id =v_unit_dataId and fund_month = v_i_fund_month and change_type = @yearAwardCode;
			
	end if;
	
	set stemParam = 0;
	-- 艰苦边远地区津补贴补扣发
	-- 更新当前单位 未审核通过的 艰苦边远地区津补贴补扣发 表数据
	select count(1) into stemNum from t164 where c01 = concat(v_unit_dataId,'') 
	and exists(select 1 from t125 b,sys_s_data d where d.id = b.c36 and t164.c03=b.c06 and d.typename = 'wageSystem' and d.data_value in ('204','205'))
	and (exists (select 1 from sys_s_data d where d.typename = 'ybshzt' and d.data_value != '2' and d.id = ifnull(t164.c10,''))
		or ifnull(t164.c10,'') = ''
	);
	-- 月报审核状态  0-未处理 1-待审核 2-通过 3-未通过 7-撤回申请中 8-撤回 9-生成基金未上报
	if stemNum > 0 then
		select ifnull(content,11315) into @hardMoteCode from sys_s_config where enname = 'HARD_MOTE_CODE';
		update t164 ,sys_s_data d set t164.c10 = d.id,t164.c11=concat(v_i_fund_month,'')
		 where t164.c01 = concat(v_unit_dataId,'') 
		 and exists(select 1 from t125 b,sys_s_data d where d.id = b.c36 and t164.c03=b.c06 and d.typename = 'wageSystem' and d.data_value in ('204','205'))
		 and t164.c10 != 11204 -- sys_s_data 11204 月报审核状态 -审核通过 
		and d.typename = 'ybshzt' and d.data_value= '9' ; 
		 
		select id into stempParam from t164 where c01 = concat(v_unit_dataId,'') and c10 = @noApplyAuditCode limit 0,1; -- 11208 生成基金未上报
		-- 艰边津补贴表
		INSERT INTO fund_total_ins(fund_month,unit_id,unit_code,change_type,change_person_num,
						total_salary,part_total_salary,zwgz_salary,gwgz_salary,jbt_salary,ycxbkf_salary) 
						-- 工资合计   工资小计					职务工资  级别工资  津补贴小计  一次性补扣发
						/*,total_salary,part_total_salary,zwgz_salary,gwgz_salary,
		dszn_salary,llt_salary,ggbl_salary,hmbt_salary,jjbabt_salary,xfgzry_salary,zsjz_salary,gwygfh_salary,ycxbkf_salary*/
			select  v_i_fund_month,v_unit_dataId,v_unit_id,@hardMoteCode,count(1) ,
				sum(t164.c09),0,0,0,0,sum(t164.c09)
			--  工资总计 工资合计  职务工资  级别工资 津补贴小计   一次性补扣发
				from t164  where c11 = concat(v_i_fund_month,'') and c01 = concat(v_unit_dataId,'') 
				and exists(select 1 from t125 b,sys_s_data d where d.id = b.c36 and t164.c03=b.c06 and d.typename = 'wageSystem' and d.data_value in ('204','205'))
				;
		select sum(ycxbkf_salary+stemParam) into stemParam -- 获取基金月份对应的 艰苦边远地区津补贴补扣发 补扣发费用之和
			from fund_total_ins where unit_id =concat(v_unit_dataId,'') and fund_month = concat(v_i_fund_month,'') and change_type = @hardMoteCode;
	end if;
	
	
	-- 其它一次性补扣发
	-- 更新当前单位 未审核通过的其它一次性补扣发管理表数据
	select count(1) into stemNum from t119 where c04 = concat(v_unit_dataId,'') 
	-- and EXISTS (select 1 from t126,sys_s_data d where d.id = t126.c03 and t126.id = t119.c01 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
	and exists(select 1 from sys_s_data d,t125 b where d.id = b.c36 and b.c06 = t119.c01 and d.typename = 'wageSystem' and d.data_value in ('204','205'))
	and (exists (select 1 from sys_s_data d where d.typename = 'ybshzt' and d.data_value != '2' and d.id = ifnull(t119.c21,''))
		or ifnull(t119.c21,'') = ''
	)
	and not exists(select 1 from t126,sys_s_data d where t126.id = t119.c01 and  d.id = t126.c03 and d.typename = 'staffStatus' and d.data_value = '2')
	-- 非离休人员
	;
	
	set stemParam = 0;
	-- 月报审核状态  0-未处理 1-待审核 2-通过 3-未通过 7-撤回申请中 8-撤回 9-生成基金未上报
	if stemNum > 0 then
		select ifnull(content,11264) into @otherFillCode from sys_s_config where enname = 'OTHER_FILL_CODE';-- 11264其它一次性补扣发
		select count(1) into stemNum from t119,t125 b where t119.c01=b.c06 
		and t119.c04 = concat(v_unit_dataId,'') and t119.c21 != 11204  -- sys_s_data 11204 月报审核状态 -审核通过
		-- and EXISTS (select 1 from t126,sys_s_data d where d.id = t126.c03 and t126.id = t119.c01 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
		and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in ('204','205')) 
		and not exists(select 1 from t126,sys_s_data d where t126.id = t119.c01 and d.id = t126.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		;
		if stemNum > 0 then 
			update t119,t125 b ,sys_s_data d set t119.c21 = d.id,t119.c20=concat(v_i_fund_month,'')
			 where t119.c04 = concat(v_unit_dataId,'') and ifnull(t119.c21,'') != 11204 -- sys_s_data 11204 月报审核状态 -审核通过 
			and d.typename = 'ybshzt' and d.data_value= '9' 
			and t119.c01=b.c06 
			-- and EXISTS (select 1 from t126,sys_s_data d where d.id = t126.c03 and t126.id = t119.c01 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
			and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in ('204','205'))  -- 204事业绩效岗位工资制
			and not exists(select 1 from t126,sys_s_data d where t126.id = t119.c01 and  d.id = t126.c03 and d.typename = 'staffStatus' and d.data_value = '2')
			-- 非离休人员
			;
			-- 其它一次性补扣发
			INSERT INTO fund_total_ins(fund_month,unit_id,unit_code,change_type,changetype_name,change_person_num,
							jstg10,tsjy15,blzxx10,blhs10,bltg,psxlj,jxgz,
							-- 教师护士提高10%,特殊教育提高15%, 中小学教师保留10%(改名为:退役运动员保留工资额度) 保留护士提高10%  保留特岗 平时训练奖 绩效工资/基础绩效
							total_salary,/*part_total_salary,*/zwgz_salary,gwgz_salary,jbt_salary,ycxbkf_salary,jbt_code_salary)
							-- 其它人员一次性补扣发 不计算工资小计  
							-- 工资合计   工资小计					职务工资  级别工资  一次性补扣发 津补贴小计
							/*,total_salary,part_total_salary,zwgz_salary,gwgz_salary,
		dszn_salary,llt_salary,ggbl_salary,hmbt_salary,jjbabt_salary,xfgzry_salary,zsjz_salary,gwygfh_salary,ycxbkf_salary*/
			select  v_i_fund_month,v_unit_dataId,v_unit_id,@otherFillCode,t119.c05,count(1) ,
				-- sum(t119.c11),sum(t119.c12),sum(t119.c13),sum(t119.c14),sum(t119.c15),sum(t119.c16),sum(t119.c26),
				0,0,0,0,0,0,0,
				sum(t119.c22),/*sum(t119.c09),*/0/*sum(t119.c06)*/,0/*sum(t119.c07)*/,0/*round(sum(t119.c08),2)*/,sum(t119.c22)
				-- -- 其它人员一次性补扣发 不计算工资小计   不计算津补贴小计  不计算津补贴细项
				-- 工资总计 工资合计 职务工资  级别工资 津补贴小计 一次性补扣发
				,''/*
				(select group_concat(c02,'-',case when round(je ,2)=0 then '' else round(je ,2) end) from 
			(	select t119.c05,t116.c02,sum(t150.c04 ) as je 
				from t150  join t119 on t119.id = t150.c01 join t116 on t150.c02 = t116.id
				where  t150.c01 = t119.id  
				and exists(select 1 from sys_s_data d,t125 c
					where t119.c01 = c.c06 and d.id = c.c36
					and d.typename = 'wageSystem' and d.data_value in (204,205))
				and t119.c04 = concat(v_unit_dataId,'')  and t119.c21 = @noApplyAuditCode group by t116.c02,t119.c05
				) a where a.c05 = t119.c05) */			
				from t119 ,t125 c
				where t119.c01 = c.c06 
				and exists(select 1 from sys_s_data d where d.id = c.c36 and d.typename = 'wageSystem' and d.data_value in ('204','205')) 
				-- and EXISTS (select 1 from t126,sys_s_data d where d.id = t126.c03 and t126.id = t119.c01 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
				and t119.c04 = concat(v_unit_dataId,'') and t119.c21 = @noApplyAuditCode
				and not exists(select 1 from t126,sys_s_data d where t126.id = t119.c01 and d.id = t126.c03 and d.typename = 'staffStatus' and d.data_value = '2')
				-- 非离休人员
				group by t119.c04,t119.c05; -- 11208 生成基金未上报
		end if;
	end if;
	-- CALL getFundTotalJbt ('fund_total_ins',v_unit_dataId,v_i_fund_month,resultMsg);/*基金计算津补贴*/
	select group_concat(z.c02,'-',round(z.je ,2)) into resultMsg from ( select t116.c02,SUM(t117.c07) as je from 
	t126,t117,t116 where t126.c01 = concat(v_unit_dataId,'') and concat(t126.id,'') = t117.c03 and t116.id = t117.c04
	and  t126.c03 ='10371' and t126.c40 not in('10646','10650','10652','10831','10855') and t126.c28  in ('10518','10519','10520','10522') GROUP BY t116.c02
	) z ;
	set @jbt_code_salary = resultMsg;
	set resultMsg = '';
	
	select sum(ifnull(ycxbkf_salary,0)) into stemParam
			from fund_total_ins where unit_id =concat(v_unit_dataId,'') and fund_month = concat(v_i_fund_month,'')
			 and change_type not in( '本月核定工资总额','上月核定工资总额');-- 11264 其它一次性补扣发
			 
	 select sum(ifnull(total_salary,0)),ifnull(sum(part_total_salary),0),
		sum(ifnull(zwgz_salary,0)),sum(ifnull(gwgz_salary,0)),sum(ifnull(jbt_salary,0))
		,sum(ifnull(jstg10,0)) ,sum(ifnull(tsjy15,0)) ,sum(ifnull(blzxx10,0))
		-- 中小学教师或护士提高10%  特殊教育提高15% 退役运动员保留工资额度;-- 原 中小学教师保留10%
		 ,sum(ifnull(blhs10,0)) ,sum(ifnull(bltg,0)) ,sum(ifnull(psxlj ,0))
		-- 在护士岗位工作满20年并在医疗卫生机构工作的保留原提高10% 保留原特殊岗位活工资比例提高部分 运动员平时训练奖
		,sum(ifnull(jxgz,0))
		--  绩效工资
	 	into @stemBkfHj,@stemBkfXj,@stemBkfZwgz,@stemBkfJbgz,@stemBkfJbtXj,
	 	@stemJstgBkf,@stemTsjyBkf,@stemBlzxx10Bkf,
	 	@stemBhs10Bkf,@stemBltgBkf,@stemPsxljBkf,
	 	@stemJxgzBkf
		from fund_total_ins where unit_id =concat(v_unit_dataId,'') and fund_month = concat(v_i_fund_month,'')
	 	and change_type = 11264;-- 其它一次性补扣发
	set @stemBkfHj = @yearHj+ifnull(@stemBkfHj,0)+0;	
	-- 本月核定工资总额
	INSERT INTO fund_total_ins(fund_month,unit_id,unit_code,change_type,change_person_num,
				total_salary,part_total_salary,zwgz_salary,gwgz_salary,jbt_salary,ycxbkf_salary
				,jstg10 ,tsjy15 ,blzxx10
				-- 中小学教师或护士提高10%  特殊教育提高15% 退役运动员保留工资额度;-- 原 中小学教师保留10%
				 ,blhs10 ,bltg ,psxlj 
				-- 在护士岗位工作满20年并在医疗卫生机构工作的保留原提高10% 保留原特殊岗位活工资比例提高部分 运动员平时训练奖
				,jxgz
				--  绩效工资
				,jbt_code_salary) 
				-- 工资合计   工资小计					职务工资  级别工资 津补贴小计  一次性补扣发
				/*,total_salary,part_total_salary,zwgz_salary,gwgz_salary,
		dszn_salary,llt_salary,ggbl_salary,hmbt_salary,jjbabt_salary,xfgzry_salary,zsjz_salary,gwygfh_salary,ycxbkf_salary*/
		select  v_i_fund_month,v_unit_dataId,v_unit_id,'本月核定工资总额',count(1) ,
		ROUND(sum(b.c32)+ifnull(stemParam,0),2),
		-- 工资合计 
		ROUND(sum(b.c32)+ifnull(@stemBkfXj,0),2),
		--   工资小计
		ROUND(sum(b.c25)+ifnull(@stemBkfZwgz,0),2),
		--  职务工资 
		ROUND(sum(b.c26)+ifnull(@stemBkfJbgz,0),2), 
		--  级别工资
		ROUND(sum(b.c27)+ifnull(@stemBkfJbtXj,0),2),stemParam
		--  津补贴小计
		,ROUND(sum(b.c28)+ifnull(@stemJstgBkf,0),2) ,round(sum(b.c29)+ifnull(@stemTsjyBkf,0),2) ,round(sum(b.c44)+ifnull(@stemBlzxx10Bkf,0),2)
		-- 中小学教师或护士提高10%  特殊教育提高15% 退役运动员保留工资额度;-- 原 中小学教师保留10%
		 ,round(sum(b.c45)+ifnull(@stemBhs10Bkf,0),2) ,round(sum(b.c30)+ifnull(@stemBltgBkf,0),2) ,round(sum(b.c47)+ifnull(@stemPsxljBkf,0),2) 
		-- 在护士岗位工作满20年并在医疗卫生机构工作的保留原提高10% 保留原特殊岗位活工资比例提高部分 运动员平时训练奖
		,round(sum(b.c31)+ifnull(@stemJxgzBkf,0),2)
		--  绩效工资
		,@jbt_code_salary
		from t126 a ,t125 b 
		where  b.c06 = concat(a.id,'') 
		and a.c01 = concat(v_unit_dataId,'')
		and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in ('204','205'))  -- 204事业绩效岗位工资制 205体育津贴奖金制
		and EXISTS (select 1 from sys_s_data d where d.id = a.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
		-- and not exists (select 1 from sys_s_data d where d.id = a.c43 and d.typename = 'is' and d.data_value = '1') -- 不是停发工资的人员
		and ifnull(a.c46,'')='' -- 非调出人员
		and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		;-- 根据变动类型分组
-- 统一处理小数位数   00000001
	update fund_total_gov set total_salary =round(total_salary ,2) where fund_month = concat(v_i_fund_month,'') and unit_id =concat(v_unit_dataId,'');
	update fund_total_gov set part_total_salary =round(part_total_salary ,2) where fund_month = concat(v_i_fund_month,'') and unit_id =concat(v_unit_dataId,'');
	update fund_total_gov set jbt_salary =round(jbt_salary ,2) where fund_month = concat(v_i_fund_month,'') and unit_id =concat(v_unit_dataId,'');
	update fund_total_gov set ycxbkf_salary =round(ycxbkf_salary ,2) where fund_month = concat(v_i_fund_month,'') and unit_id =concat(v_unit_dataId,'');
	leave label_pro;
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`p_5_fund`(in v_i_fund_month varchar(6),in v_unit_id varchar(20),in v_unit_dataId varchar(20),Inout resultMsg varchar(1000))
BEGIN
/*基金生成-分支存储过程 事业变动花名册fund_change_detail_ins*/

/*数据清理*/
	DELETE FROM fund_change_detail_ins WHERE fund_month = v_i_fund_month and unit_id = v_unit_id ;
/*数据插入-变动后*/
	INSERT INTO fund_change_detail_ins(fund_month,unit_id,data_type,staff_id,name,change_type,
		eduLevel,standing,actual_workRank,workRank,isLeader,postSalRank,salRankLevel,grade_salary1,grade_salary2,grade_salary3,
		grade_salary4,grade_salary5,grade_salary6,grade_salary7,grade_salary8,grade_salary9,jbt_total_salary,actual_total_salary,salary_value,theory_total_salary,
		is_finSupt,is_salUniOut,department_name,st_sal_date,en_sal_date)
		select v_i_fund_month,v_unit_id,
				'变动后',
				t1.c02,t1.c04,
				(select name from sys_s_data where id=t1.c40),
				(select name from sys_s_data where id=t1.c09),
				(select c02 from t136 where id=t1.c28),
				(select name from sys_s_data where id=t1.c36),
				(select c05 from t127 where id=t1.c17),
				(select c04 from t127 where id=t1.c27),
				(select c05 from t127 where id=t2.c07),
				(select c04 from t127 where id=t2.c09),
				t2.c25,t2.c26,t2.c28,t2.c29,t2.c30,t2.c44,t2.c45,t2.c47,t2.c31,t2.c27,t2.c32,0,t2.c32+0,
				(select name from sys_s_data where id=t1.c24),
				(select name from sys_s_data where id=t1.c22),
				(select c03 from t113 where id=t1.c15),
				t2.c02,t2.c38
				from data_record_t126 t1,data_record_t125 t2 
				where 1=1 and t1.changeSign = t2.changeSign
					and t1.dataclassCode = "t126"
					and t2.dataclassCode = "t125"
				  and t1.fund_month = v_i_fund_month
				  and SUBSTR(t1.c02,1,9)= v_unit_id
					/*括号中的这些id为人员身份对应的id*/ 
					and t1.c28  
						in (select a.id FROM t136 a,sys_s_data d where a.c06 = d.id and d.data_value = '1');-- t136 c06码表 人员身份类别 0-机关 1-事业


/*数据插入-变动前*/
	INSERT INTO fund_change_detail_ins(fund_month,unit_id,data_type,staff_id,name,change_type,
		eduLevel,standing,actual_workRank,workRank,isLeader,postSalRank,salRankLevel,grade_salary1,grade_salary2,grade_salary3,
		grade_salary4,grade_salary5,grade_salary6,grade_salary7,grade_salary8,grade_salary9,jbt_total_salary,actual_total_salary,salary_value,theory_total_salary,
		is_finSupt,is_salUniOut,department_name,st_sal_date,en_sal_date)
	select v_i_fund_month,v_unit_id,'变动前',
			staff_id,name,change_type,
			eduLevel,standing,actual_workRank,workRank,isLeader,postSalRank,salRankLevel,grade_salary1,grade_salary2,grade_salary3,
			grade_salary4,grade_salary5,grade_salary6,grade_salary7,grade_salary8,grade_salary9,jbt_total_salary,actual_total_salary,salary_value,theory_total_salary,
			is_finSupt,is_salUniOut,department_name,st_sal_date,en_sal_date 
	from fund_change_detail_ins 
	where 1=1 
			and fund_month < v_i_fund_month 
			and unit_id = v_unit_id
			and data_type = '变动后'
ORDER BY fund_month DESC limit 1 ;	

/*数据插入-增减资*/
	INSERT INTO fund_change_detail_ins(fund_month,unit_id,data_type,staff_id,name,change_type,
		eduLevel,standing,actual_workRank,workRank,isLeader,postSalRank,salRankLevel,grade_salary1,grade_salary2,grade_salary3,
		grade_salary4,grade_salary5,grade_salary6,grade_salary7,grade_salary8,grade_salary9,jbt_total_salary,actual_total_salary,salary_value,theory_total_salary,
		is_finSupt,is_salUniOut,department_name,st_sal_date,en_sal_date)
	select t1.fund_month,t1.unit_id,'增减资',t1.staff_id,t1.name,t1.change_type,
			t1.eduLevel,t1.standing,'','','','','',t1.grade_salary1-t2.grade_salary1,t1.grade_salary2-t2.grade_salary2,t1.grade_salary3-t2.grade_salary3,
			t1.grade_salary4-t2.grade_salary4,t1.grade_salary5-t2.grade_salary5,t1.grade_salary6-t2.grade_salary6,t1.grade_salary7-t2.grade_salary7,t1.grade_salary8-t2.grade_salary8,t1.grade_salary9-t2.grade_salary9,t1.jbt_total_salary-t2.jbt_total_salary,t1.actual_total_salary-t2.actual_total_salary,t1.salary_value-t2.salary_value,t1.theory_total_salary-t2.theory_total_salary,
			t1.is_finSupt,t1.is_salUniOut,t1.department_name,t1.st_sal_date,t1.en_sal_date 
		from fund_change_detail_ins t1,fund_change_detail_ins t2 
		where 1=1 
		and t1.fund_month = t2.fund_month 
		and t1.unit_id = t2.unit_id
		and t1.change_type = t2.change_type
		and t1.data_type = '变动后' 
		and t2.data_type = '变动前' 
		and  t1.fund_month = v_i_fund_month and t1.unit_id = v_unit_id;

END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`p_6_fund`(in v_i_fund_month varchar(6),in v_unit_id varchar(20),in v_unit_dataId int(11) ,inout resultMsg varchar(1000))
BEGIN
/*基金生成-分支存储过程 事业工资发放表fund_salary_pay_201607*/
DECLARE v_table VARCHAR(30);
SET v_table =  CONCAT('fund_salary_pay_',v_i_fund_month);/*处理分表存储*/

SET @sqlstr = CONCAT('DROP TABLE IF EXISTS ', v_table);
PREPARE stmt FROM @sqlstr;
EXECUTE stmt;

SET @sqlstr = CONCAT('CREATE TABLE ',v_table,' LIKE ', ' fund_salary_pay');
PREPARE stmt FROM @sqlstr;
EXECUTE stmt;

/*数据插入*/
/*
--t1.c02人员编号
--t1.c04人员姓名
--t1.c09学历
--t1.c28人员身份
--t1.c36实际职务/技术等级
--t1.c17工资对应职级
--t1.c27是否领导工资
--t2.c07工资级别
--t2.c09工资档次
--t2.c25职务/技术等级工资
--t2.c26级别岗位级别工资;
--t2.c28教师护士提高10%;
--t2.c29特殊教育提高15%;
--t2.c30保留特岗工资;
--t2.c44中小学教师保留10%工资;
--t2.c45保留护士提高10%工资;
--t2.c47平时训练奖;
--t2.c31基础绩效;
--t2.c27津补贴小计;
--t2.c32实发工资合计;
-- 0 工资补扣发;
--t2.c32+0实际应发工资合计
--(select name from sys_s_data where id=t1.c24)财政供养
--(select name from sys_s_data where id=t1.c22)财政统发
--(select c03 from t113 where id=t1.c15)部门
*/
SET @sqlstr = CONCAT('INSERT INTO ', v_table,'(fund_month,unit_id,unit_code,staff_id,name,
		eduLevel,standing,actual_workRank,workRank,isLeader,postSalRank,salRankLevel,grade_salary1,grade_salary2,grade_salary3,
		grade_salary4,grade_salary5,grade_salary6,grade_salary7,grade_salary8,grade_salary9,jbt_total_salary,actual_total_salary,salary_value,theory_total_salary,
		is_finSupt,is_salUniOut,department_name)
		select ',v_i_fund_month,',',v_unit_dataId,',\'',v_unit_id,'\',t1.c02,t1.c04,t1.c09,t1.c28,t1.c36,t1.c17,t1.c27,
				t2.c07,t2.c09,t2.c25,t2.c26,t2.c28,t2.c29,t2.c30,t2.c44,t2.c45,t2.c47,t2.c31,t2.c27,t2.c32,0,t2.c32+0,
(select name from sys_s_data where id=t1.c24),
(select name from sys_s_data where id=t1.c22),
(select c03 from t113 where id=t1.c15)
from data_record_t126 t1,data_record_t125 t2 
where 1=1 and t1.changeSign = t2.changeSign
	and t1.dataclassCode = "t126"
	and t2.dataclassCode = "t125"',
					' and t1.fund_month = ',v_i_fund_month,' and SUBSTR(t1.c02,1,9)=\'',v_unit_id,
					/*括号中的这些id为人员身份对应的id*/  
					'\' and t1.c28  
						in (select id FROM t136 where 1=1 and c06 = "10858")');
PREPARE stmt FROM @sqlstr;
EXECUTE stmt;	

		SET @sqlstr = CONCAT('update ', v_table,'set jbt_total_salary = round(jbt_total_salary,2),
	salary_value =round(salary_value,2),
	 actual_total_salary =round(actual_total_salary,2),
 theory_total_salary =round(theory_total_salary,2)
 where fund_month = ',v_i_fund_month,'  and unit_id =',v_unit_dataId );

	-- set resultMsg = concat('@sqlstr:',@sqlstr);leave label_pro;
		PREPARE stmt FROM @sqlstr;
		EXECUTE stmt;
		DROP PREPARE stmt;
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`p_all_fund`(in v_i_fund_month varchar(6),in v_unit_id varchar(50),
in v_unit_dataId int(11),inout resultMsg varchar(10000))
label_pro:BEGIN
/*基金生成-标记本次基金的变动数据(只能当月生成下个月的基金) data_data_record 变动记录表; --v_i_fund_month 基金月份传入参数;--v_unit_id 基金单位代码传入参数--v_unit_dataId 基金单位id*/
declare stemNum int(11);
declare stemParam varchar(20);
declare stemYearMonth varchar(20);

declare stemJcjbNum int(11) default 0;
declare stemJczqNum int(11) default 0;
declare stemJbjbtNum int(11) default 0;

 DECLARE t_error INTEGER DEFAULT 0;
  -- 1265截断 1005创建表失败 1021硬盘剩余空间不足 1022关键字重复 1032记录不存在 1036数据表只读 
 -- 1037系统内存不足 1038用于排除的内存不足 1040数据库已达最大连接 1048字段不能为空 1054字段不存在 1065 无效的sql
 -- 1129数据库出现异常请重启数据库 1141当前用户无权访问数据库 1149sql语法错误 1062字段值重复入库失败 1169字段值重复更新失败 
 -- 1203当前用户和数据库建立的连接已达最大连接数，请增大连接或重启数据库
 -- 1205加锁超时 0147资源不足无法执行该命令 0240已取消会话
  declare continue handler for 1265,1005,1021,1022,1032,1036,1037, 1038,1040,1048,1054,1065,1129,1141,1149,1062,1169,1203,1205,0147,0240 
	set t_error=1;
 DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET t_error=1;
	
	DELETE FROM fund_audit_record WHERE fund_month = concat(v_i_fund_month,'') and unit_id = concat(v_unit_dataId,'');
	INSERT INTO fund_audit_record(fund_month,unit_code,unit_id,fund_status,firstFlag,secondFlag,
			thirdFlag,forthFlag,fiveFlag,sixFlag,auditMsg) 
	VALUES(v_i_fund_month,v_unit_id,v_unit_dataId,'6','6','6','6','6','6','6','');
	-- 插入审核状态数据并初始化状态值-基金生成中...

	set resultMsg = '6';
	call p_fund_delete(v_i_fund_month,v_unit_id,v_unit_dataId,resultMsg);
	if resultMsg = '6' then set resultMsg = ''; end if;
	if ''!=resultMsg then 
		DELETE FROM fund_audit_record WHERE fund_month = concat(v_i_fund_month,'') and unit_id = concat(v_unit_dataId,'');
		leave label_pro; 
	end if;
 if t_error = 1 then 
		DELETE FROM fund_audit_record WHERE fund_month = concat(v_i_fund_month,'') and unit_id = concat(v_unit_dataId,'');
		set resultMsg = '清除旧的基金数据出错';
		leave label_pro; 
 end if;

	set @resultMsg = concat(@resultMsg,',p_fund_delete,t_error:',t_error);
	-- CALL p_fund_checkPerson (v_i_fund_month,v_unit_id,v_unit_dataId,resultMsg);/*检查所有人员是否存在学习/任职简历*/
	-- if ''!=resultMsg then leave label_pro; end if;
    -- 导数时先不考虑学习/任职简历
/*基金生成-调用各个分支存储过程 基金核定表 机关与事业分开*/
		-- set resultMsg = concat('p_fund_checkRecord:',v_i_fund_month,',',v_unit_id,',',v_unit_dataId);leave label_pro;
	CALL p_fund_checkRecord (v_i_fund_month,v_unit_id,v_unit_dataId,resultMsg);/*检查所有变动记录是否符合要求*/
	set @resultMsg = concat(@resultMsg,',p_fund_checkRecord,t_error:',t_error,',resultMsg:',resultMsg);
	if ''!=resultMsg then 
		DELETE FROM fund_audit_record WHERE fund_month = concat(v_i_fund_month,'') and unit_id = concat(v_unit_dataId,'');
		call p_fund_delete(v_i_fund_month,v_unit_id,v_unit_dataId,resultMsg); 
		leave label_pro; 
	end if;
	if t_error = 1 then 
		DELETE FROM fund_audit_record WHERE fund_month = concat(v_i_fund_month,'') and unit_id = concat(v_unit_dataId,'');
		set resultMsg = '检查变动记录出错';
		leave label_pro; 
	end if;

	-- 先调用补扣发生成
	-- set resultMsg = concat('p_fill_fund#',v_i_fund_month,',',v_unit_id,',',v_unit_dataId,',');leave label_pro;
	 CALL p_fill_fund (v_i_fund_month,v_unit_id,concat(v_unit_dataId,''),resultMsg);/*基金生成-基金补扣发详细*/
	if ''!=resultMsg then 
		DELETE FROM fund_audit_record WHERE fund_month = concat(v_i_fund_month,'') and unit_id = concat(v_unit_dataId,'');
		call p_fund_delete(v_i_fund_month,v_unit_id,v_unit_dataId,resultMsg); 
		leave label_pro; 
	end if;

	if t_error = 1 then 
		DELETE FROM fund_audit_record WHERE fund_month = concat(v_i_fund_month,'') and unit_id = concat(v_unit_dataId,'');
		call p_fund_delete(v_i_fund_month,v_unit_id,v_unit_dataId,resultMsg);
		set resultMsg = '计算补扣发失败';
		leave label_pro; 
	end if;
	set @resultMsg = concat(@resultMsg,',p_fill_fund,t_error:',t_error);
	
		/*
	if resultMsg then leave label_pro; end if;
	if ''!=resultMsg then leave label_pro; end if;
	update data_data_record set fund_month = v_i_fund_month, 
	perAuditFlag = '9',allAuditFlag = '9' where dataclassCode = 't126' 
	and c01 = v_unit_dataId and ifnull(allAuditFlag,'')!='2'
	and perAuditFlag!= '2';-- 先更新人员基本信息的变动记录

	update data_data_record a,data_data_record b set a.fund_month = b.fund_month,a.perAuditFlag = '9' ,a.allAuditFlag = '9'
	where a.changeSign = b.changeSign and b.dataclassCode = 't126' and b.perAuditFlag = '9' --  9-生成基金未上报
	and ifnull(a.allAuditFlag,'')!='2' and a.perAuditFlag!= '2';-- 再更新所有相同变动标志的  改在循环里面执行
	
	update data_data_record set fund_month = v_i_fund_month, 
	allAuditFlag = '9' where dataclassCode = 't126' 
	and c01 = v_unit_dataId and ifnull(allAuditFlag,'')!='2'
	and perAuditFlag= '2'
	;-- 先更新人员基本信息的变动记录-前置变动已经审核通过的allAuditFlag

	update data_data_record a,data_data_record b
	 set a.fund_month = b.fund_month,a.allAuditFlag = '9'
	where a.changeSign = b.changeSign and b.dataclassCode = 't126' 
	and a.perAuditFlag= '2' and ifnull(a.allAuditFlag,'')!='2'
	;-- 再更新所有相同变动标志的   前置变动已经审核通过的allAuditFlag
	*/
		
		update data_record_t126 a set fund_month = concat(v_i_fund_month,''), 
		allAuditFlag = '9' ,auditMsg = ''
		-- firstFlag= '9',secondFlag='9',thirdFlag='9',forthFlag='9',fiveFlag='9',sixFlag='9'
		 where -- dataclassCode = 't126'  
		c01 = concat(v_unit_dataId,'') and ifnull(allAuditFlag,'')!='2' 
		and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		;-- 更新人员基本信息的变动记录-的allAuditFlag
	
		update data_record_t125 a,data_record_t126 b
		 set a.fund_month = b.fund_month,a.allAuditFlag = '9' ,a.auditMsg = ''
		--  a.firstFlag= '9',a.secondFlag='9',a.thirdFlag='9',a.forthFlag='9',a.fiveFlag='9',a.sixFlag='9'
		where a.changeSign = b.changeSign --  and b.dataclassCode = 't126' 
		and b.c01 = concat(v_unit_dataId,'') 
		and not exists(select 1 from sys_s_data d where d.id = b.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		and b.allAuditFlag = '9';
	
		update data_record_t117 a,data_record_t126 b
		 set a.fund_month = b.fund_month,a.allAuditFlag = '9' ,a.auditMsg = ''
		--  a.firstFlag= '9',a.secondFlag='9',a.thirdFlag='9',a.forthFlag='9',a.fiveFlag='9',a.sixFlag='9'
		where a.changeSign = b.changeSign --  and b.dataclassCode = 't126' 
		and b.c01 = concat(v_unit_dataId,'') 
		and not exists(select 1 from sys_s_data d where d.id = b.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		and b.allAuditFlag = '9';
		-- 再更新所有相同变动标志的 的allAuditFlag
		
	/**
		update data_data_record a set fund_month = v_i_fund_month, 
		allAuditFlag = '9' 
		 where dataclassCode = 't126' 
		and c01 = v_unit_dataId and ifnull(allAuditFlag,'')!='2' and perAuditFlag = '2'
		and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		;-- 更新人员基本信息的变动记录-的allAuditFlag
	
		update data_data_record a,data_data_record b
		 set a.fund_month = b.fund_month,a.allAuditFlag = '9'
		where a.changeSign = b.changeSign and b.dataclassCode = 't126' 
		and b.c01 = v_unit_dataId and b.perAuditFlag = '2'
		and not exists(select 1 from sys_s_data d where d.id = b.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		and b.allAuditFlag = '9';
*/
		
-- update data_data_record set perAuditFlag = '9' where dataclassCode = 't126' and c01 = v_unit_dataId and ifnull(perAuditFlag,'')!='2' ;-- 9-生成基金未上报
	
	CALL p_2_fund (v_i_fund_month,v_unit_id,v_unit_dataId,resultMsg);/*基金生成-变动花名册(机关事业同一张表)*/
	if ''!=resultMsg then 
			DELETE FROM fund_audit_record WHERE fund_month = concat(v_i_fund_month,'') and unit_id = concat(v_unit_dataId,'');
		call p_fund_delete(v_i_fund_month,v_unit_id,v_unit_dataId,resultMsg); 
		leave label_pro; 
	end if;

	if t_error = 1 then 
		DELETE FROM fund_audit_record WHERE fund_month = concat(v_i_fund_month,'') and unit_id = concat(v_unit_dataId,'');
		call p_fund_delete(v_i_fund_month,v_unit_id,v_unit_dataId,resultMsg);
		set resultMsg = '生成基金变动花名册失败';
		leave label_pro; 
	end if;
	set @resultMsg = concat(@resultMsg,',p_2_fund,t_error:',t_error);
	CALL p_3_fund (v_i_fund_month,v_unit_id,v_unit_dataId,resultMsg);/*基金生成-工资,津补贴 发放表(机关事业同表)*/
	if ''!=resultMsg then 
			DELETE FROM fund_audit_record WHERE fund_month = concat(v_i_fund_month,'') and unit_id = concat(v_unit_dataId,'');
		call p_fund_delete(v_i_fund_month,v_unit_id,v_unit_dataId,resultMsg); 
		leave label_pro; 
	end if;

	if t_error = 1 then 
		DELETE FROM fund_audit_record WHERE fund_month = concat(v_i_fund_month,'') and unit_id = concat(v_unit_dataId,'');
		call p_fund_delete(v_i_fund_month,v_unit_id,v_unit_dataId,resultMsg);
		set resultMsg = '生成基金发放表失败';
		leave label_pro; 
	end if;
	set @resultMsg = concat(@resultMsg,',p_3_fund,t_error:',t_error);
	CALL p_1_fund (v_i_fund_month,v_unit_id,v_unit_dataId,resultMsg);/*基金生成-机关核定表*/
	if ''!=resultMsg then 
			DELETE FROM fund_audit_record WHERE fund_month = concat(v_i_fund_month,'') and unit_id = concat(v_unit_dataId,'');
		call p_fund_delete(v_i_fund_month,v_unit_id,v_unit_dataId,resultMsg); 
		leave label_pro; 
	end if;

	if t_error = 1 then 
		DELETE FROM fund_audit_record WHERE fund_month = concat(v_i_fund_month,'') and unit_id = concat(v_unit_dataId,'');
		call p_fund_delete(v_i_fund_month,v_unit_id,v_unit_dataId,resultMsg);
		set resultMsg = '生成机关核定表失败';
		leave label_pro; 
	end if;
	set @resultMsg = concat(@resultMsg,',p_1_fund,t_error:',t_error);
	CALL p_4_fund (v_i_fund_month,v_unit_id,v_unit_dataId,resultMsg);/*基金生成-事业核定表*/
	if ''!=resultMsg then 
			DELETE FROM fund_audit_record WHERE fund_month = concat(v_i_fund_month,'') and unit_id = concat(v_unit_dataId,'');
		call p_fund_delete(v_i_fund_month,v_unit_id,v_unit_dataId,resultMsg); 
		leave label_pro; 
	end if;

	if t_error = 1 then 
		DELETE FROM fund_audit_record WHERE fund_month = concat(v_i_fund_month,'') and unit_id = concat(v_unit_dataId,'');
		call p_fund_delete(v_i_fund_month,v_unit_id,v_unit_dataId,resultMsg);
		set resultMsg = '生成事业核定表失败';
		leave label_pro; 
	end if;
	set @resultMsg = concat(@resultMsg,',p_4_fund,t_error:',t_error);
/*TODO*/
	
/*fund_audit_record基金审核表处理*/
/*数据清理 fund_audit_record基金审核表 */
	-- DELETE FROM fund_audit_record WHERE fund_month = v_i_fund_month and unit_id = v_unit_dataId;
/*数据插入 
--fund_month基金月份
--unit_id单位代码
--fund_status  基金状态 0未上报/1待审核/2通过/3未通过
--firstFlag 1审核人审核状态 0未上报/1已上报/2通过/3未通过
--secondFlag 2审核人审核状态 0未上报/1已上报/2通过/3未通过
--thirdFlag 3审核人审核状态 0未上报/1已上报/2通过/3未通过
--forthFlag 4审核人审核状态 0未上报/1已上报/2通过/3未通过
--fiveFlag 5审核人审核状态 0未上报/1已上报/2通过/3未通过
--sixFlag 6审核人审核状态 0未上报/1已上报/2通过/3未通过
--auditMsg 审核意见
*/
	update fund_audit_record set fund_status = 9,secondFlag=9,firstFlag = 9,thirdFlag=9,forthFlag=9,fiveFlag=9,sixFlag=9
		where fund_month = concat(v_i_fund_month,'')
		and unit_id = concat(v_unit_dataId,'');
	set @permonth = DATE_FORMAT(DATE_ADD(concat(v_i_fund_month,'01'),INTERVAL -2 MONTH),'%Y%m');

	delete from record_fill_tail where unit_id = v_unit_dataId;
	delete from record_fill_subsidies  where fund_month = v_i_fund_month and exists(select 1 from data_record_t126 t126 where t126.c01 = v_unit_dataId and  t126.dataid = staff_id and 
		t126.fund_month = v_i_fund_month );
		
		
IF t_error = 1 THEN
	DELETE FROM fund_audit_record WHERE fund_month = concat(v_i_fund_month,'') and unit_id = concat(v_unit_dataId,'');
	call p_fund_delete(v_i_fund_month,v_unit_id,v_unit_dataId,resultMsg);
	set resultMsg = '数据异常';
	set resultMsg = concat(resultMsg,':',@resultMsg);
ELSE
	commit;
END IF;
 update fund_audit_record set endTime = now() where unit_id =CONCAT(v_unit_dataId ,'') and fund_month =v_i_fund_month ;
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`p_all_fundCopy`(in v_i_fund_month varchar(6),in v_unit_id varchar(50),
in v_unit_dataId int(11),inout resultMsg varchar(10000))
label_pro:BEGIN
/*基金生成-标记本次基金的变动数据(只能当月生成下个月的基金) data_data_record 变动记录表; --v_i_fund_month 基金月份传入参数;--v_unit_id 基金单位代码传入参数--v_unit_dataId 基金单位id*/
declare stemNum int(11);
declare stemParam varchar(20);
declare stemYearMonth varchar(20);

declare stemJcjbNum int(11) default 0;
declare stemJczqNum int(11) default 0;
declare stemJbjbtNum int(11) default 0;

 DECLARE t_error INTEGER DEFAULT 0;
-- DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET t_error=1;
	
	DELETE FROM fund_audit_record WHERE fund_month = concat(v_i_fund_month,'') and unit_id = concat(v_unit_dataId,'');
	INSERT INTO fund_audit_record(fund_month,unit_code,unit_id,fund_status,firstFlag,secondFlag,
			thirdFlag,forthFlag,fiveFlag,sixFlag,auditMsg) 
	VALUES(v_i_fund_month,v_unit_id,v_unit_dataId,'6','6','6','6','6','6','6','');
	-- 插入审核状态数据并初始化状态值-基金生成中...

	set resultMsg = '6';
	call p_fund_delete(v_i_fund_month,v_unit_id,v_unit_dataId,resultMsg);
	if resultMsg = '6' then set resultMsg = ''; end if;
	if ''!=resultMsg then 
		DELETE FROM fund_audit_record WHERE fund_month = concat(v_i_fund_month,'') and unit_id = concat(v_unit_dataId,'');
		leave label_pro; 
	end if;
 if t_error = 1 then 
		DELETE FROM fund_audit_record WHERE fund_month = concat(v_i_fund_month,'') and unit_id = concat(v_unit_dataId,'');
		set resultMsg = '清除旧的基金数据出错';
		leave label_pro; 
 end if;

	set @resultMsg = concat(@resultMsg,',p_fund_delete,t_error:',t_error);
	-- CALL p_fund_checkPerson (v_i_fund_month,v_unit_id,v_unit_dataId,resultMsg);/*检查所有人员是否存在学习/任职简历*/
	-- if ''!=resultMsg then leave label_pro; end if;
    -- 导数时先不考虑学习/任职简历
/*基金生成-调用各个分支存储过程 基金核定表 机关与事业分开*/
		-- set resultMsg = concat('p_fund_checkRecord:',v_i_fund_month,',',v_unit_id,',',v_unit_dataId);leave label_pro;
	CALL p_fund_checkRecord (v_i_fund_month,v_unit_id,v_unit_dataId,resultMsg);/*检查所有变动记录是否符合要求*/
	set @resultMsg = concat(@resultMsg,',p_fund_checkRecord,t_error:',t_error,',resultMsg:',resultMsg);
	if ''!=resultMsg then 
		DELETE FROM fund_audit_record WHERE fund_month = concat(v_i_fund_month,'') and unit_id = concat(v_unit_dataId,'');
		call p_fund_delete(v_i_fund_month,v_unit_id,v_unit_dataId,resultMsg); 
		leave label_pro; 
	end if;
	if t_error = 1 then 
		DELETE FROM fund_audit_record WHERE fund_month = concat(v_i_fund_month,'') and unit_id = concat(v_unit_dataId,'');
		set resultMsg = '检查变动记录出错';
		leave label_pro; 
	end if;

	-- 先调用补扣发生成
	-- set resultMsg = concat('p_fill_fund#',v_i_fund_month,',',v_unit_id,',',v_unit_dataId,',');leave label_pro;
	 CALL p_fill_fund (v_i_fund_month,v_unit_id,concat(v_unit_dataId,''),resultMsg);/*基金生成-基金补扣发详细*/
	if ''!=resultMsg then 
		DELETE FROM fund_audit_record WHERE fund_month = concat(v_i_fund_month,'') and unit_id = concat(v_unit_dataId,'');
		call p_fund_delete(v_i_fund_month,v_unit_id,v_unit_dataId,resultMsg); 
		leave label_pro; 
	end if;

	if t_error = 1 then 
		DELETE FROM fund_audit_record WHERE fund_month = concat(v_i_fund_month,'') and unit_id = concat(v_unit_dataId,'');
		call p_fund_delete(v_i_fund_month,v_unit_id,v_unit_dataId,resultMsg);
		set resultMsg = '计算补扣发失败';
		leave label_pro; 
	end if;
	set @resultMsg = concat(@resultMsg,',p_fill_fund,t_error:',t_error);
	
		/*
	if resultMsg then leave label_pro; end if;
	if ''!=resultMsg then leave label_pro; end if;
	update data_data_record set fund_month = v_i_fund_month, 
	perAuditFlag = '9',allAuditFlag = '9' where dataclassCode = 't126' 
	and c01 = v_unit_dataId and ifnull(allAuditFlag,'')!='2'
	and perAuditFlag!= '2';-- 先更新人员基本信息的变动记录

	update data_data_record a,data_data_record b set a.fund_month = b.fund_month,a.perAuditFlag = '9' ,a.allAuditFlag = '9'
	where a.changeSign = b.changeSign and b.dataclassCode = 't126' and b.perAuditFlag = '9' --  9-生成基金未上报
	and ifnull(a.allAuditFlag,'')!='2' and a.perAuditFlag!= '2';-- 再更新所有相同变动标志的  改在循环里面执行
	
	update data_data_record set fund_month = v_i_fund_month, 
	allAuditFlag = '9' where dataclassCode = 't126' 
	and c01 = v_unit_dataId and ifnull(allAuditFlag,'')!='2'
	and perAuditFlag= '2'
	;-- 先更新人员基本信息的变动记录-前置变动已经审核通过的allAuditFlag

	update data_data_record a,data_data_record b
	 set a.fund_month = b.fund_month,a.allAuditFlag = '9'
	where a.changeSign = b.changeSign and b.dataclassCode = 't126' 
	and a.perAuditFlag= '2' and ifnull(a.allAuditFlag,'')!='2'
	;-- 再更新所有相同变动标志的   前置变动已经审核通过的allAuditFlag
	*/
		
		update data_record_t126 a set fund_month = concat(v_i_fund_month,''), 
		allAuditFlag = '9' 
		-- firstFlag= '9',secondFlag='9',thirdFlag='9',forthFlag='9',fiveFlag='9',sixFlag='9'
		 where -- dataclassCode = 't126'  
		c01 = concat(v_unit_dataId,'') and ifnull(allAuditFlag,'')!='2' 
		and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		;-- 更新人员基本信息的变动记录-的allAuditFlag
	
		update data_record_t125 a,data_record_t126 b
		 set a.fund_month = b.fund_month,a.allAuditFlag = '9' 
		--  a.firstFlag= '9',a.secondFlag='9',a.thirdFlag='9',a.forthFlag='9',a.fiveFlag='9',a.sixFlag='9'
		where a.changeSign = b.changeSign --  and b.dataclassCode = 't126' 
		and b.c01 = concat(v_unit_dataId,'') 
		and not exists(select 1 from sys_s_data d where d.id = b.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		and b.allAuditFlag = '9';
	
		update data_record_t117 a,data_record_t126 b
		 set a.fund_month = b.fund_month,a.allAuditFlag = '9' 
		--  a.firstFlag= '9',a.secondFlag='9',a.thirdFlag='9',a.forthFlag='9',a.fiveFlag='9',a.sixFlag='9'
		where a.changeSign = b.changeSign --  and b.dataclassCode = 't126' 
		and b.c01 = concat(v_unit_dataId,'') 
		and not exists(select 1 from sys_s_data d where d.id = b.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		and b.allAuditFlag = '9';
		-- 再更新所有相同变动标志的 的allAuditFlag
		
	/**
		update data_data_record a set fund_month = v_i_fund_month, 
		allAuditFlag = '9' 
		 where dataclassCode = 't126' 
		and c01 = v_unit_dataId and ifnull(allAuditFlag,'')!='2' and perAuditFlag = '2'
		and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		;-- 更新人员基本信息的变动记录-的allAuditFlag
	
		update data_data_record a,data_data_record b
		 set a.fund_month = b.fund_month,a.allAuditFlag = '9'
		where a.changeSign = b.changeSign and b.dataclassCode = 't126' 
		and b.c01 = v_unit_dataId and b.perAuditFlag = '2'
		and not exists(select 1 from sys_s_data d where d.id = b.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		and b.allAuditFlag = '9';
*/
		
-- update data_data_record set perAuditFlag = '9' where dataclassCode = 't126' and c01 = v_unit_dataId and ifnull(perAuditFlag,'')!='2' ;-- 9-生成基金未上报
	
	CALL p_2_fund (v_i_fund_month,v_unit_id,v_unit_dataId,resultMsg);/*基金生成-变动花名册(机关事业同一张表)*/
	if ''!=resultMsg then 
			DELETE FROM fund_audit_record WHERE fund_month = concat(v_i_fund_month,'') and unit_id = concat(v_unit_dataId,'');
		call p_fund_delete(v_i_fund_month,v_unit_id,v_unit_dataId,resultMsg); 
		leave label_pro; 
	end if;

	if t_error = 1 then 
		DELETE FROM fund_audit_record WHERE fund_month = concat(v_i_fund_month,'') and unit_id = concat(v_unit_dataId,'');
		call p_fund_delete(v_i_fund_month,v_unit_id,v_unit_dataId,resultMsg);
		set resultMsg = '生成基金变动花名册失败';
		leave label_pro; 
	end if;
	set @resultMsg = concat(@resultMsg,',p_2_fund,t_error:',t_error);
	CALL p_3_fund (v_i_fund_month,v_unit_id,v_unit_dataId,resultMsg);/*基金生成-工资,津补贴 发放表(机关事业同表)*/
	if ''!=resultMsg then 
			DELETE FROM fund_audit_record WHERE fund_month = concat(v_i_fund_month,'') and unit_id = concat(v_unit_dataId,'');
		call p_fund_delete(v_i_fund_month,v_unit_id,v_unit_dataId,resultMsg); 
		leave label_pro; 
	end if;

	if t_error = 1 then 
		DELETE FROM fund_audit_record WHERE fund_month = concat(v_i_fund_month,'') and unit_id = concat(v_unit_dataId,'');
		call p_fund_delete(v_i_fund_month,v_unit_id,v_unit_dataId,resultMsg);
		set resultMsg = '生成基金发放表失败';
		leave label_pro; 
	end if;
	set @resultMsg = concat(@resultMsg,',p_3_fund,t_error:',t_error);
	CALL p_1_fund (v_i_fund_month,v_unit_id,v_unit_dataId,resultMsg);/*基金生成-机关核定表*/
	if ''!=resultMsg then 
			DELETE FROM fund_audit_record WHERE fund_month = concat(v_i_fund_month,'') and unit_id = concat(v_unit_dataId,'');
		call p_fund_delete(v_i_fund_month,v_unit_id,v_unit_dataId,resultMsg); 
		leave label_pro; 
	end if;

	if t_error = 1 then 
		DELETE FROM fund_audit_record WHERE fund_month = concat(v_i_fund_month,'') and unit_id = concat(v_unit_dataId,'');
		call p_fund_delete(v_i_fund_month,v_unit_id,v_unit_dataId,resultMsg);
		set resultMsg = '生成机关核定表失败';
		leave label_pro; 
	end if;
	set @resultMsg = concat(@resultMsg,',p_1_fund,t_error:',t_error);
	CALL p_4_fund (v_i_fund_month,v_unit_id,v_unit_dataId,resultMsg);/*基金生成-事业核定表*/
	if ''!=resultMsg then 
			DELETE FROM fund_audit_record WHERE fund_month = concat(v_i_fund_month,'') and unit_id = concat(v_unit_dataId,'');
		call p_fund_delete(v_i_fund_month,v_unit_id,v_unit_dataId,resultMsg); 
		leave label_pro; 
	end if;

	if t_error = 1 then 
		DELETE FROM fund_audit_record WHERE fund_month = concat(v_i_fund_month,'') and unit_id = concat(v_unit_dataId,'');
		call p_fund_delete(v_i_fund_month,v_unit_id,v_unit_dataId,resultMsg);
		set resultMsg = '生成事业核定表失败';
		leave label_pro; 
	end if;
	set @resultMsg = concat(@resultMsg,',p_4_fund,t_error:',t_error);
/*TODO*/
	
/*fund_audit_record基金审核表处理*/
/*数据清理 fund_audit_record基金审核表 */
	-- DELETE FROM fund_audit_record WHERE fund_month = v_i_fund_month and unit_id = v_unit_dataId;
/*数据插入 
--fund_month基金月份
--unit_id单位代码
--fund_status  基金状态 0未上报/1待审核/2通过/3未通过
--firstFlag 1审核人审核状态 0未上报/1已上报/2通过/3未通过
--secondFlag 2审核人审核状态 0未上报/1已上报/2通过/3未通过
--thirdFlag 3审核人审核状态 0未上报/1已上报/2通过/3未通过
--forthFlag 4审核人审核状态 0未上报/1已上报/2通过/3未通过
--fiveFlag 5审核人审核状态 0未上报/1已上报/2通过/3未通过
--sixFlag 6审核人审核状态 0未上报/1已上报/2通过/3未通过
--auditMsg 审核意见
*/
	update fund_audit_record set fund_status = 9,secondFlag=9,firstFlag = 9,thirdFlag=9,forthFlag=9,fiveFlag=9,sixFlag=9
		where fund_month = concat(v_i_fund_month,'')
		and unit_id = concat(v_unit_dataId,'');
	set @permonth = DATE_FORMAT(DATE_ADD(concat(v_i_fund_month,'01'),INTERVAL -2 MONTH),'%Y%m');

	delete from record_fill_tail where unit_id = v_unit_dataId;
	delete from record_fill_subsidies  where fund_month = v_i_fund_month and exists(select 1 from data_record_t126 t126 where t126.c01 = v_unit_dataId and  t126.dataid = staff_id and 
		t126.fund_month = v_i_fund_month );
		
		
IF t_error = 1 THEN
	DELETE FROM fund_audit_record WHERE fund_month = concat(v_i_fund_month,'') and unit_id = concat(v_unit_dataId,'');
	call p_fund_delete(v_i_fund_month,v_unit_id,v_unit_dataId,resultMsg);
	set resultMsg = '数据异常';
	set resultMsg = concat(resultMsg,':',@resultMsg);
ELSE
	commit;
END IF;
 update fund_audit_record set endTime = now() where unit_id =CONCAT(v_unit_dataId ,'') and fund_month =v_i_fund_month ;
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`p_assess_all`(IN unitId int(11),IN createrId int(11),IN dataclassCode varchar(200),
	IN c01 varchar(400),
	IN c02 VARCHAR(400),IN c03 VARCHAR(400),
	IN c04 VARCHAR(400),IN c05 varchar(400),
	IN c06 varchar(400),IN c07 varchar(400),
	INOUT resultMsg varchar(10000) CHARSET utf8)
label_pro:BEGIN	
/**
年度考核批量删除/添加 
*********************温馨提示：这个存储过程使用的参数名和表的字段名重复  所以查询是时候要小心************
*********************另外：可以不使用预处理语句，给查询条件加表名即可 如：select * from data_data_record as dd wehre  dd.dataclassCode=...and dd.c02=...
call produceAll(183,3,'t124',2017,114,null,null,10483,null,1,@re);

 call p_assess_all(3,183,'t124',2017,114,null,null,10483,null,1,@resultMsg);


*/

	DECLARE orgId int(11);-- -- 单位id
	DECLARE unit int(11);-- -- 功能id
	DECLARE creater int(11);-- -- 临时变量
	DECLARE stemNum int(11) default 0;-- -- 临时变量
	DECLARE khnd varchar(20);-- -- 考核 年度
	DECLARE khjg varchar(20);-- -- 考核结果
	DECLARE person_id varchar(20);-- -- 人员编号

	DECLARE done INT DEFAULT FALSE; -- 自定义控制游标循环变量,默认false  


	DECLARE My_Cursor CURSOR FOR (
	select dd.dataId  from data_record_t125 as dd where dd.c05=concat(c02,'') and  dd.changetype ='11326' 
	);


 -- 定义游标并输入结果集  
	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE; -- 绑定控制变量到游标,游标循环结束自动转true  


set @fail = '';

set creater = createrId;
	set unit = unitId;
	if ''!=c02 then 
		select count(1) into stemNum from t111 where id = c02;
	else
		set resultMsg = '单位id传输错误';leave label_pro;
	end if;
	
	if stemNum = 0 then
		set resultMsg = '单位id不存在';leave label_pro; 
	end if;
	set orgId = c02;
	
	if ''!=c01 then 
		set khnd = c01;-- 此句无暂时不处理
	else
		set resultMsg = '考核年度传输错误';leave label_pro;
	end if;
	if c07 = '1' then
	-- 添加
		if ''!=c05 then 
			set khjg = c05;
			set @sqlstr = concat('delete from t124 where c02 = \'',orgId,'\' and c01 = ',khnd,' and not exists(select 1 from 
				sys_s_data s,data_record_t125 t125 where  t124.c03 = t125.c06 AND s.id = t125.changeType
				AND t125.c05 = \'',orgId,'\' AND s.data_value IN (10, 11, 12, 13, 14, 30, 101, 111, 121, 131, 141, 301) AND (t125.c08 > ',khnd,' OR t125.c10 > ',khnd,'))');
			PREPARE stmt FROM @sqlstr;
			EXECUTE stmt;
			DROP PREPARE stmt;
			
			set @sqlstr = concat('insert into t124 (c03,dataclassCode,createrId,createDate,updateDate,unitId,
 				c01,c02,c04,c05 )
 			-- 考核年度 单位代码 人员编号  人员姓名 考核结果
			select DISTINCT t126.id,\'t124\',',creater,',sysdate(),sysdate(),',unit,',
				',khnd,',t126.c01,t126.id,',khjg,'
 			-- 考核年度 单位代码 人员编号  人员姓名 考核结果
				from t126 where t126.c01 = \'',orgId,'\'  -- and t124.c03 = concat(t126.id,\'\') 
				and exists(select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = \'1\')
				and t126.c40!=10831 -- 非人员减少
				and not exists(select 1 from 
				sys_s_data s,data_record_t125 t125 where   t125.c06 = concat(t126.id,\'\') AND s.id = t125.changeType
				AND t125.c05 = \'',orgId,'\' AND s.data_value IN (10, 11, 12, 13, 14, 30, 101, 111, 121, 131, 141, 301) AND (t125.c08 > ',khnd,' OR t125.c10 > ',khnd,'))
				and not exists(select 1 from t124 ,t126 a where t124.c03=concat(a.id,\'\') and a.c01 = \'',orgId,'\'
				and t124.c01 = ',khnd,' and t124.c02!=\'',orgId,'\' and t126.id = a.id) and ifnull(SUBSTR(t126.c12 from 1 for 4 ),',khnd+1,')<=',khnd,'
				');
			PREPARE stmt FROM @sqlstr;
			EXECUTE stmt;
			DROP PREPARE stmt;
			
			select GROUP_CONCAT(t126.c02,'|',t126.c04 ) into @ortherOrgIn from t124,t126 where t126.c01 = concat(orgId,'')	
				 and t124.c03=concat(t126.id,'') and t124.c02!=concat(orgId,'')	and t124.c01 = khnd;
			
			
			-- 因晋升变动不能添加
			/*set @sqlstr = concat('
				delete t124 from t124,t126 where t124.c03 = concat(t126.id,\'\') and t126.c01 = \'',orgId,'\' 
				and t124.c03 in (select c03 from (
				select c03 from (
				select count(1) aa,t124.c03,t124.c01 from t124,t126 where t124.c03 = concat(t126.id,\'\') and t126.c01 = \'',orgId,'\' group by c03,c01 
				HAVING aa>1 ) a
				)a) and t124.c01 = ',khnd,'  and t124.c02 = \'',orgId,'\'');
			PREPARE stmt FROM @sqlstr;
			EXECUTE stmt;
			DROP PREPARE stmt;*/
			



			set @sqlstr = concat('select GROUP_CONCAT(t126.c02,\'','|','\',t126.c04 ) into @temp 
 			-- 考核年度 单位代码 人员编号  人员姓名 考核结果
				from t126 where t126.c01 = \'',orgId,'\'  -- and t124.c03 = concat(t126.id,\'\') 
				and exists(select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = \'1\')
				and t126.c40!=10831 -- 非人员减少
				and  exists(select 1 from 
				sys_s_data s,data_record_t125 t125 where   t125.c06 = concat(t126.id,\'\') AND s.id = t125.changeType
				AND t125.c05 = \'',orgId,'\' AND s.data_value IN (10, 11, 12, 13, 14, 30, 101, 111, 121, 131, 141, 301) AND (t125.c08 > ',khnd,' OR t125.c10 > ',khnd,'))
				');
			PREPARE stmt FROM @sqlstr;
			EXECUTE stmt;
			DROP PREPARE stmt;
			
			set @fail = concat('jsbd:',ifnull(@temp,''));
			set @fail = concat(@fail,'drry:',ifnull(@ortherOrgIn,'')); -- 调入人员
			
-- 计发病假在做年度考核时超过六个月的 当年年度考核不能称职及以上  
			set resultMsg ='resultMsg';
			set resultMsg =concat(resultMsg,ifnull(@temp,''),ifnull(@ortherOrgIn,''));
			set @temp = 'jfbj:';
			if khjg<=10483 then
			
			OPEN My_Cursor; -- 打开游标  
			  myLoop: LOOP -- 开始循环体,myLoop为自定义循环名,结束循环时用到  
			    FETCH My_Cursor into person_id; 
			    IF done THEN -- 判断是否继续循环  
			      LEAVE myLoop; -- 结束循环  
			    END IF;  
						set @count=0;
						set @end_month='';
						set @start_month='';
						set @person_name ='';
						
						/*set @sqlstr = concat('select c02 into @start_month from data_data_record where dataclasscode =\'t125\' and c05 =114  and dataId =',person_id,'  and changetype =\'11326\'');
						PREPARE stmt FROM @sqlstr;
						EXECUTE stmt;	
						DROP PREPARE stmt;*/
						select count(dd.id) into @countt from data_record_t125 as dd where dd.dataclasscode ='t125' and dd.c05 =concat(orgId,'')  and dd.dataId =person_id  and dd.changetype ='11326';
						
					-- select count(*) into @countt from data_data_record,t125 where data_data_record.dataclassCode ='t125' and data_data_record.dataId = t125.id and t125.c06 =person_id 
						-- and data_data_record.changeType ='11326' order by data_data_record.c02 desc limit 1; -- 计发病假工资起始月份
				
							if @countt >0 then 
							select dd.c02 into @start_month from data_record_t125 as dd where -- dd.dataclasscode ='t125' and 
							dd.c05 =concat(orgId,'')  and dd.dataId =person_id  and dd.changetype ='11326' order by id desc limit 1;
			
							set @sqlstr = concat('select t126.c04,t126.id into @person_name,@person126Id from t126 , t125  where t126.id = t125.c06 and t125.id = ',person_id);
							PREPARE stmt FROM @sqlstr;
							EXECUTE stmt;
							DROP PREPARE stmt;
			
			
							 select SUBSTRING(curdate() FROM 1 FOR 7) into @end_month;
							-- select count(1) into @countt from  data_data_record as dd where dd.dataclasscode ='t125' and  dd.c05 =orgId  and dd.dataId = person_id  and dd.changetype ='10654' ;
							select count(dd.id) into @countt from  data_record_t125 as dd where --  dd.dataclasscode ='t125' and  
							dd.c05 =concat(orgId,'')  and dd.dataId = person_id  and dd.changetype ='10654' order by id desc limit 1 ;
								
							if @countt >0 then 
								-- select c02 into @end_month  from  data_data_record as dd where dd.dataclasscode ='t125' and  dd.c05 =orgId and dd.dataId = person_id   and dd.changetype ='10654' ;
								-- select data_data_record.c02 into @end_month from data_data_record,t125 where data_data_record.dataclassCode ='t125' and data_data_record.dataId = t125.id and t125.c06 =person_id
								-- and data_data_record.changeType ='10654' order by data_data_record.c02 desc limit 1;
								select dd.c02 into @end_month from  data_record_t125 as dd where --  dd.dataclasscode ='t125' and  
								dd.c05 =concat(orgId,'')  and dd.dataId = person_id  and dd.changetype ='10654' order by id desc limit 1 ;
							end if;
						
							
							if SUBSTRING(@start_month  FROM 1 FOR 4) = SUBSTRING(@end_month  FROM 1 FOR 4) and   SUBSTRING(@end_month  FROM 1 FOR 4) = khnd then 
									if (SUBSTRING(@end_month FROM 6 FOR 7) - SUBSTRING(@start_month FROM 6 FOR 7))>6 THEN
											delete from t124 where t124.c03 =concat(@person126Id,'') and t124.c01 =khnd;
											select concat(t126.c02,'|',t126.c04) into  @codeAndName from t126 where id = @person126Id;
											set @temp = concat( @temp,@codeAndName );
											set resultMsg =concat( resultMsg,';',@person_name);
			
									end if;
							end if;
						
							if SUBSTRING(@start_month  FROM 1 FOR 4) < SUBSTRING(@end_month  FROM 1 FOR 4) and   SUBSTRING(@start_month  FROM 1 FOR 4) = khnd then 
									if (13 - SUBSTRING(@start_month FROM 6 FOR 7))>6 THEN
											delete from t124 where t124.c03 =concat(@person126Id,'') and t124.c01 =khnd;
											select concat(t126.c02,'|',t126.c04) into  @codeAndName from t126 where id = @person126Id;
											set @temp = concat( @temp,@codeAndName );
											set resultMsg =concat( resultMsg,';',@person_name);
			
									end if;
							end if;
						end if;
							
			    COMMIT; -- 提交事务  
	
			  END LOOP myLoop; -- 结束自定义循环体  
			  CLOSE My_Cursor; -- 关闭游标  
			end if;
			set @fail = concat(@fail,@temp);
			insert into temp_multi values(orgId,'年度考核',sysdate(),@fail);
			if resultMsg = 'resultMsg' then 
				set resultMsg = '';
			end if;


		else
			set resultMsg = '考核结果传输错误';leave label_pro;
		end if;

	else 
		if c07 = '0' then
		-- 删除
			-- 先删除当前单位当年的全部考核记录
			set @sqlstr = concat('delete from t124 where c02 = \'',orgId,'\' and c01 = ',khnd,' and not exists(select 1 from 
				sys_s_data s,data_record_t125 t125 where  t124.c03 = t125.c06 AND s.id = t125.changeType
				AND t125.c05 = \'',orgId,'\' AND s.data_value IN (10, 11, 12, 13, 14, 30, 101, 111, 121, 131, 141, 301) AND (t125.c08 > ',khnd,' OR t125.c10 > ',khnd,'))');
			PREPARE stmt FROM @sqlstr;
			EXECUTE stmt;
			DROP PREPARE stmt;
		else
			set resultMsg = '传入添加/删除参数不正确';leave label_pro; 
		end if; 
	end if;
		
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`p_count_gznx`(in v_unit_dataId int(11),inout resultMsg varchar(1000))
label_pro:BEGIN	
/*单位人员工作年限重新计算过程
	并且
	统一修改对应的关联型 
	部门-t126.c15(人员所在单位的部门)/人员身份-t126.c28(单位工资制度+人员工资制度联合获取)/
	执行工资标准-t126.c39(单位工资制度+人员工资制度联合获取)/工资对应职级-t126.c17(根据实际职级获取)/是否领导-t126.c27(根据新的工资对应职级获取)/
	姓名-t125.c33(根据人员编号-c06获取)/级别-t125.c07(根据工资制度,工资标准获取)/档次-t125.c09(根据根据工资制度,工资标准获取或新的级别获取)/ 匹配项
	变动记录统一初始化为通过,并生成发放表

   -- 2017-01-06
	人员身份-t126.c28改成码表  不用重新查询更新
	执行工资标准-t126.c39改成 工资标准类别  码表 也不用重新查询更新
	工资对应职级-t126.c17(根据实际职级获取)/是否领导-t126.c27(根据新的工资对应职级获取)/
	级别-t125.c07(工资标准类别获取)
	档次-t125.c09(工资标准类别获取或新的级别获取)/ 匹配项
*/
	DECLARE stemIndex int(11) default 0;-- 参数变量
	DECLARE stemNum int(11);-- 参数变量
	DECLARE stemPersonId int(11);-- 人员id参数
	DECLARE stempParam varchar(20);-- 参数变量
	DECLARE stempMonth varchar(20);-- 参数变量
	DECLARE stemParam varchar(20);-- 参数变量

	DECLARE cjgzsj varchar(20);-- 参加工作时间 y-m-d
	DECLARE qxsj varchar(20);-- 起薪时间 y-m
	DECLARE kjssjY varchar(20);-- 可计算时间-年
	DECLARE kjssjM varchar(20);-- 可计算时间-月
	DECLARE jdsjY varchar(20);-- 间断时间-年
	DECLARE jdsjM varchar(20);-- 间断时间-月

	DECLARE sjzj varchar(50); -- 实际职级
	DECLARE rygzzd varchar(50); -- 人员工资制度
	DECLARE dwgzzd varchar(50); -- 单位工资制度


	DECLARE bm varchar(50); -- 部门
	DECLARE sf varchar(50); -- 人员身份
	DECLARE zxgzbz varchar(50); -- 执行工资标准
	DECLARE gzdyzj varchar(50); -- 工资对应职级
	DECLARE sfld varchar(50); -- 是否领导
	DECLARE jb varchar(50); -- 级别
	DECLARE dc varchar(50); -- 档次
	DECLARE newSalaryDate varchar(50); -- 新工资标准时间

  DECLARE done INT DEFAULT FALSE;
	-- 所有当前单位下面的人员id
	DECLARE person_ CURSOR FOR
   SELECT t126.id from  t126,t125
		where 1=1 and t126.dataclassCode = 't126'
		and t126.c01 = concat(v_unit_dataId,'') and t126.id = t125.c06 -- 人员工资表的c06人员编号 关联型
	  and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1');-- t126.c03 人员状态-码表 1-在职
 	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
 	
 SELECT count(1) into @count from  t126,t125
		where 1=1 and t126.dataclassCode = 't126'
		and t126.c01 = concat(v_unit_dataId,'') and t126.id = t125.c06 -- 人员工资表的c06人员编号 关联型
	  and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1');-- t126.c03 人员状态-码表 1-在职
 
 select ifnull(content,'2014-10-01') into newSalaryDate from sys_s_config where enname = 'SALARY_UPDATE_DATE';-- 新工资标准时间
 
 
 	-- 更新工资信息表 起薪时间 工资标准时间 对应的变动记录表也进行更新
	update t125 set c02 = '2017-01' where c05 = concat(v_unit_dataId,'');
	update data_record_t125 t125 set c02 = '2017-01' where t125.dataclassCode = 't125' and c05 = concat(v_unit_dataId,'');
	
	-- update t125 set c49 = '2016-07-01' ,c38 = '' where c05 = v_unit_dataId and ifnull(c49,'')='' ;
	-- update data_data_record set c49 = '2016-07-01' ,c38 = '' where dataclassCode = 't125' and c05 = v_unit_dataId and ifnull(c49,'')='';
 
 	/**
 	-- 更新所在单位的人员编号自动生成
 	select c01 into @dataCode from t111 where id = v_unit_dataId limit 0,1;
	select replace(c02,@dataCode,'')  into @dataAuto from t126 where c01 = v_unit_dataId order by c02 desc limit 0,1;
 	set @dataAuto = @dataAuto + 0;
 	select count(1) into @autoNum from data_auto_record where dataclassCode = 't126' and dataitemCode = 'c02' 
 	and autoHead = @dataCode and autoEndLength = 5 ;
 	if @autoNum > 0 then 
 		update data_auto_record set autoEnd = @dataAuto where dataclassCode = 't126' and dataitemCode = 'c02' 
 		and autoHead = @dataCode and autoEndLength = 5 ;
 	else 
 		insert into data_auto_record(dataclassCode,dataitemCode,autoHead,autoEndLength,autoEnd,createDate,updateDate)
 		values('t126','c02',@dataCode,5,@dataAuto,sysdate(),sysDate());	
 	end if;
 	*/
	OPEN person_;  
	while stemIndex<@count do 
    	FETCH person_ INTO stemPersonId;
    	
    	select t125.c36 into @rygzzd from t126 ,t125 where t126.id = t125.c06 and t126.id = stemPersonId;
    	if @rygzzd then
    		select data_value into @rygzzd from sys_s_data where id = @rygzzd;-- 人员工资制度 205体育津贴奖金制
    	end if;
    	if @rygzzd = '205' then 
    		-- -- 人员工资制度 205体育津贴奖金制 运动员
			select DATE_FORMAT(DATE_ADD(now(),INTERVAL 1 MONTH),'%Y') into @stemMonth;
			select replace(t126.c12,'-','') 
			into cjgzsj 
			from t126,t125 
			where t126.id = t125.c06 
			and t126.id = stemPersonId; 
			set cjgzsj = SUBSTR(cjgzsj FROM 1 FOR 4);
			select PERIOD_DIFF(@stemMonth,cjgzsj) into stemNum;
			set stemNum = ifnull(stemNum,0) + 1;
			update t126 set c45 = stemNum where id = stemPersonId;
			update data_record_t126 set c45=stemNum where dataclassCode = 't126' and dataId = stemPersonId;			
			-- 更新人员基本信息表中 入队年限 为（当前时间年-参加工作时间/入队时间的年 + 1）
    	else
			select replace(t126.c12,'-',''),replace(t125.c02,'-',''),t126.c32,t126.c33,t126.c34,t126.c35
			into cjgzsj,qxsj,kjssjY,kjssjM,jdsjY,jdsjM
			from t126,t125 
			where t126.id = t125.c06 
			and t126.id = stemPersonId; 
			set cjgzsj = SUBSTR(cjgzsj FROM 1 FOR 6);
			select PERIOD_DIFF(qxsj,cjgzsj) into stemNum;
			set stemNum = stemNum + 12*ifnull(kjssjY,0) + ifnull(kjssjM,0)  - 12*ifnull(jdsjY,0) -ifnull(jdsjM,0) +1 ; 
			-- 计算工作年-月
			-- t126.c47:工作时间-年  c48:工作时间-月 c14:工作年限
			if stemNum >= 12 then 
				set stempParam = floor(stemNum/12) ;
				set stemNum = mod(stemNum,12);
				update t126 set c47=stempParam,c48=stemNum,c14=stempParam+1 where id = stemPersonId;			
				update data_record_t126 set c47=stempParam,c48=stemNum,c14=stempParam+1 where dataclassCode = 't126' and dataId = stemPersonId;			
			ELSE	
				update t126 set c47=0,c48=stemNum,c14=1 where id = stemPersonId;
				update data_record_t126 set c47=0,c48=stemNum,c14=1 where dataclassCode = 't126' and dataId = stemPersonId;	
			end if;
		end if;
				
				
 		/**
		-- 修改关联型
		select c13 into dwgzzd from t111 where id = v_unit_dataId; -- 单位工资制度

		select t126.c15,t126.c28,t126.c39,t126.c17,t126.c27,t125.c07,t125.c09,
		t126.c36,t125.c36
		into bm,sf,zxgzbz,gzdyzj,sfld,jb,dc,
		-- 部门,人员身份,执行工资标准,工资对应职级,是否领导, 姓名,级别,档次
		sjzj,rygzzd
		-- 实际职级,人员工资制度
		from t126,t125 
		where t126.id = stemPersonId and t125.c06 = t126.id ;
		
		select c03 into bm from t113 where id = bm; -- 导入时使用的部门名称
		update t126,t113 
		set t126.c15 = t113.id where t126.id= stemPersonId and t113.c03=bm and t126.c01 = t113.c01;
		
		select data_value into @rygzzdCode from sys_s_data where id = rygzzd; -- 获取人员工资制度码表data_value名称 
		-- select c04 into @zxgzbz from t136 where id = zxgzbz;-- 执行工资标准 中文名称
		-- select c02 into sf from t136 where id = sf;-- 人员身份 中文名称
		select count(1) into @sfldCount from t127 where id = sfld;
		if @sfldCount>0 then 
			select c04 into sfld from t127 where id = sfld; -- 是否领导 中文名称
		else 
			set sfld = '';
		end if;
		-- 处理实际职级
		select count(1) into @sjzjCount from sys_s_data where id = sjzj;
		if @sjzjCount > 0 then 
			select name into @sjzjName from sys_s_data where id = sjzj;
		else 
			set @sjzjName = sjzj;
		end if;
		set @sjzjName = concat(@sjzjName,sfld);
		select count(1) into @sjzjCount from sys_s_data where typename = 'sjzj' and name =  @sjzjName;
		if @sjzjCount > 0 then 
			select id into sjzj from sys_s_data where  typename = 'sjzj' and name =  @sjzjName;
		end if;
		
		-- select id into sf from t136 where c01=dwgzzd and c02=sf and c03='在职' and c04=@zxgzbz and c05=rygzzd;
		-- 查询正确的执行工资标准,人员身份id c01-单位工资制度 c02-人员身份 c03-在职/离退休 c04-执行工资标准 c05-人员工资制度
		set @sjzjName = concat(@sjzjName,sfld);
		
		select count(1) into @gzdyzjCount from t127 where id = gzdyzj;
		set @gzdyzj = gzdyzj;
    	if @gzdyzjCount > 0 then 
			select c05 into @gzdyzj from t127 where id = gzdyzj; -- 工资对应职级 中文名称
		end if;
		select count(1) into @gzdyzjCount from t127 where c05=@gzdyzj and c08=zxgzbz and c04=sfld; -- 工资对应职级;
		if @gzdyzjCount > 0 then 
			select id into gzdyzj from t127 where c05=@gzdyzj and c08=zxgzbz and c04=sfld order by c01 desc  limit 0,1; -- 工资对应职级;
			if sfld!='' then 
				set sfld = gzdyzj;-- 是否领导
			end if;
		else 
			select id into gzdyzj from t127 where c05=@gzdyzj and c08=zxgzbz order by c01 desc  limit 0,1; -- 工资对应职级;
			-- set resultMsg = concat('select id into gzdyzj from t127 where c05=\'',gzdyzj,'\' and c08=\'',zxgzbz,'\'  and c01 = ',newSalaryDate);leave label_pro;
		end if;
		-- 查询正确的 工资对应职级 c05-次级别名称  c08-执行工资标准 c04-级别名称(是否领导)
		-- set sfld = gzdyzj;-- 是否领导
		
		if ifnull(jb,'')!='' then 
			select c05 into jb from t127 where id = jb; -- 级别 中文名称
			if ifnull(dc,'')!='' then 
				select c04 into dc from t127 where id = dc; -- 档次 中文名称
				select id,id into jb,dc from t127 where c05=jb and c04=dc and c08=zxgzbz order by c01 desc limit 0,1;
			end if;
		else
			if ifnull(dc,'')!='' then 
				select c04 into dc from t127 where id = dc; -- 档次 中文名称
				if @rygzzdCode = 202 or @rygzzdCode = 203 then 
					select id into dc from t127 where c04=dc and c08=zxgzbz and c05=@gzdyzj order by c01 desc limit 0,1;
				else
					if  @rygzzdCode = 204 then -- 事业
						select id into dc from t127 where c04=dc and c08=zxgzbz order by c01 desc limit 0,1;
					else 
						select id into dc from t127 where c04=dc and c08=zxgzbz and c05=@gzdyzj order by c01 desc limit 0,1;
					end if;
				end if;
			end if;
		end if;
		
		
		-- set zxgzbz = sf; -- 执行工资标准
		-- select id into sfld from t127 where c04=sfld and c08=zxgzbz;-- 是否领导 
		-- 查询正确的 是否领导  c04-级别名称  c08-执行工资标准
	-- set resultMsg = concat('111sf:',sf,',zxgzbz:',zxgzbz,',gzdyzj:',gzdyzj,',sfld:',sfld);leave label_pro;
		
	-- 	set resultMsg = concat('sf12:',sf,',zxgzbz:',zxgzbz,',gzdyzj:',gzdyzj,',sfld:',sfld);leave label_pro;
		-- update t126 set c28=sf,c39=zxgzbz,c17=gzdyzj,c27=sfld where id = stemPersonId;-- 更新人员信息表的 部门,执行工资标准,工资对应职级,是否领导
		update t126 set c36=sjzj,c17=gzdyzj,c27=sfld where id = stemPersonId;-- 更新人员信息表的 部门,执行工资标准,工资对应职级,是否领导
		-- update data_data_record set c28=sf,c39=zxgzbz,c17=gzdyzj,c27=sfld where dataclassCode = 't126' and dataId = stemPersonId;	
		update data_data_record set c36=sjzj,c17=gzdyzj,c27=sfld where dataclassCode = 't126' and dataId = stemPersonId;	
		update t125 set c33=stemPersonId,c07=jb,c09=dc where c06 = stemPersonId;-- 更新工资表里面的 姓名,级别,档次
		update data_data_record set c33=stemPersonId,c07=jb,c09=dc where dataclassCode = 't125' and c06 = stemPersonId;
		*/
		set stemIndex = stemIndex + 1;	
	end while;
  -- 关闭游标
  CLOSE person_;
  set resultMsg = concat('共@count:',@count,'人,其中',stemIndex,'人数据更新!');
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`p_delete_person`(IN personId int(11),INOUT resultMsg  varchar(1000) CHARSET utf8)
label_pro:BEGIN
-- 输入参数：
-- 		createrId：操作人的编号，orgId：单位人的编号，resultMsg：描述
	/**
	 * 调用存储过程删除人员相关数据 
	 * 年度考核
	 * 人员学习简历 
	 * 人员任职简历
	 * 一次性补扣发
	 */
	-- 声明变量
	declare stemNum int(11);
	
	set resultMsg = "";
	if personId = 0 then 
		leave label_pro;
	end if; 
	
	
	-- 人员学习简历
	select count(1) into stemNum from t122 where c02 = concat(personId,'') 
	; 
	if stemNum > 0 then
		delete from t122 where c02 = concat(personId,''); 
	end if; 
	
	-- 人员任职简历
	select count(1) into stemNum from t121 where c02 = concat(personId,'') 
	; 
	if stemNum > 0 then
		delete from t121 where c02 = concat(personId,''); 
	end if; 
	
	-- 人员年度考核情况表
	select count(1) into stemNum from t124 where c03 = concat(personId,'') 
	; 
	if stemNum > 0 then
		delete from t124 where c03 = concat(personId,''); 
	end if; 
	
	-- 人员套改表
	select count(1) into stemNum from t131 where c01 = concat(personId,'') 
	; 
	if stemNum > 0 then
		delete from t131 where c01 = concat(personId,''); 
	end if; 
	
	-- 警察加班补贴
	select count(1) into stemNum from t152 where c03 = concat(personId,'') ;
	if stemNum > 0 then
		delete from t152 where c03 = concat(personId,''); 
	end if; 

	-- 警察执勤津补贴
	select count(1) into stemNum from t153 where c03 = concat(personId,'') 
	;
	if stemNum > 0 then
		delete from t153 where c03 = concat(personId,''); 
	end if; 

	-- 艰边津贴补扣发
	select count(1) into stemNum from t164 where c03 = concat(personId,'') 
	; 
	if stemNum > 0 then
		delete from t164 where c03 = concat(personId,''); 
	end if; 
	
	-- 其它一次性补扣发
	select count(1) into stemNum from t119 where c01 = concat(personId,'') 
	; 
	if stemNum > 0 then
		delete from t119 where c01 = concat(personId,''); 
	end if; 
	
	-- 其它一次性补扣发-津补贴表
	select count(1) into stemNum from t150 where c05 = concat(personId,'') 
	; 
	if stemNum > 0 then
		delete from t150 where c05 = concat(personId,''); 
	end if; 
	
	-- 年终奖金发放表
	select count(1) into stemNum from t154 where c02 = concat(personId,'') 
	; 
	if stemNum > 0 then
		delete from t154 where c02 = concat(personId,''); 
	end if; 
	
	-- 人员计发生活费工资情况
	select count(1) into stemNum from t167 where c01 = concat(personId,'') 
	; 
	if stemNum > 0 then
		delete from t167 where c01 = concat(personId,''); 
	end if; 
	
	-- 人员计发病假工资
	select count(1) into stemNum from t159 where c01 = concat(personId,'') 
	; 
	if stemNum > 0 then
		delete from t159 where c01 = concat(personId,''); 
	end if; 
	
	-- 人员奖惩情况
	select count(1) into stemNum from t177 where c01 = concat(personId,'') 
	; 
	if stemNum > 0 then
		delete from t177 where c01 = concat(personId,''); 
	end if; 
	
	
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`p_del_recordMonthFill`(in v_i_fund_month varchar(6),in v_unit_dataId int(11),
inout resultMsg varchar(1000))
label_pro:BEGIN
/*先更新当前但是所有变动记录对应月份的当月应补为0 fund_salary_pay_XXXX年XX月*/
	DECLARE stempNum int(11);
	DECLARE stemIndex int(11);
	DECLARE stemFundMonth VARCHAR(20);
	DECLARE v_table VARCHAR(50);
	DECLARE v_allowance_table VARCHAR(50);
	
    DECLARE done INT DEFAULT FALSE;
    
    declare sysDataBase varchar(20);-- 数据库名称
    
	-- 所有未生成基金补扣发的变动记录(未审核通过的)对应的起薪时间
	DECLARE fundMonth_ CURSOR FOR
   SELECT distinct replace(t125.c02,'-','') from data_record_t126 t126,data_record_t125 t125
		where 1=1 and t126.c01 = concat(v_unit_dataId,'') and t125.changeSign = t126.changeSign
		 and  ifnull(t126.allAuditFlag,'')!='2' -- 未审核通过的数据
		 -- t125.c36 人员工资制度为 201 -公务员职级工资
	  and not EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '2')-- 非离休
	  order by t125.c02
	  ;-- t126.c03 人员状态-码表 1-在职
 	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
	-- 打开游标
	select ifnull(content,'smso') into sysDataBase from sys_s_config where enname = 'DATABASE_NAME';-- 数据库名称
	set stemIndex = 0;

  OPEN fundMonth_;  
  -- 开始循环
  read_loop: LOOP
    -- 提取游标里的数据，这里只有一个，多个的话也一样；
    FETCH fundMonth_ INTO stemFundMonth;
    -- 声明结束的时候
    IF done THEN
      LEAVE read_loop;
    END IF;
    set @doneF = done;
	SET v_table =  CONCAT('fund_salary_pay_',stemFundMonth);/*处理分表存储*/
	SET v_allowance_table =  CONCAT('fund_salary_subsidies_pay_',stemFundMonth);/*处理分表存储*/
    select count(1) into stempNum from information_schema.tables where table_schema = sysDataBase and TABLE_NAME = v_table;-- smso数据库里面对应的工资发放表信息
	if stempNum > 0 then -- 判断是否已经存在v_i_fund_month(如201608)的工资发放表信息
		SET @sqlstr = CONCAT('update ',v_table,' set 
					zwgz_byyb= 0,gwgz_byyb=0,
					-- 职务/技术等级工资	级别岗位级别工资
					jshstg_byyb = 0,tsjytg_byyb=0,bltggz_byyb = 0,
					--  教师护士提高 特殊教育提高 保留特岗工资
					jsblgz_byyb=0, hsblgz_byyb = 0,
					-- 中小学教师保留  保留护士提高
					psxlj_byyb=0, jxgz_byyb = 0,
					-- 平时训练奖 绩效工资
					jbt_salary_byyb=0,part_total_salary_byyb = 0,total_salary_byyb=0
					-- 津补贴 	 小计 合计
					where unit_id = \'',v_unit_dataId,'\'');
		PREPARE stmt FROM @sqlstr;
		EXECUTE stmt;
		DROP PREPARE stmt;
	end if;
	select count(1) into stempNum from information_schema.tables where table_schema = sysDataBase and TABLE_NAME = v_allowance_table;-- smso数据库里面对应的津补贴发放表信息
	if stempNum > 0 then -- 判断是否已经存在v_i_fund_month(如201608)的工资发放表信息
		SET @sqlstr = CONCAT('update ', v_allowance_table,' set   
			-- 清空所有最新一次的补扣发金额,确保下一个月再做变动,月结申报时数据是0
			salary_byyb= 0
			where unit_id = \'',v_unit_dataId,'\'');
		PREPARE stmt FROM @sqlstr;
		EXECUTE stmt;
		DROP PREPARE stmt;
	end if;
	set stemIndex = stemIndex + 1;
    set done = @doneF;
    -- 统一计算 当月所有上报变动记录的 补扣发
  END LOOP;
  -- 关闭游标
  CLOSE fundMonth_;

END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`p_fill_fund`(in v_i_fund_month varchar(6),in v_unit_id varchar(50),
in v_unit_dataId int(11),inout resultMsg varchar(10000))
label_pro:BEGIN
/*基金生成-补扣发花名册fund_salary_fill工资补扣发相关 fund_salary_fill_subsidies-津补贴详细补扣发*/
	DECLARE stempNum int(11);
	DECLARE stemNum int(11);-- 参数变量
	DECLARE stempParam varchar(20);-- 参数变量
	DECLARE stemIndex int(11);
	DECLARE sTemRecordId int(11);
	DECLARE chanType VARCHAR(30);
	DECLARE chanSign VARCHAR(200);
	DECLARE v_table VARCHAR(50);
	DECLARE v_allowance_table VARCHAR(50);
	DECLARE v_table_cache VARCHAR(50);
	DECLARE v_allowance_table_cache VARCHAR(50);
	
    DECLARE done INT DEFAULT FALSE;
    
    declare sysDataBase varchar(20);-- 数据库名称
    
	DECLARE recordId_ CURSOR FOR
   SELECT t126.id from data_record_t126 t126
	where 1=1 and t126.dataclassCode = 't126' and  ifnull(allAuditFlag,'')!='2' -- 未审核通过的数据
	and t126.c01 = concat(v_unit_dataId,'') -- t125.c36 人员工资制度为 201 -公务员职级工资
	and not exists(select 1 from sys_s_data d where d.id = t126.c03 and d.typename = 'staffStatus' and d.data_value = '2')
	-- 非离休人员
	order by t126.dataId,t126.id
	;
  DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
 	set stemIndex = 0;
	select ifnull(content,'smso') into sysDataBase from sys_s_config where enname = 'DATABASE_NAME';-- 数据库名称
	
	SET v_table =  CONCAT('fund_salary_fill_',v_i_fund_month);/*处理分表存储*/
	SET v_allowance_table =  CONCAT('fund_salary_fill_subsidies_',v_i_fund_month);/*处理分表存储*/
	SET v_table_cache =  CONCAT('fund_salary_fill_',v_unit_dataId);/*临时表 处理分表存储*/
	SET v_allowance_table_cache =  CONCAT('fund_salary_fill_subsidies_',v_unit_dataId);/*临时表 处理分表存储*/
	
	select count(1) into stempNum from information_schema.tables where table_schema = sysDataBase and TABLE_NAME = v_table_cache;-- smso数据库里面对应的工资发放表信息
	if stempNum < 1 then -- 判断是否已经存在v_i_fund_month(如201608)的工资发放表信息
		SET @sqlstr = CONCAT('CREATE TABLE ',v_table_cache,' LIKE ', ' fund_salary_fill');
		PREPARE stmt FROM @sqlstr;
		EXECUTE stmt;
		DROP PREPARE stmt;
	end if;
	select count(1) into stempNum from information_schema.tables where table_schema = sysDataBase and TABLE_NAME = v_allowance_table_cache;-- smso数据库里面对应的津补贴发放表信息
	if stempNum < 1 then -- 判断是否已经存在v_i_fund_month(如201608)的工资发放表信息
		SET @sqlstr = CONCAT('CREATE TABLE ',v_allowance_table_cache,' LIKE ', ' fund_salary_fill_subsidies');
		PREPARE stmt FROM @sqlstr;
		EXECUTE stmt;
		DROP PREPARE stmt;
		-- call p_fund_addIndex(v_i_fund_month,'fund_salary_fill',resultMsg);-- 补扣发表生成索引
	end if;
	SET @sqlstr = CONCAT('delete from ',v_table_cache);
	PREPARE stmt FROM @sqlstr;
	EXECUTE stmt;
	DROP PREPARE stmt;
	SET @sqlstr = CONCAT('delete from ',v_allowance_table_cache);
	PREPARE stmt FROM @sqlstr;
	EXECUTE stmt;
	DROP PREPARE stmt;
	
	
	-- update data_data_record set fund_month = v_i_fund_month, perAuditFlag = '9',allAuditFlag = '9' where dataclassCode = 't126' and c01 = v_unit_dataId and ifnull(allAuditFlag,'')!='2';-- 先更新人员基本信息的变动记录
	-- update data_data_record a,data_data_record b set a.fund_month = b.fund_month,a.perAuditFlag = '9' ,a.allAuditFlag = '9'
	-- where a.changeSign = b.changeSign and b.dataclassCode = 't126' and b.perAuditFlag = '9' --  9-生成基金未上报
	-- and ifnull(a.allAuditFlag,'')!='2';-- 再更新所有相同变动标志的  改在循环里面执行
	-- 打开游标

	-- 先更新当前但是所有变动记录对应月份的当月应补为0
	call p_del_recordMonthFill(v_i_fund_month,v_unit_dataId,resultMsg);
	if resultMsg and ''!=resultMsg then
		leave label_pro; 
	end if;
/**计算补扣发之前应该先清空本次所有变动的补扣发数据*/

  OPEN recordId_;  
  -- 开始循环
  read_loop: LOOP
    -- 提取游标里的数据，这里只有一个，多个的话也一样；
    FETCH recordId_ INTO sTemRecordId;
    -- 声明结束的时候
    IF done THEN
      LEAVE read_loop;
    END IF;
	set @doneF = done;
    select changeType,changeSign into chanType ,chanSign from data_record_t126 where  id = sTemRecordId;
    /**update data_data_record set fund_month = v_i_fund_month, perAuditFlag = '9',allAuditFlag = '9' 
    where id = sTemRecordId and dataclassCode = 't126' and c01 = v_unit_dataId
     and ifnull(allAuditFlag,'')!='2' and perAuditFlag!= '2';-- 先更新人员基本信息的变动记录
	update data_data_record a,data_data_record b set a.fund_month = b.fund_month,a.perAuditFlag = '9' ,a.allAuditFlag = '9'
	where a.changeSign = b.changeSign and b.dataclassCode = 't126' and b.perAuditFlag = '9' --  9-生成基金未上报
	and ifnull(a.allAuditFlag,'')!='2' and a.perAuditFlag!= '2';-- 再更新所有相同变动标志的
*/	
		 -- set resultMsg = concat('#',chanType,',',chanSign);
		 -- set resultMsg = concat('#',v_unit_dataId,',',sTemRecordId,',',chanType ,',',chanSign,',',v_i_fund_month);leave label_pro; 
		 -- if stemIndex > 0 then leave label_pro; end if;
    call fillCount(v_unit_dataId,sTemRecordId,chanType ,chanSign,v_i_fund_month,resultMsg);
	set stemIndex = stemIndex + 1;
	if ''!= resultMsg then 
		leave label_pro;
	end if;
	set done = @doneF;
    -- 统一计算 当月所有上报变动记录的 补扣发
  END LOOP;
  -- 关闭游标
  CLOSE recordId_;
		
	select count(1) into stempNum from information_schema.tables where table_schema = sysDataBase and TABLE_NAME = v_table;-- smso数据库里面对应的工资发放表信息

	if stempNum < 1 then -- 判断是否已经存在v_i_fund_month(如201608)的工资发放表信息
		SET @sqlstr = CONCAT('CREATE TABLE ',v_table,' LIKE ', ' fund_salary_fill');
		PREPARE stmt FROM @sqlstr;
		EXECUTE stmt;
		DROP PREPARE stmt;
	end if;
	select count(1) into stempNum from information_schema.tables where table_schema = sysDataBase and TABLE_NAME = v_allowance_table;-- smso数据库里面对应的津补贴发放表信息
	if stempNum < 1 then -- 判断是否已经存在v_i_fund_month(如201608)的工资发放表信息
		SET @sqlstr = CONCAT('CREATE TABLE ',v_allowance_table,' LIKE ', ' fund_salary_fill_subsidies');
		PREPARE stmt FROM @sqlstr;
		EXECUTE stmt;
		DROP PREPARE stmt;
	end if;
	
	SET @sqlstr = CONCAT('delete from  ', v_table,' where fund_month=',v_i_fund_month,' and unit_id=\'',v_unit_dataId,'\'');
	PREPARE stmt FROM @sqlstr;
	EXECUTE stmt;
	DROP PREPARE stmt;
	
	SET @sqlstr = CONCAT('delete from  ', v_allowance_table,' where fund_month=',v_i_fund_month,' and unit_id=\'',v_unit_dataId,'\'');
	PREPARE stmt FROM @sqlstr;
	EXECUTE stmt;
	DROP PREPARE stmt;
	
	
	/** select t126.c01 ,t126.c02,t126.c04,
	--		单位id	  人员id	人员姓名
		sum(jshstg_bf),		sum(tsjytg_bf),		sum(bltggz_bf),	
	-- 教师护士提高10%-补扣发 特殊教育提高15%-补扣发 保留特岗工资-补扣发
		sum(jsblgz_bf),		sum(hsblgz_bf),		sum(psxlj_bf),
	-- 中小学教师保留10%工资-补扣发 保留护士提高10%工资-补扣发 平时训练奖-补扣发
		sum(jxgz_bf),sum(jbt_salary_bf),sum(part_total_salary_bf),sum(jbzq_salary),sum(qitcxpkf_salary),
	-- 绩效工资-补扣发 津补贴补扣发 	小计-补扣发				加班值勤补扣发		其它一次性补扣发
		sum(nzjq_salary),sum(total_salary_bf)
	-- 年终一次奖金补扣发 合计-实际补扣发
	from record_fill_tail a ,data_data_record t126
	where t126.dataclassCode = 't126' 
	and a.change_id = t126.id
  	and t126.fund_month = v_i_fund_month and t126.c01 = v_unit_dataId
  	group by t126.c01 ,t126.c02,t126.c04;
  	*/
	SET @sqlstr = CONCAT('INSERT INTO ', v_table_cache,' (fund_month,unit_code,unit_id,change_type,changetype_name,changeSign,staff_id,staff_code,staff_name,
					zwgz,zwgz_ce,zwgz_bf,gwgz,gwgz_ce,gwgz_bf,
				-- 职务工资	补发	岗位工资 补发
					jshstg,jshstg_ce,jshstg_bf,		tsjytg,tsjytg_ce,tsjytg_bf,		bltggz,bltggz_ce,bltggz_bf,	
				-- 教师护士提高10%-补扣发 特殊教育提高15%-补扣发 保留特岗工资-补扣发
					jsblgz,jsblgz_ce,jsblgz_bf,		hsblgz,hsblgz_ce,hsblgz_bf,		psxlj,psxlj_ce,psxlj_bf,
				-- 中小学教师保留10%工资-补扣发 保留护士提高10%工资-补扣发 平时训练奖-补扣发
					jxgz,jxgz_ce,jxgz_bf,jbt_salary,jbt_salary_ce,jbt_salary_bf,part_total_salary,part_total_salary_ce,part_total_salary_bf,
				-- 绩效工资-补扣发 津补贴补扣发 	小计-补扣发	
					total_salary,total_salary_ce,total_salary_bf,fillNum ,change_time,startMonth,endMonth)
				-- 合计  工资合计差额 合计-实际补扣发 补扣发月数 变动时间
			select ',v_i_fund_month,',\'',v_unit_id,'\',t126.c01 ,t126.changeType,d.name,t126.changeSign,t126.dataId,t126.c02,t126.c04,
				-- 			基金月份		单位代码	单位id	  人员id	人员姓名
									round(zwgz,2),round(zwgz_ce,2),round(zwgz_bf,2),round(gwgz,2),round(gwgz_ce,2),round(gwgz_bf,2),
				-- 职务工资	补发	岗位工资 补发
					round(jshstg,2),round(jshstg_ce,2),round(jshstg_bf,2),		round(tsjytg,2),round(tsjytg_ce,2),round(tsjytg_bf,2),	
						round(bltggz,2),round(bltggz_ce,2),round(bltggz_bf,2),	
				-- 教师护士提高10%-补扣发 特殊教育提高15%-补扣发 保留特岗工资-补扣发
					round(jsblgz,2),round(jsblgz_ce,2),round(jsblgz_bf,2),		round(hsblgz,2),round(hsblgz_ce,2),round(hsblgz_bf,2),	
						round(psxlj,2),round(psxlj_ce,2),round(psxlj_bf,2),
				-- 中小学教师保留10%工资-补扣发 保留护士提高10%工资-补扣发 平时训练奖-补扣发
					round(jxgz,2),round(jxgz_ce,2),round(jxgz_bf,2),round(jbt_salary,2),round(jbt_salary_ce,2),round(jbt_salary_bf,2),
					round(part_total_salary,2),round(part_total_salary_ce,2),round(part_total_salary_bf,2),
				-- 绩效工资-补扣发   			津补贴补扣发 	小计-补扣发				加班值勤补扣发		其它一次性补扣发
					round(total_salary,2),round(total_salary_ce,2),round(total_salary_bf,2),a.fillNum,t126.c41,replace(t125.c02,\'-\',\'\'),
					replace(DATE_FORMAT(DATE_ADD(concat(\'',v_i_fund_month ,'\',\'01\'),INTERVAL -1 MONTH),\'%Y%m\'),\'-\',\'\')
				--   工资合计 合计-实际补扣发 补扣发月数 变动时间
				from record_fill_tail a ,data_record_t126 t126,sys_s_data d,data_record_t125 t125 
				where t126.c01 = \'',v_unit_dataId,'\'  and t125.c05 = t126.c01  and t125.changesign = t126.changesign 
				and a.change_id = t126.id and d.id = t126.changeType
			  	and t126.fund_month = \'',v_i_fund_month ,'\'
				and not exists(select 1 from sys_s_data d where d.id = t126.c03 and d.typename = \'staffStatus\' and d.data_value = \'2\') -- 非离休人员
			  	order by t126.c01,t126.c04 ');
		PREPARE stmt FROM @sqlstr;
		EXECUTE stmt;
		DROP PREPARE stmt;	
	
	SET @sqlstr = CONCAT('INSERT INTO ', v_allowance_table_cache,'(fund_month,unit_id,unit_code,changeSign,staff_id,
			jbt_id,jbt_title,salary_value,salary_sj_bf,salary_hx_bf,jbt_salary_ce)
			-- 津补贴id  津补贴名称  津补贴金额  津补贴当月实际补发 津补贴后续补发  津补贴标准时间
		select ',v_i_fund_month,',',v_unit_dataId,',\'',v_unit_id,'\',t117.changeSign,t117.c03,
			-- 基金月分 	   单位id		单位代码(51036000) 人员id 
		t117.c04,t116.c03,round(t117.c07,2),a.jbt_salary_bf,0,jbt_salary_ce
		-- 津补贴id  津补贴名称 津补贴金额 津补贴当月实际补发 津补贴后续补发  津补贴标准时间
		from record_fill_subsidies a ,data_record_t117 t117 ,t116
		where  a.change_id = t117.id 
		and t117.c02 = \'',v_unit_dataId,'\' 
		and a.fund_month = \'',v_i_fund_month ,'\'
		and t117.c04 = concat(t116.id,\'\') 
		and not EXISTS (select 1 from t126,sys_s_data d where t126.c01 =\'',v_unit_dataId,'\' and d.id = t126.c03 and t126.id = t117.c03 and d.data_value = \'2\')-- 非离休人员
		group by t117.changeSign,t116.id');
	PREPARE stmt FROM @sqlstr;
	EXECUTE stmt;
	DROP PREPARE stmt;
	-- 系统计算补扣发 = 差额X月数
	set @sqlstr = concat('update ',v_table_cache,' a , ',v_allowance_table_cache,' b 
			set b.salary_sj_bf = round(ifnull(b.jbt_salary_ce,0)*ifnull(a.fillNum,0),2)
			where a.changesign = b.changesign and a.unit_id = \'',v_unit_dataId,'\'');
	PREPARE stmt FROM @sqlstr;
	EXECUTE stmt; 
	
	
	-- 基金生成未上报code
	select ifnull(content,11208) into @noApplyAuditCode from sys_s_config where enname = 'NOAPPLY_AUDIT_CODE';
	

	-- 年终奖金发放
	select count(1) into stemNum from t151 where c01 = concat(v_unit_dataId,'') 
	and (exists (select 1 from sys_s_data d where d.typename = 'ybshzt' and d.data_value != '2' and d.id = ifnull(t151.c03,''))
		or ifnull(t151.c03,'') = ''
	);
	-- set stemParam = 0;
	-- 月报审核状态  0-未处理 1-待审核 2-通过 3-未通过 7-撤回申请中 8-撤回 9-生成基金未上报
	if stemNum > 0 then
		select ifnull(content,11263) into @yearAwardCode from sys_s_config where enname = 'YEAR_AWARD_CODE';
		update t151 ,sys_s_data d set t151.c03 = d.id,t151.c04=concat(v_i_fund_month,'')
		 where t151.c01 = concat(v_unit_dataId,'') and t151.c03 != '11204' -- sys_s_data 11204 月报审核状态 -审核通过 
		and d.typename = 'ybshzt' and d.data_value= '9' ; 
		 
		update t154,t151 set t154.c04=concat(v_i_fund_month,'') where t154.c09=concat(t151.id ,'')
		and t151.c01 = concat(v_unit_dataId,'') and t151.c04=concat(v_i_fund_month,'');-- 更新年终奖金发放表的基金月份/发放时间

		-- select id into stempParam from t151 where c01 = v_unit_dataId and c03 = @noApplyAuditCode limit 0,1; -- 11208 生成基金未上报
		-- 年终奖金发放表
			SET @sqlstr = CONCAT('INSERT INTO ', v_table_cache,' (fund_month,unit_code,unit_id,change_type,changetype_name,staff_id,staff_code,staff_name,
					changeSign,-- 变动标志
					zwgz,zwgz_bf,zwgz_ce,gwgz,gwgz_bf,gwgz_ce,
				-- 职务工资	补发	岗位工资 补发
					part_total_salary_bf,
				-- 小计-补扣发
					nzjq_salary,total_salary_bf,fillNum,change_time)
				-- 年终一次奖金补扣发 合计-实际补扣发 补扣发月数
			select ',v_i_fund_month,',\'',v_unit_id,'\',t154.c01 ,',@yearAwardCode,',\'年终一次性奖金\',t126.id,t126.c02,t126.c04,
				-- 			基金月份		单位代码	单位id	  人员id	人员姓名
					concat(UNIX_TIMESTAMP(),',@yearAwardCode,',\'t126\',t126.id,\'t154\',t154.id),
				-- 变动标志
					t154.c05,t154.c05,t154.c05,t154.c06,t154.c06,t154.c06,
				-- 职务工资	补发 差额	岗位工资 补发 差额
					t154.c07,
				--  小计-补扣发 加班值勤补扣发		其它一次性补扣发
					t154.c07,t154.c07,1,DATE_FORMAT(t151.createDate,\'%Y-%m-%d\')
				-- 年终一次奖金补扣发  合计-实际补扣发 补扣发月数
				from t154 ,t126,t151 where  t154.c02 = t126.id  and t154.c09= t151.id   -- 年终奖金发放编号
				and t154.c01 = \'',v_unit_dataId,'\' -- 单位代码
				and t154.c04=',v_i_fund_month,'-- 基金月份
				and t151.c03 = ',@noApplyAuditCode,'
			  	order by t154.c02 ');
		PREPARE stmt FROM @sqlstr;
		EXECUTE stmt;
		DROP PREPARE stmt;
	end if;
	
	
	-- 警察加班补贴
	select count(1) into stemNum from t152 where c01 = concat(v_unit_dataId,'') 
	-- and EXISTS (select 1 from t126,sys_s_data d where d.id = t126.c03 and t126.id = t152.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
		and (exists (select 1 from sys_s_data d where d.typename = 'ybshzt' and d.data_value != '2' and d.id = ifnull(t152.c13,''))
		or ifnull(t152.c13,'') = ''
	);
	-- 月报审核状态  0-未处理 1-待审核 2-通过 3-未通过 7-撤回申请中 8-撤回 9-生成基金未上报
	if stemNum > 0 then
		select ifnull(content,11307) into @policeExtraCode from sys_s_config where enname = 'POLICE_EXTRA_CODE';
		update t152 ,sys_s_data d set t152.c13 = d.id,t152.c12=concat(v_i_fund_month,'')
		 where t152.c01 = concat(v_unit_dataId,'') and t152.c13 != '11204' -- sys_s_data 11204 月报审核状态 -审核通过 
		-- and EXISTS (select 1 from t126,sys_s_data d where d.id = t126.c03 and t126.id = t152.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
		and d.typename = 'ybshzt' and d.data_value= '9' ; 
		-- select id into stempParam from t152 where c01 = v_unit_dataId and c13 = @noApplyAuditCode limit 0,1; -- 11208 生成基金未上报
		-- 警察加班补贴 表
			SET @sqlstr = CONCAT('INSERT INTO ', v_table_cache,' (fund_month,unit_code,unit_id,change_type,changetype_name,staff_id,staff_code,staff_name,
					changeSign,-- 变动标志
					part_total_salary_bf,part_total_salary_ce,
				-- 小计-补扣发
					total_salary_bf,total_salary_ce,fillNum,zwgz_ce,zwgz_bf,change_time,startMonth,endMonth)
				-- 合计-实际补扣发  加班天数 加班标准 变动时间
			select ',v_i_fund_month,',\'',v_unit_id,'\',t152.c01 ,',@policeExtraCode,',\'警察加班补贴\',t126.id,t126.c02,t126.c04,
				-- 			基金月份		单位代码	单位id	  人员id	人员姓名
				concat(UNIX_TIMESTAMP(),',@policeExtraCode,',\'t126\',t126.id,\'t152\',t152.id),
				-- 变动标志
					t152.c10,concat(\'节\',ifnull(t152.c09,0),\'-休\',ifnull(t152.c08,0)),
				--  小计-补扣发 加班值勤补扣发		其它一次性补扣发
					t152.c10,t152.c10,concat(\'节\',ifnull(t152.c07,0),\'-休\',ifnull(t152.c14,0)),concat(\'节\',ifnull(t152.c09,0),\'-休\',ifnull(t152.c08,0)),t152.c10
				--  合计-实际补扣发  加班天数(节假日天数-休息日天数) 加班标准(节假日标准-休息日标准) 加班费
					,DATE_FORMAT(t152.createDate,\'%Y-%m-%d\'),t152.c05,t152.c06
				from t152 ,t126 where t152.c03 = concat(t126.id,\'\')  and t152.c01 = \'',v_unit_dataId,'\' -- 发放编号
				and t152.c12 = ',v_i_fund_month,'
			--  	and EXISTS (select 1 from t126,sys_s_data d where d.id = t126.c03 and d.data_value = \'1\')-- t126.c03 人员状态-码表 1-在职
				order by t152.c03 ');
		PREPARE stmt FROM @sqlstr;
		EXECUTE stmt;
		DROP PREPARE stmt;
	end if;
	
	
	--  警察值勤津补贴
	select count(1) into stemNum from t153 where c01 = concat(v_unit_dataId,'') 
	-- and EXISTS (select 1 from t126,sys_s_data d where d.id = t126.c03 and t126.id = t153.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
	and (exists (select 1 from sys_s_data d where d.typename = 'ybshzt' and d.data_value != '2' and d.id = ifnull(t153.c17,''))
		or ifnull(t153.c17,'') = ''
	);
	-- 月报审核状态  0-未处理 1-待审核 2-通过 3-未通过 7-撤回申请中 8-撤回 9-生成基金未上报
	if stemNum > 0 then
		select ifnull(content,11307) into @policeDutyCode from sys_s_config where enname = 'POLICE_DUTY_CODE';
		update t153 ,sys_s_data d set t153.c17 = d.id,t153.c14=concat(v_i_fund_month,'')
		 where t153.c01 = concat(v_unit_dataId,'') and t153.c17 != '11204' -- sys_s_data 11204 月报审核状态 -审核通过 
		-- and EXISTS (select 1 from t126,sys_s_data d where d.id = t126.c03 and t126.id = t153.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
		and d.typename = 'ybshzt' and d.data_value= '9' ; 
		-- select id into stempParam from t152 where c01 = concat(v_unit_dataId,'') and c13 = @noApplyAuditCode limit 0,1; -- 11208 生成基金未上报
		-- 警察值勤津补贴 表
			SET @sqlstr = CONCAT('INSERT INTO ', v_table_cache,' (fund_month,unit_code,unit_id,change_type,changetype_name,staff_id,staff_code,staff_name,
					changeSign,-- 变动标志
					part_total_salary_bf,part_total_salary_ce,
				-- 小计-补扣发
					total_salary_bf,total_salary_ce,fillNum,zwgz_bf,zwgz_ce,change_time,startMonth,endMonth)
				-- 合计-实际补扣发 值勤天数 值勤补贴 变动时间
			select ',v_i_fund_month,',\'',v_unit_id,'\',t153.c01 ,',@policeDutyCode,',\'警察值勤补贴\',t126.id,t126.c02,t126.c04,
				-- 			基金月份		单位代码	单位id	  人员id	人员姓名
				concat(UNIX_TIMESTAMP(),',@policeDutyCode,',\'t126\',t126.id,\'t153\',t153.id),
				-- 变动标志
					t153.c12,t153.c06,
				--  小计-补扣发 加班值勤补扣发		其它一次性补扣发
					t153.c12,t153.c12,t153.c11,t153.c12,concat(\'值勤津贴标准-\',t153.c06)
				--  合计-实际补扣发 值勤天数 值勤补扣发 值勤补贴标准
					,DATE_FORMAT(t153.createDate,\'%Y-%m-%d\'),t153.c15,t153.c16
				from t153 ,t126 where  t153.c03 = concat( t126.id,\'\')  and t153.c01 = \'',v_unit_dataId,'\' -- 发放编号
				and t153.c14 = \'',v_i_fund_month,'\'
			--  	and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = \'1\')-- t126.c03 人员状态-码表 1-在职
				order by t153.c03 ');
		-- set resultMsg = concat('@sqlstr:',@sqlstr);leave label_pro;
		PREPARE stmt FROM @sqlstr;
		EXECUTE stmt;
		DROP PREPARE stmt;
	end if;
	
	-- 艰边津贴补扣发
	select count(1) into stemNum from t164 where c01 = concat(v_unit_dataId,'') 
	-- and EXISTS (select 1 from t126,sys_s_data d where d.id = t126.c03 and t126.id = t164.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
 	and (exists (select 1 from sys_s_data d where d.typename = 'ybshzt' and d.data_value != '2' and d.id = ifnull(t164.c10,''))
		or ifnull(t164.c10,'') = ''
	);
	-- 月报审核状态  0-未处理 1-待审核 2-通过 3-未通过 7-撤回申请中 8-撤回 9-生成基金未上报
	if stemNum > 0 then
		select ifnull(content,11315) into @hardMoteCode from sys_s_config where enname = 'HARD_MOTE_CODE';
		update t164 ,sys_s_data d set t164.c10 = d.id,t164.c11=concat(v_i_fund_month,'')
		 where t164.c01 = concat(v_unit_dataId,'') and t164.c10 != '11204' -- sys_s_data 11204 月报审核状态 -审核通过 
 		-- and EXISTS (select 1 from t126,sys_s_data d where d.id = t126.c03 and t126.id = t164.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
		and d.typename = 'ybshzt' and d.data_value= '9' ; 
		-- select id into stempParam from t152 where c01 = v_unit_dataId and c13 = @noApplyAuditCode limit 0,1; -- 11208 生成基金未上报
		-- 艰边津贴补扣发 表
			SET @sqlstr = CONCAT('INSERT INTO ', v_table_cache,' (fund_month,unit_code,unit_id,change_type,changetype_name,staff_id,staff_code,staff_name,
					changeSign,-- 变动标志
					part_total_salary_bf,part_total_salary_ce,
				-- 小计-补扣发
					total_salary_bf,total_salary_ce,fillNum,zwgz_bf,zwgz_ce,change_time,startMonth,endMonth)
				-- 合计-实际补扣发  变动时间
			select ',v_i_fund_month,',\'',v_unit_id,'\',t164.c01 ,',@hardMoteCode,',\'艰边津贴补扣发\',t126.id,t126.c02,t126.c04,
				-- 			基金月份		单位代码	单位id	  人员id	人员姓名
					concat(UNIX_TIMESTAMP(),',@hardMoteCode,',\'t126\',t126.id,\'t164\',t164.id),
				-- 变动标志
					t164.c09,t164.c07,
				--  小计-补扣发 加班值勤补扣发		其它一次性补扣发
					t164.c09,t164.c09,t164.c08 ,t164.c09,concat(\'艰边-\',t164.c07)
				--  合计-实际补扣发 补扣发月数  艰边补扣发  艰边补扣发差额
					,DATE_FORMAT(t164.createDate,\'%Y-%m-%d\'),t164.c05,t164.c06
				from t164 ,t126 where t164.c03 = concat(t126.id ,\'\')  and t164.c01 = \'',v_unit_dataId,'\' -- 发放编号
				and t164.c11 = \'',v_i_fund_month,'\'
				-- and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = \'1\')-- t126.c03 人员状态-码表 1-在职
			  	order by t164.c03 ');
		PREPARE stmt FROM @sqlstr;
		EXECUTE stmt;
		DROP PREPARE stmt;
	end if;
	
	
	-- 其它一次性补扣发
	-- 更新当前单位 未审核通过的其它一次性补扣发管理表数据
	select count(1) into stemNum from t119 where c04 = concat(v_unit_dataId,'')
	and (exists (select 1 from sys_s_data d where d.typename = 'ybshzt' and d.data_value != '2' and d.id = ifnull(t119.c21,''))
		or ifnull(t119.c21,'') = ''
	)
	and not EXISTS (select 1 from t126,sys_s_data d where t126.c01 = concat(v_unit_dataId,'') and  t126.c03 = concat(d.id,'') and t126.id = t119.c01 and d.data_value = '2')-- 非离休人员
	;
	-- 月报审核状态  0-未处理 1-待审核 2-通过 3-未通过 7-撤回申请中 8-撤回 9-生成基金未上报
	if stemNum > 0 then
		select ifnull(content,11264) into @otherFillCode from sys_s_config where enname = 'OTHER_FILL_CODE';-- 11264其它一次性补扣发
		select count(1) into stemNum from t119,t125 b where t119.c01=b.c06 
		and t119.c04 = concat(v_unit_dataId,'') and t119.c21 != '11204'  -- sys_s_data 11204 月报审核状态 -审核通过
		-- and EXISTS (select 1 from t126,sys_s_data d where d.id = t126.c03 and t126.id = t119.c01 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
		-- and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in (201,206,202,203));
		and not EXISTS (select 1 from t126,sys_s_data d where t126.c01 = concat(v_unit_dataId,'') and d.id = t126.c03 and t126.id = t119.c01 and d.data_value = '2')-- 非离休人员
		;
		if stemNum > 0 then 
			update t119,t125 b ,sys_s_data d set t119.c21 = d.id,t119.c20=concat(v_i_fund_month,'')
			 where t119.c04 = concat(v_unit_dataId,'') and ifnull(t119.c21,'') != '11204' -- sys_s_data 11204 月报审核状态 -审核通过 
			and d.typename = 'ybshzt' and d.data_value= '9' 
			and t119.c01=b.c06 
			and not EXISTS (select 1 from t126,sys_s_data d where t126.c01 = concat(v_unit_dataId,'') and d.id = t126.c03 and t126.id = t119.c01 and d.data_value = '2')-- 非离休人员
			-- and EXISTS (select 1 from t126,sys_s_data d where d.id = t126.c03 and t126.id = t119.c01 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
			;
			-- and exists(select 1 from sys_s_data d where d.id = b.c36 and d.typename = 'wageSystem' and d.data_value in (201,206,202,203));
			
			-- 其它一次性补扣发
			SET @sqlstr = CONCAT('INSERT INTO ', v_table_cache,' (fund_month,unit_code,unit_id,change_type,changetype_name,staff_id,staff_code,staff_name,
					changeSign,
					-- 变动标志
					zwgz_bf,zwgz_ce,gwgz_bf,gwgz_ce,
				-- 职务工资补发 岗位工资 补发
					jshstg_bf,jshstg_ce,tsjytg_bf,tsjytg_ce,bltggz_bf,bltggz_ce,
				-- 教师护士提高10%-补扣发 特殊教育提高15%-补扣发 保留特岗工资-补扣发
					jsblgz_bf,jsblgz_ce,hsblgz_bf,hsblgz_ce,psxlj_bf,psxlj_ce,
				-- 中小学教师保留10%工资-补扣发 保留护士提高10%工资-补扣发 平时训练奖-补扣发
					jxgz_ce,jxgz_bf,jbt_salary_bf,jbt_salary_ce,part_total_salary_bf,part_total_salary_ce,
				-- 绩效工资-补扣发 津补贴补扣发 	小计-补扣发				
					total_salary_bf,total_salary_ce,fillNum,change_time,startMonth,endMonth)
				-- 合计-实际补扣发  补扣发月数/天数
			select ',v_i_fund_month,',\'',v_unit_id,'\',t119.c04,',@otherFillCode,',t119.c05,t126.id,t126.c02,t126.c04,
				-- 			基金月份		单位代码	单位id	  人员id	人员姓名
				concat(UNIX_TIMESTAMP(),',@otherFillCode,',\'t126\',t126.id,\'t119\',t119.id),
				-- 变动标志
					round(t119.c06*t119.c23,2),t119.c06,round(t119.c07*t119.c23,2),t119.c07,
				-- 职务工资补发 岗位工资 补发
					round(t119.c11*t119.c23,2),t119.c11,		round(t119.c12*t119.c23,2),t119.c12,	round(t119.c15*t119.c23,2),t119.c15,	
				-- 教师护士提高10%-补扣发 特殊教育提高15%-补扣发 保留特岗工资-补扣发
					round(t119.c13*t119.c23,2),t119.c13,		round(t119.c14*t119.c23,2),t119.c14,	round(t119.c16*t119.c23,2),t119.c16,
				-- 中小学教师保留10%工资-补扣发 保留护士提高10%工资-补扣发 平时训练奖-补扣发
					t119.c26,round(t119.c26*t119.c23,2),round(t119.c08*t119.c23,2),t119.c08,round(t119.c09*t119.c23,2),t119.c09,
				-- 绩效工资-补扣发 津补贴补扣发 	小计-补扣发
					t119.c22,t119.c22,t119.c23,DATE_FORMAT(t119.createDate,\'%Y-%m-%d\'),t119.c02,t119.c03
				-- 合计-实际补扣发   补扣发月数/天数
				from t119 ,t126 where  t119.c01 =t126.id 
				and t119.c04 = \'',v_unit_dataId,'\' 
				and not EXISTS (select 1 from t126,sys_s_data d where t126.c01 = \'',v_unit_dataId,'\'  and d.id = t126.c03 and t126.id = t119.c01 and d.data_value = \'2\')-- 非离休人员
				and t119.c21 = ',@noApplyAuditCode,' -- sys_s_data 月报审核状态 11208 生成基金未上报
			  	-- and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = \'1\')
			  	-- t126.c03 人员状态-码表 1-在职
			order by t119.c01 ');
			PREPARE stmt FROM @sqlstr;
			EXECUTE stmt;
			DROP PREPARE stmt;
			-- 只插入一次性补扣发详细项目
			SET @sqlstr = CONCAT('insert into ',v_table,'(fund_month,unit_code,unit_id,change_type,changetype_name,changeSign,staff_id,staff_code,staff_name,
					zwgz,zwgz_ce,zwgz_bf,gwgz,gwgz_ce,gwgz_bf,
				-- 职务工资	补发	岗位工资 补发
					jshstg,jshstg_ce,jshstg_bf,		tsjytg,tsjytg_ce,tsjytg_bf,		bltggz,bltggz_ce,bltggz_bf,	
				-- 教师护士提高10%-补扣发 特殊教育提高15%-补扣发 保留特岗工资-补扣发
					jsblgz,jsblgz_ce,jsblgz_bf,		hsblgz,hsblgz_ce,hsblgz_bf,		psxlj,psxlj_ce,psxlj_bf,
				-- 中小学教师保留10%工资-补扣发 保留护士提高10%工资-补扣发 平时训练奖-补扣发
					jxgz,jxgz_ce,jxgz_bf,jbt_salary,jbt_salary_ce,jbt_salary_bf,part_total_salary,part_total_salary_ce,part_total_salary_bf,
				-- 绩效工资-补扣发 津补贴补扣发 	小计-补扣发	
					total_salary,total_salary_ce,total_salary_bf,fillNum ,change_time,startMonth,endMonth)	
				select fund_month,unit_code,unit_id,change_type,changetype_name,changeSign,staff_id,staff_code,staff_name,
					zwgz,zwgz_ce,zwgz_bf,gwgz,gwgz_ce,gwgz_bf,
				-- 职务工资	补发	岗位工资 补发
					jshstg,jshstg_ce,jshstg_bf,		tsjytg,tsjytg_ce,tsjytg_bf,		bltggz,bltggz_ce,bltggz_bf,	
				-- 教师护士提高10%-补扣发 特殊教育提高15%-补扣发 保留特岗工资-补扣发
					jsblgz,jsblgz_ce,jsblgz_bf,		hsblgz,hsblgz_ce,hsblgz_bf,		psxlj,psxlj_ce,psxlj_bf,
				-- 中小学教师保留10%工资-补扣发 保留护士提高10%工资-补扣发 平时训练奖-补扣发
					jxgz,jxgz_ce,jxgz_bf,jbt_salary,jbt_salary_ce,jbt_salary_bf,part_total_salary,part_total_salary_ce,part_total_salary_bf,
				-- 绩效工资-补扣发 津补贴补扣发 	小计-补扣发	
					total_salary,total_salary_ce,total_salary_bf,fillNum ,change_time,startMonth,endMonth from ',v_table_cache,' where change_type = \'11264\'');
			PREPARE stmt FROM @sqlstr;
			EXECUTE stmt;
			DROP PREPARE stmt;
			
			
			SET @sqlstr = CONCAT('INSERT INTO ', v_allowance_table_cache,'(fund_month,unit_id,unit_code,changeSign,staff_id,
					jbt_id,jbt_title,salary_value,salary_sj_bf,salary_hx_bf,jbt_salary_ce)
					-- 津补贴id  津补贴名称  津补贴金额  津补贴当月实际补发 津补贴后续补发  津补贴标准时间
				select ',v_i_fund_month,',',v_unit_dataId,',\'',v_unit_id,'\',b.changeSign,t150.c05,
					-- 基金月分 	   单位id		单位代码(51036000) 人员id 
				t150.c02,t116.c03,t150.c04,round((t150.c04*t119.c23),2),0,t150.c04
				-- 津补贴id  津补贴名称 津补贴金额 津补贴当月实际补发 津补贴后续补发  津补贴标准时间
				from t119,t150,t116,',v_table,' b
				where 1=1 and t119.id = t150.c01 and t119.c04 = \'',v_unit_dataId,'\' and t119.c21 = ',@noApplyAuditCode,' 
				and t150.c02 = t116.id-- 津补贴编号
				and t119.c01=b.staff_id and t119.c05=b.changetype_name and b.change_type = ',@otherFillCode,'
				and t150.c04+0!=0 and t119.id = SUBSTR(b.changesign FROM LOCATE(\'t119\',b.changesign)+4) 
				and not EXISTS (select 1 from t126,sys_s_data d where t126.c01 = \'',v_unit_dataId,'\'  and d.id = t126.c03 and t126.id = t119.c01 and d.data_value = \'2\')-- 非离休人员
				GROUP BY t150.c01,t150.c02');
				-- group by t119.c05,t116.id
			PREPARE stmt FROM @sqlstr;
			EXECUTE stmt;
			DROP PREPARE stmt;
	
	
		end if;
	end if;
	
	
	-- 删除单位生成 基金时的临时表
	-- 插入所有补扣发（排除一次性补扣发详细项目，前面已经插入了）
	SET @sqlstr = CONCAT('insert into ',v_table,'(fund_month,unit_code,unit_id,change_type,changetype_name,changeSign,staff_id,staff_code,staff_name,
					zwgz,zwgz_ce,zwgz_bf,gwgz,gwgz_ce,gwgz_bf,
				-- 职务工资	补发	岗位工资 补发
					jshstg,jshstg_ce,jshstg_bf,		tsjytg,tsjytg_ce,tsjytg_bf,		bltggz,bltggz_ce,bltggz_bf,	
				-- 教师护士提高10%-补扣发 特殊教育提高15%-补扣发 保留特岗工资-补扣发
					jsblgz,jsblgz_ce,jsblgz_bf,		hsblgz,hsblgz_ce,hsblgz_bf,		psxlj,psxlj_ce,psxlj_bf,
				-- 中小学教师保留10%工资-补扣发 保留护士提高10%工资-补扣发 平时训练奖-补扣发
					jxgz,jxgz_ce,jxgz_bf,jbt_salary,jbt_salary_ce,jbt_salary_bf,part_total_salary,part_total_salary_ce,part_total_salary_bf,
				-- 绩效工资-补扣发 津补贴补扣发 	小计-补扣发	
					total_salary,total_salary_ce,total_salary_bf,fillNum ,change_time,startMonth,endMonth)	
				select fund_month,unit_code,unit_id,change_type,changetype_name,changeSign,staff_id,staff_code,staff_name,
					zwgz,zwgz_ce,zwgz_bf,gwgz,gwgz_ce,gwgz_bf,
				-- 职务工资	补发	岗位工资 补发
					jshstg,jshstg_ce,jshstg_bf,		tsjytg,tsjytg_ce,tsjytg_bf,		bltggz,bltggz_ce,bltggz_bf,	
				-- 教师护士提高10%-补扣发 特殊教育提高15%-补扣发 保留特岗工资-补扣发
					jsblgz,jsblgz_ce,jsblgz_bf,		hsblgz,hsblgz_ce,hsblgz_bf,		psxlj,psxlj_ce,psxlj_bf,
				-- 中小学教师保留10%工资-补扣发 保留护士提高10%工资-补扣发 平时训练奖-补扣发
					jxgz,jxgz_ce,jxgz_bf,jbt_salary,jbt_salary_ce,jbt_salary_bf,part_total_salary,part_total_salary_ce,part_total_salary_bf,
				-- 绩效工资-补扣发 津补贴补扣发 	小计-补扣发	
					total_salary,total_salary_ce,total_salary_bf,fillNum ,change_time,startMonth,endMonth from ',v_table_cache,' where change_type != \'11264\'');
	PREPARE stmt FROM @sqlstr;
	EXECUTE stmt;
	DROP PREPARE stmt;
	SET @sqlstr = CONCAT('insert into ',v_allowance_table,'	(fund_month,unit_id,unit_code,changeSign,staff_id,
			jbt_id,jbt_title,salary_value,salary_sj_bf,salary_hx_bf,jbt_salary_ce)
			select fund_month,unit_id,unit_code,changeSign,staff_id,
			jbt_id,jbt_title,salary_value,salary_sj_bf,salary_hx_bf,jbt_salary_ce from ',v_allowance_table_cache);
	PREPARE stmt FROM @sqlstr;
	EXECUTE stmt;
	DROP PREPARE stmt;
	/*
	SET @sqlstr = CONCAT('delete    a.*,c.* from fund_salary_fill_201804 a,data_record_t126 b, fund_salary_fill_subsidies_201804 c 
			where a.unit_id = b.c01 and  a.staff_id = b.dataid  and b.c01 = c.unit_id and b.dataid = c.staff_id
			and b.c01 = 32 and b.changetype = 10831 and b.fund_month = 201804');
	PREPARE stmt FROM @sqlstr;
	EXECUTE stmt;
	DROP PREPARE stmt;*/
	
	-- 删除单位生成 基金时的临时表
	SET @sqlstr = CONCAT('DROP TABLE IF EXISTS ',v_table_cache);
	PREPARE stmt FROM @sqlstr;
	EXECUTE stmt;
	DROP PREPARE stmt;
	SET @sqlstr = CONCAT('DROP TABLE IF EXISTS ', v_allowance_table_cache);
	PREPARE stmt FROM @sqlstr;
	EXECUTE stmt;
	DROP PREPARE stmt;
	
	-- 减少人员当月补扣发不计算
	/*SET @sqlstr = CONCAT("update  ",v_table," a,data_record_t126 b set a.total_salary_bf = 0 where a.unit_id = b.c01 and a.staff_id = b.dataid and 
					a.unit_id = '",v_unit_dataId,"' and b.changetype = '10831' and b.fund_month = ",v_i_fund_month);
	PREPARE stmt FROM @sqlstr;
	EXECUTE stmt;
	DROP PREPARE stmt;
	SET @sqlstr = CONCAT("update ",v_allowance_table," a,data_record_t126 b set salary_sj_bf = 0 where a.unit_id = b.c01 and a.staff_id = b.dataid and 
					a.unit_id = '",v_unit_dataId,"' and b.changetype = '10831' and b.fund_month = ",v_i_fund_month);
	PREPARE stmt FROM @sqlstr;
	EXECUTE stmt;
	DROP PREPARE stmt;

	/*update v_table set jbt_salary =cast(jbt_salary as decimal(10,2)) where fund_month = v_i_fund_month  and unit_id =v_unit_dataId ;
	update v_table set jbt_salary_bf =cast(jbt_salary_bf as decimal(10,2)) where fund_month = v_i_fund_month  and unit_id =v_unit_dataId ;
	update v_table set part_total_salary =cast(part_total_salary as decimal(10,2)) where fund_month = v_i_fund_month  and unit_id =v_unit_dataId ;
	update v_table set part_total_salary_bf =cast(part_total_salary_bf as decimal(10,2)) where fund_month = v_i_fund_month  and unit_id =v_unit_dataId ;
	update v_table set total_salary =cast(total_salary as decimal(10,2)) where fund_month = v_i_fund_month  and unit_id =v_unit_dataId ;
	update v_table set total_salary_bf =cast(total_salary_bf as decimal(10,2)) where fund_month = v_i_fund_month  and unit_id =v_unit_dataId ;
	update v_table set jbt_salary_ce =cast(jbt_salary_ce as decimal(10,2)) where fund_month = v_i_fund_month  and unit_id =v_unit_dataId ;
	update v_table set part_total_salary_ce =cast(part_total_salary_ce as decimal(10,2)) where fund_month = v_i_fund_month  and unit_id =v_unit_dataId ;
	update v_table set total_salary_ce =cast(total_salary_ce as decimal(10,2)) where fund_month = v_i_fund_month  and unit_id =v_unit_dataId ;*/
	SET @sqlstr = CONCAT('update ', v_table,' set
									zwgz = round(zwgz,2),
									zwgz_bf = round( zwgz_bf,2),
									zwgz_yf = round(zwgz_yf ,2),
									gwgz = round( gwgz,2),
									gwgz_bf = round( gwgz_bf,2),
									gwgz_yf = round(gwgz_yf ,2),
									jshstg = round( jshstg,2),
									jshstg_bf = round( jshstg_bf,2),
									jshstg_yf = round(jshstg_yf ,2),
									tsjytg = round( tsjytg,2),
									tsjytg_bf = round( tsjytg_bf,2),
									tsjytg_yf = round( tsjytg_yf,2),
									bltggz = round( bltggz,2),
									bltggz_bf = round( bltggz_bf,2),
									bltggz_yf = round( bltggz_yf,2),
									jsblgz = round(jsblgz ,2),
									jsblgz_bf = round(jsblgz_bf ,2),
									jsblgz_yf = round( jsblgz_yf,2),
									hsblgz = round( hsblgz,2),
									hsblgz_bf = round(hsblgz_bf ,2),
									hsblgz_yf = round( hsblgz_yf,2),
									psxlj = round(psxlj ,2),
									psxlj_bf = round( psxlj_bf,2),
									psxlj_yf = round(psxlj_yf ,2),
									jxgz = round( jxgz,2),
									jxgz_bf = round(jxgz_bf ,2),
									jxgz_yf = round( jxgz_yf,2),
									jbt_salary = round(jbt_salary ,2),
									jbt_salary_bf = round(jbt_salary_bf ,2),
									jbt_salary_yf = round(jbt_salary_yf ,2),
									part_total_salary = round( part_total_salary,2),
									part_total_salary_bf = round(part_total_salary_bf ,2),
									part_total_salary_yf = round(part_total_salary_yf ,2),
									jbzq_salary = round(jbzq_salary ,2),
									qitcxpkf_salary = round(qitcxpkf_salary ,2),
									nzjq_salary = round( nzjq_salary,2),
									fill_salary = round(fill_salary ,2),
									fill_salary_yf = round(fill_salary_yf ,2),
									total_salary = round(total_salary ,2),
									total_salary_bf = round(total_salary_bf ,2),
									total_salary_yf = round( total_salary_yf,2),
									total_salary_yf = round( total_salary_yf,2),
									zwgz_ce =case when  zwgz_ce REGEXP \'','^[0-9/-]','\' then round(zwgz_ce ,2) else zwgz_ce end,
									gwgz_ce = case when  gwgz_ce REGEXP \'','^[0-9/-]','\' then round( gwgz_ce,2) else gwgz_ce end ,
									jshstg_ce = case when  jshstg_ce REGEXP \'','^[0-9/-]','\' then round(jshstg_ce ,2) else jshstg_ce end,
									tsjytg_ce = case when  tsjytg_ce REGEXP \'','^[0-9/-]','\' then round( tsjytg_ce,2) else tsjytg_ce end ,
									bltggz_ce = case when  bltggz_ce REGEXP \'','^[0-9/-]','\' then round(bltggz_ce ,2) else bltggz_ce end ,
									jsblgz_ce = case when  jsblgz_ce REGEXP \'','^[0-9/-]','\' then round(jsblgz_ce,2) else jsblgz_ce end ,
									hsblgz_ce =case when  hsblgz_ce REGEXP \'','^[0-9/-]','\' then  round( hsblgz_ce,2) else hsblgz_ce end,
									psxlj_ce =case when  psxlj_ce REGEXP \'','^[0-9/-]','\' then  round(psxlj_ce ,2) else psxlj_ce end,
									jxgz_ce = case when  jxgz_ce REGEXP \'','^[0-9/-]','\' then round( jxgz_ce,2) else jxgz_ce end,
									jbt_salary_ce =case when  jbt_salary_ce REGEXP \'','^[0-9/-]','\' then  round( jbt_salary_ce,2) else jbt_salary_ce end,
									part_total_salary_ce =case when  part_total_salary_ce REGEXP \'','^[0-9/-]','\' then  round( part_total_salary_ce,2) else total_salary_ce end,
									total_salary_ce =case when  total_salary_ce REGEXP \'','^[0-9/-]','\' then  round(total_salary_ce ,2) else total_salary_ce end
									where  unit_id =\'',v_unit_dataId,'\'' );

	-- set resultMsg = concat('@sqlstr:',@sqlstr);leave label_pro;
		PREPARE stmt FROM @sqlstr;
		EXECUTE stmt;
		DROP PREPARE stmt;
	leave label_pro;
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`p_fund_addIndex`(in v_i_fund_month varchar(6),
in fundTableName varchar(50),inout resultMsg varchar(1000))
label_pro:BEGIN
/*基金生成-表添加索引*/
	
	DECLARE stempNum int(11) ;
	DECLARE sysDataBase VARCHAR(50);
	DECLARE v_table VARCHAR(50);
	-- SET v_table =  CONCAT('fund_salary_fill_',v_i_fund_month);/*处理分表存储*/
	-- SET v_allowance_table =  CONCAT('fund_salary_fill_subsidies_',v_i_fund_month);/*处理分表存储*/
	SET v_table =  CONCAT(fundTableName,'_',v_i_fund_month);/*处理分表存储*/-- fund_salary_fill_201710

	select ifnull(content,'smso') into sysDataBase from sys_s_config where enname = 'DATABASE_NAME';-- 数据库名称
	select count(1) into stempNum from information_schema.tables where table_schema = sysDataBase and TABLE_NAME = v_table;-- smso数据库里面对应的工资发放表信息
	if stempNum = 0  then -- 判断是否已经存在v_i_fund_month(如201608)的工资发放表信息
		set resultMsg = concat('表',v_table,'不存在');leave label_pro;
	end if;
		IF NOT EXISTS (SELECT * FROM information_schema.statistics WHERE table_schema=sysDataBase AND table_name = v_table AND index_name = CONCAT('fill_',v_i_fund_month,'_unitId')) THEN
			if fundTableName = 'fund_salary_fill' then -- 补扣发

				set @sqlstr = concat('ALTER  TABLE ',v_table,' ADD INDEX fill_',v_i_fund_month,'_staffId(  `staff_id`  );');
				PREPARE stmt FROM @sqlstr;
				EXECUTE stmt;
				DROP PREPARE stmt;  
				set @sqlstr = concat('ALTER  TABLE ',v_table,' ADD INDEX fill_',v_i_fund_month,'_changeSign(  `changeSign`  );'); 
				PREPARE stmt FROM @sqlstr;
				EXECUTE stmt;
				DROP PREPARE stmt; 

				

				set @sqlstr = concat('ALTER  TABLE fund_salary_fill_subsidies_',v_i_fund_month,' ADD INDEX fill_sub_',v_i_fund_month,'_staffId(  `staff_id`  );');
				PREPARE stmt FROM @sqlstr;
				EXECUTE stmt;
				DROP PREPARE stmt; 
				set @sqlstr = concat('ALTER  TABLE fund_salary_fill_subsidies_',v_i_fund_month,' ADD INDEX fill_sub_',v_i_fund_month,'_changeSign(  `changeSign`  );');
				PREPARE stmt FROM @sqlstr;
				EXECUTE stmt;
				DROP PREPARE stmt;
			end if;
		end if;
		IF NOT EXISTS (SELECT * FROM information_schema.statistics WHERE table_schema=sysDataBase AND table_name = v_table AND index_name = CONCAT('change_',v_i_fund_month,'_unitId')) THEN
				if fundTableName = 'fund_change_detail' then -- 变动花名册

					set @sqlstr = concat('ALTER  TABLE fund_change_detail_',v_i_fund_month,' ADD INDEX change_',v_i_fund_month,'_staffId(  `staff_id`  );');
					PREPARE stmt FROM @sqlstr;
					EXECUTE stmt;
					DROP PREPARE stmt;
					set @sqlstr = concat('ALTER  TABLE fund_change_detail_',v_i_fund_month,' ADD INDEX change_',v_i_fund_month,'_changeSign(  `changeSign`  );');
					PREPARE stmt FROM @sqlstr;
					EXECUTE stmt;
					DROP PREPARE stmt;  

					

					set @sqlstr = concat('ALTER  TABLE fund_change_subsidies_',v_i_fund_month,' ADD INDEX change_sub_',v_i_fund_month,'_staffId(  `staff_id`  );'); 
					PREPARE stmt FROM @sqlstr;
					EXECUTE stmt;
					DROP PREPARE stmt;  
					set @sqlstr = concat('ALTER  TABLE fund_change_subsidies_',v_i_fund_month,' ADD INDEX change_sub_',v_i_fund_month,'_changeSign(  `changeSign`  );');
					PREPARE stmt FROM @sqlstr;
					EXECUTE stmt;
					DROP PREPARE stmt;  

					
				end if;
			end if;
			IF NOT EXISTS (SELECT * FROM information_schema.statistics WHERE table_schema=sysDataBase AND table_name = v_table AND index_name = CONCAT('pay_',v_i_fund_month,'_unitId')) THEN
				if fundTableName = 'fund_salary_pay' then -- 发放表

					set @sqlstr = concat('ALTER  TABLE fund_salary_pay_',v_i_fund_month,' ADD INDEX pay_',v_i_fund_month,'_staffId(  `staff_id`  );');
					PREPARE stmt FROM @sqlstr;
					EXECUTE stmt;
					DROP PREPARE stmt;

					
			
					set @sqlstr = concat('ALTER  TABLE fund_salary_subsidies_pay_',v_i_fund_month,' ADD INDEX pay_sub_',v_i_fund_month,'_staffId(  `staff_id`  );');
					PREPARE stmt FROM @sqlstr;
					EXECUTE stmt;
					DROP PREPARE stmt; 
				end if;
			end if;
	commit;
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`p_fund_allCancel`(in v_i_fund_month varchar(6),in v_unit_id varchar(50),
in v_unit_dataId int(11),inout resultMsg varchar(1000))
label_pro:BEGIN
/*基金通过后统一撤回 data_data_record 变动记录表; --v_i_fund_month 基金月份传入参数;--v_unit_id 基金单位代码传入参数--v_unit_dataId 基金单位id*/
	declare stemNum int(11);
	declare stempNum int(11);
	declare stemParam varchar(20);
	declare stemYearMonth varchar(20);
	
	DECLARE pay_table VARCHAR(30);
	DECLARE pay_allowance_table VARCHAR(50);
	declare sysDataBase varchar(20);-- 数据库名称

	select count(1) into stemNum from fund_audit_record where unit_id = concat(v_unit_dataId,'') and fund_month = concat(v_i_fund_month,'');   
	if stemNum >= 1 then
		select ifnull(fund_status,0) into stemParam from fund_audit_record where unit_id = concat(v_unit_dataId,'') and fund_month = concat(v_i_fund_month,'');
		if stemParam != 2 then
			set resultMsg = '基金未审核通过,无需统一撤回!';
			leave label_pro; 
		end if;
	else
		set resultMsg = '';
		leave label_pro;
	end if;
	update fund_audit_record set fund_status = 10
	where unit_id = concat(v_unit_dataId,'') and fund_month = concat(v_i_fund_month,'') and fund_status = 2;
	update data_record_t126 set allAuditFlag = 10 where allAuditFlag = 2 and fund_month = concat(v_i_fund_month,'') 
	and  c01 = concat(v_unit_dataId,'') and c03 != '10372';
	update data_record_t126 a,data_record_t125 b set b.allAuditFlag = 10 
	where  a.changeSign = b.changeSign and  b.c05 = concat(v_unit_dataId,'') 
	and a.allAuditFlag = 10 ;
	update data_record_t126 a,data_record_t117 b set b.allAuditFlag = 10 
	where  a.changeSign = b.changeSign and  b.c02 = concat(v_unit_dataId,'') 
	and a.allAuditFlag = 10 ;
	select count(1) into stemNum from t119 where c20 = concat(v_i_fund_month,'') and c04=concat(v_unit_dataId,'');-- 其它一次性补扣发项目表
	if stemNum > 0 then
		update t119 ,sys_s_data d set c21 = d.id where c20 = concat(v_i_fund_month,'') and c04=concat(v_unit_dataId,'')
		and d.typename = 'ybshzt' and d.data_value = '10';-- 上报后 状态更新为 统一撤回
	end if;
	select count(1) into stemNum from t151 where c04 = concat(v_i_fund_month,'') and c01=concat(v_unit_dataId,'');-- 一次性年终奖金管理表
	if stemNum > 0 then
		update t151,sys_s_data d set c03 = d.id where c04 = concat(v_i_fund_month,'') and c01=concat(v_unit_dataId,'') 
		and d.typename = 'ybshzt' and d.data_value = '10';-- 上报后 状态更新为 统一撤回
	end if;
	
	select count(1) into stemNum from t152 where c12 = concat(v_i_fund_month,'') and c01=concat(v_unit_dataId,'');-- 警察加班补贴表
	if stemNum > 0 then
		update t152 ,sys_s_data d set c13 = d.id where c12 = concat(v_i_fund_month,'') and c01=concat(v_unit_dataId,'')
		and d.typename = 'ybshzt' and d.data_value = '10';-- 上报后 状态更新为 统一撤回
	end if;
	
	select count(1) into stemNum from t153 where c14 = concat(v_i_fund_month,'') and c01=concat(v_unit_dataId,'');-- 警察值勤津补贴表
	if stemNum > 0 then
		update t153 ,sys_s_data d set c17 = d.id where c14 = concat(v_i_fund_month,'') and c01=concat(v_unit_dataId,'')
		and d.typename = 'ybshzt' and d.data_value = '10';-- 上报后 状态更新为 统一撤回
	end if;
	
	select count(1) into stemNum from t164 where c11 = concat(v_i_fund_month,'') and c01=concat(v_unit_dataId,'');-- 艰边津补贴表
	if stemNum > 0 then
		update t164 ,sys_s_data d set c10 = d.id where c11 = concat(v_i_fund_month,'') and c01=concat(v_unit_dataId,'')
		and d.typename = 'ybshzt' and d.data_value = '10';-- 上报后 状态更新为 统一撤回
	end if;
	
	
	select content into sysDataBase from sys_s_config where enname = 'DATABASE_NAME';-- 数据库名称
	SET pay_table =  CONCAT('fund_salary_pay_',v_i_fund_month);/*处理分表存储*/
	SET pay_allowance_table =  CONCAT('fund_salary_subsidies_pay_',v_i_fund_month);/*处理分表存储*/

	select count(1) into stempNum from information_schema.tables where table_schema = sysDataBase and TABLE_NAME = pay_table;-- smso数据库里面对应的工资发放表信息
	if stempNum >0 then 
		SET @sqlstr = CONCAT('select count(1) into @monthCount from ',pay_table,' where fund_month = \'',v_i_fund_month,'\' and unit_id = \'',v_unit_dataId,'\' and status = 2 '  );						
		PREPARE stmt FROM @sqlstr;
		EXECUTE stmt;
		DROP PREPARE stmt;
		if @monthCount>0 then 
			SET @sqlstr = CONCAT('update ',pay_table,' set status = 10 where fund_month = \'',v_i_fund_month,'\' and unit_id = \'',v_unit_dataId ,'\' and status = 2 ' );						
			PREPARE stmt FROM @sqlstr;
			EXECUTE stmt;
			DROP PREPARE stmt;
		end if;
	end if;
	select count(1) into stempNum from information_schema.tables where table_schema = sysDataBase and TABLE_NAME = pay_allowance_table;-- smso数据库里面对应的津补贴发放表信息
	if stempNum  >0 then 
		SET @sqlstr = CONCAT('select count(1) into @monthCount from ',pay_allowance_table,' where fund_month = \'',v_i_fund_month,'\' and unit_id = \'',v_unit_dataId,'\' and status = 2 '  );						
		PREPARE stmt FROM @sqlstr;
		EXECUTE stmt;
		DROP PREPARE stmt;
		if @monthCount>0 then 
			SET @sqlstr = CONCAT('update ',pay_allowance_table,' set status = 10 where fund_month = \'',v_i_fund_month,'\' and unit_id = \'',v_unit_dataId ,'\' and status = 2 ' );						
			PREPARE stmt FROM @sqlstr;
			EXECUTE stmt;
			DROP PREPARE stmt;
		end if;
	end if;
commit;
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`p_fund_auditOver`(in v_i_fund_month varchar(6),in userId varchar(50),in isSalUniOut varchar(10),inout resultMsg varchar(1000))
label_pro:BEGIN
	/**
	 * 审核完毕[fundMonth]月的数据 上报财政
	 * 审核完毕点击后,默认给所有未生成基金/审核通过的基金 的单位 默认生成 当月基金,使用上次审核通过的数据
	 * @param v_i_fund_month 基金月份
	 * @param isSalUniOut 是否统发单位 1-是 0-否
	 * @param userId 操作人
	 */
	 
	declare stemNum int(11);
	declare stemParam varchar(20);
	declare stemIndex int(11);
	declare stemYearMonth varchar(20);
	declare v_unit_id varchar(20);
	declare v_unit_dataId int(11);
	
    DECLARE done INT DEFAULT FALSE;
    
	-- 所有未生成基金补扣发的变动记录(未审核通过的)
	DECLARE unidDataId_ CURSOR FOR
   SELECT t111.id from t111 
		where 1=1 
		and not exists (select 1 from fund_audit_record a where a.unit_id = t111.id and fund_month =concat(v_i_fund_month,'') and fund_status = '2') -- 排除审核通过的数据
	   and case isSalUniOut when 1 then t111.id in (select c01 from t156) else t111.id not in (select c01 from t156) end ;
 	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
	select count(1) into stemNum from t160 where c01 = concat(v_i_fund_month,'') and c02 in (select id from sys_s_data where typename = 'is' and data_value = isSalUniOut);
	if stemNum > 0 then -- 当月已经审核完毕此(统发/非统发的数据)
		if isSalUniOut = 1 then 
			set resultMsg = concat('统发单位',v_i_fund_month,'月已经上报财政,不能再次操作');leave label_pro;
		else 
			set resultMsg = concat('非统发单位',v_i_fund_month,'月已经上报财政,不能再次操作');leave label_pro;
		end if; 
	end if;
	select count(1) into stemNum from t111 
		where 1=1 
		and not exists (select 1 from fund_audit_record a where a.unit_id = t111.id and fund_month =concat(v_i_fund_month,'') and fund_status = '2') -- 排除审核通过的数据
	  and case isSalUniOut when 1 then t111.id in (select c01 from t156) else t111.id not in (select c01 from t156) end ;
	
	if stemNum = 0 then -- 如果不存在需要自动生成基金的单位数据
		leave label_pro; 
	end if;
	set stemIndex = 0 ;
	OPEN unidDataId_;  
		-- 开始循环
	read_loop: LOOP
		 -- 提取游标里的数据，这里只有一个，多个的话也一样；
		FETCH unidDataId_ INTO v_unit_dataId;
		-- 声明结束的时候
		IF done THEN
			LEAVE read_loop;
		END IF;
		select c01 into v_unit_id from t111 where id = v_unit_dataId;
		select count(1) into  stemParam from  fund_audit_record where unit_id = concat(v_unit_dataId,'') 
		and fund_month <= v_i_fund_month and fund_status = '2'
		order by fund_month desc limit 0,1;
		if stemParam > 0 then 
			call no_record_fund(v_i_fund_month,v_unit_id,v_unit_dataId,resultMsg); -- 默认算没有变动记录时生成月报数据
	
			set stemIndex = stemIndex + 1;
			if resultMsg and ''!= resultMsg then 
				leave label_pro;
			end if;
		end if;
	END LOOP;
	CLOSE unidDataId_;
commit;
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`p_fund_checkPerson`(in v_i_fund_month varchar(6),in v_unit_id varchar(50),
in v_unit_dataId int(11),inout resultMsg varchar(1000))
label_pro:BEGIN	
/*单位人员月报申请前 检查所有人员的学习简历,任职简历是否填写了的*/
/*
	1. 当前单位人员必须存在学习简历
	2. 人员非试用期 必须存在 任职简历,若此人试用期本来就在此系统里添加的,可以没有任职简历
*/
	DECLARE stemNum int(11);-- 参数变量 while循环的
	DECLARE stemIndex int(11);-- 参数变量
	DECLARE stemPersonId int(11);-- 人员id参数
	DECLARE personName varchar(20);-- 姓名

  	DECLARE done INT DEFAULT FALSE;
	-- 所有当前单位下面的人员id
	DECLARE person_ CURSOR FOR
   	SELECT t126.id from  t126
		where 1=1 
		and t126.c01 = concat(v_unit_dataId,'') 
		and t126.dataclassCode = 't126'
	  and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
	  and not exists(select 1 from t122 where t122.c02 = t126.id) -- 查询人员学习简历
	  ;
 	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
	
	set stemIndex = 0;
	set resultMsg = 'resultMsg:';
	OPEN person_;  
		 -- 开始循环
		 read_loop: LOOP
		 -- 提取游标里的数据，这里只有一个，多个的话也一样；
		 FETCH person_ INTO stemPersonId;
		 -- 声明结束的时候
		IF done THEN
		    LEAVE read_loop;
		END IF;
    	set stemIndex = stemIndex + 1;
    	select t126.c04 into personName from t126 where id = stemPersonId;
    	set resultMsg = concat(resultMsg,personName,',');
	END LOOP;
 	 -- 关闭游标
  	CLOSE person_;
  	if stemIndex > 0 then 
	  	set resultMsg = concat(resultMsg,',');-- resultMsg:张三,李四,,
	  	set resultMsg = replace(resultMsg,',,','');-- resultMsg:张三,李四
	  	set resultMsg = replace(resultMsg,'resultMsg:','');-- 张三,李四
		set resultMsg = concat('人员[',resultMsg,']无学习简历,请完善后再进行月结算操作!');-- 人员[张三,李四]无学习简历,请完善后再进行月结算操作!
	  	leave label_pro;
	else 
		set resultMsg = '';leave label_pro;
	end if;
	
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`p_fund_checkRecord`(in v_i_fund_month varchar(6),in v_unit_id varchar(50),in v_unit_dataId int(11),inout resultMsg varchar(1000))
label_pro:BEGIN	
/*单位人员月报申请前 检查所有变动记录是否符合要求*/
/*
	1. 当前单位人员变动起薪时间必须小于此人在系统第一条变动记录的起薪时间之后
	2. 重新确定工资后,以后的所有变动起薪时间不能超过这个时间.
	3. 当前存在重新确定工资,且此前有未审核通过的变动的话不能生成月报
	4. 晋级晋档一年也只能做一次
*/
	DECLARE stemNum int(11);-- 参数变量 while循环的
	DECLARE stemIndex int(11);-- 参数变量
	DECLARE stemPersonId int(11);-- 人员id参数
	DECLARE personName varchar(20);-- 姓名
	DECLARE firstQxsj varchar(20);-- 第一次起薪时间
	DECLARE changeTypeName varchar(20);-- 变动类型名称
	DECLARE qxsj varchar(20);-- 起薪时间

  	DECLARE done INT DEFAULT FALSE;
	-- 所有当前单位下面的人员id
	DECLARE person_ CURSOR FOR
   	SELECT t126.id from t126 join data_record_t126 t126_r on t126.id = t126_r.dataId
		where 1=1 
		and t126.c01 = concat(v_unit_dataId,'') 
		and t126.dataclassCode = 't126' and t126_r.dataclassCode = 't126'
	  and ifnull(t126_r.allAuditFlag,'')!= '2'
	  and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
	  ;
 	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
	
	set stemIndex = 0;
	set @stemIndex = 0;
	OPEN person_;  
		  -- 开始循环
		  read_loop: LOOP
		    -- 提取游标里的数据，这里只有一个，多个的话也一样；
		    FETCH person_ INTO stemPersonId;
		    -- 声明结束的时候
		    IF done THEN
		      LEAVE read_loop;
		    END IF;
		    set @done = done;
    		select count(1) into stemNum from data_record_t126 where dataclassCode = 't126' 
    		and dataId = stemPersonId and ifnull(allAuditFlag,'')!= '2'; -- 当前人员
    		-- set resultMsg = concat('stemNum:',stemNum);leave label_pro;
		    if stemNum > 0 then
		    	-- 第一次起薪时间
		    	set @firstQxsj = '';
		    	select t125.c02 into @firstQxsj from data_record_t126 t126,data_record_t125 t125 
				where  t126.changeSign = t125.changeSign
				and t126.dataclassCode = 't126' and t125.dataclassCode = 't125' 
				and t126.dataId = stemPersonId and t125.c06 = t126.dataId limit 0,1;
				
		    	select c04 into @personName from t126 where id = stemPersonId; -- 人员姓名
				set @qxsj = '';
		    	select t125.c02 into @qxsj from data_record_t126 t126,data_record_t125 t125 
		    	where  -- t126.dataclassCode = 't126' and t125.dataclassCode = 't125'
		    	-- and 
		    	 t126.changeSign = t125.changeSign
	    		 and ifnull(t126.perAuditFlag,'')!='2' and t126.dataId = stemPersonId
	    		 and t126.dataId = t125.c06 
	    		 and t125.c02 < @firstQxsj
	    		 limit 0,1; -- 起薪时间 早于第一次起薪
	    		 -- set resultMsg = concat('@qxsj:',@qxsj);leave label_pro;
		    	if @qxsj!=null and @qxsj!='' then -- 起薪时间 早于第一次起薪
		    		set stemIndex = stemIndex+1;
					set resultMsg = concat(resultMsg,'[',@personName,':变动起薪时间',@qxsj,'早于最早起薪时间',@firstQxsj,']');
		    	else
		    		select count(1) into stemNum from data_record_t126 t126 ,data_record_t125 t125
			    	where  -- t126.dataclassCode = 't126' and t125.dataclassCode = 't125'
			    	-- and
			    	 t126.changeSign = t125.changeSign
			    	 and t126.dataId = stemPersonId and t125.c06 = t126.dataId 
			    	 and t126.changeType in(select id from sys_s_data d where d.typename = 'bdlx' and data_value like '01%')
			    	 order by t125.id desc 
			    	 limit 0,1;-- 重新确定工资
					if stemNum > 0 then 
				    	select t125.c02 into firstQxsj from data_record_t126 t126 ,data_record_t125 t125
				    	where --  t126.dataclassCode = 't126' and t125.dataclassCode = 't125'
				    	 t126.changeSign = t125.changeSign
				    	 and t126.dataId = stemPersonId and t125.c06 = t126.dataId 
				    	 and t126.changeType in(select id from sys_s_data d where d.typename = 'bdlx' and data_value like '01%')
				    	 order by t125.id desc 
				    	 limit 0,1;-- 重新确定工资
						select count(1) into stemNum from data_record_t126 t126 ,data_record_t125 t125
						where t126.dataclassCode = 't126' and t125.dataclassCode = 't125'
				    	 and t126.dataId = stemPersonId and t125.c06 = t126.dataId and ifnull(t126.perAuditFlag,'') !='2'
				    	 and t125.c02 < firstQxsj;
				    	 if stemNum > 0 then 
				    		set stemIndex = stemIndex+1;
							set resultMsg = concat(resultMsg,'[',personName,':重新确定工资时间',firstQxsj,'之前存在其它变动起薪时间',qxsj,']');
				    	 end if;
					end if;
					
			    	select count(1) into stemNum from data_record_t126 t126 ,data_record_t125 t125
			    	where -- t126.dataclassCode = 't126' and t125.dataclassCode = 't125'
			    	 t126.dataId = stemPersonId and t125.c06 = t126.dataId and t126.allAuditFlag ='2'
			    	 and t126.changeType in(10851,10852,10853,10854,11309,11317) and t126.changeSign = t125.changeSign ;
			    	 -- 10851-晋升级别,10852-晋升档次,10853-工人晋升岗位,10854-事业晋升薪级, 11309-机关正常晋升法官检察官档次 11317-事业运动员正常晋升基础津贴
				    if stemNum > 0 then -- 晋升工资
				    	select t125.c02,t126.changeType  into firstQxsj,changeTypeName from data_record_t126 t126 ,data_record_t125 t125
				    	where -- t126.dataclassCode = 't126' and t125.dataclassCode = 't125' 
				    	t126.changeSign = t125.changeSign
				    	 and t126.dataId = stemPersonId and t125.c06 = t126.dataId and t126.allAuditFlag ='2'
				    	 and t126.changeType in(10851,10852,10853,10854,11309,11317)
				    	 order by t125.id desc 
				    	 limit 0,1;
				    	 -- 10851-晋升级别,10852-晋升档次,10853-工人晋升岗位,10854-事业晋升薪级, 11309-机关正常晋升法官检察官档次 11317-事业运动员正常晋升基础津贴
				    	 set qxsj= '';
				    	select t125.c02 into qxsj from data_record_t126 t126 ,data_record_t125 t125
				    	where -- t126.dataclassCode = 't126' and t125.dataclassCode = 't125'
				    	t126.changeSign = t125.changeSign
				    	 and t126.dataId = stemPersonId and t125.c06 = t126.dataId and ifnull(t126.allAuditFlag,'') !='2'
				    	 and t126.changeType in(10851,10852,10853,10854,11309,11317)
				    	 order by t125.id desc 
				    	 limit 0,1;
				    	 -- 10851-晋升级别,10852-晋升档次,10853-工人晋升岗位,10854-事业晋升薪级 11309-机关正常晋升法官检察官档次 11317-事业运动员正常晋升基础津贴
				    	select PERIOD_DIFF(ifnull(qxsj,1),ifnull(firstQxsj,0)) into stemNum;
				    	if stemNum = 0 then 
				    		select name into changeTypeName from sys_s_data where id = changeTypeName;
				    		set stemIndex = stemIndex+1;
							set resultMsg = concat(resultMsg,'[',personName,':变动起薪时间',qxsj,'已经存在',changeTypeName,']');
				    	end if;
					end if;
				end if;
		   end if;
		set done = @done;
		set @stemIndex = @stemIndex+1;
	END LOOP;
 	 -- 关闭游标
  	CLOSE person_;
  	leave label_pro;
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`p_fund_clearByyb`(in v_start_fund_month varchar(6),in v_end_fund_month varchar(6),
in v_unit_dataId int(11),inout resultMsg varchar(1000))
label_pro:BEGIN
/*基金删除后  清空变动记录表,相关补扣发表的基金状态 p_fund_clean
data_data_record 变动记录表; --v_i_fund_month 基金月份传入参数;--v_unit_id 基金单位代码传入参数--v_unit_dataId 基金单位id*/
	declare stemNum int(11);
	declare sTempNum int(11);
	declare stemParam varchar(20);
	declare qxsj varchar(20);
	declare stemYearMonth varchar(20);
	
	declare sysDataBase varchar(20);-- 数据库名称
	DECLARE jjqxMonth int(11) DEFAULT 0;-- 变动时间对应的下月(基金月份)-(减去)起薪时间的月份 201606变动-201505起薪 结果: 12+1+1=14 201607月份发工资 补发 201607-201505个月  14个月
	
	select ifnull(content,'smso') into sysDataBase from sys_s_config where enname = 'DATABASE_NAME';-- 数据库名称
	if sysDataBase is null then 
		set sysDataBase = 'smso';
	end if;
	select PERIOD_DIFF(v_end_fund_month,v_start_fund_month) into jjqxMonth;-- 基金月份 与起薪时间差
	set stemYearMonth = concat(v_start_fund_month,'01');
	set sTempNum = 0; 
	if jjqxMonth > 0 then 
		while sTempNum<jjqxMonth DO	
			-- 按月份进行删除  （如果是录入新进人员则删除，如果不是，则更新，将本月应补设为0）
			set stemYearMonth =  DATE_FORMAT(DATE_ADD(concat(v_start_fund_month,'01') ,INTERVAL sTempNum MONTH),'%Y%m%d');

			set @sTempYMonth = DATE_FORMAT(stemYearMonth,'%Y%m');-- 起始月份 +0/1/2/3 

			select count(1) into @sTempNum from information_schema.tables where table_schema = sysDataBase and TABLE_NAME = concat('fund_salary_pay_',@sTempYMonth);-- smso数据库里面对应的工资变动表信息
			SET @pay_table =  CONCAT('fund_salary_pay_',@sTempYMonth);/*工资发放表*/

			SET @pay_allowance_table =  CONCAT('fund_salary_subsidies_pay_',@sTempYMonth);/*工资发放-津补贴表*/
			
			if @sTempNum > 0 then 
				-- 删除此月起薪的人员的发放表情况
				SET @sqlstr = CONCAT('delete from ',@pay_table,' where unit_id =\'',v_unit_dataId,'\' and fund_month = \'',@sTempYMonth,'\' 
						and EXISTS(select 1 from data_record_t126 t126,data_record_t125 as t125 where 
						 t126.c01 = \'',v_unit_dataId,'\' and t125.changeSign = t126.changeSign 
						 and replace(t125.c02,\'-\',\'\') <= \'',@sTempYMonth,'\'  and t125.changeType in (10750,10832) 
						 and staff_id = t126.dataId and t126.allauditflag != \'2\'
						)' );		
				PREPARE stmt FROM @sqlstr;
				EXECUTE stmt;
				DROP PREPARE stmt;

				SET @sqlstr = CONCAT('update ', @pay_table,' set   
						-- 清空所有最新一次的补扣发金额,确保下一个月再做变动,月结申报时数据是0
						zwgz_byyb= 0,gwgz_byyb=0,
						-- 职务/技术等级工资	级别岗位级别工资
						jshstg_byyb = 0,tsjytg_byyb=0,bltggz_byyb = 0,
						--  教师护士提高 特殊教育提高 保留特岗工资
						jsblgz_byyb=0, hsblgz_byyb = 0,
						-- 中小学教师保留  保留护士提高
						psxlj_byyb=0, jxgz_byyb = 0,
						-- 平时训练奖 绩效工资
						jbt_salary_byyb=0,part_total_salary_byyb = 0,total_salary_byyb=0
						-- 津补贴 	 小计 合计
						where unit_id = \'',v_unit_dataId,'\'');
				PREPARE stmt FROM @sqlstr;
				EXECUTE stmt;
				DROP PREPARE stmt;
				
				-- 删除此有起薪的人员的发放-津补贴表情况 
				SET @sqlstr = CONCAT('delete from ',@pay_allowance_table,' where unit_id = \'',v_unit_dataId,'\' and  fund_month = ',@sTempYMonth,'  
						and EXISTS(select 1 from data_record_t126 t126,data_record_t125 as t125 where 
						 t126.c01 = \'',v_unit_dataId,'\' and t125.changeSign = t126.changeSign 
						 and replace(t125.c02,\'-\',\'\') <= \'',@sTempYMonth,'\' and t125.changeType in (10750,10832) 
						 and staff_id = t126.dataId and t126.allauditflag != \'2\'
						)' );							
				PREPARE stmt FROM @sqlstr;
				EXECUTE stmt;
				DROP PREPARE stmt;
				
				SET @sqlstr = CONCAT('update ', @pay_allowance_table,' set   
						-- 清空所有最新一次的补扣发金额,确保下一个月再做变动,月结申报时数据是0
						salary_byyb= 0
						where unit_id = \'',v_unit_dataId,'\'');
				PREPARE stmt FROM @sqlstr;
				EXECUTE stmt;
				DROP PREPARE stmt;

			end if;
	
			set sTempNum = sTempNum + 1;
		end while;
	end if;
commit;
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`p_fund_commit`(in v_i_fund_month varchar(6),in v_unit_id varchar(50),
in v_unit_dataId int(11),in nickName varchar(50),inout resultMsg varchar(1000))
label_pro:BEGIN
/*基金上报 data_data_record 变动记录表; --v_i_fund_month 基金月份传入参数;--v_unit_id 基金单位代码传入参数--v_unit_dataId 基金单位id*/
	declare stemNum int(11);
	declare stemParam varchar(20);
	declare stemYearMonth varchar(20);
	select count(1) into stemNum from fund_audit_record where unit_id = concat(v_unit_dataId,'') and fund_month = concat(v_i_fund_month,'');   
	if stemNum >= 1 then
		select fund_status into stemParam from fund_audit_record where unit_id = concat(v_unit_dataId,'') and fund_month = v_i_fund_month;
		if stemParam = 2 then
			set resultMsg = '基金已经通过,不能重复上报!';
			leave label_pro; 
		end if;
		if stemParam = 3 then
			set resultMsg = '基金未审核通过,请删除后重新生成上报!';
			leave label_pro; 
		end if;
		if stemParam = 1 then
			set resultMsg = '基金已经上报待审核中,请不要重复上报!';
			leave label_pro; 
		end if;
		if stemParam = 7 then
			set resultMsg = '基金正在撤回过程中!';
			leave label_pro; 
		end if;
		if stemParam = 8 then
			set resultMsg = '基金已经撤回,请删除后重新生成上报!';
			leave label_pro; 
		end if;
	end if;	
	-- call p_all_fund(v_i_fund_month,v_unit_id,v_unit_dataId,resultMsg); 报错信息不对 暂时在程序后台重新生成
	if resultMsg and ''!=resultMsg then
		leave label_pro; 
	end if;
	update fund_audit_record set fund_status = 1,firstFlag='1',secondFlag='1',thirdFlag='1',forthFlag='1',fiveFlag='1',sixFlag='1',fund_status='1',
	 commitPerson = nickName 
	where unit_id = concat(v_unit_dataId,'') and fund_month = concat(v_i_fund_month,'');
	call fundRecordApply(v_i_fund_month,v_unit_dataId,resultMsg);-- 调用 变动记录上报状态修改过程
	if resultMsg and ''!= resultMsg then 
		leave label_pro;
	end if;
	
	-- 其它一次性补扣发项目表
	select count(1) into stemNum from t119 where c20 = concat(v_i_fund_month,'') and c04=concat(v_unit_dataId,'');
	if stemNum > 0 then
		update t119 ,sys_s_data d set c21 = d.id where c20 = concat(v_i_fund_month,'') and c04=concat(v_unit_dataId,'')
		and EXISTS (select 1 from t126,sys_s_data d where d.id = t126.c03 and t126.id = t119.c01 and d.data_value != '2')-- t126.c03 人员状态-码表 1-在职
		and d.typename = 'ybshzt' and d.data_value = '1';-- 上报后 状态更新为 待审核
	end if;
	
	-- 一次性年终奖金管理表
	select count(1) into stemNum from t151 where c04 = concat(v_i_fund_month,'') and c01=concat(v_unit_dataId,'');
	if stemNum > 0 then
		update t151,sys_s_data d set c03 = d.id where c04 = concat(v_i_fund_month,'') and c01=concat(v_unit_dataId,'') 
		and d.typename = 'ybshzt' and d.data_value = '1';-- 上报后 状态更新为 待审核
	end if;
	
	-- 警察加班补贴
	select count(1) into stemNum from t152 where c01 = concat(v_unit_dataId,'') and c12=concat(v_i_fund_month,'');
	if stemNum > 0 then
		update t152 ,sys_s_data d set t152.c13 = d.id
		 where t152.c01 = concat(v_unit_dataId,'') and t152.c12=concat(v_i_fund_month,'') and t152.c13 != 11204 -- sys_s_data 11204 月报审核状态 -审核通过 
		and EXISTS (select 1 from t126,sys_s_data d where d.id = t126.c03 and t126.id = t152.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
		and d.typename = 'ybshzt' and d.data_value= '1' ; -- 上报后 状态更新为 待审核
	end if;
	
	-- 警察执勤津补贴
	select count(1) into stemNum from t153 where c01 = concat(v_unit_dataId,'') and c14=concat(v_i_fund_month,'');
	if stemNum > 0 then
		update t153 ,sys_s_data d set t153.c17 = d.id
		 where t153.c01 = concat(v_unit_dataId,'') and c14=concat(v_i_fund_month,'') and t153.c17 != 11204 -- sys_s_data 11204 月报审核状态 -审核通过 
		and EXISTS (select 1 from t126,sys_s_data d where d.id = t126.c03 and t126.id = t153.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
		and d.typename = 'ybshzt' and d.data_value= '1' ; -- 上报后 状态更新为 待审核
	end if;
	
	
	-- 艰边津贴补扣发
	select count(1) into stemNum from t164 where c01 = concat(v_unit_dataId,'') and c11=concat(v_i_fund_month,'');
	-- 月报审核状态  0-未处理 1-待审核 2-通过 3-未通过 7-撤回申请中 8-撤回 9-生成基金未上报
	if stemNum > 0 then
		update t164 ,sys_s_data d set t164.c10 = d.id
		 where t164.c01 = concat(v_unit_dataId,'') and t164.c11=concat(v_i_fund_month,'') and t164.c10 != 11204 -- sys_s_data 11204 月报审核状态 -审核通过 
 		and EXISTS (select 1 from t126,sys_s_data d where d.id = t126.c03 and t126.id = t164.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
		and d.typename = 'ybshzt' and d.data_value= '1' ; -- 上报后 状态更新为 待审核
	end if;
	
commit;
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`p_fund_delete`(in v_i_fund_month varchar(6),in v_unit_id varchar(50),
in v_unit_dataId int(11),inout resultMsg varchar(1000))
label_pro:BEGIN
/*基金删除后  清空变动记录表,相关补扣发表的基金状态 p_fund_clean
data_data_record 变动记录表; --v_i_fund_month 基金月份传入参数;--v_unit_id 基金单位代码传入参数--v_unit_dataId 基金单位id*/
	declare stemNum int(11);
	declare sTempNum int(11);
	declare stemParam varchar(20);
	declare qxsj varchar(20);
	declare stemYearMonth varchar(20);
	
	declare min_month varchar(20);-- 变动记录最早补扣发月份 
	
	DECLARE sTemRecordId int(11);
	
	declare sysDataBase varchar(20);-- 数据库名称
	DECLARE jjqxMonth int(11) DEFAULT 0;-- 变动时间对应的下月(基金月份)-(减去)起薪时间的月份 201606变动-201505起薪 结果: 12+1+1=14 201607月份发工资 补发 201607-201505个月  14个月
	
	select min(t125.c02) into min_month 
	from data_record_t126 t126 ,data_record_t125 t125
	where t126.c01 = concat(v_unit_dataId,'') 
	and  t126.changeSign = t125.changeSign 
	
	and t126.allAuditFlag != 2 
	and not exists(select 1 from sys_s_data d where d.id = t126.c03 and d.typename = 'staffStatus' and d.data_value = '2')
	-- 非离休人员
	;

	if(LOCATE('-',v_i_fund_month)>0)then 
		set	v_i_fund_month =REPLACE(v_i_fund_month,'-','');
	end if;
	set v_i_fund_month = SUBSTRING(v_i_fund_month,1,6);
	if(LOCATE('-',min_month)>0)then 
		set	min_month =REPLACE(min_month,'-','');
	end if;
	set min_month = SUBSTRING(min_month,1,6);
	
	
	select ifnull(content,'smso') into sysDataBase from sys_s_config where enname = 'DATABASE_NAME';-- 数据库名称
	if sysDataBase is null then 
		set sysDataBase = 'smso';
	end if;
	set @auditFlag = 0;
  	if resultMsg = '6' then 
  		set @auditFlag = 6; 
  		set resultMsg = '';
  	end if;
	select count(1) into stemNum from fund_audit_record where unit_id = concat(v_unit_dataId,'') and fund_month = concat(v_i_fund_month,'');   
	if stemNum >= 1 then
		select ifnull(fund_status,0) into stemParam from fund_audit_record where unit_id = concat(v_unit_dataId,'') and fund_month = concat(v_i_fund_month,'');
		if stemParam = 2 then
			set resultMsg = '基金已经审核通过,不能删除或重新申报!';
			leave label_pro; 
		end if;
	end if;
	delete from fund_total_person_ins where unit_Id = v_unit_dataId and fund_month = v_i_fund_month;
	call p_fund_clearByyb(min_month,v_i_fund_month,v_unit_dataId,resultMsg);-- 先清除所有的补扣发的本月应补
		update data_record_t126 set allAuditFlag =@auditFlag ,data_record_t126.fund_month = '' 
	where c01 = concat(v_unit_dataId,'') and  ifnull(allAuditFlag,'')!=2
	and not exists(select 1 from sys_s_data d where d.id = data_record_t126.c03 and d.typename = 'staffStatus' and d.data_value = '2')
	;-- 非离休人员
-- and fund_month = v_i_fund_month   删除基金清除变动记录全部审核状态

	update data_record_t126 a,data_record_t125 b set b.allAuditFlag = @auditFlag  , b.fund_month = '' 
	where a.c01 = concat(v_unit_dataId,'') and b.c05 = concat(v_unit_dataId,'')  and a.changeSign = b.changeSign 
	and a.allAuditFlag = @auditFlag ;
	update data_record_t126 a,data_record_t117 b set b.allAuditFlag = @auditFlag  , b.fund_month = '' 
	where a.c01 = concat(v_unit_dataId,'') and  b.c02 = concat(v_unit_dataId,'') and a.changeSign = b.changeSign 
	and a.allAuditFlag = @auditFlag ;
	select count(1) into stemNum from t119 where c20 = concat(v_i_fund_month,'') and c04=concat(v_unit_dataId,'');-- 其它一次性补扣发项目表
	if stemNum > 0 then
		update t119 ,sys_s_data d set c21 = d.id,c20='' 
		where c20 = concat(v_i_fund_month,'') and c04=concat(v_unit_dataId,'')
		and d.typename = 'ybshzt' and d.data_value ='0'
		and not exists(select 1 from t126 where t126.id = t119.c01 and t126.c03 = '10372')
		;-- 非离休人员  上报后 状态更新为  未处理
	end if;
	select count(1) into stemNum from t151 where c04 = concat(v_i_fund_month,'') and c01=concat(v_unit_dataId,'');-- 一次性年终奖金管理表
	if stemNum > 0 then
		update t151,sys_s_data d set c03 = d.id,c04 = '' where c04 = concat(v_i_fund_month,'') and c01=concat(v_unit_dataId,'') 
		and d.typename = 'ybshzt' and d.data_value ='0'
		; --   上报后 状态更新为  未处理
	end if;
	
	select count(1) into stemNum from t152 where c12 = concat(v_i_fund_month,'') and c01=concat(v_unit_dataId,'');-- 警察加班补贴表
	if stemNum > 0 then
		update t152 ,sys_s_data d set c13 = d.id,c12 = '' where c12 = concat(v_i_fund_month,'') and c01=concat(v_unit_dataId,'')
		and d.typename = 'ybshzt' and d.data_value ='0'
		;-- 上报后 状态更新为  未处理
	end if;
	
	select count(1) into stemNum from t153 where c14 = concat(v_i_fund_month,'') and c01=concat(v_unit_dataId,'');-- 警察值勤津补贴表
	if stemNum > 0 then
		update t153 ,sys_s_data d set c17 = d.id,c14 = '' where c14 = concat(v_i_fund_month,'') and c01=concat(v_unit_dataId,'')
		and d.typename = 'ybshzt' and d.data_value ='0'
		;--   上报后 状态更新为  未处理
	end if;
	
	select count(1) into stemNum from t164 where c11 = concat(v_i_fund_month,'') and c01=concat(v_unit_dataId,'');-- 艰边津补贴表
	if stemNum > 0 then
		update t164 ,sys_s_data d set c10 = d.id,c11 = ''  where c11 = concat(v_i_fund_month,'') and c01=concat(v_unit_dataId,'')
		and d.typename = 'ybshzt' and d.data_value ='0'
		;--   上报后 状态更新为  未处理
	end if;
		SET @sqlstr = CONCAT('drop table if exists fund_salary_fill_',v_unit_dataId );
		PREPARE stmt FROM @sqlstr;
		EXECUTE stmt;
		DROP PREPARE stmt;
	SET @sqlstr = CONCAT('drop table if exists fund_salary_fill_subsidies_',v_unit_dataId );
		PREPARE stmt FROM @sqlstr;
		EXECUTE stmt;
		DROP PREPARE stmt;
commit;
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`p_fund_updateFlag`(IN orgId varchar(200),
INOUT resultMsg varchar(1000) CHARSET utf8)
label_pro:BEGIN	
-- 修改
	select count(1) into @stemFundNum from fund_audit_record 
	WHERE unit_id = orgId and ifnull(fund_status,'')!='2';
	if @stemFundNum>0 then -- 变动后更新基金isUPdateFund=1
    	select fund_Month into @fundMonth from fund_audit_record  WHERE unit_id = orgId and ifnull(fund_status,'')!='2' limit 1;
    	update fund_audit_record set isUpdateFund = 1 
 		where fund_month = @fundMonth and unit_id = orgId;
	end if;			
END;

CREATE DEFINER = `root`@`localhost` PROCEDURE `smso-migration-v2`.`p_getTgInit_ds`(IN orgId varchar(200),
INOUT resultMsg varchar(1000) CHARSET utf8)
label_pro:BEGIN	
-- 地税 根据人员任职简历获取人员初始套改时的现任职级,是否领导
	DECLARE personId varchar(20);-- 人员编号 
	DECLARE personName varchar(20);-- 人员编号 
	DECLARE rzsj varchar(20);-- 任职时间 
	DECLARE sjzj varchar(20);-- 实际职级
	DECLARE zz varchar(20);-- 职级
	DECLARE sfld varchar(20);-- 是否领导

	DECLARE tg_rysf varchar(20);-- 套改-人员身份
	DECLARE tg_sfld varchar(20);-- 套改-是否领导
	DECLARE tg_xrzj varchar(20);-- 套改-现任职级


	DECLARE stemIndex int(11) default 0 ;-- 条数
	

	DECLARE done INT DEFAULT FALSE;   
    
	DECLARE personId_ CURSOR FOR
   SELECT distinct t126.id 
	 from t126 join t121 on t126.id = t121.c02
	join sys_s_data d on d.id = t121.c06
	where t126.c01 = concat(orgId,'')    
	and exists(select 1 from t131 where t131.c01 = t126.id and ifnull(t131.c33,'')='' ) -- 已经存在套改数据 但是 没有现任职级   
	order by t126.id 
	;
 	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
	set stemIndex= 0;
 OPEN personId_;  
  -- 开始循环
  read_loop: LOOP
    -- 提取游标里的数据，这里只有一个，多个的话也一样；
    FETCH personId_ INTO personId;
    -- 声明结束的时候
    IF done THEN
      LEAVE read_loop;
    END IF;
	set @doneF = done;
	set tg_xrzj='',tg_sfld = '';
	select c39 into @gzbzlb from t126 where id = personId; -- 工资标准类别 
	select count(DISTINCT c06) into @stemNum from t121 where c01=personId 
	and c07<'2006-07-01';
	if  @stemNum > 0 then 
		-- 2006年前参加工作	
		select	
		t121.c07 as rzsj,d.name as sjzj,
		if(position('非领导' in d.name)>0 ,
		concat(SUBSTR(d.name FROM 1 FOR position('非领导' in d.name)-1)),
		concat(SUBSTR(d.name FROM 1 FOR position('领导' in d.name)-1))) as zz,
		if(position('非领导' in d.name)>0 ,
		'非领导职务',
		'领导职务') as sfld  
		 into rzsj,sjzj,zz,sfld
		 from t126 join t121 on t126.id = t121.c02
		join sys_s_data d on d.id = t121.c06
		where t126.id =personId 
		and t121.c07<'2006-07-01' order by t121.c07+0 desc
		 limit 1 ;
		if tg_xrzj='' THEN
			set tg_xrzj = zz,tg_sfld=ifnull(sfld,'');	
			if tg_xrzj = '' then 
				set tg_xrzj = sjzj;
			end if;
			-- 首先匹配 现任职级  是否领导
			select count(1) into @c 
			from t127 where c04 = tg_sfld 
			and c05 = tg_xrzj and c01 = '2006-07-01'
			and c08 = @gzbzlb;
			set @gzbzId = 0;
			set @sqlstr = '';
			if @c = 0 then 
				-- 匹配职级
				select count(1) into @c 
				from t127 where 1=1
				and c05 = tg_xrzj and c01 = '2006-07-01'
				and c08 = @gzbzlb;
				set @gzbzId = 0;
			else 
				set @sqlstr = concat('select id into @gzbzId 
				from t127 where c04 = \'',tg_sfld,'\'
				and c05 = \'',tg_xrzj,'\' and c01 = \'2006-07-01\' limit 1');
			end if;
			if @c = 0 then 
				-- 匹配职级
				select count(1) into @c 
				from t127 where  c04 = tg_sfld and c05 = concat(tg_xrzj,'岗位') and c01 = '2006-07-01'
				and c08 = @gzbzlb;
				set @gzbzId = 0;
			else 
				if @sqlstr = '' then 
					set @sqlstr = concat('select id into @gzbzId 
					from t127 where 1=1 
					and c05 = \'',tg_xrzj,'\' and c01 = \'2006-07-01\' limit 1');
				end if;
			end if;
			if @c = 0 then 
				-- 匹配职级
				select count(1) into @c 
				from t127 where c05 = concat(tg_xrzj,'岗位') and c01 = '2006-07-01'
				and c08 = @gzbzlb;
				set @gzbzId = 0;
				
				set @sqlstr = concat('select id into @gzbzId 
				from t127 where 1=1
				and c05 = concat(\'',tg_xrzj,'\',\'岗位\') and c01 = \'2006-07-01\' limit 1');
			else 
				if @sqlstr = '' then 
					set @sqlstr = concat('select id into @gzbzId 
					from t127 where 1=1  and c04 = \'',tg_sfld,'\' 
					and c05 = concat(\'',tg_xrzj,'\',\'岗位\') and c01 = \'2006-07-01\' limit 1');
				end if;
			end if;
			if @c > 0 then 
				-- 更新人员 现任职级 是否领导
				PREPARE stmt FROM @sqlstr;
				EXECUTE stmt;
				DROP PREPARE stmt;
				update t131 set c33 = @gzbzId,c34 = @gzbzId where c01 = concat(personId,'');
				set stemIndex = stemIndex + 1;
			end if;
		end if;
	end if;
	set done = @doneF;
end Loop;
close personId_;
	set resultMsg = concat('更新:',stemIndex,'人数据');leave label_pro;
END;

CREATE DEFINER = `root`@`localhost` PROCEDURE `smso-migration-v2`.`p_getTgInit_liangshan`(IN orgId varchar(200),
INOUT resultMsg varchar(1000) CHARSET utf8)
label_pro:BEGIN	
-- 凉山 根据人员任职简历获取人员初始套改数据
	DECLARE personId varchar(20);-- 人员编号 
	DECLARE personName varchar(20);-- 人员编号 
	DECLARE rzsj varchar(20);-- 任职时间 
	DECLARE sjzj varchar(20);-- 实际职级
	DECLARE zz varchar(20);-- 职级
	DECLARE sfld varchar(20);-- 是否领导
	DECLARE startIndex int(11) default 0 ;-- 查询人员任职分条

	DECLARE tg_rysf varchar(20);-- 套改-人员身份
	DECLARE tg_xl varchar(20);-- 套改-学历
	DECLARE tg_cgsj varchar(20);-- 套改-参工时间
	DECLARE tg_xxnx varchar(20);-- 套改-学习年限
	DECLARE tg_lxgl varchar(20);-- 套改-连续工龄
	DECLARE tg_kjsgl varchar(20);-- 套改-正式参加工作前可计算连续工龄年限
	DECLARE tg_sfld varchar(20);-- 套改-是否领导
	DECLARE tg_xrzj varchar(20);-- 套改-现任职级
	DECLARE tg_xrzjsj varchar(20);-- 套改-现任职级时间
	DECLARE tg_xrzjnx varchar(20);-- 套改-现任职级年限
	DECLARE tg_drzj varchar(20);-- 套改-低任职级
	DECLARE tg_drzjsj varchar(20);-- 套改-低任职级时间
	DECLARE tg_drzjnx varchar(20);-- 套改-低任职级年限
	DECLARE tg_jdnx varchar(20);-- 套改-间断年限
	DECLARE tg_sftg10 varchar(20);-- 套改-是否提高10%
	DECLARE tg_tgnx varchar(20);-- 套改-套改年限
	DECLARE tg_xrtgnx varchar(20);-- 套改-现任职级套改年限
	DECLARE tg_drtgnx varchar(20);-- 套改-低任职级套改年限


	DECLARE stemIndex int(11) default 0 ;-- 条数
	

	DECLARE done INT DEFAULT FALSE;   
    
	DECLARE personId_ CURSOR FOR
   SELECT distinct t126.id 
	 from t126 join t121 on t126.id = t121.c02
	join sys_s_data d on d.id = t121.c06
	where t126.id >6640  and t126.c01 = concat(orgId,'')    
	and t121.c07<'2006-07-01'  
	and not exists(select 1 from t131 where t131.c01 = t126.id)  
	order by t126.id 
	;
 	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
	set stemIndex= 0;
 OPEN personId_;  
  -- 开始循环
  read_loop: LOOP
    -- 提取游标里的数据，这里只有一个，多个的话也一样；
    FETCH personId_ INTO personId;
    -- 声明结束的时候
    IF done THEN
      LEAVE read_loop;
    END IF;
	set @doneF = done;
	set startIndex = 0;set tg_xrzj = '';set tg_drzj = '';
	set tg_rysf='', tg_xl='', tg_cgsj = '',tg_xxnx= '',tg_lxgl= '',tg_kjsgl= '',
		tg_sfld= '',tg_xrzj= '',tg_xrzjsj= '',tg_xrzjnx= '',tg_drzj= '',
		tg_drzjsj= '',tg_drzjnx= '',tg_jdnx= '',tg_sftg10= '',tg_tgnx= '',
		tg_xrtgnx= '',tg_drtgnx= '';
				/* select count(1)  into @stemNum
				from ( 
				select t126.id as rybh,t126.id as ryxm ,t126.c04,t126.c01 as dwdm,
				t121.c07 as rzsj,d.name as sjzj,position('非领导' in d.name),
				if(position('非领导' in d.name)>0 ,
				SUBSTR(d.name FROM 1 FOR position('非领导' in d.name)-1),
				SUBSTR(d.name FROM 1 FOR position('领导' in d.name)-1)) as zz,
				if(position('非领导' in d.name)>0 ,
				'非领导职务',
				'领导职务') as sfld
				 from t126 join t121 on t126.id = t121.c02
				join sys_s_data d on d.id = t121.c06
				where t126.id =personId 
				and t121.c07<'2006-07-01' ) a 
				,t165 where a.zz = c01 and t165.c05 = '10497'
				;
*/
			select count(DISTINCT c06) into @stemNum from t121 where c01=concat(personId,'') and c07<'2006-07-01'	
and c06 in (select id from sys_s_data where parent_value = '11350');  -- 11350管理人员  11349机关工人   
-- select COUNT(DISTINCT (c01)) into @stemNum from t121 where c06 in (select id from sys_s_data where parent_value =11350) and c07<2006-07-01;

				if  @stemNum > 0 then 
						select t126.c28,t126.c09,t126.c12,ifnull(t126.c30,''),ifnull(t126.c34,0),ifnull(t126.c32,0)
								-- 人员身份    学历  参工时间 					学习年限  间断年限 正式参加工作前可计算连续工龄年限
						,2006-substr(t126.c12 from 1 for 4)+1-ifnull(t126.c34,0)+ifnull(t126.c32,'')+0
						-- 连续工龄  2006-参工时间+1-间断时间+可计算时间
						,ifnull(t125.c23,'')
						-- 是否提高10%
						into 
						tg_rysf,tg_xl,tg_cgsj,tg_xxnx,tg_jdnx,tg_kjsgl
						,tg_lxgl
						,tg_sftg10
						from t126 join t125 on t126.id = t125.c06 
						where t126.id = personId;
						set tg_tgnx = ifnull(tg_xxnx,0)+ifnull(tg_lxgl,0)+0;-- 套改年限 学习年限+连续工龄
				-- 2006年前参加工作		
						while startIndex < @stemNum do							
						/*		select a.sjzj ,a.zz,a.sfld,a.rzsj into sjzj,zz,sfld,rzsj
								from ( 
								select t126.id as rybh,t126.id as ryxm ,t126.c04,t126.c01 as dwdm,
								t121.c07 as rzsj,d.name as sjzj,position('非领导' in d.name),
								if(position('非领导' in d.name)>0 ,
								SUBSTR(d.name FROM 1 FOR position('非领导' in d.name)-1),
								SUBSTR(d.name FROM 1 FOR position('领导' in d.name)-1)) as zz,
								if(position('非领导' in d.name)>0 ,
								'非领导职务',
								'领导职务') as sfld
								 from t126 join t121 on t126.id = t121.c02
								join sys_s_data d on d.id = t121.c06
								where t126.id =personId
								and t121.c07<'2006-07-01' ) a 
								,t165 where a.zz = c01 and t165.c05 = '10497'
								and a.rybh = personId
				-- t165.c05 工资标准类别  10497-公务员
								 order by a.rybh,a.rzsj desc,t165.c02+0 limit startIndex,1;	 10497*/


								select 
								t121.c07 as rzsj,d.name as sjzj,
								if(position('非领导' in d.name)>0 ,
								concat(SUBSTR(d.name FROM 1 FOR position('非领导' in d.name)-1),'岗位'),
								concat(SUBSTR(d.name FROM 1 FOR position('领导' in d.name)-1),'岗位')) as zz,
								if(position('非领导' in d.name)>0 ,
								'非领导职务',
								'领导职务') as sfld  into rzsj,sjzj,zz,sfld
								 from t126 join t121 on t126.id = t121.c02
								join sys_s_data d on d.id = t121.c06
								where t126.id =personId 
								and t121.c07<'2006-07-01' order by t121.c07+0 desc limit startIndex,1 ; /*管理人员工资标准类别的*/



							/*	select 
								t121.c07 as rzsj,d.name as sjzj,
								d.name as zz into rzsj,sjzj,zz
								 from t126 join t121 on t126.id = t121.c02
								join sys_s_data d on d.id = t121.c06
								where t126.id =personId
								and t121.c07<'2006-07-01' order by t121.c07+0 desc limit startIndex,1 ;*/






								if zz = tg_xrzj then -- 如果职级等于套改-现任职级
									set tg_xrzjsj=rzsj,tg_xrzjnx = 2006-substr(rzsj from 1 for 4)+1;
								ELSE
									if tg_xrzj!='' THEN
										if tg_drzj = '' then 
											-- 这里有可能有多个低职级任职时间  需要查询最早的一个
											select c07 into rzsj from t121 where c01 = concat(personId,'') and c06 = (select id from sys_s_data where typename ='sjzj' and  name =CONCAT(zz,sfld)) order by c07 asc  limit 1;

											set tg_drzj = zz,tg_drzjsj=rzsj,tg_drzjnx = 2006-substr(rzsj from 1 for 4)+1;		
										end if;
									else
										set tg_xrzj = zz,tg_sfld=ifnull(sfld,''),tg_xrzjsj=rzsj,tg_xrzjnx = 2006-substr(rzsj from 1 for 4)+1;		
									end if;
								end if;				
								set startIndex = startIndex+1;
						end while;				
				end if;
			if tg_xrzj != '' then 	
					select count(1) into @stemPNum from t127 where c01 like '2006%' and c05 = tg_xrzj and c04 = tg_sfld;
					if @stemPNum > 0 then 
							select id,id into tg_xrzj,tg_sfld from t127 where c01 like '2006%' and c05 = tg_xrzj and c04 = tg_sfld limit 1;
					else
							select id,id into tg_xrzj,tg_sfld from t127 where c01 like '2006%' and c05 = tg_xrzj order by c04 limit 1;
					end if;
				-- set resultMsg = concat('tg_xrzj:',tg_xrzj,',personId:',personId);leave label_pro;
					-- 	select createrId,createDate,updaterId,updateDate from t131;
					select count(1) into @stemPNum from t131 where c01 = concat(personId,'') and ifnull(c14,'')!=''; -- 已套改出级别档次则不再重新插入
					if @stemPNum = 0 then 					
						delete from t131 where c01 = concat(personId,'');
						set @sqlstr = concat('insert into t131 (createrId,createDate,updaterId,updateDate,c01,c02,c03,c04,c05,c06,c07,c11,c12,c13,
															c19,c20,c21,c27,c28,c29,c30,c31,c33,c34)
						values(1,sysDate(),1,sysDate(),\'',personId,'\',\'',personId,'\',\'',tg_xrzjsj,'\',\'',tg_drzjsj,'\',\'',tg_xrzjnx,'\',\'',tg_drzjnx,'\',\'',tg_sftg10,'\',\'',tg_tgnx,'\',\'',tg_xrzjnx,'\',\'',tg_drzjnx,'\',\'',
									orgId,'\',\'',tg_jdnx,'\',\'',tg_kjsgl,'\',\'',tg_rysf,'\',\'',tg_xl,'\',\'',tg_cgsj,'\',\'',tg_lxgl,'\',\'',tg_xxnx,'\',\'',tg_xrzj,'\',\'',tg_sfld,'\')');
						set stemIndex = stemIndex+1;
					 -- set resultMsg = concat('@sqlstr:',@sqlstr);leave label_pro;
						PREPARE stmt FROM @sqlstr;
						EXECUTE stmt;
						DROP PREPARE stmt;
					end if;
			end if;
	set done = @doneF;
end Loop;
close personId_;
	set resultMsg = concat('更新:',stemIndex,'人数据');leave label_pro;
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`p_importJBT_xc`()
BEGIN
-- 导入凉山州人员津补贴
declare _diFangBuTie varchar(200); -- 地方补贴  94
declare _jiaShi5 varchar(200); -- 驾驶5%      95
declare _fuDongGongZi varchar(200); -- 浮动工资   96
declare _jiaoHuJinTie varchar(200); -- 教护津贴   97
declare _jingXianJinTie varchar(200); -- 警衔津贴  4
declare _jianFaJinTie varchar(200); -- 检法津贴  12
declare _teGangJinTie varchar(200); -- 特岗津贴  101
declare _morethan64 varchar(200); -- 超64元     102
declare _gaoHaiLinGang varchar(200); -- 高海临岗  103
declare _jianBianJinTie varchar(200); -- 艰边津贴   5 
declare _huiZuBuTie varchar(200); -- 回族补贴       3
declare _teJiaoJinTie varchar(200); -- 特教津贴  19

declare person126Id varchar(200); 

declare done int;
-- 定义游标
DECLARE rs_cursor CURSOR FOR SELECT a1.id from t126 a1, liangshan_person_jbt a2  where   a1.c02 = a2.人员编号   ;
DECLARE CONTINUE HANDLER FOR NOT FOUND SET done=1;

open rs_cursor; 
cursor_loop:loop
   FETCH rs_cursor into person126Id; -- 取数据
 IF done=1 THEN 
	leave cursor_loop;
end if;
		select j.人员编号 into person126Id from liangshan_person_jbt j, t126 t6 where t6.c02 = j.人员编号 and t6.id = person126Id;
		select 地方补贴,驾驶5％,浮动工资,教护津贴,警衔津贴,检法津贴,特岗津贴,超64元,高海临岗,艰边津贴,回族补贴,特教津贴 into 
		_diFangBuTie,_jiaShi5,_fuDongGongZi,_jiaoHuJinTie,_jingXianJinTie,_jianFaJinTie,_teGangJinTie,_morethan64,_gaoHaiLinGang,_jianBianJinTie,_huiZuBuTie,_teJiaoJinTie
		from liangshan_person_jbt where 人员编号 =person126Id;
select _diFangBuTie ,_jiaShi5,_fuDongGongZi,_jiaoHuJinTie,_jingXianJinTie,_jianFaJinTie,_teGangJinTie,_morethan64,_gaoHaiLinGang,_jianBianJinTie,_huiZuBuTie,_teJiaoJinTie;
		
 -- insert into t117 VALUE('','7',人员编号,津补贴编号,津补贴名称,津补贴类别,执行金额,激发生活费,
 -- 激发病假,依据问号,执行公式/默认金额,单机版名称)
	 -- 地方补贴  
			-- insert into t117 VALUE('','7',person126Id,'94','94','10367',_diFangBuTie,'',
			-- '','','','');
			insert into t117(id,dataclasscode,createrid,createdate,updaterid,updatedate,unitid,c01,c02,c03,c04,c05,c06,c07,c08,c09,c10,c11,c12) VALUE(
			'','t117','1',NOW(),'0',NOW(),'0','','7',person126Id,'94','94','10367',_diFangBuTie,'','','','','');
			-- 驾驶5% 
			insert into t117(id,dataclasscode,createrid,createdate,updaterid,updatedate,unitid,c01,c02,c03,c04,c05,c06,c07,c08,c09,c10,c11,c12) VALUE(
			'','t117','1',NOW(),'0',NOW(),'0','','7',person126Id,'95','95','10367',_jiaShi5,'','','','5%','');

			-- 浮动工资
			insert into t117(id,dataclasscode,createrid,createdate,updaterid,updatedate,unitid,c01,c02,c03,c04,c05,c06,c07,c08,c09,c10,c11,c12) VALUE(
			'','t117','1',NOW(),'0',NOW(),'0','','7',person126Id,'96','96','10367',_fuDongGongZi,'','','','','');

			-- 教护津贴
			insert into t117(id,dataclasscode,createrid,createdate,updaterid,updatedate,unitid,c01,c02,c03,c04,c05,c06,c07,c08,c09,c10,c11,c12) VALUE(
			'','t117','1',NOW(),'0',NOW(),'0','','7',person126Id,'97','97','10367',_jiaoHuJinTie,'','','','','');
			 -- 警衔津贴  4
			insert into t117(id,dataclasscode,createrid,createdate,updaterid,updatedate,unitid,c01,c02,c03,c04,c05,c06,c07,c08,c09,c10,c11,c12) VALUE(
			'','t117','1',NOW(),'0',NOW(),'0','','7',person126Id,'4','4','10367',_jingXianJinTie,'','','','','');
			-- 检法津贴  12
			insert into t117(id,dataclasscode,createrid,createdate,updaterid,updatedate,unitid,c01,c02,c03,c04,c05,c06,c07,c08,c09,c10,c11,c12) VALUE(
			'','t117','1',NOW(),'0',NOW(),'0','','7',person126Id,'12','12','10367',_jianFaJinTie,'','','','','');
			-- 特岗津贴  101
				insert into t117(id,dataclasscode,createrid,createdate,updaterid,updatedate,unitid,c01,c02,c03,c04,c05,c06,c07,c08,c09,c10,c11,c12) VALUE(
			'','t117','1',NOW(),'0',NOW(),'0','','7',person126Id,'101','101','10367',_teGangJinTie,'','','','','');
			-- 超64元     102
			insert into t117(id,dataclasscode,createrid,createdate,updaterid,updatedate,unitid,c01,c02,c03,c04,c05,c06,c07,c08,c09,c10,c11,c12) VALUE(
			'','t117','1',NOW(),'0',NOW(),'0','','7',person126Id,'102','102','10367',_morethan64,'','','','','');
			-- 高海临岗  103
			insert into t117(id,dataclasscode,createrid,createdate,updaterid,updatedate,unitid,c01,c02,c03,c04,c05,c06,c07,c08,c09,c10,c11,c12) VALUE(
			'','t117','1',NOW(),'0',NOW(),'0','','7',person126Id,'103','103','10367',_gaoHaiLinGang,'','','','','');
			-- 艰边津贴   5 
			insert into t117(id,dataclasscode,createrid,createdate,updaterid,updatedate,unitid,c01,c02,c03,c04,c05,c06,c07,c08,c09,c10,c11,c12) VALUE(
			'','t117','1',NOW(),'0',NOW(),'0','','7',person126Id,'5','5','10367',_jianBianJinTie,'','','','','');
			 -- 回族补贴       3
			insert into t117(id,dataclasscode,createrid,createdate,updaterid,updatedate,unitid,c01,c02,c03,c04,c05,c06,c07,c08,c09,c10,c11,c12) VALUE(
			'','t117','1',NOW(),'0',NOW(),'0','','7',person126Id,'3','3','10367',_huiZuBuTie,'','','','','');
			-- 特教津贴  19
			insert into t117(id,dataclasscode,createrid,createdate,updaterid,updatedate,unitid,c01,c02,c03,c04,c05,c06,c07,c08,c09,c10,c11,c12) VALUE(
			'','t117','1',NOW(),'0',NOW(),'0','','7',person126Id,'19','19','10367',_teJiaoJinTie,'','','','','');


end loop cursor_loop;

close rs_cursor;
end;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`p_inis_rysf_init`(in v_unit_dataId int(11),inout resultMsg varchar(1000))
label_pro:BEGIN	
/* 
	综合类-综合类转警察法官检察官
	人民警察 职级情况下,人员身份进行修正 
	前提是 人员身份本身是综合类公务员
	人员身份-t126.c28 码表
	实际职级-t126.c36 码表
	是否领导-t126.c27 关联t127.c04
	工资标准类别-t126.c39 码表
	人员工资制度-t125.c36 码表

        员额内法官
        员额内检察官
*/
	DECLARE stemIndex int(11) default 0;-- 参数变量
	DECLARE rysfLb int(11) default 0;-- 人员身份类别  1-警察
	DECLARE stemNum int(11);-- 参数变量
	DECLARE stemPersonId int(11);-- 人员id参数
	DECLARE stempParam varchar(20);-- 参数变量
	DECLARE stempMonth varchar(20);-- 参数变量
	DECLARE stemParam varchar(20);-- 参数变量

	DECLARE sjzj varchar(50); -- 实际职级
	DECLARE sjzjName varchar(50); -- 实际职级
	DECLARE rygzzd varchar(50); -- 人员工资制度
	DECLARE dwgzzd varchar(50); -- 单位工资制度

	DECLARE rysf varchar(50); -- 人员身份码表id
	DECLARE gzbzlb varchar(50); -- 执行工资标准 工资标准类别 
	DECLARE gzdyzj varchar(50); -- 工资对应职级
	DECLARE gzdyzjName varchar(50); -- 工资对应职级
	DECLARE sfld varchar(50); -- 是否领导

  DECLARE done INT DEFAULT FALSE;
	-- 所有当前单位下面的人员id
	DECLARE person_ CURSOR FOR
   SELECT t126.id from  t126,t125
		where 1=1 and t126.dataclassCode = 't126'
		and t126.c01 = concat(v_unit_dataId,'') and t126.id = t125.c06 -- 人员工资表的c06人员编号 关联型
		and exists (select 1 from sys_s_data d where d.id = t126.c28 and d.name like '%公%')
	  and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1');-- t126.c03 人员状态-码表 1-在职
 	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
 	
   SELECT count(1) into @count from  t126,t125
		where 1=1 and t126.dataclassCode = 't126'
		and t126.c01 = concat(v_unit_dataId,'') and t126.id = t125.c06 -- 人员工资表的c06人员编号 关联型
		and exists (select 1 from sys_s_data d where d.id = t126.c28 and d.name like '%公%')
	  and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1');-- t126.c03 人员状态-码表 1-在职
 
	OPEN person_; 
  	read_loop: LOOP 
    	FETCH person_ INTO stemPersonId;
	    -- 声明结束的时候
	    IF done THEN
	      LEAVE read_loop;
	    END IF;
		set @doneF = done;
		
    	select t125.c36 into @rygzzd from t126 ,t125 where t126.id = t125.c06 and t126.id = stemPersonId;
		-- 修改关联型
		select c13 into dwgzzd from t111 where id = v_unit_dataId; -- 单位工资制度

		select t126.c28,t126.c39,t126.c17,t126.c27,
		t126.c36,t125.c36
		into  rysf,gzbzlb,gzdyzj,sfld,
		--  人员身份,执行工资标准,工资对应职级,是否领导, 姓名,级别,档次
		sjzj,rygzzd
		-- 实际职级,人员工资制度
		from t126,t125 
		where t126.id = stemPersonId and t126.id = t125.c06 ;
		
		select count(1) into stemNum from t127 where id = gzdyzj;
		if stemNum > 0 then 
			-- 工资对应职级  存入的是127的id
			select c05 into gzdyzjName from t127 where id = gzdyzj;
		else 
			set gzdyzjName = gzdyzj;
		end if;
		/**
		if position('试用期' in gzdyzjName) > 0 then 
			set gzdyzjName = '警察试用期';
			set sjzjName = gzdyzjName;
			set sfld = '非领导职务';
			select id into rysf from sys_s_data where typename = 'rysf' and name = '人民警察';
			select c05 ,c04 into rygzzd,gzbzlb from t136 where c02 = rysf limit 0,1;
			-- c05-人员工资制度 c04-工资标准类别  c02-人员身份
			select id into gzdyzj from t127 where c05=gzdyzjName order by c01 limit 0,1; -- 试用期工资对应 职级
			update t126 set c17 = gzdyzj where id = stemPersonId;
			-- 更新人员信息表的 工资对应职级
			update data_record_t126 set  c17 = gzdyzj
			where dataclassCode = 't126' and dataId = stemPersonId;	
			
			update t125 set c07='',c09='' where c06 = concat(stemPersonId,'');
			-- 更新人员工资表的 级别 档次 为空
			update data_record_t125 set c07='',c09=''
			where dataclassCode = 't125' and c06 = concat(stemPersonId,'');	
		else
		*/
		if position('警' in gzdyzjName)>0 then 
		-- 警察职级工资制度
			set rysfLb = 1;
			set sfld = '非领导职务';
			set sjzjName = gzdyzjName;-- 县处级正职
			select id into rysf from sys_s_data where typename = 'rysf' and name = '人民警察';
			select c05 ,c04 into rygzzd,gzbzlb from t136 where c02 = rysf limit 0,1;
			-- c05-人员工资制度 c04-工资标准类别  c02-人员身份

			-- 处理实际职级
			select count(1) into @sjzjCount from sys_s_data where typename = 'sjzj' and name =  sjzjName;
			if @sjzjCount > 0 then 
				select id into sjzj from sys_s_data where  typename = 'sjzj' and name =  sjzjName limit 0,1 ;
			end if;
			select id into sfld from t127 where c05=gzdyzjName and c04 = sfld order by c01 limit 0,1; -- 是否领导
			update t126 set c28=rysf,c39=gzbzlb,c36=sjzj,c27=sfld where id = stemPersonId;
			-- 更新人员信息表的 人员身份 工资标准类别  实际职级  是否领导
			update data_record_t126 set  c28=rysf,c39=gzbzlb,c36=sjzj,c27=sfld 
			where dataclassCode = 't126' and dataId = stemPersonId;	
			update t125 set c36=rygzzd where c06 = concat(stemPersonId,'');
			-- 更新人员工资表的 人员工资制度
			update data_record_t125 set  c36=rygzzd  
			where -- dataclassCode = 't125' and
			c06 = concat(stemPersonId,'');
			set stemIndex = stemIndex + 1;
		end if;
		if position('法官' in gzdyzjName)>0 || position('检察官' in gzdyzjName)>0 then 
		-- 法官/检察官职级工资制度
			set rysfLb = 1;
			set sfld = '领导职务';
			set sjzjName = gzdyzjName;-- 县处级正职
			if position('法官' in gzdyzjName)>0 then 
				select id into rysf from sys_s_data where typename = 'rysf' and name = '员额内法官';
			else
				select id into rysf from sys_s_data where typename = 'rysf' and name = '员额内检察官';
			end if;
			select c05 ,c04 into rygzzd,gzbzlb from t136 where c02 = rysf limit 0,1;
			-- c05-人员工资制度 c04-工资标准类别  c02-人员身份

			-- 处理实际职级
			select count(1) into @sjzjCount from sys_s_data where typename = 'sjzj' and name =  sjzjName;
			if @sjzjCount > 0 then 
				select id into sjzj from sys_s_data where  typename = 'sjzj' and name =  sjzjName limit 0,1 ;
			end if;
			select id into sfld from t127 where c05=gzdyzjName and c04 = sfld order by c01 limit 0,1; -- 是否领导
			update t126 set c28=rysf,c39=gzbzlb,c36=sjzj,c27=sfld where id = stemPersonId;
			-- 更新人员信息表的 人员身份 工资标准类别  实际职级  是否领导
			update data_record_t126 set  c28=rysf,c39=gzbzlb,c36=sjzj,c27=sfld 
			where dataclassCode = 't126' and dataId = stemPersonId;	
			update t125 set c36=rygzzd where c06 = concat(stemPersonId,'');
			-- 更新人员工资表的 人员工资制度
			update data_record_t125 set  c36=rygzzd  
			where -- dataclassCode = 't125' and
			c06 = concat(stemPersonId,'');
			set stemIndex = stemIndex + 1;
		end if;
		/**
			else
				set rysfLb = 0;
				set sfld = '领导职务';
				set sjzjName = concat(gzdyzjName,sfld);-- 县处级正职领导职务
			end if;
		end if;
		*/	
		set done = @doneF;
  	END LOOP;
  -- 关闭游标
  CLOSE person_;
  set resultMsg = concat('共@count:',@count,'人,其中',stemIndex,'人数据更新!');
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`p_inis_sjzj_init`(in v_unit_dataId int(11),inout resultMsg varchar(1000))
label_pro:BEGIN	
/* 
	前提是工资对应职级是id
	实际职级-t126.c36 码表
*/
	DECLARE stemIndex int(11) default 0;-- 参数变量
	DECLARE stemNum int(11);-- 参数变量
	DECLARE stemPersonId int(11);-- 人员id参数
	DECLARE stempParam varchar(20);-- 参数变量
	DECLARE stempMonth varchar(20);-- 参数变量
	DECLARE stemParam varchar(20);-- 参数变量

	DECLARE cjgzsj varchar(20);-- 参加工作时间 y-m-d
	DECLARE qxsj varchar(20);-- 起薪时间 y-m

	DECLARE sjzj varchar(50); -- 实际职级
	DECLARE sjzjName varchar(50); -- 实际职级
	DECLARE rygzzd varchar(50); -- 人员工资制度
	DECLARE dwgzzd varchar(50); -- 单位工资制度


	DECLARE rysflb int(11) default 0; -- 人员身份类别
	DECLARE rysf varchar(50); -- 人员身份
	DECLARE rysfName varchar(50); -- 人员身份
	DECLARE gzbzlb varchar(50); -- 执行工资标准 工资标准类别 
	DECLARE gzbzlbName varchar(50); -- 执行工资标准 工资标准类别 名称
	DECLARE gzdyzj varchar(50); -- 工资对应职级
	DECLARE sfld varchar(50); -- 是否领导

  DECLARE done INT DEFAULT FALSE;
	-- 所有当前单位下面的人员id
	DECLARE personId_ CURSOR FOR
   SELECT t126.id from  t126,t125
		where 1=1 and t126.dataclassCode = 't126'
		and t126.c01 = concat(v_unit_dataId,'') and t126.id = t125.c06 -- 人员工资表的c06人员编号 关联型
	  and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1');-- t126.c03 人员状态-码表 1-在职
 	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
 	
 SELECT count(1) into @count from  t126,t125
		where 1=1 and t126.dataclassCode = 't126'
		and t126.c01 = concat(v_unit_dataId,'') and t126.id = t125.c06 -- 人员工资表的c06人员编号 关联型
	  and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1');-- t126.c03 人员状态-码表 1-在职
 
 
	-- 打开游标
  OPEN personId_;  
  -- 开始循环
  	read_loop: LOOP
	    -- 提取游标里的数据，这里只有一个，多个的话也一样；
	    FETCH personId_ INTO stemPersonId;
	    -- 声明结束的时候
	    IF done THEN
	      LEAVE read_loop;
	    END IF;
		set @doneF = done;
    	select t125.c36 into @rygzzd from t126 ,t125 where t126.id = t125.c06 and t126.id = stemPersonId;
		
		-- 修改关联型
		select c13 into dwgzzd from t111 where id = v_unit_dataId; -- 单位工资制度

		select t126.c28,t126.c39,t126.c17,ifnull(t126.c27,''),
		t126.c36,t125.c36
		into  rysf,gzbzlb,gzdyzj,sfld,
		--  人员身份,执行工资标准,工资对应职级,是否领导, 姓名,级别,档次
		sjzj,rygzzd
		-- 实际职级,人员工资制度
		from t126,t125 
		where t126.id = stemPersonId and t125.c06 = t126.id ;
		select count(1) into @rysfCount from sys_s_data d where d.id = rysf;
		
		if @rysfCount > 0 then
			 select name into rysfName from sys_s_data d where d.id = rysf;
		else 
			set rysfName = rysf;
		end if;
		select ifnull(d.name,gzbzlb) into gzbzlbName from t136 ,sys_s_data d where d.id = t136.c04 
		and exists(select 1 from sys_s_data f where f.id = t136.c02 and f.name = rysfName) limit 0,1;
		-- c04 工资标准类别  c02-人员身份

		if position('事业' in gzbzlbName)>0 then 
			-- 事业身份类型  包括地勘 7-事业管理人员  8-专业技术人员 9-事业工勤人员
			if position('管理人员' in rysfName)>0 then 
				set	rysflb = 7;
			end if;
			if position('专业技术' in rysfName)>0 then
			 	set rysflb = 8;
			 	set sfld = '';
			end if;
			if position('工' in rysfName)>0 then 
			 	set rysflb = 9;
			 	set sfld = '';
			end if;
		else
			set rysflb = 1;
			-- 机关身份类型 1-普通公务员 2-人民警察 3-法官 4-检察官  5-机关工人 6-司法行政/辅助人员
			if position('人民警察' in rysfName)>0 then 
				set	rysflb = 2;
				set sfld = '非领导职务';
			end if;
			if position('法官' in rysfName)>0 then
			 	set rysflb = 3;
			 	set sfld = '领导职务';
			end if;
			if position('检察官' in rysfName)>0 then 
			 	set sfld = '领导职务';
			 	set rysflb = 4;
			end if;
			if position('工' in rysfName)>0 then 
			 	set rysflb = 5;
			 	set sfld = '';
			end if;
			if position('司法' in rysfName)>0 then 
			 	set sfld = '非领导职务';
			 	set rysflb = 6;
			end if;
		end if;
		
		-- 处理实际职级
		select count(1) into @sjzjCount from sys_s_data where id = sjzj;
		if @sjzjCount > 0 then 
			select name into sjzjName from sys_s_data where id = sjzj;
		else 
			select count(1) into @gzdyzjCount from t127 where id = gzdyzj;
			if @gzdyzjCount > 0 then
				select ifnull(c05,gzdyzj),c05 into sjzjName,gzdyzj from t127 where id = gzdyzj;
			else
				set sjzjName = sjzj; 
			end if;
		end if;
		
		select count(1) into @sfldCount from t127 where id = sfld;
		if @sfldCount>0 then 
			select c04 into sfld from t127 where id = sfld; -- 是否领导 中文名称
		end if;
		
		if ''!=sfld then
			if rysflb = 7 then-- 管理人员
				if position('领导' in sjzjName) <1 then -- 是否领导不为空  领导职务 非领导职务  但是实际职级未写明领导/非领导岗位
					set sjzjName = replace(sjzjName,'岗位',sfld);
				end if;
			else -- 机关 公务员类
				if rysflb = 1 then 
					if position('领导' in sjzjName) <1 then -- 是否领导不为空  领导职务 非领导职务 
						set sjzjName = concat(sjzjName,sfld);
					end if;
				-- else -- 法官 检察官 司法类  人民警察  实际职级不用添加 领导职务 /非领导职务
					-- select id into sfld from t127 where c08 = gzbzlb and c05 = sjzjName and c04 = sfld 
					-- order by c01 desc limit 0,1; 
					-- c08-工资标准类别  c05-次级别名称(职级) c04-级别名称(领导/非领导职务 ) c01 启用时间
				end if;
			end if;
		else
			set sfld = ''; 
		end if;
		
		select count(1) into @sjzjCount from sys_s_data d join t140 on d.id=t140.c02
		where d.typename = 'sjzj' and d.name =  concat(sjzjName,'')
		and t140.c03 = concat(rysf,'') and c01 = concat(gzbzlb,'') limit 0,1;
		-- t140-人员身份与实际职级对应关系 c03-人员身份 c02-人员实际职级 c01-工资标准类别 
		if @sjzjCount > 0 then 
			select d.id into sjzj from sys_s_data d,
			t140  where typename = 'sjzj' and d.name =  concat(sjzjName,'')
			and t140.c03 = rysf and t140.c02 = d.id and c01 = gzbzlb limit 0,1;
		end if;
		select id into sfld from t127 where c05=concat(gzdyzj,'') and c04 = concat(sfld,'') order by c01 limit 0,1; -- 是否领导
		-- set resultMsg = concat('stemPersonId:',stemPersonId,',sjzj:',sjzj,',sfld:',sfld);leave label_pro;
		update t126 set c36=sjzj,c27=sfld where id = stemPersonId;-- 更新人员信息表的 部门,执行工资标准,工资对应职级,是否领导
		update data_record_t126 set c36=sjzj,c27=sfld where dataclassCode = 't126' and dataId = stemPersonId;	
		set stemIndex = stemIndex + 1;	
	set done = @doneF;
  END LOOP;
  -- 关闭游标
  CLOSE personId_;
  set resultMsg = concat('共@count:',@count,'人,其中',stemIndex,'人数据更新!');
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`p_init_addJbt_allDw`(IN jbtCode varchar(50),INOUT resultMsg varchar(1000))
label_pro:BEGIN
	#Routine body goes here...
 -- 全部单位添加津补贴项目
	DECLARE v_unit_id varchar(50);-- 单位代码
	DECLARE v_unit_dataId int(11);-- 单位id
	DECLARE v_unit_data_name varchar(100);-- 单位名称
	DECLARE jbtName varchar(100);-- 津补贴名称
	DECLARE sucessNum int(11);-- 返回结果数据
	DECLARE done INT DEFAULT FALSE; -- 自定义控制游标循环变量,默认false  
 -- 查询四川省下属市州
	DECLARE My_Cursor CURSOR FOR (
		select id from t111  where id>46  -- 暂时针对省地税下面所有的地税单位
	);
	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE; 
-- 绑定控制变量到游标,游标循环结束自动转true 
	set sucessNum = 0;
	set @jbtCount = 0;
	select count(1) into @jbtCount from t116 where c02 = jbtCode;
	if @jbtCount = 0 then 
		set resultMsg = concat('输入津补贴编号',jbtCode,'不存在!');
		leave label_pro;
	else 
		if @jbtCount > 1 then 
			set resultMsg = concat('输入津补贴编号',jbtCode,'在系统存在重复项目,请先检查项目!');
			leave label_pro;	
		end if;		
	end if;
	select c03 into jbtName from t116 where c02 = jbtCode;
	OPEN My_Cursor; -- 打开游标  
	  	myLoop: LOOP -- 开始循环体,myLoop为自定义循环名,结束循环时用到  
		    FETCH My_Cursor into v_unit_dataId; 
		    IF done THEN -- 判断是否继续循环  
		      LEAVE myLoop; -- 结束循环  
		    END IF;  
			select c01 into v_unit_id from t111 where id = v_unit_dataId;  
			if jbtCode = 'JBT00041' then -- 增收节支削峰填谷补贴
				select count(1) into @jgGrCount from t126 where c01 = concat(v_unit_dataId,'') and c28 = 10516;-- 机关工人
				if @jgGrCount > 0 then 
					call p_init_ds_addDWJBT(v_unit_id,jbtName,resultMsg);
					set sucessNum = sucessNum + 1;
				end if;
			else 
				if jbtCode = 'JBT00025' then -- 公务员规范后津补贴
					select count(1) into @jgGrCount from t126 where c01 = concat(v_unit_dataId,'') and c28 = '10512';-- 综合类公务员
					if @jgGrCount > 0 then 
						call p_init_ds_addDWJBT(v_unit_id,jbtName,resultMsg);
						call p_init_Gwyjbt(v_unit_dataId,resultMsg);-- 根据单位公务员标准驻地读取公务员规范后标准
						set sucessNum = sucessNum + 1;
					end if;
				end if; 
			end if;
	  	END LOOP myLoop; -- 结束自定义循环体  
  	CLOSE My_Cursor; -- 关闭游标   
	if sucessNum > 0 then 
		set resultMsg = concat('共对',sucessNum,'家单位添加津补贴[',jbtName,']');
	end if;
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`p_init_autoBumen`(in v_unit_dataId int(11),inout resultMsg varchar(1000))
label_pro:BEGIN	
/*单位更新data_auto_record里面的autoEnd
*/
	DECLARE stemIndex int(11) default 0;-- 参数变量
	DECLARE bumen_id int(11) default 0;-- 部门id
	DECLARE v_unit_id varchar(50) ;-- 单位代码
	DECLARE bmbh varchar(100) ;-- 部门编号

	DECLARE done INT DEFAULT FALSE; -- 自定义控制游标循环变量,默认false  
	DECLARE My_Cursor CURSOR FOR (
		select id  from t113 where c01 = concat(v_unit_dataId,'')
	);
	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE; -- 绑定控制变量到游标,游标循环结束自动转true  
	
	select c01 into v_unit_id from t111 where id = v_unit_dataId;
 	
	OPEN My_Cursor; -- 打开游标  
  myLoop: LOOP -- 开始循环体,myLoop为自定义循环名,结束循环时用到  
    FETCH My_Cursor into bumen_id; 
    IF done THEN -- 判断是否继续循环  
      LEAVE myLoop; -- 结束循环  
    END IF;  
    set bmbh = '';
	set stemIndex = stemIndex + 1;
	if stemIndex < 10 then 
		set bmbh = concat(v_unit_id,'000',stemIndex) ;
	else 
		if stemIndex < 100 then 
			set bmbh = concat(v_unit_id,'00',stemIndex) ;
		else 
			if stemIndex <1000 then 
				set bmbh = concat(v_unit_id,'0',stemIndex) ;
			end if;
		end if;
	end if;
	update t113 set c02 = bmbh where id = bumen_id and bmbh != '';
  END LOOP myLoop; -- 结束自定义循环体  
  CLOSE My_Cursor; -- 关闭游标  
 	-- 更新所在单位的部门编号自动生成
	select count(id) into @dataAuto from t113 where c01=concat(v_unit_dataId,'');
 	set @dataAuto = @dataAuto + 0;
 	select count(1) into @autoNum from data_auto_record where dataclassCode = 't113' and dataitemCode = 'c02' 
 	and autoHead = v_unit_id and autoEndLength = 4 ;
 	if @autoNum > 0 then 
 		update data_auto_record set autoEnd = @dataAuto where dataclassCode = 't113' and dataitemCode = 'c02' 
 		and autoHead = v_unit_id and autoEndLength = 4 ;
 	else 
 		insert into data_auto_record(dataclassCode,dataitemCode,autoHead,autoCenter,autoEndLength,autoEnd,createDate,updateDate)
 		values('t113','c02',v_unit_id,'',4,@dataAuto,sysdate(),sysDate());	
 	end if;
	set resultMsg = concat('@dataCode:',v_unit_id,',@autoNum:',@autoNum,',@dataAuto:',@dataAuto);
 
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`p_init_autoRecord`(in v_unit_dataId int(11),inout resultMsg varchar(1000))
label_pro:BEGIN	
/*单位更新data_auto_record里面的autoEnd
*/
	DECLARE stemIndex int(11) default 0;-- 参数变量

  DECLARE done INT DEFAULT FALSE;
 
 	-- 更新所在单位的人员编号自动生成
 	select c01 into @dataCode from t111 where id = v_unit_dataId limit 0,1;
 	select count(1) into @r from data_record_t126 where c01 = concat(v_unit_dataId,'') and c03 <> '10372';
 	if @r > 0 then 
		select replace(c02,@dataCode,'')  into @dataAuto from data_record_t126 where c01 = concat(v_unit_dataId,'') and c03 != '10372' -- 非离休人员
		order by c02 desc limit 0,1;
	else
		select replace(c02,@dataCode,'')  into @dataAuto from t126 where c01 = concat(v_unit_dataId,'') and c03 <> '10372' -- 非离休人员
		order by c02 desc limit 0,1;
 	end if;
 	set @dataAuto = @dataAuto + 0;
 	select count(1) into @autoNum from data_auto_record where dataclassCode = 't126' and dataitemCode = 'c02' 
 	and autoHead = @dataCode and autoEndLength = 5 ;
 	if @autoNum > 0 then 
 		update data_auto_record set autoEnd = @dataAuto where dataclassCode = 't126' and dataitemCode = 'c02' 
 		and autoHead = @dataCode and autoEndLength = 5 ;
 	else 
 		insert into data_auto_record(dataclassCode,dataitemCode,autoHead,autoCenter,autoEndLength,autoEnd,createDate,updateDate)
 		values('t126','c02',@dataCode,'',5,@dataAuto,sysdate(),sysDate());	
 	end if;
	set resultMsg = concat('@dataCode:',@dataCode,',@autoNum:',@autoNum,',@dataAuto:',@dataAuto);
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`p_init_checkRyjbt`(in v_unit_dataId int(11),inout resultMsg varchar(1000))
label_pro:BEGIN	
/*
v_unit_id：单位代码
单位初始化数据后检查人员津补贴 是否与单位津补贴里面的一致
如果多了，则删除，少了则添加 
同时对添加的数据进行changeSign与录入新进人员的一致
*/
	DECLARE stemIndex int(11) default 0;-- 参数变量
	DECLARE sTemPersonId int(11) default 0;-- 参数变量

  DECLARE done INT DEFAULT FALSE;
	
	-- -- 所有机关公务员在职公务员-排开试用期人员
	DECLARE personId_ CURSOR FOR
   SELECT t126.id from t126 ,t125 
		where t126.id = t125.c06
		and t126.c01 = concat(v_unit_dataId,'')
	  and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1');-- t126.c03 人员状态-码表 1-在职
	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
	
	select group_concat(c03) into @dwjbt from t115 where c02 = concat(v_unit_dataId,'');-- 单位津补贴 项目id 格式如：12,23,11,2
	-- 打开游标
  OPEN personId_;  
  -- 开始循环
  read_loop: LOOP
    -- 提取游标里的数据，这里只有一个，多个的话也一样；
    FETCH personId_ INTO sTemPersonId;
    -- 声明结束的时候
    IF done THEN
      LEAVE read_loop;
    END IF;

		select count(1) into @delCount from t117 where c03 = concat(sTemPersonId,'') and id not in (
					select id from t117 where 1=1
					and t117.c03 = concat(sTemPersonId,'') 
					and find_in_set(t117.c04,@dwjbt)-- 查询当前人员已经对应了的单位津补贴
				);
		if @delCount>0 then 

			-- 查询当前人员 不符合单位津补贴项目 的数据 进行删除
			select group_concat(id) into @delCount from t117 where c03 = concat(sTemPersonId,'') and id not in (
				select id from t117 where 1=1
				and t117.c03 = concat(sTemPersonId,'') 
				and find_in_set(t117.c04,@dwjbt)-- 查询当前人员已经对应了的单位津补贴
			);
			delete from t117 where FIND_IN_SET(id,@delCount);
			delete from data_record_t117 where dataclassCode = 't117' and find_in_set(dataId,@delCount);
		end if;
    
    -- 查询当前人员对应单位津补贴项目中没有津补贴数据  进行添加 并且changeSign 使用初始化数据的changeSign
	 select count(1) into @addNum from t115 where c02 = concat(v_unit_dataId,'') 
    	and not exists(select 1 from t117 where t117.c03 = concat(sTemPersonId,'') and t117.c04 = t115.c03);
    while @addNum > 0 do 
    	select c03,c05 into @jbtId,@jbtLb from t115 where c02 = concat(v_unit_dataId,'') 
    		and not exists(select 1 from t117 where t117.c03 = concat(sTemPersonId,'') and t117.c04 = t115.c03) limit 0,1;
    	select changeType,changeSign into @changeType,@changeSign from data_record_t126 where dataclassCode = 't126'
    		and c01 = concat(v_unit_dataId,'') and dataId = sTemPersonId order by id limit 0,1 ;
    	select count(1) into @jbtN from t117 where c03 = concat(sTemPersonId,'') and c04 = @jbtId ;
    	if @jbtN = 0 then 
	    	insert into t117(dataclassCode,unitId,createDate,createrId,c02,c03,c04,c05,c06,c07)
	    					-- 数据类    功能id  添加时间    添加 人	     单位代码 人员编号  津补贴编号  津补贴名称 津补贴类别 金额  
	    	values('t117',0,sysDate(),1,v_unit_dataId,sTemPersonId,@jbtId,@jbtId,@jbtLb,0);
	    	
			select id into @dataId from t117 where c03 = concat(sTemPersonId,'') and c04 = @jbtId ;
			
	    	insert into data_record_t117(dataclassCode,unitId,createDate,createrId,c02,c03,c04,c05,c06,c07,
	    					-- 数据类    功能id  添加时间    添加 人	     单位代码 人员编号  津补贴编号  津补贴名称 津补贴类别 金额
				changeType,changeSign,dataId,operateTime
			)
	    	values('t117',0,sysDate(),1,v_unit_dataId,sTemPersonId,@jbtId,@jbtId,@jbtLb,0,
	    		@changeType,@changeSign, @dataId,sysDate()
	    	);
				set stemIndex = stemIndex + 1;
	    else 
	    	leave label_pro;
    	end if;	
    	 select count(1) into @addNum from t115 where c02 = concat(v_unit_dataId,'') 
				and not exists(select 1 from t117 where t117.c03 = concat(sTemPersonId,'') and t117.c04 = t115.c03);
    end while;
    
  END LOOP;
  -- 关闭游标
  CLOSE personId_;	
  	if stemIndex > 0 then 
		set resultMsg = concat('更新【',stemIndex,'】人的数据 ！');
  	end if;
  	leave label_pro;			
			
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`p_init_checkRyjbt_Less`(in v_unit_dataId int(11),in dwjbtCount int(11),inout resultMsg varchar(1000))
label_pro:BEGIN	
/*
v_unit_id：单位代码
dwjbtCount：单位津补贴数
单位初始化数据后检查人员津补贴 是否与单位津补贴里面的一致
如果多了，则删除，少了则添加 
同时对添加的数据进行changeSign与录入新进人员的一致
*/
	DECLARE stemIndex int(11) default 0;-- 参数变量
	DECLARE sTemPersonId int(11) default 0;-- 参数变量

  DECLARE done INT DEFAULT FALSE;
	
	-- -- 所有在职人员
	DECLARE personId_ CURSOR FOR
	select c03 from t117 where c02= concat(v_unit_dataId,'')
	and exists(select 1 from t126 where c01 = concat(v_unit_dataId,'') and id = t117.c03 and c03 != '10372')-- 排除离休人员
	 group by c03 HAVING count(1)!=dwjbtCount; 
	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
   /** 
   SELECT t126.id from t126 ,t125 
		where t125.c06 = t126.id 
		and t126.c01 = v_unit_dataId
	  and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1');-- t126.c03 人员状态-码表 1-在职
	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
	*/
	select group_concat(c03) into @dwjbt from t115 where c02 = concat(v_unit_dataId,'');-- 单位津补贴 项目id 格式如：12,23,11,2
	-- 打开游标
  OPEN personId_;  
  -- 开始循环
  read_loop: LOOP
    -- 提取游标里的数据，这里只有一个，多个的话也一样；
    FETCH personId_ INTO sTemPersonId;
    -- 声明结束的时候
    IF done THEN
      LEAVE read_loop;
    END IF;

		select count(1) into @delCount from t117 where c03 = concat(sTemPersonId,'') and id not in (
					select id from t117 where 1=1
					and t117.c03 = concat(sTemPersonId,'') 
					and find_in_set(t117.c04,@dwjbt)-- 查询当前人员已经对应了的单位津补贴
				);
		if @delCount>0 then 
			-- 查询当前人员 不符合单位津补贴项目 的数据 进行删除
			select group_concat(id) into @delCount from t117 where c03 = concat(sTemPersonId,'') and id not in (
				select id from t117 where 1=1
				and t117.c03 = concat(sTemPersonId,'') 
				and find_in_set(t117.c04,@dwjbt)-- 查询当前人员已经对应了的单位津补贴
			);
			delete from t117 where FIND_IN_SET(id,@delCount);
			delete from data_record_t117 where dataclassCode = 't117' and find_in_set(dataId,@delCount);
		end if;
    
    -- 查询当前人员对应单位津补贴项目中没有津补贴数据  进行添加 并且changeSign 使用初始化数据的changeSign
	 select count(1) into @addNum from t115 where c02 = concat(v_unit_dataId,'') 
    	and not exists(select 1 from t117 where t117.c03 = concat(sTemPersonId,'') and t117.c04 = t115.c03);
    while @addNum > 0 do 
    	select c03,c05 into @jbtId,@jbtLb from t115 where c02 = concat(v_unit_dataId,'') 
    		and not exists(select 1 from t117 where t117.c03 = concat(sTemPersonId,'') and t117.c04 = t115.c03) limit 0,1;
    	select changeType,changeSign into @changeType,@changeSign from data_record_t126 where --  dataclassCode = 't126'
    		 c01 = concat(v_unit_dataId,'') and dataId = sTemPersonId order by id limit 0,1 ;
    	select count(1) into @jbtN from t117 where c03 = concat(sTemPersonId,'') and c04 = @jbtId ;
    	if @jbtN = 0 then 
	    	insert into t117(dataclassCode,unitId,createDate,createrId,c02,c03,c04,c05,c06,c07,updaterId,updateDate)
	    					-- 数据类    功能id  添加时间    添加 人	     单位代码 人员编号  津补贴编号  津补贴名称 津补贴类别 金额  
	    	values('t117',0,sysDate(),1,concat(v_unit_dataId,''),concat(sTemPersonId,''),@jbtId,@jbtId,@jbtLb,0,1,sysDate());
	    	
			select id into @dataId from t117 where c03 = concat(sTemPersonId,'') and c04 = @jbtId limit 1;
			
	    	insert into data_record_t117(dataclassCode,unitId,createDate,createrId,c02,c03,c04,c05,c06,c07,
	    					-- 数据类    功能id  添加时间    添加 人	     单位代码 人员编号  津补贴编号  津补贴名称 津补贴类别 金额
				changeType,changeSign,dataId,operateTime,updaterId,updateDate
			)
	    	values('t117',0,sysDate(),1,v_unit_dataId,sTemPersonId,@jbtId,@jbtId,@jbtLb,0,
	    		@changeType,@changeSign, @dataId,sysDate(),1,sysDate()
	    	);
				set stemIndex = stemIndex + 1;
	    else 
	    	leave label_pro;
    	end if;	
    	 select count(1) into @addNum from t115 where c02 = concat(v_unit_dataId,'') 
				and not exists(select 1 from t117 where t117.c03 = concat(sTemPersonId,'') and t117.c04 = t115.c03);
    end while;
    
  END LOOP;
  -- 关闭游标
  CLOSE personId_;	
  	if stemIndex > 0 then 
		set resultMsg = concat('更新【',stemIndex,'】人的数据 ！');
  	end if;
  	leave label_pro;	
END
/**
;;
DELIMITER ;
*/;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`p_init_czgy`(in v_unit_dataId int(11),inout resultMsg varchar(1000))
label_pro:BEGIN	
/* 
	前提是工资对应职级是id
	实际职级-t126.c36 
*/
	DECLARE stemNum int(11);-- 参数变量
	DECLARE stemP int(11);-- 参数变量
	select count(1) into stemNum from t126 where c01 = concat(v_unit_dataId,'');
	select IFNULL(d.name,t111.c12) ,
		IFNULL((select f.name from sys_s_data f where t111.c14 = f.id ),t111.c14) 
		into @czgy, @cztf 
		from t111 left join sys_s_data d on t111.c12 = d.id where t111.id = v_unit_dataId;
		select position('无' in @czgy) into stemP;
		if @czgy = '全部人员' then -- 财政供养全部人员
			update t126,sys_s_data d set t126.c24 = d.id 
			where t126.c01 = concat(v_unit_dataId,'') and d.typename = 'is' and d.data_value = '1' ;
			update data_record_t126 t126,sys_s_data d set t126.c24 = d.id 
			where t126.dataclassCode = 't126' and t126.c01 = concat(v_unit_dataId,'') and d.typename = 'is' and d.data_value = '1' ;
		else 
			if stemP>0 then -- 无财政供养人员 
				update t126 ,sys_s_data d set c24 = d.id 
				where c01 = concat(v_unit_dataId,'') and d.typename = 'is' and d.data_value = '0' ;
				
				update data_record_t126 t126,sys_s_data d set t126.c24 = d.id 
				where t126.dataclassCode = 't126' and t126.c01 = concat(v_unit_dataId,'') and d.typename = 'is' and d.data_value = '0' ;
			end if;
	end if;
	select position('无' in @cztf) into stemP;
	if  @cztf = '全部人员' then -- 财政统发全部人员
		update t126 ,sys_s_data d set c22 = d.id 
		where c01 = concat(v_unit_dataId,'') and d.typename = 'is' and d.data_value = '1' ;
		
		update data_record_t126 t126,sys_s_data d set t126.c22 = d.id 
		where t126.dataclassCode = 't126' and t126.c01 = concat(v_unit_dataId,'') and d.typename = 'is' and d.data_value = '1' ;
			
	else
		if stemP>0 then -- 无财政统发人员
			update t126 ,sys_s_data d set c22 = d.id 
			where c01 = concat(v_unit_dataId,'') and d.typename = 'is' and d.data_value = '0' ;
			
			update data_record_t126 t126,sys_s_data d set t126.c22 = d.id 
			where t126.dataclassCode = 't126' and t126.c01 = concat(v_unit_dataId,'') and d.typename = 'is' and d.data_value = '0' ;
			
		end if;
	end if;
	
  set resultMsg = concat('共stemNum:',stemNum,'人!');
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`p_init_ds`(IN v_unit_id varchar(50) ,
INOUT resultMsg varchar(10000) CHARSET utf8)
label_pro:BEGIN	
-- v_unit_id 单位代码
	DECLARE v_unit_dataId varchar(100);-- 单位id
	DECLARE v_unit_data_name varchar(100);-- 单位名称
	call p_init_table_ds_c(v_unit_id,resultMsg);-- 重新加载需要导入的这些表ds_t1-ds_t14
	-- call p_init_ds_t111_0(v_unit_id,resultMsg);-- 加载ds_t1
	if resultMsg != '' then
		leave label_pro; 
	end if;
	select id,c02 into v_unit_dataId,v_unit_data_name from t111 where c01 = v_unit_id;
	
	call p_init_ds_t113(v_unit_id,v_unit_dataId,v_unit_data_name,resultMsg);-- 调用部门初始化过程
	
	call p_init_ds_t126(v_unit_id,v_unit_dataId,v_unit_data_name,resultMsg);-- 调用人员基本信息初始化过程

	--  调用自动改变人员序号的过程
	call p_init_autoRecord (v_unit_dataId,resultMsg);
	
	call p_init_ds_t125(v_unit_id,v_unit_dataId,v_unit_data_name,resultMsg);-- 调用人员工资信息初始化过程
	
	call p_init_ds_t131(v_unit_id,v_unit_dataId,v_unit_data_name,resultMsg);-- 调用人员套改信息初始化过程
	
	call p_init_ds_t117(v_unit_id,v_unit_dataId,v_unit_data_name,resultMsg);-- 调用人员津补贴信息初始化过程

	call p_init_ds_t115(v_unit_id,v_unit_dataId,v_unit_data_name,resultMsg);-- 调用单位津补贴信息初始化过程
	
	call p_init_ds_money(v_unit_id,v_unit_dataId,v_unit_data_name,resultMsg);-- 调用人员重新计算工资过程
	-- 调用生成单位人员变动记录
	call p_insert_unit_record(1,0,v_unit_dataId,resultMsg);
	
	-- 调用生成单位 旧系统 历史记录 过程
	call p_init_record_ds(v_unit_id,resultMsg);
	
	
	call p_init_ds_t121(v_unit_id,v_unit_dataId,v_unit_data_name,resultMsg);-- 调用人员任职简历初始化过程
	
	call p_init_ds_t122(v_unit_id,v_unit_dataId,v_unit_data_name,resultMsg);-- 调用人员学习简历初始化过程
	
	call p_init_ds_t124(v_unit_id,v_unit_dataId,v_unit_data_name,resultMsg);-- 调用人员年度考核情况初始化过程
	
	call p_init_ds_t112(v_unit_id,v_unit_dataId,v_unit_data_name,resultMsg);-- 调用单位编制初始化过程
	
	-- ds_t11_c 单位部门表
	
	
	call p_init_ds_t177(v_unit_id,v_unit_dataId,v_unit_data_name,resultMsg);-- 调用人员奖惩情况初始化过程

	 -- 调用  地税 根据人员任职简历获取人员初始套改时的现任职级,是否领导
	call p_getTgInit_ds(v_unit_dataId,resultMsg);
 	select count(1) into @stem from t115 where c02 = concat(v_unit_dataId,'') and ifnull(c03,'')!='';
	call p_init_checkRyjbt_Less(v_unit_dataId,@stem,resultMsg);-- 检查人员津补贴条数是否少于单位津补贴
	-- 获取单位表13补充 字段表并获取单位工资制度 
	call p_init_ds_t111(v_unit_id,resultMsg);
	-- 生成地税导入单位数据汇总情况表
	call p_init_ds_result(v_unit_dataId,resultMsg);
	
	-- 未单独处理 人民警察 法官 检察官 司法类人员 地勘类人员

commit;
end;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`p_init_ds_addDWJBT`(IN dwdm varchar(200),
In jbtmc varchar(200),
INOUT resultMsg varchar(1000) CHARSET utf8)
label_pro:BEGIN	

select count(1) into @jbtCount from t116 WHERE c03=concat(jbtmc,'');
if @jbtCount = 0 then 
	set resultMsg = concat('津补贴名称[',jbtmc,']在系统不存在!');leave label_pro;
end if;
SET @dwid=(SELECT id FROM t111 WHERE c01=concat(dwdm,''));
--  高海拔地区折算工龄补贴 43  10369 回民补贴 3 10367
SET @jbtid=(SELECT id FROM t116 WHERE c03=concat(jbtmc,''));
SET @jbtlb=(SELECT c04 FROM t116 WHERE c03=concat(jbtmc,''));
set @isAdd=(select count(1) from t115 where c02=concat(@dwid,'') and c03=concat(@jbtid,''));
--  给整个市区添加津补贴   
--  c05 津补贴类别  国家规定 10367  地方出台  10369
--  给某个单位添加  某项津补贴   是否用于在职人员 10487-是
--  c06 是否为公式  c07执行金额
-- 如果单位不存在该项津补贴才添加
if @isAdd=0 THEN
INSERT into t115 (dataclassCode,createrId,createDate,updaterId,updateDate,unitId,c01,c02,c03,c04,c05,c06,c07,c11,c12)
	VALUES ('t115','1',SYSDATE(),'1',SYSDATE(),0,'10487',@dwid,@jbtid,@jbtid,@jbtlb,'','',jbtmc,jbtmc);
end if;

-- 给单位人员添加津补贴  金额默认为0 如果存在就不添加   变动记录也需要添加
INSERT INTO data_record_t117 (unitId,dataclassCode,createrId,createDate,updaterId,updateDate,operateId,operateTime,operateType,
c02,c03,c04,c05,c07,c12,changeType,changeSign)
SELECT 0,'t117','1',SYSDATE(),'1',SYSDATE(),'1',SYSDATE(),'1',@dwid,a.id,@jbtid,@jbtid,'0',jbtmc,a.c40,''
	from t126 a WHERE
   a.c01=concat(@dwid,'') AND a.id NOT in(SELECT c03 FROM t117 WHERE c03 = concat(a.id,'') and c02=concat(@dwid,'') AND c04=concat(@jbtid,''));

INSERT INTO t117 (dataclassCode,createrId,createDate,updaterId,updateDate,unitId,c02,c03,c04,c05,c07,c12)
SELECT 't117','1',SYSDATE(),'1',SYSDATE(),0,@dwid,a.id,@jbtid,@jbtid,'0',jbtmc
	from t126 a WHERE
   a.c01=concat(@dwid,'') AND a.id NOT in(SELECT c03 FROM t117 WHERE c02=concat(@dwid,'') AND c04=concat(@jbtid,''));

-- 添加完t117表后 再更新变动记录的dataId 并获取到录入新进人员的changeSign
UPDATE data_record_t117 a,data_record_t126 b SET a.changeSign=b.changeSign WHERE b.c01 = concat(@dwid,'') and a.c02=concat(@dwid,'')
-- AND a.dataclassCode='t117' AND b.dataclassCode='t126'
AND a.c04=concat(@jbtid,'') AND b.dataId = a.c03 and a.changeType = b.changeType AND a.changeSign = '';

UPDATE data_record_t117 a,t117 b SET a.dataId=b.id WHERE a.c02=concat(@dwid,'') -- AND a.dataclassCode='t117' 
AND a.c04=concat(@jbtid,'')
AND a.c02=b.c02 AND a.c03=b.c03 AND a.c04=b.c04;

END;

CREATE DEFINER = `root`@`localhost` PROCEDURE `smso-migration-v2`.`p_init_ds_changeDWDM`(IN oldDWDM varchar(200),
In newDWDM varchar(200),
INOUT resultMsg varchar(1000) CHARSET utf8)
label_pro:BEGIN	


-- 查询单位id
UPDATE t130 a SET a.c01=newDWDM WHERE a.c01=oldDWDM;
UPDATE sys_s_user SET name=newDWDM WHERE name=oldDWDM;

SET @dwid=(SELECT id FROM t111 WHERE c01=newDWDM);
-- UPDATE t111 SET c01=newDWDM WHERE c01=oldDWDM;
-- UPDATE t130 SET c01=newDWDM WHERE c01=oldDWDM;
-- UPDATE sys_s_user SET name=newDWDM WHERE name=oldDWDM;
UPDATE t113 SET c02=REPLACE(c02,oldDWDM,newDWDM) WHERE c01=@dwid;
UPDATE t126 SET c02=REPLACE(c02,oldDWDM,newDWDM) WHERE c01=@dwid;
UPDATE data_auto_record SET autoHead=newDWDM WHERE autoHead=oldDWDM;
UPDATE data_record_t126 a,t126 b SET a.c02=b.c02 WHERE a.dataclassCode='t126' AND a.dataId=b.id;

END;

CREATE DEFINER = `root`@`localhost` PROCEDURE `smso-migration-v2`.`p_init_ds_deleteDWJBT`(IN dwdm varchar(200),
In jbtmc varchar(200),
INOUT resultMsg varchar(1000) CHARSET utf8)
label_pro:BEGIN	


SET @dwid=(SELECT id FROM t111 WHERE c01=concat(dwdm,''));
--  高海拔地区折算工龄补贴 43  10369 回民补贴 3 10367
SET @jbtid=(SELECT id FROM t116 WHERE c03=concat(jbtmc,''));

delete from t115 where c02=@dwid and c03=concat(@jbtid,'');
delete from data_record_t117  where c02=concat(@dwid,'') and c04=concat(@jbtid,'') and dataclassCode='t117';
delete from t117  WHERE c02=concat(@dwid,'') and c04=concat(@jbtid,'');
   


END;

CREATE DEFINER = `root`@`localhost` PROCEDURE `smso-migration-v2`.`p_init_ds_money`(IN v_unit_id varchar(200),IN v_unit_dataId varchar(200),
In v_unit_data_name varchar(200),
INOUT resultMsg varchar(1000) CHARSET utf8)
label_pro:BEGIN	
-- 调用人员重新计算工资过程
	if v_unit_dataId = '' then 
		select id,c01,c02 into v_unit_dataId,v_unit_id,v_unit_data_name from t111 where c01 = concat(v_unit_id,'');
	else
		select id,c01,c02 into v_unit_dataId,v_unit_id,v_unit_data_name from t111 where id = v_unit_dataId;
	end if;
	select count(1) into @c from t111 where c01 = v_unit_id;
	if @c = 0 then 
		set resultMsg = '单位数据未进入t111表,请先处理!';leave label_pro;
	end if;
	-- 更新人员津补贴小计为t117表金额之和 
	update t125  
	set t125.c27 =(select sum(t117.c07) from t117 where t125.c06 = t117.c03
	) where t125.c05 = concat(v_unit_dataId,''); 
	-- 更新人员工资合计
	update t125 set 
	c32 = ifnull(c25,0)+ifnull(c26,0) + ifnull(c28,0) + ifnull(c29,0) + ifnull(c30,0) + ifnull(c31,0)+ifnull(c27,0)+ifnull(c44,0)+ifnull(c45,0)+ifnull(c47,0) +0
	where c05 = concat(v_unit_dataId,'');
END;

CREATE DEFINER = `root`@`localhost` PROCEDURE `smso-migration-v2`.`p_init_ds_moneyAndRecord`(IN v_unit_id varchar(200),IN v_unit_dataId varchar(200),
In v_unit_data_name varchar(200),
INOUT resultMsg varchar(1000) CHARSET utf8)
label_pro:BEGIN	
-- 调用人员重新计算津补贴小计以及工资合计 更新t125 ,data_data_record 
	select count(1) into @c from t111 where c01 = concat(v_unit_id,'');
	if @c = 0 then 
		set resultMsg = '单位数据未进入t111表,请先处理!';leave label_pro;
	end if;
	if v_unit_dataId = '' then 
		select id,c02 into v_unit_dataId,v_unit_data_name from t111 where c01 = concat(v_unit_id,'');
	end if;
	-- 更新人员津补贴小计为t117表金额之和 
	update t125  
	set t125.c27 =(select sum(t117.c07) from t117 where t125.c06 = t117.c03)
	where t125.c05 = concat(v_unit_dataId,''); 
	-- 更新人员工资合计
	update t125 set 
	c32 = ifnull(c25,0)+ifnull(c26,0) + ifnull(c28,0) + ifnull(c29,0) + ifnull(c30,0) + ifnull(c31,0)+ifnull(c27,0)+ifnull(c44,0)+ifnull(c45,0)+ifnull(c47,0) +0
	where c05 = concat(v_unit_dataId,'');
	
	-- 更新人员津补贴小计为t117表金额之和 
	update data_record_t125 t125
	set t125.c27 =(select sum(t117.c07) from t117 where t125.c06 = t117.c03)
	where t125.c05 = concat(v_unit_dataId,''); 
	
	-- 更新人员工资合计
	update data_record_t125 set 
	c32 = ifnull(c25,0)+ifnull(c26,0) + ifnull(c28,0) + ifnull(c29,0) + ifnull(c30,0) + ifnull(c31,0)+ifnull(c27,0)+ifnull(c44,0)+ifnull(c45,0)+ifnull(c47,0) +0
	where dataclassCode = 't125' and c05 = concat(v_unit_dataId,'');
	 
	
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`p_init_ds_result`(IN v_unit_dataId varchar(50) ,
INOUT resultMsg varchar(10000) CHARSET utf8)
label_pro:BEGIN	
	DECLARE v_unit_id varchar(100);-- 单位代码
	DECLARE v_unit_data_name varchar(100);-- 单位名称
	delete from t_init_ds_result where unitId = concat(v_unit_dataId,'');-- 先删除数据
	select c01,c02 into v_unit_id ,v_unit_data_name from t111 where id = v_unit_dataId;
	-- 单位表
	select count(1) into @c from t111 where id = v_unit_dataId ;
	insert into t_init_ds_result (unitCode,unitId,unitName,dataclassCode,dataclassName,successNum,createDate)
	values (v_unit_id,v_unit_dataId,v_unit_data_name,'t111','单位基本信息表',@c ,sysDate() );
	-- 单位编制表
	select count(1) into @c from t112 where c01 = concat(v_unit_dataId,'') ;
	insert into t_init_ds_result (unitCode,unitId,unitName,dataclassCode,dataclassName,successNum,createDate)
	values (v_unit_id,v_unit_dataId,v_unit_data_name,'t112','单位编制表',@c ,sysDate() );
	-- 部门表
	select count(1) into @c from t113 where c01 = concat(v_unit_dataId,'') ;
	insert into t_init_ds_result (unitCode,unitId,unitName,dataclassCode,dataclassName,successNum,createDate)
	values (v_unit_id,v_unit_dataId,v_unit_data_name,'t113','单位部门表',@c ,sysDate() );
	-- 基层单位津补贴表
	select count(1) into @c from t115 where c02 = concat(v_unit_dataId,'') ;
	insert into t_init_ds_result (unitCode,unitId,unitName,dataclassCode,dataclassName,successNum,createDate)
	values (v_unit_id,v_unit_dataId,v_unit_data_name,'t115','单位津补贴表',@c ,sysDate() );
	-- 人员基本信息表
	select count(1) into @c from t126 where c01 = concat(v_unit_dataId,'') ;
	insert into t_init_ds_result (unitCode,unitId,unitName,dataclassCode,dataclassName,successNum,createDate)
	values(v_unit_id, v_unit_dataId,v_unit_data_name,'t126','单位人员基本信息表',@c ,sysDate() );
	-- 人员工资信息表
	select count(1) into @c from t125 where exists (select 1 from t126 where id = t125.c06 and c01 = concat(v_unit_dataId,'')) ;
	insert into t_init_ds_result (unitCode,unitId,unitName,dataclassCode,dataclassName,successNum,createDate)
	values(v_unit_id, v_unit_dataId,v_unit_data_name,'t125','人员工资信息表',@c ,sysDate() );
	-- 人员津补贴表
	select count(1) into @c from t117,t126 where t126.id = t117.c03 and t126.c01 = concat(v_unit_dataId,'') ;
	insert into t_init_ds_result (unitCode,unitId,unitName,dataclassCode,dataclassName,successNum,createDate)
	values(v_unit_id, v_unit_dataId,v_unit_data_name,'t117','人员津补贴表',@c ,sysDate() );
	-- 人员套改表
	select count(1) into @c from t131,t126 where t126.id = t131.c01 and t126.c01 = concat(v_unit_dataId,'') ;
	insert into t_init_ds_result (unitCode,unitId,unitName,dataclassCode,dataclassName,successNum,createDate)
	values(v_unit_id, v_unit_dataId,v_unit_data_name,'t131','人员套改表',@c ,sysDate() );
	-- 人员任职简历表
	select count(1) into @c from t121,t126 where t126.id = t121.c02 and t126.c01 = concat(v_unit_dataId,'') ;
	insert into t_init_ds_result (unitCode,unitId,unitName,dataclassCode,dataclassName,successNum,createDate)
	values(v_unit_id, v_unit_dataId,v_unit_data_name,'t121','人员任职简历表',@c ,sysDate() );
	-- 人员学习简历表
	select count(1) into @c from t122,t126 where t126.id = t122.c02 and t126.c01 = concat(v_unit_dataId,'') ;
	insert into t_init_ds_result (unitCode,unitId,unitName,dataclassCode,dataclassName,successNum,createDate)
	values(v_unit_id, v_unit_dataId,v_unit_data_name,'t122','人员学习简历表',@c ,sysDate() );
	-- 人员年度考核表
	select count(1) into @c from t124,t126 where t126.id = t124.c03 and t126.c01 = concat(v_unit_dataId,'') ;
	insert into t_init_ds_result (unitCode,unitId,unitName,dataclassCode,dataclassName,successNum,createDate)
	values(v_unit_id, v_unit_dataId,v_unit_data_name,'t124','人员年度考核表',@c ,sysDate() );
	-- 人员奖惩情况表
	select count(1) into @c from t177,t126 where t126.id = t177.c01 and t126.c01 = concat(v_unit_dataId,'') ;
	insert into t_init_ds_result (unitCode,unitId,unitName,dataclassCode,dataclassName,successNum,createDate)
	values(v_unit_id, v_unit_dataId,v_unit_data_name,'t177','人员奖惩情况表',@c ,sysDate() );
	
	commit;
end;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`p_init_ds_t111`(IN v_unit_id varchar(50) ,
INOUT resultMsg varchar(10000) CHARSET utf8)
label_pro:BEGIN	
-- 地税数据导入后 针对ds_t14 即表13.基层单位信息补充字段表 进行更新
-- v_unit_id 单位代码
	DECLARE v_unit_dataId varchar(100);-- 单位id
	DECLARE v_unit_data_name varchar(100);-- 单位名称

	select count(1) into @t111Count from t111 where c01 = v_unit_id; 
	if  @t111Count  = 0 then
		set resultMsg = '当前单位数据未进入t111表,请先处理数据再做补充表的完善!';leave label_pro; 
	end if;
	select count(1) into @c from ds_t14 where dwdmandmc like concat(v_unit_id,'/%') 
	or dwdmandmc = v_unit_dataId;-- 判断基础数据
	if  @c = 0 then 
		set resultMsg = '当前单位未填写基层单位补充字段表';
		leave label_pro;
	end if;
	select id,c02 into v_unit_dataId,v_unit_data_name from t111 where c01 = v_unit_id;
	delete from ds_t14_c where dwdmandmc like concat(v_unit_id,'/%') or dwdmandmc = v_unit_id ;
	delete from ds_t14_c where dwdmandmc = concat(v_unit_dataId,'');-- 删除已经存在的数据
	insert into ds_t14_c 
	select * from ds_t14 where dwdmandmc like concat(v_unit_id,'/%') or dwdmandmc = concat(v_unit_dataId,'') ;-- 插入基础数据

	update ds_t14_c set dwdmandmc = concat(v_unit_dataId,'') 
	where dwdmandmc like concat(v_unit_id,'/%') or dwdmandmc = v_unit_id ;-- 单位代码或名称

	-- 处理单位驻地
	select ifnull(dwzd,'') into @dwzd from ds_t14_c where dwdmandmc = concat(v_unit_dataId,'');
	-- 如果驻地如: XX市XX市的情况 排除 内江市市中区的情况
	set @dwzd_sj = '';-- 单位驻地 市州级 
	if position('省' in @dwzd)>0 then -- 四川省自贡市自流井区XX街道 四川省阿坝州壤塘县XX塘街26号
		select substring(@dwzd from position('省' in @dwzd)+1) into @dwzd; -- 结果: 自贡市自流井区 阿坝州壤塘县XX塘街26号
	end if;
 	if position('州' in @dwzd)>0 then 
 		-- 如果存在州 且州在市的前面  阿坝州壤塘县XX塘街26号  
 		if  position('市' in @dwzd) > 0 and position('州' in @dwzd) < position('市' in @dwzd) then 
		-- 如果存在 州市这种情况 达州市
			select substring(@dwzd from 1 for position('州' in @dwzd)) into @dwzd_sj; -- 阿坝州
			select count(1) into @c from sys_s_data d where d.name = @dwzd_sj and d.typename = 'locale';
			if @c = 0 then 
				if position('州市' in @dwzd)>0 then -- 如果不存在州存在市 四川省达州市自流井区
					select substring(@dwzd from 1 for position('州市' in @dwzd)+2) into @dwzd_sj; -- 达州市
		 		end if;
			end if;
		else
			select substring(@dwzd from 1 for position('州' in @dwzd)) into @dwzd_sj; -- 达州市
		end if;
 	else
 		if position('市' in @dwzd)>0 then -- 如果不存在州存在市 四川省自贡市自流井区
			select substring(@dwzd from 1 for position('市' in @dwzd)) into @dwzd_sj; -- 自贡市
	 	end if;
 	end if;
	if @dwzd != '' then
		 if position('县' in @dwzd)>0 or position('区' in @dwzd)>0 then 
		 	if position('县' in @dwzd)>0 then 
				select substring(@dwzd from 1 for position('县' in @dwzd)) into @dwzd; 
			else
				select substring(@dwzd from 1 for position('区' in @dwzd)) into @dwzd; 
			end if; 
		 	if @dwzd_sj!='' then 
		 		select replace(@dwzd,@dwzd_sj,'') into @dwzd;
		 	end if;
		 else 
		 	if @dwzd_sj!='' then 
		 		set @dwzd = @dwzd_sj;
		 	end if;
		end if;
		select id into @dwzd from sys_s_data where typename = 'locale' and name = @dwzd;
	end if;
	
	-- 处理单位工资制度
	-- 查询当前单位是否存在机关的人员
	select count(1) into @jgCount from t126 
	where c01 = concat(v_unit_dataId,'') 
	and exists(-- 单位工资制度与人员属性对应关系
		select 1 from t136 where t136.c02 = t126.c28 
		and exists(select 1 from sys_s_data d where d.id = t136.c06 and d.typename = 'personSort'
			and d.name = '机关' 
		)
	);
	-- 查询当前单位是否存在事业的人员
	select count(1) into @syCount from t126 
	where c01 = concat(v_unit_dataId,'') 
	and exists(-- 单位工资制度与人员属性对应关系
		select 1 from t136 where t136.c02 = t126.c28 
		and exists(select 1 from sys_s_data d where d.id = t136.c06 and d.typename = 'personSort'
			and d.name = '事业' 
		)
	);
	set @dwgzzd = '机关工资制度';
	if @jgCount > 0 then 
		if @syCount > 0 then 
			set @dwgzzd = '机关、事业两种制度并存';
		end if;
	else 
		if @syCount > 0 then 
			set @dwgzzd = '事业单位工资制度';
		end if;
	end if ;
	select id into @dwgzzd from sys_s_data where typename = 'wageScheme' and name = @dwgzzd;
	
	update t111,ds_t14_c set c15=dwczbm,-- c03=@dwzd,c13 = @dwgzzd,
	 c23=zdhb, c21=pjhb, c20=jblb ,c06=dwdh ,c07=dwfzr,
	 c08=yb, c10=dwjb ,c18=sydwhy,c16=sydwlx ,c19=sfjgfwzx, c22=sfzgdw, c11=sjzgdw,updateDate = sysdate(),
	 updaterId = 1
	where t111.id =dwdmandmc and t111.id=v_unit_dataId;
		
	-- 更新单位驻地为码表id
	update t111 c set c.c03 = @dwzd where c.id = v_unit_dataId;
	-- 更新执行工资制度为码表id
	update t111 set c13 = @dwgzzd where id = v_unit_dataId;
	-- 更新驻地海拔为码表id
	update t111 c,sys_s_data d set c.c23 = d.id 
		where c.c23 = d.name and d.typename = 'ghblb' and c.id = v_unit_dataId;
	-- 更新平均海拔为码表id
	update t111 c,sys_s_data d set c.c21 = d.id 
		where c.c21 = d.name and d.typename = 'ghblb' and c.id = v_unit_dataId;
	-- 更新艰边类别为码表id
	update t111 c,sys_s_data d set c.c20 = d.id 
		where c.c20 = d.name and d.typename = 'dwjblb' and c.id = v_unit_dataId;
	-- 更新单位级别为码表id
	update t111 c,sys_s_data d set c.c10 = d.id 
		where c.c10 = d.name and d.typename = 'grade'  and c.id = v_unit_dataId;
	-- 更新事业单位行业为码表id
	update t111 c,sys_s_data d set c.c18 = d.id 
		where c.c18 = d.name and d.typename = 'pubInsIndustry' and c.id = v_unit_dataId;
	-- 更新事业单位类型为码表id
	update t111 c,sys_s_data d set c.c16 = d.id 
		where c.c16 = d.name and d.typename = 'pubInsType' and c.id = v_unit_dataId;
		
	-- 更新是否机关服务中心为码表id
	update t111 c,sys_s_data d set c.c19 = d.id 
		where c.c19 = d.name and d.typename = 'is' and c.id = v_unit_dataId;
	-- 更新是否主管单位为码表id
	update t111 c,sys_s_data d set c.c22 = d.id 
		where c.c22 = d.name and d.typename = 'is' and c.id = v_unit_dataId;
	-- 更新主管单位为对应关系的数据 
	update t111 c,t111 z set c.c11 = z.id 
		where c.c11 = z.c02 and c.id = v_unit_dataId;
	
	update t111 ,ds_t14_c c
	set c04 = c.dwzd where ifnull(c04,'')=''
	and t111.id = v_unit_dataId;-- 如果单位地址为空 默认为驻地
	-- 处理财政供养为空时为全部人员
	update t111,sys_s_data d 
	set c12 = d.id  where t111.id = v_unit_dataId
	and d.typename = 'finSupport' and d.name = '全部人员'
	and ifnull(c12,'')='' 
	; 
	-- 处理财政统发为空时为全部人员
	update t111 ,sys_s_data d
	set c14 = d.id where t111.id = v_unit_dataId
	and d.typename = 'finPay' and d.name = '全部人员'
	and ifnull(c14,'')='';
	
		
commit;
end;

CREATE DEFINER = `root`@`localhost` PROCEDURE `smso-migration-v2`.`p_init_ds_t111_0`(IN v_unit_id varchar(200),
INOUT resultMsg varchar(1000) CHARSET utf8)
label_pro:BEGIN	
-- 初始化单位表
	select count(1) into @c from ds_t1 where dwdm = v_unit_id;
	if @c = 0 then 
		set resultMsg = concat('系统不存在地税单位代码', v_unit_id);
		leave label_pro;
	end if;
	delete from ds_t1_c where dwdm = v_unit_id;
	insert into ds_t1_c select * from ds_t1 where dwdm = v_unit_id;
	
	-- 更新单位性质为对应关系的数据 
	update ds_t1_c c,ds_zh z set c.dwxz = z.my_name 
		where c.dwxz = z.ds_name and z.table_name = 'ds_t1_c' and table_column = 'dwxz' 
		and dwdm = v_unit_id ;
	-- 更新单位性质为码表id
	update ds_t1_c c,sys_s_data d set c.dwxz = d.id 
		where c.dwxz = d.name and d.typename = 'nature' and dwdm = v_unit_id;
		
	-- 更新单位驻地为对应关系的数据 
	update ds_t1_c c,ds_zh z set c.dwzd = z.my_name 
		where c.dwzd = z.ds_name and z.table_name = 'ds_t1_c' and table_column = 'dwzd' 
		and dwdm = v_unit_id ;
	-- 更新单位驻地为码表id
	update ds_t1_c c,sys_s_data d set c.dwzd = d.id 
		where c.dwzd = d.name and d.typename = 'locale' and dwdm = v_unit_id;
		
	-- 更新隶属关系为对应关系的数据 
	update ds_t1_c c,ds_zh z set c.lsgx = z.my_name 
		where c.lsgx = z.ds_name and z.table_name = 'ds_t1_c' and table_column = 'lsgx' 
		and dwdm = v_unit_id ;
	-- 更新隶属关系为码表id
	update ds_t1_c c,sys_s_data d set c.lsgx = d.id 
		where c.lsgx = d.name and d.typename = 'subjection' and dwdm = v_unit_id;
		
	-- 更新执行工资制度为对应关系的数据 
	update ds_t1_c c,ds_zh z set c.zxgzzd = z.my_name 
		where c.zxgzzd = z.ds_name and z.table_name = 'ds_t1_c' and table_column = 'zxgzzd' 
		and dwdm = v_unit_id ;
	-- 更新执行工资制度为码表id
	update ds_t1_c c,sys_s_data d set c.zxgzzd = d.id 
		where c.zxgzzd = d.name and d.typename = 'wageScheme' and dwdm = v_unit_id;
		
	-- 更新事业单位类型为对应关系的数据 
	update ds_t1_c c,ds_zh z set c.sydwlx = z.my_name 
		where c.sydwlx = z.ds_name and z.table_name = 'ds_t1_c' and table_column = 'sydwlx' 
		and dwdm = v_unit_id ;
	-- 更新单位类型为码表id
	update ds_t1_c c,sys_s_data d set c.sydwlx = d.id 
		where c.sydwlx = d.name and d.typename = 'pubInsType' and dwdm = v_unit_id;
		
	-- 更新事业单位行业为对应关系的数据 
	update ds_t1_c c,ds_zh z set c.sydwhy = z.my_name 
		where c.sydwhy = z.ds_name and z.table_name = 'ds_t1_c' and table_column = 'sydwhy' 
		and dwdm = v_unit_id ;
	-- 更新单位类型为码表id
	update ds_t1_c c,sys_s_data d set c.sydwhy = d.id 
		where c.sydwlx = d.name and d.typename = 'pubInsIndustry' and dwdm = v_unit_id;
		
	-- 更新单位级别为对应关系的数据 
	update ds_t1_c c,ds_zh z set c.dwjb = z.my_name 
		where c.dwjb = z.ds_name and z.table_name = 'ds_t1_c' and table_column = 'dwjb' 
		and dwdm = v_unit_id ;
	-- 更新单位级别为码表id
	update ds_t1_c c,sys_s_data d set c.dwjb = d.id 
		where c.dwjb = d.name and d.typename = 'grade' and dwdm = v_unit_id;
		
	-- 更新财政供养为对应关系的数据 
	update ds_t1_c c,ds_zh z set c.czgy = z.my_name 
		where c.czgy = z.ds_name and z.table_name = 'ds_t1_c' and table_column = 'czgy' 
		and dwdm = v_unit_id ;
	-- 更新财政供养为码表id
	update ds_t1_c c,sys_s_data d set c.czgy = d.id 
		where c.czgy = d.name and d.typename = 'finSupport' and dwdm = v_unit_id;
		
	-- 更新经费来源为对应关系的数据 
	update ds_t1_c c,ds_zh z set c.jfly = z.my_name 
		where c.jfly = z.ds_name and z.table_name = 'ds_t1_c' and table_column = 'jfly' 
		and dwdm = v_unit_id ;
	-- 更新经费来源为码表id
	update ds_t1_c c,sys_s_data d set c.jfly = d.id 
		where c.jfly = d.name and d.typename = 'pubInsFundSrc' and dwdm = v_unit_id;
		
	-- 更新是否机关服务中心为对应关系的数据 
	update ds_t1_c c,ds_zh z set c.sfjgfwzx = z.my_name 
		where c.sfjgfwzx = z.ds_name and z.table_name = 'ds_t1_c' and table_column = 'sfjgfwzx' 
		and dwdm = v_unit_id ;
	-- 更新是否机关服务中心为码表id
	update ds_t1_c c,sys_s_data d set c.sfjgfwzx = d.id 
		where c.sfjgfwzx = d.name and d.typename = 'is' and dwdm = v_unit_id;
		
	-- 更新艰边类别为对应关系的数据 
	update ds_t1_c c,ds_zh z set c.jblb = z.my_name 
		where c.jblb = z.ds_name and z.table_name = 'ds_t1_c' and table_column = 'jblb' 
		and dwdm = v_unit_id ;
	-- 更新艰边类别为码表id
	update ds_t1_c c,sys_s_data d set c.jblb = d.id 
		where c.jblb = d.name and d.typename = 'dwjblb' and dwdm = v_unit_id;
		
	-- 更新平均海拔为对应关系的数据 
	update ds_t1_c c,ds_zh z set c.pjhb = z.my_name 
		where c.pjhb = z.ds_name and z.table_name = 'ds_t1_c' and table_column = 'pjhb' 
		and dwdm = v_unit_id ;
	-- 更新平均海拔为码表id
	update ds_t1_c c,sys_s_data d set c.pjhb = d.id 
		where c.pjhb = d.name and d.typename = 'ghblb' and dwdm = v_unit_id;
		
	-- 更新驻地海拔为对应关系的数据 
	update ds_t1_c c,ds_zh z set c.zdhb = z.my_name 
		where c.zdhb = z.ds_name and z.table_name = 'ds_t1_c' and table_column = 'zdhb' 
		and dwdm = v_unit_id ;
	-- 更新驻地海拔为码表id
	update ds_t1_c c,sys_s_data d set c.zdhb = d.id 
		where c.zdhb = d.name and d.typename = 'ghblb' and dwdm = v_unit_id;
		
	-- 更新党群政府群团标志为对应关系的数据 
	update ds_t1_c c,ds_zh z set c.dqzfqtbz = z.my_name 
		where c.dqzfqtbz = z.ds_name and z.table_name = 'ds_t1_c' and table_column = 'dqzfqtbz' 
		and dwdm = v_unit_id ;
	-- 更新党群政府群团标志为码表id
	update ds_t1_c c,sys_s_data d set c.dqzfqtbz = d.id 
		where c.dqzfqtbz = d.name and d.typename = 'qtbz' and dwdm = v_unit_id;
		
	-- 更新主管单位为对应关系的数据 
	update ds_t1_c c,ds_zh z set c.zgdw = z.my_name 
		where c.zgdw = z.ds_name and z.table_name = 'ds_t1_c' and table_column = 'zgdw' 
		and dwdm = v_unit_id ;
	-- 更新主管单位为t127.id
	update ds_t1_c c,t111 d set c.zgdw = d.id 
		where c.zgdw = d.c02 and dwdm = v_unit_id;
-- ds_t1_c 单位基本信息表   财政供养财政统发默认全部人员
	select count(1) into @c from t111 where c01 = v_unit_id;
	if @c > 0 then 
		update t111,ds_t1_c set c01=dwdm,c02=dwmc,c03=dwzd,
		c04=dwdz,c05=dwxz,c06=dwdh,c07=dwfzr,c08=yb,
		c09=lsgx,c10=dwjb,c11=zgdw,c12=czgy,c13=zxgzzd,
		-- c14=cztf,
		c15=yb,
		c16=sydwlx,c17=jfly,c18=sydwhy,c19=sfjgfwzx,
		c20=jblb,c21=pjhb,c22=sfzgdw,c23=zdhb,c25=dqzfqtbz
		where t111.c01 = v_unit_id and t111.c01 = ds_t1_c.dwdm;
	else 
		INSERT INTO t111(createrId,createDate,updaterId,updateDate,dataclassCode,c01,c02,
		c03,c04,c05,c06,c07,c08,
		c09,c10,c11,c12,c13,
		-- c14,
		c15,c16,c17,c18,
		c19,c20,c21,c22,c23,c25) 
		SELECT 1,sysdate(),1,sysdate(),'t111',dwdm,dwmc,
		dwzd,dwdz,dwxz,dwdh,dwfzr,yb,
		lsgx,dwjb,zgdw,czgy,zxgzzd,
		-- cztf,
		yb,
		sydwlx,jfly,sydwhy,sfjgfwzx,
		jblb,pjhb,sfzgdw,zdhb,dqzfqtbz FROM ds_t1_c
		where dwdm = v_unit_id
		and not exists (select 1 from t111 where ds_t1_c.dwmc=t111.c02) AND ds_t1_c.dwmc!='';
	end if;
END;

CREATE DEFINER = `root`@`localhost` PROCEDURE `smso-migration-v2`.`p_init_ds_t112`(IN v_unit_id varchar(200),IN v_unit_dataId varchar(200),
In v_unit_data_name varchar(200),
INOUT resultMsg varchar(1000) CHARSET utf8)
label_pro:BEGIN	
-- 初始化单位编制表
	select count(1) into @c from t111 where c01 = v_unit_id;
	if @c = 0 then 
		set resultMsg = '单位数据未进入t111表,请先处理!';leave label_pro;
	end if;
	if v_unit_dataId = '' then 
		select id,c02 into v_unit_dataId,v_unit_data_name from t111 where c01 = v_unit_id;
	end if;
	-- delete from ds_t12_c where dwmc in (v_unit_dataId,v_unit_id,v_unit_data_name);
	-- insert into ds_t12_c select * from ds_t12 where dwmc in (v_unit_dataId,v_unit_id,v_unit_data_name);
	-- ds_t12_c 单位编制表
	-- UPDATE ds_t12_c set dwdm=(select id from t111 where c01=dwdm) where 1=1 and dwdm=v_unit_id;	
	update ds_t12_c c,t111 set c.dwdm = t111.id where c.dwdm = t111.c01 and t111.c01 = v_unit_id;
	UPDATE t112,ds_t12_c set updateDate=sysdate(),c02=xzbz,c03=dlbz,c04=jjbz,c05=jzbz,c06=zfzxbzhj,c24=gazxbz,c25=jcyzxbz,
		c21=fyzxbz,c22=sfzxbz,c23=aqzxbz,c16=sybzhj,c17=qebkbzhj,c07=jggqrykzs,c08=qebksybz,c09=qebksybz_hgqbz,c10=xzzflsybz,
		c11=xzzflsybz_hgqbz,c12=cebkbz,c13=zszzbz,c14=tzjgxzbzhj,c15=xzbzhj where c01=concat(v_unit_dataId,''); 
	insert into t112 (createrId,createDate,updaterId,updateDate,dataclassCode,unitId,
		c01,c02,c03,c04,c05,c06,c07,c08,c09,c10,c11,c12,c13,c14,c15,c16,c17,c21,c22,c23,c24,c25)
	select 1,sysdate(),1,sysdate(),'t112','0',dwdm,xzbz,dlbz,jjbz,jzbz,zfzxbzhj,jggqrykzs,qebksybz,qebksybz_hgqbz,xzzflsybz,
		xzzflsybz_hgqbz,cebkbz,zszzbz,tzjgxzbzhj,xzbzhj,sybzhj,qebkbzhj,fyzxbz,sfzxbz,aqzxbz,gazxbz,jcyzxbz
		from ds_t12_c a where not exists(select 1 from t112 where c01=a.dwdm);
	
END;

CREATE DEFINER = `root`@`localhost` PROCEDURE `smso-migration-v2`.`p_init_ds_t113`(IN v_unit_id varchar(200),IN v_unit_dataId varchar(200),
In v_unit_data_name varchar(200),
INOUT resultMsg varchar(1000) CHARSET utf8)
label_pro:BEGIN	
-- 初始化单位部门表
	select count(1) into @c from t111 where c01 = v_unit_id;
	if @c = 0 then 
		set resultMsg = '单位数据未进入t111表,请先处理!';leave label_pro;
	end if;
	if v_unit_dataId = '' then 
		select id,c02 into v_unit_dataId,v_unit_data_name from t111 where c01 = v_unit_id;
	end if;
	
	delete from ds_t11_c where dwmc in (v_unit_dataId,v_unit_id,v_unit_data_name);-- 先删除部门
	-- 单位部门表
	INSERT INTO ds_t11_c(bmmc,dwmc) 
	SELECT distinct bm,v_unit_id from ds_t2_c where not exists
	(select 1 from ds_t11_c where dwmc=v_unit_id or dwmc=concat(v_unit_dataId,'')) and bm !='';
	
	UPDATE ds_t11_c set bmbh=concat(dwmc,id) where LENGTH(dwmc)>4;-- 更新部门编号
	
	update ds_t11_c c,t111 set c.dwmc = t111.id where c01 = c.dwmc ;-- 处理单位名称为t111.id
	
	INSERT INTO t113 (createrId,createDate,updaterId,updateDate,dataclassCode,unitId,c01,c02,c03) 
	-- c01-单位代码 c02-部门编号  c03-部门名称
	SELECT  1,sysdate(),1,sysdate(),'t113','0',dwmc,bmbh,bmmc  
	from ds_t11_c where dwmc=concat(v_unit_dataId,'') 
	and not exists
		(select 1 from t113 where c01=ds_t11_c.dwmc and c03=ds_t11_c.bmmc) -- 排除已经存在的部门名称
	and ds_t11_c.dwmc!='';
END;

CREATE DEFINER = `root`@`localhost` PROCEDURE `smso-migration-v2`.`p_init_ds_t115`(IN v_unit_id varchar(200),IN v_unit_dataId varchar(200),
In v_unit_data_name varchar(200),
INOUT resultMsg varchar(1000) CHARSET utf8)
label_pro:BEGIN	
-- 初始化单位津补贴表
	select count(1) into @c from t111 where c01 = v_unit_id;
	if @c = 0 then 
		set resultMsg = '单位数据未进入t111表,请先处理!';leave label_pro;
	end if;
	if v_unit_dataId = '' then 
		select id,c02 into v_unit_dataId,v_unit_data_name from t111 where c01 = v_unit_id;
	end if;
	
	-- 插入单位津补贴表
	insert into t115 (createrId,createDate,updaterId,updateDate,dataclassCode,
		c02,c03,c04,c05,c01,c11,c12
		-- 单位代码 津补贴编号  津补贴名称 津补贴类别 是否用于在职人员 旧版津补贴号 旧版津补贴名称
	)
	select 
		distinct
		1,sysdate(),1,sysdate(),'t115',
		v_unit_dataId,c04,c05,(select c04 from t116 where id = t117.c04),
		-- 单位代码 津补贴编号  津补贴名称 津补贴类别 
		(select id from sys_s_data where typename = 'is' and data_value = '1'),c12,c12
		-- 是否用于在职人员 旧版津补贴号 旧版津补贴名称
	from t117 where c02 = concat(v_unit_dataId,'') 
	and not exists(select 1 from t115 where t115.c02 = concat(v_unit_dataId,'') and t115.c03 = t117.c04);
	
END;

CREATE DEFINER = `root`@`localhost` PROCEDURE `smso-migration-v2`.`p_init_ds_t117`(IN v_unit_id varchar(200),IN v_unit_dataId varchar(200),
In v_unit_data_name varchar(200),
INOUT resultMsg varchar(1000) CHARSET utf8)
label_pro:BEGIN	
-- 初始化人员津补贴表
	select count(1) into @c from t111 where c01 = v_unit_id;
	if @c = 0 then 
		set resultMsg = '单位数据未进入t111表,请先处理!';leave label_pro;
	end if;
	if v_unit_dataId = '' then 
		select id,c02 into v_unit_dataId,v_unit_data_name from t111 where c01 = v_unit_id;
	end if;
	-- delete from ds_t5_c where dwmc in (v_unit_dataId,v_unit_id,v_unit_data_name);
	-- insert into ds_t5_c select * from ds_t5 where dwmc in (v_unit_dataId,v_unit_id,v_unit_data_name);
	
	-- ds_t5_c 人员津补贴表	
	update ds_t5_c set dwmc = concat(v_unit_dataId,'') where dwmc = v_unit_data_name;
	-- 更新人员序号为单位编码+序号
	UPDATE ds_t5_c a SET ryxh=CONCAT((SELECT c01 FROM t111  WHERE id=a.dwmc),
	(CASE LENGTH(a.ryxh) WHEN '1' THEN '0000' WHEN '2' THEN '000' WHEN '3' THEN '00' WHEN '4' THEN '0' WHEN '5' 
	THEN '' END),ryxh) WHERE LENGTH(ryxh)<6
	AND dwmc=concat(v_unit_dataId,'');
	
	-- 更新人员序号为id
	update ds_t5_c c ,t126
	set c.ryxh = t126.id 
	where t126.c01 = c.dwmc and t126.c01 = concat(v_unit_dataId,'') and ryxh = t126.c02;
	-- 更新人员津补贴表里面的津补贴名称为对应关系的津补贴名称
	update ds_t5_c c,ds_zh z set c.jbtmc = z.my_name
	where c.jbtmc = z.ds_name and z.table_name = 'ds_t5_c' and z.table_column = 'jbtmc'
	and c.dwmc = concat(v_unit_dataId,'');
	
	-- 更新人员津补贴金额
	update t117,ds_t5_c c set t117.c07 = zxje
	where t117.c02 = concat(v_unit_dataId,'') 
	and t117.c03 = c.ryxh and t117.c04 = c.jbtmc;  
	-- 插入人员津补贴
	insert into t117(createrId,createDate,updaterId,updateDate,dataclassCode,
		c02,c03,c04,c05,c07,c12
		-- 单位代码 人员编号 津补贴编号 津补贴名称 执行金额 单机版名称
	)
	select 1,sysdate(),1,sysdate(),'t117',
	v_unit_dataId,ryxh,t116.id,t116.id,zxje,jbtmc
	from ds_t5_c c ,t116
	where c.dwmc = concat(v_unit_dataId,'')
	and c.jbtmc = t116.c03 -- 必须是对应起了的数据 
	and not exists(select 1 from t117 where t117.c04 = t116.id and t117.c03 = ryxh );-- 排除已经存在的津贴
	
	-- 更新人员津补贴项目的津补贴名称为我们系统的数据
	/** update t117 ,ds_zh z 
	set t117.c04 = z.my_name,t117.c05=z.my_name where z.table_name = 'ds_t5_c' 
	and z.table_column = 'jbtmc' and z.ds_name = t117.c04 and t117.c02 = v_unit_dataId;
	*/
	
	-- 更新人员津补贴表中的津补贴名称为t116的id
	-- update t117,t116 set t117.c04 = t116.id,t117.c05 = t116.id where t117.c04 = t116.c03 and t117.c02 = v_unit_dataId;
	
	-- delete from t117 where c02 = v_unit_dataId and length(c04)>3 ; 暂时不处理没匹配起的津补贴项目
	
END;

CREATE DEFINER = `root`@`localhost` PROCEDURE `smso-migration-v2`.`p_init_ds_t121`(IN v_unit_id varchar(200),IN v_unit_dataId varchar(200),
In v_unit_data_name varchar(200),
INOUT resultMsg varchar(1000) CHARSET utf8)
label_pro:BEGIN	
-- 初始化人员任职简历
	select count(1) into @c from t111 where c01 = v_unit_id;
	if @c = 0 then 
		set resultMsg = '单位数据未进入t111表,请先处理!';leave label_pro;
	end if;
	if v_unit_dataId = '' then 
		select id,c02 into v_unit_dataId,v_unit_data_name from t111 where c01 = v_unit_id;
	end if;
	-- delete from ds_t7_c where dwmc in (v_unit_dataId,v_unit_id,v_unit_data_name);
	-- insert into ds_t7_c select * from ds_t7 where dwmc in (v_unit_dataId,v_unit_id,v_unit_data_name);
	update ds_t7_c set dwmc = concat(v_unit_dataId,'') where dwmc = v_unit_data_name;
	-- ds_t7_c 人员任职简历
	UPDATE ds_t7_c a  SET rybh=CONCAT(v_unit_id,(CASE LENGTH(a.rybh) WHEN '1' THEN '0000' WHEN '2' THEN '000' WHEN '3' THEN '00' WHEN '4' THEN '0' ELSE '' END),rybh) WHERE LENGTH(rybh)<6;
	-- 修改人员id及身份为t126的数据
	UPDATE ds_t7_c a ,t126
	set xm = t126.id,rysf = t126.c28 where rybh = t126.c02 and t126.c01 = concat(v_unit_dataId,'')
	 and xm = t126.c04 ;
	-- 更新人员身份为汉字
	-- 更新人员身份到任职简历表
	update ds_t7_c c ,sys_s_data d set c.rysf = d.name 
	where c.rysf = d.id and dwmc = concat(v_unit_dataId,'') and d.typename = 'rysf';
	-- 见习期
	 update ds_t7_c c ,ds_zh z set c.zj = z.my_name 
	 where c.dwmc = concat(v_unit_dataId,'') and c.zj like '%习期' and c.zj = z.ds_name 
	 and z.table_name = 'ds_t2_c' and table_column = 'gzdyzj';
	 -- 修改 职级  为对应关系的数据
	 update ds_t7_c c,ds_zh z set c.zj = z.my_name 
	 where c.dwmc = concat(v_unit_dataId,'') and c.zj = z.ds_name and c.rysf = z.remark
	 and z.table_name = 'ds_t2_c' and table_column = 'gzdyzj';
	 
	-- 先将备注处理成职级
	update ds_t7_c set bz = zj where dwmc = concat(v_unit_dataId,'');
	
	-- 处理公务员实际职级
	update ds_t7_c set zj = concat(zj,if(ifnull(drzw,'')='','非领导职务',drzw)) where dwmc = concat(v_unit_dataId,'') 
	and rysf like '%公%' and zj not like '%期'; -- 排除试用期人员 以及 是否领导为空的数据 默认为非领导职务
	
	-- 处理备注-(职级)为码表id
	update ds_t7_c c,sys_s_data d set c.zj = d.id 
	where c.zj = d.name and c.dwmc = concat(v_unit_dataId,'')
	and d.typename = 'sjzj' and rysf like '%公%';
	-- 排除试用期人员 以及 是否领导 为非领导职务但是未匹配起码表的数据
	update ds_t7_c c set zj = replace(zj,'非领导职务','领导职务') where dwmc = concat(v_unit_dataId,'') 
	and rysf like '%公%' and bz not like '%期'; 
	update ds_t7_c c,sys_s_data d set c.zj = d.id 
	where c.zj = d.name and c.dwmc = concat(v_unit_dataId,'')
	and d.typename = 'sjzj' and rysf like '%公%' and bz not like '%期'; 
	-- 排除试用期人员 以及 是否领导 为领导职务但是未匹配起码表的数据
	update ds_t7_c set zj = replace(zj,'领导职务','非领导职务') where dwmc = concat(v_unit_dataId,'') 
	and rysf like '%公%' and zj not like '%期'; 
	update ds_t7_c c,sys_s_data d set c.zj = d.id 
	where c.zj = d.name and c.dwmc = concat(v_unit_dataId,'')
	and d.typename = 'sjzj' and rysf like '%公%' and zj not like '%期'; 
	
	-- 处理管理人员实际职级
	update ds_t7_c c set zj = replace(zj,'岗位',if(ifnull(drzw,'')='','非领导岗位',drzw)) where dwmc = concat(v_unit_dataId,'') 
	and rysf like '%管理人员%' and bz not like '%期'; -- 排除试用期人员 以及 是否领导为空的数据 默认为非领导职务
	-- 处理管理人员 本身有 是否领导的数据
	update ds_t7_c set zj = replace(zj,'领导职务','领导岗位') where dwmc = concat(v_unit_dataId,'');
	-- 处理实际职级为码表id
	update ds_t7_c c,sys_s_data d set c.zj = d.id 
	where c.zj = d.name and c.dwmc = concat(v_unit_dataId,'')
	and d.typename = 'sjzj' and rysf like '%管理人员%';
	-- 排除试用期人员 以及 是否领导 为非领导职务但是未匹配起码表的数据
	update ds_t7_c set zj = replace(zj,'非领导岗位','领导岗位') where dwmc = concat(v_unit_dataId,'') 
	and rysf like '%管理人员%' and zj not like '%期'; 
	update ds_t7_c c,sys_s_data d set c.zj = d.id 
	where c.zj = d.name and c.dwmc = concat(v_unit_dataId,'')
	and d.typename = 'sjzj' and rysf like '%管理人员%' and zj not like '%期'; 
	-- 排除试用期人员 以及 是否领导 为领导职务但是未匹配起码表的数据
	update ds_t7_c c set zj = replace(zj,'领导岗位','非领导岗位') where dwmc = concat(v_unit_dataId,'') 
	and rysf like '%管理人员%' and zj not like '%期'; 
	update ds_t7_c c,sys_s_data d set c.zj = d.id 
	where c.zj = d.name and c.dwmc = concat(v_unit_dataId,'')
	and d.typename = 'sjzj' and rysf like '%管理人员%' and zj not like '%期'; 
	
	-- 统一处理实际职级为码表id
	update ds_t7_c c,sys_s_data d set c.zj = d.id 
	where c.zj = d.name and c.dwmc = concat(v_unit_dataId,'')
	and d.typename = 'sjzj';
	/** 
	UPDATE ds_t7_c a SET drzw='非领导职务' 
	WHERE a.zj = '十级' OR a.zj = '九级' OR a.zj = '八级' OR a.zj = '七级' OR a.zj = '六级' OR a.zj = '三级' OR a.zj = '二级' OR a.zj = '一级' ;
	UPDATE ds_t7_c a SET zj=CONCAT(a.zj,'职员岗位') WHERE a.zj = '十级' OR a.zj = '九级' OR a.zj = '八级' OR a.zj = '七级' OR a.zj = '六级' OR a.zj = '五级' OR a.zj = '四级'  OR a.zj = '三级' OR a.zj = '二级' OR a.zj = '一级';
	UPDATE ds_t7_c SET drzw='非领导职务' WHERE zj='科员';
	UPDATE ds_t7_c set drzw='' where zj='试用期';
	UPDATE ds_t7_c a set bz = (select id from sys_s_data where typename='sjzj' and name=concat(a.zj,a.drzw));
	UPDATE ds_t7_c  SET dwmc=(SELECT id FROM t111 WHERE ds_t7_c.dwmc=t111.c02 LIMIT 1) WHERE 1=1 AND dwmc NOT REGEXP '[0-9]+' ;
	*/
	 	
	UPDATE t121,ds_t7_c set updateDate=sysdate(),c03=dwmc,c05=concat(ifnull(zwmc,''),drzw),c06=zj
		WHERE  c01=ds_t7_c.xm and c07=ds_t7_c.rzsj 
		and exists(select 1 from t126 where t126.c01 = concat(v_unit_dataId,'') and t126.id = t121.c01);
	
	insert into t121 (createrId,createDate,updaterId,updateDate,dataclassCode,
	unitId,c01,c02,c03,c04,c05,c06,c07)
		select 1,sysdate(),1,sysdate(),'t121','149',xm,xm,dwmc,v_unit_data_name,concat(ifnull(zwmc,''),drzw),zj,rzsj
	from ds_t7_c a where not exists(select 1 from t121 where c01=a.xm);
	
END;

CREATE DEFINER = `root`@`localhost` PROCEDURE `smso-migration-v2`.`p_init_ds_t122`(IN v_unit_id varchar(200),IN v_unit_dataId varchar(200),
In v_unit_data_name varchar(200),
INOUT resultMsg varchar(1000) CHARSET utf8)
label_pro:BEGIN	
-- 初始化人员学习简历
	select count(1) into @c from t111 where c01 = v_unit_id;
	if @c = 0 then 
		set resultMsg = '单位数据未进入t111表,请先处理!';leave label_pro;
	end if;
	if v_unit_dataId = '' then 
		select id,c02 into v_unit_dataId,v_unit_data_name from t111 where c01 = v_unit_id;
	end if;
	-- delete from ds_t8_c where dwmc in (v_unit_dataId,v_unit_id,v_unit_data_name);
	-- insert into ds_t8_c select * from ds_t8 where dwmc in (v_unit_dataId,v_unit_id,v_unit_data_name);
	
	-- ds_t8_c 人员学习简历
	 update ds_t8_c c set dwmc = concat(v_unit_dataId,'') where dwmc =  v_unit_data_name;-- 单位名称更新为单位id

	 update ds_t8_c c ,t126 
		 set c.xm = t126.id 
	 where c.xm = t126.c04 and c.dwmc = concat(v_unit_dataId,'') and t126.c01 = concat(v_unit_dataId,''); -- 更新人员姓名为id
	-- 修改学习简历为对应关系
	update ds_t8_c c,ds_zh d set c.xl = d.my_name 
	where c.dwmc = concat(v_unit_dataId,'') and c.xl = d.ds_name 
	and d.table_name = 'ds_t8_c' and d.table_column = 'xl' ;
	-- 修改学习简历为码表id
	update ds_t8_c c,sys_s_Data d set c.xl = d.id 
	where c.xl = d.name and d.typename = 'eduLevel' and dwmc = concat(v_unit_dataId,'');
	
	-- 向学历表插入数据 
	insert into t122 (createrId,createDate,updaterId,updateDate,dataclassCode,
		c02,c03,c04,c05,c06,c07,c08
		-- 人员编号 姓名 学历 取得学历时间 所学专业 就读学校  备注
	)
	select 
		1,sysdate(),1,sysdate(),'t122',
		xm,xm,xl,qdxlsj,'',jdxx,bz
	from ds_t8_c c where c.dwmc = concat(v_unit_dataId,'')
	and not exists(select 1 from t122 where c02 = c.xm and c.xl = t122.c04);
	
	
END;

CREATE DEFINER = `root`@`localhost` PROCEDURE `smso-migration-v2`.`p_init_ds_t124`(IN v_unit_id varchar(200),IN v_unit_dataId varchar(200),
In v_unit_data_name varchar(200),
INOUT resultMsg varchar(1000) CHARSET utf8)
label_pro:BEGIN	
-- 初始化人员年度考核情况
	select count(1) into @c from t111 where c01 = v_unit_id;
	if @c = 0 then 
		set resultMsg = '单位数据未进入t111表,请先处理!';leave label_pro;
	end if;
	if v_unit_dataId = '' then 
		select id,c02 into v_unit_dataId,v_unit_data_name from t111 where c01 = v_unit_id;
	end if;
	-- delete from ds_t9_c where dwmc in (v_unit_dataId,v_unit_id,v_unit_data_name);
	-- insert into ds_t9_c select * from ds_t9 where dwmc in (v_unit_dataId,v_unit_id,v_unit_data_name);
	
	-- ds_t9_c 人员考核情况
	-- 修改单位名称为t111.id
	update ds_t9_c set dwmc = concat(v_unit_dataId,'') where dwmc = v_unit_data_name;
	-- 修改人员序号为单位代码+序号
	UPDATE ds_t9_c a SET ryxh=CONCAT(v_unit_id,(CASE LENGTH(a.ryxh) WHEN '1' THEN '0000' WHEN '2' THEN '000' WHEN '3' THEN '00' WHEN '4' THEN '0' ELSE '' END),ryxh) WHERE LENGTH(ryxh)<5;
	-- 修改人员姓名为t126.id
	update ds_t9_c c,t126 set ryxm = t126.id 
	where dwmc = t126.c01 and dwmc = concat(v_unit_dataId,'') and ryxh = t126.c02;
	-- 修改考核情况为对应关系的数据
	update ds_t9_c c,ds_zh z set khjg = z.my_name 
	where c.dwmc = concat(v_unit_dataId,'')
	and c.khjg = z.ds_name and z.table_name = 'ds_t9_c' and z.table_column = 'khjg';
	-- 修改考核情况为码表id
	update ds_t9_c c,sys_s_data d set c.khjg = d.id 
	where c.dwmc = concat(v_unit_dataId,'') and c.khjg = d.name 
	and d.typename = 'assResult';
	/**
	UPDATE ds_t9_c set khjg=(case khjg when '称职'  then '10483' when '合格' then '10483' when '不称职' then '10485'
	when '不合格' then '10485' when '基本称职'  then '10484' when '不参加考核'  then '10496'
	when '优秀' then '10482' when  '基本合格' then '10484' when  '不确定等次' then '10496' 
		ELSE '10483' END)  where dwmc=concat(v_unit_dataId,'');
	*/
	UPDATE t124,ds_t9_c set updateDate=sysdate(),c05=khjg
		WHERE c02=dwmc and c03=ryxm and c01=khnd 
		and exists(select 1 from t126 where t126.c01 = concat(v_unit_dataId,'') and t126.id=t124.c03);
	-- 插入数据  排除此人X年已经有了的
	insert into t124  (createrId,createDate,updaterId,updateDate,dataclassCode,unitId,c01,c02,c03,c04,c05)
		select 1,sysdate(),1,sysdate(),'t124','183',khnd,dwmc,ryxm,ryxm,khjg
		from ds_t9_c a 
		where exists(select 1 from t126 where id = ryxm) 
		and not exists(select 1 from t124 where c03=a.ryxm and c01 != khnd);
	
END;

CREATE DEFINER = `root`@`localhost` PROCEDURE `smso-migration-v2`.`p_init_ds_t125`(IN v_unit_id varchar(200),IN v_unit_dataId varchar(200),
In v_unit_data_name varchar(200),
INOUT resultMsg varchar(1000) CHARSET utf8)
label_pro:BEGIN	
-- 基层单位人员工资信息
	select count(1) into @c from t111 where c01 = v_unit_id;
	if @c = 0 then 
		set resultMsg = '单位数据未进入t111表,请先处理!';leave label_pro;
	end if;
	if v_unit_dataId = '' then 
		select id,c02 into v_unit_dataId,v_unit_data_name from t111 where c01 = v_unit_id;
	end if;
	-- delete from ds_t3_c where dwmc in (v_unit_dataId,v_unit_id,v_unit_data_name);
	-- insert into ds_t3_c select * from ds_t3 where dwmc in (v_unit_dataId,v_unit_id,v_unit_data_name);
	
	-- ds_t3_c 人员工资情况表(有很多条记录)	
	-- 修改人员单位名称为t111.id
	UPDATE ds_t3_c c,t111 
	SET dwmc = t111.id where c.dwmc = t111.c02 and t111.id = v_unit_dataId ;
	
	-- 更新人员序号为单位代码+编号 
	UPDATE ds_t3_c a SET ryxh=CONCAT((SELECT c01 FROM t111  WHERE id=a.dwmc),
	(CASE LENGTH(a.ryxh) WHEN '1' THEN '0000' WHEN '2' THEN '000' WHEN '3' THEN '00' WHEN '4' THEN '0' WHEN '5' 
	THEN '' END),ryxh) WHERE LENGTH(ryxh)<6
	AND dwmc=concat(v_unit_dataId,'');
	
	-- 更新人员起薪时间为2009.1的情况	
	UPDATE ds_t3_c SET qxsj=REPLACE(qxsj,'.1','-01') WHERE LENGTH(qxsj)=6 and dwmc = concat(v_unit_dataId,'') ;
	-- 更新人员起薪时间为2009.01的情况
	UPDATE ds_t3_c SET qxsj=REPLACE(qxsj,'.','-') WHERE  LENGTH(qxsj)=7 and dwmc = concat(v_unit_dataId,'') ;
	
	-- 修改人员姓名为人员id
	update ds_t3_c c ,t126 
	set c.xm = t126.id where t126.c01 = c.dwmc and t126.c01 = concat(v_unit_dataId,'') 
	and t126.c02 = c.ryxh
	and xm = t126.c04;
	
	-- 修改 根据 人员序号去匹配 人员工资表临时存放的 人员身份为汉字 人员身份id为码表id
	update ds_t3_c c,t126,sys_s_data d set c.rysf = d.name,c.rysfId = d.id
	where  c.ryxh = t126.c02 and c.dwmc = t126.c01 and t126.c28 = d.id and d.typename = 'rysf'
	and t126.c01 = concat(v_unit_dataId,''); 
	
	-- 更新人员工资制度为对应关系的数据  人员工资制度根据人员身份去配
	/** update ds_t3_c c,ds_zh z,t126  set c.rygzzd = z.my_name 
	where c.rygzzd = z.ds_name and z.table_name = 'ds_t3_c' 
	and z.table_column = 'rygzzd' 
	and c.rysf = remark
	and c.dwmc = v_unit_dataId;
	*/
	-- 根据 人员身份修改人员工资制度
	update ds_t3_c c,t136 ,sys_s_data d set c.rygzzd = t136.c05 -- 人员工资制度(码表id)
	where c.dwmc = concat(v_unit_dataId,'') and d.name = c.rysf and d.id = t136.c02 -- 人员身份(码表id)
	and t136.c05 != ''
	;
	-- 修改人员工资制度为码表id
	update ds_t3_c c,sys_s_data d set c.rygzzd =d.id
	where c.dwmc = concat(v_unit_dataId,'') and c.rygzzd = d.name and d.typename = 'wageSystem';
	
	-- 更新工资级别为对应关系的数据
	update ds_t3_c c,ds_zh z set c.gzjb = z.my_name 
	where c.gzjb = z.ds_name and z.table_name = 'ds_t3_c' and z.table_column = 'gzjb'
	and c.dwmc = concat(v_unit_dataId,'');
	
	-- 更新级别档次为对应关系的数据 根据人员身份去判断档次字段应该怎么处理
	update ds_t3_c c,ds_zh z set c.jbdc = z.my_name
	where c.jbdc = z.ds_name and z.table_name = 'ds_t3_c' and z.table_column = 'jbdc'
	and c.rysf = z.remark
	and c.dwmc = concat(v_unit_dataId,'');
	
	-- 公务员 
	-- 更新人员级别字段为最新级别
	update ds_t3_c c,t127 set gzjb = t127.id 
	where gzjb = t127.c05 and c.jbdc = t127.c04
	and c.dwmc = concat(v_unit_dataId,'') and c.rysf like '%公%'
	and gzjb != '' and t127.c01 >= '2016-07-01' and t127.c03 = '级别工资';
	-- 修改档次 为级别对应的id
	update ds_t3_c set jbdc = gzjb where dwmc = concat(v_unit_dataId,'') 
	and gzjb != '' and rysf like '%公%' and gzjb not like '%级'; 
	
	-- 机关工人
	update ds_t3_c c,t127 ,t126 set c.jbdc = t127.id
	where c.dwmc = concat(v_unit_dataId,'') and c.jbdc = t127.c04
	and c.xm = t126.id and t127.c01 >= '2016-07-01' and t127.c03='岗位工资' 
	and t127.c05 = (select d.c05 from t127 d where d.id = t126.c17);
	/**
	UPDATE ds_t3_c SET jbdc=(select id from t127 where c01='2016-07-01' and c03='岗位工资' 
	and c04=REPLACE(ds_t3_c.jbdc,'档','级') and 
	c05=(select c05 from t127 where id=(select gzdyzj from ds_t2_c where ryxh=ds_t3_c.ryxh)))
	where  exists(select 1 from ds_t2_c where rysf='10516' and ds_t2_c.ryxh=ds_t3_c.ryxh);
	*/
	-- 事业 薪级字段处理	
	update ds_t3_c c ,t127,t126 set jbdc = t127.id
	where c.dwmc = concat(v_unit_dataId,'') and c.jbdc = t127.c04 
	and t127.c01 >= '2016-07-01' and t127.c03 = '薪级工资'
	and t127.c08 = t126.c39 and t126.id = c.xm;
	
	/**
	UPDATE ds_t3_c SET jbdc=(SELECT id FROM t127 WHERE c01='2016-07-01' AND c03='薪级工资' 
	AND c04=REPLACE(ds_t3_c.jbdc,'档','级') AND 
	c08=(select my_name from ds_zh where table_column='gzbzlb' 
	and ds_name=(select rysf from ds_t2_c where ryxh=ds_t3_c.ryxh))) 
	WHERE ( gzjb='' or gzjb=null )  and dwmc=v_unit_dataId and (jbdc like '%档' or jbdc like '%级');
	*/
	
	UPDATE t125,ds_t3_c set c05=dwmc,c02=qxsj,c36=rygzzd,c07=gzjb,c08=jbqknf,c09=jbdc,
	c10=jbdcqknf,c25=zwgz,c26=jbgz,c31=jxgzxj,c27=jbtxj,c32=gzhj
	 where c06 = ds_t3_c.xm and t125.c05 = concat(v_unit_dataId,'') 
	 and ds_t3_c.id=(select max(id) from ds_t3_c b where b.xm=ds_t3_c.xm);
	 
	
	insert into t125 (
		createrId,createDate,updaterId,updateDate,dataclassCode,
		c05,c02,c06,c33,c36,c07,c08,c09,c10,c25,c26,c31,c27,c32,c49)
		select  
		1,sysdate(),1,sysdate(),'t125',
		dwmc,'2017-09',xm,xm,rygzzd,gzjb,jbqknf,jbdc,jbdcqknf,zwgz,jbgz,jxgzxj,jbtxj,gzhj,'2016-07-01'
	 from ds_t3_c a WHERE a.id=(SELECT MAX(id) FROM ds_t3_c WHERE xm=a.xm) 
	 and exists(select 1 from t126 where t126.id = xm and t126.c01 = concat(v_unit_dataId,''))
	 and not exists(select 1 from t125 b where b.c06=a.xm);
	 -- 根据人员工资标准类别刷新 人员的工资标准时间
	update t125 ,t126
		set t125.c49 = (select c01 from t127 where t127.c08 = t126.c39 order by c01 desc limit 1 )
		where t126.id = t125.c06 and t126.c01 = concat(v_unit_dataId,'');
	-- c38 目标单位 暂时存放人员工资制度 待t125添加后再清除
	-- update t126  sET c38 = '' WHERE c01 = v_unit_dataId ;

END;

CREATE DEFINER = `root`@`localhost` PROCEDURE `smso-migration-v2`.`p_init_ds_t126`(IN v_unit_id varchar(200),IN v_unit_dataId varchar(200),
In v_unit_data_name varchar(200),
INOUT resultMsg varchar(1000) CHARSET utf8)
label_pro:BEGIN	
-- 基层单位人员基础信息
	select count(1) into @c from t111 where c01 = concat(v_unit_id,'');
	if @c = 0 then 
		set resultMsg = '单位数据未进入t111表,请先处理!';leave label_pro;
	end if;
	if v_unit_dataId = '' then 
		select id,c02 into v_unit_dataId,v_unit_data_name from t111 where c01 = concat(v_unit_id,'');
	end if;
	-- delete from ds_t2_c where dwmc in (v_unit_dataId,concat(v_unit_id,''),v_unit_data_name);
	-- insert into ds_t2_c select * from ds_t2 where dwmc in (v_unit_dataId,concat(v_unit_id,''),v_unit_data_name);
	-- ds_t2_c 人员基本信息表
	-- 更新人员基本信息表 单位名称为id
	UPDATE ds_t2_c SET dwmc=concat(v_unit_dataId,'') WHERE trim(dwmc) = v_unit_data_name ;
	
	-- 更新人员状态为码表id
	UPDATE ds_t2_c c,sys_s_data d set c.ryzt = d.id 
		WHERE d.typename ='staffStatus' AND name=c.ryzt
		and dwmc=concat(v_unit_dataId,'');
	-- 更新人员编制 如果提供的编制为空 则由人员身份决定人员的编制 由ds_zh表处理
	UPDATE ds_t2_c c,ds_zh z set c.rybz = z.my_name 
	WHERE z.table_name = 'ds_t2_c' and z.table_column = 'rybz'
	and z.ds_name = c.rysf and c.dwmc=concat(v_unit_dataId,'') and ifnull(rybz,'') = '';
	-- 更新人员编制为码表id
	update ds_t2_c c,sys_s_data d set c.rybz = d.id
	where c.rybz = d.name and d.typename = 'rybz' and c.dwmc = concat(v_unit_dataId,'');

	-- 更新人员性别为对应关系表的名称
	update ds_t2_c c ,ds_zh z set c.xb = z.my_name
	where c.xb = z.ds_name and z.table_name = 'ds_t2_c' and z.table_column = 'xb'
	and c.dwmc = concat(v_unit_dataId,'');
	-- 更新性别为码表id
	update ds_t2_c c,sys_s_data d set c.xb = d.id 
	where c.xb = d.name and d.typename = 'sex' and c.dwmc = concat(v_unit_dataId,'');
	
	-- 更新民族为对应关系表的名称
	update ds_t2_c c ,ds_zh z set c.mz = z.my_name
	where c.mz = z.ds_name and z.table_name = 'ds_t2_c' and z.table_column = 'mz'
	and c.dwmc = concat(v_unit_dataId,'');
	-- 更新民族为码表id
	update ds_t2_c c,sys_s_data d set c.mz = d.id 
	where c.mz = d.name and d.typename = 'nation' and c.dwmc = concat(v_unit_dataId,'');
	-- 修改人员出生日期 处理 1990.1的情况
	UPDATE ds_t2_c c SET csrq=REPLACE(csrq,'.1','-01-01') WHERE LENGTH(csrq)=6 AND dwmc=concat(v_unit_dataId,'');
	-- 修改人员出生日期 处理 1990.01的情况
	UPDATE ds_t2_c c SET csrq=concat(REPLACE(c.csrq,'.','-'),'-01') WHERE LENGTH(csrq)=7 AND dwmc=concat(v_unit_dataId,'');
	-- 处理人员学历为对应关系的学历  学历使用ds_t8_c里面的对应关系
	update ds_t2_c c,ds_zh z set c.xl = z.my_name 
	where c.xl = z.ds_name and z.table_name = 'ds_t8_c' and z.table_column = 'xl'
	and c.dwmc = concat(v_unit_dataId,'');
	-- 处理人员学历为码表id
	update ds_t2_c c,sys_s_data d set c.xl = d.id 
	where c.xl = d.name and d.typename = 'eduLevel' and c.dwmc = concat(v_unit_dataId,'');
	-- 处理人员学位为对应关系的学位
	update ds_t2_c c,ds_zh z set c.xw = z.my_name 
	where c.xw = z.ds_name and z.table_name = 'ds_t2_c' and z.table_column = 'xw'
	and c.dwmc = concat(v_unit_dataId,'');
	-- 处理人员学位为码表id
	update ds_t2_c c,sys_s_data d set c.xw = d.id 
	where c.xw = d.name and d.typename = 'degree' and c.dwmc = concat(v_unit_dataId,'');
	-- 处理毕业 时间为 2009.1的情况
	UPDATE ds_t2_c c SET bysj=REPLACE(bysj,'.1','-01-01') WHERE LENGTH(bysj)=6 AND dwmc=concat(v_unit_dataId,'');
	-- 处理毕业 时间为2009.01的情况
	UPDATE ds_t2_c c SET bysj=concat(REPLACE(c.bysj,'.','-'),'-01') WHERE  LENGTH(bysj)=7 AND dwmc=concat(v_unit_dataId,'');
	-- 处理参加工作时间为2009.1的情况
	UPDATE ds_t2_c c SET cjgzsj=REPLACE(cjgzsj,'.1','-01-01') WHERE LENGTH(cjgzsj)=6 AND dwmc=concat(v_unit_dataId,'');
	-- 处理参加工作时间为 2009.01的情况
	UPDATE ds_t2_c c SET cjgzsj=concat(REPLACE(c.cjgzsj,'.','-'),'-01') WHERE  LENGTH(cjgzsj)=7 AND dwmc=concat(v_unit_dataId,'');
	-- 处理进入本单位时间 为2009.1的情况
	UPDATE ds_t2_c c SET jrbdwsj=REPLACE(jrbdwsj,'.1','-01-01') WHERE LENGTH(jrbdwsj)=6 AND dwmc=concat(v_unit_dataId,'');
	-- 处理进入本单位时间为2009.01的情况
	UPDATE ds_t2_c c SET jrbdwsj=concat(REPLACE(c.jrbdwsj,'.','-'),'-01') WHERE  LENGTH(jrbdwsj)=7 AND dwmc=concat(v_unit_dataId,'');
	-- 处理任职级时间为 2009.1的情况
	UPDATE ds_t2_c c SET rxzjsj=REPLACE(rxzjsj,'.1','-01-01') WHERE LENGTH(rxzjsj)=6 AND dwmc=concat(v_unit_dataId,'');
	-- 处理任现职级时间为2009.01的情况
	UPDATE ds_t2_c c SET rxzjsj=concat(REPLACE(c.rxzjsj,'.','-'),'-01') WHERE  LENGTH(rxzjsj)=7 AND dwmc=concat(v_unit_dataId,'');
	-- 处理人员来源为对应关系表的数据
	update ds_t2_c c,ds_zh z set c.ryly = z.my_name 
	where c.ryly = z.ds_name and z.table_name = 'ds_t2_c' and z.table_column = 'ryly'
	and c.dwmc = concat(v_unit_dataId,'');
	-- 处理人员来源为码表的id
	update ds_t2_c c,sys_s_data d set c.ryly = d.id 
	where c.ryly = d.name and d.typename = 'staffFrom' and dwmc = concat(v_unit_dataId,'');
	-- 处理人员部门为部门表t113的id
	update ds_t2_c c ,t113 set c.bm = t113.id 
	where c.bm = t113.c03 and c.dwmc = concat(v_unit_dataId,'') and c.dwmc = t113.c01 ;
	-- 处理政治面貌为对应关系的数据 
	update ds_t2_c c,ds_zh z set c.zzmm = z.my_name 
	where c.zzmm = z.ds_name and z.table_name = 'ds_t2_c' and z.table_column = 'zzmm'
	and c.dwmc = concat(v_unit_dataId,'');
	-- 处理政治面貌为对应码表的id
	update ds_t2_c c,sys_s_data d set c.zzmm = d.id 
	where c.zzmm = d.name and d.typename = 'zzmm' 
	and c.dwmc = concat(v_unit_dataId,'');
	
	-- 修改人员序号为 单位代码加序号
	UPDATE ds_t2_c a SET ryxh=CONCAT((SELECT c01 FROM t111  WHERE id=a.dwmc),
	(CASE LENGTH(a.ryxh) WHEN '1' THEN '0000' WHEN '2' THEN '000' WHEN '3' THEN '00' WHEN '4' THEN '0' WHEN '5' 
	THEN '' END),ryxh) WHERE LENGTH(ryxh)<6
	AND dwmc=concat(v_unit_dataId,'');
	
	-- 更新人员基本信息表人员身份为对应关系表里的身份
	update ds_t2_c c,ds_zh z set c.rysf = z.my_name 
	where c.rysf = z.ds_name and z.table_name = 'ds_t2_c'  and z.table_column = 'rysf'
	and c.dwmc = concat(v_unit_dataId,'');
	
	-- 处理人员工资对应职级 试用期人员->试用期
	update ds_t2_c c set c.gzdyzj = '试用期' where gzdyzj = '试用期人员' and dwmc = concat(v_unit_dataId,'');
	-- 处理人员工资对应职级 为对应关系的数据
	update ds_t2_c c ,ds_zh z set c.gzdyzj = z.my_name 
	where c.gzdyzj = z.ds_name and z.table_name = 'ds_t2_c' and z.table_column = 'gzdyzj'
	and c.dwmc = concat(v_unit_dataId,'') and c.gzdyzj not like '%期';
	-- 处理人员工资对应职级包含期(试用期/熟练期/深造期)
	update ds_t2_c c,ds_zh z set c.gzdyzj = z.my_name 
	where c.gzdyzj = z.ds_name and z.table_name = 'ds_t2_c' and z.table_column = 'gzdyzj'
	and c.rysf = z.remark
	and c.dwmc = concat(v_unit_dataId,'') and c.gzdyzj like '%期';
	
	-- 实际职级先处理成工资对应职级 
	update ds_t2_c set sjzj = gzdyzj where dwmc = concat(v_unit_dataId,'');
	
	
	-- 更新人员基本信息表是否领导为对应关系表里的身份
	update ds_t2_c c,ds_zh z set c.sfld = z.my_name 
	where c.sfld = z.ds_name and z.table_name = 'ds_t2_c'  and z.table_column = 'sfld'
	and c.dwmc = concat(v_unit_dataId,'');
	
	-- 处理公务员实际职级
	update ds_t2_c set sjzj = concat(gzdyzj,if(ifnull(sfld,'')='','非领导职务',sfld)) where dwmc = concat(v_unit_dataId,'') 
	and rysf like '%公%' and gzdyzj not like '%期'; -- 排除试用期人员 以及 是否领导为空的数据 默认为非领导职务
	
	-- 处理实际职级为码表id
	update ds_t2_c c,sys_s_data d set c.sjzj = d.id 
	where c.sjzj = d.name and c.dwmc = concat(v_unit_dataId,'')
	and d.typename = 'sjzj' and rysf like '%公%';
	-- 排除试用期人员 以及 是否领导 为非领导职务但是未匹配起码表的数据
	update ds_t2_c c set sjzj = replace(sjzj,'非领导职务','领导职务') where dwmc = concat(v_unit_dataId,'') 
	and rysf like '%公%' and gzdyzj not like '%期'; 
	update ds_t2_c c,sys_s_data d set c.sjzj = d.id 
	where c.sjzj = d.name and c.dwmc = concat(v_unit_dataId,'')
	and d.typename = 'sjzj' and rysf like '%公%' and gzdyzj not like '%期'; 
	-- 排除试用期人员 以及 是否领导 为领导职务但是未匹配起码表的数据
	update ds_t2_c set sjzj = replace(sjzj,'领导职务','非领导职务') where dwmc = concat(v_unit_dataId,'') 
	and rysf like '%公%' and gzdyzj not like '%期'; 
	update ds_t2_c c,sys_s_data d set c.sjzj = d.id 
	where c.sjzj = d.name and c.dwmc = concat(v_unit_dataId,'')
	and d.typename = 'sjzj' and rysf like '%公%' and gzdyzj not like '%期'; 
	
	-- 处理管理人员实际职级
	update ds_t2_c set sjzj = replace(gzdyzj,'岗位',if(ifnull(sfld,'')='','非领导岗位',sfld)) where dwmc = concat(v_unit_dataId,'') 
	and rysf like '%管理人员%' and gzdyzj not like '%期'; -- 排除试用期人员 以及 是否领导为空的数据 默认为非领导职务
	-- 处理管理人员 本身有 是否领导的数据
	update ds_t2_c set sjzj = replace(sjzj,'领导职务','领导岗位') where dwmc = concat(v_unit_dataId,'');
	-- 处理实际职级为码表id
	update ds_t2_c c,sys_s_data d set c.sjzj = d.id 
	where c.sjzj = d.name and c.dwmc = concat(v_unit_dataId,'')
	and d.typename = 'sjzj' and rysf like '%管理人员%';
	-- 排除试用期人员 以及 是否领导 为非领导职务但是未匹配起码表的数据
	update ds_t2_c set sjzj = replace(sjzj,'非领导岗位','领导岗位') where dwmc = concat(v_unit_dataId,'') 
	and rysf like '%管理人员%' and gzdyzj not like '%期'; 
	update ds_t2_c c,sys_s_data d set c.sjzj = d.id 
	where c.sjzj = d.name and c.dwmc = concat(v_unit_dataId,'')
	and d.typename = 'sjzj' and rysf like '%管理人员%' and gzdyzj not like '%期'; 
	-- 排除试用期人员 以及 是否领导 为领导职务但是未匹配起码表的数据
	update ds_t2_c c set sjzj = replace(sjzj,'领导岗位','非领导岗位') where dwmc = concat(v_unit_dataId,'') 
	and rysf like '%管理人员%' and gzdyzj not like '%期'; 
	update ds_t2_c c,sys_s_data d set c.sjzj = d.id 
	where c.sjzj = d.name and c.dwmc = concat(v_unit_dataId,'')
	and d.typename = 'sjzj' and rysf like '%管理人员%' and gzdyzj not like '%期'; 
	
	-- 统一处理实际职级为码表id
	update ds_t2_c c,sys_s_data d set c.sjzj = d.id 
	where c.sjzj = d.name and c.dwmc = concat(v_unit_dataId,'')
	and d.typename = 'sjzj';
	
	-- 统一处理试用期是否领导为空
	update ds_t2_c c set sfld = '' where dwmc = concat(v_unit_dataId,'') and gzdyzj like '%期';
	
	-- 统一处理是否领导为实际职级处理后的数据  主要是排除人员是 领导 但是 此职级没有领导只有非领导的情况
	update ds_t2_c c,sys_s_data d set c.sfld = '非领导职务'
	where c.sjzj = d.id and d.typename = 'sjzj' and c.dwmc = concat(v_unit_dataId,'')
	and d.name like '%非领导职务'
	and ( c.rysf like '%公%' or c.rysf like '%管理人员%');
	-- 统一处理是否领导为实际职级处理后的数据  主要是排除人员是 非领导 但是 此职级没有非领导只有领导的情况
	update ds_t2_c c,sys_s_data d set c.sfld = '领导职务'
	where c.sjzj = d.id and d.typename = 'sjzj' and c.dwmc = concat(v_unit_dataId,'')
	and d.name like '%领导职务' and d.name not like '%非领导职务'
	and ( c.rysf like '%公%' or c.rysf like '%管理人员%');
	
	-- 处理人员工资对应职级为t127工资标准表的id
	-- 公务员 及 管理人员 排除试用期
	UPDATE ds_t2_c c SET gzdyzj=IFNULL((SELECT id FROM t127 WHERE 
	t127.c04 = c.sfld AND t127.c05=c.gzdyzj order by c01 desc LIMIT 1),c.gzdyzj) 
	WHERE 1=1 AND gzdyzj NOT REGEXP '[0-9]+' 
	AND dwmc=concat(v_unit_dataId,'') and gzdyzj not like '%期'
	and ( c.rysf like '%公%' or c.rysf like '%管理人员%');
	-- 试用期情况
	UPDATE ds_t2_c c SET gzdyzj=IFNULL((SELECT id FROM t127 WHERE
	t127.c05=c.gzdyzj order by c01 desc LIMIT 1),c.gzdyzj) 
	WHERE 1=1 AND gzdyzj NOT REGEXP '[0-9]+' 
	AND dwmc=concat(v_unit_dataId,'') and gzdyzj like '%期';
	
	UPDATE ds_t2_c c SET gzdyzj=IFNULL((SELECT id FROM t127 WHERE 
	t127.c05=c.gzdyzj order by c01 desc LIMIT 1),c.gzdyzj) 
	WHERE 1=1 AND gzdyzj NOT REGEXP '[0-9]+' 
	AND dwmc=concat(v_unit_dataId,'') and gzdyzj not like '%期'
	and ( c.rysf not like '%公%' or c.rysf not like '%管理人员%');
	
	-- UPDATE ds_t2_c SET gzdyzj=IFNULL((SELECT id FROM t127 WHERE t127.c01='2016-07-01' AND t127.c04=ds_t2_c.sfld AND t127.c05=CONCAT(ds_t2_c.gzdyzj,'职员岗位') LIMIT 1),ds_t2_c.gzdyzj) WHERE (SELECT name FROM sys_s_data WHERE id=ds_t2_c.rysf)='管理人员' AND dwmc=concat(v_unit_dataId,'');
	-- UPDATE ds_t2_c SET gzdyzj=IFNULL((SELECT id FROM t127 WHERE t127.c01='2016-07-01' AND t127.c04=(SELECT NAME FROM sys_s_data WHERE id=ds_t2_c.xl) AND t127.c05='公务员试用期' LIMIT 1),ds_t2_c.gzdyzj) WHERE (SELECT name FROM sys_s_data WHERE id=ds_t2_c.rysf)='综合类公务员' AND ds_t2_c.gzdyzj='试用期' AND dwmc=concat(v_unit_dataId,'');
	
	-- UPDATE ds_t2_c SET gzdyzj=IFNULL((SELECT id FROM t127 WHERE t127.c01='2016-07-01' AND t127.c04=ds_t2_c.sfld
	--  AND t127.c05=ds_t2_c.gzdyzj LIMIT 1),ds_t2_c.gzdyzj) WHERE 1=1 AND gzdyzj NOT REGEXP '[0-9]+' ;
	 
	/** UPDATE ds_t2_c SET gzdyzj=IFNULL(
		(SELECT id FROM t127 WHERE t127.c01='2016-07-01' AND t127.c04=ds_t2_c.sfld
			 AND t127.c05=CONCAT(ds_t2_c.gzdyzj,'职员岗位') LIMIT 1)
		,ds_t2_c.gzdyzj) 
		WHERE 1=1 and exists(SELECT 1 FROM sys_s_data WHERE id=ds_t2_c.rysf and name='管理人员');
	UPDATE ds_t2_c SET gzdyzj=IFNULL((SELECT id FROM t127 WHERE t127.c01='2016-07-01' AND t127.c04=(SELECT NAME FROM sys_s_data WHERE id=ds_t2_c.xl) AND t127.c05='公务员试用期' LIMIT 1),ds_t2_c.gzdyzj)
	WHERE (SELECT name FROM sys_s_data WHERE id=ds_t2_c.rysf)='综合类公务员' 
	AND ds_t2_c.gzdyzj='试用期';
	*/
	-- 处理是否领导
	UPDATE ds_t2_c SET sfld=gzdyzj where dwmc = concat(v_unit_dataId,'') and sfld like '%领导%' ;
	-- 处理实际职级 
	/** UPDATE ds_t2_c set sjzj=(select id from sys_s_data where typename='sjzj' 
	and name=concat((select c05 from t127 where id=ds_t2_c.gzdyzj),sfld)) where dwmc=concat(v_unit_dataId,'');
	UPDATE ds_t2_c set sjzj=(select id from sys_s_data where typename='sjzj' and name='公务员试用期') 
	where dwmc=concat(v_unit_dataId,'') and (select c05 from t127 where id=ds_t2_c.gzdyzj)='公务员试用期';
	update ds_t2_c c,t127,sys_s_Data d set c.sjzj = d.id where gzdyzj = t127.id  and d.typename = 'sjzj' 
	and concat(left(t127.c05,4),replace(sfld,'职务','岗位'))=d.name and POSITION('职员' in c05)>0
	 and dwmc = concat(v_unit_dataId,'');
	*/
	
	-- 更新人员身份为码表id
	update ds_t2_c c,sys_s_data d set c.rysf = d.id 
	where c.rysf = d.name and d.typename = 'rysf' and c.dwmc = concat(v_unit_dataId,'');
	
	
	-- 修改是否工资统发为对应关系的数据
	update ds_t2_c c,ds_zh z set c.sfgztf = z.my_name 
	where c.sfgztf = z.ds_name and z.table_name = 'ds_t2_c' and z.table_column = 'sfgztf'
	and c.dwmc = concat(v_unit_dataId,'');
	-- 修改是否工资统发为码表的id	
	update ds_t2_c c ,sys_s_data d set c.sfgztf = d.id 
	where c.sfgztf = d.name and d.typename = 'is' 
	and c.dwmc = concat(v_unit_dataId,'');
	
	-- 修改是否财政供养为对应关系的数据
	update ds_t2_c c,ds_zh z set c.sfczgy = z.my_name 
	where c.sfczgy = z.ds_name and z.table_name = 'ds_t2_c' and z.table_column = 'sfczgy'
	and c.dwmc = concat(v_unit_dataId,'');
	-- 修改是否财政供养为码表的id	
	update ds_t2_c c ,sys_s_data d set c.sfczgy = d.id 
	where c.sfczgy = d.name and d.typename = 'is' 
	and c.dwmc = concat(v_unit_dataId,'');
	
	update t126,ds_t2_c
	set c02=ryxh,c03=ryzt,c16=ryly,c28=rysf,c18=rxzjsj,c08=csrq,c12=cjgzsj,c14=lxgl,c04=xm,c09=xl,c10=xw,c17=gzdyzj,c05=xb,c37=zzmm,c30=wjsgznxxxsj_y,c32=zscgqgl,
	c11=bysj,c06=mz,c19=xrzw,c49=jg,c07=sfzh,c13=jrbdwsj,c35=jdgzsj_m,c29=ds_t2_c.ry_remark,c21=rybz,c22=sfgztf,c24=sfczgy,c27=sfld,c35=jdgzsj_m,c36=sjzj,
	c39=(select my_name from ds_zh where table_name='ds_t2_c' and table_column='gzbzlb' and ds_name=ds_t2_c.rysf),
	c40='10750',c41=DATE_FORMAT(NOW(),'%Y-%m-%d'),c15=bm,c20=rxzjsj,updateDate=sysDate()
	where c02 = ds_t2_c.ryxh and c01=concat(v_unit_dataId,'');
	
	insert into t126 (
		createrId,createDate,updaterId,updateDate,dataclassCode,
		c01,c02,c03,c16,c28,c18,c08,c12,c14,c04,c09,c10,c17,c05,c37,c30,c32,
	c11,c06,c19,c49,c07,c13,c35,c29,c21,c22,c24,c40,c41,c39,c36,c15,c27,c20)
		select  
		1,sysdate(),1,sysdate(),'t126',
		v_unit_dataId,ryxh,ryzt,ryly,rysf,rxzjsj,csrq,cjgzsj,lxgl,xm,xl,xw,gzdyzj,xb,zzmm,wjsgznxxxsj_y,zscgqgl,
		bysj,mz,xrzw,jg,sfzh,jrbdwsj,jdgzsj_m,ry_remark,rybz,sfgztf,sfczgy,'10750',DATE_FORMAT(NOW(),'%Y-%m-%d'),
		(select my_name from ds_zh where table_name='ds_t2_c' and table_column='gzbzlb' and ds_name=ds_t2_c.rysf),
		sjzj,bm,sfld,rxzjsj
		from ds_t2_c 
		 where dwmc = concat(v_unit_dataId,'')
		 and not exists(select 1 from t126 where c02 = ryxh) and xm!='';
	-- 更新人员工资标准类别 为码表id
	update t126 ,sys_s_data d set t126.c39 = d.id 
	where t126.c39 = d.name and d.typename = 'gzbzlb' and t126.c01 = concat(v_unit_dataId,'');
	
-- 计算参加工作时间 年 月 默认起薪时间2017年8月（计算方式：起薪时间减去参加工作时间）
		UPDATE t126 set c48=(8-substring(c12,6,2)),c47=(2017-substring(c12,1,4)) where c01=concat(v_unit_dataId,'') 
		 AND ((8-substring(c12,6,2))>0 OR (8-substring(c12,6,2))=0);
		UPDATE t126 set c48=(8+12-substring(c12,6,2)),c47=(2017-substring(c12,1,4)-1) where c01=concat(v_unit_dataId,'') 
		AND (8-substring(c12,6,2))<0 AND (2017-substring(c12,1,4))>1;
		
	-- 更新人员现任职务为空的情况为 工资对应职级 
	update t126,t127
	set t126.c19 = t127.c05 
	where t126.c17=t127.id and t126.c01 = concat(v_unit_dataId,'') and t126.c19 = '';
	
	-- 处理人员来源为空的数据及变动记录
	update t126,sys_s_data d set 
	t126.c16 = d.id where t126.c01 = concat(v_unit_dataId,'') and t126.c16 = '' and d.typename = 'staffFrom' and d.name = '其他' ; 
	update data_record_t126 t126,sys_s_data d set 
	t126.c16 = d.id where t126.c01 = concat(v_unit_dataId,'') and t126.dataclassCode = 't126' and t126.c16 = '' and d.typename = 'staffFrom' and d.name = '其他';
	
	
END;

CREATE DEFINER = `root`@`localhost` PROCEDURE `smso-migration-v2`.`p_init_ds_t131`(IN v_unit_id varchar(200),IN v_unit_dataId varchar(200),
In v_unit_data_name varchar(200),
INOUT resultMsg varchar(1000) CHARSET utf8)
label_pro:BEGIN	
-- 人员套改附加信息
	select count(1) into @c from t111 where c01 = v_unit_id;
	if @c = 0 then 
		set resultMsg = '单位数据未进入t111表,请先处理!';leave label_pro;
	end if;
	if v_unit_dataId = '' then 
		select id,c02 into v_unit_dataId,v_unit_data_name from t111 where c01 = v_unit_id;
	end if;
	-- delete from ds_t6_c where dwmc in (v_unit_dataId,v_unit_id,v_unit_data_name);
	-- insert into ds_t6_c select * from ds_t6 where dwmc in (v_unit_dataId,v_unit_id,v_unit_data_name);
	
	-- ds_t6_c 06年套改情况表
	-- 修改单位名称为t111.id
	update ds_t6_c c,t111 set c.dwmc = t111.id where c.dwmc = t111.c02 and t111.id = v_unit_dataId;
	-- 修改人员序号为单位代码+序号
	UPDATE ds_t6_c a SET ryxh=CONCAT((SELECT c01 FROM t111  WHERE id=a.dwmc),
		(CASE LENGTH(a.ryxh) WHEN '1' THEN '0000' WHEN '2' THEN '000' WHEN '3' THEN '00' WHEN '4' THEN '0' ELSE '' END
		),ryxh) 
	WHERE a.dwmc = concat(v_unit_dataId,'') and  LENGTH(ryxh)<5 ;
	-- 修改姓名为t126.id
	update ds_t6_c c,t126 set c.xm = t126.id where c.dwmc = t126.c01 and t126.c01 = concat(v_unit_dataId,'')
		and ryxh = t126.c02 and c.xm = t126.c04;
	-- 修改现职级任职时间
	UPDATE ds_t6_c SET xzjrzsj=REPLACE(xzjrzsj,'.','-') WHERE dwmc = concat(v_unit_dataId,'') and xzjrzsj LIKE '%.%';
	-- 修改低一职级任职时间
	UPDATE ds_t6_c SET dyzjrzsj=REPLACE(dyzjrzsj,'.','-') WHERE dwmc = concat(v_unit_dataId,'') and dyzjrzsj LIKE '%.%' ;
	-- 修改参加工作时间
	UPDATE ds_t6_c SET cjgzsj=REPLACE(cjgzsj,'.','-') WHERE dwmc = concat(v_unit_dataId,'') and cjgzsj LIKE '%.%' ;
	-- 修改人员身份为对应关系的数据
	update ds_t6_c c,ds_zh z set c.rysf = z.my_name 
		where c.dwmc = concat(v_unit_dataId,'') and z.table_name = 'ds_t6_c' and z.table_column = 'rysf' 
		and c.rysf = z.ds_name;
	-- 修改人员身份为码表的id
	update ds_t6_c c,sys_s_data d set c.rysf = d.id
	where c.rysf = d.name and d.typename = 'rysf' and c.dwmc = concat(v_unit_dataId,'');
	-- 修改人员当前学历为对应关系的数据
	update ds_t6_c c,ds_zh z set c.dqxl = z.my_name 
		where c.dwmc = concat(v_unit_dataId,'') and z.table_name = 'ds_t6_c' and z.table_column = 'dqxl' 
		and c.dqxl = z.ds_name;
		
	UPDATE ds_t6_c SET dqxl=(SELECT id FROM sys_s_data WHERE typename='eduLevel' AND name='无') WHERE  dqxl='' AND xm!='';
	-- 修改人员当前学历为码表的id
	update ds_t6_c c,sys_s_data d set c.dqxl = d.id
	where c.dqxl = d.name and d.typename = 'eduLevel' and c.dwmc = concat(v_unit_dataId,'');
	-- dx_zh 存入数据如下
	-- ds_t6_c 93kh05bhg 0 1993_称职,1994_称职,1995_称职,1996_称职,1997_称职,1998_称职,1999_称职,2000_称职,2001_称职,2002_称职,2003_称职,2004_称职,2005_称职
	-- 根据参加 工作时间 处理 93年到05年全部称职的情况
	update ds_t6_c c , ds_zh  z
	set 93kh05bhg = 
	if(c.cjgzsj < '1994-01-01',z.my_name,substring(my_name,POSITION(substring(c.cjgzsj,1,4) in my_name)))
	where c.dwmc = concat(v_unit_dataId,'') and z.table_name = 'ds_t6_c' 
	and table_column = '93kh05bhg' 
	and if(ifnull(93kh05bhg,'')='',0,93kh05bhg)=ds_name;
	-- 根据参加工作时间处理 不职称的情况
	update  
	ds_t6_c c , ds_zh  z
	set c.93kh05bhg = concat(
		substr(if(c.cjgzsj < '1994-01-01',z.my_name,substring(my_name,POSITION(substring(c.cjgzsj,1,4) in my_name))),
			1,
			position((2005-93kh05bhg+1) in if(c.cjgzsj < '1994-01-01',z.my_name,substring(my_name,POSITION(substring(c.cjgzsj,1,4) in my_name))))-1
		)-- 2年不称职此部分为 93-2003称职
		,
		replace(
			substr(
				if(c.cjgzsj < '1994-01-01',z.my_name,substring(my_name,POSITION(substring(c.cjgzsj,1,4) in my_name))),
				position((2005-93kh05bhg+1) in if(c.cjgzsj < '1994-01-01',z.my_name,substring(my_name,POSITION(substring(c.cjgzsj,1,4) in my_name))))
			),
			'称职',
			'不称职'
		)-- 2年称职 此部分为2004-不称职 ,2005-不称职
	)
	where c.dwmc = concat(v_unit_dataId,'')
	and z.table_name = 'ds_t6_c' 
	and table_column = '93kh05bhg' 
	and 0=z.ds_name
	and length(c.93kh05bhg)<5 
	and c.93kh05bhg>0;  
	
	-- 修改套改表现任职级为任职简历里面的数据
	UPDATE ds_t6_c a SET 
	xrzj=(SELECT zj FROM ds_t7_c WHERE id=(SELECT MAX(id) FROM ds_t7_c WHERE xm=a.xm  and dwmc = v_unit_data_name 
		AND replace(replace(rzsj,'.',''),'-','')<'200607'));

	UPDATE t131,ds_t6_c set c03=xzjrzsj,c04=dyzjrzsj,c05=xzjrznx,c06=dyzjrznx,c09=93kh05bhg,c10=zztgfs,c11=tgnx,c12=xzjtgrznx,
		c13=dyzjtgrznx,c14=jb_dc,c15=zwgz,c16=jbgz,c19=dwmc,
		c24='10487',c25='10487',c26='10487',
		c27=rysf,
		c28=dqxl,c29=cjgzsj,c30=gznx,c33=xrzj,c34=xrzj
	WHERE c01 = ds_t6_c.xm 
	and exists(select 1 from t126 where t126.c01 = concat(v_unit_dataId,'') and t126.id = t131.c01);
	
	insert into t131 (
		createrId,createDate,updaterId,updateDate,dataclassCode,
				c01,c02,c03,c04,c05,c06,c09,c10,c11,c12,c13,c14,c15,c16,c19,c24,c25,c26,c27,c28,c29,c30,c33,c34)
		select  
		1,sysdate(),1,sysdate(),'t131',
		xm,xm,xzjrzsj,dyzjrzsj,xzjrznx,dyzjrznx,93kh05bhg,zztgfs,tgnx,xzjtgrznx,dyzjtgrznx,jb_dc,zwgz,jbgz,dwmc,xrzj '10487','10487','10487',rysf,dqxl,cjgzsj,gznx,xrzj,xrzj
	 from ds_t6_c a where exists(select 1 from t126 where t126.id = xm)
	 and not exists(select 1 from t131 b where a.xm = b.c01);
	 
	 
END;

CREATE DEFINER = `root`@`localhost` PROCEDURE `smso-migration-v2`.`p_init_ds_t177`(IN v_unit_id varchar(200),IN v_unit_dataId varchar(200),
In v_unit_data_name varchar(200),
INOUT resultMsg varchar(1000) CHARSET utf8)
label_pro:BEGIN	
-- 人员奖惩情况
	select count(1) into @c from t111 where c01 = v_unit_id;
	if @c = 0 then 
		set resultMsg = '单位数据未进入t111表,请先处理!';leave label_pro;
	end if;
	if v_unit_dataId = '' then 
		select id,c02 into v_unit_dataId,v_unit_data_name from t111 where c01 = v_unit_id;
	end if;
	-- delete from ds_t10_c where dwmc in (v_unit_dataId,v_unit_id,v_unit_data_name);
	-- insert into ds_t10_c select * from ds_t10 where dwmc in (v_unit_dataId,v_unit_id,v_unit_data_name);
	
	-- ds_t10_c 人员奖惩情况
	-- 修改单位名称
	update ds_t10_c c set dwmc = concat(v_unit_dataId,'') where dwmc = v_unit_data_name;
	-- 修改人员序号
	UPDATE ds_t10_c a SET rybh=CONCAT(v_unit_id,(CASE LENGTH(a.rybh) WHEN '1' THEN '000' WHEN '2' THEN '00' WHEN '3' THEN '0' WHEN '4' THEN '' END),rybh) 
	WHERE LENGTH(rybh)<6 AND dwmc=concat(v_unit_dataId,'');
	-- 修改人员序号为id
	update ds_t10_c c,t126 set rybh = t126.id
	where c.rybh = t126.c02 and dwmc = concat(v_unit_dataId,'');
	
	UPDATE ds_t10_c a SET jcyy=IFNULL((select id from sys_s_data where typename='jcyy' and name=a.jcyy),(select my_name from ds_zh where table_column='ds_t10_c' and table_column='jcyy' and ds_name=a.jcyy)) where dwmc=concat(v_unit_dataId,'');
	
	-- 奖惩类别为对应关系的数据
	update ds_t10_c c ,ds_zh z set c.jclb = z.my_name 
	where c.dwmc = concat(v_unit_dataId,'') and c.jclb = z.ds_name 
	and z.table_name = 'ds_t10_c' and z.table_column = 'jclb' ;
	-- 奖惩类别为码表id
	update ds_t10_c c ,sys_s_data d set c.jclb = d.id 
	where c.jclb = d.name and d.typename = 'jiangchengleibie'
	and c.dwmc = concat(v_unit_dataId,'');
	
--	UPDATE ds_t10_c SET gyjcdw=IFNULL((select id from sys_s_data where typename='gyjcdw'),(select my_name from ds_zh where table_column='ds_t10_c' and table_column='gyjcdw' and ds_name=a.gyjcdw));	
	 -- 先删除原来的数据
	 delete from t177 where exists(select 1 from t126 where id = t177.c01 and t126.c01 = concat(v_unit_dataId,''));
	 -- 人员奖惩情况表
	 insert into t177(createrId,createDate,updaterId,updateDate,dataclassCode,unitId,c01,c02,c03,c04,c05,c06,c07,c08)
	 select 1,sysdate(),1,sysdate(),'t177','0',rybh,rybh,jcsj,jclb,jcyy,gyjcdw,zzsj,bz
	  from ds_t10_c where exists (select 1 from t126 where id = rybh and t126.c01 = concat(v_unit_dataId,''));
	 
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`p_init_ds_updateDWDM`(IN oldDWDM varchar(200),
In newDWDM varchar(200),In dataBaseName varchar(200),
INOUT resultMsg varchar(1000) CHARSET utf8)
label_pro:BEGIN	
declare isExsits int(11);-- 判断是否存在表
declare total int(11);-- 基金月份数量
declare fund_change_detail_table varchar(100);-- 动态拼接的变动花名册表名称
declare fund_change_subsidies_table varchar(100);-- 动态拼接的变动花名册基金表名称
declare fund_salary_fill_table varchar(100);-- 动态拼接的补扣发表名称
declare fund_salaryFill_subsidies_table varchar(100);-- 动态拼接的补扣发基金表名称
declare fund_salary_pay_table varchar(100);-- 动态拼接的发放表名称
declare fund_salary_subsidies_pay_table varchar(100);-- 动态拼接的发放基金表名称
declare yearAndMonth varchar(100);-- 当前动态基金月份
declare dw_id varchar(100); -- 单位id
declare monthMin varchar(100);  -- 单位基金月份最小月
declare monthMax varchar(100);  -- 单位基金月份最大月

SET dw_id=(SELECT id FROM t111 WHERE c01=oldDWDM OR c01=newDWDM);
UPDATE t111 SET c01=newDWDM WHERE c01=oldDWDM;
UPDATE t156 SET c01=newDWDM WHERE c01=oldDWDM;     -- 统发单位表
update t113 set c02=REPLACE(c02,oldDWDM,newDWDM) WHERE c01=concat(dw_id,''); -- 部门表
UPDATE t151 SET c06=REPLACE(c06,oldDWDM,newDWDM) WHERE c01=concat(dw_id,''); -- 年终奖金表
UPDATE t126 SET c02=REPLACE(c02,oldDWDM,newDWDM) WHERE c01=concat(dw_id,'');
UPDATE data_auto_record SET autoHead=newDWDM WHERE autoHead=oldDWDM;

-- 修改调标系统
UPDATE adjustwage.adjustindex set unitCode=newDWDM WHERE unitId=concat(dw_id,'');
UPDATE adjustwage.exadjust set rybh=replace(rybh,oldDWDM,newDWDM) WHERE unitId=concat(dw_id,'');
UPDATE adjustwage.excount set unitCode=newDWDM WHERE unitId=concat(dw_id,'');
UPDATE adjustwage.normaladjust set rybh=replace(rybh,oldDWDM,newDWDM) WHERE unitId=concat(dw_id,'');
UPDATE adjustwage.retireadjust set rybh=replace(rybh,oldDWDM,newDWDM) WHERE unitId=concat(dw_id,'');
UPDATE adjustwage.ywjyadjust set rybh=replace(rybh,oldDWDM,newDWDM) WHERE unitId=concat(dw_id,'');

-- 年报系统
UPDATE yearreport.rylist SET f1=newDWDM WHERE unitId=concat(dw_id,'');
UPDATE yearreport.txrylist SET f1=newDWDM WHERE unitId=concat(dw_id,'');
UPDATE yearreport.dwlist SET f1=newDWDM WHERE unitId=concat(dw_id,'');
UPDATE yearreport.txdwlist SET f1=newDWDM WHERE unitId=concat(dw_id,'');


-- UPDATE data_record_t126 a,t126 b SET a.c02=b.c02 WHERE a.c01=b.c01 AND a.dataId=b.id AND b.c01=dw_id;
-- 修改变动记录人员表编号
UPDATE data_record_t126 SET c02=REPLACE(c02,oldDWDM,newDWDM) WHERE c01=concat(dw_id,'');
-- 离休基金表
UPDATE lx_fund_audit_record SET unit_code=newDWDM WHERE unit_code=oldDWDM AND unit_id=dw_id;
UPDATE lx_salary_pay a,t126 b SET a.rybh=b.c02  WHERE a.ryid=b.id AND a.dwid=dw_id;
UPDATE lx_salary_fill a,t126 b SET a.rybh=b.c02  WHERE a.ryid=b.id AND a.dwid=dw_id;
UPDATE lx_change_register a,t126 b SET a.rybh=b.c02  WHERE a.ryid=b.id AND a.dwid=dw_id;
-- 在职基金表
UPDATE fund_audit_record SET unit_code=newDWDM WHERE unit_code=oldDWDM AND unit_id=dw_id;
UPDATE fund_total_gov SET unit_code=newDWDM WHERE unit_code=oldDWDM AND unit_id=dw_id;
UPDATE fund_total_ins SET unit_code=newDWDM WHERE unit_code=oldDWDM AND unit_id=dw_id;
UPDATE fund_total_person_gov SET unit_code=newDWDM WHERE unit_code=oldDWDM AND unit_id=dw_id;
UPDATE fund_total_person_ins SET unit_code=newDWDM WHERE unit_code=oldDWDM AND unit_id=dw_id;
UPDATE fund_total_person_type_gov SET unit_code=newDWDM WHERE unit_code=oldDWDM AND unit_id=dw_id;


SET total=(SELECT COUNT(DISTINCT(fund_month)) FROM fund_audit_record WHERE unit_id=dw_id);

begin
declare i int;
set i=0;
 while i<total do

SET yearAndMonth =(SELECT DISTINCT(fund_month) FROM
 fund_audit_record WHERE unit_id=dw_id LIMIT i,1);
-- 动态拼接的基金表名
SET fund_change_detail_table=CONCAT('fund_change_detail_',yearAndMonth);
SET fund_change_subsidies_table=CONCAT('fund_change_subsidies_',yearAndMonth);
SET fund_salary_fill_table=CONCAT('fund_salary_fill_',yearAndMonth);
SET fund_salaryFill_subsidies_table=CONCAT('fund_salary_fill_subsidies_',yearAndMonth);
SET fund_salary_pay_table=CONCAT('fund_salary_pay_',yearAndMonth);
SET fund_salary_subsidies_pay_table=CONCAT('fund_salary_subsidies_pay_',yearAndMonth);
-- 更新在职基金子表 共6张表
SET isExsits=(SELECT COUNT(1) FROM information_schema.TABLES WHERE table_name =
fund_change_detail_table AND TABLE_SCHEMA=dataBaseName);
-- 存在此表才更新
if isExsits > 0 then  
SET @statement = CONCAT("UPDATE ",fund_change_detail_table," SET unit_code='",newDWDM,"',
staff_code=","replace(staff_code,'",oldDWDM,"','",newDWDM,"') WHERE unit_code='",oldDWDM,"' AND unit_id='",dw_id,"';");
PREPARE stmt FROM @statement;
EXECUTE stmt;
end if;

SET isExsits=(SELECT COUNT(1) FROM information_schema.TABLES WHERE table_name =
fund_change_subsidies_table AND TABLE_SCHEMA=dataBaseName);
if isExsits > 0 then  
SET @statement = CONCAT("UPDATE ",fund_change_subsidies_table," SET unit_code='",newDWDM,"' WHERE unit_code='",oldDWDM,"' AND unit_id='",dw_id,"';");
PREPARE stmt FROM @statement;
EXECUTE stmt;
end if;

SET isExsits=(SELECT COUNT(1) FROM information_schema.TABLES WHERE table_name =
fund_salary_fill_table AND TABLE_SCHEMA=dataBaseName);
if isExsits > 0 then  
SET @statement = CONCAT("UPDATE ",fund_salary_fill_table," SET unit_code='",newDWDM,"',
staff_code=","replace(staff_code,'",oldDWDM,"','",newDWDM,"') WHERE unit_code='",oldDWDM,"' AND unit_id='",dw_id,"';");
PREPARE stmt FROM @statement;
EXECUTE stmt;
end if;

SET isExsits=(SELECT COUNT(1) FROM information_schema.TABLES WHERE table_name =
fund_salaryFill_subsidies_table AND TABLE_SCHEMA=dataBaseName);
if isExsits > 0 then  
SET @statement = CONCAT("UPDATE ",fund_salaryFill_subsidies_table," SET unit_code='",newDWDM,"' WHERE unit_code='",oldDWDM,"' AND unit_id='",dw_id,"';");
PREPARE stmt FROM @statement;
EXECUTE stmt;
end if;

SET isExsits=(SELECT COUNT(1) FROM information_schema.TABLES WHERE table_name =
fund_salary_pay_table AND TABLE_SCHEMA=dataBaseName);
if isExsits > 0 then 
SET @statement = CONCAT("UPDATE ",fund_salary_pay_table," SET unit_code='",newDWDM,"',
staff_code=","replace(staff_code,'",oldDWDM,"','",newDWDM,"') WHERE unit_code='",oldDWDM,"' AND unit_id='",dw_id,"';");
PREPARE stmt FROM @statement;
EXECUTE stmt;
end if;

SET isExsits=(SELECT COUNT(1) FROM information_schema.TABLES WHERE table_name =
fund_salary_subsidies_pay_table AND TABLE_SCHEMA=dataBaseName);
if isExsits > 0 then 
SET @statement = CONCAT("UPDATE ",fund_salary_subsidies_pay_table," SET unit_code='",newDWDM,"' WHERE unit_code='",oldDWDM,"' AND unit_id='",dw_id,"';");
PREPARE stmt FROM @statement;
EXECUTE stmt;
end if;

 set i=i+1;
 end while;
end;

-- 根据变动记录起薪时间  获取单位最小基金发放表月份  
SET monthMin=(SELECT DISTINCT(replace(min(c02),'-','')) FROM data_record_t125 WHERE c05=dw_id);


begin
declare i int;
set i=1;
 while monthMin<monthMax do
SET monthMax=(SELECT DATE_FORMAT(DATE_ADD(SYSDATE(), INTERVAL i MONTH),'%Y%m'));
SET yearAndMonth = monthMax;

SET fund_salary_pay_table=CONCAT('fund_salary_pay_',yearAndMonth);
SET fund_salary_subsidies_pay_table=CONCAT('fund_salary_subsidies_pay_',yearAndMonth);

SET isExsits=(SELECT COUNT(1) FROM information_schema.TABLES WHERE table_name =
fund_salary_pay_table AND TABLE_SCHEMA=dataBaseName);
if isExsits > 0 then 
SET @statement = CONCAT("UPDATE ",fund_salary_pay_table," SET unit_code='",newDWDM,"',
staff_code=","replace(staff_code,'",oldDWDM,"','",newDWDM,"') WHERE unit_code='",oldDWDM,"' AND unit_id='",dw_id,"';");
PREPARE stmt FROM @statement;
EXECUTE stmt;
end if;

SET isExsits=(SELECT COUNT(1) FROM information_schema.TABLES WHERE table_name =
fund_salary_subsidies_pay_table AND TABLE_SCHEMA=dataBaseName);
if isExsits > 0 then 
SET @statement = CONCAT("UPDATE ",fund_salary_subsidies_pay_table," SET unit_code='",newDWDM,"' WHERE unit_code='",oldDWDM,"' AND unit_id='",dw_id,"';");
PREPARE stmt FROM @statement;
EXECUTE stmt;
end if;

 set i=i-1;
 end while;
end;


END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`p_init_ds_wrongList`(IN dwid varchar(200),
INOUT resultMsg varchar(1000) CHARSET utf8)
label_pro:BEGIN	

DELETE FROM t181 where c03=concat(dwid,'');

INSERT into t181 (createrId,createDate,updateDate,c01,c02,c03,c04,c05,c06,c07,c08)  
SELECT 
'0',SYSDATE(),SYSDATE(),'','',t111.c02,t111.c01,'单位编制表','所有字段','本单位单位编制未完善',
"请联系终审单位进行管理完善"
FROM t111 WHERE 1=1 and id = dwid
and concat(id,'') NOT in(SELECT c01 FROM t112);

INSERT into t181 (createrId,createDate,updateDate,c01,c02,c03,c04,c05,c06,c07,c08)  SELECT 
'0',SYSDATE(),SYSDATE(),t126.c04,t126.c02,t111.c02,t111.c01,'所有表' as c05,'所有字段' AS c06,'该人员身份证号码在系统中重复，请复核该人员相关信息' AS c07,"请在'人员管理-在职人员管理-基础信息个别变动'中选择该人员进行修改" AS c08
FROM t126,t111  WHERE 1=1 and t111.id = dwid
 and t126.c01=concat(t111.id,'') and t126.c40 != 10831 and t126.c03 = 10371 AND t126.c07 in
(SELECT a.c07 FROM t126 a WHERE  a.c01 = concat(dwid,'') and a.id IN(SELECT id FROM t126 where c01 = concat(dwid,'') GROUP BY c07 HAVING COUNT(c07) > 1) AND a.c07!='') order BY t126.c04;

INSERT into t181 (createrId,createDate,updateDate,c01,c02,c03,c04,c05,c06,c07,c08)  SELECT 
'0',SYSDATE(),SYSDATE(),t126.c04,t126.c02,t111.c02,t111.c01,'人员基本信息表' as c05,'身份证号' AS c06,'该人员身份证号码为空' AS c07,"请在'人员管理-在职人员管理-基础信息个别变动'中选择该人员进行修改" AS c08
FROM t126,t111  WHERE 1=1 and t111.id = dwid
 and t126.c01=concat(t111.id,'') and t126.c03 = 10371 and t126.c40 != 10831 AND length(t126.c07)<10 ;

-- 人员编号重复
INSERT into t181 (createrId,createDate,updateDate,c01,c02,c03,c04,c05,c06,c07,c08)
SELECT '0',SYSDATE(),SYSDATE(),'',a.c02,a.c01,'','人员基本信息表',CONCAT('请核对以下人员编号:',a.c02,',重复',count(1),'条'),'人员编号重复',"请确认人员编号及人员信息后联系三夫-客服进行编号修改"
 FROM t126 a
where c01 = concat(dwid,'')
group by c02 having count(1) > 1;

/**
INSERT into t181 (createrId,createDate,updateDate,c01,c02,c03,c04,c05,c06,c07,c08)
SELECT '0',SYSDATE(),SYSDATE(),a.c04,a.c02,b.c02,b.c01,'人员基本信息表','参加工作时间','参加工作时间没填，请完善！',"请在'工资变动-个别人员工资变动-重新确定工资(原填报有误)'中进行修改"
 FROM t126 a,t111 b WHERE 1=1  and b.id = dwid
 and  a.c01=concat(b.id,'') AND  a.c12='' and a.c28 != '10522' -- 不等于运动员 
 and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
	-- 非离休人员
;
*/
 
 
/**
-- 参加工作时间-年
INSERT into t181 (createrId,createDate,updateDate,c01,c02,c03,c04,c05,c06,c07,c08)
SELECT '0',SYSDATE(),SYSDATE(),a.c04,a.c02,b.c02,b.c01,'人员基本信息表','工作时间-年'
,"该人员的'工作时间-年'为空！"
,"请在'工资变动-个别人员工资变动-重新确定工资(原填报有误)'中进行修改"
 FROM t126 a,t111 b WHERE b.id = dwid
 and a.c01=concat(b.id,'') AND (a.c47='' OR a.c47 IS NULL)  and a.c28 != '10522' -- 不等于运动员
 and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
	-- 非离休人员
;
*/

/**
-- 现任职务  现任职务时间
INSERT into t181 (createrId,createDate,updateDate,c01,c02,c03,c04,c05,c06,c07,c08)
SELECT '0',SYSDATE(),SYSDATE(),a.c04,a.c02,b.c02,b.c01,'人员基本信息表','现任职务','现任职务没填，请完善！',"请在'工资变动-个别人员工资变动-重新确定工资(原填报有误)'中进行修改"
 FROM t126 a,t111 b WHERE b.id = dwid
  and a.c01=concat(b.id,'') AND  a.c28 NOT in 
('10522','10523','10524','10525','10526','10527','10528','10529','10530','10531','10532')
 AND a.c19=''
 and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
	-- 非离休人员
;
*/

/**
INSERT into t181 (createrId,createDate,updateDate,c01,c02,c03,c04,c05,c06,c07,c08)
SELECT '0',SYSDATE(),SYSDATE(),a.c04,a.c02,b.c02,b.c01,'人员基本信息表','现任职务时间','现任职务时间没填，请完善！',"请在'工资变动-个别人员工资变动-重新确定工资(原填报有误)'中进行修改"
 FROM t126 a,t111 b WHERE b.id = dwid
  and a.c01=concat(b.id,'') AND  a.c28 NOT in 
('10522','10523','10524','10525','10526','10527','10528','10529','10530','10531','10532')
 AND a.c20=''
 and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
	-- 非离休人员
;
*/

/**
INSERT into t181 (createrId,createDate,updateDate,c01,c02,c03,c04,c05,c06,c07,c08)
SELECT '0',SYSDATE(),SYSDATE(),a.c04,a.c02,b.c02,b.c01,'人员基本信息表','进入本单位时间','进入本单位时间没填，请完善！',"请在'人员管理-在职人员管理-基础信息个别变动'中进行修改"
 FROM t126 a,t111 b WHERE b.id = dwid
 and  a.c01=concat(b.id,'') AND  a.c13=''
 and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
	-- 非离休人员
;
*/

INSERT into t181 (createrId,createDate,updateDate,c01,c02,c03,c04,c05,c06,c07,c08)
SELECT '0',SYSDATE(),SYSDATE(),a.c04,a.c02,b.c02,b.c01,'人员基本信息表',CONCAT('实际职级：',a.c36),'请检查该人员的实际职级，并按照系统规范完善！',"请在'工资变动-个别人员工资变动-重新确定工资(原填报有误)'中进行修改"
 FROM t126 a,t111 b WHERE b.id = dwid
 and  a.c01=concat(b.id,'') AND  a.c36 regexp '[^0-9]'
 and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
	-- 非离休人员
;

INSERT into t181 (createrId,createDate,updateDate,c01,c02,c03,c04,c05,c06,c07,c08)
SELECT '0',SYSDATE(),SYSDATE(),a.c04,a.c02,b.c02,b.c01,'人员基本信息表',CONCAT('工资对应职级：',a.c17),'请检查该人员的工资对应职级，并按照系统规范完善！',"请在'工资变动-个别人员工资变动-重新确定工资(原填报有误)'中进行修改"
 FROM t126 a,t111 b WHERE b.id = dwid and  a.c01=concat(b.id,'') AND (a.c17 regexp '[^0-9]' OR  a.c17 LIKE '%-%')
 and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
	-- 非离休人员
;

INSERT into t181 (createrId,createDate,updateDate,c01,c02,c03,c04,c05,c06,c07,c08)
SELECT '0',SYSDATE(),SYSDATE(),a.c04,a.c02,b.c02,b.c01,'人员基本信息表',CONCAT('是否领导职务',a.c27),'请检查该人员的是否领导职务，并按照系统规范完善！',"请在'工资变动-个别人员工资变动-重新确定工资(原填报有误)'中进行修改"
 FROM t126 a,t111 b WHERE b.id = dwid and a.c01=concat(b.id,'') AND (a.c27 ='副科级')
 and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
	-- 非离休人员
;

INSERT into t181 (createrId,createDate,updateDate,c01,c02,c03,c04,c05,c06,c07,c08)
SELECT '0',SYSDATE(),SYSDATE(),a.c04,a.c02,b.c02,b.c01,'人员基本信息表',CONCAT('正式参加工作前可计算工龄时间',a.c32),'该人员的正式参加工作前可计算工龄时间不合理，请按照实际情况完善！',"请在'工资变动-个别人员工资变动-重新确定工资(原填报有误)'中进行修改"
 FROM t126 a,t111 b WHERE b.id = dwid and a.c01=concat(b.id,'') AND (a.c32 LIKE '-%')
 and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
	-- 非离休人员
;

INSERT into t181 (createrId,createDate,updateDate,c01,c02,c03,c04,c05,c06,c07,c08)
SELECT '0',SYSDATE(),SYSDATE(),a.c04,a.c02,b.c02,b.c01,'人员基本信息表',CONCAT('间断工作年限-月',a.c35),'该人员的间断工作年限-月不合理，请按照实际情况完善！',"请在'工资变动-个别人员工资变动-重新确定工资(原填报有误)'中进行修改"
 FROM t126 a,t111 b WHERE b.id = dwid and a.c01=concat(b.id,'') AND (a.c35 LIKE '%-%' OR LENGTH(a.c35)>2)
 and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
	-- 非离休人员
;

-- 工资级别出现汉字
INSERT into t181 (createrId,createDate,updateDate,c01,c02,c03,c04,c05,c06,c07,c08)
SELECT '0',SYSDATE(),SYSDATE(),c.c04,c.c02,b.c02,b.c01,'人员工资信息表',CONCAT('工资级别：',a.c07),'该复核该人员的工资级别 和 级别档次！',"请在'工资变动-个别人员工资变动-重新确定工资(原填报有误)'中进行修改"
 FROM t125 a,t111 b,t126 c WHERE b.id = dwid and c.c01 = concat(dwid,'') and  a.c05=concat(b.id,'') AND concat(c.id,'')=a.c06 AND a.c07  regexp '[^0-9]'
 and not exists(select 1 from sys_s_data d where concat(d.id,'') = c.c03 and d.typename = 'staffStatus' and d.data_value = '2')
	-- 非离休人员
;

-- 级别档次出现汉字
INSERT into t181 (createrId,createDate,updateDate,c01,c02,c03,c04,c05,c06,c07,c08)
SELECT '0',SYSDATE(),SYSDATE(),c.c04,c.c02,b.c02,b.c01,'人员工资信息表',CONCAT('级别档次：','不正确'),'请复核该人员的人员身份 级别档次是否正确并完善！',"请在'工资变动-个别人员工资变动-重新确定工资(原填报有误)'中进行修改"
 FROM t125 a,t111 b,t126 c WHERE b.id = dwid and c.c01 = concat(dwid,'') and a.c05=concat(b.id,'') AND concat(c.id,'')=a.c06 AND a.c09  regexp '[^0-9]'
 and not exists(select 1 from sys_s_data d where concat(d.id,'') = c.c03 and d.typename = 'staffStatus' and d.data_value = '2')
	-- 非离休人员
;
/**
-- 试用期基本工资未填写
INSERT into t181 (createrId,createDate,updateDate,c01,c02,c03,c04,c05,c06,c07,c08)
		SELECT '0',SYSDATE(),SYSDATE(),c.c04,c.c02,b.c02,b.c01,'人员工资信息表',CONCAT(b.c02,c.c04,a.c01,',人员基本工资为空'),'人员基本工资为空',"请在'工资变动-变动记录查询-编辑新进人员-人员工资信息'中确认信息并点击保存"
		 FROM t125 a,t111 b,t126 c WHERE b.id = dwid  and c.c01 = concat(dwid,'') and a.c05=concat(b.id,'') AND concat(c.id,'')=a.c06 AND a.c25=''
	 and not exists(select 1 from sys_s_data d where d.id = c.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
	 and not exists(select 1 from t127 where concat(t127.id,'') = c.c17 and t127.c05 = '普通工')
	 -- 非普通工
	;
*/
/*
-- 绩效工资
INSERT into t181 (createrId,createDate,updateDate,c01,c02,c03,c04,c05,c06,c07,c08)
SELECT '0',SYSDATE(),SYSDATE(),c.c04,c.c02,b.c02,b.c01,'人员工资信息表',CONCAT('绩效工资',a.c31),'该人员的绩效工资为汉字，需要转换！',"请在'工资变动-变动记录查询'中进行修改"
 FROM t125 a,t111 b,t126 c WHERE b.id = dwid  and c.c01 = concat(dwid,'') and a.c05=concat(b.id,'') AND concat(c.id,'')=a.c06 AND a.c31  regexp '[^0-9]'
 and not exists(select 1 from sys_s_data d where d.id = c.c03 and d.typename = 'staffStatus' and d.data_value = '2')
	-- 非离休人员
;*/

-- 查询那些人员工资表没有数据
INSERT into t181 (createrId,createDate,updateDate,c01,c02,c03,c04,c05,c06,c07,c08)
SELECT '0',SYSDATE(),SYSDATE(),a.c04,a.c02,b.c02,b.c01,'人员工资信息表',CONCAT('人员工资信息表没有：',a.c04,'的数据'),'该单位没有该人员的工资信息数据，请按照实际情况完善！',"请在'工资变动-个别人员工资变动-重新确定工资(原填报有误)'中进行完善"
 FROM t126 a,t111 b WHERE b.id = dwid and a.c01 = concat(dwid,'') AND a.id NOT in (SELECT c06 FROM t125 where c05 = concat(dwid,''))
 and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
	-- 非离休人员
;

-- 单位津补贴重复
INSERT into t181 (createrId,createDate,updateDate,c01,c02,c03,c04,c05,c06,c07)
SELECT '0',SYSDATE(),SYSDATE(),b.c02,b.c01,b.c02,b.c01,'单位津补贴表',CONCAT('单位津补贴：',c.c03,'重复了'),'该单位该项津补贴重复了，请进行相关调整！'
 FROM t115 a,t111 b,t116 c WHERE b.id = dwid and concat(b.id,'')=a.c02 AND a.c03=concat(c.id,'') 
 AND a.id IN(SELECT a.id FROM t115 a,t115 b WHERE a.c02=b.c02 AND a.c03=b.c03 AND a.id>b.id)
 and not exists(select 1 from sys_s_data d where d.id = c.c03 and d.typename = 'staffStatus' and d.data_value = '2')
	-- 非离休人员
;

-- 人员津补贴重复
INSERT into t181 (createrId,createDate,updateDate,c01,c02,c03,c04,c05,c06,c07)
SELECT '0',SYSDATE(),SYSDATE(),c.c04,c.c02,b.c02,b.c01,'人员津补贴表',CONCAT('人员津补贴：',e.c03,'重复了'),'该人员该项津补贴重复了，请进行相关调整！'
 FROM t117 a,t111 b,t126 c,t116 e WHERE   b.id = dwid  and c.c01 = concat(dwid,'')
 and concat(b.id,'')=a.c02 AND a.c03=concat(c.id,'') AND a.c04=concat(e.id,'') 
 AND a.id IN(SELECT a.id FROM t117 a,t117 b WHERE a.c03=b.c03 AND a.c04=b.c04 AND a.id>b.id)
 and not exists(select 1 from sys_s_data d where d.id = c.c03 and d.typename = 'staffStatus' and d.data_value = '2')
	-- 非离休人员
;

-- 人员套改信息 11-15
-- INSERT into t181 (createrId,createDate,updateDate,c01,c02,c03,c04,c05,c06,c07,c08)
-- SELECT '0',SYSDATE(),SYSDATE(),c.c04,c.c02,b.c02,b.c01,'人员套改信息表',CONCAT(b.c02,c.c04,'需完善人员套改信息现职级任职时间！'),'缺少现职级任职时间',"请在'工资变动-变动记录查询-编辑新进人员-人员套改信息'中进行修改"
-- FROM t131 a,t111 b,t126 c WHERE  b.id = dwid  and c.c01 = concat(dwid,'')
-- and a.c19=concat(dwid,'') AND a.c01=concat(c.id,'')  AND a.c03=''
-- and not exists(select 1 from sys_s_data d where d.id = c.c03 and d.typename = 'staffStatus' and d.data_value = '2')
	-- 非离休人员
-- ;
-- 11-15
-- INSERT into t181 (createrId,createDate,updateDate,c01,c02,c03,c04,c05,c06,c07,c08)
-- SELECT '0',SYSDATE(),SYSDATE(),c.c04,c.c02,b.c02,b.c01,'人员套改信息表',CONCAT(b.c02,c.c04,'现职级任职年限不合理！'),'现职级任职年限不合理',"请在'工资变动-变动记录查询-编辑新进人员-人员套改信息'中进行修改"
-- FROM t131 a,t111 b,t126 c WHERE b.id = dwid   and c.c01 = concat(dwid,'') and 
-- a.c19=concat(dwid,'') AND a.c01=concat(c.id,'')  AND a.c05>40
-- and not exists(select 1 from sys_s_data d where d.id = c.c03 and d.typename = 'staffStatus' and d.data_value = '2')
	-- 非离休人员
-- ;
-- 11-15
-- INSERT into t181 (createrId,createDate,updateDate,c01,c02,c03,c04,c05,c06,c07,c08)
-- SELECT '0',SYSDATE(),SYSDATE(),c.c04,c.c02,b.c02,b.c01,'人员套改信息表',CONCAT(b.c02,c.c04,'低一职级任职年限不合理！'),'低一职级任职年限不合理',"请在'工资变动-变动记录查询-编辑新进人员-人员套改信息'中进行修改"
-- FROM t131 a,t111 b,t126 c WHERE b.id = dwid  and c.c01 = concat(dwid,'') and
-- a.c19=concat(dwid,'') AND a.c01=concat(c.id,'')  AND a.c06>40
-- and not exists(select 1 from sys_s_data d where d.id = c.c03 and d.typename = 'staffStatus' and d.data_value = '2')
	-- 非离休人员
-- ;
-- 11-5
-- INSERT into t181 (createrId,createDate,updateDate,c01,c02,c03,c04,c05,c06,c07,c08)
-- SELECT '0',SYSDATE(),SYSDATE(),c.c04,c.c02,b.c02,b.c01,'人员套改信息表',CONCAT(b.c02,c.c04,'套改信息未完善'),'请在人员套改信息中完善必要信息（人员身份 当前学历 参加工作时间 现任职级 现职级任职时间）后重新进行套改',"请在'工资变动-变动记录查询-编辑新进人员-人员套改信息'中进行修改"
-- FROM t131 a,t111 b,t126 c WHERE  b.id = dwid  and c.c01 = concat(dwid,'') and  
-- a.c19=concat(dwid,'') AND a.c01=concat(c.id,'')  AND (a.c14='-' or a.c14='')
-- and not exists(select 1 from sys_s_data d where d.id = c.c03 and d.typename = 'staffStatus' and d.data_value = '2')
	-- 非离休人员
-- ;
-- 11-15
-- INSERT into t181 (createrId,createDate,updateDate,c01,c02,c03,c04,c05,c06,c07,c08)
--	SELECT '0',SYSDATE(),SYSDATE(),c.c04,c.c02,b.c02,b.c01,'人员套改信息表',CONCAT(b.c02,c.c04,'工作年限不合理'),'人员工作年限不合理，请完善后重新进行套改',"请在'工资变动-变动记录查询-编辑新进人员-人员套改信息'中进行修改"
--	FROM t131 a,t111 b,t126 c WHERE  b.id = dwid  and c.c01 = concat(dwid,'') and 
-- a.c19=concat(dwid,'') AND a.c01=concat(c.id,'')  AND  (a.c30>40 OR a.c30 LIKE '-%')
-- and not exists(select 1 from sys_s_data d where d.id = c.c03 and d.typename = 'staffStatus' and d.data_value = '2')
	-- 非离休人员
-- ;
  
-- 2006年试用期人员  不需要完善的套改信息  11-15
-- DELETE FROM t181  WHERE  t181.c05='人员套改信息表' AND t181.c02 in 
-- (SELECT c02 FROM t126 WHERE id in(SELECT DISTINCT(a.c01) FROM t131 a,t127 b WHERE a.c19=concat(dwid,'') AND b.c05 LIKE '%期'))
-- ;

-- 检测出那些人员缺少套改信息 11-15
-- INSERT into t181 (createrId,createDate,updateDate,c01,c02,c03,c04,c05,c06,c07,c08)
--	SELECT '0',SYSDATE(),SYSDATE(),c.c04,c.c02,b.c02,b.c01,'人员套改信息表',CONCAT(b.c02,c.c04,'套改信息缺少'),'请完善该人员的套改信息' ,"请在'工资变动-变动记录查询-编辑新进人员-人员套改信息'中进行修改"
--	FROM  t111 b,t126 c WHERE b.id = dwid and c.c01 = concat(dwid,'')
-- AND  c.c12<'2005-06-30' AND c.id NOT in (SELECT c01 FROM t131 where c19 = concat(dwid,'') ) AND  c.c12!=''
-- and not exists(select 1 from sys_s_data d where d.id = c.c03 and d.typename = 'staffStatus' and d.data_value = '2')
	-- 非离休人员
-- and not exists(select 1 from t131 a,t127 b WHERE a.c19=concat(dwid,'') and a.c01 = concat(c.id,'') AND b.c05 LIKE '%期')
 -- 非试用期人员
-- ;

-- 检测出现职级任职时间和低一职级任职时间相同
/** 
	INSERT into t181 (createrId,createDate,updateDate,c01,c02,c03,c04,c05,c06,c07,c08)
	SELECT '0',SYSDATE(),SYSDATE(),c.c04,c.c02,b.c02,b.c01,'人员套改信息表',CONCAT(b.c02,c.c04,'现职级任职时间和低一职级任职时间相同'),'现职级任职时间和低一职级任职时间相同,请完善后重新进行套改！' ,"请在'工资变动-变动记录查询-编辑新进人员-人员套改信息'中进行修改"
	from t131 a,t111 b,t126 c WHERE   a.c19=b.id AND a.c01=c.id AND  a.c04!='' AND a.c03=a.c04
 and not exists(select 1 from sys_s_data d where d.id = c.c03 and d.typename = 'staffStatus' and d.data_value = '2')
	-- 非离休人员
;
*/
-- 任职简历 未填写的
/**
UPDATE t126 SET c29='' WHERE c29 IS NULL AND c01=dwid;
UPDATE t126  SET c29=CONCAT(c29,'@') WHERE c01=dwid AND c12<'2016-11-23';
UPDATE t121 a,t126 b SET b.c29=replace(b.c29,'@','') WHERE a.c01=b.id AND b.c01=dwid;
INSERT into t181 (createrId,createDate,updateDate,c01,c02,c03,c04,c05,c06,c07,c08)
	SELECT '0',SYSDATE(),SYSDATE(),c.c04,c.c02,b.c02,b.c01,'人员任职简历表',CONCAT(b.c02,c.c04,'任职简历未填写'),'任职简历未填写，请完善',"请在'工资变动-变动记录查询-编辑新进人员-人员任职简历'中进行完善" 
	from t126 c,t111 b  WHERE c.c01=dwid and c.c01=b.id   AND c.c29  LIKE '%@'
 and not exists(select 1 from sys_s_data d where d.id = c.c03 and d.typename = 'staffStatus' and d.data_value = '2');
UPDATE t126 b SET b.c29=replace(b.c29,'@','') WHERE  b.c01=dwid;
*/

-- 任职简历 任职简历职级未转换成系统名称，原因是名称不规范
INSERT into t181 (createrId,createDate,updateDate,c01,c02,c03,c04,c05,c06,c07,c08)
	SELECT '0',SYSDATE(),SYSDATE(),c.c04,c.c02,b.c02,b.c01,'人员任职简历表',CONCAT(b.c02,c.c04,'任职简历职级未转换成系统名称，原因是名称不规范'),'任职简历职级未转换成系统名称，原因是名称不规范',"请在'工资变动-个别人员工资变动-重新确定工资(原填报有误)(或人员任职简历)'中进行修改" 
	from t121 a,t111 b,t126 c  WHERE b.id = dwid and c.c01=concat(dwid,'')  and a.c03=concat(b.id,'')  AND  a.c01=concat(c.id,'')  AND a.c06 REGEXP  '[^0-9]'
 and not exists(select 1 from sys_s_data d where d.id = c.c03 and d.typename = 'staffStatus' and d.data_value = '2')
	-- 非离休人员
;
/**
-- 存在任职简历任职级时间/任职务时间大于当前人员现任职务或现任职级时间
INSERT into t181 (createrId,createDate,updateDate,c01,c02,c03,c04,c05,c06,c07,c08)
	-- SELECT '0',SYSDATE(),SYSDATE(),c.c04,c.c02,b.c02,b.c01,'人员任职简历表',CONCAT(b.c02,c.c04,'任职简历职级未转换成系统名称，原因是名称不规范'),'任职简历职级未转换成系统名称，原因是名称不规范',"请在'工资变动-变动记录查询-编辑新进人员-人员任职简历'中进行修改" 
	-- from t121 a,t111 b,t126 c  WHERE   a.c03=b.id  AND  a.c01=c.id  AND a.c06 REGEXP  '[^0-9]';
select '0',SYSDATE(),SYSDATE(),t126.c04,t126.c02,t111.c02,t111.c01,'人员任职简历表',concat(t126.c04,'存在任职简历任职级时间/任职务时间大于当前人员现任职务或现任职级时间'),'任职简历任职级时间/任职务时间大于当前人员现任职务或现任职级时间',"请在'工资变动-个别人员工资变动-重新确定工资(原填报有误)(或人员任职简历)'中进行修改;'若该变动非录入新进人员，请复核现任职级时间后删除，再重新做此变动'" 
from t126 ,t111 
where t111.id = dwid and t126.c01 = concat(t111.id,'') 
and ( t126.c18 < (select max(t121.c07) from t121 where t121.c02 = concat(t126.id,'')  )
or t126.c20 < (select max(t121.c09) from t121 where t121.c02 = concat(t126.id,'')  )
)  and t126.c28 != '10522' -- 不等于运动员
 and not exists(select 1 from sys_s_data d where d.id = t126.c03 and d.typename = 'staffStatus' and d.data_value = '2')
	-- 非离休人员
; 
*/
-- 存在任职简历任职级时间/任职务时间大于当前人员现任职务或现任职级时间
/**
INSERT into t181 (createrId,createDate,updateDate,c01,c02,c03,c04,c05,c06,c07,c08)
select '0',SYSDATE(),SYSDATE(),t126.c04,t126.c02,t111.c02,t111.c01,'人员学习简历表',concat(t126.c04,'存在毕业时间大于当前人员最新毕业时间数据'),'学习简历中存在毕业时间大于当前人员最新毕业时间数据',"请在'工资变动-个别人员工资变动-重新确定工资(原填报有误)(或人员学习简历)'中进行修改" 
-- select t126.id,t126.c01,t126.c04,t126.c11 
from t126 ,t111 
where t111.id = dwid and t126.c01 = concat(t111.id,'')
and ( t126.c11 < (select max(t122.c05) from t122 where t122.c02 = concat(t126.id,'')  ) 
) and t126.c28 != '10522' -- 不等于运动员
 and not exists(select 1 from sys_s_data d where d.id = t126.c03 and d.typename = 'staffStatus' and d.data_value = '2')
	-- 非离休人员
; 
*/
/**
-- 任职时间为空
INSERT into t181 (createrId,createDate,updateDate,c01,c02,c03,c04,c05,c06,c07,c08)
	SELECT '0',SYSDATE(),SYSDATE(),c.c04,c.c02,b.c02,b.c01,'人员任职简历表',CONCAT(b.c02,c.c04,'任职时间为空'),'任职时间为空',"请在'工资变动-个别人员工资变动-重新确定工资(原填报有误)(或人员任职简历)'中进行修改" 
	from t121 a,t111 b,t126 c  WHERE b.id = dwid and c.c01 = concat(dwid,'') and a.c03=concat(b.id,'')  AND  a.c01=concat(c.id,'')  AND a.c07 =''
 and not exists(select 1 from sys_s_data d where d.id = c.c03 and d.typename = 'staffStatus' and d.data_value = '2')
	-- 非离休人员
;
*/

-- 单位代码是汉字
INSERT into t181 (createrId,createDate,updateDate,c01,c02,c03,c04,c05,c06,c07,c08)
	SELECT '0',SYSDATE(),SYSDATE(),b.c02,b.c01,b.c02,b.c01,'人员任职简历表',CONCAT(b.c02,'单位代码是汉字'),'单位代码是汉字',"请在'工资变动-个别人员工资变动-重新确定工资(原填报有误)(或人员任职简历)'中进行修改" 
	from t121 a,t111 b  WHERE b.id = dwid and a.c03=concat(b.id,'')  AND  a.c03 REGEXP  '[^0-9]'
;
 
/**
-- 取得学历时间未填写或填写不规范  排除学历为无的人员
INSERT into t181 (createrId,createDate,updateDate,c01,c02,c03,c04,c05,c06,c07,c08)
	SELECT '0',SYSDATE(),SYSDATE(),c.c04,c.c02,b.c02,b.c01,'人员学习简历表',CONCAT(b.c02,c.c04,'取得学历时间未填写或填写不规范'),'取得学历时间未填写或填写不规范' ,"请在'人员管理-在职人员管理-基础信息个别变动'中进行修改"
	from t122 a,t111 b,t126 c WHERE b.id = dwid  and c.c01 = concat(b.id,'') and a.c02=concat(c.id,'') AND c.c01=b.id  AND a.c04!='11193'  AND LENGTH(a.c05)<10
 and not exists(select 1 from sys_s_data d where d.id = c.c03 and d.typename = 'staffStatus' and d.data_value = '2')
	-- 非离休人员
;
*/

select DATE_FORMAT(SYSDATE(),'%Y') into @NowY;
set  @NowY =  @NowY-1;
set  @nextY =  @NowY+1;

-- 年度考核
INSERT into t181 (createrId,createDate,updateDate,c01,c02,c03,c04,c05,c06,c07,c08)
	SELECT '0',SYSDATE(),SYSDATE(),c.c04,c.c02,b.c02,b.c01,'人员年度考核表',CONCAT(b.c02,c.c04,',考核时间填写不对,考核时间不能超过[','1993,',@nextY,']范围，请复核后修改'),'考核时间填写不对',"请在'工资变动-年度考核-年度考核'中进行修改"
	from t124 a,t111 b,t126 c WHERE b.id = dwid  and c.c01 = concat(b.id,'') and a.c02=concat(b.id,'')
	 AND a.c03=concat(c.id,'') AND  (a.c01<1993 OR a.c01>@nextY OR a.c01='')
 and not exists(select 1 from sys_s_data d where d.id = c.c03 and d.typename = 'staffStatus' and d.data_value = '2')
	-- 非离休人员
; 
-- 考核结果
INSERT into t181 (createrId,createDate,updateDate,c01,c02,c03,c04,c05,c06,c07,c08)
	SELECT '0',SYSDATE(),SYSDATE(),c.c04,c.c02,b.c02,b.c01,'人员年度考核表',CONCAT(b.c02,c.c04,',请填写该人员',a.c01,'年的年度考核结果'),CONCAT('请填写该人员',a.c01,'年的年度考核结果'),"请在'工资变动-年度考核-年度考核'中进行修改" 
	from t124 a,t111 b,t126 c WHERE b.id = dwid  and c.c01 = concat(b.id,'') and a.c02=concat(b.id,'') AND a.c03=concat(c.id,'') AND  a.c05=''
 and not exists(select 1 from sys_s_data d where d.id = c.c03 and d.typename = 'staffStatus' and d.data_value = '2')
	-- 非离休人员
;

/**
select DATE_FORMAT(SYSDATE(),'%Y') into @NowY;
set  @NowY =  @NowY-1;

-- 检测出单位年度考核未填写的人员
UPDATE t126 a SET a.c25='1' WHERE a.c01=concat(dwid,'') and a.c12<concat(@NowY,'') 
 and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
	-- 非离休人员
; 
UPDATE t126 a,t124 b SET a.c25='' WHERE a.c01 = concat(dwid,'') and concat(a.id,'')=b.c03 AND a.c12<concat(@NowY,'')
 and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
	-- 非离休人员
; 
INSERT into t181 (createrId,createDate,updateDate,c01,c02,c03,c04,c05,c06,c07,c08)
	SELECT '0',SYSDATE(),SYSDATE(),c.c04,c.c02,b.c02,b.c01,'人员年度考核表',CONCAT(b.c02,c.c04,',请填写该人员从参加工作到',@NowY,'年的年度考核情况'),
	CONCAT(b.c02,c.c04,',请填写该人员从参加工作到',@NowY,'年的年度考核情况'),"请在'工资变动-变动记录查询-编辑新进人员-人员年度考核'中进行添加" 
	from t111 b,t126 c WHERE b.id = dwid and c.c01 = concat(b.id,'') AND c.c25='1'
 and not exists(select 1 from sys_s_data d where d.id = c.c03 and d.typename = 'staffStatus' and d.data_value = '2')
	-- 非离休人员
; 
UPDATE t126 a SET c25='' WHERE a.c01= concat(dwid,'') and c25='1'
 and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
	-- 非离休人员
; 
*/

-- 检测出考核结果重复的数据 让单位确认
INSERT into t181 (createrId,createDate,updateDate,c01,c02,c03,c04,c05,c06,c07,c08)
	SELECT '0',SYSDATE(),SYSDATE(),c.c04,c.c02,b.c02,b.c01,'人员年度考核表',CONCAT(b.c02,c.c04,a.c01,',年度考核结果重复'),CONCAT(a.c01,',年度考核结果重复'),"请在'工资变动-年度考核-年度考核'中进行修改"
	from t124 a,t111 b,t126 c WHERE b.id = dwid and c.c01 = concat(dwid,'') and a.c02=concat(b.id,'') AND a.c03=concat(c.id,'') AND  a.id in
	(SELECT a.id FROM t124 a,t124 b 
	WHERE a.c50=b.c50 AND  a.id>b.id)
 and not exists(select 1 from sys_s_data d where d.id = c.c03 and d.typename = 'staffStatus' and d.data_value = '2')
	-- 非离休人员
;

	UPDATE t181 a,t111 b SET a.c03=b.id WHERE b.c02=a.c03 and b.id = dwid;
	-- select count(1) into resultMsg from t181 where c03 = dwid;

END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`p_init_Gwyjbt`(IN v_unit_dataId int(11),
-- 单位id
inout resultMsg varchar(1000))
label_pro:BEGIN
	DECLARE sTemPersonJbtId int(11);-- 人员津补贴表id
	DECLARE sTemPersonId int(11);-- 人员id
	DECLARE stemNum int(11);-- 参数变量
	DECLARE stemParam varchar(20);-- 参数变量
	DECLARE stemIndex int(11);
	
	DECLARE jbtId int(11) default 25;-- 公务员规范后津补贴id
	
	DECLARE xbzsj VARCHAR(30); -- 新标准时间
	DECLARE jbtCode VARCHAR(30); -- 津补贴编号 
	
	DECLARE dwzdId VARCHAR(30); -- 单位驻地id 
	DECLARE gzdyzj VARCHAR(30); -- 工资对应职级
	DECLARE sfld VARCHAR(30); -- 是否领导
	DECLARE gzdyzjId VARCHAR(30); -- 工资对应职级Id 

	DECLARE oldJbtbzsj VARCHAR(30); -- 人员旧的津补贴标准时间
	DECLARE jbtxj Varchar(30);-- 津补贴小计
	DECLARE newJbtxj Varchar(30);-- 津补贴小计
	DECLARE gzhj VARCHAR(30); -- 工资合计
	DECLARE newGzhj VARCHAR(30); -- 工资合计

	DECLARE jbtSalary VARCHAR(30); -- 津补贴项金额
	DECLARE newJbtSalary VARCHAR(30); -- 新津补贴项金额

    DECLARE done INT DEFAULT FALSE;
    
	-- 单位所有人员
	DECLARE personJbtId_ CURSOR FOR
   SELECT t117.id from t126 join t125 on t126.id = t125.c06 join t117 on t126.id = t117.c03
		where t126.c01 = concat(v_unit_dataId,'')  
		and t117.c04 = '25' -- 人员津补贴表-津补贴编号  关联型
	  and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
	  and not exists (select 1 from sys_s_data d where d.id = t126.c43 and d.typename = 'is' and d.data_value = '1') -- 不是停发工资的人员
	  and not exists (select 1 from sys_s_data d where d.id = t125.c39 and d.typename = 'is' and d.data_value = '1') -- 不是受处分人员
	  and ifnull(t126.c46,'')=''
	;
 	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
 	
 	
 	set stemIndex = 0;
 	
 	select count(1) into stemNum 
 	from t126 join t117 on t126.id = t117.c03 
 	where t126.c01 = concat(v_unit_dataId,'')
 	and t117.c04 = concat(jbtId,'');
 	-- and ifnull(t117.c01,'') != xbzsj;-- t117.c01 津补贴工作标准时间 	
 	select c27
 	-- c27-公务员规范后津补贴标准使用驻地-码表  c20-单位艰边类别码表
	into dwzdId
 	from t111 where id = v_unit_dataId;
	
 	-- 处理新的标准时间 t123-津补贴标准表 c06
 	select c06 into xbzsj from t123 where c03 = concat(jbtId,'') and c05 = concat(dwzdId,'') order by c06 desc limit 1;-- 新标准时间

	
 	select c02 into jbtCode from t116 where id = jbtId;-- t116津补贴项目表c02-津补贴编号

	set @failMsg = 1;
-- 目前三种津补贴标准
-- JBT00025-公务员规范后津补贴 对应 单位驻地-工资对应职级
  OPEN personJbtId_;  
  -- 开始循环
  read_loop: LOOP
    -- 提取游标里的数据，这里只有一个，多个的话也一样；
    FETCH personJbtId_ INTO sTemPersonJbtId;
    -- 声明结束的时候
    IF done THEN
      LEAVE read_loop;
    END IF;
    set @done = done;
    select ifnull(c01,''),c03,c07
    into oldJbtbzsj,sTemPersonId,jbtSalary
    -- c01-津补贴时间  c03-人员编号 
    from t117 where id = sTemPersonJbtId;
    select t126.c04,
		t126.c17,
		ifnull((select d.c05 from t127 d where d.id = t126.c17),ifnull(t126.c17,'')) as gzdyzj,
		ifnull((select d.c04 from t127 d where d.id = t126.c27),ifnull(t126.c27,'')) as sfld,
		-- 工资对应职级
		t125.c27,t125.c32
		-- 津补贴小计 工资合计 工资标准时间
    	into @personName,
    	gzdyzjId,gzdyzj,sfld,
    	jbtxj,gzhj
    from t126 join t125 on t126.id = t125.c06 where t126.id = sTemPersonId;
    if ifnull(gzdyzj,'')='' then
    	if @failMsg = 1 then 
	    	set @failMsg = concat(@personName,',');
	    else
	    	set @failMsg = concat(@failMsg,@personName,',');
    	end if;
    else
	    set stemNum = 0;-- 变量为0表示 没有更新 变动>0 表示需要更新
		if sfld is null or sfld = '' then 
			set sfld = '';
		end if;
		if jbtCode = 'JBT00025' then -- 公务员规范后津补贴 对应 单位驻地-工资对应职级
			select count(1) into stemNum from t123 
			where c03 = jbtId 
			and ( select 1 from sys_s_data d where d.typename = 'locale' and d.id = t123.c05 and d.id =dwzdId order by data_value desc limit 0,1  ) 
			and c06 = xbzsj
			and exists(select 1 from t127 where t127.id = t123.c07 and t127.c05 = gzdyzj);
			if stemNum > 0 then 
				set stemNum = 1;
			end if;
			select min(c10) into newJbtSalary from t123 
			where c03 = concat(jbtId,'') 
			and ( select 1 from sys_s_data d where d.typename = 'locale' and d.id = t123.c05 and d.id = dwzdId order by data_value desc limit 0,1  ) 
			and c06 = xbzsj
			and exists(select 1 from t127 where t127.id = t123.c07 and t127.c05 = concat(gzdyzj,''))
			and if(ifnull(t123.c11,'')='',IF(IFNULL(sfld,'') = '','领导职务',sfld),t123.c11) = IF(IFNULL(sfld,'') = '','领导职务',sfld)
			 limit 1;
			-- t123 津补贴标准表 c03-津补贴编号  c05-单位驻地 码表 c06标准时间 c07-工资对应职级
	    end if;
	    if stemNum > 0 then 
	    	set @saveFlag = 0;
	    	if newJbtSalary != jbtSalary then 
	    		set @saveFlag = 1;
				update t117 set c07 = newJbtSalary,c01=xbzsj
				where id = sTemPersonJbtId;-- 更新人员津补贴表

				update data_record_t117 set c07 = newJbtSalary,c01=xbzsj
				where dataId = sTemPersonJbtId;-- 更新人员津补贴表
	    	end if;
	    	select sum(ifnull(c07+0,0)) into newJbtxj from t117 where c03 = concat(sTemPersonId,'');
	    	
	    	if newJbtxj != jbtxj then 
	    		set @saveFlag = 1;
	    	end if;
			if @saveFlag=1 then 
				

				update t125 set -- 更新人员工资信息
				c27=newJbtxj,
				c32 = ifnull(c25,0)+ifnull(c26,0) + ifnull(c28,0) + ifnull(c29,0) + ifnull(c30,0) + ifnull(c31,0)+ifnull(newJbtxj,0)+ifnull(c44,0)+ifnull(c45,0)+ifnull(c47,0) +0
				where c06 = concat(sTemPersonId,'');
				
				update data_record_t125 set -- 更新人员工资信息变动记录
				c27=newJbtxj,
				c32 = ifnull(c25,0)+ifnull(c26,0) + ifnull(c28,0) + ifnull(c29,0) + ifnull(c30,0) + ifnull(c31,0)+ifnull(newJbtxj,0)+ifnull(c44,0)+ifnull(c45,0)+ifnull(c47,0) +0
				where c06 = concat(sTemPersonId,'');
				
				set stemIndex = stemIndex+1;
			end if;
		end if;
    end if;
    set done = @done;
  END LOOP;
  -- 关闭游标

  CLOSE personJbtId_;
	if stemIndex > 0 then 
		set resultMsg = concat('成功更新[',stemIndex,']人的津补贴工资标准为',xbzsj); 
	else
		set resultMsg = concat('成功更新[',stemIndex,']人的津补贴工资标准为',xbzsj);
	end if;
	if @failMsg != 1 then 
		set resultMsg = concat(resultMsg,',失败人员情况:', @failMsg,'职级无数据');
	end if;
	leave label_pro;
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`p_init_Gwyjbt_person`(IN v_person_id varchar(60),
-- 人员编号
inout resultMsg varchar(1000))
label_pro:BEGIN
	DECLARE v_unit_dataId VARCHAR(30); -- 单位id
	DECLARE sTemPersonJbtId int(11);-- 人员津补贴表id
	DECLARE sTemPersonId int(11);-- 人员id
	DECLARE stemNum int(11);-- 参数变量
	DECLARE stemParam varchar(20);-- 参数变量
	DECLARE stemIndex int(11);
	
	DECLARE jbtId int(11) default 25;-- 公务员规范后津补贴id
	
	DECLARE xbzsj VARCHAR(30); -- 新标准时间
	DECLARE jbtCode VARCHAR(30); -- 津补贴编号 
	
	DECLARE dwzdId VARCHAR(30); -- 单位驻地id 
	DECLARE gzdyzj VARCHAR(30); -- 工资对应职级
	DECLARE sfld VARCHAR(30); -- 是否领导
	DECLARE gzdyzjId VARCHAR(30); -- 工资对应职级Id 

	DECLARE oldJbtbzsj VARCHAR(30); -- 人员旧的津补贴标准时间
	DECLARE jbtxj Varchar(30);-- 津补贴小计
	DECLARE newJbtxj Varchar(30);-- 津补贴小计
	DECLARE gzhj VARCHAR(30); -- 工资合计
	DECLARE newGzhj VARCHAR(30); -- 工资合计

	DECLARE jbtSalary VARCHAR(30); -- 津补贴项金额
	DECLARE newJbtSalary VARCHAR(30); -- 新津补贴项金额

    DECLARE done INT DEFAULT FALSE;
    
	-- 当前人员的公务员规范后津补贴
	DECLARE personJbtId_ CURSOR FOR
   SELECT t117.id from t126 join t125 on t126.id = t125.c06 join t117 on t126.id = t117.c03
		where 1=1 
		and t126.c02 = concat(v_person_id,'')  
		and t117.c04 = 25 -- 人员津补贴表-津补贴编号  关联型
	  and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
	  and not exists (select 1 from sys_s_data d where d.id = t126.c43 and d.typename = 'is' and d.data_value = '1') -- 不是停发工资的人员
	  and not exists (select 1 from sys_s_data d where d.id = t125.c39 and d.typename = 'is' and d.data_value = '1') -- 不是受处分人员
	  and ifnull(t126.c46,'')=''
	;
 	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
	
	select c27
 	-- c27-公务员规范后津补贴标准使用驻地-码表  c20-单位艰边类别码表
	into dwzdId
 	from t111 where id = v_unit_dataId;
 	
 	-- 处理新的标准时间 t123-津补贴标准表 c06
 	select c06 into xbzsj from t123 where c03 = concat(jbtId,'') and c05 = dwzdId order by c06 desc limit 1;-- 新标准时间

 	set stemIndex = 0;
 	select c01 into v_unit_dataId from t126 where c02 = concat(v_person_id,'')  limit 1;
 	
 	select count(1) into stemNum 
 	from t126 join t117 on t126.id = t117.c03 
 	where t126.c01 = v_unit_dataId
 	and t117.c04 = jbtId;
 	if stemNum = 0 then 
 		set resultMsg = concat('当前人员【',v_person_id,'】在系统没有公务员规范后津补贴项目！');leave label_pro;
 	end if;
 	if stemNum > 0 then 
 		set resultMsg = concat('当前人员【',v_person_id,'】在系统公务员规范后津补贴项目存在多条！');leave label_pro;
 	end if;
 	-- and ifnull(t117.c01,'') != xbzsj;-- t117.c01 津补贴工作标准时间 	
 	
 	select c02 into jbtCode from t116 where id = jbtId;-- t116津补贴项目表c02-津补贴编号

	set @failMsg = 1;
-- 目前三种津补贴标准
-- JBT00025-公务员规范后津补贴 对应 单位驻地-工资对应职级
  OPEN personJbtId_;  
  -- 开始循环
  read_loop: LOOP
    -- 提取游标里的数据，这里只有一个，多个的话也一样；
    FETCH personJbtId_ INTO sTemPersonJbtId;
    -- 声明结束的时候
    IF done THEN
      LEAVE read_loop;
    END IF;
    set @done = done;
    select ifnull(c01,''),c03,c07
    into oldJbtbzsj,sTemPersonId,jbtSalary
    -- c01-津补贴时间  c03-人员编号 
    from t117 where id = sTemPersonJbtId;
    select t126.c04,
		t126.c17,
		ifnull((select d.c05 from t127 d where d.id = t126.c17),ifnull(t126.c17,'')) as gzdyzj,
		ifnull((select d.c04 from t127 d where d.id = t126.c27),ifnull(t126.c27,'')) as sfld,
		-- 工资对应职级
		t125.c27,t125.c32
		-- 津补贴小计 工资合计 工资标准时间
    	into @personName,
    	gzdyzjId,gzdyzj,sfld,
    	jbtxj,gzhj
    from t126 join t125 on t126.id = t125.c06 where t126.id = sTemPersonId;
    if ifnull(gzdyzj,'')='' then
    	if @failMsg = 1 then 
	    	set @failMsg = concat(@personName,',');
	    else
	    	set @failMsg = concat(@failMsg,@personName,',');
    	end if;
    else
	    set stemNum = 0;-- 变量为0表示 没有更新 变动>0 表示需要更新
		if sfld is null or sfld = '' then 
			set sfld = '';
		end if;
		if jbtCode = 'JBT00025' then -- 公务员规范后津补贴 对应 单位驻地-工资对应职级
			select count(1) into stemNum from t123 
			where c03 = jbtId 
			and ( select 1 from sys_s_data d where d.typename = 'locale' and d.id = t123.c05 and d.id =dwzdId order by data_value desc limit 0,1  ) 
			and c06 = xbzsj
			and exists(select 1 from t127 where t127.id = t123.c07 and t127.c05 = gzdyzj);
			if stemNum > 0 then 
				set stemNum = 1;
			end if;
			select c10 into newJbtSalary from t123 
			where c03 = concat(jbtId,'') 
			and ( select 1 from sys_s_data d where d.typename = 'locale' and d.id = t123.c05 and d.id = dwzdId order by data_value desc limit 0,1  ) 
			and c06 = xbzsj
			and exists(select 1 from t127 where t127.id = t123.c07 and t127.c05 = concat(gzdyzj,''))
			and if(ifnull(t123.c11,'')='',IF(IFNULL(sfld,'') = '','领导职务',sfld),t123.c11) = IF(IFNULL(sfld,'') = '','领导职务',sfld)
			 limit 1;
			-- t123 津补贴标准表 c03-津补贴编号  c05-单位驻地 码表 c06标准时间 c07-工资对应职级
	    end if;
	    if stemNum > 0 then 
	    	set @saveFlag = 0;
	    	if newJbtSalary != jbtSalary then 
	    		set @saveFlag = 1;
				update t117 set c07 = newJbtSalary,c01=xbzsj
				where id = sTemPersonJbtId;-- 更新人员津补贴表

				update data_record_t117 
				-- update data_data_record 
				set c07 = newJbtSalary,c01=xbzsj
				where  dataclassCode = 't117' and dataId = sTemPersonJbtId;-- 更新人员津补贴表
	    	end if;
	    	select sum(ifnull(c07+0,0)) into newJbtxj from t117 where c03 = concat(sTemPersonId,'');
	    	
	    	if newJbtxj != jbtxj then 
	    		set @saveFlag = 1;
	    	end if;
			if @saveFlag=1 then 
				

				update t125 set -- 更新人员工资信息
				c27=newJbtxj,
				c32 = ifnull(c25,0)+ifnull(c26,0) + ifnull(c28,0) + ifnull(c29,0) + ifnull(c30,0) + ifnull(c31,0)+ifnull(newJbtxj,0)+ifnull(c44,0)+ifnull(c45,0)+ifnull(c47,0) +0
				where c06 = concat(sTemPersonId,'');
				
				update data_record_t125 set -- 更新人员工资信息变动记录
				-- update data_data_record set -- 更新人员工资信息变动记录
				c27=newJbtxj,
				c32 = ifnull(c25,0)+ifnull(c26,0) + ifnull(c28,0) + ifnull(c29,0) + ifnull(c30,0) + ifnull(c31,0)+ifnull(newJbtxj,0)+ifnull(c44,0)+ifnull(c45,0)+ifnull(c47,0) +0
				where dataclassCode = 't125' and c06 = concat(sTemPersonId,'');
				
				set stemIndex = stemIndex+1;
			end if;
		end if;
    end if;
    set done = @done;
  END LOOP;
  -- 关闭游标

  CLOSE personJbtId_;
	if stemIndex > 0 then 
		set resultMsg = concat('成功更新[',stemIndex,']人的津补贴工资标准为',xbzsj); 
	else
		set resultMsg = concat('成功更新[',stemIndex,']人的津补贴工资标准为',xbzsj);
	end if;
	if @failMsg != 1 then 
		set resultMsg = concat(resultMsg,',失败人员情况:', @failMsg,'职级无数据');
	end if;
	leave label_pro;
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`p_init_Jbgz`(IN v_unit_dataId int(11),
-- 单位id
inout resultMsg varchar(1000))
label_pro:BEGIN 
	DECLARE sTemPersonId int(11);-- 人员id
	DECLARE personName varchar(20);-- 人员名称
	DECLARE stemNum int(11);-- 参数变量
	DECLARE stemParam varchar(20);-- 参数变量
	DECLARE stemIndex int(11);
	 
	
	DECLARE xbzsj VARCHAR(30); -- 新标准时间  
	 
	DECLARE rysf VARCHAR(30); -- 人员身份
	DECLARE gzdyzj VARCHAR(30); -- 工资对应职级
	DECLARE sfld VARCHAR(30); -- 是否领导 
	DECLARE xl VARCHAR(30); -- 学历
 
	DECLARE dc Varchar(30);-- 档次 
	DECLARE zwgz Varchar(30);-- 职务工资
	DECLARE newZwgz Varchar(30);-- 新的职务工资
	DECLARE gzhj VARCHAR(30); -- 工资合计
	DECLARE newGzhj VARCHAR(30); -- 工资合计 

    DECLARE done INT DEFAULT FALSE;
    
	-- 单位人员
	DECLARE personId_ CURSOR FOR
   SELECT t126.id 	from t126 ,t125
		where t126.c01 = concat(v_unit_dataId,'')
		and t126.id = t125.c06
		and (
			ifnull(t125.c25,'')='' -- 职务工资为空的数据 	
			or t125.c25 = t125.c26 -- 职务工资与级别工资相同的数据
		)
	  and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
	  and not exists (select 1 from sys_s_data d where d.id = t126.c43 and d.typename = 'is' and d.data_value = '1') -- 不是停发工资的人员
	  and not exists (select 1 from sys_s_data d where d.id = t125.c39 and d.typename = 'is' and d.data_value = '1') -- 不是受处分人员
	  and ifnull(t126.c46,'')=''
	;
 	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;

 	set stemIndex = 0;

	set @failMsg = 1; 
  OPEN personId_;  
  -- 开始循环
  read_loop: LOOP
    -- 提取游标里的数据，这里只有一个，多个的话也一样；
    FETCH personId_ INTO sTemPersonId;
    -- 声明结束的时候
    IF done THEN
      LEAVE read_loop;
    END IF;
    set @done = done; 
    select t126.c04,
		-- t126.c17,
		ifnull((select d.c05 from t127 d where d.id = t126.c17),ifnull(t126.c17,'')) as gzdyzj,
		-- 工资对应职级
		ifnull((select d.c04 from t127 d where d.id = t126.c27),ifnull(t126.c27,'')) as sfld,
		-- 是否领导
		ifnull((select d.name from sys_s_data d where d.id = t126.c09),ifnull(t126.c09,'')) as xl,
		-- 学历
		ifnull((select d.name from sys_s_data d where d.id = t126.c28),ifnull(t126.c28,'')) as rysf,
		-- 人员身份
		ifnull((select d.c04 from t127 d where d.id = t125.c09),ifnull(t125.c09,'')) as dc,
		-- 档次 
		ifnull(t125.c25,0) as zwgz,t125.c32
		-- 职务工资 工资合计  
    	into personName,
    	-- gzdyzjId,
    	gzdyzj,sfld,xl,rysf,
    	dc,
    	zwgz,gzhj
    from t126 join t125 on t126.id = t125.c06 where t126.id = sTemPersonId limit 1;
    if ifnull(gzdyzj,'')='' then
    	if @failMsg = 1 then 
	    	set @failMsg = concat(personName,',');
	    else
	    	set @failMsg = concat(@failMsg,personName,',');
    	end if;
    else
	    set stemNum = 0;-- 变量为0表示 没有更新 变动>0 表示需要更新
		if sfld is null or sfld = '' then 
			set sfld = '';
		end if;
		if position('期' in gzdyzj)>0 then -- 试用期
			select c06 into newZwgz from t127 where c05 = gzdyzj and c04 = xl order by c01 desc limit 1;
		else
			if position('工人' in rysf)>0 then -- 工人
				if position('机关' in rysf)>0 then 
					select c06 into newZwgz from t127 where c05 = gzdyzj
					and c03 = '技术等级工资'
					and c08 = (select id from sys_s_data d where d.typename = 'gzbzlb' and name = '机关工勤人员')
					order by c01 desc limit 1;
				else
					select c06 into newZwgz from t127 where c05 = gzdyzj
					and c03 = '岗位工资'
					and c08 = (select id from sys_s_data d where d.typename = 'gzbzlb' and name = '事业工勤人员')
					 order by c01 desc limit 1;
				end if;
			end if;
		end if;
		if newZwgz > 0 then 
			set stemNum = 1;
		end if;
		if stemNum> 0 then 
			update t125 set -- 更新人员工资信息
			c25=newZwgz,
			c32 = ifnull(newZwgz,0)+ifnull(c26,0) + ifnull(c28,0) + ifnull(c29,0) + ifnull(c30,0) + ifnull(c31,0)+ifnull(c27,0)+ifnull(c44,0)+ifnull(c45,0)+ifnull(c47,0) +0
			where c06 = concat(sTemPersonId,'');
			
			update data_record_t125 set -- 更新人员工资信息变动记录
			c25=newZwgz,
			c32 = ifnull(newZwgz,0)+ifnull(c26,0) + ifnull(c28,0) + ifnull(c29,0) + ifnull(c30,0) + ifnull(c31,0)+ifnull(c27,0)+ifnull(c44,0)+ifnull(c45,0)+ifnull(c47,0) +0
			where -- dataclassCode = 't125' and
			 c06 = concat(sTemPersonId,'');
			
			set stemIndex = stemIndex+1;
		end if;
    end if;
    set done = @done;
  END LOOP;
  -- 关闭游标
  CLOSE personId_;
	if stemIndex > 0 then 
		set resultMsg = concat('成功更新[',stemIndex,']人的基本工资'); 
	else
		set resultMsg = concat('成功更新[',stemIndex,']人的基本工资'); 
	end if;
	if @failMsg != 1 then 
		set resultMsg = concat(resultMsg,',失败人员情况:', @failMsg,'职级无数据');
	end if;
	leave label_pro;
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`p_init_Jkbyjt`(IN v_unit_dataId int(11),
-- p_init_Jkbyjt艰苦边远地区津贴读取标准
-- 单位id
inout resultMsg varchar(1000))
label_pro:BEGIN
	DECLARE sTemPersonJbtId int(11);-- 人员津补贴表id
	DECLARE sTemPersonId int(11);-- 人员id
	DECLARE stemNum int(11);-- 参数变量
	DECLARE stemParam varchar(20);-- 参数变量
	DECLARE stemIndex int(11);
	
	DECLARE jbtId int(11) default 5;-- 艰苦边远地区津贴id
	
	DECLARE xbzsj VARCHAR(30); -- 新标准时间
	DECLARE jbtCode VARCHAR(30); -- 津补贴编号 
	
	DECLARE dwzdId VARCHAR(30); -- 单位驻地id 
	DECLARE dwjblbId VARCHAR(30); -- 单位艰边类别
	DECLARE gzdyzj VARCHAR(30); -- 工资对应职级
	DECLARE sfld VARCHAR(30); -- 是否领导
	DECLARE gzdyzjId VARCHAR(30); -- 工资对应职级Id 

	DECLARE oldJbtbzsj VARCHAR(30); -- 人员旧的津补贴标准时间
	DECLARE jbtxj Varchar(30);-- 津补贴小计
	DECLARE newJbtxj Varchar(30);-- 津补贴小计
	DECLARE gzhj VARCHAR(30); -- 工资合计
	DECLARE newGzhj VARCHAR(30); -- 工资合计

	DECLARE jbtSalary VARCHAR(30); -- 津补贴项金额
	DECLARE newJbtSalary VARCHAR(30); -- 新津补贴项金额

    DECLARE done INT DEFAULT FALSE;
    
	-- 单位所有人员
	DECLARE personJbtId_ CURSOR FOR
   SELECT t117.id from t126 join t125 on t126.id = t125.c06 join t117 on t126.id = t117.c03
		where 1=1 
		and t126.c01 = concat(v_unit_dataId,'')  
		and t117.c04 = 5 -- 人员津补贴表-津补贴编号  关联型
	  and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
	  and not exists (select 1 from sys_s_data d where d.id = t126.c43 and d.typename = 'is' and d.data_value = '1') -- 不是停发工资的人员
	  and not exists (select 1 from sys_s_data d where d.id = t125.c39 and d.typename = 'is' and d.data_value = '1') -- 不是受处分人员
	  and ifnull(t126.c46,'')=''
	;
 	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
	
 	-- 处理新的标准时间 t123-津补贴标准表 c06
 	-- select c06 into xbzsj from t123 where c03 = jbtId order by c06 desc limit 1;-- 新标准时间

 	set stemIndex = 0;
 	
 	select count(1) into stemNum 
 	from t126 join t117 on t126.id = t117.c03 
 	where t126.c01 = concat(v_unit_dataId,'')
 	and t117.c04 = concat(jbtId,'');
 	-- and ifnull(t117.c01,'') != xbzsj;-- t117.c01 津补贴工作标准时间 	
 	select c27,c20
 	-- c27-公务员规范后津补贴标准使用驻地-码表  c20-单位艰边类别码表
	into dwzdId,dwjblbId
 	from t111 where id = v_unit_dataId;
	
 	select c02 into jbtCode from t116 where id = jbtId;-- t116津补贴项目表c02-津补贴编号

	set @failMsg = 1;
-- 目前三种津补贴标准
-- JBT00025-公务员规范后津补贴 对应 单位驻地-工资对应职级
  OPEN personJbtId_;  
  -- 开始循环
  read_loop: LOOP
    -- 提取游标里的数据，这里只有一个，多个的话也一样；
    FETCH personJbtId_ INTO sTemPersonJbtId;
    -- 声明结束的时候
    IF done THEN
      LEAVE read_loop;
    END IF;
    set @done = done;
    select ifnull(c01,''),c03,c07
    into oldJbtbzsj,sTemPersonId,jbtSalary
    -- c01-津补贴时间  c03-人员编号 
    from t117 where id = sTemPersonJbtId;
    select t126.c04,
		t126.c17,
		ifnull((select d.c05 from t127 d where d.id = t126.c17),ifnull(t126.c17,'')) as gzdyzj,
		ifnull((select d.c04 from t127 d where d.id = t126.c27),ifnull(t126.c27,'')) as sfld,
		-- 工资对应职级
		t125.c27,t125.c32
		-- 津补贴小计 工资合计 工资标准时间
    	into @personName,
    	gzdyzjId,gzdyzj,sfld,
    	jbtxj,gzhj
    from t126 join t125 on t126.id = t125.c06 where t126.id = sTemPersonId;
    if ifnull(gzdyzj,'')='' then
    	if @failMsg = 1 then 
	    	set @failMsg = concat(@personName,',');
	    else
	    	set @failMsg = concat(@failMsg,@personName,',');
    	end if;
    else
	    set stemNum = 0;-- 变量为0表示 没有更新 变动>0 表示需要更新
		if sfld is null or sfld = '' then 
			set sfld = '';
		end if;
		if jbtCode = 'JBT00005' then -- 艰苦边远地区津贴对应 艰边类别-工资对应职级
			select count(1) into stemNum from t123 
				where c03 = jbtId and c09 = dwjblbId 
				and exists(select 1 from t127 where t127.id = t123.c07 and t127.c05 = gzdyzj)
				;
				if stemNum > 0 then 
					set stemNum = 1;
				end if;
				select c10,c06 into newJbtSalary,xbzsj from t123 
				where c03 = jbtId and c09 = dwjblbId 
				and exists(select 1 from t127 where t127.id = t123.c07 and t127.c05 = gzdyzj)
				order by c06 desc 
				limit 1;
			-- t123 津补贴标准表 c03-津补贴编号  c09-单位艰边类别 码表 c06标准时间 c07-工资对应职级
	    end if;
	    if stemNum > 0 then 
	    	set @saveFlag = 0;
	    	if newJbtSalary != jbtSalary then 
	    		set @saveFlag = 1;
				update t117 set c07 = newJbtSalary,c01=xbzsj
				where id = sTemPersonJbtId;-- 更新人员津补贴表

				update data_record_t117 set c07 = newJbtSalary,c01=xbzsj
				where  dataclassCode = 't117' and dataId = sTemPersonJbtId;-- 更新人员津补贴表
	    	end if;
	    	select sum(ifnull(c07+0,0)) into newJbtxj from t117 where c03 = sTemPersonId;
	    	
	    	if newJbtxj != jbtxj then 
	    		set @saveFlag = 1;
	    	end if;
			if @saveFlag=1 then			

				update t125 set -- 更新人员工资信息
				c27=newJbtxj,
				c32 = ifnull(c25,0)+ifnull(c26,0) + ifnull(c28,0) + ifnull(c29,0) + ifnull(c30,0) + ifnull(c31,0)+ifnull(newJbtxj,0)+ifnull(c44,0)+ifnull(c45,0)+ifnull(c47,0) +0
				where c06 = concat(sTemPersonId,'');
				
				update data_record_t125 set -- 更新人员工资信息变动记录
				c27=newJbtxj,
				c32 = ifnull(c25,0)+ifnull(c26,0) + ifnull(c28,0) + ifnull(c29,0) + ifnull(c30,0) + ifnull(c31,0)+ifnull(newJbtxj,0)+ifnull(c44,0)+ifnull(c45,0)+ifnull(c47,0) +0
				where -- dataclassCode = 't125' and 
				c06 = concat(sTemPersonId,'');
				
				set stemIndex = stemIndex+1;
			end if;
		end if;
    end if;
    set done = @done;
  END LOOP;
  -- 关闭游标
  CLOSE personJbtId_;
	if stemIndex > 0 then 
		set resultMsg = concat('成功更新[',stemIndex,']人的津补贴工资标准为',xbzsj); 
	else
		set resultMsg = concat('成功更新[',stemIndex,']人的津补贴工资标准为',xbzsj);
	end if;
	if @failMsg != 1 then 
		set resultMsg = concat(resultMsg,',失败人员情况:', @failMsg,'职级无数据');
	end if;
	leave label_pro;
END;

CREATE DEFINER = `root`@`localhost` PROCEDURE `smso-migration-v2`.`p_init_person_gzbzsj`(IN v_unit_dataId varchar(200),
INOUT resultMsg varchar(1000) CHARSET utf8)
label_pro:BEGIN	
-- 根据人员身份职级决定人员的工资标准时间
	update t125 ,t126
	set t125.c49 = (select c01 from t127 where t127.c08 = t126.c39 order by c01 desc limit 1 )
	where t126.id = t125.c06 and t126.c01 = concat(v_unit_dataId,'');
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`p_init_record_ds`(IN v_unit_id varchar(50) ,
INOUT resultMsg varchar(10000) CHARSET utf8)
label_pro:BEGIN	
	declare numIndex int(11) default 0 ;
	declare v_unit_data_name varchar(20)  ;-- 单位名称
	declare v_unit_dataId varchar(20)  ; -- 单位id

	DECLARE sTemPersonId int(11);
	DECLARE sTemT125Id int(11);
	
    DECLARE done INT DEFAULT FALSE;
	DECLARE personId_ CURSOR FOR
   	SELECT t126.id from t126,t111  where 1=1 and t126.c01 = t111.id and t111.c01 = v_unit_id 
	;-- 查询此单位下面所有人员
 	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
	set resultMsg = '';
	select count(1) into @c from t111 where c01 = v_unit_id; -- 获取单位id
	if @c = 0 then
		set resultMsg = concat('当前单位账号',v_unit_id,'系统不存在!');
		leave label_pro;
	end if;
	select id,c02 into v_unit_dataId,v_unit_data_name from t111 where c01 = v_unit_id;
	select count(1) into @c from ds_t3_c where dwmc = v_unit_data_name or dwmc = concat(v_unit_dataId,'');
	if @c = 0 then 
		set resultMsg = concat('当前单位',v_unit_data_name,'不存在人员工资信息!');
		leave label_pro;
	end if;
	
  OPEN personId_;  
  -- 开始循环
  read_loop: LOOP
    -- 提取游标里的数据，这里只有一个，多个的话也一样；
    FETCH personId_ INTO sTemPersonId;
    -- 声明结束的时候
    IF done THEN
      LEAVE read_loop;
    END IF;
	set @doneF = done;
	select id into sTemT125Id from t125 where c06 = sTemPersonId; 
	select count(1) into @c from data_data_record_history where dataclassCode = 't126' and dataId = sTemPersonId;
	if @c = 0 then 
		set @chanSign = concat('jxtsj',UNIX_TIMESTAMP(),'11412','t126',sTemPersonId);
		insert into data_data_record_history (dataId,dataclassCode,createrId,createDate,updaterId,updateDate,unitId,
	 				c01,c02,c03,c04,c05,c06,c07,c08,c09,c10,c11,c12,c13,c14,c15,c16,c17,c18,c19,c20,
	 				c21,c22,c23,c24,c25,c26,c27,c28,c29,c30,c31,c32,c33,c34,c35,c36,c37,c38,c39,c40,
	 				c41,c42,c43,c44,c45,c46,c47,c48,c49,c50,operateTime,operateId,operateType,
	 				changeSign,changeType)
		select distinct t126.id,dataclassCode,createrId,createDate,updaterId,updateDate,unitId,
	 				c01,c02,c03,c04,c05,c06,c07,c08,c09,c10,c11,c12,c13,c14,c15,c16,c17,c18,c19,c20,
	 				c21,c22,c23,c24,c25,c26,c27,c28,'旧系统数据导入',c30,c31,c32,c33,c34,c35,c36,c37,c38,c39,c40,
	 				c41,c42,c43,c44,c45,c46,c47,c48,c49,c50,sysdate(),1,1,
	 				concat(@chanSign,qxsj,c.gzhj),'11412'
		from t126 ,ds_t3_c c -- 人员基本信息表数据
		where t126.id = sTemPersonId
		and t126.id = c.xm;
		insert into data_data_record_history (dataId,dataclassCode,createrId,createDate,updaterId,updateDate,unitId,
	 				c01,c02,c03,c04,c05,c06,c07,c08,c09,c10,c11,c12,c13,c14,c15,c16,c17,c18,c19,c20,
	 				c21,c22,c23,c24,c25,c26,c27,c28,c29,c30,c31,c32,c33,c34,c35,c36,c37,c38,c39,c40,
	 				c41,c42,c43,c44,c45,c46,c47,c48,c49,c50,operateTime,operateId,operateType,
	 				changeSign,changeType)
		select distinct sTemT125Id,'t125',createrId,createDate,updaterId,updateDate,unitId,
	 				'',qxsj,'','',v_unit_dataId,t126.id,gzjb,jbqknf,jbdc,jbdcqknf,yhgdjb,gdjbyj,yhddjb,ddjbyj,yhgddc,gddcyj,yhfddc,fddcyj,yhgddc_gu,gddcyj_gu,
	 				yhdddc,dddcyj,sftg10gz,'',zwgz,jbgz,jbtxj,zxxjshhstg10,tsjytg15,blytsgwhgzbl,jxgzxj,gzhj,t126.id,'旧系统数据导入',sftsjy,(select c36 from t125 where id = sTemT125Id),jx,c38,c39,c40,
	 				c41,c42,c43,c44,c45,c46,c47,c48,c49,c50,sysdate(),1,1,
	 				concat(@chanSign,qxsj,c.gzhj),'11412'
		from t126,ds_t3_c c -- 人员工资信息表数据
		where t126.id = sTemPersonId 
		and t126.id = c.xm;
		/**
		select group_concat(distinct changeSign) into @chanSign from data_data_record_history where changeSign in (
		 select changeSign
		from data_data_record_history
		 group by changeSign having count(1) > 2);
		 */
	end if;
	
	set done = @doneF;
  END LOOP;
  -- 关闭游标
  CLOSE personId_;
	
commit;
end;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`p_init_sz_gwyJbtBz`(IN dwzd varchar(20),INOUT resultMsg varchar(1000))
label_pro:BEGIN
	#Routine body goes here...
 -- 各市州公务员规范后津补贴标准初始化
 -- dwzd 单位驻地 (市级 汉字)  
	DECLARE dwzd_id int(11);-- -- 单位驻地id
	DECLARE stemNum int(11);-- -- 变量
	DECLARE parentId int(11);-- -- 单位驻地上级id
	DECLARE parentName varchar(20);-- -- 单位驻地上级
	DECLARE done INT DEFAULT FALSE; -- 自定义控制游标循环变量,默认false  
-- 查询当前市州下属区县
	DECLARE My_Cursor CURSOR FOR (
		select id  from sys_s_data a where 
			exists(select 1 from sys_s_data d where a.id = d.id and d.name = dwzd and d.typename = 'locale' )
			or exists(select 1 from sys_s_data d where a.parent_value = d.id and  d.name = dwzd and d.typename = 'locale') 
	);
	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE; 
-- 绑定控制变量到游标,游标循环结束自动转true  

	select parent_value into parentId from sys_s_data where  typename = 'locale' and name = dwzd;
	select name into parentName from sys_s_data where id = parentId; 
	if parentName != '四川省' then 
		set resultMsg = concat('当前驻地[',dwzd,']不是市级驻地');
		leave label_pro;
	end if;
	
	OPEN My_Cursor; -- 打开游标  
  myLoop: LOOP -- 开始循环体,myLoop为自定义循环名,结束循环时用到  
    FETCH My_Cursor into dwzd_id; 
    IF done THEN -- 判断是否继续循环  
      LEAVE myLoop; -- 结束循环  
    END IF; 
    		select count(1) into @stemNum from jbtbz_sz where dwzd_bz = dwzd_id;
    		if @stemNum > 0 then -- 如果存在
    			-- delete from t123 where c05 = dwzd_id and c06 = '2016-07-01';
    			delete from t123 where c05 = dwzd_id and c06 = '2016-07-01' 
    			and c07 not in (select id from t127 where c05 like '%股级%'); -- 股级
				select parent_value into parentId from sys_s_data where id = dwzd_id;
				select name into parentName from sys_s_data where id = parentId; 
				-- 正厅级(厅局级正职)

				if dwzd = '成都市' then -- 副省级
					select count(1) into stemNum from jbtbz_sz 
					where dwzd_bz = dwzd_id and fsj != '';		
					if stemNum > 0 then 
						insert into t123 (createrId,createDate,updaterId,updateDate,dataclassCode,unitId,
						c06,c01,c05,c03,c04,
						-- c06 标准时间 , c01 依据文号,c05 单位驻地(码表) ,c03-津补贴编号(关联型),c04-津补贴名称(关联型)
						c07,c10,c11,c09,c08)
						-- c07-工资对应职级(关联型) c10-标准金额 c11-领导职务  c09-艰边类别 c08-衔级					
						select 1,SYSDATE(),1,SYSDATE(),'t123',0,
						'2016-07-01' as bzsj,'' as yjwh,dwzd_bz as dwzd,'JBT00025' as jbtCode,'公务员规范后津补贴' as jbtName,
						-- c06 标准时间 , c01 依据文号,c05 单位驻地(码表) ,c03-津补贴编号(关联型),c04-津补贴名称(关联型)
						 '省部级副职' as gzdyzj,fsj as je ,'' as ldzw,'' as jblb,'' xj
						-- c07-工资对应职级(关联型) c10-标准金额 c11-领导职务 
						from jbtbz_sz  where dwzd_bz = dwzd_id;		
					end if;
				end if;

				if parentName = '四川省' then -- 市级单位 才有正厅级
					select count(1) into stemNum from jbtbz_sz 
					where dwzd_bz = dwzd_id and ztjfld != '';		
/**
				 select '2016-07-01' as bzsj,'' as yjwh,dwzd_bz as dwzd,'JBT00025' as jbtCode,'公务员规范后津补贴' as jbtName,
					-- c06 标准时间 , c01 依据文号,c05 单位驻地(码表) ,c03-津补贴编号(关联型),c04-津补贴名称(关联型)
					 '厅局级正职' as gzdyzj,ztjld as je ,(case stemNum when 0 then '领导职务' else ''  end )as ldzw
					-- c07-工资对应职级(关联型) c10-标准金额 c11-领导职务
					into @bzsj,@yjwh,@dwzd,@jbtCode,@jbtName,@gzdyzj,@je,@ldzw
					from jbtbz_sz  where dwzd_bz = dwzd_id; 
*/
					insert into t123 (createrId,createDate,updaterId,updateDate,dataclassCode,unitId,
					c06,c01,c05,c03,c04,
					-- c06 标准时间 , c01 依据文号,c05 单位驻地(码表) ,c03-津补贴编号(关联型),c04-津补贴名称(关联型)
					c07,c10,c11,c09,c08)
					-- c07-工资对应职级(关联型) c10-标准金额 c11-领导职务  c09-艰边类别 c08-衔级					
					select 1,SYSDATE(),1,SYSDATE(),'t123',0,
					'2016-07-01' as bzsj,'' as yjwh,dwzd_bz as dwzd,'JBT00025' as jbtCode,'公务员规范后津补贴' as jbtName,
					-- c06 标准时间 , c01 依据文号,c05 单位驻地(码表) ,c03-津补贴编号(关联型),c04-津补贴名称(关联型)
					 '厅局级正职' as gzdyzj,ztjld as je ,(case stemNum when 0 then '' else '领导职务' end ) as ldzw,'' as jblb,'' xj
					-- c07-工资对应职级(关联型) c10-标准金额 c11-领导职务 
					from jbtbz_sz  where dwzd_bz = dwzd_id; 
					if stemNum > 0 then -- 存在非领导职务							
							insert into t123 (createrId,createDate,updaterId,updateDate,dataclassCode,unitId,
							c06,c01,c05,c03,c04,
							-- c06 标准时间 , c01 依据文号,c05 单位驻地(码表) ,c03-津补贴编号(关联型),c04-津补贴名称(关联型)
							c07,c10,c11,c09,c08)
							-- c07-工资对应职级(关联型) c10-标准金额 c11-领导职务  c09-艰边类别 c08-衔级					
							select 1,SYSDATE(),1,SYSDATE(),'t123',0,
							'2016-07-01' as bzsj,'' as yjwh,dwzd_bz as dwzd,'JBT00025' as jbtCode,'公务员规范后津补贴' as jbtName,
							-- c06 标准时间 , c01 依据文号,c05 单位驻地(码表) ,c03-津补贴编号(关联型),c04-津补贴名称(关联型)
							 '厅局级正职' as gzdyzj,ztjfld as je ,'非领导职务' as ldzw,'' as jblb,'' xj
							-- c07-工资对应职级(关联型) c10-标准金额 c11-领导职务 
							from jbtbz_sz  where dwzd_bz = dwzd_id; 
					end if;
				end if;
				
				-- 副厅级(厅局级副职)
				select count(1) into stemNum from jbtbz_sz 
					where dwzd_bz = dwzd_id and ftjfld != '';
							
				insert into t123 (createrId,createDate,updaterId,updateDate,dataclassCode,unitId,
				c06,c01,c05,c03,c04,
				-- c06 标准时间 , c01 依据文号,c05 单位驻地(码表) ,c03-津补贴编号(关联型),c04-津补贴名称(关联型)
				c07,c10,c11,c09,c08)
				-- c07-工资对应职级(关联型) c10-标准金额 c11-领导职务  c09-艰边类别 c08-衔级					
				select 1,SYSDATE(),1,SYSDATE(),'t123',0,
				'2016-07-01' as bzsj,'' as yjwh,dwzd_bz as dwzd,'JBT00025' as jbtCode,'公务员规范后津补贴' as jbtName,
				-- c06 标准时间 , c01 依据文号,c05 单位驻地(码表) ,c03-津补贴编号(关联型),c04-津补贴名称(关联型)
				 '厅局级副职' as gzdyzj,ftjld as je ,(case stemNum when 0 then '' else '领导职务' end ) as ldzw,'' as jblb,'' xj
				-- c07-工资对应职级(关联型) c10-标准金额 c11-领导职务 
				from jbtbz_sz  where dwzd_bz = dwzd_id and ftjld != '';
				if stemNum > 0 then -- 存在非领导职务	
					select count(1) into stemNum from jbtbz_sz 
					where dwzd_bz = dwzd_id and ftjld != '';	-- 如果存在领导职务
										
					insert into t123 (createrId,createDate,updaterId,updateDate,dataclassCode,unitId,
					c06,c01,c05,c03,c04,
					-- c06 标准时间 , c01 依据文号,c05 单位驻地(码表) ,c03-津补贴编号(关联型),c04-津补贴名称(关联型)
					c07,c10,c11,c09,c08)
					-- c07-工资对应职级(关联型) c10-标准金额 c11-领导职务  c09-艰边类别 c08-衔级					
					select 1,SYSDATE(),1,SYSDATE(),'t123',0,
					'2016-07-01' as bzsj,'' as yjwh,dwzd_bz as dwzd,'JBT00025' as jbtCode,'公务员规范后津补贴' as jbtName,
					-- c06 标准时间 , c01 依据文号,c05 单位驻地(码表) ,c03-津补贴编号(关联型),c04-津补贴名称(关联型)
					 '厅局级副职' as gzdyzj,ftjfld as je ,(case stemNum when 0 then '' else '非领导职务' end ) as ldzw,'' as jblb,'' xj
					-- c07-工资对应职级(关联型) c10-标准金额 c11-领导职务 
					from jbtbz_sz  where dwzd_bz = dwzd_id; 
				end if;
				
				-- 正处级(县处级正职)
				select count(1) into stemNum from jbtbz_sz 
					where dwzd_bz = dwzd_id and zcjfld != '';
							
				insert into t123 (createrId,createDate,updaterId,updateDate,dataclassCode,unitId,
				c06,c01,c05,c03,c04,
				-- c06 标准时间 , c01 依据文号,c05 单位驻地(码表) ,c03-津补贴编号(关联型),c04-津补贴名称(关联型)
				c07,c10,c11,c09,c08)
				-- c07-工资对应职级(关联型) c10-标准金额 c11-领导职务  c09-艰边类别 c08-衔级					
				select 1,SYSDATE(),1,SYSDATE(),'t123',0,
				'2016-07-01' as bzsj,'' as yjwh,dwzd_bz as dwzd,'JBT00025' as jbtCode,'公务员规范后津补贴' as jbtName,
				-- c06 标准时间 , c01 依据文号,c05 单位驻地(码表) ,c03-津补贴编号(关联型),c04-津补贴名称(关联型)
				 '县处级正职' as gzdyzj,zcjld as je ,(case stemNum when 0 then '' else '领导职务' end ) as ldzw,'' as jblb,'' xj
				-- c07-工资对应职级(关联型) c10-标准金额 c11-领导职务 
				from jbtbz_sz  where dwzd_bz = dwzd_id and zcjld != '';
				if stemNum > 0 then -- 存在非领导职务	
					select count(1) into stemNum from jbtbz_sz 
					where dwzd_bz = dwzd_id and zcjld != '';	-- 如果存在领导职务
										
					insert into t123 (createrId,createDate,updaterId,updateDate,dataclassCode,unitId,
					c06,c01,c05,c03,c04,
					-- c06 标准时间 , c01 依据文号,c05 单位驻地(码表) ,c03-津补贴编号(关联型),c04-津补贴名称(关联型)
					c07,c10,c11,c09,c08)
					-- c07-工资对应职级(关联型) c10-标准金额 c11-领导职务  c09-艰边类别 c08-衔级					
					select 1,SYSDATE(),1,SYSDATE(),'t123',0,
					'2016-07-01' as bzsj,'' as yjwh,dwzd_bz as dwzd,'JBT00025' as jbtCode,'公务员规范后津补贴' as jbtName,
					-- c06 标准时间 , c01 依据文号,c05 单位驻地(码表) ,c03-津补贴编号(关联型),c04-津补贴名称(关联型)
					 '县处级正职' as gzdyzj,zcjfld as je ,(case stemNum when 0 then '' else '非领导职务' end ) as ldzw,'' as jblb,'' xj
					-- c07-工资对应职级(关联型) c10-标准金额 c11-领导职务 
					from jbtbz_sz  where dwzd_bz = dwzd_id; 
				end if;
				
				-- 副处级(县处级副职)
				select count(1) into stemNum from jbtbz_sz 
					where dwzd_bz = dwzd_id and fcjfld != '';
							
				insert into t123 (createrId,createDate,updaterId,updateDate,dataclassCode,unitId,
				c06,c01,c05,c03,c04,
				-- c06 标准时间 , c01 依据文号,c05 单位驻地(码表) ,c03-津补贴编号(关联型),c04-津补贴名称(关联型)
				c07,c10,c11,c09,c08)
				-- c07-工资对应职级(关联型) c10-标准金额 c11-领导职务  c09-艰边类别 c08-衔级					
				select 1,SYSDATE(),1,SYSDATE(),'t123',0,
				'2016-07-01' as bzsj,'' as yjwh,dwzd_bz as dwzd,'JBT00025' as jbtCode,'公务员规范后津补贴' as jbtName,
				-- c06 标准时间 , c01 依据文号,c05 单位驻地(码表) ,c03-津补贴编号(关联型),c04-津补贴名称(关联型)
				 '县处级副职' as gzdyzj,fcjld as je ,(case stemNum when 0 then '' else '领导职务' end ) as ldzw,'' as jblb,'' xj
				-- c07-工资对应职级(关联型) c10-标准金额 c11-领导职务 
				from jbtbz_sz  where dwzd_bz = dwzd_id and fcjld != '';
				if stemNum > 0 then -- 存在非领导职务	
					select count(1) into stemNum from jbtbz_sz 
					where dwzd_bz = dwzd_id and fcjld != '';	-- 如果存在领导职务
										
					insert into t123 (createrId,createDate,updaterId,updateDate,dataclassCode,unitId,
					c06,c01,c05,c03,c04,
					-- c06 标准时间 , c01 依据文号,c05 单位驻地(码表) ,c03-津补贴编号(关联型),c04-津补贴名称(关联型)
					c07,c10,c11,c09,c08)
					-- c07-工资对应职级(关联型) c10-标准金额 c11-领导职务  c09-艰边类别 c08-衔级					
					select 1,SYSDATE(),1,SYSDATE(),'t123',0,
					'2016-07-01' as bzsj,'' as yjwh,dwzd_bz as dwzd,'JBT00025' as jbtCode,'公务员规范后津补贴' as jbtName,
					-- c06 标准时间 , c01 依据文号,c05 单位驻地(码表) ,c03-津补贴编号(关联型),c04-津补贴名称(关联型)
					 '县处级副职' as gzdyzj,fcjfld as je ,(case stemNum when 0 then '' else '非领导职务' end ) as ldzw,'' as jblb,'' xj
					-- c07-工资对应职级(关联型) c10-标准金额 c11-领导职务 
					from jbtbz_sz  where dwzd_bz = dwzd_id; 
				end if;
				
				-- 正科级(乡科级正职)
				select count(1) into stemNum from jbtbz_sz 
					where dwzd_bz = dwzd_id and zkjfld != '';
							
				insert into t123 (createrId,createDate,updaterId,updateDate,dataclassCode,unitId,
				c06,c01,c05,c03,c04,
				-- c06 标准时间 , c01 依据文号,c05 单位驻地(码表) ,c03-津补贴编号(关联型),c04-津补贴名称(关联型)
				c07,c10,c11,c09,c08)
				-- c07-工资对应职级(关联型) c10-标准金额 c11-领导职务  c09-艰边类别 c08-衔级					
				select 1,SYSDATE(),1,SYSDATE(),'t123',0,
				'2016-07-01' as bzsj,'' as yjwh,dwzd_bz as dwzd,'JBT00025' as jbtCode,'公务员规范后津补贴' as jbtName,
				-- c06 标准时间 , c01 依据文号,c05 单位驻地(码表) ,c03-津补贴编号(关联型),c04-津补贴名称(关联型)
				 '乡科级正职' as gzdyzj,zkjld as je ,(case stemNum when 0 then '' else '领导职务' end ) as ldzw,'' as jblb,'' xj
				-- c07-工资对应职级(关联型) c10-标准金额 c11-领导职务 
				from jbtbz_sz  where dwzd_bz = dwzd_id and zkjld != '';
				if stemNum > 0 then -- 存在非领导职务	
					select count(1) into stemNum from jbtbz_sz 
					where dwzd_bz = dwzd_id and zkjld != '';	-- 如果存在领导职务
										
					insert into t123 (createrId,createDate,updaterId,updateDate,dataclassCode,unitId,
					c06,c01,c05,c03,c04,
					-- c06 标准时间 , c01 依据文号,c05 单位驻地(码表) ,c03-津补贴编号(关联型),c04-津补贴名称(关联型)
					c07,c10,c11,c09,c08)
					-- c07-工资对应职级(关联型) c10-标准金额 c11-领导职务  c09-艰边类别 c08-衔级					
					select 1,SYSDATE(),1,SYSDATE(),'t123',0,
					'2016-07-01' as bzsj,'' as yjwh,dwzd_bz as dwzd,'JBT00025' as jbtCode,'公务员规范后津补贴' as jbtName,
					-- c06 标准时间 , c01 依据文号,c05 单位驻地(码表) ,c03-津补贴编号(关联型),c04-津补贴名称(关联型)
					 '乡科级正职' as gzdyzj,zkjfld as je ,(case stemNum when 0 then '' else '非领导职务' end ) as ldzw,'' as jblb,'' xj
					-- c07-工资对应职级(关联型) c10-标准金额 c11-领导职务 
					from jbtbz_sz  where dwzd_bz = dwzd_id; 
				end if;
				
				-- 副科级(乡科级副职)
				select count(1) into stemNum from jbtbz_sz 
					where dwzd_bz = dwzd_id and fkjfld != '';
							
				insert into t123 (createrId,createDate,updaterId,updateDate,dataclassCode,unitId,
				c06,c01,c05,c03,c04,
				-- c06 标准时间 , c01 依据文号,c05 单位驻地(码表) ,c03-津补贴编号(关联型),c04-津补贴名称(关联型)
				c07,c10,c11,c09,c08)
				-- c07-工资对应职级(关联型) c10-标准金额 c11-领导职务  c09-艰边类别 c08-衔级					
				select 1,SYSDATE(),1,SYSDATE(),'t123',0,
				'2016-07-01' as bzsj,'' as yjwh,dwzd_bz as dwzd,'JBT00025' as jbtCode,'公务员规范后津补贴' as jbtName,
				-- c06 标准时间 , c01 依据文号,c05 单位驻地(码表) ,c03-津补贴编号(关联型),c04-津补贴名称(关联型)
				 '乡科级副职' as gzdyzj,fkjld as je ,(case stemNum when 0 then '' else '领导职务' end ) as ldzw,'' as jblb,'' xj
				-- c07-工资对应职级(关联型) c10-标准金额 c11-领导职务 
				from jbtbz_sz  where dwzd_bz = dwzd_id and fkjld != '';
				if stemNum > 0 then -- 存在非领导职务	
					select count(1) into stemNum from jbtbz_sz 
					where dwzd_bz = dwzd_id and fkjld != '';	-- 如果存在领导职务
										
					insert into t123 (createrId,createDate,updaterId,updateDate,dataclassCode,unitId,
					c06,c01,c05,c03,c04,
					-- c06 标准时间 , c01 依据文号,c05 单位驻地(码表) ,c03-津补贴编号(关联型),c04-津补贴名称(关联型)
					c07,c10,c11,c09,c08)
					-- c07-工资对应职级(关联型) c10-标准金额 c11-领导职务  c09-艰边类别 c08-衔级					
					select 1,SYSDATE(),1,SYSDATE(),'t123',0,
					'2016-07-01' as bzsj,'' as yjwh,dwzd_bz as dwzd,'JBT00025' as jbtCode,'公务员规范后津补贴' as jbtName,
					-- c06 标准时间 , c01 依据文号,c05 单位驻地(码表) ,c03-津补贴编号(关联型),c04-津补贴名称(关联型)
					 '乡科级副职' as gzdyzj,fkjfld as je ,(case stemNum when 0 then '' else '非领导职务' end ) as ldzw,'' as jblb,'' xj
					-- c07-工资对应职级(关联型) c10-标准金额 c11-领导职务 
					from jbtbz_sz  where dwzd_bz = dwzd_id; 
				end if;
				
				-- 科员
				insert into t123 (createrId,createDate,updaterId,updateDate,dataclassCode,unitId,
				c06,c01,c05,c03,c04,
				-- c06 标准时间 , c01 依据文号,c05 单位驻地(码表) ,c03-津补贴编号(关联型),c04-津补贴名称(关联型)
				c07,c10,c11,c09,c08)
				-- c07-工资对应职级(关联型) c10-标准金额 c11-领导职务  c09-艰边类别 c08-衔级					
				select 1,SYSDATE(),1,SYSDATE(),'t123',0,
				'2016-07-01' as bzsj,'' as yjwh,dwzd_bz as dwzd,'JBT00025' as jbtCode,'公务员规范后津补贴' as jbtName,
				-- c06 标准时间 , c01 依据文号,c05 单位驻地(码表) ,c03-津补贴编号(关联型),c04-津补贴名称(关联型)
				 '科员' as gzdyzj,ky as je ,'' as ldzw,'' as jblb,'' xj
				-- c07-工资对应职级(关联型) c10-标准金额 c11-领导职务 
				from jbtbz_sz  where dwzd_bz = dwzd_id and ky != '';
				
				-- 办事员
				insert into t123 (createrId,createDate,updaterId,updateDate,dataclassCode,unitId,
				c06,c01,c05,c03,c04,
				-- c06 标准时间 , c01 依据文号,c05 单位驻地(码表) ,c03-津补贴编号(关联型),c04-津补贴名称(关联型)
				c07,c10,c11,c09,c08)
				-- c07-工资对应职级(关联型) c10-标准金额 c11-领导职务  c09-艰边类别 c08-衔级					
				select 1,SYSDATE(),1,SYSDATE(),'t123',0,
				'2016-07-01' as bzsj,'' as yjwh,dwzd_bz as dwzd,'JBT00025' as jbtCode,'公务员规范后津补贴' as jbtName,
				-- c06 标准时间 , c01 依据文号,c05 单位驻地(码表) ,c03-津补贴编号(关联型),c04-津补贴名称(关联型)
				 '办事员' as gzdyzj,bsy as je ,'' as ldzw,'' as jblb,'' xj
				-- c07-工资对应职级(关联型) c10-标准金额 c11-领导职务 
				from jbtbz_sz  where dwzd_bz = dwzd_id and bsy != '';
				
				
				-- 公务员试用期
				insert into t123 (createrId,createDate,updaterId,updateDate,dataclassCode,unitId,
				c06,c01,c05,c03,c04,
				-- c06 标准时间 , c01 依据文号,c05 单位驻地(码表) ,c03-津补贴编号(关联型),c04-津补贴名称(关联型)
				c07,c10,c11,c09,c08)
				-- c07-工资对应职级(关联型) c10-标准金额 c11-领导职务  c09-艰边类别 c08-衔级					
				select 1,SYSDATE(),1,SYSDATE(),'t123',0,
				'2016-07-01' as bzsj,'' as yjwh,dwzd_bz as dwzd,'JBT00025' as jbtCode,'公务员规范后津补贴' as jbtName,
				-- c06 标准时间 , c01 依据文号,c05 单位驻地(码表) ,c03-津补贴编号(关联型),c04-津补贴名称(关联型)
				 '公务员试用期' as gzdyzj,if(ifnull(bsy,'')='',ky,bsy) as je ,'' as ldzw,'' as jblb,'' xj
				-- c07-工资对应职级(关联型) c10-标准金额 c11-领导职务 
				from jbtbz_sz  where dwzd_bz = dwzd_id;
				
				
    		end if;

  END LOOP myLoop; -- 结束自定义循环体  
  CLOSE My_Cursor; -- 关闭游标  
	-- 先更新津补贴标准表里面 津补贴编号为公务员规范后津补贴的数据为t127.id
	update t123 ,t127 set t123.c07 = t127.id where t123.c07 = t127.c05 and t123.c06 = t127.c01 and t123.c03 = 'JBT00025';
	-- 更新津补贴标准表里面 津补贴编号为公务员规范后津补贴的数据为t116.id
	update t123 ,t116 set t123.c03 = t116.id ,t123.c04 = t116.id where t123.c03 = t116.c02 and t123.c03 = 'JBT00025';

END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`p_init_sz_QxGwyJbtBz`(INOUT resultMsg varchar(1000))
label_pro:BEGIN
	#Routine body goes here...
 -- 全省各市州公务员规范后津补贴标准初始化
 -- dwzd 单位驻地 (市级 汉字)  
 -- 执行时 直接往往参数 @re 表示全部重新生成四川省下面各市州及区县的标准
	DECLARE dwzd_id int(11);-- -- 单位驻地id
	DECLARE dwzdName varchar(20);-- -- 单位驻地id
	DECLARE done INT DEFAULT FALSE; -- 自定义控制游标循环变量,默认false  
 -- 查询四川省下属市州
	DECLARE My_Cursor CURSOR FOR (
		select id  from sys_s_data a where typename = 'locale' and parent_value = 10949
	);
	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE; 
-- 绑定控制变量到游标,游标循环结束自动转true 

	
	OPEN My_Cursor; -- 打开游标  
  myLoop: LOOP -- 开始循环体,myLoop为自定义循环名,结束循环时用到  
    FETCH My_Cursor into dwzd_id; 
    IF done THEN -- 判断是否继续循环  
      LEAVE myLoop; -- 结束循环  
    END IF;  
		select name into dwzdName from sys_s_data where id = dwzd_id;
		call p_init_sz_gwyJbtBz(dwzdName,resultMsg);
  END LOOP myLoop; -- 结束自定义循环体  
  CLOSE My_Cursor; -- 关闭游标   
END;

CREATE DEFINER = `root`@`localhost` PROCEDURE `smso-migration-v2`.`p_init_table_ds_c`(IN v_unit_id varchar(50) ,
INOUT resultMsg varchar(10000) CHARSET utf8)
label_pro:BEGIN	
	declare numIndex int(11) default 0 ;
	declare v_unit_name varchar(20)  ;-- 单位名称
	declare v_table varchar(20)  ;
	declare v_table_c varchar(20)  ; 
	declare v_unit_dataId varchar(20)  ; -- 单位id
set resultMsg = '';
	while numIndex < 12 do
		set numIndex = numIndex + 1; 
		set v_table = concat('ds_t',numIndex);
		set v_table_c = concat('ds_t',numIndex,'_c');
		-- set @sqlstr = concat('select count(1) into @c from ',v_table_c,' where dwdm = \'',v_unit_id,'\'');
		
		if numIndex > 1  and numIndex <12 then 
			set @sqlstr = concat('select count(1) into @c from ',v_table_c,' where dwmc = \'',v_unit_name,'\'');
			PREPARE stmt FROM @sqlstr;
			EXECUTE stmt;
			if @c = 0 then 
				set @sqlstr = concat('select count(1) into @c from ',v_table_c,' where dwmc = \'',v_unit_dataId,'\'');
				PREPARE stmt FROM @sqlstr;
				EXECUTE stmt;
				if @c > 0 then  
					set @sqlstr = concat('delete from ',v_table_c,' where dwmc = \'',v_unit_dataId,'\'');
					PREPARE stmt FROM @sqlstr;
					EXECUTE stmt;
				end if;
				set @c = 0;
			else
				set @sqlstr = concat('delete from ',v_table_c,' where dwmc = \'',v_unit_name,'\'');
				PREPARE stmt FROM @sqlstr;
				EXECUTE stmt;
				set @c = 0;
			end if;
		else
			set @sqlstr = concat('delete from ',v_table_c,' where dwdm = \'',v_unit_id,'\'');-- ds_t1_c
			PREPARE stmt FROM @sqlstr;
			EXECUTE stmt;
			if numIndex > 1 then 
				set @sqlstr = concat('delete from ',v_table_c,' where dwdm = \'',v_unit_dataId,'\'');-- ds_t12_c
				PREPARE stmt FROM @sqlstr;
				EXECUTE stmt;
			end if;
			set @c = 0;
		end if;
		if @c = 0 then -- 此v_table_c表不存在当前单位的数据,则执行插入 如果存在则继续while
			set @sqlstr = concat('insert into ',v_table_c,' select * from ',v_table,' where dwdm = \'',v_unit_id,'\' and not exists (select 1 from ',v_table_c,' where dwdm=\'',v_unit_id,'\')');
			if numIndex > 1  and numIndex <12 then 
				set @sqlstr = concat('insert into ',v_table_c,' select * from ',v_table,' where dwmc = \'',v_unit_name,'\' and not exists (select 1 from ',v_table_c,' where dwmc=\'',v_unit_name,'\')');
			end if;
			PREPARE stmt FROM @sqlstr;
			EXECUTE stmt;
		end if;
		set @sqlstr = concat('select count(1) into @c from ',v_table_c,' where dwdm = \'',v_unit_id,'\'');
		if numIndex > 1 and numIndex <12 then 
			set @sqlstr = concat('select count(1) into @c from ',v_table_c,' where dwmc = \'',v_unit_name,'\'');
		end if;
		PREPARE stmt FROM @sqlstr;
		EXECUTE stmt;
		if numIndex = 1 then 
			if @c = 0 then 
				set resultMsg = concat('系统不存在地税单位代码', v_unit_id,',v_table_c:',v_table_c,',v_table:',v_table);
				leave label_pro;
			else 
				call p_init_ds_t111_0(v_unit_id,resultMsg);-- 调用初始化单位信息表
				select id,c02 into v_unit_dataId,v_unit_name
				from t111 where c01 = v_unit_id;-- t111表中单位id
			end if;
		end if;
	end while;
commit;
end;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`p_init_updateJbgz`(IN v_unit_dataId int(11),
-- p_init_updateJbgz刷新单位全部人员的职务工资 级别工资 工人岗位工资
-- 单位id
inout resultMsg varchar(1000))
label_pro:BEGIN 
	DECLARE sTemPersonId int(11);-- 人员id
	DECLARE personName varchar(20);-- 人员名称
	DECLARE stemNum int(11);-- 参数变量
	DECLARE stemParam varchar(20);-- 参数变量
	DECLARE stemIndex int(11);
	 
	
	DECLARE xbzsj VARCHAR(30); -- 新标准时间  
	 
	DECLARE rysf VARCHAR(30); -- 人员身份
	DECLARE gzdyzj VARCHAR(30); -- 工资对应职级
	DECLARE sfld VARCHAR(30); -- 是否领导 
	DECLARE xl VARCHAR(30); -- 学历
 
	DECLARE jb Varchar(30);-- 级别
	DECLARE dc Varchar(30);-- 档次 
	DECLARE zwgz Varchar(30);-- 职务工资
	DECLARE newZwgz Varchar(30);-- 新的职务工资
	DECLARE jbgz Varchar(30);-- 级别工资
	DECLARE newJbgz Varchar(30);-- 新的级别工资
	DECLARE gzhj VARCHAR(30); -- 工资合计
	DECLARE newGzhj VARCHAR(30); -- 工资合计 

    DECLARE done INT DEFAULT FALSE;
    
	-- 单位人员
	DECLARE personId_ CURSOR FOR
   SELECT t126.id 	from t126 ,t125
		where t126.c01 = concat(v_unit_dataId,'')
		and t126.id = t125.c06
	  and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
	  and not exists (select 1 from sys_s_data d where d.id = t126.c43 and d.typename = 'is' and d.data_value = '1') -- 不是停发工资的人员
	  and not exists (select 1 from sys_s_data d where d.id = t125.c39 and d.typename = 'is' and d.data_value = '1') -- 不是受处分人员
	  and ifnull(t126.c46,'')=''
	;
 	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;

 	set stemIndex = 0;

	set @failMsg = 1; 
  OPEN personId_;  
  -- 开始循环
  read_loop: LOOP
    -- 提取游标里的数据，这里只有一个，多个的话也一样；
    FETCH personId_ INTO sTemPersonId;
    -- 声明结束的时候
    IF done THEN
      LEAVE read_loop;
    END IF;
    set @done = done; 
    set newZwgz = 0;
    set newJbgz = 0;
    select c01 into xbzsj from t127 where c08 = (select c39 from t126 where id= sTemPersonId limit 1)
    order by c01 desc limit 1;
    select t126.c04,
		-- t126.c17,
		ifnull((select d.c05 from t127 d where d.id = t126.c17),ifnull(t126.c17,'')) as gzdyzj,
		-- 工资对应职级
		ifnull((select d.c04 from t127 d where d.id = t126.c27),ifnull(t126.c27,'')) as sfld,
		-- 是否领导
		ifnull((select d.name from sys_s_data d where d.id = t126.c09),ifnull(t126.c09,'')) as xl,
		-- 学历
		ifnull((select d.name from sys_s_data d where d.id = t126.c28),ifnull(t126.c28,'')) as rysf,
		-- 人员身份
		ifnull((select d.c05 from t127 d where d.id = t125.c07),ifnull(t125.c07,'')) as jb,
		-- 级别
		ifnull((select d.c04 from t127 d where d.id = t125.c09),ifnull(t125.c09,'')) as dc,
		-- 档次 
		ifnull(t125.c25,0) as zwgz,
		-- 职务工资 
		ifnull(t125.c26,0) as jbgz,
		-- 级别工资 
		t125.c32
		-- 工资合计  
    	into personName,
    	-- gzdyzjId,
    	gzdyzj,sfld,xl,rysf,
    	jb,dc,
    	zwgz,jbgz,gzhj
    from t126 join t125 on t126.id = t125.c06 where t126.id = sTemPersonId limit 1; 
    if ifnull(gzdyzj,'')='' then
    	if @failMsg = 1 then 
	    	set @failMsg = concat(personName,',');
	    else
	    	set @failMsg = concat(@failMsg,personName,',');
    	end if;
    else
	    set stemNum = 0;-- 变量为0表示 没有更新 变动>0 表示需要更新
		if sfld is null or sfld = '' then 
			set sfld = '';
		end if;
		if position('期' in gzdyzj)>0 then -- 试用期
			select c06 into newZwgz from t127 where c05 = concat(gzdyzj,'') and c04 = concat(xl,'') order by c01 desc limit 1;
		else
			if position('工人' in rysf)>0 then -- 工人
				if position('机关' in rysf)>0 then 
					select c06 into newZwgz from t127 where c05 = concat(gzdyzj,'')
					and c03 = '技术等级工资'
					and c08 = (select id from sys_s_data d where d.typename = 'gzbzlb' and name = '机关工勤人员')
					order by c01 desc limit 1;
					
					select c06 into newJbgz from t127 where c05 = concat(gzdyzj,'') and c04 = concat(dc,'')
					and c03 = '岗位工资'
					and c08 = (select id from sys_s_data d where d.typename = 'gzbzlb' and name = '机关工勤人员')
					order by c01 desc limit 1;
				else
					select c06 into newZwgz from t127 where c05 = cocnat(gzdyzj,'')
					and c03 = '岗位工资'
					and c08 = (select id from sys_s_data d where d.typename = 'gzbzlb' and name = '事业工勤人员')
					 order by c01 desc limit 1;
					 
					 select c06 into newJbgz from t127 where c04 = concat(dc,'')
					and c03 = '薪级工资'
					and c08 = (select id from sys_s_data d where d.typename = 'gzbzlb' and name = '事业工勤人员')
					order by c01 desc limit 1;
				end if;
			else 
				if position('公' in rysf)>0 then -- 公务员
					select c06 into newZwgz from t127 where c05 = concat(gzdyzj,'') and c04 = if(sfld='','非领导职务',sfld)
					and c03 = '职务工资'
					and c08 = (select id from sys_s_data d where d.typename = 'gzbzlb' and name = '公务员')
					order by c01 desc limit 1;
					
					select c06 into newJbgz from t127 where c05 = concat(jb,'') and c04 = concat(dc,'')
					and c03 = '级别工资'
					and c08 = (select id from sys_s_data d where d.typename = 'gzbzlb' and name = '公务员')
					order by c01 desc limit 1;
				end if;
			end if;
		end if;
	-- 	set resultMsg = concat('newZwgz:',newZwgz,',newJbgz:',newJbgz);leave label_pro;
		if newZwgz > 0 || newJbgz > 0 then 
			set stemNum = 1;
		end if;
		if stemNum> 0 then 
			if newZwgz > 0 then 
				update t125 set -- 更新人员工资信息
				c25=newZwgz,
				c32 = ifnull(newZwgz,0)+ifnull(c26,0) + ifnull(c28,0) + ifnull(c29,0) + ifnull(c30,0) + ifnull(c31,0)+ifnull(c27,0)+ifnull(c44,0)+ifnull(c45,0)+ifnull(c47,0) +0
				where c06 = concat(sTemPersonId,'');
				
				update data_record_t125 set -- 更新人员工资信息变动记录
				c25=newZwgz,
				c32 = ifnull(newZwgz,0)+ifnull(c26,0) + ifnull(c28,0) + ifnull(c29,0) + ifnull(c30,0) + ifnull(c31,0)+ifnull(c27,0)+ifnull(c44,0)+ifnull(c45,0)+ifnull(c47,0) +0
				where -- dataclassCode = 't125' and
				 c06 = concat(sTemPersonId,'');
			end if;
			if newJbgz > 0 then 
				update t125 set -- 更新人员工资信息
				c26=newJbgz,
				c32 = ifnull(c25,0)+ifnull(newJbgz,0) + ifnull(c28,0) + ifnull(c29,0) + ifnull(c30,0) + ifnull(c31,0)+ifnull(c27,0)+ifnull(c44,0)+ifnull(c45,0)+ifnull(c47,0) +0
				where c06 = concat(sTemPersonId,'');
				
				update data_record_t125 set -- 更新人员工资信息变动记录
				c26=newJbgz,
				c32 = ifnull(c25,0)+ifnull(newJbgz,0) + ifnull(c28,0) + ifnull(c29,0) + ifnull(c30,0) + ifnull(c31,0)+ifnull(c27,0)+ifnull(c44,0)+ifnull(c45,0)+ifnull(c47,0) +0
				where --  dataclassCode = 't125' and
				 c06 = concat(sTemPersonId,'');
			end if;
			set stemIndex = stemIndex+1;
			set stemNum = 0 ;
		end if;
	end if;
    set done = @done;
  END LOOP;
  -- 关闭游标
  CLOSE personId_;
	if stemIndex > 0 then 
		set resultMsg = concat('成功更新[',stemIndex,']人的基本工资'); 
	else
		set resultMsg = concat('成功更新[',stemIndex,']人的基本工资'); 
	end if;
	if @failMsg != 1 then 
		set resultMsg = concat(resultMsg,',失败人员情况:', @failMsg,'职级无数据');
	end if;
	leave label_pro;
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`p_init_update_gznx`(IN unitId int(11),IN createrId int(11),in v_unit_dataId int(11),
in jssj varchar(20),inout resultMsg varchar(1000))
label_pro:BEGIN	
/*单位人员工作年限重新计算过程
jssj-计算时间 2017-11
如果计算时间不为空 则按计算时间-参加工作时间算
*/
	DECLARE stemIndex int(11) default 0;-- 参数变量
	DECLARE sucessNum int(11) default 0;-- 成功数量
	DECLARE failNum int(11) default 0;-- 失败数量
	DECLARE stemNum int(11);-- 参数变量
	DECLARE stemPersonId int(11);-- 人员id参数
	DECLARE stemPersonName varchar(20);-- 人员姓名
	DECLARE stempParam varchar(20);-- 参数变量
	DECLARE stempMonth varchar(20);-- 参数变量
	DECLARE stemParam varchar(20);-- 参数变量

	DECLARE bdsj varchar(20);-- 变动时间
	DECLARE changeTypeId varchar(20);-- 变动类型id

	DECLARE cjgzsj varchar(20);-- 参加工作时间 y-m-d
	DECLARE qxsj varchar(20);-- 起薪时间 y-m
	DECLARE kjssjY varchar(20);-- 可计算时间-年
	DECLARE kjssjM varchar(20);-- 可计算时间-月
	DECLARE jdsjY varchar(20);-- 间断时间-年
	DECLARE jdsjM varchar(20);-- 间断时间-月
	DECLARE newSalaryDate varchar(50); -- 新工资标准时间

  DECLARE done INT DEFAULT FALSE;
	-- 所有当前单位下面的人员id
	DECLARE person_ CURSOR FOR
   SELECT t126.id from  t126,t125
		where 1=1 and t126.dataclassCode = 't126'
		and t126.c01 = concat(v_unit_dataId,'') and t126.id = t125.c06 -- 人员工资表的c06人员编号 关联型
	  and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1') -- t126.c03 人员状态-码表 1-在职
		and ifnull(t126.c46,'')=''
		and ifnull(t126.c43,'') !=10487 -- 排除已经停薪的人员  10487是否状态-是
		and ifnull(t125.c39,'') !=10487 -- 排除计发生活费/处分减资的人员
		and ifnull(t125.c40,'') !=10487 -- 排除计发病假工资的人员
		;
 	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
 SELECT count(1) into @count2 from  t126,t125
		where 1=1 and t126.dataclassCode = 't126'
		and t126.c01 = concat(v_unit_dataId,'') and t126.id = t125.c06 -- 人员工资表的c06人员编号 关联型
	  and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
		and ifnull(t126.c46,'')=''
		and ifnull(t126.c43,'') !=10487 -- 排除已经停薪的人员  10487是否状态-是
		and ifnull(t125.c39,'') !=10487 -- 排除计发生活费/处分减资的人员
		and ifnull(t125.c40,'') !=10487 -- 排除计发病假工资的人员
		;
		select id into changeTypeId from sys_s_data where typename = 'bdlx' and data_value = '7201';
	select DATE_FORMAT(now(),'%Y-%m-%d') into bdsj;-- 变动时间
 	set stemPersonName = 'stemPersonName:'; -- 失败人名称
 -- select ifnull(content,'2014-10-01') into newSalaryDate from sys_s_config where enname = 'SALARY_UPDATE_DATE';-- 新工资标准时间
	OPEN person_;  
	while stemIndex<@count2 do 
    	FETCH person_ INTO stemPersonId;
    	
    	select t125.c36 into @rygzzd from t126 ,t125 where t126.id = t125.c06 and t126.id = stemPersonId;
    	if @rygzzd then
    		select data_value into @rygzzd from sys_s_data where id = @rygzzd;-- 人员工资制度 205体育津贴奖金制
    	end if;
		select jssj into qxsj;-- 起薪时间
    	if @rygzzd != '205' then 
			select replace(t126.c12,'-',''),t126.c32,t126.c33,t126.c34,t126.c35,t126.c04,if(length(t125.c02)>7,SUBSTR(t125.c02 FROM 1 for 7),t125.c02),
			t126.c37,t126.c48,t126.c14
			into cjgzsj,kjssjY,kjssjM,jdsjY,jdsjM,@personName,@qxsj,
			@stempParam,@stemNum,@stempParam1
			from t126,t125 
			where t126.id = t125.c06 
			and t126.id = stemPersonId; 
			set cjgzsj = SUBSTR(cjgzsj FROM 1 FOR 6);
			select PERIOD_DIFF(replace(qxsj,'-',''),cjgzsj) into stemNum;
			set stemNum = stemNum + 12*ifnull(kjssjY,0) + ifnull(kjssjM,0)  - 12*ifnull(jdsjY,0) -ifnull(jdsjM,0) +1 ;
			-- 计算工作年-月
			-- t126.c47:工作时间-年  c48:工作时间-月 c14:工作年限
			if stemNum >= 12 then 
				set stempParam = floor(stemNum/12) ;
				set stemNum = mod(stemNum,12);		
			ELSE	
				set stempParam= 0;
			end if;
			if stempParam = @stempParam and stemNum = @stemNum and @stempParam1=stempParam+1 then
				set stemPersonName = concat(stemPersonName,',',@personNam);
				set failNum = failNum + 1;	
			else
				update t126 set c47=stempParam,c48=stemNum,c14=stempParam+1,
				c41 = bdsj 
				where id = stemPersonId;
				update t125 set c02 = qxsj where c06 = concat(stemPersonId,'');-- 更新起薪时间
				update data_record_t126 set c47=stempParam,c48=stemNum,c14=stempParam+1,
				c41 = bdsj where dataclassCode = 't126' and dataId =  stemPersonId;
				update data_record_t125 set c02 = qxsj where dataclassCode = 't125' and c06 = concat(stemPersonId,'');-- 更新起薪时间
				set sucessNum = sucessNum + 1;	
			end if;
		end if;
		set stemIndex = stemIndex + 1;	
	end while;
  -- 关闭游标
  CLOSE person_;
  set resultMsg = concat('共:',@count2,'人,其中',sucessNum,'人数据更新!');
  if sucessNum > 0 then 
  	call p_fund_updateFlag(v_unit_dataId,@re);-- 变动后更新基金isUPdateFund=1
  end if;
--  IF failNum > 0 THEN 
 -- 	set stemPersonName = replace(stemPersonName,'stemPersonName:','');
 -- 	set resultMsg = concat(resultMsg,failNum,'人[',stemPersonName,']入队年限/工作年限未发生变化');
 -- END IF;
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`p_insert_unit_record`(in createrId int(11),in unitId int(11),
in v_unit_dataId varchar(400),
inout resultMsg varchar(1000))
label_pro:BEGIN
-- 向record表插入当前单位所有人员当前变动信息
	DECLARE stemPersonId int(11);-- 人员id

 	DECLARE done INT DEFAULT FALSE;
	DECLARE personId_ CURSOR FOR
   	SELECT t126.id from t126 where 1=1 and t126.c01 = concat(v_unit_dataId,'') 
	;-- 查询此单位下面所有人员
 	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
 		
  OPEN personId_;  
  -- 开始循环
  read_loop: LOOP
    -- 提取游标里的数据，这里只有一个，多个的话也一样；
    FETCH personId_ INTO sTemPersonId;
    -- 声明结束的时候
    IF done THEN
      LEAVE read_loop;
    END IF;
	set @doneF = done;
		call person_insert_record(createrId,unitId,sTemPersonId,resultMsg);
	set done = @doneF;
  END LOOP;
  -- 关闭游标
  CLOSE personId_;
	
end;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`p_ins_xjxgRecord_init`(in v_unit_dataId int(11),inout resultMsg varchar(1000))
label_pro:BEGIN	
/*单位人员 重新给 档次id
	并且
	统一修改对应的关联型 
	部门-t126.c15(人员所在单位的部门)/人员身份-t126.c28(单位工资制度+人员工资制度联合获取)/
	执行工资标准-t126.c39(单位工资制度+人员工资制度联合获取)/工资对应职级-t126.c17(根据实际职级获取)/是否领导-t126.c27(根据新的工资对应职级获取)/
	姓名-t125.c33(根据人员编号-c06获取)/级别-t125.c07(根据工资制度,工资标准获取)/档次-t125.c09(根据根据工资制度,工资标准获取或新的级别获取)/ 匹配项
	变动记录统一初始化为通过,并生成发放表
*/
	DECLARE stemIndex int(11) default 0;-- 参数变量
	DECLARE stemNum int(11);-- 参数变量
	DECLARE stemPersonId int(11);-- 人员id参数
	DECLARE stemId int(11);-- 记录id参数
	DECLARE chanSign varchar(100);-- 变动标志

	DECLARE sjzj varchar(50); -- 实际职级
	DECLARE rygzzd varchar(50); -- 人员工资制度
	DECLARE dwgzzd varchar(50); -- 单位工资制度


	DECLARE sf varchar(50); -- 人员身份
	DECLARE zxgzbz varchar(50); -- 执行工资标准 工资标准类别
	DECLARE gzdyzj varchar(50); -- 工资对应职级
	DECLARE sfld varchar(50); -- 是否领导
	DECLARE jb varchar(50); -- 级别
	DECLARE dc varchar(50); -- 档次
	DECLARE newSalaryDate varchar(50); -- 新工资标准时间

  DECLARE done INT DEFAULT FALSE;
	-- 所有当前单位薪级为XX级的人员id
	DECLARE person_ CURSOR FOR
   SELECT t126.id from  data_record_t126 t126,data_record_t125 t125
		where 1=1 and t126.dataclassCode = 't126' and t125.dataclassCode = 't125' and t126.changeSign = t125.changeSign
		and t126.c01 = concat(v_unit_dataId,'') and t126.dataId = t125.c06 -- 人员工资表的c06人员编号 关联型
		and exists(select 1 from sys_s_data d where d.id = t125.c36 and d.typename = 'wageSystem' 
			and d.data_value in (204,205)) -- 人员工资制度为  202 203 机关技工 普工 204 -事业岗位绩效工资制 205-体育津贴奖金制 
	  and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1');-- t126.c03 人员状态-码表 1-在职
 	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
 	
 SELECT  count(1) into @count from  data_record_t126 t126,data_record_t125 t125
		where 1=1 and t126.dataclassCode = 't126' and t125.dataclassCode = 't125' and t126.changeSign = t125.changeSign
		and t126.c01 = concat(v_unit_dataId,'') and t126.dataid = t125.c06 -- 人员工资表的c06人员编号 关联型
		and exists(select 1 from sys_s_data d where d.id = t125.c36 and d.typename = 'wageSystem' 
			and d.data_value in (204,205)) -- 人员工资制度为  202 203 机关技工 普工 204 -事业岗位绩效工资制 205-体育津贴奖金制 
	  and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1');-- t126.c03 人员状态-码表 1-在职
 	
 select ifnull(content,'2014-10-01') into newSalaryDate from sys_s_config where enname = 'SALARY_UPDATE_DATE';-- 新工资标准时间
 
	-- 修改关联型
	select c13 into dwgzzd from t111 where id = v_unit_dataId; -- 单位工资制度

	OPEN person_;  
	while stemIndex<@count do 
    	FETCH person_ INTO stemId;
		select t126.dataId,t126.c28,t126.c39,t126.c17,t126.c27,t125.c07,t125.c09,
		t126.c36,t125.c36,t126.changeSign 
		into stemPersonId,sf,zxgzbz,gzdyzj,sfld,jb,dc,
		--  人员id,人员身份,执行工资标准/工资标准类别,工资对应职级,是否领导, 姓名,级别,档次
		sjzj,rygzzd,chanSign
		-- 实际职级,人员工资制度,变动标志
		from data_record_t126 t126 join data_record_t125 t125 on t126.dataId = t125.c06 and t126.changeSign = t125.changeSign 
		where t126.id = stemId ;
		
		select name,data_value into rygzzd,@rygzzdCode from sys_s_data where id = rygzzd; -- 获取人员工资制度中文名称 
		
		if ifnull(jb,'')!='' then -- 运动员  存在级别这个字段
			set stemIndex = stemIndex;
		else -- 级别为空的情况  
			if ifnull(dc,'')!='' then 
				select c04,c05 into dc,jb from t127 where id = dc; -- 档次 中文名称
				if  @rygzzdCode = 204 then -- 事业岗位绩效工资制
					select id into dc from t127 where c04=concat(dc,'') and c08=concat(zxgzbz,'') order by c01 desc limit 0,1;
				else 
					select id into dc from t127 where c04=concat(dc,'') and c08=concat(zxgzbz,'') and c05=concat(jb,'') order by c01 desc limit 0,1;
				end if;
			end if;
			update data_record_t125 set c09=dc where c06 = concat(stemPersonId,'') and changeSign = cocnat(chanSign,'') and dataclassCode = 't125' ;-- 更新工资表里面的 姓名,级别,档次
			set stemIndex = stemIndex + 1;	
		end if;
	end while;
  -- 关闭游标
  CLOSE person_;
  set resultMsg = concat('共@count:',@count,'人,其中',stemIndex,'条记录数据更新!');
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`p_ins_xjxg_init`(in v_unit_dataId int(11),inout resultMsg varchar(1000))
label_pro:BEGIN	
/*单位人员 重新给 档次id
	并且
	统一修改对应的关联型 
	部门-t126.c15(人员所在单位的部门)/人员身份-t126.c28(单位工资制度+人员工资制度联合获取)/
	执行工资标准-t126.c39(单位工资制度+人员工资制度联合获取)/工资对应职级-t126.c17(根据实际职级获取)/是否领导-t126.c27(根据新的工资对应职级获取)/
	姓名-t125.c33(根据人员编号-c06获取)/级别-t125.c07(根据工资制度,工资标准获取)/档次-t125.c09(根据根据工资制度,工资标准获取或新的级别获取)/ 匹配项
	变动记录统一初始化为通过,并生成发放表
*/
	DECLARE stemIndex int(11) default 0;-- 参数变量
	DECLARE stemNum int(11);-- 参数变量
	DECLARE stemPersonId int(11);-- 人员id参数
	DECLARE stempParam varchar(20);-- 参数变量
	DECLARE stempMonth varchar(20);-- 参数变量
	DECLARE stemParam varchar(20);-- 参数变量


	DECLARE sjzj varchar(50); -- 实际职级
	DECLARE rygzzd varchar(50); -- 人员工资制度
	DECLARE dwgzzd varchar(50); -- 单位工资制度


	DECLARE sf varchar(50); -- 人员身份
	DECLARE zxgzbz varchar(50); -- 执行工资标准 工资标准类别
	DECLARE gzdyzj varchar(50); -- 工资对应职级
	DECLARE sfld varchar(50); -- 是否领导
	DECLARE jb varchar(50); -- 级别
	DECLARE dc varchar(50); -- 档次
	DECLARE newSalaryDate varchar(50); -- 新工资标准时间

  DECLARE done INT DEFAULT FALSE;
	-- 所有当前单位薪级为XX级的人员id
	DECLARE person_ CURSOR FOR
   SELECT t126.id from  t126,t125
		where 1=1 -- and t126.dataclassCode = 't126'
		and t126.c01 = concat(v_unit_dataId,'') and t126.id = t125.c06 -- 人员工资表的c06人员编号 关联型
		and exists(select 1 from sys_s_data d where d.id = t125.c36 and d.typename = 'wageSystem' 
			and d.data_value in (204,205)) -- 人员工资制度为  202 203 机关技工 普工 204 -事业岗位绩效工资制 205-体育津贴奖金制 
	  and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1');-- t126.c03 人员状态-码表 1-在职
 	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
 	
 SELECT  count(1) into @count from  t126,t125
		where 1=1 -- and t126.dataclassCode = 't126'
		and t126.c01 = concat(v_unit_dataId,'') and t126.id = t125.c06 -- 人员工资表的c06人员编号 关联型
		and exists(select 1 from sys_s_data d where d.id = t125.c36 and d.typename = 'wageSystem' 
			and d.data_value in (204,205)) -- 人员工资制度为  202 203 机关技工 普工 204 -事业岗位绩效工资制 205-体育津贴奖金制 
	  ;-- t126.c03 人员状态-码表 1-在职
 	
 select ifnull(content,'2014-10-01') into newSalaryDate from sys_s_config where enname = 'SALARY_UPDATE_DATE';-- 新工资标准时间
 
	-- 修改关联型
	select c13 into dwgzzd from t111 where id = v_unit_dataId; -- 单位工资制度

	OPEN person_;  
	while stemIndex<@count do 
    	FETCH person_ INTO stemPersonId;
		select t126.c28,t126.c39,t126.c17,t126.c27,t125.c07,t125.c09,
		t126.c36,t125.c36
		into sf,zxgzbz,gzdyzj,sfld,jb,dc,
		--  人员身份,执行工资标准/工资标准类别,工资对应职级,是否领导, 姓名,级别,档次
		sjzj,rygzzd
		-- 实际职级,人员工资制度
		from t126,t125 
		where t126.id = stemPersonId and t126.id = t125.c06 ;
		
		select name,data_value into rygzzd,@rygzzdCode from sys_s_data where id = rygzzd; -- 获取人员工资制度中文名称 
		
		if ifnull(jb,'')!='' then -- 运动员  存在级别这个字段
			set stemIndex = stemIndex;
		else -- 级别为空的情况  
			if ifnull(dc,'')!='' then 
				select c04,c05 into dc,jb from t127 where id = dc; -- 档次 中文名称
				if  @rygzzdCode = 204 then -- 事业岗位绩效工资制
					select id into dc from t127 where c04=concat(dc,'') and c08=concat(zxgzbz,'') order by c01 desc limit 0,1;
				else 
					select id into dc from t127 where c04=concat(dc,'') and c08=concat(zxgzbz,'') and c05=concat(jb,'') order by c01 desc limit 0,1;
				end if;
			end if;
			update t125 set c09=dc where c06 = concat(stemPersonId,'');-- 更新工资表里面的 姓名,级别,档次
			update data_record_t125 set c09=dc where c06 = concat(stemPersonId,'') and dataclassCode = 't125' order by id desc limit 1;-- 更新工资表里面的 姓名,级别,档次
			set stemIndex = stemIndex + 1;	
		end if;
	end while;
  -- 关闭游标
  CLOSE person_;
  set resultMsg = concat('共@count:',@count,'人,其中',stemIndex,'人数据更新!');
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`p_ins_xj_init`(in v_unit_dataId int(11),inout resultMsg varchar(1000))
label_pro:BEGIN	
/*单位人员工作年限重新计算过程
	并且
	统一修改对应的关联型 
	部门-t126.c15(人员所在单位的部门)/人员身份-t126.c28(单位工资制度+人员工资制度联合获取)/
	执行工资标准-t126.c39(单位工资制度+人员工资制度联合获取)/工资对应职级-t126.c17(根据实际职级获取)/是否领导-t126.c27(根据新的工资对应职级获取)/
	姓名-t125.c33(根据人员编号-c06获取)/级别-t125.c07(根据工资制度,工资标准获取)/档次-t125.c09(根据根据工资制度,工资标准获取或新的级别获取)/ 匹配项
	变动记录统一初始化为通过,并生成发放表
*/
	DECLARE stemIndex int(11) default 0;-- 参数变量
	DECLARE stemNum int(11);-- 参数变量
	DECLARE stemPersonId int(11);-- 人员id参数
	DECLARE stempParam varchar(20);-- 参数变量
	DECLARE stempMonth varchar(20);-- 参数变量
	DECLARE stemParam varchar(20);-- 参数变量


	DECLARE sjzj varchar(50); -- 实际职级
	DECLARE rygzzd varchar(50); -- 人员工资制度
	DECLARE dwgzzd varchar(50); -- 单位工资制度


	DECLARE bm varchar(50); -- 部门
	DECLARE sf varchar(50); -- 人员身份
	DECLARE zxgzbz varchar(50); -- 执行工资标准 工资标准类别
	DECLARE gzdyzj varchar(50); -- 工资对应职级
	DECLARE sfld varchar(50); -- 是否领导
	DECLARE jb varchar(50); -- 级别
	DECLARE dc varchar(50); -- 档次
	DECLARE newSalaryDate varchar(50); -- 新工资标准时间

  DECLARE done INT DEFAULT FALSE;
	-- 所有当前单位薪级为XX级的人员id
	DECLARE person_ CURSOR FOR
   SELECT t126.id from  t126,t125
		where 1=1 -- and t126.dataclassCode = 't126'
		and t126.c01 = concat(v_unit_dataId,'') and t126.id = t125.c06 -- 人员工资表的c06人员编号 关联型
		and exists(select 1 from sys_s_data d where d.id = t125.c36 and d.typename = 'wageSystem' 
			and d.data_value in (202,203,204,205)) -- 人员工资制度为  202 203 机关技工 普工 204 -事业岗位绩效工资制 205-体育津贴奖金制 
		and t125.c09 like '%级'
	  and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1');-- t126.c03 人员状态-码表 1-在职
 	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
 	
 SELECT count(1) into @count from  t126,t125
		where 1=1 --  and t126.dataclassCode = 't126'
		and t126.c01 = concat(v_unit_dataId,'') and t126.id = t125.c06 -- 人员工资表的c06人员编号 关联型
		and t125.c09 like '%级'
	  and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1');-- t126.c03 人员状态-码表 1-在职
 
 select ifnull(content,'2014-10-01') into newSalaryDate from sys_s_config where enname = 'SALARY_UPDATE_DATE';-- 新工资标准时间
 
	-- 修改关联型
	select c13 into dwgzzd from t111 where id = v_unit_dataId; -- 单位工资制度

	OPEN person_;  
	while stemIndex<@count do 
    	FETCH person_ INTO stemPersonId;
    	
		select t126.c15,t126.c28,t126.c39,t126.c17,t126.c27,t125.c07,t125.c09,
		t126.c36,t125.c36
		into bm,sf,zxgzbz,gzdyzj,sfld,jb,dc,
		-- 部门,人员身份,执行工资标准/工资标准类别,工资对应职级,是否领导, 姓名,级别,档次
		sjzj,rygzzd
		-- 实际职级,人员工资制度
		from t126,t125 
		where t126.id = stemPersonId and t126.id = t125.c06 ;
		
		select name,data_value into rygzzd,@rygzzdCode from sys_s_data where id = rygzzd; -- 获取人员工资制度中文名称 
		-- select c04 into zxgzbz from t136 where id = zxgzbz;-- 执行工资标准 中文名称
		-- select c02 into sf from t136 where id = sf;-- 人员身份 中文名称
		 -- 2017-01-06
		--	人员身份-t126.c28改成码表  不用重新查询更新
		--	执行工资标准-t126.c39改成 工资标准类别  码表 也不用重新查询更新
		select name into @rysfName from sys_s_data where id = sf;
		if @rysfName = '管理人员' then -- 事业人员只有身份为管理人员的才分是否领导
			select c04 into sfld from t127 where id = sfld; -- 是否领导 中文名称
		else  
			set sfld = '';
		end if;
		-- select id into sf from t136 where c01=dwgzzd and c02=sf and c03='在职' and c04=zxgzbz and c05=rygzzd;
		-- 查询正确的执行工资标准,人员身份id c01-单位工资制度 c02-人员身份 c03-在职/离退休 c04-执行工资标准 c05-人员工资制度
		select count(1) into @gzdyzjCount from t127 where id = gzdyzj;
		set @gzdyzj = gzdyzj;
    	if @gzdyzjCount > 0 then 
			select c05 into @gzdyzj from t127 where id = gzdyzj; -- 工资对应职级 中文名称
		end if;
		select count(1) into @gzdyzjCount from t127 where c05=@gzdyzj and c08=zxgzbz and c04=sfld; -- 工资对应职级;
		if @gzdyzjCount > 0 then 
			select id into gzdyzj from t127 where c05=@gzdyzj and c08=zxgzbz and c04=sfld order by c01 desc limit 0,1; -- 工资对应职级;
			if sfld!='' then 
				set sfld = gzdyzj;-- 是否领导
			end if;
		else 
			select id into gzdyzj from t127 where c05=@gzdyzj and c08=zxgzbz order by c01 desc  limit 0,1; -- 工资对应职级;
			-- set resultMsg = concat('select id into gzdyzj from t127 where c05=\'',gzdyzj,'\' and c08=\'',zxgzbz,'\'  and c01 = ',newSalaryDate);leave label_pro;
		end if;
		-- select id into @gzdyzj from t127 where c05=gzdyzj and c08=zxgzbz and c04=sfld and c01 = newSalaryDate; -- 工资对应职级;
		-- 查询正确的 工资对应职级 c05-次级别名称  c08-执行工资标准 c04-级别名称(是否领导)
		-- set sfld = @gzdyzj;-- 是否领导
		
		if ifnull(jb,'')!='' then -- 运动员  存在级别这个字段
			select c05 into jb from t127 where id = jb; -- 级别 中文名称
			if ifnull(dc,'')!='' then 
				select c04 into dc from t127 where id = dc; -- 档次 中文名称
				select id,id into jb,dc from t127 where c05=jb and c04=dc and c08=zxgzbz order by c01 desc limit 0,1;
			end if;
		else -- 级别为空的情况  
			if ifnull(dc,'')!='' then 
				select c04,c05 into dc,jb from t127 where id = dc; -- 档次 中文名称
				if @rygzzdCode = 202 or @rygzzdCode = 203 then -- 机关技工 普工
					select id into dc from t127 where c04=dc and c08=zxgzbz and c05=@gzdyzj order by c01 desc limit 0,1;
				else
					if  @rygzzdCode = 204 then -- 事业岗位绩效工资制
						select id into dc from t127 where c04=dc and c08=zxgzbz order by c01 desc limit 0,1;
					else 
						select id into dc from t127 where c04=dc and c08=zxgzbz and c05=jb order by c01 desc limit 0,1;
					end if;
				end if;
			end if;
		end if;
		
		-- set zxgzbz = sf; -- 执行工资制度
		-- select id into sfld from t127 where c04=sfld and c08=zxgzbz;-- 是否领导 
		-- 查询正确的 是否领导  c04-级别名称  c08-执行工资标准
		update t125 set c09=dc where c06 = concat(stemPersonId,'');-- 更新工资表里面的 姓名,级别,档次
		set stemIndex = stemIndex + 1;	
	end while;
  -- 关闭游标
  CLOSE person_;
  set resultMsg = concat('共@count:',@count,'人,其中',stemIndex,'人数据更新!');
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`p_lx_tiaochu`(in olddwid int(11),in newdwid int(11),
in ryid int(11),in userIdOld int(11),in userIdNew int(11),in qxsj varchar(200),
INOUT resultMsg varchar(200) CHARSET utf8)
label_pro:BEGIN	

declare czbm varchar(50)  ;  -- 单位财政编码
declare dwdm varchar(50)  ;  -- 单位代码
declare dwryxh int(11)  ;    -- 单位人员序号
declare xrybh varchar(100)  ;    -- 新人员编号

select c01,c15 into dwdm,czbm from t111 where id=concat('',newdwid);
select (autoEnd+1) into dwryxh from data_auto_record  WHERE autoHead=concat('',dwdm) AND dataclassCode='t126';


update t126 set c01=newdwid,c41=DATE_FORMAT(SYSDATE(),'%Y-%m-%d'),c40='10750',updateDate=SYSDATE(),
	updaterId=userIdNew,c23=czbm  where id = ryid;-- 更新人员
update t125 set c02=qxsj,c05=newdwid where c06 = concat(ryid,'');-- 更新人员基本工资项
update t117 set c02=newdwid where c03 = concat(ryid,'');-- 更新人员基本工资项
call person_insert_record(userIdNew,newdwid,ryid,resultMsg);	

if dwryxh>999 then
set xrybh=concat(dwdm,dwryxh,'T');
elseif dwryxh>99 then
set xrybh=concat(dwdm,'0',dwryxh,'T');
elseif dwryxh>9 then
set xrybh=concat(dwdm,'00',dwryxh,'T');
elseif dwryxh<10 then
set xrybh=concat(dwdm,'000',dwryxh,'T');
end if;

UPDATE data_auto_record SET autoEnd=dwryxh  WHERE autoHead=concat('',dwdm) AND dataclassCode='t126';

UPDATE t126 set c02=xrybh WHERE id=concat('',ryid);
UPDATE data_record_t126 set c02=xrybh WHERE dataId=concat('',ryid)  AND c01=concat('',newdwid);

    
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`p_person_getQxsj`(IN personId int(11),out qxsj VARCHAR(10))
BEGIN
	DECLARE first_qxsj varchar(20); -- 在本单位的第一条起薪时间
	DECLARE lastCXQDGZ_qxjs varchar(20); -- 在本单位最后一条重新确定工资变动的起薪时间
	DECLARE lastCXQDGZ_GZZD varchar(20); -- 在本单位的最后一条重新确定工资
	DECLARE first_GZZD varchar(20); -- 在本单位的第一条工资制度
	DECLARE fzbl_qxsj varchar(20); -- 辅助变量_起薪时间
	DECLARE notfound INT DEFAULT 0; -- 定义一个辅助变量用于判断
	DECLARE tId varchar(100);-- data_record_t125表的id-变量
	DECLARE gzzd_2 varchar(20); -- 之后工资制度
	DECLARE fzbl_gzzd varchar(20); -- 辅助变量_工资制度
	DECLARE qxsj_1 varchar(20); -- 起薪时间
	DECLARE num_1 INT(10); -- 辅助变量，用于确定人员在本单位是否存在重新确定工资的变动
	DECLARE num INT(10); -- 辅助变量，用于确定人员在辅助变动起薪时间之后是否还存在与辅助变量工资制度不同的变动

		-- 得到在人员在目前单位的变动记录ID并且ID大于人员在当前单位最新的一次录入或者接收人员变动，按照工资制度和起薪时间分组，Id排序
		DECLARE re_t125_id CURSOR FOR select id from data_record_t125 where c06 = concat(personId,'') and c05 = (select c01 from t126 where id = personId)
and id >= (select id from data_record_t125 where changeSign = (select changeSign from data_record_t126 where dataId = personId AND c01 = (select c01 from t126 where id = personId) and  (c40 = '10750' or c40 = '10832') order by id desc LIMIT 1)) GROUP BY c36,c02 order by id;
		-- 设置游标的终止条件
		DECLARE CONTINUE HANDLER FOR NOT FOUND SET notfound = 1;

	-- 获取人员在本单位最新的一条录入新进人员或者接收调入人员 ,10750（录入新进人员） 10832（接收调入人员）
	select c02,c36 into first_qxsj,first_GZZD from data_record_t125 where changeSign = (select changeSign from data_record_t126 where dataId = personId and  (c40 = '10750' or c40 = '10832') and c01=(select c01 from t126 where id = personId)  order by id desc LIMIT 1);


	-- 获取人员在本单位的最后一条重新确定工资的起薪时间， 10749（重新确定工资）
	select c02,c36,COUNT(1) into lastCXQDGZ_qxjs,lastCXQDGZ_GZZD,num_1 from data_record_t125 where 
	changeSign = (select changeSign from data_record_t126 where  dataId = personId and  c40 = '10749' and c01 = (select c01 from t126 where id = personId)  order by id desc LIMIT 1);

	-- 判断最后一条重新确定工资是否为空
	if num_1 > 0 THEN
		set fzbl_qxsj = lastCXQDGZ_qxjs; -- 将在本单位最后一条的重新确定工资的起薪时间赋值给fzbl_qxsj
		set fzbl_gzzd = lastCXQDGZ_GZZD; -- 将在本单位最后一条重新确定工资的工资制度赋值给last_GZZD
	else 
		set fzbl_qxsj = first_qxsj; -- 将在本单位第一条起薪时间赋值给fzbl_qxsj
		set fzbl_gzzd = first_GZZD; -- 将在本单位的第一条的工资制度赋值给first_GZZD
	end if;
	-- 获取人员在之后的起薪时间是否还存在工资制度改变
	select COUNT(1) into num from data_record_t125 where c02 > fzbl_qxsj and c36 <> fzbl_gzzd and c06 = concat(personId,'');
	-- 设置起薪时间为赋值变量起薪时间
	set qxsj = fzbl_qxsj;
	if num > 0 then -- 如果起薪时间大于录入人员或者调入人员或者重新确定工资之后的工资制度有变化
	OPEN re_t125_id;
				loop1: LOOP
					FETCH re_t125_id into tId;
						if notfound = 1 then
							LEAVE loop1;
						end if;
						select c02 into @c02 from data_record_t125 where id = tId ;
					 	if @c02 > fzbl_qxsj THEN -- 如果起薪时间大于录入人员或者调入人员或者重新确定工资的起薪时间
							-- 获取data_record_t125表中的工资制度
							select c36 into gzzd_2 from data_record_t125 where id = tId;
							if gzzd_2 <> fzbl_gzzd then -- 11172(警察职级工资制),10469(公务员职级工资制)
								if (gzzd_2 = 10469 or gzzd_2 = 11172) and (fzbl_gzzd = 11172 or fzbl_gzzd = 10469) then  -- 机关的单位判断
									select fzbl_gzzd;
									select gzzd_2;
								else
									-- 获取data_record_t125表中的起薪时间	
									select e.c02 into qxsj_1 from data_record_t125 e where id = tId;
									set fzbl_gzzd = gzzd_2;
									set qxsj = qxsj_1;
								end if;
							end if;
						end if;
				END LOOP;
		close re_t125_id;
	end if;
	
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`p_pre_validate_fund`(in v_i_fund_month varchar(6),in v_unit_id varchar(50),
in v_unit_dataId int(11),inout resultMsg varchar(10000))
label_pro:BEGIN
/*基金生成前验证; --v_i_fund_month 基金月份传入参数;--v_unit_id 基金单位代码传入参数--v_unit_dataId 基金单位id*/
declare stemNum int(11);
declare stemParam varchar(20);
declare stemYearMonth varchar(20);

declare stemJcjbNum int(11) default 0;
declare stemJczqNum int(11) default 0;
declare stemJbjbtNum int(11) default 0;
declare failMsg VARCHAR(1000); -- 生成失败原因 
declare failCount int(11) default 0; -- 生成失败总跳数
declare isleave int(11) default 0;  -- 是否退出过程
DECLARE t_error INTEGER DEFAULT 0;
DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET t_error=1;
	
	select count(1) into stemNum from fund_audit_record where unit_id = concat(v_unit_dataId,'') and fund_month = concat(v_i_fund_month,'');   
	if stemNum >= 1 then
		select fund_status into stemParam from fund_audit_record where unit_id = concat(v_unit_dataId,'') and fund_month = concat(v_i_fund_month,'');
		if stemParam = 2 then
			set resultMsg = '基金已经通过,不能重复生成!';
			leave label_pro; 
		end if;
		if stemParam = 1 then
			set resultMsg = '基金已经上报待审核中,请不要重复操作!';
			leave label_pro; 
		end if;
		if stemParam = 7 then
			set resultMsg = '基金正在撤回过程中!';
			leave label_pro; 
		end if;
	end if;
	
		select count(1) into @stemParam from t112 where c01 = concat(v_unit_dataId,''); -- t112单位编制信息
		if @stemParam = 0 then
			set resultMsg = '单位编制信息获取失败!';
			leave label_pro; 
		end if;
		select c18 into stemParam from t112 where c01 = concat(v_unit_dataId,''); -- t112.c18 单位编制审核状态
		select data_value into stemParam from sys_s_data where id = stemParam ;
		if stemParam = '0' then 
			 set resultMsg = '当前单位编制保存后尚未审核通过!';
			 leave label_pro;
		end if;
		if stemParam = '2' then 
			 set resultMsg = '当前单位编制保存后审核未通过!';
			 leave label_pro;
		end if;
		
		select count(1) into stemNum from t126 where c01 = concat(v_unit_dataId,'') -- t126 人员基本信息 c01-单位代码
		and not exists(select 1 from sys_s_data d where d.id = t126.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		;  
		select count(1) into @stemNumRecord126 from data_record_t126 t126 where c01 = concat(v_unit_dataId,'') -- t126 人员基本信息 c01-单位代码
		and not exists(select 1 from sys_s_data d where d.id = t126.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
		and ifnull(allAuditFlag , 0 ) !=2 
		; 
		select count(1) into @stemNumT119 from t119 where c04 = concat(v_unit_dataId,'') -- t126 人员基本信息 c01-单位代码
		and  exists(select 1 from t126 where t119.c01 = t126.id and t126.c03!=10372 )
		-- 非离休人员
		; 
		set stemNum = stemNum +@stemNumRecord126 + @stemNumT119 ;
	
	
		if stemNum = 0 then
			 set resultMsg = '当前单位没有人员信息';
			 leave label_pro;
		end if;	
		
		select DATE_FORMAT(DATE_ADD(now(),INTERVAL 1 MONTH),'%Y%m') into stemParam;
		
		select PERIOD_DIFF(v_i_fund_month,stemParam) into stemNum  ;-- 如果201608月份申请201610月份的基金,不可以的
		if stemNum >= 2 then
			set resultMsg = '基金生成不能超过未来2个月!';leave label_pro;
		end if;
		
		-- 先调用补扣发生成
		-- CALL p_fill_fund (v_i_fund_month,v_unit_id,v_unit_dataId,resultMsg);/*基金生成-基金补扣发详细*/
		select DATE_FORMAT(DATE_ADD(concat(v_i_fund_month,'01'),INTERVAL 1 MONTH),'%Y%m') into stemYearMonth;-- 基金生成月份下一个月
		select count(1) into stemNum from fund_audit_record where fund_month = concat(stemYearMonth,'') and unit_id = concat(v_unit_dataId,'');
		if stemNum > 0 then -- 如果基金生成月份为:201704 但是当前单位的201705已经生成基金,则默认生成04月份 的基金从03月份取
			call no_record_fund(v_i_fund_month,v_unit_id,v_unit_dataId,resultMsg); -- 没有变动记录时生成月报数据
			leave label_pro;
		end if;
		
		select DATE_FORMAT(DATE_SUB(concat(v_i_fund_month,'01'),INTERVAL 1 MONTH),'%Y%m') into stemYearMonth;-- 基金生成月份上一个月
		select count(1) into stemNum from fund_audit_record where fund_month = concat(stemYearMonth,'') and unit_id = concat(v_unit_dataId,'');
		if stemNum = 0 then -- 首先判断上一个月是否存在基金审核记录(基金是否生成),如果没有生成,则先生成上月的基金,默认通过的
			-- set resultMsg = concat('#',stemYearMonth,',',v_unit_id,',',v_unit_dataId);leave label_pro;
			-- 循环生成上一个基金月份与现在基金月份之间相关的基金月份数据
			set @funM = '';
			select count(1) into @c from fund_audit_record 
			where unit_id = concat(v_unit_dataId,'') and fund_status = '2' and fund_month<=stemYearMonth;
		
			select fund_month into @funM from fund_audit_record 
			where unit_id = concat(v_unit_dataId,'') and fund_status = '2' and fund_month<=stemYearMonth 
			order by fund_month desc limit 1;
			while @c>0 do
				if stemYearMonth = @funM then -- 如果生成基金月份上一个月
					set @c = 0;
				else
					select DATE_FORMAT(DATE_ADD(concat(@funM,'01'),INTERVAL 1 MONTH),'%Y%m') into @stemYM;
					if @stemYM = stemYearMonth then 
						call no_record_fund(stemYearMonth,v_unit_id,v_unit_dataId,resultMsg); -- 没有变动记录时生成月报数据
						if ''!=resultMsg then leave label_pro; end if;
						set @c = 0;
					else
						call no_record_fund(@stemYM,v_unit_id,v_unit_dataId,resultMsg); -- 没有变动记录时生成月报数据
						if ''!=resultMsg then leave label_pro; end if;
						select PERIOD_DIFF(v_i_fund_month,@stemYM) into @c;
						set @funM = @stemYM ; 
					end if; 
				end if;
			end while;
		end if;
		
		delete from fund_check_fail where unitid = concat(v_unit_dataId,''); 
		
		-- select count(1) into stemNum from data_data_record a where a.dataclassCode = 't126' and a.c01 = v_unit_dataId and fund_month = v_i_fund_month ; -- 当月的变动记录情况
		select count(1) into @stemNum1 from t141; -- 前置变动配置表
		if @stemNum1 > 0 then 
			select ifnull(content,11307) into @policeExtraCode from sys_s_config where enname = 'POLICE_EXTRA_CODE';
			select ifnull(content,11306) into @policeDutyCode from sys_s_config where enname = 'POLICE_DUTY_CODE';
			select ifnull(content,11315) into @hardMoteCode from sys_s_config where enname = 'HARD_MOTE_CODE';
			
			select count(1) into @policeExtraCodeNum from t141 where c01 = @policeExtraCode;-- 前置变动表 查询警察加班是否需要前置审核
			select count(1) into @policeDutyCodeNum from t141 where c01 = @policeDutyCode;
			select count(1) into @hardMoteCodeNUm from t141 where c01 = @hardMoteCode;
			if @policeExtraCodeNum > 0 then 
				-- 警察加班补贴
				select count(1) into stemJcjbNum from t152 where c01 = concat(v_unit_dataId,'') 
					-- and EXISTS (select 1 from t126,sys_s_data d where d.id = t126.c03 and t126.id = t153.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
					and ifnull(c15,'')!='2';
					-- 前置审核状态  0-未申报 1-待审核 2-审核通过 3-审核不通过
				if stemJcjbNum > 0 then -- 当月没有警察加班补贴
					insert into fund_check_fail 
					--     id  单位id      基金月份 变动类型  人员编号  人员姓名  起薪时间  失败原因
					select 0,v_unit_dataId,v_i_fund_month ,'警察加班津补贴',b.c02,b.c04,'','前置变动[警察加班津补贴]未审核通过'
					from t152 as a,t126 as b 
					where a.c03 = b.id and  a.c01 = concat(v_unit_dataId,'')  and 	ifnull(a.c15,'')!='2';

					set failCount = failCount+stemJcjbNum;
					-- 前置审核状态  0-未申报 1-待审核 2-审核通过 3-审核不通过
					-- set resultMsg = '当月尚有前置变动[警察加班津补贴]未审核通过,不能进行月报生成!';
					set isleave =1;
				end if;
			end if;
			if @policeDutyCodeNum > 0 then 
				select count(1) into stemJczqNum from t153 where c01 = concat(v_unit_dataId,'') 
				and ifnull(c18,'')!='2';
				if stemJczqNum > 0 then -- 当月没有警察加班补贴
					insert into fund_check_fail 
					--     id  单位id      基金月份 变动类型  人员编号  人员姓名  起薪时间  失败原因
					select 0,v_unit_dataId,v_i_fund_month ,'警察值勤津补贴',b.c02,b.c04,'','前置变动[警察值勤津补贴]未审核通过'
					from t153 as a,t126 as b 
					where a.c03 = b.id and  a.c01 = concat(v_unit_dataId,'')  and 	ifnull(a.c18,'')!='2';
					set failCount = failCount+stemJczqNum;
					-- 前置审核状态  0-未申报 1-待审核 2-审核通过 3-审核不通过
					-- set resultMsg = '当月尚有前置变动[警察值勤津补贴]未审核通过,不能进行月报生成!';
					set isleave =1;
				end if;
			end if;
			if @hardMoteCodeNUm > 0 then 
				select count(1) into stemJbjbtNum from t164 where c01 = concat(v_unit_dataId,'') 
				and ifnull(c12,'')!='2';
				-- 前置审核状态  0-未申报 1-待审核 2-审核通过 3-审核不通过
				if stemJbjbtNum > 0 then
					insert into fund_check_fail 
					--     id  单位id      基金月份 变动类型  人员编号  人员姓名  起薪时间  失败原因
					select 0,v_unit_dataId,v_i_fund_month ,'艰苦边远地区津贴补扣发',b.c02,b.c04,'','前置变动[艰苦边远地区津贴补扣发]未审核通过'
					from t164 as a,t126 as b 
					where a.c03 = b.id and  a.c01 = concat(v_unit_dataId,'')  and 	ifnull(a.c12,'')!='2';
					set failCount = failCount+stemJbjbtNum;
					-- set resultMsg = '当月尚有前置变动[艰苦边远地区津贴补扣发]未审核通过,不能进行月报生成!';
					set isleave =1;
				end if;
			end if;
		end if;
		set @resultMsg = concat('t_error:',t_error);
		select count(1) into stemNum from data_record_t126 a where a.dataclassCode = 't126' and a.c01 = concat(v_unit_dataId,'') and ifnull(a.allAuditFlag,'') != '2'; -- 当月的变动记录情况
		if stemNum = 0 then -- 当月没有变动记录
			if stemJcjbNum=0 and stemJczqNum=0 and stemJbjbtNum=0 then 
				call no_record_fund(v_i_fund_month,v_unit_id,v_unit_dataId,resultMsg); -- 没有变动记录时生成月报数据
				if ''!=resultMsg then leave label_pro; end if;
				update fund_audit_record set fund_status = 9,secondFlag=9,firstFlag = 9,thirdFlag=9,forthFlag=9,fiveFlag=9,sixFlag=9
				where fund_month = concat(v_i_fund_month,'')
				and unit_id = concat(v_unit_dataId,'');
				leave label_pro;
			end if; 
		end if;
		-- if resultMsg then  leave label_pro; end if;
		-- if ''!=resultMsg then  leave label_pro; end if;
	
-- 先查询是否存在前置变动数据
	 --  人员基本信息-变动类型 与t141.c01-前置变动配置表里面的变动类型相同且未审核通过
	select count(1) into stemNum from t141;
	if stemNum > 0 then 
		select count(1) into stemNum from data_record_t126 a , t141 b 
		where a.dataclassCode = 't126' and a.c40 = b.c01
		 and a.c01 = concat(v_unit_dataId,'') and ifnull(a.perAuditFlag,'') != '2' ;-- 2审核通过 查询未审核通过的前置变动数量
		if stemNum > 0 then
			insert into fund_check_fail 
					--     id  单位id      基金月份 变动类型  人员编号  人员姓名  起薪时间  失败原因
					select 0,v_unit_dataId,v_i_fund_month ,(select d.name from sys_s_data d where d.id = a.changeType),
						a.c02,a.c04,'',
						(select concat('前置变动[',d.name,']未审核通过') from sys_s_data d where d.id = a.changeType )
					from data_record_t126 as a,t141 as b 
					where a.dataclassCode = 't126' and a.changeType = b.c01 and a.c01 = concat(v_unit_dataId,'') 
					and ifnull(a.perAuditFlag,'') != '2' ;
			set failCount = failCount+stemNum;
			-- set resultMsg = '当月尚有前置变动未审核通过,不能进行月报生成!';
			set isleave =1;
		end if;
	end if;
	
		-- 查询当月是否存在变动记录
		select count(1) into stemNum from data_record_t126 a,data_record_t125 b
			 where a.dataclassCode = 't126' and b.dataclassCode = 't125' 
			 and a.changeSign = b.changeSign 
			 and a.c01 = concat(v_unit_dataId,'') and ifnull(a.allAuditFlag,'') != '2' 
			 and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
		-- 非离休人员
			 and replace(b.c02,'-','')> v_i_fund_month; -- 生成基金月份存在起薪时间晚于基金月分的变动
		if stemNum > 0 then
			-- 存入生成失败原因记录表
			set failCount = failCount+stemNum;
			insert into fund_check_fail 
					select 0,v_unit_dataId,v_i_fund_month ,(select d.name from sys_s_data d where d.id = a.c40),a.c02,a.c04,b.c02,'起薪时间晚于基金月份'
					from data_record_t126 a,data_record_t125 b
					where a.dataclassCode = 't126' and b.dataclassCode = 't125' 
					and a.changeSign = b.changeSign 
					and a.c01 = concat(v_unit_dataId,'') and ifnull(a.allAuditFlag,'') != '2' 
					and not exists(select 1 from sys_s_data d where d.id = a.c03 and d.typename = 'staffStatus' and d.data_value = '2')
					-- 非离休人员
					and replace(b.c02,'-','')> v_i_fund_month ;
					
			set isleave =1;
		end if;

	if isleave =1 then 
		set resultMsg = 'downloadFail';
		leave label_pro; 
	end if ;



	CALL p_init_ds_wrongList(v_unit_dataId,resultMsg);
	select count(1) into @countWrong from t181 where c03 = concat(v_unit_dataId,'');
		if @countWrong>0 then
			set resultMsg =  '[单位数据及人员数据错误情况列表]尚未处理完全，请在：单位管理-待修改列表 下查看详情并作出相应处理';
			leave label_pro; 
		end if;

END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`p_record_init`(in v_unit_dataId int(11),inout resultMsg varchar(1000))
label_pro:BEGIN	
/*单位人员 
	统一修改对应的关联型 
	部门-t126.c15(人员所在单位的部门)/人员身份-t126.c28(单位工资制度+人员工资制度联合获取)/
	执行工资标准-t126.c39(单位工资制度+人员工资制度联合获取)/工资对应职级-t126.c17(根据实际职级获取)/是否领导-t126.c27(根据新的工资对应职级获取)/
	姓名-t125.c33(根据人员编号-c06获取)/级别-t125.c07(根据工资制度,工资标准获取)/档次-t125.c09(根据根据工资制度,工资标准获取或新的级别获取)/ 匹配项
	变动记录统一初始化为通过,并生成发放表*/
	DECLARE stemNum int(11);-- 参数变量 while循环的
	DECLARE stempNum int(11);-- 参数变量 创建表的
	DECLARE stemIndex int(11);-- 参数变量
	DECLARE stemPersonId int(11);-- 人员id参数
	DECLARE qxsj varchar(20);-- 起薪时间
	DECLARE newYm varchar(20);-- 当前单位下次申报月份 如: 初始化月份是9月,现在是10.8号 根据当前单位是否统发单位获取此时上报应该是哪个月
	DECLARE sbsj varchar(20);-- 单位截止上报时间
	DECLARE v_unit_id varchar(50);-- 单位代码
	DECLARE stemYearMonth varchar(20);-- 基金月份

	DECLARE v_table VARCHAR(50);
	DECLARE v_allowance_table VARCHAR(50);

  DECLARE done INT DEFAULT FALSE;
	-- 所有当前单位下面的人员id
	DECLARE person_ CURSOR FOR
   SELECT t126.id from  t126
		where 1=1 -- and t126.dataclassCode = 't126'
		and t126.c01 = concat(v_unit_dataId,'') 
	  and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1');-- t126.c03 人员状态-码表 1-在职
 	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
	
	select c01 into v_unit_id from t111 where id = v_unit_dataId;-- t111.c01 单位代码

	select count(1) into stemNum from t156 where c01 = concat(v_unit_dataId,''); -- 提交财政统发单位表 如果存在这个单位,则是统发单位
	if stemNum > 0 then 
		-- 统发单位
		select c02 into sbsj from t155 ,sys_s_data d where t155.c01 = concat(d.id,'') and d.typename = 'is' and d.data_value = '1';
	else 
		-- 非统发单位
		select c02 into sbsj from t155 ,sys_s_data d where t155.c01 = concat(d.id,'') and d.typename = 'is' and d.data_value = '0';
	end if;
	select PERIOD_DIFF(DATE_FORMAT(SYSDATE(),'%d'),sbsj) into stemNum;
	if stemNum >0 then
	-- 如果当前时间 10月8号 截止上报时间:5号 则 newYm = 当前时间+1 
		-- set newYm = DATE_FORMAT(DATE_ADD(SYSDATE(),INTERVAL 2 MONTH),'%Y%m');
		set newYm = DATE_FORMAT(DATE_ADD(SYSDATE(),INTERVAL 1 MONTH),'%Y%m');
	else 
	-- 如果当前时间 10月8号 截止上报时间:10号 则 newYm = 当前时间+1
		-- set newYm = DATE_FORMAT(DATE_ADD(SYSDATE(),INTERVAL 1 MONTH),'%Y%m');
		set newYm = DATE_FORMAT(SYSDATE(),'%Y%m');
	end if;	
	
	-- 初始化测试数据时,先初始化201701的数据
	set newYm = DATE_FORMAT(DATE_SUB(SYSDATE(),INTERVAL 1 MONTH),'%Y%m');
	set newYm = DATE_FORMAT(SYSDATE(),'%Y%m');
	
	OPEN person_;  
  -- 开始循环
  read_loop: LOOP
    -- 提取游标里的数据，这里只有一个，多个的话也一样；
    FETCH person_ INTO stemPersonId;
    -- 声明结束的时候
    IF done THEN
      LEAVE read_loop;
    END IF;
    	select count(1) into stemNum from data_record_t126 where dataclassCode = 't126' and dataId = stemPersonId;
	    /**if stemNum > 0 then
	    	update data_data_record  set perAuditFlag = 2,allAuditFlag = 2,auditMsg = '导入系统初始化数据'
	    	where dataclassCode = 't126' and dataId = stemPersonId;
	    	update data_data_record a,data_data_record b set a.perAuditFlag = 2,a.allAuditFlag = 2
	    	where b.dataclassCode = 't126' and a.changeSign = b.changeSign and b.perAuditFlag = 2 and b.allAuditFlag = 2;
	    end if;
	    */
   	 	select replace(c02,'-','') into qxsj from t125 where c06 = concat(stemPersonId,''); -- 查询人员起薪时间
		
		select PERIOD_DIFF(newYm,qxsj) into stemNum;
		if stemNum = 0 then 
			set stemYearMonth = newYm;
			select count(1) into stempNum from fund_audit_record 
			where fund_month = concat(stemYearMonth,'') and unit_id = concat(v_unit_dataId,'') and fund_status = '2' ;
			if stempNum < 1 then 
				call p_all_fund(stemYearMonth,v_unit_id,v_unit_dataId,resultMsg); -- 调用基金生成方法
				update fund_audit_record set firstFlag='2',secondFlag='2',thirdFlag='2',forthFlag='2',fiveFlag='2',sixFlag='2',fund_status='2' 
				where fund_month = concat(stemYearMonth,'') and unit_id = concat(v_unit_dataId,'');
				call fund_audit(stemYearMonth,v_unit_id,v_unit_dataId,resultMsg);
			end if;
		else
			if stemNum > 0 then
				set stemIndex = 0;
				while stemIndex<stemNum DO
				
					set stemYearMonth = DATE_FORMAT(DATE_ADD(concat(qxsj,'01'),INTERVAL stemIndex MONTH),'%Y%m');
					select count(1) into stempNum from fund_audit_record 
					where fund_month = concat(stemYearMonth,'') and unit_id = concat(v_unit_dataId,'') and fund_status = '2' ;
					if stempNum < 1 then 
						call p_all_fund(stemYearMonth,v_unit_id,v_unit_dataId,resultMsg); -- 调用基金生成方法
						update fund_audit_record set firstFlag='2',secondFlag='2',thirdFlag='2',forthFlag='2',fiveFlag='2',sixFlag='2',fund_status='2' 
						where fund_month = concat(stemYearMonth,'') and unit_id = concat(v_unit_dataId,'');
						call fund_audit(stemYearMonth,v_unit_id,v_unit_dataId,resultMsg);
					end if;
				end while;
			end if;
		end if;
	END LOOP;
  -- 关闭游标
  CLOSE person_;
	
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`p_salaryUpdate`(IN unitId int(11),IN createrId int(11),
in gzbzgxfl varchar(400),in v_unit_dataId varchar(400),in v_unit_id varchar(400),
-- c01 工资标准分类           c02-单位代码/关联型              c03-单位名称
in bdsj varchar(400),in xbzsj varchar(400),in jbtId varchar(400),
-- c04-更新时间                c05-新标准时间                   c06-津补贴编号 /关联型
in jbtName varchar(400),
-- c07-津补贴名称/关联型
inout resultMsg varchar(1000))
label_pro:BEGIN
/*工资标准更新*/
	DECLARE sTemPersonId int(11);
	DECLARE stemNum int(11);-- 参数变量
	DECLARE stemParam varchar(20) default '';-- 参数变量
	DECLARE stemIndex int(11);
	DECLARE chanType VARCHAR(30);
	DECLARE chanSign VARCHAR(200);
	
	DECLARE rysf VARCHAR(30);-- 人员身份
	DECLARE rysfId VARCHAR(30);-- 人员身份id
	DECLARE xl VARCHAR(30);-- 学历
	DECLARE xlId VARCHAR(30);-- 学历id
	DECLARE gzbzlb VARCHAR(30);-- 工资标准类别
	DECLARE gzbzlbId VARCHAR(30);-- 工资标准类别Id
	DECLARE gzdyzj VARCHAR(30); -- 工资对应职级
	DECLARE gzdyzjId VARCHAR(30); -- 工资对应职级Id
	DECLARE sfld VARCHAR(30); -- 是否领导
	DECLARE sfldId VARCHAR(30); -- 是否领导Id
	DECLARE jb VARCHAR(30); -- 级别
	DECLARE jbId VARCHAR(30); -- 级别Id
	DECLARE dc VARCHAR(30); -- 档次
	DECLARE dcId VARCHAR(30); -- 档次Id
	DECLARE oldGzbzsj VARCHAR(30); -- 人员旧的工资标准时间
	DECLARE zwgz VARCHAR(30); -- 职务 工资
	DECLARE jbgz VARCHAR(30); -- 级别 工资
	DECLARE jbtxj VARCHAR(30); -- 津补贴小计
	DECLARE gzhj VARCHAR(30); -- 工资合计
	DECLARE newZwgz VARCHAR(30); -- 新职务 工资
	DECLARE newJbgz VARCHAR(30); -- 新级别 工资
	DECLARE newJbtxj VARCHAR(30); -- 津补贴小计
	DECLARE newGzhj VARCHAR(30); -- 新工资合计
	
	DECLARE sftg10 VARCHAR(30); -- 是否提高10工資
	DECLARE sftg15 VARCHAR(30); -- 是否提高15%工資

	DECLARE jhtg VARCHAR(30); -- 教師護士提高10工資
	DECLARE newJhtg VARCHAR(30); -- 教師護士提高10工資
	DECLARE tjtg VARCHAR(30); -- 特殊教育提高15%工資
	DECLARE newTjtg VARCHAR(30); -- 特殊教育提高15%工資

	
	
    DECLARE done INT DEFAULT FALSE;
    
	-- 单位所有人员
	DECLARE personId_ CURSOR FOR
   SELECT t126.id from t126 join t125 on t126.id = t125.c06
		where 1=1 
		and t126.c01 = concat(v_unit_dataId,'')  
	  and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
	  and not exists (select 1 from sys_s_data d where d.id = t126.c43 and d.typename = 'is' and d.data_value = '1') -- 不是停发工资的人员
	  and not exists (select 1 from sys_s_data d where d.id = t125.c39 and d.typename = 'is' and d.data_value = '1') -- 不是受处分人员
	  and ifnull(t126.c46,'')='' -- 不是调出的人员
	;
 	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
 	set stemIndex = 0; -- 更新条数
 	
 	select count(1) into stemNum from sys_s_data where id = gzbzgxfl;
 	if stemNum > 0 then 
	 	select data_value into stemParam from sys_s_data where id = gzbzgxfl;
	else 
		set resultMsg = '更新标准类型传输错误!';leave label_pro;
 	end if;
 	if stemParam = 2 then -- 津补贴标准更新
		call p_sublariesUpdate(createrId,unitId,gzbzgxfl,v_unit_dataId,c3,bdsj,xbzsj,jbtId,c7,resultMsg);
		leave label_pro;
 	end if;
 	
 	-- 处理新的标准时间
 	select count(1) into stemNum from t127 where position(xbzsj in c01) > 0 ;
 	if stemNum = 0 then 
	 	set stemParam = substring(xbzsj,1,4);-- 新标准时间 年 如: 2016
	 	select count(1) into stemNum from t127 where position(stemParam in c01) > 0 ;
	 	if stemNum = 0 then 
	 		set resultMsg = concat('系统不存在',stemParam,'年新的工资标准数据,请系统更新后再操作');
	 		leave label_pro;
	 	else
	 		select c01 into xbzsj from t127 where position(stemParam in c01) > 0 limit 1 ;
	 	end if;
	else 
	 	select c01 into xbzsj from t127 where position(xbzsj in c01) > 0 limit 1 ;
 	end if;
 	
 	select count(1) into stemNum 
 	from t126 join t125 on t126.id = t125.c06 
 	where t126.c01 = concat(v_unit_dataId,'')
 	and t125.c49 != xbzsj;-- t125.c49 工资标准时间
 	if stemNum = 0 then
 		set resultMsg = concat('当前单位所有人员的工资标准时间为[',xbzsj,'],不用再更新');leave label_pro; 
 	end if;
	select DATE_FORMAT(now(),'%Y-%m-%d') into bdsj;-- 变动时间
	select count(1) into stemNum from data_record_t126 t126 join data_record_t125 t125 
	on t126.changeSign = t125.changeSign and t126.dataId = t125.c06
	where t126.dataclassCode = 't126' and t125.dataclassCode = 't125' and t126.c01 = concat(v_unit_dataId,'')
	and ifnull(t126.allAuditFlag,'')!='2' and t125.c02 > xbzsj;
 	if stemNum > 0 then
 		set resultMsg = concat('当前更新工资标准时间为[',xbzsj,'],存在人员变动起薪时间在此之后的数据');leave label_pro; 
 	end if;
  OPEN personId_;  
  -- 开始循环
  read_loop: LOOP
    -- 提取游标里的数据，这里只有一个，多个的话也一样；
    FETCH personId_ INTO sTemPersonId;
    -- 声明结束的时候
    IF done THEN
      LEAVE read_loop;
    END IF;
    set @done = done;
    select 
    	t126.c28,ifnull((select d.name from sys_s_data d where d.id = t126.c28),ifnull(t126.c28,'')) as rysf,
    	-- 人员身份
    	t126.c10,ifnull((select d.name from sys_s_data d where d.id = t126.c10),ifnull(t126.c10,'')) as xl,
    	-- 学历
    	t126.c39,ifnull((select d.name from sys_s_data d where d.id = t126.c39),ifnull(t126.c39,'')) as gzbzlb,
    	-- 工资标准类别
		t126.c17,ifnull((select d.c05 from t127 d where d.id = t126.c17),ifnull(t126.c17,'')) as gzdyzj,
		-- 工资对应职级
		t126.c27,ifnull((select d.c04 from t127 d where d.id = t126.c27),ifnull(t126.c27,'')) as sfld,
		-- 是否领导
		ifnull(t125.c07,''),ifnull((select d.c05 from t127 d where d.id = t125.c07),ifnull(t125.c07,'')) as jb,
		-- 级别
		t125.c09,ifnull((select d.c04 from t127 d where d.id = t125.c09),ifnull(t125.c09,'')) as dc,
		-- 档次 
		t125.c25,ifnull(t125.c26,''),t125.c27,t125.c32,t125.c49,
		-- 职务工资 级别工资 津补贴小计 工资合计 工资标准时间
		ifnull((select d.name from sys_s_data d where d.id = t125.c23),ifnull(t125.c23,'')) ,ifnull(t125.c28,''),
		-- 是否提高10%工資
		ifnull((select d.name from sys_s_data d where d.id = t125.c35),ifnull(t125.c35,'')) ,ifnull(t125.c19,'')
		-- 是否提高15%工資
    	into 
    	rysfId,rysf,
    	xlId,xl,
    	gzbzlbId,gzbzlb,
    	gzdyzjId,gzdyzj,
    	sfldId,sfld,
    	jbId,jb,
    	dcId,dc,
    	zwgz,jbgz,jbtxj,gzhj,oldGzbzsj,
    	sftg10,jhtg,
    	sftg15,tjtg
    from t126 join t125 on t126.id = t125.c06 where t126.id = sTemPersonId;
    if oldGzbzsj != xbzsj then -- 旧工资标准时间不是新的
		set @qxsj = substring(xbzsj,1,7);
		if position('期' in gzdyzj) > 0 then -- 试用 期人员
			select count(1) into stemNum 
			 from t127 where c01 = concat(xbzsj,'') and c05 = gzdyzj and c04 = xl and c08 = gzbzlbId;-- 新的工资对应职级id
			if stemNum > 0 then 
				select id,c06 into gzdyzjId,newZwgz
				 from t127 where c01 = concat(xbzsj,'') and c05 = gzdyzj and c04 = xl and c08 = gzbzlbId;-- 新的工资对应职级id 新的职务工资
				
				set newJbgz = '';
				CALL upPercentJbt(sTemPersonId,newJbtxj,newZwgz,newJbgz,resultMsg);
				if sftg10 = '是' then
					set newJhtg = round(CAST((newZwgz + newJbgz)*0.1 AS DECIMAL));
				else 
					set newJhtg = '';
				end if;
				if sftg15 = '是' then
					set newTjtg = round(CAST((newZwgz + newJbgz + newJhtg)*0.15 AS DECIMAL));
				else 
					set newTjtg = '';
				end if;
				set newGzhj = gzhj - zwgz + newZwgz - jhtg + newJhtg - tjtg +newTjtg - jbtxj + newJbtxj+ 0;
				
				update t126,sys_s_data d set c40 = d.id -- 更新人员的变动类型 
				,t126.c41 = bdsj
				,t126.c17 = gzdyzjId -- 新的工资对应职级id
				where t126.id = sTemPersonId and d.typename = 'bdlx' and d.data_value = '9001';
				update t125 set c02=@qxsj,c49=xbzsj,
				c25 = newZwgz,c26=newJbgz,c27=newJbtxj,
				c28 = newJhtg,
				c29 = newTjtg,
				c32 = newGzhj
				where c06 = concat(sTemPersonId,'');
				call person_insert_record(createrId,unitId,sTemPersonId,resultMsg);-- 插入变动记录
				set stemIndex = stemIndex+1;
			end if;
		else -- 非试用 期人员
			select count(1) into stemNum 
			 from t127 where c01 = xbzsj and c05 = gzdyzj and c04 = sfld and c08 = gzbzlbId ;-- 新的工资对应职级id
			if stemNum > 0 then 
				select id,c06 into gzdyzjId,newZwgz
				 from t127 where c01 = concat(xbzsj,'') and c05 = gzdyzj and c04 = sfld and c08 = concat(gzbzlbId,'');-- 新的工资对应职级id 新的职务工资

				if gzbzlb = '机关工勤人员' then 
					set jb = gzdyzj;
				end if;
				
				select id,c06 into dcId,newJbgz
				 from t127 where c01 = concat(xbzsj,'') and c05 = jb and c04 = dc and c08 = concat(gzbzlbId,'');-- 新的级别 档次 id 以及 级别工资
				if ifnull(newJbgz,'')='' then 
					set newJbgz = '';
				end if;
				CALL upPercentJbt(sTemPersonId,newJbtxj,newZwgz,newJbgz,resultMsg);
				if resultMsg!= '' then leave label_pro;end if;
				if sftg10 = '是' then
					set newJhtg = round(CAST((newZwgz + newJbgz)*0.1 AS DECIMAL));
				else 
					set newJhtg = '';
				end if;
				if sftg15 = '是' then
					set newTjtg = round(CAST((newZwgz + newJbgz + newJhtg)*0.15 AS DECIMAL));
				else 
					set newTjtg = '';
				end if;
				set newGzhj = gzhj - zwgz + newZwgz - jbgz + newJbgz - jhtg + newJhtg - tjtg +newTjtg - jbtxj + newJbtxj+ 0;
				/** if sTemPersonId = 5526 then 
		    		set resultMsg = concat('newGzhj:',newGzhj,',newTjtg:',newTjtg,',newJbtxj:',newJbtxj);leave label_pro;
		    	end if;*/
				update t126,sys_s_data d set c40 = d.id -- 更新人员的变动类型 
				,t126.c41 = bdsj
				,t126.c17 = gzdyzjId -- 新的工资对应职级id
				,t126.c27 = if(position('领导' in sfld)>0,gzdyzjId,'') -- 如果原来的是否领导不为空则 使用新的id
				where t126.id = sTemPersonId and d.typename = 'bdlx' and d.data_value = '9001';
				
				update t125 set c02=@qxsj,c49=xbzsj,
				c07=if(position('级' in jb)>0,dcId,''),-- 级别id
				c09 = dcId,-- 档次 id
				c25 = newZwgz,c26=newJbgz,c27=newJbtxj,
				c28 = newJhtg,
				c29 = newTjtg,
				c32 = newGzhj where c06 = concat(sTemPersonId,'');
				call person_insert_record(createrId,unitId,sTemPersonId,resultMsg);-- 插入变动记录
				set stemIndex = stemIndex+1;
			end if;
		end if;
    end if;
    set done = @done;
  END LOOP;
  -- 关闭游标
  CLOSE personId_;
	if stemIndex > 0 then 
		set resultMsg = concat('成功更新[',stemIndex,']人的工资标准为',xbzsj);
  		call p_fund_updateFlag(v_unit_dataId,@re);-- 变动后更新基金isUPdateFund=1
	else
		set resultMsg = concat('成功更新[',stemIndex,']人的工资标准为',xbzsj);
	end if;
	leave label_pro;

END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`p_set_gznx`(in v_unit_dataId int(11),inout resultMsg varchar(1000))
label_pro:BEGIN	
/*单位人员工作年限重新计算过程
*/
	DECLARE stemIndex int(11) default 0;-- 参数变量
	DECLARE sucessNum int(11) default 0;-- 参数变量
	DECLARE stemNum int(11);-- 参数变量
	DECLARE stemPersonId int(11);-- 人员id参数
	DECLARE stempParam varchar(20);-- 参数变量
	DECLARE stempMonth varchar(20);-- 参数变量
	DECLARE stemParam varchar(20);-- 参数变量

	DECLARE cjgzsj varchar(20);-- 参加工作时间 y-m-d
	DECLARE qxsj varchar(20);-- 起薪时间 y-m
	DECLARE kjssjY varchar(20);-- 可计算时间-年
	DECLARE kjssjM varchar(20);-- 可计算时间-月
	DECLARE jdsjY varchar(20);-- 间断时间-年
	DECLARE jdsjM varchar(20);-- 间断时间-月
	DECLARE newSalaryDate varchar(50); -- 新工资标准时间

  DECLARE done INT DEFAULT FALSE;
	-- 所有当前单位下面的人员id
	DECLARE person_ CURSOR FOR
   SELECT t126.id from  t126,t125
		where 1=1 -- and t126.dataclassCode = 't126'
		and t126.c01 = concat(v_unit_dataId,'') and t126.id = t125.c06 -- 人员工资表的c06人员编号 关联型
	  and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1') -- t126.c03 人员状态-码表 1-在职
	;-- 需要更新工作年限
 	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
 	
 SELECT count(1) into @count from  t126,t125
		where 1=1 -- and t126.dataclassCode = 't126'
		and t126.c01 = concat(v_unit_dataId,'') and concat(t126.id,'') = t125.c06 -- 人员工资表的c06人员编号 关联型
	  and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1');-- t126.c03 人员状态-码表 1-在职
 
 -- select ifnull(content,'2014-10-01') into newSalaryDate from sys_s_config where enname = 'SALARY_UPDATE_DATE';-- 新工资标准时间
	OPEN person_;  
  	read_loop: LOOP
    -- 提取游标里的数据，这里只有一个，多个的话也一样；
    FETCH person_ INTO stemPersonId;
	    -- 声明结束的时候
	    IF done THEN
	      LEAVE read_loop;
	    END IF;
	    set  @stempParam = 0, @stemNum=0,@stempParam1=0,stemNum=0;
    	select t125.c36 into @rygzzd from t126 ,t125 where t126.id = t125.c06 and t126.id = stemPersonId;
    	if @rygzzd then
    		select data_value into @rygzzd from sys_s_data where id = @rygzzd;-- 人员工资制度 205体育津贴奖金制
    	end if;
    	if @rygzzd = '205' then 
    		-- -- 人员工资制度 205体育津贴奖金制 运动员
			select replace(t126.c12,'-','') ,if(length(t125.c02)>4,SUBSTR(t125.c02 FROM 1 for 4),t125.c02)
			into cjgzsj ,qxsj
			from t126,t125 
			where t126.id = t125.c06 
			and t126.id = stemPersonId; 
			set cjgzsj = SUBSTR(cjgzsj FROM 1 FOR 4);
			set qxsj = replace(qxsj,'-','');
			set stemNum = substring(qxsj,1,4)+0 - cjgzsj + 1 ;-- 2017-1990 
			update t126 set c45 = stemNum,c47='',c48='',c14='',c19='',c20='' where id = stemPersonId;
			-- c45:入队年限  c47:工作时间-年 c48:工作时间-月 c14:工作年限 c19:现任职务 c20:现任职务时间
			update data_record_t126 set c45=stemNum,c47='',c48='',c14='',c19='',c20='' where dataId = stemPersonId and changeType = '10750' ;-- 录入新进人员			
			-- 更新人员基本信息表中 入队年限 为（当前时间年-参加工作时间/入队时间的年 + 1）
			set sucessNum = sucessNum + 1;	
			-- 更新人员基本信息表中 入队年限 为（当前时间年-参加工作时间/入队时间的年 + 1）
    	else
			select replace(t126.c12,'-',''),ifnull(t126.c32,0)+0,ifnull(t126.c33,0)+0,ifnull(t126.c34,0)+0,ifnull(t126.c35,0)+0,
			if(length(t125.c02)>7,SUBSTR(t125.c02 FROM 1 for 7),t125.c02),
			ifnull(t126.c47,0)+0,ifnull(t126.c48,0)+0,ifnull(t126.c14,0)+0
			into cjgzsj,kjssjY,kjssjM,jdsjY,jdsjM,qxsj,
			-- 参加工作时间 y-m-d 可计算时间-年  可计算时间-月 间断时间-年 间断时间-月 起薪时间 y-m
			@stempParam,@stemNum,@stempParam1
			-- 工作时间-年 工作时间-月 工作年限
			from t126,t125 
			where t126.id = t125.c06 
			and t126.id = stemPersonId; 
			-- set cjgzsj = SUBSTR(cjgzsj FROM 1 FOR 6);
			set qxsj = replace(qxsj,'-','');-- 2017-01 -> 201701

			set @kjsglMonth = 0;-- 可计算工龄月份时间
			set @kjsglMonth = kjssjY*12 + kjssjM - jdsjY*12 - jdsjM;-- 可计算年*12+可计算月-间断年*12-间断月
			set @cjgzsj = SUBSTR(cjgzsj FROM 1 FOR 6);-- 此字段存在 根据 可计算 间断 时间 推算后的 虚拟参加工作时间
			if @kjsglMonth > 0 then -- 可计算时间为正
				-- 参加工作时间对应增加/减少 可计算/间断的时间后的参加工作时间(如: 2012年6月参加工作可计算7个月 那么此人正式参加工作时间为 201112)
				set @cjgzsj = DATE_FORMAT(DATE_SUB(cjgzsj,INTERVAL @kjsglMonth MONTH),'%Y%m');
			else 
			  if @kjsglMonth < 0 then -- 可计算时间为负 表示间断>可计算
				-- 参加工作时间对应增加/减少 可计算/间断的时间后的参加工作时间(如: 2012年6月参加工作 间断7个月 那么此人正式参加工作时间为 201301)
				set @kjsglMonth = @kjsglMonth*-1;-- 负负得正
				set @cjgzsj = DATE_FORMAT(DATE_ADD(cjgzsj,INTERVAL @kjsglMonth MONTH),'%Y%m');
			  end if;
			end if;
			
			-- 工作年限(原连续工龄) 按照间断与可计算的时间推算后的 参加工作时间与起薪时间之间的 年-年+1.
			set stemParam = substring(qxsj,1,4)+0 - substring(@cjgzsj,1,4) + 1 ;-- 2017-1990 
			
			/** 
			set cjgzsj = SUBSTR(cjgzsj FROM 1 FOR 6);
			select PERIOD_DIFF(replace(qxsj,'-',''),cjgzsj) into stemNum;
			set stemNum = stemNum + 12*ifnull(kjssjY,0) + ifnull(kjssjM,0)  - 12*ifnull(jdsjY,0) -ifnull(jdsjM,0) +1 ; 
			*/
			select PERIOD_DIFF(qxsj,@cjgzsj) into stemNum;-- 按照间断与可计算的时间推算后的 参加工作时间与起薪时间之间的 月份差
			set stemNum = stemNum +1;-- 月份+1
			-- 计算工作年-月
			-- t126.c47:工作时间-年  c48:工作时间-月 c14:工作年限
			if stemNum >= 12 then 
				set stempParam = floor(stemNum/12) ;
				set stemNum = mod(stemNum,12);		
			ELSE	
				set stempParam= 0;
			end if;
			-- set resultMsg = concat('stemNum:',stemNum,',','stempParam:',stempParam,',@stempParam:',@stempParam);leave label_pro;
			-- if stempParam != @stempParam then
				update t126 set c47=stempParam,c48=stemNum,c14=stemParam
				-- 工作时间-年  工作时间-月 工作年限(原连续工龄)
				where id = stemPersonId;
				update data_record_t126 set c47=stempParam,c48=stemNum,c14=stemParam
				where dataId = stemPersonId and changeType = '10750';
				set sucessNum = sucessNum + 1;	
			-- end if;
		end if;
		set stemIndex = stemIndex+1;
  END LOOP;
  -- 关闭游标
  CLOSE person_;
  set resultMsg = concat('共@count:',@count,'人,其中',sucessNum,'人数据更新!');
  select resultMsg;
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`p_sublariesUpdate`(IN unitId int(11),IN createrId int(11),
in gzbzgxfl varchar(400),in v_unit_dataId varchar(400),in v_unit_id varchar(400),
-- c01 工资标准分类           c02-单位代码/关联型              c03-单位名称
in bdsj varchar(400),in xbzsj varchar(400),in jbtId varchar(400),
-- c04-更新时间                c05-新标准时间                   c06-津补贴编号 /关联型
in jbtName varchar(400),
-- c07-津补贴名称/关联型
inout resultMsg varchar(1000))
label_pro:BEGIN
	DECLARE sTemPersonJbtId int(11);-- 人员津补贴表id
	DECLARE sTemPersonId int(11);-- 人员id
	DECLARE stemNum int(11);-- 参数变量
	DECLARE stemParam varchar(20);-- 参数变量
	DECLARE stemIndex int(11);
	
	DECLARE jbtCode VARCHAR(30); -- 津补贴编号 
	
	DECLARE dwzdId VARCHAR(30); -- 单位驻地id
	DECLARE dwjblbId VARCHAR(30); -- 单位艰边类别
	DECLARE gzdyzj VARCHAR(30); -- 工资对应职级
	DECLARE gzdyzjId VARCHAR(30); -- 工资对应职级Id
	DECLARE xjId VARCHAR(30); -- 衔级Id

	DECLARE oldJbtbzsj VARCHAR(30); -- 人员旧的津补贴标准时间
	DECLARE jbtxj Varchar(30);-- 津补贴小计
	DECLARE newJbtxj Varchar(30);-- 津补贴小计
	DECLARE gzhj VARCHAR(30); -- 工资合计
	DECLARE newGzhj VARCHAR(30); -- 工资合计

	DECLARE jbtSalary VARCHAR(30); -- 津补贴项金额
	DECLARE newJbtSalary VARCHAR(30); -- 新津补贴项金额

    DECLARE done INT DEFAULT FALSE;
    
	-- 单位所有人员
	DECLARE personJbtId_ CURSOR FOR
   SELECT t117.id from t126 join t125 on t126.id = t125.c06 join t117 on t126.id = t117.c03
		where 1=1 
		and t126.c01 = concat(v_unit_dataId,'')  
		and t117.c04 = concat(jbtId,'') -- 人员津补贴表-津补贴编号  关联型
	  and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
	  and not exists (select 1 from sys_s_data d where d.id = t126.c43 and d.typename = 'is' and d.data_value = '1') -- 不是停发工资的人员
	  and not exists (select 1 from sys_s_data d where d.id = t125.c39 and d.typename = 'is' and d.data_value = '1') -- 不是受处分人员
	  and ifnull(t126.c46,'')=''
	;
 	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
 	set stemIndex = 0;
 	select count(1) into stemNum from sys_s_data where id = gzbzgxfl;
 	if stemNum > 0 then 
	 	select data_value into stemParam from sys_s_data where id = gzbzgxfl;
	else 
		set resultMsg = '更新标准类型传输错误!';leave label_pro;
 	end if;
 	if stemParam = 1 then -- 基本工资标准更新
		call p_salaryUpdate(createrId,unitId,gzbzgxfl,v_unit_dataId,c3,bdsj,xbzsj,jbtId,c7,resultMsg);
		leave label_pro;
 	end if;
 	
 	-- 处理新的标准时间 t123-津补贴标准表 c06
 	select count(1) into stemNum from t123 where position(xbzsj in c06) > 0 ;
 	if stemNum = 0 then 
	 	set stemParam = substring(xbzsj,1,4);-- 新标准时间 年 如: 2016
	 	select count(1) into stemNum from t123 where position(stemParam in c06) > 0 ;
	 	if stemNum = 0 then 
	 		set resultMsg = concat('系统不存在',stemParam,'年新的津补贴标准数据,请系统更新后再操作');
	 		leave label_pro;
	 	else
	 		select c06 into xbzsj from t123 where position(stemParam in c06) > 0 limit 1 ;
	 	end if;
	else 
	 	select c06 into xbzsj from t123 where position(xbzsj in c06) > 0 limit 1 ;
 	end if;
 	
 	select count(1) into stemNum 
 	from t126 join t117 on t126.id = t117.c03 
 	where t126.c01 = v_unit_dataId
 	and t117.c04 = concat(jbtId,'')
 	and ifnull(t117.c01,'') != xbzsj;-- t117.c01 津补贴工作标准时间
 	if stemNum = 0 then
 		set resultMsg = concat('当前单位所有人员的津补贴标准时间为[',xbzsj,'],不用再更新');leave label_pro; 
 	end if;
	select DATE_FORMAT(now(),'%Y-%m-%d') into bdsj;-- 变动时间
	select count(1) into stemNum from data_record_t126 t126 join data_record_t125 t125 
	on t126.changeSign = t125.changeSign and t126.dataId = t125.c06
	where t126.dataclassCode = 't126' and t125.dataclassCode = 't125' and t126.c01 = concat(v_unit_dataId,'')
	and ifnull(t126.allAuditFlag,'')!='2' and t125.c02 > xbzsj;
 	if stemNum > 0 then
 		set resultMsg = concat('当前更新津补贴工资标准时间为[',xbzsj,'],存在人员变动起薪时间在此之后的数据');leave label_pro; 
 	end if;
 	select c27,c20
 	-- c27-公务员规范后津补贴标准使用驻地-码表  c20-单位艰边类别码表
	into dwzdId,dwjblbId
 	from t111 where id = v_unit_dataId;
	
 	select c02 into jbtCode from t116 where id = jbtId;-- t116津补贴项目表c02-津补贴编号

	select DATE_FORMAT(now(),'%Y-%m-%d') into bdsj;-- 变动时间

-- 目前三种津补贴标准
-- JBT00025-公务员规范后津补贴 对应 单位驻地-工资对应职级
-- JBT00004-警衔补贴 对应 衔级
-- JBT00005-艰苦边远地区津贴 对应 艰边类别-工资对应职级
  OPEN personJbtId_;  
  -- 开始循环
  read_loop: LOOP
    -- 提取游标里的数据，这里只有一个，多个的话也一样；
    FETCH personJbtId_ INTO sTemPersonJbtId;
    -- 声明结束的时候
    IF done THEN
      LEAVE read_loop;
    END IF;
    set @done = done;
    select ifnull(c01,''),c03,c07
    into oldJbtbzsj,sTemPersonId,jbtSalary
    -- c01-津补贴时间  c03-人员编号 
    from t117 where id = sTemPersonJbtId;
    select 
    	t125.c24,
    	-- 衔级Id
		t126.c17,ifnull((select d.c05 from t127 d where d.id = t126.c17),ifnull(t126.c17,'')) as gzdyzj,
		-- 工资对应职级
		t125.c27,t125.c32
		-- 津补贴小计 工资合计 工资标准时间
    	into 
    	xjId,
    	gzdyzjId,gzdyzj,
    	jbtxj,gzhj
    from t126 join t125 on t126.id = t125.c06 where t126.id = sTemPersonId;
    set stemNum = 0;-- 变量为0表示 没有更新 变动>0 表示需要更新
	if oldJbtbzsj != xbzsj then -- 旧工资标准时间不是新的
		set @qxsj = substring(xbzsj,1,7);
	    if jbtCode = 'JBT00004' then -- 警衔补贴 JBT00004-警衔补贴 对应 衔级
			select count(1) into stemNum from t123 
			where c03 = jbtId and c08 = xjId 
			and c06 = xbzsj;
			if stemNum > 0 then 
				set stemNum = 1;
			end if;
			select c10 into newJbtSalary from t123 
			where c03 = jbtId and c08 = xjId 
			and c06 = xbzsj limit 1;
			-- t123 津补贴标准表 c03-津补贴编号  c08-衔级 码表 c06标准时间
		else 
		  if jbtCode = 'JBT00025' then -- 公务员规范后津补贴 对应 单位驻地-工资对应职级
			select count(1) into stemNum from t123 
			where c03 = jbtId 
			and ( select 1 from sys_s_data d where d.typename = 'locale' and d.id = t123.c05 and d.id =dwzdId order by data_value desc limit 0,1  ) 
			and c06 = xbzsj
			and exists(select 1 from t127 where t127.id = t123.c07 and t127.c05 = gzdyzj);
			if stemNum > 0 then 
				set stemNum = 1;
			end if;
			select c10 into newJbtSalary from t123 
			where c03 = jbtId 
			and ( select 1 from sys_s_data d where d.typename = 'locale' and d.id = t123.c05 and d.id = dwzdId order by data_value desc limit 0,1  ) 
			and c06 = xbzsj
			and exists(select 1 from t127 where t127.id = t123.c07 and t127.c05 = gzdyzj) limit 1;
			-- t123 津补贴标准表 c03-津补贴编号  c05-单位驻地 码表 c06标准时间 c07-工资对应职级
		  else 
		  	if jbtCode = 'JBT00005' then -- 艰苦边远地区津贴 对应 艰边类别-工资对应职级
				select count(1) into stemNum from t123 
				where c03 = concat(jbtId,'') and c09 = concat(dwjblbId,'') 
				and c06 = xbzsj
				and exists(select 1 from t127 where t127.id = t123.c07 and t127.c05 = gzdyzj);
				if stemNum > 0 then 
					set stemNum = 1;
				end if;
				select c10 into newJbtSalary from t123 
				where c03 = concat(jbtId,'') and c09 = concat(dwjblbId,'') 
				and c06 = xbzsj
				and exists(select 1 from t127 where t127.id = t123.c07 and t127.c05 = gzdyzj) limit 1;
			-- t123 津补贴标准表 c03-津补贴编号  c09-单位艰边类别 码表 c06标准时间 c07-工资对应职级
			end if;
	      end if;
	    end if;
	    if stemNum > 0 then 
			set newJbtxj = jbtxj -  jbtSalary + newJbtSalary + 0;
			if newJbtxj!=jbtxj then 
				set newGzhj = gzhj -  jbtxj + newJbtxj + 0;
				update t126,sys_s_data d set c40 = d.id -- 更新人员的变动类型 
				,t126.c41 = bdsj
				where t126.id = sTemPersonId and d.typename = 'bdlx' and d.data_value = '9002';
				
				update t125 set c02=@qxsj,-- 更新人员工资信息
				c27=newJbtxj,
				c32 = newGzhj where c06 = concat(sTemPersonId,'');
				update t117 set c07 = newJbtSalary,c01=xbzsj
				where id = sTemPersonJbtId;
				call person_insert_record(createrId,unitId,sTemPersonId,resultMsg);-- 插入变动记录
				if resultMsg != '' then leave label_pro;end if;
				set stemIndex = stemIndex+1;
			else 
				update t117 set c01=xbzsj
				where id = sTemPersonJbtId and ifnull(c01,'')='';
			end if;
		end if;
	end if;
    set done = @done;
  END LOOP;
  -- 关闭游标
  CLOSE personJbtId_;
	if stemIndex > 0 then 
		set resultMsg = concat('成功更新[',stemIndex,']人的津补贴工资标准为',xbzsj);
  		call p_fund_updateFlag(v_unit_dataId,@re);-- 变动后更新基金isUPdateFund=1
	else
		set resultMsg = concat('成功更新[',stemIndex,']人的津补贴工资标准为',xbzsj);
	end if;
	leave label_pro;
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`p_tb_jiguan_fgjcg_update`(in userId int(11),IN dwid int(11),IN sTemPersonId int(11),
IN t125c02 varchar(20),
INOUT resultMsg varchar(200) CHARSET utf8)
label_pro:BEGIN	
-- 机关单位人员调标
-- dwid-单位id  personId-人员id t125c02-起薪时间 


	declare qxsj varchar(50)  ;-- 临时变量  起薪时间
	declare bdlx varchar(50)  ;-- 临时变量  变动类型
	declare ryzt varchar(50)  ;-- 临时变量  人员状态
	declare rybh varchar(50)  ;-- 临时变量  人员编号
	declare xm varchar(50)  ;-- 临时变量  姓名
	declare xb varchar(50)  ;-- 临时变量  性别
	-- declare sfz varchar(50)  ;-- 临时变量 身份证
	declare rysf varchar(50)  ;-- 临时变量 人员身份
	declare gzbzlb varchar(50)  ;-- 临时变量 工资标准类别
	declare xl varchar(50)  ;-- 临时变量 学历 
	declare gzdyzj varchar(50)  ;-- 临时变量 工资对应职级
	declare sfld varchar(50)  ;-- 临时变量 是否领导
	declare dc varchar(50)  ;-- 临时变量 档次 
	declare zwdjgz varchar(50)  ;-- 临时变量 职务等级工资 
	declare xj varchar(50)  ;-- 小计

	declare Azwdjgz varchar(50)  ; -- 临时变量  调标后 职务等级工资 
	declare Axj varchar(50)  ;   -- 临时变量 调标后 小计
	
	declare zwjfbl varchar(50)  ;-- 职务计发比例  人员可能存在计发的情况

	
	
	declare chanType varchar(50)  ;-- 调标变动类型
	declare newGzbzlb varchar(50)  ;-- 新的工资标准类别

	set resultMsg='';
	-- 调用调标工资 获取这个人员是否存在变动
	select count(1) into @zcCount
	from data_record_t126 t126,data_record_t125 t125 where t125.changeSign = t126.changeSign 
	and t126.dataId = sTemPersonId -- 人员id
	and t126.c01 = concat(dwid,'')-- 单位id
	and t126.changeType = '11410' -- 人员已经进行调标变动了   基本工资标准更新
	;
	-- 如果这个人员存在变动 基本工资标准更新
	if @zcCount > 0 then 
		-- set resultMsg ='error';
		set resultMsg = '1';
		-- set czMsg = concat(czMsg,ryCode,',',ryName,',已存在此变动|');
		leave label_pro;  -- 返回
	end if;
	
	set @qxsj = '2019-01';-- 默认起薪时间
	set @t125c02 = '';-- 人员在单位最新录入时间
	select t125.c02 into @t125c02
	from data_record_t126 t126,data_record_t125 t125 where t125.changeSign = t126.changeSign 
	and t126.dataId = sTemPersonId -- 人员id
	and t126.c01 = concat(dwid,'')-- 单位id
	and t126.changeType in ('10750','10832') -- 录入新进人员 接收调入人员
	order by t126.id desc limit 1;
	if @t125c02>@qxsj then -- 获取此人在此单位起薪的记录时间，如果最早起薪时间大于起薪时间，使用最早起薪时间作为调标变动起薪时间
		set @qxsj = @t125c02;
	end if;
	
	--  变动未通过审核 
	select count(1) into @bdCount
	from data_record_t126 t126,data_record_t125 t125 where t125.changeSign = t126.changeSign 
	and t126.dataId = sTemPersonId -- 人员id
	and t126.c01 = concat(dwid,'')-- 单位id
	and t125.c02 > @qxsj -- 未通过变动的起薪时间大于调标变动的起薪时间
	and t126.allAuditFlag != 2  -- 
	;
	-- 如是 存在审核未通过 和起薪时间 大于 20
	if @bdCount > 0 then 
		select t125.c02 into @cqxsj -- 超过的起薪时间
		from data_record_t126 t126,data_record_t125 t125 where t125.changeSign = t126.changeSign 
		and t126.dataId = sTemPersonId -- 人员id
		and t126.c01 = concat(dwid,'')-- 单位id
		and t125.c02 > @qxsj -- 未通过变动的起薪时间大于调标变动的起薪时间
		and t126.allAuditFlag != 2  
		order by t126.id limit 1;
		set resultMsg = concat('2,',@cqxsj);
		-- set resultMsg = concat(bdMsg,sTemPersonId,',2,',@cqxsj,'|');
		-- set bdMsg = concat(bdMsg,ryCode,',',ryName,',存在',@cqxsj,'起薪工资变动，删除变动之后再进行调标变动|');
		leave label_pro;
	end if;
		
    SELECT count(1) into @personC from t126,t125
	where t126.id = sTemPersonId -- 人员id
	and t126.c01 = concat(dwid,'')-- 单位id
	and t125.c06 = concat(t126.id,'') -- 人员id
	and t126.c03 != '10372' -- 非离休人员
	and t126.c40 != '10831' -- 非减少人员
	and t126.c28 in  ('11181','11182')  -- 法官 检察官
	;
	if @personC=0 then 
		-- 人员不在这个单位
		set resultMsg = concat(sTemPersonId,',7|');
		leave label_pro;
	end if;
	   
	select t125.c02 into qxsj
    from data_record_t126 t126,data_record_t125 t125 where t125.changeSign = t126.changeSign 
    and t126.dataId = sTemPersonId -- 人员id
    and t126.c01 = concat(dwid,'')-- 单位id
	and t126.changeType in ('10750','10832') -- 录入新进人员 接收调入人员
	order by t126.id desc limit 1;
	if t125c02<qxsj then -- 获取此人在此单位起薪的记录时间，如果传入时间小于起薪时间，使用起薪时间作为调标变动起薪时间
		set t125c02 = qxsj;
	end if;
	
	-- 取此人当前在此单位最新的未审核通过的起薪时间
	select t125.c02 into qxsj
    from data_record_t126 t126,data_record_t125 t125 where t125.changeSign = t126.changeSign 
    and t126.dataId = sTemPersonId -- 人员id
    and t126.c01 = concat(dwid,'')-- 单位id
	and t126.allAuditFlag != 2 
	order by t126.id desc limit 1;
	if t125c02<qxsj then -- 获取此人在此单位最新的未审核通过的起薪时间，如果传入时间小于此起薪时间，使用此起薪时间作为调标变动起薪时间
		set t125c02 = qxsj;
	end if;
	
    select count(1) into @personC 
    from data_record_t126 t126,data_record_t125 t125 where t125.changeSign = t126.changeSign 
    and t126.dataId = sTemPersonId -- 人员id
    and t126.c01 = concat(dwid,'')-- 单位id
    and t125.c02<=t125c02;-- 人员在此单位的起薪时间少于传输的起薪时间
	if @personC=0 then 
		-- 人员不在这个单位
		set resultMsg = concat(sTemPersonId,',7|');
		leave label_pro;
	end if;
	
	set chanType = '11410';-- 设置变动类型 调标
		
    select t126.c02,t126.c04,
    (select name from sys_s_data where id = t126.c05), -- 性别
	-- t126.c07 ,-- 身份证
	t125.c02,-- 起薪时间
    (select name from sys_s_data where id = t126.c28), -- 人员身份
	t126.c39, -- 工资标准类别id
    -- (select name from sys_s_data where id = t126.c39), -- 工资标准类别
    (select name from sys_s_data where id = t126.c09), -- 学历
    (select name from sys_s_data where id = t126.c03), -- 人员状态
    t126.c40 ,-- 变动类型
    (select c05 from t127 where id = t126.c17), -- 工资对应职级
    (select c04 from t127 where id = t126.c27), -- 是否领导
    (select c04 from t127 where id = t125.c09), -- 档次
    round(ifnull(t125.c25,0),2) -- 职务等级工资
    into rybh,xm,xb,qxsj,
    rysf,gzbzlb,xl,ryzt,bdlx,gzdyzj,sfld,dc,
    zwdjgz
    from t126 t126, t125 where t125.c06 = concat(t126.id,'') 
    and t126.id = sTemPersonId;
    
	set newGzbzlb = gzbzlb;-- 默认设置工资标准类别
	
		
    if bdlx != 10831 and bdlx !=  10855 and bdlx != 11187 then
    	-- 如果人员停发  减少 计发生活费 不调标
		set xj = round(ifnull(zwdjgz,0)+0);
		set @oldzwdjgzbz = 0;
		set zwjfbl = 1;-- 默认比例为1
		set Azwdjgz = 0;-- 默认新的为0


		select c06 into @oldzwdjgzbz -- 旧的职务等级工资
			from t127 where c08 = gzbzlb
			and c03 = '职务等级工资'
			and c05 = gzdyzj
			and c04 = dc
			and c01< '2018-07-01'
			order by c01 desc  limit 1;

		if @oldzwdjgzbz > 0 then 
			set zwjfbl = zwdjgz/@oldzwdjgzbz;-- 原来职务等级工资的比例
		end if;
		if zwdjgz=0 then set zwjfbl = 0;set Azwdjgz=0; end if;-- 旧的职务等级工资为0，则新的也为0

	-- 判断是否计发病假  病假取0.7 0.8 0.9  比例为0.75 0.6的归为 计发生活费 人员
		set @zwjfbl=ROUND(zwjfbl,1);
		if  @zwjfbl=0.7 then
		set zwjfbl=ROUND(zwjfbl,1);
		elseif  @zwjfbl=0.8 then
		set zwjfbl=ROUND(zwjfbl,1);
		elseif  @zwjfbl=0.9 then
		set zwjfbl=ROUND(zwjfbl,1);
		else 
			if ROUND(zwjfbl,2)=0.75 then
			set resultMsg = concat(sTemPersonId,',8|');
			leave label_pro;
			elseif ROUND(zwjfbl,1)=0.6 then
			set resultMsg = concat(sTemPersonId,',8|');
			leave label_pro;
			else   
			 set zwjfbl = 1;   -- 非计发生活费 和 计发病假按照正常标准调标
			end if;
		end if;
		if zwjfbl>1 then set zwjfbl = 1;end if; -- 如果本身比例大于1的情况，取比例为1	
		

		if zwjfbl!=0 then -- 比例不为0时，查询新标准

			select c06 into Azwdjgz -- 职务等级工资
			from t127 where c08 = newGzbzlb -- 新的工资标准类别 （
			and c03 = '职务等级工资'
			and c05 = gzdyzj
			and c04 = dc
			and c01<= '2018-07-01'
			order by c01 desc  limit 1;
	
			set Azwdjgz = round(Azwdjgz*zwjfbl,2);
		end if;
		
		
		--  调标后小计
		set Axj = round(ifnull(Azwdjgz,0)+0);
		
		update t126 set c41=DATE_FORMAT(SYSDATE(),'%Y-%m-%d'),c40=chanType,updateDate=SYSDATE(),updaterId=userId,
		c39 = newGzbzlb  -- 新的工资标准类别 
		where id = sTemPersonId;-- 更新人员
		
		update t125 set c02=t125c02,c25 = Azwdjgz,
		c49='2018-07-01' -- 工资标准时间 
		where c06 = concat(sTemPersonId,'');-- 更新人员基本工资项

		update t125 set 
		c32 = ifnull(c25,0)+ifnull(c26,0) +ifnull(c27,0)+0
		where c06 = concat(sTemPersonId,'');-- 更新人员各工资项
		
		call person_insert_record(userId,dwid,sTemPersonId,resultMsg);

    end if;
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`p_tb_jiguan_gr_update`(in userId int(11),IN dwid int(11),IN sTemPersonId int(11),
IN t125c02 varchar(20),
INOUT resultMsg varchar(200) CHARSET utf8)
label_pro:BEGIN
-- 机关单位人员调标
-- dwid-单位id  personId-人员id t125c02-起薪时间


	declare qxsj varchar(50)  ;-- 临时变量  起薪时间
	declare bdlx varchar(50)  ;-- 临时变量  变动类型
	declare ryzt varchar(50)  ;-- 临时变量  人员状态
	declare rybh varchar(50)  ;-- 临时变量  人员编号
	declare xm varchar(50)  ;-- 临时变量  姓名
	declare xb varchar(50)  ;-- 临时变量  性别
	-- declare sfz varchar(50)  ;-- 临时变量 身份证
	declare rysf varchar(50)  ;-- 临时变量 人员身份
	declare gzbzlb varchar(50)  ;-- 临时变量 工资标准类别
	declare xl varchar(50)  ;-- 临时变量 学历
	declare gzdyzj varchar(50)  ;-- 临时变量 工资对应职级
	declare sfld varchar(50)  ;-- 临时变量 是否领导
	declare jb varchar(50)  ;-- 临时变量 级别
	declare dc varchar(50)  ;-- 临时变量 档次
	declare jsdjgz varchar(50)  ;-- 临时变量 技术等级工资
	declare gwgz varchar(50)  ;-- 临时变量 岗位工资
	declare xj varchar(50)  ;-- 小计

	declare Ajsdjgz varchar(50)  ; -- 临时变量  调标后 技术等级工资
	declare Agwgz varchar(50)  ; -- 临时变量  调标后 岗位工资
	declare Axj varchar(50)  ;   -- 临时变量 调标后 小计

	declare zwjfbl varchar(50)  ;-- 职务计发比例  人员可能存在计发的情况
	declare jbjfbl varchar(50)  ;-- 级别计发比例  人员可能存在计发的情况


	declare chanType varchar(50)  ;-- 调标变动类型
	declare newGzbzlb varchar(50)  ;-- 新的工资标准类别


	set resultMsg='';
	-- 调用调标工资 获取这个人员是否存在变动
	select count(1) into @zcCount
	from data_record_t126 t126,data_record_t125 t125 where t125.changeSign = t126.changeSign 
	and t126.dataId = sTemPersonId -- 人员id
	and t126.c01 = concat(dwid,'')-- 单位id
	and t126.changeType = '11410' -- 人员已经进行调标变动了   基本工资标准更新
	;
	-- 如果这个人员存在变动 基本工资标准更新
	if @zcCount > 0 then 
		-- set resultMsg ='error';
		set resultMsg = '1';
		-- set czMsg = concat(czMsg,ryCode,',',ryName,',已存在此变动|');
		leave label_pro;  -- 返回
	end if;
	
	set @qxsj = '2019-01';-- 默认起薪时间
	set @t125c02 = '';-- 人员在单位最新录入时间
	select t125.c02 into @t125c02
	from data_record_t126 t126,data_record_t125 t125 where t125.changeSign = t126.changeSign 
	and t126.dataId = sTemPersonId -- 人员id
	and t126.c01 = concat(dwid,'')-- 单位id
	and t126.changeType in ('10750','10832') -- 录入新进人员 接收调入人员
	order by t126.id desc limit 1;
	if @t125c02>@qxsj then -- 获取此人在此单位起薪的记录时间，如果最早起薪时间大于起薪时间，使用最早起薪时间作为调标变动起薪时间
		set @qxsj = @t125c02;
	end if;
	
	--  变动未通过审核 
	select count(1) into @bdCount
	from data_record_t126 t126,data_record_t125 t125 where t125.changeSign = t126.changeSign 
	and t126.dataId = sTemPersonId -- 人员id
	and t126.c01 = concat(dwid,'')-- 单位id
	and t125.c02 > @qxsj -- 未通过变动的起薪时间大于调标变动的起薪时间
	and t126.allAuditFlag != 2  -- 
	;
	-- 如是 存在审核未通过 和起薪时间 大于 20
	if @bdCount > 0 then 
		select t125.c02 into @cqxsj -- 超过的起薪时间
		from data_record_t126 t126,data_record_t125 t125 where t125.changeSign = t126.changeSign 
		and t126.dataId = sTemPersonId -- 人员id
		and t126.c01 = concat(dwid,'')-- 单位id
		and t125.c02 > @qxsj -- 未通过变动的起薪时间大于调标变动的起薪时间
		and t126.allAuditFlag != 2  
		order by t126.id limit 1;
		set resultMsg = concat('2,',@cqxsj);
		-- set resultMsg = concat(bdMsg,sTemPersonId,',2,',@cqxsj,'|');
		-- set bdMsg = concat(bdMsg,ryCode,',',ryName,',存在',@cqxsj,'起薪工资变动，删除变动之后再进行调标变动|');
		leave label_pro;
	end if;
	
    SELECT count(1) into @personC from t126,t125
	where t126.id = sTemPersonId -- 人员id
	and t126.c01 = concat(dwid,'')-- 单位id
	and t125.c06 = concat(t126.id,'') -- 人员id
	and t126.c03 != '10372' -- 非离休人员
	and t126.c40 != '10831' -- 非减少人员
	and t126.c28 = '10516'  -- 机关工人
	;
	if @personC=0 then
		-- 人员不在这个单位
		set resultMsg = concat(sTemPersonId,',7|');
		leave label_pro;
	end if;

	select t125.c02 into qxsj
    from data_record_t126 t126,data_record_t125 t125 where t125.changeSign = t126.changeSign
    and t126.dataId = sTemPersonId -- 人员id
    and t126.c01 = concat(dwid,'')-- 单位id
	and t126.changeType in ('10750','10832') -- 录入新进人员 接收调入人员
	order by t126.id desc limit 1;
	if t125c02<qxsj then -- 获取此人在此单位起薪的记录时间，如果传入时间小于起薪时间，使用起薪时间作为调标变动起薪时间
		set t125c02 = qxsj;
	end if;

	-- 取此人当前在此单位最新的未审核通过的起薪时间
	select t125.c02 into qxsj
    from data_record_t126 t126,data_record_t125 t125 where t125.changeSign = t126.changeSign
    and t126.dataId = sTemPersonId -- 人员id
    and t126.c01 = concat(dwid,'')-- 单位id
	and t126.allAuditFlag != 2
	order by t126.id desc limit 1;
	if t125c02<qxsj then -- 获取此人在此单位最新的未审核通过的起薪时间，如果传入时间小于此起薪时间，使用此起薪时间作为调标变动起薪时间
		set t125c02 = qxsj;
	end if;

    select count(1) into @personC
    from data_record_t126 t126,data_record_t125 t125 where t125.changeSign = t126.changeSign
    and t126.dataId = sTemPersonId -- 人员id
    and t126.c01 = concat(dwid,'')-- 单位id
    and t125.c02<=t125c02;-- 人员在此单位的起薪时间少于传输的起薪时间
	if @personC=0 then
		-- 人员不在这个单位
		set resultMsg = concat(sTemPersonId,',7|');
		leave label_pro;
	end if;

	set chanType = '11410';-- 设置变动类型 调标

    select t126.c02,t126.c04,
    (select name from sys_s_data where id = t126.c05), -- 性别
	-- t126.c07 ,-- 身份证
	t125.c02,-- 起薪时间
    (select name from sys_s_data where id = t126.c28), -- 人员身份
	t126.c39, -- 工资标准类别id
    -- (select name from sys_s_data where id = t126.c39), -- 工资标准类别
    (select name from sys_s_data where id = t126.c09), -- 学历
    (select name from sys_s_data where id = t126.c03), -- 人员状态
    t126.c40 ,-- 变动类型
    (select c05 from t127 where id = t126.c17), -- 工资对应职级
    (select c04 from t127 where id = t126.c27), -- 是否领导
    (select c05 from t127 where id = t125.c07), -- 级别
    (select c04 from t127 where id = t125.c09), -- 档次

    round(ifnull(t125.c25,0),2), -- 职务岗位工资
    round(ifnull(t125.c26,0),2)  -- 级别工资
    into rybh,xm,xb,qxsj,
    rysf,gzbzlb,xl,ryzt,bdlx,gzdyzj,sfld,jb,dc,
    jsdjgz,gwgz
    from t126 t126, t125 where t125.c06 = concat(t126.id,'')
    and t126.id = sTemPersonId;

	set newGzbzlb = gzbzlb;-- 默认设置工资标准类别


    if bdlx != 10831 and bdlx !=  10855 and bdlx != 11187 then
    	-- 如果人员停发  减少 计发生活费 不调标
		set xj = round(ifnull(jsdjgz,0)+0+ifnull(gwgz,0)+0);
		set @oldjsdjgzbz = 0;
		set @oldgwgzbz = 0;
		set zwjfbl = 1;-- 默认比例为1
		set jbjfbl = 1;-- 默认比例为1
		set Ajsdjgz = 0;-- 默认新的为0
		set Agwgz = 0;-- 默认新的为0
		if  position('期' in gzdyzj)>0 then
		-- 如果是试用期、学徒期、熟练期
			select c06 into @oldjsdjgzbz -- 职务工资
				from t127 where c08 = gzbzlb -- 试用期按照之前的标准读
				and c03 = '技术等级工资'
				and c05 = gzdyzj -- 工资对应职级
				and c04 = xl -- 学历
				and c01< '2018-07-01'
				order by c01 desc  limit 1;
		else

			select c06 into @oldjsdjgzbz -- 旧的技术等级工资
				from t127 where c08 = gzbzlb
				and c03 = '技术等级工资'
				and c05 = gzdyzj -- 工资对应职级
				and c01< '2018-07-01'
				order by c01 desc  limit 1;

			select c06 into @oldgwgzbz -- 旧的级别工资
				from t127 where c08 = gzbzlb
				and c03 = '岗位工资'
				and c05 = gzdyzj
				and c04 = dc
				and c01< '2018-07-01'
				order by c01 desc  limit 1;
		end if;
		if @oldjsdjgzbz > 0 then
			set zwjfbl = jsdjgz/@oldjsdjgzbz;-- 原来职务工资的比例
		end if;
		if jsdjgz=0 then set zwjfbl = 0;set Ajsdjgz=0; end if;-- 旧的职务工资为0，则新的也为0
		if @oldgwgzbz > 0 then
			set jbjfbl = gwgz/@oldgwgzbz;-- 原来级别工资的比例
		end if;
		if gwgz=0 then set jbjfbl = 0;set Agwgz=0; end if;-- 旧级别工资为0 ，则新的也为0
		

	-- 判断是否计发病假  病假取0.7 0.8 0.9  比例为0.75 0.6的归为 计发生活费 人员
		set @zwjfbl=ROUND(zwjfbl,1);
		set @jbjfbl=ROUND(jbjfbl,1);
		if  @zwjfbl=0.7 then
		if @jbjfbl=0 then
		set zwjfbl=ROUND(zwjfbl,1);
		set jbjfbl=ROUND(jbjfbl,1);
		elseif @jbjfbl=0.7 then
		set zwjfbl=ROUND(zwjfbl,1);
		set jbjfbl=ROUND(jbjfbl,1);
		else
			 set zwjfbl = 1;   -- 非计发生活费 和 计发病假按照正常标准调标
			 set jbjfbl = 1;
		end if;
		elseif  @zwjfbl=0.8 then
		if @jbjfbl=0 then
		set zwjfbl=ROUND(zwjfbl,1);
		set jbjfbl=ROUND(jbjfbl,1);
		elseif @jbjfbl=0.8 then
		set zwjfbl=ROUND(zwjfbl,1);
		set jbjfbl=ROUND(jbjfbl,1);
		else
			 set zwjfbl = 1;   -- 非计发生活费 和 计发病假按照正常标准调标
			 set jbjfbl = 1;
		end if;
		elseif  @zwjfbl=0.9 then
		if @jbjfbl=0 then
		set zwjfbl=ROUND(zwjfbl,1);
		set jbjfbl=ROUND(jbjfbl,1);
		elseif @jbjfbl=0.9 then
		set zwjfbl=ROUND(zwjfbl,1);
		set jbjfbl=ROUND(jbjfbl,1);
		else
			 set zwjfbl = 1;   -- 非计发生活费 和 计发病假按照正常标准调标
			 set jbjfbl = 1;
		end if;
		else 
			if ROUND(zwjfbl,2)=0.75 then
			set resultMsg = concat(sTemPersonId,',8|');
			leave label_pro;
			elseif ROUND(zwjfbl,1)=0.6 then
			set resultMsg = concat(sTemPersonId,',8|');
			leave label_pro;
			else   
			 set zwjfbl = 1;   -- 非计发生活费 和 计发病假按照正常标准调标
			 set jbjfbl = 1;
			end if;
		end if;

		if zwjfbl>1 then set zwjfbl = 1;end if; -- 如果本身比例大于1的情况，取比例为1	
		if jbjfbl>1 then set jbjfbl = 1;end if; -- 如果本身比例大于1的情况，取比例为1	

		if zwjfbl!=0 then -- 比例不为0时，查询新标准
			if  position('期' in gzdyzj)>0 then
				select c06 into Ajsdjgz -- 职务工资
				from t127 where c08 = gzbzlb -- 原来的工资标准类别
				and c03 = '技术等级工资'
				and c05 = gzdyzj -- 工资对应职级
				and c04 = xl -- 学历
				and c01<= '2018-07-01'
				order by c01 desc  limit 1;
			else
				select c06 into Ajsdjgz -- 职务工资
				from t127 where c08 = newGzbzlb
				and c03 = '技术等级工资'
				and c05 = gzdyzj -- 工资对应职级
				and c01<= '2018-07-01'
				order by c01 desc  limit 1;
			end if;
			set Ajsdjgz = round(Ajsdjgz*zwjfbl,2); -- 按比例计发 需要保留两位小数
		end if;
		if jbjfbl!=0 then -- 比例不为0时，查询新标准
			if  position('期' in gzdyzj)<1 then
				select c06 into Agwgz -- 级别工资
				from t127 where c08 = newGzbzlb
				and c03 = '岗位工资'
				and c05 = gzdyzj
				and c04 = dc
				and c01<= '2018-07-01'
				order by c01 desc  limit 1;
			end if;
			set Agwgz = round(Agwgz*jbjfbl,2); -- 按比例计发 需要保留两位小数
		end if;

		--  调标后小计
		set Axj = round(ifnull(Ajsdjgz,0)+0+ ifnull(Agwgz,0)+0);

		update t126 set c41=DATE_FORMAT(SYSDATE(),'%Y-%m-%d'),c40=chanType,updateDate=SYSDATE(),updaterId=userId,
		c39 = newGzbzlb  -- 新的工资标准类别
		where id = sTemPersonId;-- 更新人员

		update t125 set c02=t125c02,c25 = Ajsdjgz,c26 = Agwgz,
		c49='2018-07-01' -- 工资标准时间
		where c06 = concat(sTemPersonId,'');-- 更新人员基本工资项

		update t125 set
		c32 = ifnull(c25,0)+ifnull(c26,0) +ifnull(c27,0)+0
		where c06 = concat(sTemPersonId,'');-- 更新人员各工资项

		call person_insert_record(userId,dwid,sTemPersonId,resultMsg);

    end if;
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`p_tb_jiguan_update`(in userId int(11),IN dwid int(11),IN sTemPersonId int(11),
IN t125c02 varchar(20),
INOUT resultMsg varchar(200) CHARSET utf8)
label_pro:BEGIN	
-- 机关单位人员调标
-- dwid-单位id  personId-人员id t125c02-起薪时间 


	declare qxsj varchar(50)  ;-- 临时变量  起薪时间
	declare bdlx varchar(50)  ;-- 临时变量  变动类型
	declare ryzt varchar(50)  ;-- 临时变量  人员状态
	declare rybh varchar(50)  ;-- 临时变量  人员编号
	declare xm varchar(50)  ;-- 临时变量  姓名
	declare xb varchar(50)  ;-- 临时变量  性别
	-- declare sfz varchar(50)  ;-- 临时变量 身份证
	declare rysf varchar(50)  ;-- 临时变量 人员身份
	declare gzbzlb varchar(50)  ;-- 临时变量 工资标准类别
	declare xl varchar(50)  ;-- 临时变量 学历 
	declare gzdyzj varchar(50)  ;-- 临时变量 工资对应职级
	declare sfld varchar(50)  ;-- 临时变量 是否领导
	declare jb varchar(50)  ;-- 临时变量 级别
	declare dc varchar(50)  ;-- 临时变量 档次 
	declare zwgz varchar(50)  ;-- 临时变量 职务工资 
	declare jbgz varchar(50)  ;-- 临时变量 级别工资 
	declare xj varchar(50)  ;-- 小计

	declare Azwgz varchar(50)  ; -- 临时变量  调标后 职务工资 
	declare Ajbgz varchar(50)  ; -- 临时变量  调标后 级别工资 
	declare Axj varchar(50)  ;   -- 临时变量 调标后 小计
	
	declare zwjfbl varchar(50)  ;-- 职务计发比例  人员可能存在计发的情况
	declare jbjfbl varchar(50)  ;-- 级别计发比例  人员可能存在计发的情况
	
	
	declare chanType varchar(50)  ;-- 调标变动类型
	declare newGzbzlb varchar(50)  ;-- 新的工资标准类别

	set resultMsg='';
	-- 调用调标工资 获取这个人员是否存在变动
	select count(1) into @zcCount
	from data_record_t126 t126,data_record_t125 t125 where t125.changeSign = t126.changeSign 
	and t126.dataId = sTemPersonId -- 人员id
	and t126.c01 = concat(dwid,'')-- 单位id
	and t126.changeType = '11410' -- 人员已经进行调标变动了   基本工资标准更新
	;
	-- 如果这个人员存在变动 基本工资标准更新
	if @zcCount > 0 then 
		-- set resultMsg ='error';
		set resultMsg = '1';
		-- set czMsg = concat(czMsg,ryCode,',',ryName,',已存在此变动|');
		leave label_pro;  -- 返回
	end if;
	
	set @qxsj = '2019-01';-- 默认起薪时间
	set @t125c02 = '';-- 人员在单位最新录入时间
	select t125.c02 into @t125c02
	from data_record_t126 t126,data_record_t125 t125 where t125.changeSign = t126.changeSign 
	and t126.dataId = sTemPersonId -- 人员id
	and t126.c01 = concat(dwid,'')-- 单位id
	and t126.changeType in ('10750','10832') -- 录入新进人员 接收调入人员
	order by t126.id desc limit 1;
	if @t125c02>@qxsj then -- 获取此人在此单位起薪的记录时间，如果最早起薪时间大于起薪时间，使用最早起薪时间作为调标变动起薪时间
		set @qxsj = @t125c02;
	end if;
	
	--  变动未通过审核 
	select count(1) into @bdCount
	from data_record_t126 t126,data_record_t125 t125 where t125.changeSign = t126.changeSign 
	and t126.dataId = sTemPersonId -- 人员id
	and t126.c01 = concat(dwid,'')-- 单位id
	and t125.c02 > @qxsj -- 未通过变动的起薪时间大于调标变动的起薪时间
	and t126.allAuditFlag != 2  -- 
	;
	-- 如是 存在审核未通过 和起薪时间 大于 20
	if @bdCount > 0 then 
		select t125.c02 into @cqxsj -- 超过的起薪时间
		from data_record_t126 t126,data_record_t125 t125 where t125.changeSign = t126.changeSign 
		and t126.dataId = sTemPersonId -- 人员id
		and t126.c01 = concat(dwid,'')-- 单位id
		and t125.c02 > @qxsj -- 未通过变动的起薪时间大于调标变动的起薪时间
		and t126.allAuditFlag != 2  
		order by t126.id limit 1;
		set resultMsg = concat('2,',@cqxsj);
		-- set resultMsg = concat(bdMsg,sTemPersonId,',2,',@cqxsj,'|');
		-- set bdMsg = concat(bdMsg,ryCode,',',ryName,',存在',@cqxsj,'起薪工资变动，删除变动之后再进行调标变动|');
		leave label_pro;
	end if;
	
	
    SELECT count(1) into @personC from t126,t125
	where t126.id = sTemPersonId -- 人员id
	and t126.c01 = concat(dwid,'')-- 单位id
	and t125.c06 = concat(t126.id,'') -- 人员id
	and t126.c03 != '10372' -- 非离休人员
	and t126.c40 != '10831' -- 非减少人员
	and t126.c28 in ('10512','10513','10514','10515','11180','11376','11377')  -- 公务员 参公人员 警察 司法行政 司法辅助
	;
	if @personC=0 then 
		-- 人员不在这个单位
		set resultMsg = concat(sTemPersonId,',7|');
		leave label_pro;
	end if;
	   
	select t125.c02 into qxsj
    from data_record_t126 t126,data_record_t125 t125 where t125.changeSign = t126.changeSign 
    and t126.dataId = sTemPersonId -- 人员id
    and t126.c01 = concat(dwid,'')-- 单位id
	and t126.changeType in ('10750','10832') -- 录入新进人员 接收调入人员
	order by t126.id desc limit 1;
	if t125c02<qxsj then -- 获取此人在此单位起薪的记录时间，如果传入时间小于起薪时间，使用起薪时间作为调标变动起薪时间
		set t125c02 = qxsj;
	end if;
	
	-- 取此人当前在此单位最新的未审核通过的起薪时间
	select t125.c02 into qxsj
    from data_record_t126 t126,data_record_t125 t125 where t125.changeSign = t126.changeSign 
    and t126.dataId = sTemPersonId -- 人员id
    and t126.c01 = concat(dwid,'')-- 单位id
	and t126.allAuditFlag != 2 
	order by t126.id desc limit 1;
	if t125c02<qxsj then -- 获取此人在此单位最新的未审核通过的起薪时间，如果传入时间小于此起薪时间，使用此起薪时间作为调标变动起薪时间
		set t125c02 = qxsj;
	end if;
	
    select count(1) into @personC 
    from data_record_t126 t126,data_record_t125 t125 where t125.changeSign = t126.changeSign 
    and t126.dataId = sTemPersonId -- 人员id
    and t126.c01 = concat(dwid,'')-- 单位id
    and t125.c02<=t125c02;-- 人员在此单位的起薪时间少于传输的起薪时间
	if @personC=0 then 
		-- 人员不在这个单位
		set resultMsg = concat(sTemPersonId,',7|');
		leave label_pro;
	end if;
	
	set chanType = '11410';-- 设置变动类型 调标
		
    select t126.c02,t126.c04,
    (select name from sys_s_data where id = t126.c05), -- 性别
	-- t126.c07 ,-- 身份证
	t125.c02,-- 起薪时间
    (select name from sys_s_data where id = t126.c28), -- 人员身份
	t126.c39, -- 工资标准类别id
    -- (select name from sys_s_data where id = t126.c39), -- 工资标准类别
    (select name from sys_s_data where id = t126.c09), -- 学历
    (select name from sys_s_data where id = t126.c03), -- 人员状态
    t126.c40 ,-- 变动类型
    (select c05 from t127 where id = t126.c17), -- 工资对应职级
    (select c04 from t127 where id = t126.c27), -- 是否领导
    (select c05 from t127 where id = t125.c07), -- 级别
    (select c04 from t127 where id = t125.c09), -- 档次

    round(ifnull(t125.c25,0),2), -- 职务岗位工资
    round(ifnull(t125.c26,0),2)  -- 级别工资
    into rybh,xm,xb,qxsj,
    rysf,gzbzlb,xl,ryzt,bdlx,gzdyzj,sfld,jb,dc,
    zwgz,jbgz
    from t126 t126, t125 where t125.c06 = concat(t126.id,'') 
    and t126.id = sTemPersonId;
    
	set newGzbzlb = gzbzlb;-- 默认设置工资标准类别
	

    if bdlx != 10831 and bdlx !=  10855 and bdlx != 11187 then
    	-- 如果人员停发  减少 计发生活费 不调标
		set xj = round(ifnull(zwgz,0)+0+ifnull(jbgz,0)+0);
		set @oldzwgzbz = 0;
		set @oldjbgzbz = 0;
		set zwjfbl = 1;-- 默认比例为1
		set jbjfbl = 1;-- 默认比例为1
		set Azwgz = 0;-- 默认新的为0
		set Ajbgz = 0;-- 默认新的为0
		if  position('期' in gzdyzj)>0 then 
		-- 如果是试用期、学徒期、熟练期
			select c06 into @oldzwgzbz -- 职务工资
				from t127 where c08 = gzbzlb -- 试用期按照之前的标准读
				and c03 = '职务工资'
				and c05 = gzdyzj -- 工资对应职级
				and c04 = xl -- 学历
				and c01< '2018-07-01'
				order by c01 desc  limit 1;
		else
		
			select c06 into @oldzwgzbz -- 旧的职务工资
				from t127 where c08 = gzbzlb 
				and c03 = '职务工资'
				and c04 = sfld  -- 是否领导
				and c05 = gzdyzj -- 工资对应职级
				and c01< '2018-07-01'
				order by c01 desc  limit 1;
				
			select c06 into @oldjbgzbz -- 旧的级别工资
				from t127 where c08 = '10497' -- 警察 司法行政辅助人员  也执行公务员的级别工资
				and c03 = '级别工资'
				and c05 = jb 
				and c04 = dc
				and c01< '2018-07-01'
				order by c01 desc  limit 1;
		end if;
		if @oldzwgzbz > 0 then 
			set zwjfbl = zwgz/@oldzwgzbz;-- 原来职务工资的比例
		end if;
		if zwgz=0 then set zwjfbl = 0;set Azwgz=0; end if;-- 旧的职务工资为0，则新的也为0
		if @oldjbgzbz > 0 then 
			set jbjfbl = jbgz/@oldjbgzbz;-- 原来级别工资的比例
		end if;
		if jbgz=0 then set jbjfbl = 0;set Ajbgz=0; end if;-- 旧级别工资为0 ，则新的也为0

	-- 判断是否计发病假  病假取0.7 0.8 0.9  比例为0.75 0.6的归为 计发生活费 人员
		set @zwjfbl=ROUND(zwjfbl,1);
		set @jbjfbl=ROUND(jbjfbl,1);
		if  @zwjfbl=0.7 then
		if @jbjfbl=0 then
		set zwjfbl=ROUND(zwjfbl,1);
		set jbjfbl=ROUND(jbjfbl,1);
		elseif @jbjfbl=0.7 then
		set zwjfbl=ROUND(zwjfbl,1);
		set jbjfbl=ROUND(jbjfbl,1);
		else
			 set zwjfbl = 1;   -- 非计发生活费 和 计发病假按照正常标准调标
			 set jbjfbl = 1;
		end if;
		elseif  @zwjfbl=0.8 then
		if @jbjfbl=0 then
		set zwjfbl=ROUND(zwjfbl,1);
		set jbjfbl=ROUND(jbjfbl,1);
		elseif @jbjfbl=0.8 then
		set zwjfbl=ROUND(zwjfbl,1);
		set jbjfbl=ROUND(jbjfbl,1);
		else
			 set zwjfbl = 1;   -- 非计发生活费 和 计发病假按照正常标准调标
			 set jbjfbl = 1;
		end if;
		elseif  @zwjfbl=0.9 then
		if @jbjfbl=0 then
		set zwjfbl=ROUND(zwjfbl,1);
		set jbjfbl=ROUND(jbjfbl,1);
		elseif @jbjfbl=0.9 then
		set zwjfbl=ROUND(zwjfbl,1);
		set jbjfbl=ROUND(jbjfbl,1);
		else
			 set zwjfbl = 1;   -- 非计发生活费 和 计发病假按照正常标准调标
			 set jbjfbl = 1;
		end if;
		
		else 
			if ROUND(zwjfbl,2)=0.75 then
			set resultMsg = concat(sTemPersonId,',8|');
			leave label_pro;
			elseif ROUND(zwjfbl,1)=0.6 then
			set resultMsg = concat(sTemPersonId,',8|');
			leave label_pro;
			else   
			 set zwjfbl = 1;   -- 非计发生活费 和 计发病假按照正常标准调标
			 set jbjfbl = 1;
			end if;
		end if;
		
		if zwjfbl>1 then set zwjfbl = 1;end if; -- 如果本身比例大于1的情况，取比例为1	
		if jbjfbl>1 then set jbjfbl = 1;end if; -- 如果本身比例大于1的情况，取比例为1	

		if zwjfbl!=0 then -- 比例不为0时，查询新标准
			if  position('期' in gzdyzj)>0 then 
				select c06 into Azwgz -- 职务工资
				from t127 where c08 = gzbzlb -- 原来的工资标准类别 
				and c03 = '职务工资'
				and c05 = gzdyzj -- 工资对应职级
				and c04 = xl -- 学历
				and c01<= '2018-07-01'
				order by c01 desc  limit 1;
			else 
				select c06 into Azwgz -- 职务工资
				from t127 where c08 = newGzbzlb -- 新的工资标准类别 （
				and c03 = '职务工资'
				and c04 = sfld  -- 是否领导
				and c05 = gzdyzj -- 工资对应职级
				and c01<= '2018-07-01'
				order by c01 desc  limit 1;
			end if;
			set Azwgz = round(Azwgz*zwjfbl,2); -- 保留两位小数
		end if;
		if jbjfbl!=0 then -- 比例不为0时，查询新标准
			if  position('期' in gzdyzj)<1 then
				select c06 into Ajbgz -- 级别工资
				from t127 where c08 = '10497' -- 警察 司法行政辅助人员 也执行公务员的级别工资
				and c03 = '级别工资'
				and c05 = jb 
				and c04 = dc
				and c01<= '2018-07-01'
				order by c01 desc  limit 1;
			end if;
			set Ajbgz = round(Ajbgz*jbjfbl,2); -- 保留两位小数
		end if;
		
		--  调标后小计
		set Axj = round(ifnull(Azwgz,0)+0+ ifnull(Ajbgz,0)+0);
		
		update t126 set c41=DATE_FORMAT(SYSDATE(),'%Y-%m-%d'),c40=chanType,updateDate=SYSDATE(),updaterId=userId,
		c39 = newGzbzlb  -- 新的工资标准类别 
		where id = sTemPersonId;-- 更新人员
		
		update t125 set c02=t125c02,c25 = Azwgz,c26 = Ajbgz,
		c49='2018-07-01' -- 工资标准时间 
		where c06 = concat(sTemPersonId,'');-- 更新人员基本工资项

		update t125 set 
		c32 = ifnull(c25,0)+ifnull(c26,0) +ifnull(c27,0)+0
		where c06 = concat(sTemPersonId,'');-- 更新人员各工资项
		
		call person_insert_record(userId,dwid,sTemPersonId,resultMsg);

    end if;
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`p_tb_lx_update`(in userId int(11),IN dwid int(11),IN sTemPersonId int(11),
IN t125c02 varchar(20),
INOUT resultMsg varchar(200) CHARSET utf8)
label_pro:BEGIN	
-- 机关单位人员调标
-- dwid-单位id  personId-人员id t125c02-起薪时间 


	declare qxsj varchar(50)  ;-- 临时变量  起薪时间
	declare bdlx varchar(50)  ;-- 临时变量  变动类型
	declare ryzt varchar(50)  ;-- 临时变量  人员状态
	declare rybh varchar(50)  ;-- 临时变量  人员编号
	declare xm varchar(50)  ;-- 临时变量  姓名
	declare xb varchar(50)  ;-- 临时变量  性别
	declare rysf varchar(50)  ;-- 临时变量 人员身份
	declare gzbzlb varchar(50)  ;-- 临时变量 工资标准类别
	declare gzdyzj varchar(50)  ;-- 临时变量 工资对应职级
	declare zwgz varchar(50)  ;-- 临时变量 职务工资 

	
	
	
	declare chanType varchar(50)  ;-- 调标变动类型
	declare newGzbzlb varchar(50)  ;-- 新的工资标准类别

	set resultMsg='';
	-- 调用调标工资 获取这个人员是否存在变动
	select count(1) into @zcCount
	from data_record_t126 t126,data_record_t125 t125 where t125.changeSign = t126.changeSign 
	and t126.dataId = sTemPersonId -- 人员id
	and t126.c01 = concat(dwid,'')-- 单位id
	and t126.changeType = '11410' -- 人员已经进行调标变动了   基本工资标准更新
	;
	-- 如果这个人员存在变动 基本工资标准更新
	if @zcCount > 0 then 
		-- set resultMsg ='error';
		set resultMsg = '1';
		-- set czMsg = concat(czMsg,ryCode,',',ryName,',已存在此变动|');
		leave label_pro;  -- 返回
	end if;
	
	set @qxsj = '2019-01';-- 默认起薪时间
	set @t125c02 = '';-- 人员在单位最新录入时间
	select t125.c02 into @t125c02
	from data_record_t126 t126,data_record_t125 t125 where t125.changeSign = t126.changeSign 
	and t126.dataId = sTemPersonId -- 人员id
	and t126.c01 = concat(dwid,'')-- 单位id
	and t126.changeType in ('10750','10832') -- 录入新进人员 接收调入人员
	order by t126.id desc limit 1;
	if @t125c02>@qxsj then -- 获取此人在此单位起薪的记录时间，如果最早起薪时间大于起薪时间，使用最早起薪时间作为调标变动起薪时间
		set @qxsj = @t125c02;
	end if;
	
	--  变动未通过审核 
	select count(1) into @bdCount
	from data_record_t126 t126,data_record_t125 t125 where t125.changeSign = t126.changeSign 
	and t126.dataId = sTemPersonId -- 人员id
	and t126.c01 = concat(dwid,'')-- 单位id
	and t125.c02 > @qxsj -- 未通过变动的起薪时间大于调标变动的起薪时间
	and t126.allAuditFlag != 2  -- 
	;
	-- 如是 存在审核未通过 和起薪时间 大于 20
	if @bdCount > 0 then 
		select t125.c02 into @cqxsj -- 超过的起薪时间
		from data_record_t126 t126,data_record_t125 t125 where t125.changeSign = t126.changeSign 
		and t126.dataId = sTemPersonId -- 人员id
		and t126.c01 = concat(dwid,'')-- 单位id
		and t125.c02 > @qxsj -- 未通过变动的起薪时间大于调标变动的起薪时间
		and t126.allAuditFlag != 2  
		order by t126.id limit 1;
		set resultMsg = concat('2,',@cqxsj);
		-- set resultMsg = concat(bdMsg,sTemPersonId,',2,',@cqxsj,'|');
		-- set bdMsg = concat(bdMsg,ryCode,',',ryName,',存在',@cqxsj,'起薪工资变动，删除变动之后再进行调标变动|');
		leave label_pro;
	end if;
	
    SELECT count(1) into @personC from t126,t125
	where t126.id = sTemPersonId -- 人员id
	and t126.c01 = concat(dwid,'')-- 单位id
	and t125.c06 = concat(t126.id,'') -- 人员id
	and t126.c03 = '10372' -- 离休人员
	and t126.c40 != '10831' -- 非减少人员
	;
	if @personC=0 then 
		-- 人员不在这个单位
		set resultMsg = concat(sTemPersonId,',7|');
		leave label_pro;
	end if;
	   
	select t125.c02 into qxsj
    from data_record_t126 t126,data_record_t125 t125 where t125.changeSign = t126.changeSign 
    and t126.dataId = sTemPersonId -- 人员id
    and t126.c01 = concat(dwid,'')-- 单位id
	and t126.changeType in ('10750','10832') -- 录入新进人员 接收调入人员
	order by t126.id desc limit 1;
	if t125c02<qxsj then -- 获取此人在此单位起薪的记录时间，如果传入时间小于起薪时间，使用起薪时间作为调标变动起薪时间
		set t125c02 = qxsj;
	end if;
	
	-- 取此人当前在此单位最新的未审核通过的起薪时间
	select t125.c02 into qxsj
    from data_record_t126 t126,data_record_t125 t125 where t125.changeSign = t126.changeSign 
    and t126.dataId = sTemPersonId -- 人员id
    and t126.c01 = concat(dwid,'')-- 单位id
	and t126.allAuditFlag != 2 
	order by t126.id desc limit 1;
	if t125c02<qxsj then -- 获取此人在此单位最新的未审核通过的起薪时间，如果传入时间小于此起薪时间，使用此起薪时间作为调标变动起薪时间
		set t125c02 = qxsj;
	end if;
	
    select count(1) into @personC 
    from data_record_t126 t126,data_record_t125 t125 where t125.changeSign = t126.changeSign 
    and t126.dataId = sTemPersonId -- 人员id
    and t126.c01 = concat(dwid,'')-- 单位id
    and t125.c02<=t125c02;-- 人员在此单位的起薪时间少于传输的起薪时间
	if @personC=0 then 
		-- 人员不在这个单位
		set resultMsg = concat(sTemPersonId,',7|');
		leave label_pro;
	end if;
	
	UPDATE t126 a,t125 b,t127 c SET b.c25=(b.c25+1700)
	WHERE a.id=concat(sTemPersonId,'') and b.c06 = concat(a.id,'') AND a.c03='10372' AND a.c17=c.id AND (c.c05='省部级正职' or c.c05='一级职员岗位') AND a.c40!='10831';
	
	UPDATE t126 a,t125 b,t127 c SET b.c25=(b.c25+1150)
	WHERE a.id=concat(sTemPersonId,'') and b.c06 = concat(a.id,'')  AND a.c03='10372' AND a.c17=c.id AND (c.c05='省部级副职' or c.c05='二级职员岗位') AND a.c40!='10831';
	
	UPDATE t126 a,t125 b,t127 c SET b.c25=(b.c25+900) 
	WHERE a.id=concat(sTemPersonId,'') and b.c06 = concat(a.id,'')  AND a.c03='10372' AND a.c17=c.id AND (c.c05='厅局级正职' or c.c05='三级职员岗位') AND a.c40!='10831';
	
	UPDATE t126 a,t125 b,t127 c SET b.c25=(b.c25+750) 
	WHERE a.id=concat(sTemPersonId,'') and b.c06 = concat(a.id,'')  AND a.c03='10372' AND a.c17=c.id AND (c.c05='厅局级副职' or c.c05='四级职员岗位') AND a.c40!='10831';
	
	UPDATE t126 a,t125 b,t127 c SET b.c25=(b.c25+600) 
	WHERE a.id=concat(sTemPersonId,'') and b.c06 = concat(a.id,'')  AND a.c03='10372' AND a.c17=c.id AND (c.c05='县处级正职' or c.c05='五级职员岗位') AND a.c40!='10831';
	
	UPDATE t126 a,t125 b,t127 c SET b.c25=(b.c25+500) 
	WHERE a.id=concat(sTemPersonId,'') and b.c06 = concat(a.id,'')  AND a.c03='10372' AND a.c17=c.id AND (c.c05='县处级副职' or c.c05='六级职员岗位') AND a.c40!='10831';

	UPDATE t126 a,t125 b,t127 c SET b.c25=(b.c25+400) 
	WHERE a.id=concat(sTemPersonId,'') and b.c06 = concat(a.id,'')  AND a.c03='10372' AND a.c17=c.id AND (c.c05 LIKE '乡科级%' or c.c05='七级职员岗位' or c.c05='八级职员岗位') AND a.c40!='10831';
	
	UPDATE t126 a,t125 b,t127 c SET b.c25=(b.c25+820) 
	WHERE a.id=concat(sTemPersonId,'') and b.c06 = concat(a.id,'')  AND a.c03='10372' AND a.c17=c.id AND c.c05='教授' AND a.c40!='10831';

	UPDATE t126 a,t125 b,t127 c SET b.c25=(b.c25+580)
	WHERE a.id=concat(sTemPersonId,'') and b.c06 = concat(a.id,'')  AND a.c03='10372' AND a.c17=c.id AND c.c05='副教授' AND a.c40!='10831';

	UPDATE t126 a,t125 b,t127 c SET b.c25=(b.c25+400) 
	WHERE a.id=concat(sTemPersonId,'') and b.c06 = concat(a.id,'')  AND a.c03='10372' AND a.c17=c.id AND c.c05='讲师' AND a.c40!='10831';

	set chanType = '11410';  -- 设置变动类型 调标
		
    select t126.c02,t126.c04,
    (select name from sys_s_data where id = t126.c05), -- 性别
	-- t126.c07 ,-- 身份证
	t125.c02,-- 起薪时间
    (select name from sys_s_data where id = t126.c28), -- 人员身份
	t126.c39, -- 工资标准类别id
    -- (select name from sys_s_data where id = t126.c39), -- 工资标准类别
    (select name from sys_s_data where id = t126.c03), -- 人员状态
    t126.c40 ,-- 变动类型
    (select c05 from t127 where id = t126.c17) -- 工资对应职级 -- 工资对应职级 金额
    into rybh,xm,xb,qxsj,
    rysf,gzbzlb,ryzt,bdlx,gzdyzj
    from t126 t126, t125 where t125.c06 = concat(t126.id,'') 
    and t126.id = sTemPersonId;
    
	set newGzbzlb = gzbzlb;-- 默认设置工资标准类别
	

    if bdlx != 10831 and bdlx !=  10855 and bdlx != 11187 then
    	-- 如果人员停发  减少 计发生活费 不调标
		
		update t126 set c41=DATE_FORMAT(SYSDATE(),'%Y-%m-%d'),c40=chanType,updateDate=SYSDATE(),updaterId=userId,
		c39 = newGzbzlb  -- 新的工资标准类别 
		where id = sTemPersonId;-- 更新人员
		
		update t125 set c02=t125c02,
		c49='2018-07-01' -- 工资标准时间 
		where c06 = concat(sTemPersonId,'');-- 更新人员基本工资项

		update t125 set 
		c32 = (ifnull(c25,0)+0+ifnull(c27,0)+0)
		where c06 = concat(sTemPersonId,'');-- 更新人员各工资项

		
		call person_insert_record(userId,dwid,sTemPersonId,resultMsg);

    end if;
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`p_tb_shiye_update`(in userId int(11),IN dwid int(11),IN sTemPersonId int(11),
IN t125c02 varchar(20),
INOUT resultMsg varchar(200) CHARSET utf8)
label_pro:BEGIN	

-- 事业单位人员调标
-- dwid-单位id  personId-人员id t125c02-起薪时间 

	declare jslx varchar(50)  ;-- 临时变量  教师类别
	declare qxsj varchar(50)  ;-- 临时变量  起薪时间
	declare bdlx varchar(50)  ;-- 临时变量  变动类型
	declare ryzt varchar(50)  ;-- 临时变量  人员状态
	declare rybh varchar(50)  ;-- 临时变量  人员编号
	declare xm varchar(50)  ;-- 临时变量  姓名
	declare xb varchar(50)  ;-- 临时变量  性别
	-- declare sfz varchar(50)  ;-- 临时变量 身份证
	declare rysf varchar(50)  ;-- 临时变量 人员身份
	declare gzbzlb varchar(50)  ;-- 临时变量 工资标准类别
	declare xl varchar(50)  ;-- 临时变量 学历 
	declare gzdyzj varchar(50)  ;-- 临时变量 工资对应职级
	declare sfld varchar(50)  ;-- 临时变量 是否领导
	declare jb varchar(50)  ;-- 临时变量 级别
	declare dc varchar(50)  ;-- 临时变量 档次 
	declare gwgz varchar(50)  ;-- 临时变量 岗位工资 
	declare xjgz varchar(50)  ;-- 临时变量 薪级工资 
	declare up10 varchar(50)  ;-- 临时变量 提高10%
	declare isUp10 varchar(50)  ;-- 临时变量 是否提高10%
	declare up15 varchar(50)  ;-- 临时变量 提高15%
	declare isUp15 varchar(50)  ;-- 临时变量 是否提高15%
	declare xj varchar(50)  ;-- 小计

	declare Agwgz varchar(50)  ;-- 临时变量  调标后 岗位工资 
	declare Axjgz varchar(50)  ;-- 临时变量 调标后  薪级工资 
	declare Aup15 varchar(50)  ;-- 临时变量 调标后 提高15%
	declare Aup10 varchar(50)  ;-- 临时变量 调标后 提高10%
	declare Axj varchar(50)  ;-- 临时变量 调标后 小计
	
	declare gwjfbl varchar(50)  ;-- 岗位计发比例  人员可能存在计发的情况
	declare xjjfbl varchar(50)  ;-- 薪级计发比例  人员可能存在计发的情况
	
	
	declare chanType varchar(50)  ;-- 调标变动类型
	declare newGzbzlb varchar(50)  ;-- 新的工资标准类别
	
	declare dwjb varchar(50)  ;-- 单位级别 

	
	set resultMsg='';
	-- 调用事业调标工资 获取这个人员是否存在变动
	select count(1) into @zcCount
	from data_record_t126 t126,data_record_t125 t125 where t125.changeSign = t126.changeSign 
	and t126.dataId = sTemPersonId -- 人员id
	and t126.c01 = concat(dwid,'')-- 单位id
	and t126.changeType = '11410' -- 人员已经进行调标变动了   基本工资标准更新
	;
	-- 如果这个人员存在变动 基本工资标准更新
	if @zcCount > 0 then 
		-- set resultMsg ='error';
		set resultMsg = '1';
		-- set czMsg = concat(czMsg,ryCode,',',ryName,',已存在此变动|');
		leave label_pro;  -- 返回
	end if;
	
	set @qxsj = '2019-01';-- 默认起薪时间
	set @t125c02 = '';-- 人员在单位最新录入时间
	select t125.c02 into @t125c02
	from data_record_t126 t126,data_record_t125 t125 where t125.changeSign = t126.changeSign 
	and t126.dataId = sTemPersonId -- 人员id
	and t126.c01 = concat(dwid,'')-- 单位id
	and t126.changeType in ('10750','10832') -- 录入新进人员 接收调入人员
	order by t126.id desc limit 1;
	if @t125c02>@qxsj then -- 获取此人在此单位起薪的记录时间，如果最早起薪时间大于起薪时间，使用最早起薪时间作为调标变动起薪时间
		set @qxsj = @t125c02;
	end if;
	
	--  变动未通过审核 
	select count(1) into @bdCount
	from data_record_t126 t126,data_record_t125 t125 where t125.changeSign = t126.changeSign 
	and t126.dataId = sTemPersonId -- 人员id
	and t126.c01 = concat(dwid,'')-- 单位id
	and t125.c02 > @qxsj -- 未通过变动的起薪时间大于调标变动的起薪时间
	and t126.allAuditFlag != 2  -- 
	;
	-- 如是 存在审核未通过 和起薪时间 大于 20
	if @bdCount > 0 then 
		select t125.c02 into @cqxsj -- 超过的起薪时间
		from data_record_t126 t126,data_record_t125 t125 where t125.changeSign = t126.changeSign 
		and t126.dataId = sTemPersonId -- 人员id
		and t126.c01 = concat(dwid,'')-- 单位id
		and t125.c02 > @qxsj -- 未通过变动的起薪时间大于调标变动的起薪时间
		and t126.allAuditFlag != 2  
		order by t126.id limit 1;
		set resultMsg = concat('2,',@cqxsj);
		-- set resultMsg = concat(bdMsg,sTemPersonId,',2,',@cqxsj,'|');
		-- set bdMsg = concat(bdMsg,ryCode,',',ryName,',存在',@cqxsj,'起薪工资变动，删除变动之后再进行调标变动|');
		leave label_pro;
	end if;

	
	
	
	-- 查询这人的情况 对条件进行过滤
    SELECT count(1) into @personC from t126 ,t125
	where t126.id = sTemPersonId -- 人员id
	and t126.c01 = concat(dwid,'')-- 单位id
	and t125.c06 = concat(t126.id,'') -- 人员id
	and t126.c03 != '10372' -- 非离休人员
	and t126.c40 != '10831' -- 非减少人员
	and t126.c28 in( '10518','10519','10520') -- 管理人员 专业技术人员 事业工人 10522-运动员（运动员不调标）
	-- and t125.c01 = '11537' -- 义务教育教师
	;
    -- 判断人员 存在
	if @personC=0 then 
		-- 人员不在这个单位
		set resultMsg = concat(sTemPersonId,',7|');
		leave label_pro;
	end if;
	
    -- 查询起薪时间 放入起薪时间
	select t125.c02 into qxsj
    from data_record_t126 t126,data_record_t125 t125 where t125.changeSign = t126.changeSign 
    and t126.dataId = sTemPersonId -- 人员id
    and t126.c01 = concat(dwid,'')-- 单位id
	and t126.changeType in ('10750','10832') -- 录入新进人员10750 10832接收调入人员
	order by t126.id desc limit 1;
	if t125c02<qxsj then -- 获取此人在此单位起薪的记录时间，如果传入时间小于起薪时间，使用起薪时间作为调标变动起薪时间
		set t125c02 = qxsj;
	end if;
	
	-- 取此人当前在此单位最新的未审核通过的起薪时间 
	select t125.c02 into qxsj
    from data_record_t126 t126,data_record_t125 t125 where t125.changeSign = t126.changeSign 
    and t126.dataId = sTemPersonId -- 人员id
    and t126.c01 = concat(dwid,'')-- 单位id
	and t126.allAuditFlag != 2 
	order by t126.id desc limit 1;
	if t125c02<qxsj then -- 获取此人在此单位最新的未审核通过的起薪时间，如果传入时间小于此起薪时间，使用此起薪时间作为调标变动起薪时间
		set t125c02 = qxsj;
	end if;
	
    select count(1) into @personC 
    from data_record_t126 t126,data_record_t125 t125 where t125.changeSign = t126.changeSign 
    and t126.dataId = sTemPersonId -- 人员id
    and t126.c01 = concat(dwid,'')-- 单位id
    and t125.c02<=t125c02;-- 人员在此单位的起薪时间少于传输的起薪时间
	if @personC=0 then  
		-- 人员不在这个单位
		set resultMsg = concat(sTemPersonId,',7|');
		leave label_pro;
	end if;
	
	set chanType = '11410';-- 设置变动类型 调标
		
    select t125.c01,t126.c02,t126.c04,
    (select name from sys_s_data where id = t126.c05), -- 性别
	-- t126.c07 ,-- 身份证
	t125.c02,-- 起薪时间
    (select name from sys_s_data where id = t126.c28), -- 人员身份
	t126.c39, -- 工资标准类别id
    -- (select name from sys_s_data where id = t126.c39), -- 工资标准类别
    (select name from sys_s_data where id = t126.c09), -- 学历
    (select name from sys_s_data where id = t126.c03), -- 人员状态
    t126.c40 ,-- 变动类型
    (select c05 from t127 where id = t126.c17), -- 工资对应职级
    (select c04 from t127 where id = t126.c27), -- 是否领导
    (select c05 from t127 where id = t125.c07), -- 级别
    (select c04 from t127 where id = t125.c09), -- 档次、薪级
    t125.c35, -- 是否提高15%
    t125.c23, -- 是否提高10%
    round(ifnull(t125.c25,0),2),-- 职务岗位工资
    round(ifnull(t125.c26,0),2),-- 薪级工资
    round(ifnull(t125.c28,0),2),-- 提高10
    round(ifnull(t125.c29,0),2) -- 提高15
    into jslx,rybh,xm,xb,qxsj,
    rysf,gzbzlb,xl,ryzt,bdlx,gzdyzj,sfld,jb,dc,isUp15,isUp10,
    gwgz,xjgz,up10,up15
    from t126 t126, t125 where t125.c06 = concat(t126.id,'') 
    and t126.id = sTemPersonId;
    
	set newGzbzlb = gzbzlb;-- 默认设置工资标准类别
	if jslx = '11537' then 
		-- 如果是义务教育教师
		set newGzbzlb = '11538';-- 事业义务教育教师
	end if;

    if bdlx != 10831 and bdlx !=  10855 then
    	-- 如果人员停发  减少 计发生活费 不调标
		set xj = round(ifnull(gwgz,0)+0+ ifnull(xjgz,0)+0+ ifnull(up10,0)+ ifnull(up15,0));
		set @oldgwgzbz = 0;
		set @oldxjgzbz = 0;
		set gwjfbl = 1;-- 默认比例为1
		set xjjfbl = 1;-- 默认比例为1
		set Agwgz = 0;-- 默认新的为0
		set Axjgz = 0;-- 默认新的为0

		select c10 into dwjb from t111 where id = dwid;  -- 获取单位级别 10324-副地厅级

		if  position('期' in gzdyzj)>0 then 
		-- 如果是试用期、学徒期、熟练期
			if jslx = '11537' then -- 如果是义务教育，试用期读取专业技术人员的标准
				select c06 into @oldgwgzbz -- 岗位工资
					from t127 where c08 = '11335' -- 试用期标准
					and c03 = '岗位工资'
					and c05 = gzdyzj -- 工资对应职级
					and c04 = xl -- 学历
					and c01< '2018-07-01'
					order by c01 desc  limit 1;
			else 
				select c06 into @oldgwgzbz -- 岗位工资
					from t127 where c08 = gzbzlb -- 试用期按照之前的标准读
					and c03 = '岗位工资'
					and c05 = gzdyzj -- 工资对应职级
					and c04 = xl -- 学历
					and c01< '2018-07-01'
					order by c01 desc  limit 1;
			end if; 
		else
			if jslx = '11537' then 
				-- 如果是义务教育教师
				set isUp10 = 0;-- 非试用期无提高10%
			end if;
			if rysf ='管理人员' then -- 管理人员
				if dwjb = '10324' and (position('四级职员' in gzdyzj) > 0 or position('五级职员' in gzdyzj) > 0 ) then   -- 10324 副地厅级
					select c06 into @oldgwgzbz -- 岗位工资
					from t127 where c08 = gzbzlb -- 旧的岗位工资
					and c03 = '岗位工资'
					and c05 = gzdyzj -- 工资对应职级 副地厅级单位四五级职员按照领导非领导读取
					and c04 = sfld   --  是否领导
					and c01 < '2018-07-01'
					order by c01 desc  limit 1;
				else 
					select c06 into @oldgwgzbz -- 岗位工资
					from t127 where c08 = gzbzlb -- 旧的岗位工资
					and c03 = '岗位工资'
					and c05 = gzdyzj -- 工资对应职级
					and c04 = '非领导职务' 
					and c01< '2018-07-01'
					order by c01 desc  limit 1;
				end if;
			else 
				select c06 into @oldgwgzbz -- 岗位工资
				from t127 where c08 = gzbzlb -- 旧的岗位工资
				and c03 = '岗位工资'
				and c05 = gzdyzj -- 工资对应职级
				and c01< '2018-07-01'
				order by c01 desc  limit 1;
			end if; 
			select c06 into @oldxjgzbz -- 岗位工资
				from t127 where c08 = gzbzlb -- 新的岗位工资
				and c03 = '薪级工资'
				and c04 = dc -- 工资对应职级
				and c01< '2018-07-01'
				order by c01 desc  limit 1;
		end if;
		if @oldgwgzbz > 0 then 
			set gwjfbl = gwgz/@oldgwgzbz;-- 原来岗位工资的比例
		end if;
		if gwgz=0 then set gwjfbl = 0;set Agwgz=0; end if;-- 旧的岗位工资为0，则新的也为0
		if @oldxjgzbz > 0 then 
			set xjjfbl = xjgz/@oldxjgzbz;-- 原来薪级工资的比例
		end if;
		if xjgz=0 then set xjjfbl = 0;set Axjgz=0; end if;-- 旧薪级工资为0 ，则新的也为0

		-- 判断是否计发病假  病假取0.7 0.8 0.9  比例为0.75 0.6的归为 计发生活费 人员
		set @gwjfbl=ROUND(gwjfbl,1);
		set @xjjfbl=ROUND(xjjfbl,1);
		if  @gwjfbl=0.7 then
		if @xjjfbl=0 then
		set gwjfbl=ROUND(gwjfbl,1);
		set xjjfbl=ROUND(xjjfbl,1);
		elseif @xjjfbl=0.7 then
		set gwjfbl=ROUND(gwjfbl,1);
		set xjjfbl=ROUND(xjjfbl,1);
		else
			 set gwjfbl = 1;   -- 非计发生活费 和 计发病假按照正常标准调标
			 set xjjfbl = 1;
		end if;
		elseif  @gwjfbl=0.8 then
		if @xjjfbl=0 then
		set gwjfbl=ROUND(gwjfbl,1);
		set xjjfbl=ROUND(xjjfbl,1);
		elseif @xjjfbl=0.8 then
		set gwjfbl=ROUND(gwjfbl,1);
		set xjjfbl=ROUND(xjjfbl,1);
		else
			 set gwjfbl = 1;   -- 非计发生活费 和 计发病假按照正常标准调标
			 set xjjfbl = 1;
		end if;
		elseif  @gwjfbl=0.9 then
		if @xjjfbl=0 then
		set gwjfbl=ROUND(gwjfbl,1);
		set xjjfbl=ROUND(xjjfbl,1);
		elseif @xjjfbl=0.9 then
		set gwjfbl=ROUND(gwjfbl,1);
		set xjjfbl=ROUND(xjjfbl,1);
		else
			 set gwjfbl = 1;   -- 非计发生活费 和 计发病假按照正常标准调标
			 set xjjfbl = 1;
		end if;
		else 
			if ROUND(gwjfbl,2)=0.75 then
			set resultMsg = concat(sTemPersonId,',8|');
			leave label_pro;
			elseif ROUND(gwjfbl,1)=0.6 then
			set resultMsg = concat(sTemPersonId,',8|');
			leave label_pro;
			else   
			 set xjjfbl = 1;   -- 非计发生活费 和 计发病假按照正常标准调标
			 set gwjfbl = 1;
			end if;
		end if;
		
		if xjjfbl>1 then set xjjfbl = 1;end if;-- 如果本身比例大于1的情况，取比例为1
		if gwjfbl>1 then set gwjfbl = 1;end if;	-- 如果本身比例大于1的情况，取比例为1	
		if gwjfbl!=0 then -- 比例不为0时，查询新标准
			if  position('期' in gzdyzj)>0 then 
				if jslx = '11537' then -- 如果是义务教育，试用期读取专业技术人员的标准
					select c06 into Agwgz -- 岗位工资
					from t127 where c08 = '11335' -- 试用期标准
					and c03 = '岗位工资'
					and c05 = gzdyzj -- 工资对应职级
					and c04 = xl -- 学历
					and c01<='2018-07-01'
					order by c01 desc  limit 1;
				else 
					select c06 into Agwgz -- 岗位工资
					from t127 where c08 = gzbzlb -- 原来的工资标准类别 义务教育教师试用期是专业技术人员的试用期
					and c03 = '岗位工资'
					and c05 = gzdyzj -- 工资对应职级
					and c04 = xl -- 学历
					and c01<= '2018-07-01'
					order by c01 desc  limit 1;
				end if;
			else 
				if rysf ='管理人员' then -- 管理人员
					if dwjb = '10324' and (position('四级职员' in gzdyzj) > 0 or position('五级职员' in gzdyzj) > 0 ) then   -- 10324 副地厅级 
				 		select c06 into Agwgz -- 岗位工资
						from t127 where c08 = newGzbzlb -- 新的工资标准类别 （事业义务教育教师，这个是新的）
						and c03 = '岗位工资'
						and c05 = gzdyzj -- 工资对应职级 副地厅级单位四五级职员按照领导非领导读取
						and c04 = sfld   --  是否领导
						and c01 <= '2018-07-01'
						order by c01 desc  limit 1;
					else 
						select c06 into Agwgz -- 岗位工资
						from t127 where c08 = newGzbzlb -- 新的工资标准类别 （事业义务教育教师，这个是新的）
						and c03 = '岗位工资'
						and c05 = gzdyzj -- 工资对应职级
						and c04 = '非领导职务' -- 非副地厅级单位四五级职员按照非领导读取
						and c01 <= '2018-07-01'
						order by c01 desc  limit 1;
					end if;
				else  -- 专业技术人员 与 事业工人 都不需要是否领导条件
					select c06 into Agwgz -- 岗位工资
					from t127 where c08 = newGzbzlb -- 新的工资标准类别 （事业义务教育教师，这个是新的）
					and c03 = '岗位工资'
					and c05 = gzdyzj -- 工资对应职级
					and c01<= '2018-07-01'
					order by c01 desc  limit 1;
				end if;
			end if;
			if position('四级职员' in gzdyzj) > 0 or position('五级职员' in gzdyzj) > 0 then     
				set gwjfbl = 1;-- 目前系统里面四五级职员工资无需按比例计算，一阶段都算入正常人员调标了
				set xjjfbl = 1;
			end if;
			set Agwgz = round(Agwgz*gwjfbl,2);
		end if;
		if xjjfbl!=0 then -- 比例不为0时，查询新标准
			if  position('期' in gzdyzj)<1 then
				select c06 into Axjgz -- 薪级工资
				from t127 where c08 = newGzbzlb -- 新的工资标准类别 （事业义务教育教师，这个是新的）
				and c03 = '薪级工资'
				and c04 = dc -- 薪级、档次
				and c01<= '2018-07-01'
				order by c01 desc  limit 1;
			end if;
			set Axjgz = round(Axjgz*xjjfbl,2);
		end if;
		set Aup10 = 0;
		if isUp10 = 10487 then -- 如果要提高10%
			set Aup10 = round((ifnull(Agwgz,0)+0+ ifnull(Axjgz,0)+0)*0.10);
		end if;
		set Aup15 = 0;
		if isUp15 = 10487 then -- 如果要提高15%
			set Aup15 = round((ifnull(Agwgz,0)+0+ ifnull(Axjgz,0)+0+ ifnull(Aup10,0)+0)*0.15);
		end if;
		-- 调标后小计
		set Axj = round(ifnull(Agwgz,0)+0+ ifnull(Axjgz,0)+0+ifnull(Aup10,0)+0+ifnull(Aup15,0));
		
		update t126 set c41=DATE_FORMAT(SYSDATE(),'%Y-%m-%d'),c40=chanType,updateDate=SYSDATE(),updaterId=userId,
		c39 = newGzbzlb  -- 新的工资标准类别 （事业义务教育教师，这个是新的）
		where id = sTemPersonId;-- 更新人员
		
		update t125 set c02=t125c02,c25 = Agwgz,c26 = Axjgz,c28=Aup10,c29=Aup15,
		c49='2018-07-01' -- 工资标准时间 
		where c06 = concat(sTemPersonId,'');-- 更新人员基本工资项

		update t125 set 
		c32 = ifnull(c25,0)+ifnull(c26,0) + ifnull(c28,0) + ifnull(c29,0) + ifnull(c30,0) + ifnull(c31,0)+ifnull(c27,0)+ifnull(c44,0)+ifnull(c45,0)+ifnull(c47,0) +0
		where c06 = concat(sTemPersonId,'');-- 更新人员各工资项
		
		call person_insert_record(userId,dwid,sTemPersonId,resultMsg);

    end if;
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`p_tb_ywjy_add`(IN dwid int(11),IN mon int(11),
INOUT resultMsg varchar(200) CHARSET utf8)
label_pro:BEGIN	
-- dwid 单位id mon-月份 (7,8,...13)
-- 义务教育正常人员进入 义务教育表
-- 义务教育正常人员按照月份进入 义务教育表
	declare sTemPersonId int(11) ;-- 临时变量 人员id
	declare tempMonth varchar(20) default '2018-07' ;-- 临时变量 月份

	declare t126RId int(11) default 0 ;-- 临时变量  变动记录id
	declare qxsj varchar(50)  ;-- 临时变量  起薪时间
	declare bdlx varchar(50)  ;-- 临时变量  变动类型
	declare ryzt varchar(50)  ;-- 临时变量  人员状态
	declare rybh varchar(50)  ;-- 临时变量  人员编号
	declare xm varchar(50)  ;-- 临时变量  姓名
	declare xb varchar(50)  ;-- 临时变量  性别
	declare sfz varchar(50)  ;-- 临时变量 身份证
	declare rysf varchar(50)  ;-- 临时变量 人员身份
	declare gzbzlb varchar(50)  ;-- 临时变量 工资标准类别
	declare xl varchar(50)  ;-- 临时变量 学历 
	declare gzdyzj varchar(50)  ;-- 临时变量 工资对应职级
	declare sfld varchar(50)  ;-- 临时变量 是否领导
	declare jb varchar(50)  ;-- 临时变量 级别
	declare dc varchar(50)  ;-- 临时变量 档次 
	declare gwgz varchar(50)  ;-- 临时变量 岗位工资 
	declare xjgz varchar(50)  ;-- 临时变量 薪级工资 
	declare up10 varchar(50)  ;-- 临时变量 提高10%
	declare isUp10 varchar(50)  ;-- 临时变量 是否提高10%
	declare up15 varchar(50)  ;-- 临时变量 提高15%
	declare isUp15 varchar(50)  ;-- 临时变量 是否提高15%
	declare xj varchar(50)  ;-- 小计

	declare Agwgz varchar(50)  ;-- 临时变量  调标后 岗位工资 
	declare Axjgz varchar(50)  ;-- 临时变量 调标后  薪级工资 
	declare Aup15 varchar(50)  ;-- 临时变量 调标后 提高15%
	declare Aup10 varchar(50)  ;-- 临时变量 调标后 提高10%
	declare Axj varchar(50)  ;-- 临时变量 调标后 小计
	
	declare fill varchar(50)  ;-- 临时变量 补发额
	
	declare gwjfbl varchar(50)  ;-- 岗位计发比例  人员可能存在计发的情况
	declare xjjfbl varchar(50)  ;-- 薪级计发比例  人员可能存在计发的情况

	

	DECLARE done INT DEFAULT FALSE;
	-- 获取人员在月份对应数据
	-- 获取单位所有当前表里面的专业技术人员名单
	DECLARE t126_ids CURSOR FOR
    SELECT distinct t126.id from t126 ,t125
	where t126.c01 = concat(dwid,'') -- 单位id
	and t125.c06 = concat(t126.id,'') -- 人员id
	and t126.c03 != '10372' -- 非离休人员
	and t126.c28 = '10519' -- 专业技术人员
	and t125.c01 = '11537' -- 义务教育教师
	and not exists(select 1 from adjustwage.exadjust e where e.ryId = t126.id) -- 人员不在异常人员名单中
	order by t126.id
	-- 人员身份类型  
	;
 	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
 	
 	
	OPEN t126_ids;  
  	-- 开始循环
		read_loop: LOOP
    	-- 提取游标里的数据，这里只有一个，多个的话也一样；
		FETCH t126_ids INTO sTemPersonId;
		-- 声明结束的时候
			IF done THEN
			  LEAVE read_loop;
			END IF;
			set @done = done;
			if mon < 13 then 
				set tempMonth = DATE_FORMAT(DATE_ADD('2018-01-01',INTERVAL (mon-1) month),'%Y-%m');-- 获取起薪时间
			else 
				set tempMonth = '2018-12';-- 如果月份>12表示 13薪
		    end if;
		    select count(1) into @personC 
		     from data_record_t126 t126,data_record_t125 t125 where t125.changeSign = t126.changeSign 
		    and t126.dataId = sTemPersonId
			and t126.allAuditFlag = 2 -- 审核通过的变动记录
		    and t125.c02<=tempMonth;
		    if @personC>0 then 
			    select t126.id,t126.c02,t126.c04,
			    (select name from sys_s_data where id = t126.c05), -- 性别
				t126.c07 ,-- 身份证
				t125.c02,-- 起薪时间
			    (select name from sys_s_data where id = t126.c28), -- 人员身份
				t126.c39, -- 工资标准类别id
			    -- (select name from sys_s_data where id = t126.c39), -- 工资标准类别
			    (select name from sys_s_data where id = t126.c09), -- 学历
			    (select name from sys_s_data where id = t126.c03), -- 人员状态
			    t126.changeType ,-- 变动类型
			    (select c05 from t127 where id = t126.c17), -- 工资对应职级
			    (select c04 from t127 where id = t126.c27), -- 是否领导
			    (select c05 from t127 where id = t125.c07), -- 级别
			    (select c04 from t127 where id = t125.c09), -- 档次、薪级
			    t125.c35, -- 是否提高15%
			    t125.c23, -- 是否提高10%
			    round(ifnull(t125.c25,0)),-- 职务岗位工资
			    round(ifnull(t125.c26,0)),-- 薪级工资
			    round(ifnull(t125.c28,0)),-- 提高10
			    round(ifnull(t125.c29,0)) -- 提高15
			    into t126RId,rybh,xm,xb,sfz,qxsj,
			    rysf,gzbzlb,xl,ryzt,bdlx,gzdyzj,sfld,jb,dc,isUp15,isUp10,
			    gwgz,xjgz,up10,up15
			    from data_record_t126 t126,data_record_t125 t125 where t125.changeSign = t126.changeSign 
			    and t126.dataId = sTemPersonId
			    and t125.c02<=tempMonth
			    and t126.allAuditFlag = 2 -- 审核通过的变动记录
			    and t126.changeType not in ('10751','11530','11532','11414')
			    -- 10751-人员基础信息修改  11530 -其它变动  11532-人员统发信息变动  11414-年度工龄变更
			    order by t126.id desc,t125.c02 DESC limit 1;
			    if bdlx = 10831 or bdlx =  10855 then 
			    	-- 如果是10831-人员减少 10855-停发工资
					insert into adjustwage.ywjyadjust(unitId,ryId,rybh,name,idcard,month,
					job,rankLevel,jobSalary,levelSalary,teacherNurseUp10,specialTeach,subTotal,
					jobSalaryAfter,levelSalaryAfter,specialTeachAfter,subTotalAfter,fill,remark,nt,rysf,recordId)
				    values(dwId,sTemPersonId,rybh,xm,sfz,mon,
				    gzdyzj,dc,0,0,0,0,0,0,0,0,0,0,'','',rysf,t126RId);
				else
					set xj = round(ifnull(gwgz,0)+0+ ifnull(xjgz,0)+0+ ifnull(up10,0)+ ifnull(up15,0));
					set @oldgwgzbz = 0;
					set @oldxjgzbz = 0;
					set gwjfbl = 1;-- 默认比例为1
					set xjjfbl = 1;-- 默认比例为1
					set Agwgz = 0;-- 默认新的为0
					set Axjgz = 0;-- 默认新的为0
					if  position('期' in gzdyzj)>0 then 
					-- 如果是试用期、学徒期、熟练期
						select c06 into @oldgwgzbz -- 岗位工资
							from t127 where c08 = gzbzlb -- 事业义务教育教师
							and c03 = '岗位工资'
							and c05 = gzdyzj -- 工资对应职级
							and c04 = xl -- 学历
							and c01< '2018-07-01'
							order by c01 desc  limit 1;
					else
						set isUp10 = 0;-- 非试用期无提高10%
						select c06 into @oldgwgzbz -- 岗位工资
							from t127 where c08 = gzbzlb -- 事业义务教育教师
							and c03 = '岗位工资'
							and c05 = gzdyzj -- 工资对应职级
							and c01< '2018-07-01'
							order by c01 desc  limit 1;
							
						select c06 into @oldxjgzbz -- 岗位工资
							from t127 where c08 = gzbzlb -- 事业义务教育教师
							and c03 = '薪级工资'
							and c05 = dc -- 工资对应职级
							and c01< '2018-07-01'
							order by c01 desc  limit 1;
					end if;
					if @oldgwgzbz > 0 then 
						set gwjfbl = gwgz/@oldgwgzbz;-- 原来岗位工资的比例
					end if;
					if gwgz=0 then set gwjfbl = 0;set Agwgz=0; end if;-- 旧的岗位工资为0，则新的也为0
					if @oldxjgzbz > 0 then 
						set xjjfbl = xjgz/@oldxjgzbz;-- 原来薪级工资的比例
					end if;
					if xjgz=0 then set xjjfbl = 0;set Axjgz=0; end if;-- 旧薪级工资为0 ，则新的也为0
					if rysf = '专业技术人员' then 
						if gwjfbl!=0 then -- 比例不为0时，查询新标准
							if  position('期' in gzdyzj)>0 then 
								select c06 into Agwgz -- 岗位工资
								from t127 where c08 = gzbzlb -- 原来的工资标准类别 义务教育教师试用期是专业技术人员的试用期
								and c03 = '岗位工资'
								and c05 = gzdyzj -- 工资对应职级
								and c04 = xl -- 学历
								and c01<= '2018-07-01'
								order by c01 desc  limit 1;
							else 
								select c06 into Agwgz -- 岗位工资
								from t127 where c08 = '11538' -- 事业义务教育教师
								and c03 = '岗位工资'
								and c05 = gzdyzj -- 工资对应职级
								and c01<= '2018-07-01'
								order by c01 desc  limit 1;
							end if;
							set Agwgz = round(Agwgz*gwjfbl);
						end if;
						if xjjfbl!=0 then -- 比例不为0时，查询新标准
							if  position('期' in gzdyzj)<1 then
								select c06 into Axjgz -- 薪级工资
								from t127 where c08 = '11538' -- 事业义务教育教师
								and c03 = '薪级工资'
								and c04 = dc -- 工资对应职级
								and c01<= '2018-07-01'
								order by c01 desc  limit 1;
							end if;
							set Axjgz = round(Axjgz*xjjfbl);
						end if;
						set Aup10 = 0;
						if isUp10 = 10487 then -- 如果要提高10%
							set Aup10 = round((ifnull(Agwgz,0)+0+ ifnull(Axjgz,0)+0)*0.10);
						end if;
						set Aup15 = 0;
						if isUp15 = 10487 then -- 如果要提高15%
							set Aup15 = round((ifnull(Agwgz,0)+0+ ifnull(Axjgz,0)+0+ ifnull(Aup10,0)+0)*0.15);
						end if;
						-- 调标后小计
						set Axj = round(ifnull(Agwgz,0)+0+ ifnull(Axjgz,0)+0+ifnull(Aup10,0)+0+ifnull(Aup15,0));
						-- 补发额 
						set fill = round(ifnull(Axj,0)+0-ifnull(xj,0)+0.1); 
						insert into adjustwage.ywjyadjust(unitId,ryId,rybh,name,idcard,month,
						job,rankLevel,jobSalary,levelSalary,teacherNurseUp10,specialTeach,subTotal,
						jobSalaryAfter,levelSalaryAfter,teacherNurseUp10After,specialTeachAfter,
						subTotalAfter,fill,remark,nt,rysf,recordId)
					    values(dwId,sTemPersonId,rybh,xm,sfz,mon,
					    gzdyzj,dc,gwgz,xjgz,up10,up15,xj,
					    Agwgz,Axjgz,Aup10,Aup15,
					    Axj,fill,'','',rysf,t126RId);
					else
						if gwjfbl!=0 then -- 比例不为0时，查询新标准
							select c06 into Agwgz -- 岗位工资
							from t127 where c08 = gzbzlb -- 原工资标准类别
							and c03 = '岗位工资'
							and c05 = gzdyzj -- 工资对应职级
							and c01<= '2018-07-01'
							order by c01 desc  limit 1;
							set Agwgz = round(Agwgz*gwjfbl);
						end if;
						if xjjfbl!=0 then -- 比例不为0时，查询新标准
							select c06 into Axjgz -- 薪级工资
							from t127 where c08 = gzbzlb -- 原工资标准类别
							and c03 = '薪级工资'
							and c04 = dc -- 工资对应职级
							and c01<= '2018-07-01'
							order by c01 desc  limit 1;
							set Axjgz = round(Axjgz*xjjfbl);
						end if;
						set Aup10 = 0;
						if isUp10 = 10487 then -- 如果要提高10%
							set Aup10 = round((ifnull(Agwgz,0)+0+ ifnull(Axjgz,0)+0)*0.10);
						end if;
						set Aup15 = 0;
						if isUp15 = 10487 then -- 如果要提高15%
							set Aup15 = round((ifnull(Agwgz,0)+0+ ifnull(Axjgz,0)+0+ ifnull(Aup10,0)+0)*0.15);
						end if;
						-- 调标后小计
						set Axj = round(ifnull(Agwgz,0)+0+ ifnull(Axjgz,0)+0+ifnull(Aup10,0)+0+ifnull(Aup15,0));
						-- 补发额 
						set fill = round(ifnull(Axj,0)+0-ifnull(xj,0)+0.1); 
						insert into adjustwage.ywjyadjust(unitId,ryId,rybh,name,idcard,month,
						job,rankLevel,jobSalary,levelSalary,teacherNurseUp10,specialTeach,subTotal,
						jobSalaryAfter,levelSalaryAfter,teacherNurseUp10After,specialTeachAfter,
						subTotalAfter,fill,remark,nt,rysf,recordId)
					    values(dwId,sTemPersonId,rybh,xm,sfz,mon,
					    gzdyzj,dc,gwgz,xjgz,up10,up15,xj,
					    Agwgz,Axjgz,Aup10,Aup15,Axj,fill,'','',rysf,t126RId);
					end if;
			    end if;
			else
				-- 如果此人没有月份之前的变动，则记为空
				insert into adjustwage.ywjyadjust(unitId,ryId,rybh,name,idcard,month,
				rysf)
			    select c01,id,c02,c04,replace(c07,'不是调出',''),mon,
				    (select name from sys_s_data where id = t126.c28) -- 人员身份
			    from t126 where id = sTemPersonId;
			end if;  
		    set done = @done;
		END LOOP;
  	-- 关闭游标
	CLOSE t126_ids;
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`p_tiaobiao_ywjy`(IN dwid int(11),
INOUT resultMsg varchar(200) CHARSET utf8)
label_pro:BEGIN	
-- 义务教育正常人员进入 义务教育表

	declare columnNum int(11) default 6;-- 默认是6行
	declare tempNum smallInt(11) default 0 ;-- 临时变量
	declare tempMonth smallInt(11) default 7 ;-- 临时变量 月份

	-- 更新前先清空之前的数据
	DELETE FROM adjustwage.ywjyadjust where unitId= dwid;
	
	select c01,c05,c19 into @dwCode,@dwxz,@isFwzx from t111 where id = dwid and c02 != '四川省冶金地质勘查局机关后勤服务中心';
	-- 四川省冶金地质勘查局机关后勤服务中心' 这个单位不发13薪
	if @dwxz=10295 || @dwxz=10821 ||@isFwzx=10487 then 
	-- 机关 参公 或服务中心
		set columnNum = 7;
	end if;
	if @dwCode = '151000000034' or  @dwCode = '151160000000' then 
		-- //151000000034   151160000000  这两个单位机关人员要发年终奖,事业人员不发,事业放空的13薪数据
		set columnNum = 7;
	end if; 
	while tempNum<columnNum do
		-- set resultMsg = concat('call p_tb_ywjy_add(',dwid,',',tempMonth,',@re)');
		-- leave label_pro;
		-- select concat('call p_tb_ywjy_add(',dwid,',',tempMonth,',@re)');
		call p_tb_ywjy_add(dwId,tempMonth,resultMsg);
		-- if ''!= resultMsg then leave label_pro; end if;
		set tempNum = tempNum+1;-- 循环+1
		set tempMonth = tempMonth+1;-- 月份加1
	end while;
	-- 为0的改成null
	if @dwCode = '151000000034' or  @dwCode = '151160000000' then
		--  这两个单位机关人员要发年终奖,事业人员不发,事业放空的13薪数据
		update adjustwage.ywjyadjust set jobSalary = null,levelSalary = null,
		teacherNurseUp10 = null,specialTeach = null,subTotal = null,jobSalaryAfter = null,
		levelSalaryAfter = null,teacherNurseUp10After = null,specialTeachAfter = null,
		subTotalAfter = null,fill = null
		where unitId= dwid and month = 13 and rysf in ('管理人员','专业技术人员','事业工人','运动员');
	end if;
	update adjustwage.ywjyadjust set jobSalary = null where unitId= dwid and jobSalary = 0;
	update adjustwage.ywjyadjust set levelSalary = null where  unitId= dwid and levelSalary = 0;
	update adjustwage.ywjyadjust set teacherNurseUp10 = null where  unitId= dwid and teacherNurseUp10 = 0;
	update adjustwage.ywjyadjust set specialTeach = null where  unitId= dwid and specialTeach = 0;
	update adjustwage.ywjyadjust set subTotal = null where  unitId= dwid and subTotal = 0;
	update adjustwage.ywjyadjust set jobSalaryAfter = null where  unitId= dwid and jobSalaryAfter = 0;
	update adjustwage.ywjyadjust set levelSalaryAfter = null where  unitId= dwid and levelSalaryAfter = 0;
	update adjustwage.ywjyadjust set teacherNurseUp10After = null where  unitId= dwid and teacherNurseUp10After = 0;
	update adjustwage.ywjyadjust set specialTeachAfter = null where  unitId= dwid and specialTeachAfter = 0;
	update adjustwage.ywjyadjust set subTotalAfter = null where  unitId= dwid and subTotalAfter = 0;
	update adjustwage.ywjyadjust set fill = null where  unitId= dwid and fill = 0;
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`p_update_isTg10_wj`(IN v_unit_dataId varchar(200),
INOUT resultMsg varchar(1000) CHARSET utf8)
label_pro:BEGIN	
-- 修改事业人员 是否提高10% 主要是温江初始导入时 未成功导入10%工资

	DECLARE stemParam varchar(100);-- 参数变量
	DECLARE sucessNum int(11) default 0;-- 成功数量
	DECLARE failNum int(11) default 0;-- 参数变量
	DECLARE sTemPersonId int(11);
	DECLARE salaryId int(11);

  	DECLARE done INT DEFAULT FALSE;
	DECLARE person_ CURSOR FOR
	   SELECT t126.id from  t126,t125
			where 1=1 --  and t126.dataclassCode = 't126'
			and t126.c01 = concat(v_unit_dataId,'') and concat(t126.id,'') = t125.c06 -- 人员工资表的c06人员编号 关联型
		;
 	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
 	 OPEN person_;  
  -- 开始循环
  read_loop: LOOP
    -- 提取游标里的数据，这里只有一个，多个的话也一样；
    FETCH person_ INTO sTemPersonId;
    -- 声明结束的时候
    IF done THEN
      LEAVE read_loop;
    END IF;
	set @doneF = done;
		select c02 into @personCode from t126 where id = sTemPersonId;
		select f11 into stemParam from gzda_wj where f1 = @personCode;
		if stemParam > 0 then 
			select count(1) into @stemParam from t125 where c06 = concat(sTemPersonId,'') 
			and exists(select 1 from t126 where t126.id = t125.c06 and t126.c40 = '10750');-- 10750 录入新进人员
			if @stemParam > 0 then 
				update t125 set c01 = 10487,c23=10487,c28=stemParam where c06 = sTemPersonId;
				-- c01 是否中小学老师 c23-是否提高10%工资 c28-提高10%工资
				update t125 set c01 = 10487,c23=10487,c28=stemParam where c06 = sTemPersonId;
				update t125 set c28 = stemParam,
					c32 = ifnull(c25,0) + ifnull(c26,0) + stemParam + ifnull(c29,0) + ifnull(c30,0) 
					+ ifnull(c31,0)+ifnull(c27,0)+ifnull(c44,0)+ifnull(c45,0) +0 
				where c06 = concat(sTemPersonId,'') and exists(select 1 from t126 where t126.id = t125.c06 and t126.c40 = 10750);-- 10750 录入新进人员
				update data_record_t125 set c28 = stemParam,
					c32 = ifnull(c25,0) + ifnull(c26,0) + stemParam + ifnull(c29,0) + ifnull(c30,0) 
					+ ifnull(c31,0)+ifnull(c27,0)+ifnull(c44,0)+ifnull(c45,0) +0 
				where c06 = concat(sTemPersonId,'') and dataclassCode = 't125' and changeType = 10750;-- 10750 录入新进人员
				update fund_salary_pay_201704 set staff_teacherNurseUpTen =stemParam where staff_id = sTemPersonId;
				update fund_change_detail_201704 set staff_teacherNurseUpTen =stemParam where staff_id = sTemPersonId;
				set sucessNum = sucessNum + 1; 
			else
				set failNum = failNum + 1; 
			end if;
		else
			set failNum = failNum + 1; 
		end if;
	set done = @doneF;
  END LOOP;
  -- 关闭游标
  CLOSE person_;
  set resultMsg = concat('成功更新',sucessNum,'人数据!失败',failNum,'人数据!');
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`p_update_isTg10_wj2`(IN v_unit_dataId varchar(200),
INOUT resultMsg varchar(1000) CHARSET utf8)
label_pro:BEGIN	
-- 修改事业人员 是否提高10% 主要是温江初始导入时 未成功导入10%工资
-- 用于已经做过变动的人员
	DECLARE stemParam varchar(100);-- 参数变量
	DECLARE sucessNum int(11) default 0;-- 成功数量
	DECLARE failNum int(11) default 0;-- 参数变量
	DECLARE failMsg varchar(1000);-- 失败原因

	DECLARE sTemPersonId int(11);
	DECLARE salaryId int(11);

  	DECLARE done INT DEFAULT FALSE;
	DECLARE person_ CURSOR FOR
	   SELECT t126.id from  t126,t125
			where 1=1 -- and t126.dataclassCode = 't126'
			and t126.c01 = concat(v_unit_dataId,'') and concat(t126.id,'') = t125.c06 -- 人员工资表的c06人员编号 关联型
		;
 	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
 		set failMsg = '失败人员:';
 	 OPEN person_;  
  -- 开始循环
  read_loop: LOOP
    -- 提取游标里的数据，这里只有一个，多个的话也一样；
    FETCH person_ INTO sTemPersonId;
    -- 声明结束的时候
    IF done THEN
      LEAVE read_loop;
    END IF;
	set @doneF = done;
		select c02,c04 into @personCode,@personName from t126 where id = sTemPersonId;
		select f11 into stemParam from gzda_wj where f1 = @personCode;
		if stemParam > 0 then 
			select count(1) into @stemParam from t125 where c06 = concat(sTemPersonId,'') 
		and exists(select 1 from t126 where t126.id = t125.c06 and ifnull(c23,'')!=10486);-- 10750 非 录入新进人员
			if @stemParam > 0 then 
				update t125 set c01 = 10487,c23=10487
				 where c06 = concat(sTemPersonId,'') and ifnull(c23,'')!=10487;
				-- c01 是否中小学老师 c23-是否提高10%工资 c28-提高10%工资
				update t125 set c28=round(CAST((ifnull(c25,0)+ifnull(c25,0))*0.1 AS DECIMAL)),
					c32 = ifnull(c25,0) + ifnull(c26,0) + round(CAST((ifnull(c25,0)+ifnull(c25,0))*0.1 AS DECIMAL)) 
					+ ifnull(c29,0) + ifnull(c30,0) 
					+ ifnull(c31,0)+ifnull(c27,0)+ifnull(c44,0)+ifnull(c45,0) +0 
				where c06 = concat(sTemPersonId,'') and exists(select 1 from t126 where t126.id = t125.c06 and t125.c23 = 10487);-- 10750 录入新进人员
				update data_record_t125 set c01 = 10487,c23=10487 
				where dataclassCode = 't125' and c06 = concat(sTemPersonId,'') and ifnull(c23,'')!=10486;
				update data_record_t125 set c28 = round(CAST((ifnull(c25,0)+ifnull(c25,0))*0.1 AS DECIMAL)),
					c32 = ifnull(c25,0) + ifnull(c26,0) + round(CAST((ifnull(c25,0)+ifnull(c25,0))*0.1 AS DECIMAL)) + ifnull(c29,0) + ifnull(c30,0) 
					+ ifnull(c31,0)+ifnull(c27,0)+ifnull(c44,0)+ifnull(c45,0) +0 
				where c06 = concat(sTemPersonId,'') and dataclassCode = 't125' and ifnull(c23,'')!=10486 ;-- 10750 录入新进人员
				update fund_salary_pay_201704 set staff_teacherNurseUpTen =stemParam where staff_id = sTemPersonId;
				update fund_change_detail_201704 set staff_teacherNurseUpTen =stemParam where staff_id = sTemPersonId;
				set sucessNum = sucessNum + 1; 
			else
				set failNum = failNum + 1; 
				set failMsg = concat(failMsg,@personName,',');
			end if;
		else
			set failNum = failNum + 1; 
			set failMsg = concat(failMsg,@personName,',');
		end if;
	set done = @doneF;
  END LOOP;
  -- 关闭游标
  CLOSE person_;
  set resultMsg = concat('成功更新',sucessNum,'人数据!失败',failNum,'人数据!');
  if failNum > 0 then 
  	set failMsg = concat(failMsg,',');
  	set failMsg = replace(failMsg,',,','');
  	set resultMsg = concat(resultMsg,failMsg);
  end if;
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`selectuser`(userno varchar(100))
begin     
 select * from sys_s_user where `name` like CONCAT('%',userno,'%');       
end;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`setRycode`(inout resultMsg varchar(10000))
label_pro:BEGIN
-- 处理已经接收的人员编号
	
    DECLARE sTemRecordId int(11);
    DECLARE done INT DEFAULT FALSE;
    	
    
	DECLARE recordId_ CURSOR FOR
  	--  SELECT a.id from data_record_t126 a , t111 b  
	-- where a.c01 = b.id and b.c01 =  v_unit_id and a.changetype = 10832
	select id from data_record_t126 where changetype = 10832
	;
	
	
	
	
	
  DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
 	
	select count(*) into @total from data_record_t126 where changetype = 10832;
	
	
	/*select count(1) into stempNum from information_schema.tables where table_schema = sysDataBase and TABLE_NAME = v_allowance_table_cache;-- smso数据库里面对应的津补贴发放表信息
	if stempNum < 1 then -- 判断是否已经存在v_i_fund_month(如201608)的工资发放表信息
		SET @sqlstr = CONCAT('CREATE TABLE ',v_allowance_table_cache,' LIKE ', ' fund_salary_fill_subsidies');
		PREPARE stmt FROM @sqlstr;
		EXECUTE stmt;
		DROP PREPARE stmt;
		-- call p_fund_addIndex(v_i_fund_month,'fund_salary_fill',resultMsg);-- 补扣发表生成索引
	end if;*/
	set @index2 = 0;

/**计算补扣发之前应该先清空本次所有变动的补扣发数据*/

  OPEN recordId_;  
  -- 开始循环
  read_loop: LOOP
    -- 提取游标里的数据，这里只有一个，多个的话也一样；
    FETCH recordId_ INTO sTemRecordId;
    -- 声明结束的时候
    IF done THEN
      LEAVE read_loop;
    END IF;
	set @doneF = done;
    select dataid,c01,c02 into @id,@dwid,@rycode from data_record_t126 where  id = sTemRecordId;
    select c01 into @v_unit_id from t111 where id = @dwid;
    select length(@rycode)- length(@v_unit_id) into @count;
    set @change = 1;
	if @count = 5 then 
		select locate(@v_unit_id,@rycode) into @index;
		if @index = 1 then 
			set @change = 0;
		end if;
	end if;
	set @personcode = @v_unit_id;
	if @change = 1 then
		select count(1) into @auto from data_auto_record where dataclasscode = 't126' and autohead = @v_unit_id;
		if @auto = 1 then
			 select autoend into @autoend from data_auto_record where dataclasscode = 't126' and autohead = @v_unit_id;
			 update data_auto_record set autoend = autoend+1 where dataclasscode = 't126' and autohead = @v_unit_id;
		else 
			insert into data_auto_record (dataclasscode,dataitemcode,createdate,updatedate,
			autohead,autocenter,autoendlength,autoend) value ('t126','c02',now(),now(),
			@v_unit_id,'',5,1);
			set @autoend = 1;
		end if;

		set @autoend = @autoend+1;
		if length(@autoend)=1 then 
			set @personcode = concat(@personcode,'0000',@autoend);
		end if;
		if length(@autoend)=2 then 
			set @personcode = concat(@personcode,'000',@autoend);
		end if;
		if length(@autoend)=3 then 
			set @personcode = concat(@personcode,'00',@autoend);
		end if;
		if length(@autoend)=4 then 
			set @personcode = concat(@personcode,'0',@autoend);
		end if;
		/*
@id,-----t126.id
@dwid,-----t111.id
@rycode-----t126.c02原编号
@personcode ---- t126.c02 新编号

*/

set @index2 =  @index2 +1;
		update  t126 set c02 = 	@personcode where   id = @id and c01 = @dwid and c02 =@rycode ;
		update data_record_t126 set c02 = 	@personcode where   dataid = @id and c01 = @dwid and c02 =@rycode;
		update fund_change_detail_201711 set staff_code = @personcode where unit_id = @dwid and staff_id = @id and staff_code = @rycode;
		update fund_change_detail_201712 set staff_code = @personcode where unit_id = @dwid and staff_id = @id and staff_code = @rycode;
		update fund_change_detail_201801 set staff_code = @personcode where unit_id = @dwid and staff_id = @id and staff_code = @rycode;
		update fund_change_detail_201802 set staff_code = @personcode where unit_id = @dwid and staff_id = @id and staff_code = @rycode;
		
		update fund_salary_fill_201711 set staff_code = @personcode where unit_id = @dwid and staff_id = @id and staff_code = @rycode;
		update fund_salary_fill_201712 set staff_code = @personcode where unit_id = @dwid and staff_id = @id and staff_code = @rycode;
		update fund_salary_fill_201801 set staff_code = @personcode where unit_id = @dwid and staff_id = @id and staff_code = @rycode;
		update fund_salary_fill_201802 set staff_code = @personcode where unit_id = @dwid and staff_id = @id and staff_code = @rycode;
		
		update fund_salary_pay_201711 set staff_code = @personcode where unit_id = @dwid and staff_id = @id and staff_code = @rycode;
		update fund_salary_pay_201712 set staff_code = @personcode where unit_id = @dwid and staff_id = @id and staff_code = @rycode;
		update fund_salary_pay_201801 set staff_code = @personcode where unit_id = @dwid and staff_id = @id and staff_code = @rycode;
		update fund_salary_pay_201802 set staff_code = @personcode where unit_id = @dwid and staff_id = @id and staff_code = @rycode;
		
		
		
		
	end if;	
	
	
	if ''!= resultMsg then 
		leave label_pro;
	end if;
	set done = @doneF;
    -- 统一计算 当月所有上报变动记录的 补扣发
  END LOOP;
  -- 关闭游标
  CLOSE recordId_;
		
	
	

	SELECT concat('共',@total),concat('修改',@index2,'人');
	
END;

CREATE DEFINER = `root`@`localhost` PROCEDURE `smso-migration-v2`.`someoneGoToOtherUnit`(IN yrybh varchar(200),IN ydwdm varchar(200),
In xdwdm varchar(200),
INOUT resultMsg varchar(1000) CHARSET utf8)
label_pro:BEGIN	
DECLARE ryid int(11);-- 人员id
DECLARE ydwid int(11);-- 原单位id
DECLARE xdwid int(11);-- 现单位id
DECLARE xdwbh_end varchar(20);-- 新单位人员编号 最后一位
DECLARE newAutoEnd varchar(100);-- 新单位人员编号 最后一位
DECLARE xdw_rybh varchar(100);-- 新单位人员编号


--  yrybh 原人员编号-目前单位人员编号  ydwdm 原单位代码-目前所在单位  xdwdm 现单位代码-要去的单位
SELECT id into ryid FROM t126 WHERE c02=yrybh;
SELECT id into ydwid FROM t111 WHERE c01=ydwdm;
SELECT id into xdwid FROM t111 WHERE c01=xdwdm;
if ryid is null or ryid = 0 then
	set resultMsg = concat('人员编号 :',yrybh,'不存在!');leave label_pro;
end if;
-- 新单位人员编号 最后一位
SET xdwbh_end=(SELECT autoEnd FROM data_auto_record WHERE autoHead=xdwdm AND dataclassCode='t126');
SET newAutoEnd=xdwbh_end+1;
SET xdw_rybh=CONCAT(xdwdm,(CASE LENGTH(xdwbh_end) WHEN '1' THEN '0000' WHEN '2' THEN '000' WHEN '3' THEN '00' WHEN '4' THEN '0' WHEN '5' 
	THEN '' END),(newAutoEnd));

UPDATE t126 SET c01=xdwid,c15='',c13=DATE(SYSDATE()) WHERE id=ryid;
UPDATE t125 SET c05=xdwid WHERE c06=concat(ryid,'');
UPDATE t117 SET c02=xdwid WHERE c03=concat(ryid,'');
UPDATE t121 SET c03=xdwid WHERE c02=concat(ryid,'');  
UPDATE t122 SET c01=xdwid WHERE c02=concat(ryid,'');
UPDATE t124 SET c02=xdwid WHERE c03=concat(ryid,'');
UPDATE t131 SET c19=xdwid WHERE c01=concat(ryid,'');
UPDATE t126 SET c02=xdw_rybh WHERE c02=yrybh;
UPDATE data_auto_record SET autoEnd=newAutoEnd WHERE autoHead=xdwdm AND dataclassCode='t126';
UPDATE data_record_t126 SET c01=xdwid,c15='',c13=DATE(SYSDATE()),c02=xdw_rybh WHERE dataId=ryid AND dataclassCode='t126';
UPDATE data_record_t125 SET c05=xdwid WHERE c06=concat(ryid,'') AND dataclassCode='t125';
UPDATE data_record_t117 SET c02=xdwid WHERE c03=concat(ryid,'') AND dataclasscode='t117';


	
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`updateDWMC`(IN ydwmc varchar(200),
In xdwmc varchar(200),
INOUT resultMsg varchar(1000) CHARSET utf8)
label_pro:BEGIN	

update t111 set c02=xdwmc where c02=ydwmc;
update t130 set c02=CONCAT(xdwmc,'管理员') WHERE c02=CONCAT(ydwmc,'管理员');
update sys_s_user set nickName=xdwmc where nickName=ydwmc;
update sys_s_user set nickName=CONCAT(xdwmc,'管理员') where nickName=CONCAT(ydwmc,'管理员');

	
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`upGaJgDj`(IN createrId int(11),IN unitId int(11),IN orgId varchar(200),
IN chanType varchar(200),IN qxsj varchar(20) ,IN bdsj varchar(20),IN qknx varchar(4),in yjwh varchar(100),
INOUT resultMsg varchar(10000) CHARSET utf8)
label_pro:BEGIN	
	-- orgId 单位id
	-- chanType 批量变动变动类型id  sys_s_data data_value = 11 机关正常晋升级别工资
	-- bdsj 变动时间 20160701
	-- qxsj 起薪时间 20160101
	-- DECLARE orgId varchar(100);-- 单位id

	DECLARE changeType varchar(100);-- -- 变动类型sys_s_data id
	DECLARE changeId int(11);-- -- changeId 变动记录id 主要是t126的变动记录id,此id来查询所有关联的工资t125,津贴t117 变动记录
	DECLARE personId varchar(100);-- 人员id
	
	DECLARE salaryId varchar(100);-- 工资信息的Id
	DECLARE salaryRecordId varchar(100);-- 工资信息的recordId
	DECLARE changeTypeCode varchar(100);-- 变动类型code

	DECLARE rysf varchar(10);-- 人员身份 管理人员 工人 专业技术人员	
	DECLARE rygzzd varchar(20);-- 人员工资制度- - 公务员职级工资制码表-201 警察职级工资制度-206	
	DECLARE zxgzbz varchar(20);-- 执行工资标准- 公务员
	
	DECLARE zwgz double DEFAULT 0;-- 职务工资
	DECLARE jb varchar(10);-- 级别
 	DECLARE zggzjb int(20);-- 最高工资级别
	DECLARE jbsj varchar(10);-- 级别-起考时间
	DECLARE dc varchar(10);-- 档次
	DECLARE jbgz varchar(10);-- 级别工资-档次-薪级工资
	DECLARE dcsj varchar(10);-- 档次-薪级	
	DECLARE newJb varchar(20);-- 新级别	
	DECLARE newJbsj varchar(20);-- 新级别时间
	DECLARE newDc varchar(20);-- 新档次	
	DECLARE newDcsj varchar(20);-- 新起考时间
	DECLARE newJe double DEFAULT 0;-- 新金额
	DECLARE newDcId varchar(10);-- 新档次Id

	DECLARE subJe double DEFAULT 0;-- 档差(薪级差)金额
	DECLARE jhtg double DEFAULT 0;-- 教师护士提高10%
	DECLARE tjtg double DEFAULT 0;-- 特殊教育揭提高15%
	DECLARE oldQysj varchar(20);-- 标准启用时间
	DECLARE oldBzlb varchar(20);-- 标准类别
	DECLARE oldBzmc varchar(20);-- 标准名称
	DECLARE oldJbmc varchar(20);-- 级别名称-档次/薪级
	DECLARE oldCjbmc varchar(20);-- 次级别名称-级别
	DECLARE oldJe double DEFAULT 0;-- 金额
	DECLARE oldZxgzbz varchar(50);-- 执行工资标准
	
	DECLARE qxYearMonth varchar(100);-- 起薪时间-截取 年月 2016-01
	
	DECLARE sTemPersonId varchar(100);-- 人员id-变量
	DECLARE sTempNum int(11);-- 参数
	DECLARE sTempYearMonth varchar(6);-- 
	DECLARE sTempParam int(11);-- 变动时间-(减去)起薪时间的月份

	DECLARE chanSign varchar(100);-- 变动标志
	
	DECLARE qxMonth varchar(10);-- 系统设置批量变动 统一起薪月份 :01表示 当年1月  11表示当年11月

	DECLARE stemSucIndex int(11) default 0;-- 批量晋升工资成功条数
	DECLARE stemFailIndex int(11) default 0;-- 批量晋升工资失败条数(需要手工补扣发人数)
	
	DECLARE zxgs	varchar(100);-- t117执行公式
	DECLARE zxje	double DEFAULT 0;-- t117执行金额
	DECLARE zxgsje double DEFAULT 0;-- t117 执行公式*t117执行金额
	DECLARE dwdm int(11);-- 单位代码
	DECLARE personNo varchar(100);-- 人员编号
	DECLARE personNum int(11);	-- 所有机关公务员在职公务员数量-排开试用期人员 
	DECLARE	FailIndex int(11) default 0; -- 晋级失败人数
	DECLARE temp varchar(100); -- 最近一次变动记录的起薪时间
	DECLARE c_id int(11);-- 创建人id
	DECLARE u_id int(11);-- 功能id
	
	DECLARE mydone INT DEFAULT 0;
    DECLARE done INT DEFAULT FALSE;
	-- -- 所有机关公务员在职公务员-排开试用期人员
	DECLARE personId_ CURSOR FOR
   SELECT t126.id from t126 ,t125,sys_s_data d 
		where t126.c01 = concat(orgId,'')  -- 单位代码
		and t125.c06 = concat(t126.id,'')-- 人员编号
		and d.id = t125.c36  and d.data_value in( 209,210 )-- t125.c36 人员工资制度为 201 -公务员职级工资 206-警察职级工资制度 包含身份:公务员 人民警察 司法辅助 行政人员 
		and EXISTS (select 1 from t127 where t127.id = t126.c17 and t127.c05 not like '%试用期%') -- t126.c39 执行工资标准 关联 单位工资制度与人员属性信息对应关系t136.c04 执行工资标准
	  and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
	and (ifnull(t126.c43,'') !=10487 and ifnull(t125.c26,'')!=0)  -- 排除已经停薪的人员  10487是否状态-是   级别工资是0 的不参与晋升
	and ifnull(t125.c39,'') !=10487 -- 排除计发生活费的人员
	and ifnull(t125.c40,'') !=10487 -- 排除计发病假工资的人员
	;
	
	-- 所有在职试用期公务员 
	DECLARE personId_2 CURSOR FOR
   SELECT t126.id from t126 ,t125,sys_s_data d 
		where t125.c06 = concat(t126.id,'') and d.id = t125.c36 
		and t126.c01 = concat(orgId,'') and d.data_value in( 209,210) -- t125.c36 人员工资制度为 201 -公务员职级工资 206-警察职级工资制度 
		and EXISTS (select 1 from t127 where t127.id = t126.c17 and t127.c05 like '%期%') -- t126.c39 执行工资标准 关联 单位工资制度与人员属性信息对应关系t136.c04 执行工资标准
	  and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
	and ifnull(t126.c43,'') !=10487 -- 排除已经停薪的人员  10487是否状态-是
	and ifnull(t125.c39,'') !=10487 -- 排除计发生活费的人员
	and ifnull(t125.c40,'') !=10487 -- 排除计发病假工资的人员
	;
	-- 所有在职计发生活费人员
	DECLARE personId_3 CURSOR FOR
   SELECT t126.id from t126 ,t125,sys_s_data d 
		where t125.c06 = concat(t126.id,'') and d.id = t125.c36 
		and t126.c01 = concat(orgId,'') and d.data_value in( 209,210) -- t125.c36 人员工资制度为 201 -公务员职级工资 206-警察职级工资制度 
		and EXISTS (select 1 from t127 where t127.id = t126.c17 and t127.c05 not like '%期%') -- t126.c39 执行工资标准 关联 单位工资制度与人员属性信息对应关系t136.c04 执行工资标准
	  and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
	and ifnull(t126.c43,'') !=10487 -- 排除已经停薪的人员  10487是否状态-是
	and t125.c39 =10487 -- 计发生活费的人员
	;

	-- -- 所有在职停薪人员
	DECLARE personId_4 CURSOR FOR
   SELECT t126.id from t126 ,t125,sys_s_data d 
		where t125.c06 = concat(t126.id,'') and d.id = t125.c36 
		and t126.c01 = concat(orgId,'') and d.data_value in( 209,210) -- t125.c36 人员工资制度为 201 -公务员职级工资 206-警察职级工资制度 
	and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
	and ifnull(t126.c43,'') =10487   -- 排除已经停薪的人员  10487是否状态-是    
	and ifnull(t125.c39,'') !=10487 -- 排除计发生活费的人员
	and ifnull(t126.c40,'') !=10831 -- 排除减少人员
	;

		-- 所有在职计发病假工资人员
	DECLARE personId_5 CURSOR FOR
   SELECT t126.id from t126 ,t125,sys_s_data d 
		where t125.c06 = concat(t126.id,'') and d.id = t125.c36 
		and t126.c01 = concat(orgId,'') and d.data_value in( 209,210) -- t125.c36 人员工资制度为 201 -公务员职级工资 206-警察职级工资制度 
		and EXISTS (select 1 from t127 where t127.id = t126.c17 and t127.c05 not like '%期%') -- t126.c39 执行工资标准 关联 单位工资制度与人员属性信息对应关系t136.c04 执行工资标准
	  and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
	and ifnull(t126.c43,'') !=10487 -- 排除已经停薪的人员  10487是否状态-是
	and t125.c40 =10487 -- 计发生活费的人员
	;
	
		
		-- -- 所有级别工资为0人员
	DECLARE personId_6 CURSOR FOR
   SELECT t126.id from t126 ,t125,sys_s_data d 
		where t125.c06 = concat(t126.id ,'') and d.id = t125.c36 
		and t126.c01 = concat(orgId,'') and d.data_value in( 209,210) -- t125.c36 人员工资制度为 201 -公务员职级工资 206-警察职级工资制度 
		and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
	and  ifnull(t125.c32,0) = 0  --    工资合计为0 及视为停发工资
	and ifnull(t126.c43,'') !=10487   -- 排除已经停薪的人员  10487是否状态-是    
	and ifnull(t125.c39,'') !=10487 -- 排除计发生活费的人员
	and ifnull(t126.c40,'') !=10831 -- 排除减少人员
	;
	
	
 	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
 
	-- select DATE_FORMAT(qxsj,'%Y%m') into qxYearMonth;-- 起薪年月 201601

	select content into qxMonth from sys_s_config where enname = 'qxMonth' ;

	set c_id = createrId;
	set u_id = unitId;
	if length(qxsj)=4 then
		select DATE_FORMAT(concat(qxsj,'-',qxMonth,'-01'),'%Y-%m') into qxYearMonth;-- 起薪年月 2016-01
	else
		select DATE_FORMAT(qxsj,'%Y-%m') into qxYearMonth;-- 起薪年月 2016-01
 	end if;
	
	set @resultM = 'resultM:';
	set @khsjbm = 'khsjbm:';-- 考核没考5年称职的
	set @qksjbz = 'qksjbz:';-- 人员上一次变动起考时间与起薪年月-年相差不足5年
	set @khfcz = 'khfcz:';-- 考核不是称职的 用来包装考核5年，但没有达到5年称职
	set @qxsjbd = 'qxsjbd:';-- 人员起薪时间 小于等于最近一次变动记录的起薪时间
	set @syq = 'syq:';-- 试用期人员
	set @jfshf = 'jfshf:';-- 在职计发生活费人员
	set @jfbj = 'jfbj:';-- 在职计发病假工资人员
	set @zztx = 'zztx:';-- 所有在职停薪人员
	set @bdcz = 'bdcz:';-- 当前变动类型当年已经存在
	set @jbgz0 = 'jbgz0:';-- 所有级别工资为0人员
	set @zddc = 'zddc:' ;-- 达到最低档次了  那么就不晋级了  提示用户自己做个别变动
	set resultMsg = 'resultMsg';
	-- 打开游标
  OPEN personId_;  
  -- 开始循环
  read_loop: LOOP
    -- 提取游标里的数据，这里只有一个，多个的话也一样；
    FETCH personId_ INTO sTemPersonId;
    -- 声明结束的时候
    IF done THEN
      LEAVE read_loop;
    END IF;
	set @doneF = done;-- 用于存储当前游标实际结束标志,在中间查询过程中可能会对done进行变更(原因尚不知),所以存放临时变量
    	
    select count(1) into sTempNum from data_record_t126 t126 ,data_record_t125 t125 
    where   t125.c06=concat(t126.dataId,'') and t126.changeSign = t125.changeSign 
    and t126.dataId = sTemPersonId and t126.changeType = chanType 
		and t126.allAuditFlag = '2'
		and t125.c02 >= qxYearMonth ;
    if sTempNum = 0 then -- 起薪时间之后已经存在通过的此变动记录
/*
    	-- 人员在当前单位第一次起薪时间
		select t125.c02 into @firstQxsj from data_record_t126 t126,data_record_t125 t125 
			where  t126.changesign = t125.changesign and  t126.dataId = stemPersonId and t125.c06 = concat(t126.dataId ,'') 
			and t126.c01 = concat(orgId,'') and t126.changetype in(10750,10832) order by t126.id desc  limit 0,1;

		
		-- 重新确定工资
		select count(1) into @cxqdNum from data_record_t126 t126 ,data_record_t125 t125
    	where  t126.changesign = t125.changesign and   t126.dataId = stemPersonId and t125.c06 = concat(t126.dataId ,'') 
    	 and t126.changeType in(select id from sys_s_data d where d.typename = 'bdlx' and data_value = '05')
    	 and t126.c01 = concat(orgId,'') 
    	 order by t125.id desc 
    	 limit 0,1;-- 重新确定工资
		if @cxqdNum > 0 then 
	    	select t125.c02 into @firstQxsj from data_record_t126 t126 ,data_record_t125 t125
	    	where  t126.changesign = t125.changesign and  t126.dataId = stemPersonId and t125.c06 = concat(t126.dataId ,'') 
	    	 and t126.changeType in(select id from sys_s_data d where d.typename = 'bdlx' and data_value = '05')
	    	 and t126.c01 = concat(orgId,'') 
	    	 order by t125.id desc 
	    	 limit 0,1;-- 重新确定工资
		end if;*/
		-- 人员在本单位最后一次起薪（录入或调入）时间、重新确定工资起薪时间、工资制度变化起薪时间 取最大的一个起薪时间
		call p_person_getQxsj(sTemPersonId,@firstQxsj);-- 根据人员当前单位及身份等获取最早起薪时间
		
		select PERIOD_DIFF(replace(@firstQxsj,'-',''),replace(qxYearMonth,'-','')) into @stemNum; -- 判断 起薪时间201601与当前人员在该单位首次起薪时间201602 
	-- 	set resultMsg = concat('qxYearMonth:',qxYearMonth,',@firstQxsj:',@firstQxsj,',@stemNum:',@stemNum);leave label_pro;
		if @stemNum > 0 then -- 设置人员起薪时间  如果在单位首次起薪为201602,则设置为2016-02 如果一直在 则为为 2016-01 
			set @qxYearMonth = @firstQxsj;
		else 
			set @qxYearMonth = qxYearMonth;
		end if;
		
    	-- 循环查询人员工资信息
		-- t125 人员工资信息表 c07-工资级别-关联工资标准表t127.c05次级别名称,c08-级别起考时间,c09-工资档次-关联工资标准表-c04级别名称,c10-档次起考时间,c25-职务工资,c26-级别工资,c28-教师护士提高10%,c29-特殊教育提高15%,c36-人员工资制度-字符型
		-- t126 人员基本信息表 c28-人员身份-关联 单位工资制度与人员属性信息对应关系.人员身份 t126.c39-执行工资标准-关联 单位工资制度与人员属性信息对应关系.执行工资标准 t125.c27-津补贴小计
		select t125.id,t125.c07,t125.c08,t125.c09,t125.c10,round(t125.c25,2),round(t125.c26,2),round(t125.c28,2),round(t125.c29,2),t125.c36,t126.c28,t126.c39,t126.c01,t126.c02,round(t125.c27,2)
		into salaryId,jb,jbsj,dc,dcsj,zwgz,jbgz,jhtg,tjtg,rygzzd,rysf,zxgzbz,dwdm,personNo,zxgsje
		from t126,t125 where t125.c06 = concat(t126.id ,'')  and t126.id = sTemPersonId ; -- t125 人员工资表 c06-人员编号 关联型
		
			
		-- 查询有该单位下该人员有多少津补贴项dwd 单位代码 ,personNo 人员编号
		-- 人员的执行公式,执行金额，如果执行公式以%结尾，津补贴小计要加上执行公式*执行金额 zxgsje
		-- select COUNT(1) into @jbt  from t117  t  WHERE t.c02 = dwdm  and t.c03 = personNo ;
		-- if @jbt > 0  then
		-- zxgsje = CALL upPercentJbt(sTemPersonId);
		-- END IF;


		set dcsj = SUBSTR(dcsj FROM 1 FOR 4);-- 2016-07-01 to 2016
		
		--  t124 人员年度考核情况表 c03人员编号  关联型 c01-考核年度 c05-考核结果 码表, 1-优秀 2-称职 3-基本称职 4-不称职 5-不参与考核
		-- 起考年度-2012与起薪时间-2017-01-01之间 考核年度[2012,2013,2014,2015,2016]机关连续5年以上考核 称职以上 升一级(可能退一档)事业是每年都会晋升薪级
		select count(1) into sTempNum from t124 where c03 = concat(sTemPersonId,'') and c01 >= jbsj and c01 < qxsj
			and EXISTS (select 1 from sys_s_data d where d.id = t124.c05 and d.data_value < '3');
		
		select c04 into @personName from t126 where id = stemPersonId; -- 人员姓名
			
		if sTempNum >= 5 then -- 满足起考年度开始连续5年称职以上 升级
			
			-- 对起薪时间与最近一次未通过审核的变动记录的起薪时间进行比较,如果起薪时间在这变动记录之前,不能晋升
			 select UNIX_TIMESTAMP() into sTempParam;
			 set chanSign = concat('batch',sTempParam,chanType,'t126',sTemPersonId);
			--  set chanSign = concat('\'',chanSign,'\'');
			
			set temp = '';
			if(	EXISTS(select 1 from data_record_t125 a  -- 人员在目前单位的变动记录ID并且ID大于人员在当前单位最新的一次录入或者接收人员变动
					where  a.dataId = salaryId and  a.allAuditFlag<>2 and a.perAuditFlag<>2 and a.id >= (select id from data_record_t125 where changeSign =
 (select changeSign from data_record_t126 where dataId = sTemPersonId AND c01 = (select c01 from t126 where id = sTemPersonId) and  (c40 = '10750' or c40 = '10832') order by id desc LIMIT 1))
					order by a.updateDate desc LIMIT 0,1)) THEN  -- 判断是否存在结果 存在则赋值
						select a.c02 into temp from data_record_t125 a  
						where  a.dataId = salaryId and  a.allAuditFlag<>2 and a.perAuditFlag<>2
						order by a.updateDate desc LIMIT 0,1;
			end if;
			
	
			IF  @qxYearMonth < temp THEN -- 人员起薪时间 小于等于最近一次变动记录的起薪时间
					SET @qxsjbd = CONCAT(@qxsjbd,stemPersonId,'-',@qxYearMonth,','); 
					set FailIndex = FailIndex+1;-- 晋级失败人数+1	
			else 
				/**select t125.c02 into @firstQxsj from data_data_record t126,data_data_record t125 
				where t126.dataclassCode = 't126' and t125.dataclassCode = 't125' 
				and t126.dataId = stemPersonId and t125.c06 = t126.dataId limit 0,1;
				*/
				-- set resultMsg = concat('@personName:',@personName,',@qxYearMonth:',@qxYearMonth,',qxYearMonth:',qxYearMonth);leave label_pro;
				
				-- set @stemQxsj = @qxYearMonth;
			-- set resultMsg = concat('firstQxsj > stemQxsj:',firstQxsj > stemQxsj);leave label_pro;
			-- set resultMsg = concat('qxYearMonth:',qxYearMonth,',@qxYearMonth:',@qxYearMonth,',@firstQxsj:',@firstQxsj);leave label_pro;
				-- set resultMsg = concat('@qxYearMonth !=  qxYearMonth:',@qxYearMonth !=  qxYearMonth);leave label_pro;
				if  @qxYearMonth !=  qxYearMonth then -- 起薪时间 与 系统设置的起薪时间不一致
				
					set @resultM = concat(@resultM,'[',@personName,':变动起薪时间',@qxYearMonth,']');
					set stemFailIndex = stemFailIndex + 1;-- 需要手工补扣发的人数+1
					-- set resultMsg = stemFailIndex;leave label_pro;
				end if;
				-- t127 工资标准表  c01-启用时间 c02-标准类别 c03-标准名称 c04-次级别名称(工资档次等) c05-次级别名称(工资级别等) c06-金额 c08-执行工资标准 c09-工资标准备注
				select c01,c02,c03,c05,c05,c06,c08 into oldQysj,oldBzlb,oldBzmc,jb,oldCjbmc,oldJe,oldZxgzbz 
				from t127 where id = jb;
				select c01 into oldQysj from t127 where c08 = oldZxgzbz ORDER BY c01 desc limit 0,1; -- 赋值最新的工资标准时间
				if jbgz != oldJe then -- 如果公务员系列的 级别工资 与查询工资标准的金额不一致 则查询符合条件的工资标准id数据
					set oldJe = jbgz;
				end if;
				select c04 ,c04 into dc,oldJbmc from t127 where id = dc;
				-- select id into jb from t127 where c01 = oldQysj and c02 = oldBzlb and c03 = oldBzmc and c04 = oldCjbmc;
				-- select id into dc from t127 where c01 = oldQysj and c02 = oldBzlb and c03 = oldBzmc and c04 = oldJbmc;
				-- select c04 into zxgzbz from t136 where id = zxgzbz; -- 单位工资制度与人员属性信息对应关系t136.c04 执行工资标准
				-- select c02 into rysf from t136 where id = rysf; -- 单位工资制度与人员属性信息对应关系t136.c02 人员身份
				-- 人员身份-t126.c28改成码表  不用重新查询更新
				-- select c02 into rysf from t136 where id = rysf; -- 单位工资制度与人员属性信息对应关系t136.c02 人员身份
				select SUBSTR(jb FROM 1 FOR POSITION('级' IN jb)-1),SUBSTR(dc FROM 1 FOR POSITION('档' IN dc)-1) into jb,dc;
	
				
		-- 获取最高工资级别
				select t165.c04 into zggzjb from t126 , t127 , t165 
					where t127.id = t126.c17 and t127.c05 = t165.c01 and t127.c08 = t126.c39 and t165.c05=t127.c08
					and t126.id = sTemPersonId and t126.c39 = zxgzbz;
			-- set resultMsg = concat('zggzjb:',zggzjb);leave label_pro;
				if jb <= zggzjb then
					set newJb = jb;
					set newJb = CONCAT(newJb,'级');
					set newDc = dc + 1 ;-- 此档次上一个档次
					set newJbsj = qknx;
					set newDcsj = jbsj; -- 如果退档 则不使用新的起考年度
				else
					set newJb = jb-1;-- 级别是越小工资越高
					set newJb = CONCAT(newJb,'级');
					set newDc = dc -1 ;-- 此档次上一个档次
					set newDcsj = dcsj; -- 如果退档 则不使用新的起考年度
					set newJbsj = qknx; -- 如果退档 则不使用新的起考年度
				end if;
				
				set @t125gdjb = 0;
				set @beforegddc = 1;
				if newDc <= 0 THEN
					set @beforegddc = newDc;
					set newDc = dc;
					set newDcsj = qknx; -- 如果没有退档 则使用新的起考年度
					select ifnull(c11,0)  into  @t125gdjb from t125 where c06 = stemPersonId; -- 高定级别
				end if;
				if cast(@t125gdjb as SIGNED INTEGER) > 0 and  @beforegddc <= 0 then  -- 高定级别后档次小于1档了
						
						SET @zddc = CONCAT(@zddc,stemPersonId,','); 
						set FailIndex = FailIndex+1;-- 晋级失败人数+1	
				ELSE 

						set newDc = CONCAT(newDc,'档');-- 晋级退档 都 是级别-1 档次-1 数据库是肯定有的不需要再是否存在 
						select count(1) into sTempParam from t127 a where a.c05 = newJb  and c04 = newDc  and c03 = oldBzmc 
						and c08 = oldZxgzbz and c01 = oldQysj;-- 查询新的级别新的档次工资是否存在
						if sTempParam = 0 THEN 
							set @preDc = dc -1 ;-- 此档次上一个档次 
							if @preDc <= 0 THEN
								set @preDc = @preDc + 1;
							end if;
							select count(1) into @sTempCountParam from t127 a where a.c05=newJb 
							and c03 = oldBzmc and c08 = oldZxgzbz and c04 = CONCAT(@preDc,'档') and c01 = oldQysj;-- 上一个档次的金额
							if @sTempCountParam > 0 then 
								select c06 into sTempParam from t127 a where a.c05 = newJb  
								and c03 = oldBzmc and c08 = oldZxgzbz and c04 = CONCAT(@preDc,'档') 
								and c01 = oldQysj;-- 上一个档次的金额
								set subJe = oldJe - sTempParam + 0;
								set newJe = oldJe + subJe + 0; -- 原来薪级/档次的工资+档差工资
								insert into t127(dataclassCode,c01,c03,c04,c05,c06,c08,c_id,createDate,c_id,updateDate)
								values ('t127',oldQysj,oldBzmc,newDc,newJb,newJe,oldZxgzbz,1,SYSDATE(),1,SYSDATE());
							end if;
						end if;	
						
						select id,c06 into newDcId,newJe from t127 a where a.c05 = newJb  and c04 = newDc  and c03 = oldBzmc 
						and c08 = oldZxgzbz and c01 = oldQysj;-- 查询新的级别新的档次工资是否存在
						select count(1) into sTempNum from data_record_t126 where  dataId = sTemPersonId and changeType = chanType and ifnull(allAuditFlag,'') != '2';
						if sTempNum = 0 then 
							select DATE_FORMAT(SYSDATE(),'%Y') into @NowY;
							set @sqlstr = concat('select count(1) into @sTempNum from data_record_t126 ',
								'where  dataId = ',sTemPersonId,
								' and changeType = ',chanType,' and  exists(select 1 from data_record_t125 where data_record_t126.changesign = data_record_t125.changesign ',
								' and data_record_t125.c02 like \'',SUBSTR(qxsj from 1 for 4),'%\')');
								-- 当年只能做一次机关正常晋升级别
							PREPARE stmt FROM @sqlstr;
							EXECUTE stmt;
							set sTempNum = @sTempNum;
						end if;
						if sTempNum > 0 then 
							--  当前变动时间所有年份已经存在此变动记录类型
							SET @bdcz = CONCAT(@bdcz,stemPersonId,',');
							-- set @bdcz = replace(@bdcz,'bdcz:',''); -- 用来包装没有起考时间开始考核2年以上
							set FailIndex = FailIndex+1;
						end if;

						if sTempNum = 0 then 
							--  如果不存在此变动记录,存在先不管
							set stemSucIndex = stemSucIndex + 1; -- 晋升成功人数+1
							update t126 set c41=DATE_FORMAT(SYSDATE(),'%Y-%m-%d'),c40=chanType where id = sTemPersonId;-- 更新人员基本信息表-变动类型,变动时间
							if jhtg > 0 THEN -- 教师护士提高10%
								set jhtg = round(CAST((zwgz + newJe)*0.1 AS DECIMAL));
							end if;
							if tjtg > 0 then -- 特殊教育揭提高15%
								set tjtg = round(CAST((zwgz + newJe)*0.15 AS DECIMAL));
							end if;
							
							-- 调用upPercentJbt，更新t117津补贴金额，返回zxgzje,修改t125.c27 津补贴小计
							CALL upPercentJbt(sTemPersonId,zxgsje,zwgz,newJe,resultMsg);
							select sum(ifnull(c07+0,0)) into zxgsje from t117 where c03 = concat(sTemPersonId,'');
							update t125 set c27= zxgsje where id = salaryId;
							
							-- set gzhj = zwgz + newJe + jhtg + tjtg, ; 工资合计=职务工资+新的级别/档次工资+提高+保留
							-- 更新人员工资表t125 级别-c07,级别起考时间-c08 薪级-c09,档次起考时间-c10 薪级工资-c26 工资合计c32: 原来的职务工资+新的薪级工资+教师护士提高+特殊教育提高+c30保留特岗工资+c31基础绩效+c27津补贴合计+c44中小学老师保留10%+c45保留护士提高10%
							-- update t125 set c07=newDcId,c08=qknx,c09 = newDcId,c10=newDcsj,c26 = newJe,c32 = zwgz + newJe + jhtg + tjtg + c30 + c31+c27+c44+c45 +0 where id = salaryId ;
							update t125 set c02= @qxYearMonth,c07=newDcId,c08=newJbsj,c09 = newDcId,c10=newDcsj,c26 = newJe, 
							c32 = round(zwgz + newJe + ifnull(jhtg,0) + ifnull(tjtg,0) + ifnull(c30,0) + ifnull(c31,0)+ifnull(c27,0)+ifnull(c44,0)+ifnull(c45,0) +0,2) 
							,c34 ='',c04=yjwh,c48=''
						-- 工资变动 备注 依据文号 工资报审附件 
							where id = salaryId ;
							--  select UNIX_TIMESTAMP() into sTempParam;
							-- set chanSign = concat(sTempParam,chanType,'t126',sTemPersonId); -- 设置人员基本信息,工资信息,津补贴信息 共同的changeSign
							-- 人员基本信息-变动记录
							-- 先插入一条操作记录 基本信息的
							INSERT data_record_t126 (dataId,dataclassCode,createrId,createDate,updaterId,updateDate,unitId,
								operateTime,operateId,operateType,changeSign,changeType,c01,c02,c03,c04,c28)-- c01,c02,c03,c04,c28必填 
							select 
							id,'t126',c_id,SYSDATE(),c_id,SYSDATE(),u_id,SYSDATE(),c_id,1,chanSign,chanType,orgId,c02,c03,c04,c28
							from t126 where id = sTemPersonId;
							-- values (sTemPersonId,'t126',createrId,SYSDATE(),createrId,SYSDATE(),unitId,SYSDATE(),createrId,1,chanSign,chanType,orgId);
							
							update data_record_t126 a , t126 b set a.c01 = b.c01 ,a.c02 = b.c02,a.c03=b.c03,a.c04=b.c04,a.c05=b.c05,a.c06=b.c06,a.c07=b.c07,a.c08=b.c08,a.c09=b.c09,
								a.c10=b.c10,a.c11=b.c11,a.c12=b.c12,a.c13=b.c13,a.c14=b.c14,a.c15=b.c15,a.c16=b.c16,a.c17=b.c17,a.c18=b.c18,a.c19=b.c19,a.c20=b.c20,a.c21=b.c21,a.c22=b.c22,
								a.c23=b.c23,a.c24=b.c24,a.c25=b.c25,a.c26=b.c26,a.c27=b.c27,a.c28=b.c28,a.c29=b.c29,a.c30=b.c30,a.c31=b.c31,a.c32=b.c32,a.c33=b.c33,a.c34=b.c34,a.c35=b.c35,
								a.c36=b.c36,a.c37=b.c37,a.c38=b.c38,a.c39=b.c39,a.c40=b.c40,a.c41=b.c41,a.c42=b.c42,a.c43=b.c43,a.c44=b.c44,a.c45=b.c45,a.c46=b.c46,a.c47=b.c47,a.c48=b.c48,
								a.c49=b.c49,a.c50=b.c50
							where a.dataId = b.id and a.dataId = sTemPersonId and  a.changeSign = chanSign ;
				
							-- 人员工资信息-变动记录
							INSERT data_record_t125 (dataId,dataclassCode,createrId,createDate,updaterId,updateDate,unitId,
								operateTime,operateId,operateType,changeSign,changeType)
							values (salaryId,'t125',createrId,SYSDATE(),createrId,SYSDATE(),unitId,SYSDATE(),createrId,1,chanSign,chanType);-- 插入 人员工资信息 变动记录
							update data_record_t125 a , t125 b set a.c01 = b.c01 ,a.c02 = b.c02,a.c03=b.c03,a.c04=b.c04,a.c05=b.c05,a.c06=b.c06,a.c07=b.c07,a.c08=b.c08,a.c09=b.c09,
								a.c10=b.c10,a.c11=b.c11,a.c12=b.c12,a.c13=b.c13,a.c14=b.c14,a.c15=b.c15,a.c16=b.c16,a.c17=b.c17,a.c18=b.c18,a.c19=b.c19,a.c20=b.c20,a.c21=b.c21,a.c22=b.c22,
								a.c23=b.c23,a.c24=b.c24,a.c25=b.c25,a.c26=b.c26,a.c27=b.c27,a.c28=b.c28,a.c29=b.c29,a.c30=b.c30,a.c31=b.c31,a.c32=b.c32,a.c33=b.c33,a.c34=b.c34,a.c35=b.c35,
								a.c36=b.c36,a.c37=b.c37,a.c38=b.c38,a.c39=b.c39,a.c40=b.c40,a.c41=b.c41,a.c42=b.c42,a.c43=b.c43,a.c44=b.c44,a.c45=b.c45,a.c46=b.c46,a.c47=b.c47,a.c48=b.c48,
								a.c49=b.c49,a.c50=b.c50
							where a.dataId = b.id and a.dataId = salaryId  and a.changeSign = chanSign ;						
						
								-- --  人员津补贴-变动记录
								call upRyjbtBd(sTemPersonId,createrId,unitId,chanSign,chanType,resultMsg);
							
								-- 计算补扣发
								select id into changeId from data_record_t126 where  changeSign = chanSign;
								-- call fillCount(orgId,changeId,chanType ,chanSign,resultMsg);

							end if;	
					end if; -- 高定级别
			end if;
			
			 -- leave label_pro;
			end IF;
			
   end if;
			
	select count(1) into sTempNum from t124 where c03 = concat(sTemPersonId,'') and c01 >= jbsj and c01 < qxsj
	and EXISTS (select 1 from sys_s_data d where d.id = t124.c05); 
	if sTempNum >= 5 then  -- 起考时间开始考核5年以上
		select count(1) into sTempNum from t124 where c03 = concat(sTemPersonId,'') and c01 >= jbsj and c01 < qxsj
		and EXISTS (select 1 from sys_s_data d where d.id = t124.c05 and d.data_value < '3');
		if sTempNum < 5 then  -- 未达到5年以上称职
			SET @khfcz = CONCAT(@khfcz,stemPersonId,','); 
			set FailIndex = FailIndex+1;-- 晋级失败人数+1	
		end if;
	ELSE 
		
		select DATE_FORMAT(SYSDATE(),'%Y') into @NowY;
		set @sqlstr = concat('select count(1) into @sTempNum from data_record_t126 ',
			'where  dataId = ',sTemPersonId,
			' and changeType = ',chanType,' and  exists(select 1 from data_record_t125 where data_record_t126.changesign = data_record_t125.changesign ',
			' and data_record_t125.c02 like \'',SUBSTR(qxsj from 1 for 4),'%\')');
			-- 当年只能做一次事业正常晋升薪级
		PREPARE stmt FROM @sqlstr;
		EXECUTE stmt;
		set sTempNum = @sTempNum;
		if sTempNum > 0 then 
			--  当前变动时间所有年份已经存在此变动记录类型
			SET @bdcz = CONCAT(@bdcz,stemPersonId,',');
			set FailIndex = FailIndex+1;
		else
			set @sNum = qknx-jbsj;
			-- set resultMsg = concat('qknx:',qknx,',dcsj:',dcsj,',sNum:',@sNum);leave label_pro;
			if @sNum >= 5 then 
				SET @khsjbm = CONCAT(@khsjbm,stemPersonId,',');
				set FailIndex = FailIndex+1;
			else
				SET @qksjbz = CONCAT(@qksjbz,stemPersonId,',');
				set FailIndex = FailIndex+1;
			end if;
		end if;
	end if;


	set done = @doneF;

  END LOOP;
  -- 关闭游标
  CLOSE personId_;

-- 遍历试用期人员
set done = FALSE;
OPEN personId_2;
    loop1: LOOP
        FETCH personId_2 into sTemPersonId;

        IF done THEN
            LEAVE loop1;
        END IF;
			set @syq = concat(@syq,sTemPersonId,',');
			set FailIndex = FailIndex+1;-- 晋级失败人数+1	
    END LOOP;
close personId_2;


-- 遍历在职计发生活费人员
set done = FALSE;
OPEN personId_3;
    loop1: LOOP
        FETCH personId_3 into sTemPersonId;

        IF done THEN
            LEAVE loop1;
        END IF;
				set @jfshf = concat(@jfshf,sTemPersonId,',');
				set FailIndex = FailIndex+1;-- 晋级失败人数+1	
    END LOOP;
close personId_3;


-- 遍历所有在职停薪人员
set done = FALSE;
OPEN personId_4;
    loop1: LOOP
        FETCH personId_4 into sTemPersonId;

        IF done THEN
            LEAVE loop1;
        END IF;
				set @zztx = concat(@zztx,sTemPersonId,',');
				set FailIndex = FailIndex+1;-- 晋级失败人数+1	
    END LOOP;
close personId_4;


-- 遍历所有在职计发病假工资人员
 set done = FALSE;
 OPEN personId_5;
    loop1: LOOP
       FETCH personId_5 into sTemPersonId;

       IF done THEN
           LEAVE loop1;
        END IF;
			set @jfbj = concat(@jfbj,sTemPersonId,',');
			set FailIndex = FailIndex+1;-- 晋级失败人数+1	
   END LOOP;
close personId_5;


-- 遍历所有在职停薪人员
set done = FALSE;
OPEN personId_6;
    loop1: LOOP
        FETCH personId_6 into sTemPersonId;

        IF done THEN
            LEAVE loop1;
        END IF;
				set @jbgz0 = concat(@jbgz0,sTemPersonId,',');
				set FailIndex = FailIndex+1;-- 晋级失败人数+1	
    END LOOP;
close personId_6;


		if stemSucIndex > 0 then 
    		call p_fund_updateFlag(orgId,@re);-- 变动后更新基金isUPdateFund=1
			set resultMsg = concat('公安机关正常晋升等级工资成功:[',stemSucIndex,']人');
			set @resultM = replace(@resultM,'resultM:','');
			if stemFailIndex > 0 then 
				set resultMsg= concat(resultMsg,'（起薪时间不在',qxYearMonth,'的共[',stemFailIndex,']人，可能需要做一次性补扣发）;');
			end if ;
		 end if;
		if FailIndex > 0 then 
			set resultMsg = replace(resultMsg,'resultMsg','');
			set @failMsg = concat(@qksjbz,';',@khsjbm,';',@khfcz,';',@qxsjbd,';',@syq,';',@jfshf,';',@jfbj,';',@zztx,';',@bdcz,';',@zddc,';',@jbgz0,';');
			insert into temp_multi values(orgId,chanType,sysdate(),@failMsg);
			if stemSucIndex = 0 THEN
				-- set resultMsg= CONCAT(resultMsg,'成功:[0]人，','失败[',FailIndex,']人，是否下载失败记录?',@qksjbz,';',@khsjbm,';',@khfcz,';',@qxsjbd,';',@syq,';',@jfshf,';',@jfbj,';',@zztx,';',@bdcz,';',qxYearMonth,';',chanType,';','5');
				set resultMsg= CONCAT(resultMsg,'成功:[0]人，','失败[',FailIndex,']人，是否下载失败记录?',qxYearMonth,';',chanType,';','5');
			ELSE
				set resultMsg= CONCAT(resultMsg,'失败[',FailIndex,']人，是否下载失败记录?',qxYearMonth,';',chanType,';','5');	
				-- set resultMsg= CONCAT(resultMsg,'失败[',FailIndex,']人，是否下载失败记录?',@qksjbz,';',@khsjbm,';',@khfcz,';',@qxsjbd,';',@syq,';',@jfshf,';',@jfbj,';',@zztx,';',@bdcz,';',qxYearMonth,';',chanType,';','5');
			end if;
			set resultMsg = replace(resultMsg,'resultMsg','');
		end if;

		 if 	FailIndex = 0 || stemSucIndex= 0 then
				set resultMsg = replace(resultMsg,'resultMsg','该变动原因无晋升人员');
		 end if; 

		
  	leave label_pro;
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`upGaJgDjDc`(IN createrId int(11),IN unitId int(11),IN orgId varchar(200),IN chanType varchar(200),IN qxsj varchar(10) ,
	IN bdsj varchar(20),IN qknx varchar(4),in yjwh varchar(100),INOUT resultMsg varchar(10000) CHARSET utf8)
label_pro:BEGIN	
	-- orgId 单位id
	-- chanType 批量变动变动类型id  sys_s_data data_value = 12 机关正常晋升级别工资档次
	-- bdsj 变动时间 20160701
	-- qxsj 起薪时间 20160101
	-- DECLARE orgId varchar(100);-- 单位id
	DECLARE changeType varchar(100);-- -- 变动类型sys_s_data id
	DECLARE changeId int(11);-- -- changeId 变动记录id 主要是t126的变动记录id,此id来查询所有关联的工资t125,津贴t117 变动记录
	DECLARE personId varchar(100);-- 人员id
	DECLARE personNo varchar(100);-- 人员编号
	DECLARE salaryId varchar(100);-- 工资信息的Id
	DECLARE salaryRecordId varchar(100);-- 工资信息的recordId
	DECLARE changeTypeCode varchar(100);-- 变动类型code

	DECLARE rysf varchar(10);-- 人员身份 管理人员 工人 专业技术人员	
	DECLARE rygzzd varchar(20);-- 人员工资制度-  201 -公务员职级工资 206-警察职级工资制度
	DECLARE zxgzbz varchar(20);-- 执行工资标准- 公务员

	DECLARE zwgz double DEFAULT 0;-- 职务工资

	DECLARE gzzd varchar(50);-- 工资制度 -  201 -公务员职级工资 206-警察职级工资制度	
	
	DECLARE jb varchar(20);-- 级别
	DECLARE jbsj varchar(20);-- 级别-起考时间
	DECLARE dc varchar(20);-- 档次	
	DECLARE dcsj varchar(20);-- 档次-起考时间	
	DECLARE dcgz varchar(20);-- 档次-薪级工资
	DECLARE newDc varchar(20);-- 新档次	
	DECLARE newDcsj varchar(20);-- 新起考时间
	DECLARE newJe double DEFAULT 0;-- 新金额
	DECLARE newDcId varchar(20);-- 新档次Id
	
	DECLARE oldQysj varchar(50);-- 标准启用时间
	DECLARE oldBzlb varchar(50);-- 标准类别
	DECLARE oldBzmc varchar(50);-- 标准名称
	DECLARE oldJbmc varchar(50);-- 级别名称-档次
	DECLARE oldCjbmc varchar(50);-- 次级别名称-级别
	DECLARE oldJe double DEFAULT 0;-- 金额
	DECLARE oldZxgzbz varchar(50);-- 执行工资标准

	DECLARE subJe double DEFAULT 0;-- 档差(薪级差)金额
	DECLARE jhtg double DEFAULT 0;-- 教师护士提高10%
	DECLARE tjtg double DEFAULT 0;-- 特殊教育揭提高15%

	DECLARE qxYearMonth varchar(100);-- 起薪时间-截取 年月 2016-01
	
	DECLARE sTemPersonId varchar(100);-- 人员id-变量
	DECLARE sTempNum int(11);-- 参数
	DECLARE sTempParam int(11);-- 变动时间-(减去)起薪时间的月份

	DECLARE chanSign varchar(100);-- 变动标志

	DECLARE qxMonth varchar(10);-- 系统设置批量变动 统一起薪月份 :01表示 当年1月  11表示当年11月

	DECLARE stemSucIndex int(11) default 0;-- 批量晋升工资成功条数
	DECLARE stemFailIndex int(11) default 0;-- 批量晋升工资失败条数(需要手工补扣发人数)
	DECLARE personNum int(11);	-- 所有机关公务员在职公务员数量-排开试用期人员 
	DECLARE	FailIndex int(11) default 0; -- 晋级失败人数
	DECLARE zxgsje double DEFAULT 0;-- t117 执行公式*t117执行金额
	DECLARE c_id int(11);-- 创建人id
	DECLARE u_id int(11);-- 功能id
	DECLARE temp varchar(100); -- 最近一次变动记录的起薪时间
    DECLARE done INT DEFAULT FALSE;
    

	-- -- 所有机关公务员在职公务员-排开试用期人员
	DECLARE personId_ CURSOR FOR
   SELECT t126.id from t126 ,t125,sys_s_data d 
		where t125.c06 = concat(t126.id ,'') and d.id = t125.c36 
		and t126.c01 = concat(orgId,'') and d.data_value in( 209,210) -- t125.c36 人员工资制度为 201 -公务员职级工资 206-警察职级工资制度
		and EXISTS (select 1 from t127 where t127.id = t126.c17 and t127.c05 not like '%试用期%') -- t126.c39 执行工资标准 关联 单位工资制度与人员属性信息对应关系t136.c04 执行工资标准
	 and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
		and (ifnull(t126.c43,'') !=10487 and ifnull(t125.c26,'')!=0)  -- 排除已经停薪的人员  10487是否状态-是   级别工资是0 的不参与晋升
	and ifnull(t125.c39,'') !=10487 -- 排除计发生活费的人员
	and ifnull(t125.c40,'') !=10487 -- 排除计发病假工资的人员
	;

	-- 所有在职试用期公务员 
	DECLARE personId_2 CURSOR FOR
   SELECT t126.id from t126 ,t125,sys_s_data d 
		where t125.c06 = concat(t126.id ,'') and d.id = t125.c36 
		and t126.c01 = concat(orgId,'') and d.data_value in( 209,210) -- t125.c36 人员工资制度为 201 -公务员职级工资 206-警察职级工资制度
		and EXISTS (select 1 from t127 where t127.id = t126.c17 and t127.c05 like '%试用期%') -- t126.c39 执行工资标准 关联 单位工资制度与人员属性信息对应关系t136.c04 执行工资标准
	 and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
	and ifnull(t126.c43,'') !=10487 -- 排除已经停薪的人员  10487是否状态-是
	and ifnull(t125.c39,'') !=10487 -- 排除计发生活费的人员
	and ifnull(t125.c40,'') !=10487 -- 排除计发病假工资的人员
	;
	-- 所有在职计发生活费人员
	DECLARE personId_3 CURSOR FOR
   SELECT t126.id from t126 ,t125,sys_s_data d 
		where t125.c06 = concat(t126.id ,'') and d.id = t125.c36 
		and t126.c01 = concat(orgId,'') and d.data_value in( 209,210) -- t125.c36 人员工资制度为 201 -公务员职级工资 206-警察职级工资制度
		and EXISTS (select 1 from t127 where t127.id = t126.c17 and t127.c05 not like '%试用期%') -- t126.c39 执行工资标准 关联 单位工资制度与人员属性信息对应关系t136.c04 执行工资标准
	 and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
	and ifnull(t126.c43,'') !=10487 -- 排除已经停薪的人员  10487是否状态-是
	and ifnull(t125.c39,'') =10487 -- 计发生活费的人员
	;

	-- -- 所有在职停薪人员
	DECLARE personId_4 CURSOR FOR
   SELECT t126.id from t126 ,t125,sys_s_data d 
		where t125.c06 = concat(t126.id ,'') and d.id = t125.c36 
		and t126.c01 = concat(orgId,'') and d.data_value in( 209,210) -- t125.c36 人员工资制度为 201 -公务员职级工资 206-警察职级工资制度
		and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
	and ifnull(t126.c43,'') =10487  -- 排除已经停薪的人员  10487是否状态-是    
	and ifnull(t125.c39,'') !=10487 -- 排除计发生活费的人员
	and ifnull(t126.c40,'') !=10831 -- 排除减少人员
	;

		-- 所有在职计发病假工资人员
	DECLARE personId_5 CURSOR FOR
   SELECT t126.id from t126 ,t125,sys_s_data d 
		where t125.c06 = concat(t126.id ,'') and d.id = t125.c36 
		and t126.c01 = concat(orgId,'') and d.data_value in( 209,210) -- t125.c36 人员工资制度为 201 -公务员职级工资 206-警察职级工资制度
		and EXISTS (select 1 from t127 where t127.id = t126.c17 and t127.c05 not like '%期%') -- t126.c39 执行工资标准 关联 单位工资制度与人员属性信息对应关系t136.c04 执行工资标准
	  and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
	and ifnull(t126.c43,'') !=10487 -- 排除已经停薪的人员  10487是否状态-是
	and t125.c40 =10487 -- 计发病假工资的人员
	;
	
		-- -- 所有级别工资为0人员
	DECLARE personId_6 CURSOR FOR
   SELECT t126.id from t126 ,t125,sys_s_data d 
		where t125.c06 = concat(t126.id ,'') and d.id = t125.c36 
		and t126.c01 = concat(orgId,'') and d.data_value in( 209,210) -- t125.c36 人员工资制度为 201 -公务员职级工资 206-警察职级工资制度
		and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
	and  ifnull(t125.c32,0) = 0  --    工资合计为0 及视为停发工资
	and ifnull(t126.c43,'') !=10487   -- 排除已经停薪的人员  10487是否状态-是    
	and ifnull(t125.c39,'') !=10487 -- 排除计发生活费的人员
	and ifnull(t126.c40,'') !=10831 -- 排除减少人员
	;
	
	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
	select DATE_FORMAT(concat(qxsj,'0101'),'%Y%m'),qxsj into qxYearMonth,newDcsj;-- 起薪年月 201607,新的 档次起考时间 为 选择的起考时间
	
	select content into qxMonth from sys_s_config where enname = 'qxMonth' ;
	
	set c_id = createrId;
	set u_id = unitId;
	if length(qxsj)=4 then
		select DATE_FORMAT(concat(qxsj,'-',qxMonth,'-01'),'%Y-%m') into qxYearMonth;-- 起薪年月 2016-01
	else
		select DATE_FORMAT(qxsj,'%Y-%m') into qxYearMonth;-- 起薪年月 2016-01
 	end if;
	
	set @resultM = 'resultM:';
	set @khsjbm = 'khsjbm:';-- 考核没考2年称职的
	set @qksjbz = 'qksjbz:';-- 人员上一次变动起考时间与起薪年月-年相差不足2年
	set @khfcz = 'khfcz:';-- 考核不是称职的 用来包装考核2年，但没有达到2年称职
	set @qxsjbd = 'qxsjbd:';-- 人员起薪时间 小于等于最近一次变动记录的起薪时间
	set @syq = 'syq:';-- 试用期人员
	set @jfshf = 'jfshf:';-- 在职计发生活费人员
	set @jfbj = 'jfbj:';-- 在职计发病假工资人员
	set @zztx = 'zztx:';-- 所有在职停薪人员
	set @jbgz0 = 'jbgz0:';-- 所有级别工资为0人员
	set @bdcz = 'bdcz:';-- 当前变动类型当年已经存在
	set resultMsg = 'resultMsg';
	
	-- 打开游标
  OPEN personId_;  
  -- 开始循环
  read_loop: LOOP
    -- 提取游标里的数据，这里只有一个，多个的话也一样；
    FETCH personId_ INTO sTemPersonId;
    -- 声明结束的时候
    IF done THEN
      LEAVE read_loop;
    END IF;
	set @doneF = done;
    select count(1) into sTempNum from data_record_t126 t126 ,data_record_t125 t125 
    where  t126.dataId = sTemPersonId and t126.changeType = chanType  and t126.allAuditFlag = '2' 
    and t125.c02 >= qxYearMonth;
		
    if sTempNum = 0 then -- 起薪时间之后已经存在通过的此变动记录

	/*	-- 人员在当前单位第一次起薪时间
		select t125.c02 into @firstQxsj from data_record_t126 t126,data_record_t125 t125 
			where  t126.changesign = t125.changesign and   t126.dataId = stemPersonId and  t125.c06 = concat(t126.dataId,'') 
			and t126.c01 = concat(orgId,'') and t126.changetype in(10750,10832) order by t126.id desc  limit 0,1;

		
		-- 重新确定工资
		select count(1) into @cxqdNum from data_record_t126 t126 ,data_record_t125 t125
    	where  t126.changesign = t125.changesign and  t126.dataId = stemPersonId and t125.c06 = concat(t126.dataId,'') 
    	 and t126.changeType in(select id from sys_s_data d where d.typename = 'bdlx' and data_value = '05')
    	 and t126.c01 = concat(orgId,'') 
    	 order by t125.id desc 
    	 limit 0,1;-- 重新确定工资
		if @cxqdNum > 0 then 
	    	select t125.c02 into @firstQxsj from data_record_t126 t126 ,data_record_t125 t125
	    	where  t126.changesign = t125.changesign and  t126.dataId = stemPersonId and t125.c06 = concat(t126.dataId,'') 
	    	 and t126.changeType in(select id from sys_s_data d where d.typename = 'bdlx' and data_value = '05')
	    	 and t126.c01 = concat(orgId,'') 
	    	 order by t125.id desc 
	    	 limit 0,1;-- 重新确定工资
		end if;*/
		-- 人员在本单位最后一次起薪（录入或调入）时间、重新确定工资起薪时间、工资制度变化起薪时间 取最大的一个起薪时间
		call p_person_getQxsj(sTemPersonId,@firstQxsj);-- 根据人员当前单位及身份等获取最早起薪时间
		
		select PERIOD_DIFF(replace(@firstQxsj,'-',''),replace(qxYearMonth,'-','')) into @stemNum; -- 判断 起薪时间201601与当前人员在该单位首次起薪时间201602 
	-- 	set resultMsg = concat('qxYearMonth:',qxYearMonth,',@firstQxsj:',@firstQxsj,',@stemNum:',@stemNum);leave label_pro;
		
		if @stemNum > 0 then -- 设置人员起薪时间  如果在单位首次起薪为201602,则设置为2016-02 如果一直在 则为为 2016-01 
			set @qxYearMonth = @firstQxsj;
		else 
			set @qxYearMonth = qxYearMonth;
		end if;
		
   	 -- 循环查询人员工资信息
		-- t125 人员工资信息表 c07-工资级别-关联工资标准表t127.c05次级别名称,c08-级别起考时间,c09-工资档次-关联工资标准表-c04级别名称,c10-档次起考时间,c25-职务工资,c26-级别工资,c28-教师护士提高10%,c29-特殊教育提高15%,c36-人员工资制度-字符型
		-- t126 人员基本信息表 c28-人员身份-关联 单位工资制度与人员属性信息对应关系.人员身份 t126.c39-执行工资标准-关联 单位工资制度与人员属性信息对应关系.执行工资标准 t125.c27-津补贴小计
		select t125.id,t125.c07,t125.c08,t125.c09,t125.c10,round(t125.c25,2),round(t125.c26,2),round(t125.c28,2),round(t125.c29,2),t125.c36,t126.c28,t126.c39,round(t125.c27,2) 
		into salaryId,jb,jbsj,dc,dcsj,zwgz,dcgz,jhtg,tjtg,rygzzd,rysf,zxgzbz,zxgsje
		from t126,t125 where t125.c06 = t126.id and t126.id = sTemPersonId ; -- t125 人员工资表 c06-人员编号 关联型
		set dcsj = SUBSTR(dcsj FROM 1 FOR 4);-- 2016-07-01 to 2016
		-- t124 人员年度考核情况表 c03人员编号  关联型 c01-考核年度 c05-考核结果 码表, 1-优秀 2-称职 3-基本称职 4-不称职 5-不参与考核
			 -- 起考年度-2012与起薪时间-2017-01-01之间 考核年度[2012,2013,2014,2015,2016]机关连续2年以上考核 称职以上 升一档 
		
		select count(1) into sTempNum from t124 where c03 = concat(sTemPersonId,'') and c01 >= dcsj and c01 < qxsj
			and EXISTS (select 1 from sys_s_data d where d.id = t124.c05 and d.data_value < '3');
		select c04 into @personName from t126 where id = stemPersonId; -- 人员姓名
		if sTempNum >= 2 then -- 满足起考年度开始连续2年称职以上 升-档
			-- 对起薪时间与最近一次未通过审核的变动记录的起薪时间进行比较,如果起薪时间在这变动记录之前,不能晋升
			 select UNIX_TIMESTAMP() into sTempParam;
			 set chanSign = concat('batch',sTempParam,chanType,'t126',sTemPersonId);
			 -- set chanSign = concat('\'',chanSign,'\'');
			 
			set temp = '';
			if(	EXISTS(select 1 from data_record_t125 a -- 人员在目前单位的变动记录ID并且ID大于人员在当前单位最新的一次录入或者接收人员变动
					where  a.dataId = salaryId   and a.allAuditFlag<>2 and a.perAuditFlag<>2 and a.id >= (select id from data_record_t125 where changeSign =
 (select changeSign from data_record_t126 where dataId = sTemPersonId AND c01 = (select c01 from t126 where id = sTemPersonId) and  (c40 = '10750' or c40 = '10832') order by id desc LIMIT 1))
					order by a.updateDate desc LIMIT 0,1)) THEN  -- 判断是否存在结果 存在则赋值
						select a.c02 into temp from data_record_t125 a  
						where  a.dataId = salaryId  and a.allAuditFlag<>2 and a.perAuditFlag<>2
						order by a.updateDate desc LIMIT 0,1;
			end if;
			IF  @qxYearMonth < temp THEN -- 人员起薪时间 小于等于最近一次变动记录的起薪时间
				SET @qxsjbd = CONCAT(@qxsjbd,stemPersonId,'-',@qxYearMonth,','); 
				set FailIndex = FailIndex+1;-- 晋级失败人数+1	
			else 
							/** select t125.c02 into @firstQxsj from data_data_record t126,data_data_record t125 
				where t126.dataclassCode = 't126' and t125.dataclassCode = 't125' 
				and t126.dataId = stemPersonId and t125.c06 = t126.dataId limit 0,1;
				*/
				-- set @stemQxsj = @qxYearMonth;
			-- set resultMsg = concat('firstQxsj > stemQxsj:',firstQxsj > stemQxsj);leave label_pro;
				if  @qxYearMonth !=  qxYearMonth then -- 起薪时间 与 系统设置的起薪时间不一致
				
					set @resultM = concat(@resultM,'[',@personName,':变动起薪时间',@qxYearMonth,']');
					set stemFailIndex = stemFailIndex + 1;-- 需要手工补扣发的人数+1
					-- set resultMsg = stemFailIndex;leave label_pro;
				end if;
				-- t127 工资标准表  c01-启用时间 c02-标准类别 c03-标准名称 c04-次级别名称(工资档次等) c05-次级别名称(工资级别等) c06-金额 c08-执行工资标准 c09-工资标准备注
				select c01,c02,c03,c05,c05,c06,c08 into oldQysj,oldBzlb,oldBzmc,jb,oldCjbmc,oldJe,oldZxgzbz 
				from t127 where id = jb;
				select c01 into oldQysj from t127 where c08 = oldZxgzbz ORDER BY c01 desc limit 0,1; -- 赋值最新的工资标准时间
				if dcgz != oldJe then -- 如果公务员系列的 级别工资 与查询工资标准的金额不一致 则查询符合条件的工资标准id数据
					set oldJe = dcgz;
				end if;
				select c04 ,c04 into dc,oldJbmc from t127 where id = dc;
				-- select id into jb from t127 where c01 = oldQysj and c02 = oldBzlb and c03 = oldBzmc and c04 = oldCjbmc;
				-- select id into dc from t127 where c01 = oldQysj and c02 = oldBzlb and c03 = oldBzmc and c04 = oldJbmc;
				-- select c04 into zxgzbz from t136 where id = zxgzbz; -- 单位工资制度与人员属性信息对应关系t136.c04 执行工资标准
				-- select c02 into rysf from t136 where id = rysf; -- 单位工资制度与人员属性信息对应关系t136.c02 人员身份
				-- 2017-1-6 执行工资标准-t126.c39改成 工资标准类别  码表
				-- 人员身份-t126.c28改成码表  不用重新查询更新
				select SUBSTR(dc FROM 1 FOR POSITION('档' IN dc)-1) into dc;
				set newDc = dc+1;
				set newDc = CONCAT(newDc,'档');
				select count(1) into sTempParam from t127 a where a.c04 = newDc and c05 = jb  and c03 = oldBzmc and c08 = oldZxgzbz and a.c01 = oldQysj;-- 查询新的薪级工资是否存在

				if sTempParam = 0 THEN 
					set dc = dc -1 ;-- 此薪级上一个薪级
					if dc <= 0 THEN
						set dc = dc + 1;
					end if;
					select count(1) into @sTempCountParam from t127 a where a.c05=jb and c03 = oldBzmc and c08 = oldZxgzbz and c04 = CONCAT(dc,'档') and c01 = oldQysj;-- 上一个档次的金额
					if @sTempCountParam > 0 then 
						select c06 into sTempParam from t127 a where a.c05 = jb  and c03 = oldBzmc and c08 = oldZxgzbz and c04 = CONCAT(dc,'档') and c01 = oldQysj;-- 上一个档次的金额
						set subJe = oldJe - sTempParam + 0;
						set newJe = oldJe + subJe + 0; -- 原来薪级/档次的工资+档差工资
						insert into t127(dataclassCode,c01,c03,c04,c05,c06,c08,createrId,createDate,updaterId,updateDate)
						values ('t127',oldQysj,oldBzmc,newDc,jb,newJe,oldZxgzbz,1,SYSDATE(),1,SYSDATE());
					end if;
				end if;			
				select id,c06 into newDcId,newJe from t127 a where  a.c04 = newDc and  c03 = oldBzmc and c08 = oldZxgzbz and c01 = oldQysj  and c05= jb;-- 查询新的档次工资
				select count(1) into sTempNum from data_record_t126 where dataclassCode = 't126' and dataId = sTemPersonId and changeType = chanType and ifnull(allAuditFlag,'') != '2';
				if sTempNum = 0 then 
					select DATE_FORMAT(SYSDATE(),'%Y') into @NowY;
					set @sqlstr = concat('select count(1) into @sTempNum from data_record_t126 ',
						'where  dataId = ',sTemPersonId,
						-- ' and changeType = ',chanType,' and c41 like \'',@NowY,'%\'');
						' and changeType = ',chanType,' and  exists(select 1 from data_record_t125 where data_record_t126.changesign = data_record_t125.changesign ',
						' and data_record_t125.c02 like \'',SUBSTR(qxsj from 1 for 4),'%\')');
						-- 当年只能做一次机关正常晋升级别档次
					PREPARE stmt FROM @sqlstr;
					EXECUTE stmt;
					set sTempNum = @sTempNum;
				end if;
				if sTempNum > 0 then 
					--  当前变动时间所有年份已经存在此变动记录类型
					SET @bdcz = CONCAT(@bdcz,stemPersonId,',');
					-- set @bdcz = replace(@bdcz,'bdcz:',''); -- 用来包装没有起考时间开始考核2年以上
					set FailIndex = FailIndex+1;
				end if;
				if sTempNum = 0 then 
					--  如果不存在此变动记录,存在先不管
					set stemSucIndex = stemSucIndex + 1; -- 晋升成功人数+1
					update t126 set c41=DATE_FORMAT(SYSDATE(),'%Y-%m-%d'),c40=chanType where id = sTemPersonId;-- 更新人员基本信息表-变动类型,变动时间
					if jhtg > 0 THEN -- 教师护士提高10%
						set jhtg = round(CAST((zwgz + newJe)*0.1 AS DECIMAL));
					end if;
					if tjtg > 0 then -- 特殊教育揭提高15%
						set tjtg = round(CAST((zwgz + newJe)*0.15 AS DECIMAL));
					end if;
					
					-- 调用upPercentJbt，更新t117津补贴金额，返回zxgzje，修改t125.c27津补贴小计
					CALL upPercentJbt(sTemPersonId,zxgsje,zwgz,newJe,resultMsg);
					select sum(ifnull(c07+0,0)) into zxgsje from t117 where c03 = concat(sTemPersonId,'');
					update t125 set c27= zxgsje where id = salaryId;
					
					-- set gzhj = zwgz + newJe + jhtg + tjtg, ; 工资合计=职务工资+新的级别/档次工资+提高+保留
					-- 更新人员工资表t125 薪级-c09 档次起考年度-c10 薪级工资-c26 工资合计c32: 原来的职务工资+新的薪级工资+教师护士提高+特殊教育提高+c30保留特岗工资+c31基础绩效+c27津补贴合计+c44中小学老师保留10%+c45保留护士提高10%
					update t125 set c02=@qxYearMonth,c09 = newDcId,c10=qknx ,c26 = newJe,
					c32 = round((ifnull(zwgz,0) + newJe + ifnull(jhtg,0) + ifnull(tjtg,0) + ifnull(c27,0)+ifnull(c30,0)+ifnull(c31,0)+ifnull(c44,0)+ifnull(c45,0)) ,2)
					,c34 ='',c04=yjwh,c48=''
				-- 工资变动 备注 依据文号 工资报审附件 
					where id = salaryId ;
					-- select UNIX_TIMESTAMP() into sTempParam;
					-- set chanSign = concat(sTempParam,chanType,'t126',sTemPersonId); -- 设置人员基本信息,工资信息,津补贴信息 共同的changeSign
					
					-- 人员基本信息-变动记录
					INSERT data_record_t126 (dataId,dataclassCode,createrId,createDate,updaterId,updateDate,unitId,
						operateTime,operateId,operateType,changeSign,changeType,c01,c02,c03,c04,c28)-- c01,c02,c03,c04,c28必填 
					select 
					id,'t126',c_id,SYSDATE(),c_id,SYSDATE(),u_id,SYSDATE(),c_id,1,chanSign,chanType,orgId,c02,c03,c04,c28
					from t126 where id = sTemPersonId;
					-- values (sTemPersonId,'t126',createrId,SYSDATE(),createrId,SYSDATE(),unitId,SYSDATE(),createrId,1,chanSign,chanType,orgId);
					update data_record_t126 a , t126 b set a.c01 = b.c01 ,a.c02 = b.c02,a.c03=b.c03,a.c04=b.c04,a.c05=b.c05,a.c06=b.c06,a.c07=b.c07,a.c08=b.c08,a.c09=b.c09,
						a.c10=b.c10,a.c11=b.c11,a.c12=b.c12,a.c13=b.c13,a.c14=b.c14,a.c15=b.c15,a.c16=b.c16,a.c17=b.c17,a.c18=b.c18,a.c19=b.c19,a.c20=b.c20,a.c21=b.c21,a.c22=b.c22,
						a.c23=b.c23,a.c24=b.c24,a.c25=b.c25,a.c26=b.c26,a.c27=b.c27,a.c28=b.c28,a.c29=b.c29,a.c30=b.c30,a.c31=b.c31,a.c32=b.c32,a.c33=b.c33,a.c34=b.c34,a.c35=b.c35,
						a.c36=b.c36,a.c37=b.c37,a.c38=b.c38,a.c39=b.c39,a.c40=b.c40,a.c41=b.c41,a.c42=b.c42,a.c43=b.c43,a.c44=b.c44,a.c45=b.c45,a.c46=b.c46,a.c47=b.c47,a.c48=b.c48,
						a.c49=b.c49,a.c50=b.c50
					where a.dataId = b.id and a.dataId = sTemPersonId and  a.changeSign = chanSign ;
		
					-- 人员工资信息-变动记录
					INSERT data_record_t125 (dataId,dataclassCode,createrId,createDate,updaterId,updateDate,unitId,
		 				operateTime,operateId,operateType,changeSign,changeType)
					values (salaryId,'t125',createrId,SYSDATE(),createrId,SYSDATE(),unitId,SYSDATE(),createrId,1,chanSign,chanType);-- 插入 人员工资信息 变动记录
					update data_record_t125 a , t125 b set a.c01 = b.c01 ,a.c02 = b.c02,a.c03=b.c03,a.c04=b.c04,a.c05=b.c05,a.c06=b.c06,a.c07=b.c07,a.c08=b.c08,a.c09=b.c09,
						a.c10=b.c10,a.c11=b.c11,a.c12=b.c12,a.c13=b.c13,a.c14=b.c14,a.c15=b.c15,a.c16=b.c16,a.c17=b.c17,a.c18=b.c18,a.c19=b.c19,a.c20=b.c20,a.c21=b.c21,a.c22=b.c22,
						a.c23=b.c23,a.c24=b.c24,a.c25=b.c25,a.c26=b.c26,a.c27=b.c27,a.c28=b.c28,a.c29=b.c29,a.c30=b.c30,a.c31=b.c31,a.c32=b.c32,a.c33=b.c33,a.c34=b.c34,a.c35=b.c35,
						a.c36=b.c36,a.c37=b.c37,a.c38=b.c38,a.c39=b.c39,a.c40=b.c40,a.c41=b.c41,a.c42=b.c42,a.c43=b.c43,a.c44=b.c44,a.c45=b.c45,a.c46=b.c46,a.c47=b.c47,a.c48=b.c48,
						a.c49=b.c49,a.c50=b.c50
					where a.dataId = b.id and a.dataId = salaryId and  a.changeSign = chanSign ;						
				
					-- --  人员津补贴-变动记录
					call upRyjbtBd(sTemPersonId,createrId,unitId,chanSign,chanType,resultMsg);
					
					-- 计算补扣发
					select id into changeId from data_record_t126 where  changeSign = chanSign;
					-- call fillCount(orgId,changeId,chanType ,chanSign,resultMsg);
				end  if;
			end if;
		end if;
	end if;	
	select count(1) into sTempNum from t124 where c03 = concat(sTemPersonId,'') and c01 >= dcsj and c01 < qxsj
			and EXISTS (select 1 from sys_s_data d where t124.c05 = d.id); 
	if sTempNum >= 2 then  -- 起考时间开始考核2年以上
		select count(1) into sTempNum from t124 where c03 = concat(sTemPersonId,'') and c01 >= dcsj and c01 < qxsj
		and EXISTS (select 1 from sys_s_data d where d.id = t124.c05 and d.data_value < '3');
		if sTempNum < 2 then  -- 未达到2年以上称职
			SET @khfcz = CONCAT(@khfcz,stemPersonId,','); 
			set FailIndex = FailIndex+1;-- 晋级失败人数+1	
		end if;
	ELSE 
		
		select DATE_FORMAT(SYSDATE(),'%Y') into @NowY;
		set @sqlstr = concat('select count(1) into @sTempNum from data_record_t126 ',
			'where  dataId = ',sTemPersonId,
			-- ' and changeType = ',chanType,' and c41 like \'',@NowY,'%\'');
			' and changeType = ',chanType,' and  exists(select 1 from data_record_t125 where data_record_t126.changesign = data_record_t125.changesign ',
			' and data_record_t125.c02 like \'',SUBSTR(qxsj from 1 for 4),'%\')');
			-- 当年只能做一次事业正常晋升薪级
		PREPARE stmt FROM @sqlstr;
		EXECUTE stmt;
		set sTempNum = @sTempNum;
		if sTempNum > 0 then 
			--  当前变动时间所有年份已经存在此变动记录类型
			SET @bdcz = CONCAT(@bdcz,stemPersonId,',');
			set FailIndex = FailIndex+1;
		else
			set @sNum = qknx-dcsj;
			if @sNum >= 2 then 
				SET @khsjbm = CONCAT(@khsjbm,stemPersonId,',');
				set FailIndex = FailIndex+1;
			else
				SET @qksjbz = CONCAT(@qksjbz,stemPersonId,',');
				set FailIndex = FailIndex+1;
			end if;
		end if;
	end if;
	
	set done = @doneF;
  END LOOP;

  -- 关闭游标
CLOSE personId_;	


-- 遍历试用期人员
set done = FALSE;
OPEN personId_2;
    loop1: LOOP
        FETCH personId_2 into sTemPersonId;
        IF done THEN
            LEAVE loop1;
        END IF;
			set @syq = concat(@syq,sTemPersonId,',');
			set FailIndex = FailIndex+1;-- 晋级失败人数+1	
    END LOOP;
close personId_2;


-- 遍历在职计发生活费人员
set done = FALSE;
OPEN personId_3;
    loop1: LOOP
        FETCH personId_3 into sTemPersonId;

        IF done THEN
            LEAVE loop1;
        END IF;
			set @jfshf = concat(@jfshf,sTemPersonId,',');
			set FailIndex = FailIndex+1;-- 晋级失败人数+1	
    END LOOP;
close personId_3;


-- 遍历所有在职停薪人员
set done = FALSE;
OPEN personId_4;
    loop1: LOOP
        FETCH personId_4 into sTemPersonId;

        IF done THEN
            LEAVE loop1;
        END IF;
				set @zztx = concat(@zztx,sTemPersonId,',');
				set FailIndex = FailIndex+1;-- 晋级失败人数+1	
    END LOOP;
close personId_4;

-- 遍历所有在职计发病假工资人员
 set done = FALSE;
 OPEN personId_5;
    loop1: LOOP
        FETCH personId_5 into sTemPersonId;

       IF done THEN
            LEAVE loop1;
        END IF;
				set @jfbj = concat(@jfbj,sTemPersonId,',');
				set FailIndex = FailIndex+1;-- 晋级失败人数+1	
    END LOOP;
close personId_5;

-- 遍历所有在职停薪人员
set done = FALSE;
OPEN personId_6;
    loop1: LOOP
        FETCH personId_6 into sTemPersonId;

        IF done THEN
            LEAVE loop1;
        END IF;
				set @jbgz0 = concat(@jbgz0,sTemPersonId,',');
				set FailIndex = FailIndex+1;-- 晋级失败人数+1	
    END LOOP;
close personId_6;


		if stemSucIndex > 0 then 
    		call p_fund_updateFlag(orgId,@re);-- 变动后更新基金isUPdateFund=1
	  		set resultMsg = concat('公安机关正常晋升等级工资档次成功:[',stemSucIndex,']人');
			set @resultM = replace(@resultM,'resultM:','');
			if stemFailIndex > 0 then 
				set resultMsg= concat(resultMsg,'（起薪时间不在',qxYearMonth,'的共[',stemFailIndex,']人，可能需要做一次性补扣发）;');
			end if;
		end if;
		if FailIndex > 0 then 
			set resultMsg = replace(resultMsg,'resultMsg','');
			set @failMsg = concat(@qksjbz,';',@khsjbm,';',@khfcz,';',@qxsjbd,';',@syq,';',@jfshf,';',@jfbj,';',@zztx,';',@bdcz,';',@jbgz0,';');
			insert into temp_multi values(orgId,chanType,sysdate(),@failMsg);
			if stemSucIndex = 0 THEN
				-- set resultMsg= CONCAT(resultMsg,'成功:[0]人，','失败[',FailIndex,']人，是否下载失败记录?',@qksjbz,';',@khsjbm,';',@khfcz,';',@qxsjbd,';',@syq,';',@jfshf,';',@jfbj,';',@zztx,';',@bdcz,';',qxYearMonth,';',chanType,';','2');
				set resultMsg= CONCAT(resultMsg,'成功:[0]人，','失败[',FailIndex,']人，是否下载失败记录?',qxYearMonth,';',chanType,';','2');
			ELSE
				set resultMsg= CONCAT(resultMsg,'失败[',FailIndex,']人，是否下载失败记录?',qxYearMonth,';',chanType,';','2');	
				-- set resultMsg= CONCAT(resultMsg,'失败[',FailIndex,']人，是否下载失败记录?',@qksjbz,';',@khsjbm,';',@khfcz,';',@qxsjbd,';',@syq,';',@jfshf,';',@jfbj,';',@zztx,';',@bdcz,';',qxYearMonth,';',chanType,';','2');
			end if;
			set resultMsg = replace(resultMsg,'resultMsg','');
		end if;
		if 	FailIndex = 0 and stemSucIndex= 0 then	
				set resultMsg = replace(resultMsg,'resultMsg','该变动原因无晋升人员');
		end if;
  	leave label_pro;
			
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`upJb`(IN createrId int(11),IN unitId int(11),IN orgId varchar(200),IN chanType varchar(200),IN qxsj varchar(10) ,
IN bdsj varchar(20),IN qknx varchar(4),in yjwh varchar(100),INOUT resultMsg varchar(20000) CHARSET utf8)
label_pro:BEGIN	
	-- orgId 单位id
	-- chanType 批量变动变动类型id
	-- bdsj 变动时间
	-- qxsj 起薪时间
	-- qknx 新起考年度
	-- yjwh 依据文号
	-- DECLARE orgId varchar(100);-- 单位id
	DECLARE changeType varchar(100);-- -- 变动类型sys_s_data id
	DECLARE changeTypeCode varchar(100);-- 变动类型code
	
	-- DECLARE rysf varchar(10);-- 人员身份 0-机关 1-事业	

	DECLARE sTempNum int(11);-- 参数
	
		
	select c02 into changeType from t134 where c01 = chanType;-- t138-批量变动与变动类型的关系 c01-批量变动代码 c02-对应变动类型代码

	-- 变动类型code 01开头-重新确定工资 11-机关正常晋升级别 12-机关正常晋升档次 13-机关工人正常晋升岗位 14-事业正常晋升薪级
	select data_value into changeTypeCode from sys_s_data where id = changeType;

	select count(1) into sTempNum from t126 where c01 = orgId;-- t126 人员基本信息 c01-单位id
	if sTempNum < 1 THEN
		set resultMsg = '当前单位没有在人员!';
		leave label_pro;
	end if;
	select count(1) into sTempNum from t126 where c01 = concat(orgId,'') and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1');-- t126 人员基本信息 c01-单位id c03-人员状态,码表sys_s_data 在职是1
	if sTempNum < 1 THEN
		set resultMsg = '当前单位没有在职人员!';
		leave label_pro;
	end if;
	-- set qxsj = replace(qxsj,'-','');-- 2016-07 to 201607	
	set bdsj = replace(bdsj,'-','');-- 2016-07-01 to 20160701

	if changeTypeCode = '101' then -- 10-机关批量正常晋升法官检察官档次
		call upJgFjDc(createrId,unitId,orgId,changeType,qxsj,bdsj,qknx,yjwh,resultMsg); 
	end if;
	if changeTypeCode = '111' THEN -- 11-机关批量正常晋升级别
		call upJgJb(createrId,unitId,orgId,changeType,qxsj,bdsj,qknx,yjwh,resultMsg); 
	end if;

	if changeTypeCode = '121' then -- 12-机关批量正常晋升档次
		call upJgDc(createrId,unitId,orgId,changeType,qxsj,bdsj,qknx,yjwh,resultMsg); 
	end if;
		
	if changeTypeCode = '131' then -- 13-机关工人批量正常晋升岗位
		call upJgGw(createrId,unitId,orgId,changeType,qxsj,bdsj,qknx,yjwh,resultMsg); 
	end if;
		
	if changeTypeCode = '141' then -- 14-事业批量正常晋升薪级
		call upSyXj(createrId,unitId,orgId,changeType,qxsj,bdsj,qknx,yjwh,resultMsg); 
	end if;
	if changeTypeCode = '301' then -- 30 事业运动员批量晋升
		call upYdyDc(createrId,unitId,orgId,changeType,qxsj,bdsj,qknx,yjwh,resultMsg); 
		-- 运动员批量晋升时，晋升的是基础津贴档次，一年晋升一次，如果到了最高的档次，计算档差后加一档即可
	end if;
	if changeTypeCode = '2011' then -- 07 公安机关正常晋升等级
		call upGaJgDj(createrId,unitId,orgId,changeType,qxsj,bdsj,qknx,yjwh,resultMsg); 
	end if;
	if changeTypeCode = '2012' then -- 08 公安机关正常晋升等级档次
		call upGaJgDjDc(createrId,unitId,orgId,changeType,qxsj,bdsj,qknx,yjwh,resultMsg); 
	end if;
		
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`upJgDc`(IN createrId int(11),IN unitId int(11),IN orgId varchar(200),IN chanType varchar(200),IN qxsj varchar(10) ,
	IN bdsj varchar(20),IN qknx varchar(4),in yjwh varchar(100),INOUT resultMsg varchar(10000) CHARSET utf8)
label_pro:BEGIN	
	-- orgId 单位id
	-- chanType 批量变动变动类型id  sys_s_data data_value = 12 机关正常晋升级别工资档次
	-- bdsj 变动时间 20160701
	-- qxsj 起薪时间 20160101
	-- DECLARE orgId varchar(100);-- 单位id
	DECLARE changeType varchar(100);-- -- 变动类型sys_s_data id
	DECLARE changeId int(11);-- -- changeId 变动记录id 主要是t126的变动记录id,此id来查询所有关联的工资t125,津贴t117 变动记录
	DECLARE personId varchar(100);-- 人员id
	DECLARE personNo varchar(100);-- 人员编号
	DECLARE salaryId varchar(100);-- 工资信息的Id
	DECLARE salaryRecordId varchar(100);-- 工资信息的recordId
	DECLARE changeTypeCode varchar(100);-- 变动类型code

	DECLARE rysf varchar(10);-- 人员身份 管理人员 工人 专业技术人员	
	DECLARE rygzzd varchar(20);-- 人员工资制度-  201 -公务员职级工资 206-警察职级工资制度
	DECLARE zxgzbz varchar(20);-- 执行工资标准- 公务员

	DECLARE zwgz double DEFAULT 0;-- 职务工资

	DECLARE gzzd varchar(50);-- 工资制度 -  201 -公务员职级工资 206-警察职级工资制度	
	
	DECLARE jb varchar(20);-- 级别
	DECLARE jbsj varchar(20);-- 级别-起考时间
	DECLARE dc varchar(20);-- 档次	
	DECLARE dcsj varchar(20);-- 档次-起考时间	
	DECLARE dcgz varchar(20);-- 档次-薪级工资
	DECLARE newDc varchar(20);-- 新档次	
	DECLARE newDcsj varchar(20);-- 新起考时间
	DECLARE newJe double DEFAULT 0;-- 新金额
	DECLARE newDcId varchar(20);-- 新档次Id
	
	DECLARE oldQysj varchar(50);-- 标准启用时间
	DECLARE oldBzlb varchar(50);-- 标准类别
	DECLARE oldBzmc varchar(50);-- 标准名称
	DECLARE oldJbmc varchar(50);-- 级别名称-档次
	DECLARE oldCjbmc varchar(50);-- 次级别名称-级别
	DECLARE oldJe double DEFAULT 0;-- 金额
	DECLARE oldZxgzbz varchar(50);-- 执行工资标准

	DECLARE subJe double DEFAULT 0;-- 档差(薪级差)金额
	DECLARE jhtg double DEFAULT 0;-- 教师护士提高10%
	DECLARE tjtg double DEFAULT 0;-- 特殊教育揭提高15%

	DECLARE qxYearMonth varchar(100);-- 起薪时间-截取 年月 2016-01
	
	DECLARE sTemPersonId varchar(100);-- 人员id-变量
	DECLARE sTempNum int(11);-- 参数
	DECLARE sTempParam int(11);-- 变动时间-(减去)起薪时间的月份

	DECLARE chanSign varchar(100);-- 变动标志

	DECLARE qxMonth varchar(10);-- 系统设置批量变动 统一起薪月份 :01表示 当年1月  11表示当年11月

	DECLARE stemSucIndex int(11) default 0;-- 批量晋升工资成功条数
	DECLARE stemFailIndex int(11) default 0;-- 批量晋升工资失败条数(需要手工补扣发人数)
	DECLARE personNum int(11);	-- 所有机关公务员在职公务员数量-排开试用期人员 
	DECLARE	FailIndex int(11) default 0; -- 晋级失败人数
	DECLARE zxgsje double DEFAULT 0;-- t117 执行公式*t117执行金额
	DECLARE c_id int(11);-- 创建人id
	DECLARE u_id int(11);-- 功能id
	DECLARE temp varchar(100); -- 最近一次变动记录的起薪时间
    DECLARE done INT DEFAULT FALSE;
    

	-- -- 所有机关公务员在职公务员-排开试用期人员
	DECLARE personId_ CURSOR FOR
   SELECT t126.id from t126 ,t125,sys_s_data d 
		where t125.c06 = concat(t126.id ,'') and d.id = t125.c36 
		and t126.c01 = concat(orgId,'') and d.data_value in( 201,206) -- t125.c36 人员工资制度为 201 -公务员职级工资 206-警察职级工资制度
		and EXISTS (select 1 from t127 where t127.id = t126.c17 and t127.c05 not like '%试用期%') -- t126.c39 执行工资标准 关联 单位工资制度与人员属性信息对应关系t136.c04 执行工资标准
	 and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
		and (ifnull(t126.c43,'') !=10487 and ifnull(t125.c26,'')!=0)  -- 排除已经停薪的人员  10487是否状态-是   级别工资是0 的不参与晋升
	and ifnull(t125.c39,'') !=10487 -- 排除计发生活费的人员
	and ifnull(t125.c40,'') !=10487 -- 排除计发病假工资的人员
	;

	-- 所有在职试用期公务员 
	DECLARE personId_2 CURSOR FOR
   SELECT t126.id from t126 ,t125,sys_s_data d 
		where t125.c06 = concat(t126.id ,'') and d.id = t125.c36 
		and t126.c01 = concat(orgId,'') and d.data_value in( 201,206) -- t125.c36 人员工资制度为 201 -公务员职级工资 206-警察职级工资制度
		and EXISTS (select 1 from t127 where t127.id = t126.c17 and t127.c05 like '%试用期%') -- t126.c39 执行工资标准 关联 单位工资制度与人员属性信息对应关系t136.c04 执行工资标准
	 and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
	and ifnull(t126.c43,'') !=10487 -- 排除已经停薪的人员  10487是否状态-是
	and ifnull(t125.c39,'') !=10487 -- 排除计发生活费的人员
	and ifnull(t125.c40,'') !=10487 -- 排除计发病假工资的人员
	;
	-- 所有在职计发生活费人员
	DECLARE personId_3 CURSOR FOR
   SELECT t126.id from t126 ,t125,sys_s_data d 
		where t125.c06 = concat(t126.id ,'') and d.id = t125.c36 
		and t126.c01 = concat(orgId,'') and d.data_value in( 201,206) -- t125.c36 人员工资制度为 201 -公务员职级工资 206-警察职级工资制度
		and EXISTS (select 1 from t127 where t127.id = t126.c17 and t127.c05 not like '%试用期%') -- t126.c39 执行工资标准 关联 单位工资制度与人员属性信息对应关系t136.c04 执行工资标准
	 and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
	and ifnull(t126.c43,'') !=10487 -- 排除已经停薪的人员  10487是否状态-是
	and ifnull(t125.c39,'') =10487 -- 计发生活费的人员
	;

	-- -- 所有在职停薪人员
	DECLARE personId_4 CURSOR FOR
   SELECT t126.id from t126 ,t125,sys_s_data d 
		where t125.c06 = concat(t126.id ,'') and d.id = t125.c36 
		and t126.c01 = concat(orgId,'') and d.data_value in( 201,206) -- t125.c36 人员工资制度为 201 -公务员职级工资 206-警察职级工资制度
		and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
	and ifnull(t126.c43,'') =10487  -- 排除已经停薪的人员  10487是否状态-是    
	and ifnull(t125.c39,'') !=10487 -- 排除计发生活费的人员
	and ifnull(t126.c40,'') !=10831 -- 排除减少人员
	;

		-- 所有在职计发病假工资人员
	DECLARE personId_5 CURSOR FOR
   SELECT t126.id from t126 ,t125,sys_s_data d 
		where t125.c06 = concat(t126.id ,'') and d.id = t125.c36 
		and t126.c01 = concat(orgId,'') and d.data_value in( 201,206) -- t125.c36 人员工资制度为 201 -公务员职级工资 206-警察职级工资制度
		and EXISTS (select 1 from t127 where t127.id = t126.c17 and t127.c05 not like '%期%') -- t126.c39 执行工资标准 关联 单位工资制度与人员属性信息对应关系t136.c04 执行工资标准
	  and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
	and ifnull(t126.c43,'') !=10487 -- 排除已经停薪的人员  10487是否状态-是
	and t125.c40 =10487 -- 计发病假工资的人员
	;
	
		-- -- 所有级别工资为0人员
	DECLARE personId_6 CURSOR FOR
   SELECT t126.id from t126 ,t125,sys_s_data d 
		where t125.c06 = concat(t126.id ,'') and d.id = t125.c36 
		and t126.c01 = concat(orgId,'') and d.data_value in( 201,206) -- t125.c36 人员工资制度为 201 -公务员职级工资 206-警察职级工资制度
		and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
	and  ifnull(t125.c32,0) = 0  --    工资合计为0 及视为停发工资
	and ifnull(t126.c43,'') !=10487   -- 排除已经停薪的人员  10487是否状态-是    
	and ifnull(t125.c39,'') !=10487 -- 排除计发生活费的人员
	and ifnull(t126.c40,'') !=10831 -- 排除减少人员
	;
	
	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
	select DATE_FORMAT(concat(qxsj,'0101'),'%Y%m'),qxsj into qxYearMonth,newDcsj;-- 起薪年月 201607,新的 档次起考时间 为 选择的起考时间
	
	select content into qxMonth from sys_s_config where enname = 'qxMonth' ;
	
	set c_id = createrId;
	set u_id = unitId;
	if length(qxsj)=4 then
		select DATE_FORMAT(concat(qxsj,'-',qxMonth,'-01'),'%Y-%m') into qxYearMonth;-- 起薪年月 2016-01
	else
		select DATE_FORMAT(qxsj,'%Y-%m') into qxYearMonth;-- 起薪年月 2016-01
 	end if;
	
	set @resultM = 'resultM:';
	set @khsjbm = 'khsjbm:';-- 考核没考2年称职的
	set @qksjbz = 'qksjbz:';-- 人员上一次变动起考时间与起薪年月-年相差不足2年
	set @khfcz = 'khfcz:';-- 考核不是称职的 用来包装考核2年，但没有达到2年称职
	set @qxsjbd = 'qxsjbd:';-- 人员起薪时间 小于等于最近一次变动记录的起薪时间
	set @syq = 'syq:';-- 试用期人员
	set @jfshf = 'jfshf:';-- 在职计发生活费人员
	set @jfbj = 'jfbj:';-- 在职计发病假工资人员
	set @zztx = 'zztx:';-- 所有在职停薪人员
	set @jbgz0 = 'jbgz0:';-- 所有级别工资为0人员
	set @bdcz = 'bdcz:';-- 当前变动类型当年已经存在
	set resultMsg = 'resultMsg';
	
	-- 打开游标
  OPEN personId_;  
  -- 开始循环
  read_loop: LOOP
    -- 提取游标里的数据，这里只有一个，多个的话也一样；
    FETCH personId_ INTO sTemPersonId;
    -- 声明结束的时候
    IF done THEN
      LEAVE read_loop;
    END IF;
	set @doneF = done;
    select count(1) into sTempNum from data_record_t126 t126 ,data_record_t125 t125 
    where  t126.dataId = sTemPersonId and t126.changeType = chanType  and t126.allAuditFlag = '2' 
    and t125.c02 >= qxYearMonth;
		
    if sTempNum = 0 then -- 起薪时间之后已经存在通过的此变动记录

	/*	-- 人员在当前单位第一次起薪时间
		select t125.c02 into @firstQxsj from data_record_t126 t126,data_record_t125 t125 
			where  t126.changesign = t125.changesign and   t126.dataId = stemPersonId and  t125.c06 = concat(t126.dataId,'') 
			and t126.c01 = concat(orgId,'') and t126.changetype in(10750,10832) order by t126.id desc  limit 0,1;

		
		-- 重新确定工资
		select count(1) into @cxqdNum from data_record_t126 t126 ,data_record_t125 t125
    	where  t126.changesign = t125.changesign and  t126.dataId = stemPersonId and t125.c06 = concat(t126.dataId,'') 
    	 and t126.changeType in(select id from sys_s_data d where d.typename = 'bdlx' and data_value = '05')
    	 and t126.c01 = concat(orgId,'') 
    	 order by t125.id desc 
    	 limit 0,1;-- 重新确定工资
		if @cxqdNum > 0 then 
	    	select t125.c02 into @firstQxsj from data_record_t126 t126 ,data_record_t125 t125
	    	where  t126.changesign = t125.changesign and  t126.dataId = stemPersonId and t125.c06 = concat(t126.dataId,'') 
	    	 and t126.changeType in(select id from sys_s_data d where d.typename = 'bdlx' and data_value = '05')
	    	 and t126.c01 = concat(orgId,'') 
	    	 order by t125.id desc 
	    	 limit 0,1;-- 重新确定工资
		end if;*/
		-- 人员在本单位最后一次起薪（录入或调入）时间、重新确定工资起薪时间、工资制度变化起薪时间 取最大的一个起薪时间
		call p_person_getQxsj(sTemPersonId,@firstQxsj);-- 根据人员当前单位及身份等获取最早起薪时间
		
		select PERIOD_DIFF(replace(@firstQxsj,'-',''),replace(qxYearMonth,'-','')) into @stemNum; -- 判断 起薪时间201601与当前人员在该单位首次起薪时间201602 
	-- 	set resultMsg = concat('qxYearMonth:',qxYearMonth,',@firstQxsj:',@firstQxsj,',@stemNum:',@stemNum);leave label_pro;
		
		if @stemNum > 0 then -- 设置人员起薪时间  如果在单位首次起薪为201602,则设置为2016-02 如果一直在 则为为 2016-01 
			set @qxYearMonth = @firstQxsj;
		else 
			set @qxYearMonth = qxYearMonth;
		end if;
		
   	 -- 循环查询人员工资信息
		-- t125 人员工资信息表 c07-工资级别-关联工资标准表t127.c05次级别名称,c08-级别起考时间,c09-工资档次-关联工资标准表-c04级别名称,c10-档次起考时间,c25-职务工资,c26-级别工资,c28-教师护士提高10%,c29-特殊教育提高15%,c36-人员工资制度-字符型
		-- t126 人员基本信息表 c28-人员身份-关联 单位工资制度与人员属性信息对应关系.人员身份 t126.c39-执行工资标准-关联 单位工资制度与人员属性信息对应关系.执行工资标准 t125.c27-津补贴小计
		select t125.id,t125.c07,t125.c08,t125.c09,t125.c10,round(t125.c25,2),round(t125.c26,2),round(t125.c28,2),round(t125.c29,2),t125.c36,t126.c28,t126.c39,round(t125.c27,2) 
		into salaryId,jb,jbsj,dc,dcsj,zwgz,dcgz,jhtg,tjtg,rygzzd,rysf,zxgzbz,zxgsje
		from t126,t125 where t125.c06 = t126.id and t126.id = sTemPersonId ; -- t125 人员工资表 c06-人员编号 关联型
		set dcsj = SUBSTR(dcsj FROM 1 FOR 4);-- 2016-07-01 to 2016
		-- t124 人员年度考核情况表 c03人员编号  关联型 c01-考核年度 c05-考核结果 码表, 1-优秀 2-称职 3-基本称职 4-不称职 5-不参与考核
			 -- 起考年度-2012与起薪时间-2017-01-01之间 考核年度[2012,2013,2014,2015,2016]机关连续2年以上考核 称职以上 升一档 
		
		select count(1) into sTempNum from t124 where c03 = concat(sTemPersonId,'') and c01 >= dcsj and c01 < qxsj
			and EXISTS (select 1 from sys_s_data d where d.id = t124.c05 and d.data_value < '3');
		select c04 into @personName from t126 where id = stemPersonId; -- 人员姓名
		if sTempNum >= 2 then -- 满足起考年度开始连续2年称职以上 升-档
			-- 对起薪时间与最近一次未通过审核的变动记录的起薪时间进行比较,如果起薪时间在这变动记录之前,不能晋升
			 select UNIX_TIMESTAMP() into sTempParam;
			 set chanSign = concat('batch',sTempParam,chanType,'t126',sTemPersonId);
			 -- set chanSign = concat('\'',chanSign,'\'');
			 
			set temp = '';
			if(	EXISTS(select 1 from data_record_t125 a -- 人员在目前单位的变动记录ID并且ID大于人员在当前单位最新的一次录入或者接收人员变动
					where  a.dataId = salaryId   and a.allAuditFlag<>2 and a.perAuditFlag<>2 and a.id >= (select id from data_record_t125 where changeSign =
 (select changeSign from data_record_t126 where dataId = sTemPersonId AND c01 = (select c01 from t126 where id = sTemPersonId) and  (c40 = '10750' or c40 = '10832') order by id desc LIMIT 1))
					order by a.updateDate desc LIMIT 0,1)) THEN  -- 判断是否存在结果 存在则赋值
						select a.c02 into temp from data_record_t125 a  
						where  a.dataId = salaryId  and a.allAuditFlag<>2 and a.perAuditFlag<>2
						order by a.updateDate desc LIMIT 0,1;
			end if;
			IF  @qxYearMonth < temp THEN -- 人员起薪时间 小于等于最近一次变动记录的起薪时间
				SET @qxsjbd = CONCAT(@qxsjbd,stemPersonId,'-',@qxYearMonth,','); 
				set FailIndex = FailIndex+1;-- 晋级失败人数+1	
			else 
							/** select t125.c02 into @firstQxsj from data_data_record t126,data_data_record t125 
				where t126.dataclassCode = 't126' and t125.dataclassCode = 't125' 
				and t126.dataId = stemPersonId and t125.c06 = t126.dataId limit 0,1;
				*/
				-- set @stemQxsj = @qxYearMonth;
			-- set resultMsg = concat('firstQxsj > stemQxsj:',firstQxsj > stemQxsj);leave label_pro;
				if  @qxYearMonth !=  qxYearMonth then -- 起薪时间 与 系统设置的起薪时间不一致
				
					set @resultM = concat(@resultM,'[',@personName,':变动起薪时间',@qxYearMonth,']');
					set stemFailIndex = stemFailIndex + 1;-- 需要手工补扣发的人数+1
					-- set resultMsg = stemFailIndex;leave label_pro;
				end if;
				-- t127 工资标准表  c01-启用时间 c02-标准类别 c03-标准名称 c04-次级别名称(工资档次等) c05-次级别名称(工资级别等) c06-金额 c08-执行工资标准 c09-工资标准备注
				select c01,c02,c03,c05,c05,c06,c08 into oldQysj,oldBzlb,oldBzmc,jb,oldCjbmc,oldJe,oldZxgzbz 
				from t127 where id = jb;
				select c01 into oldQysj from t127 where c08 = oldZxgzbz ORDER BY c01 desc limit 0,1; -- 赋值最新的工资标准时间
				if dcgz != oldJe then -- 如果公务员系列的 级别工资 与查询工资标准的金额不一致 则查询符合条件的工资标准id数据
					set oldJe = dcgz;
				end if;
				select c04 ,c04 into dc,oldJbmc from t127 where id = dc;
				-- select id into jb from t127 where c01 = oldQysj and c02 = oldBzlb and c03 = oldBzmc and c04 = oldCjbmc;
				-- select id into dc from t127 where c01 = oldQysj and c02 = oldBzlb and c03 = oldBzmc and c04 = oldJbmc;
				-- select c04 into zxgzbz from t136 where id = zxgzbz; -- 单位工资制度与人员属性信息对应关系t136.c04 执行工资标准
				-- select c02 into rysf from t136 where id = rysf; -- 单位工资制度与人员属性信息对应关系t136.c02 人员身份
				-- 2017-1-6 执行工资标准-t126.c39改成 工资标准类别  码表
				-- 人员身份-t126.c28改成码表  不用重新查询更新
				select SUBSTR(dc FROM 1 FOR POSITION('档' IN dc)-1) into dc;
				set newDc = dc+1;
				set newDc = CONCAT(newDc,'档');
				select count(1) into sTempParam from t127 a where a.c04 = newDc and c05 = jb  and c03 = oldBzmc and c08 = oldZxgzbz and a.c01 = oldQysj;-- 查询新的薪级工资是否存在

				if sTempParam = 0 THEN 
					set dc = dc -1 ;-- 此薪级上一个薪级
					if dc <= 0 THEN
						set dc = dc + 1;
					end if;
					select count(1) into @sTempCountParam from t127 a where a.c05=jb and c03 = oldBzmc and c08 = oldZxgzbz and c04 = CONCAT(dc,'档') and c01 = oldQysj;-- 上一个档次的金额
					if @sTempCountParam > 0 then 
						select c06 into sTempParam from t127 a where a.c05 = jb  and c03 = oldBzmc and c08 = oldZxgzbz and c04 = CONCAT(dc,'档') and c01 = oldQysj;-- 上一个档次的金额
						set subJe = oldJe - sTempParam + 0;
						set newJe = oldJe + subJe + 0; -- 原来薪级/档次的工资+档差工资
						insert into t127(dataclassCode,c01,c03,c04,c05,c06,c08,createrId,createDate,updaterId,updateDate)
						values ('t127',oldQysj,oldBzmc,newDc,jb,newJe,oldZxgzbz,1,SYSDATE(),1,SYSDATE());
					end if;
				end if;			
				select id,c06 into newDcId,newJe from t127 a where  a.c04 = newDc and  c03 = oldBzmc and c08 = oldZxgzbz and c01 = oldQysj  and c05= jb;-- 查询新的档次工资
				select count(1) into sTempNum from data_record_t126 where dataclassCode = 't126' and dataId = sTemPersonId and changeType = chanType and ifnull(allAuditFlag,'') != '2';
				if sTempNum = 0 then 
					select DATE_FORMAT(SYSDATE(),'%Y') into @NowY;
					set @sqlstr = concat('select count(1) into @sTempNum from data_record_t126 ',
						'where  dataId = ',sTemPersonId,
						-- ' and changeType = ',chanType,' and c41 like \'',@NowY,'%\'');
						' and changeType = ',chanType,' and  exists(select 1 from data_record_t125 where data_record_t126.changesign = data_record_t125.changesign ',
						' and data_record_t125.c02 like \'',SUBSTR(qxsj from 1 for 4),'%\')');
						-- 当年只能做一次机关正常晋升级别档次
					PREPARE stmt FROM @sqlstr;
					EXECUTE stmt;
					set sTempNum = @sTempNum;
				end if;
				if sTempNum > 0 then 
					--  当前变动时间所有年份已经存在此变动记录类型
					SET @bdcz = CONCAT(@bdcz,stemPersonId,',');
					-- set @bdcz = replace(@bdcz,'bdcz:',''); -- 用来包装没有起考时间开始考核2年以上
					set FailIndex = FailIndex+1;
				end if;
				if sTempNum = 0 then 
					--  如果不存在此变动记录,存在先不管
					set stemSucIndex = stemSucIndex + 1; -- 晋升成功人数+1
					update t126 set c41=DATE_FORMAT(SYSDATE(),'%Y-%m-%d'),c40=chanType where id = sTemPersonId;-- 更新人员基本信息表-变动类型,变动时间
					if jhtg > 0 THEN -- 教师护士提高10%
						set jhtg = round(CAST((zwgz + newJe)*0.1 AS DECIMAL));
					end if;
					if tjtg > 0 then -- 特殊教育揭提高15%
						set tjtg = round(CAST((zwgz + newJe)*0.15 AS DECIMAL));
					end if;
					
					-- 调用upPercentJbt，更新t117津补贴金额，返回zxgzje，修改t125.c27津补贴小计
					CALL upPercentJbt(sTemPersonId,zxgsje,zwgz,newJe,resultMsg);
					select sum(ifnull(c07+0,0)) into zxgsje from t117 where c03 = concat(sTemPersonId,'');
					update t125 set c27= zxgsje where id = salaryId;
					
					-- set gzhj = zwgz + newJe + jhtg + tjtg, ; 工资合计=职务工资+新的级别/档次工资+提高+保留
					-- 更新人员工资表t125 薪级-c09 档次起考年度-c10 薪级工资-c26 工资合计c32: 原来的职务工资+新的薪级工资+教师护士提高+特殊教育提高+c30保留特岗工资+c31基础绩效+c27津补贴合计+c44中小学老师保留10%+c45保留护士提高10%
					update t125 set c02=@qxYearMonth,c09 = newDcId,c10=qknx ,c26 = newJe,
					c32 = round((ifnull(zwgz,0) + newJe + ifnull(jhtg,0) + ifnull(tjtg,0) + ifnull(c27,0)+ifnull(c30,0)+ifnull(c31,0)+ifnull(c44,0)+ifnull(c45,0)) ,2)
					,c34 ='',c04=yjwh,c48=''
				-- 工资变动 备注 依据文号 工资报审附件 
					where id = salaryId ;
					-- select UNIX_TIMESTAMP() into sTempParam;
					-- set chanSign = concat(sTempParam,chanType,'t126',sTemPersonId); -- 设置人员基本信息,工资信息,津补贴信息 共同的changeSign
					
					-- 人员基本信息-变动记录
					INSERT data_record_t126 (dataId,dataclassCode,createrId,createDate,updaterId,updateDate,unitId,
						operateTime,operateId,operateType,changeSign,changeType,c01,c02,c03,c04,c28)-- c01,c02,c03,c04,c28必填 
					select 
					id,'t126',c_id,SYSDATE(),c_id,SYSDATE(),u_id,SYSDATE(),c_id,1,chanSign,chanType,orgId,c02,c03,c04,c28
					from t126 where id = sTemPersonId;
					-- values (sTemPersonId,'t126',createrId,SYSDATE(),createrId,SYSDATE(),unitId,SYSDATE(),createrId,1,chanSign,chanType,orgId);
					update data_record_t126 a , t126 b set a.c01 = b.c01 ,a.c02 = b.c02,a.c03=b.c03,a.c04=b.c04,a.c05=b.c05,a.c06=b.c06,a.c07=b.c07,a.c08=b.c08,a.c09=b.c09,
						a.c10=b.c10,a.c11=b.c11,a.c12=b.c12,a.c13=b.c13,a.c14=b.c14,a.c15=b.c15,a.c16=b.c16,a.c17=b.c17,a.c18=b.c18,a.c19=b.c19,a.c20=b.c20,a.c21=b.c21,a.c22=b.c22,
						a.c23=b.c23,a.c24=b.c24,a.c25=b.c25,a.c26=b.c26,a.c27=b.c27,a.c28=b.c28,a.c29=b.c29,a.c30=b.c30,a.c31=b.c31,a.c32=b.c32,a.c33=b.c33,a.c34=b.c34,a.c35=b.c35,
						a.c36=b.c36,a.c37=b.c37,a.c38=b.c38,a.c39=b.c39,a.c40=b.c40,a.c41=b.c41,a.c42=b.c42,a.c43=b.c43,a.c44=b.c44,a.c45=b.c45,a.c46=b.c46,a.c47=b.c47,a.c48=b.c48,
						a.c49=b.c49,a.c50=b.c50
					where a.dataId = b.id and a.dataId = sTemPersonId and  a.changeSign = chanSign ;
		
					-- 人员工资信息-变动记录
					INSERT data_record_t125 (dataId,dataclassCode,createrId,createDate,updaterId,updateDate,unitId,
		 				operateTime,operateId,operateType,changeSign,changeType)
					values (salaryId,'t125',createrId,SYSDATE(),createrId,SYSDATE(),unitId,SYSDATE(),createrId,1,chanSign,chanType);-- 插入 人员工资信息 变动记录
					update data_record_t125 a , t125 b set a.c01 = b.c01 ,a.c02 = b.c02,a.c03=b.c03,a.c04=b.c04,a.c05=b.c05,a.c06=b.c06,a.c07=b.c07,a.c08=b.c08,a.c09=b.c09,
						a.c10=b.c10,a.c11=b.c11,a.c12=b.c12,a.c13=b.c13,a.c14=b.c14,a.c15=b.c15,a.c16=b.c16,a.c17=b.c17,a.c18=b.c18,a.c19=b.c19,a.c20=b.c20,a.c21=b.c21,a.c22=b.c22,
						a.c23=b.c23,a.c24=b.c24,a.c25=b.c25,a.c26=b.c26,a.c27=b.c27,a.c28=b.c28,a.c29=b.c29,a.c30=b.c30,a.c31=b.c31,a.c32=b.c32,a.c33=b.c33,a.c34=b.c34,a.c35=b.c35,
						a.c36=b.c36,a.c37=b.c37,a.c38=b.c38,a.c39=b.c39,a.c40=b.c40,a.c41=b.c41,a.c42=b.c42,a.c43=b.c43,a.c44=b.c44,a.c45=b.c45,a.c46=b.c46,a.c47=b.c47,a.c48=b.c48,
						a.c49=b.c49,a.c50=b.c50
					where a.dataId = b.id and a.dataId = salaryId and  a.changeSign = chanSign ;						
				
					-- --  人员津补贴-变动记录
					call upRyjbtBd(sTemPersonId,createrId,unitId,chanSign,chanType,resultMsg);
					
					-- 计算补扣发
					select id into changeId from data_record_t126 where  changeSign = chanSign;
					-- call fillCount(orgId,changeId,chanType ,chanSign,resultMsg);
				end  if;
			end if;
		end if;
	end if;	
	select count(1) into sTempNum from t124 where c03 = concat(sTemPersonId,'') and c01 >= dcsj and c01 < qxsj
			and EXISTS (select 1 from sys_s_data d where t124.c05 = d.id); 
	if sTempNum >= 2 then  -- 起考时间开始考核2年以上
		select count(1) into sTempNum from t124 where c03 = concat(sTemPersonId,'') and c01 >= dcsj and c01 < qxsj
		and EXISTS (select 1 from sys_s_data d where d.id = t124.c05 and d.data_value < '3');
		if sTempNum < 2 then  -- 未达到2年以上称职
			SET @khfcz = CONCAT(@khfcz,stemPersonId,','); 
			set FailIndex = FailIndex+1;-- 晋级失败人数+1	
		end if;
	ELSE 
		
		select DATE_FORMAT(SYSDATE(),'%Y') into @NowY;
		set @sqlstr = concat('select count(1) into @sTempNum from data_record_t126 ',
			'where  dataId = ',sTemPersonId,
			-- ' and changeType = ',chanType,' and c41 like \'',@NowY,'%\'');
			' and changeType = ',chanType,' and  exists(select 1 from data_record_t125 where data_record_t126.changesign = data_record_t125.changesign ',
			' and data_record_t125.c02 like \'',SUBSTR(qxsj from 1 for 4),'%\')');
			-- 当年只能做一次事业正常晋升薪级
		PREPARE stmt FROM @sqlstr;
		EXECUTE stmt;
		set sTempNum = @sTempNum;
		if sTempNum > 0 then 
			--  当前变动时间所有年份已经存在此变动记录类型
			SET @bdcz = CONCAT(@bdcz,stemPersonId,',');
			set FailIndex = FailIndex+1;
		else
			set @sNum = qknx-dcsj;
			if @sNum >= 2 then 
				SET @khsjbm = CONCAT(@khsjbm,stemPersonId,',');
				set FailIndex = FailIndex+1;
			else
				SET @qksjbz = CONCAT(@qksjbz,stemPersonId,',');
				set FailIndex = FailIndex+1;
			end if;
		end if;
	end if;
	
	set done = @doneF;
  END LOOP;

  -- 关闭游标
CLOSE personId_;	


-- 遍历试用期人员
set done = FALSE;
OPEN personId_2;
    loop1: LOOP
        FETCH personId_2 into sTemPersonId;
        IF done THEN
            LEAVE loop1;
        END IF;
			set @syq = concat(@syq,sTemPersonId,',');
			set FailIndex = FailIndex+1;-- 晋级失败人数+1	
    END LOOP;
close personId_2;


-- 遍历在职计发生活费人员
set done = FALSE;
OPEN personId_3;
    loop1: LOOP
        FETCH personId_3 into sTemPersonId;

        IF done THEN
            LEAVE loop1;
        END IF;
			set @jfshf = concat(@jfshf,sTemPersonId,',');
			set FailIndex = FailIndex+1;-- 晋级失败人数+1	
    END LOOP;
close personId_3;


-- 遍历所有在职停薪人员
set done = FALSE;
OPEN personId_4;
    loop1: LOOP
        FETCH personId_4 into sTemPersonId;

        IF done THEN
            LEAVE loop1;
        END IF;
				set @zztx = concat(@zztx,sTemPersonId,',');
				set FailIndex = FailIndex+1;-- 晋级失败人数+1	
    END LOOP;
close personId_4;

-- 遍历所有在职计发病假工资人员
 set done = FALSE;
 OPEN personId_5;
    loop1: LOOP
        FETCH personId_5 into sTemPersonId;

       IF done THEN
            LEAVE loop1;
        END IF;
				set @jfbj = concat(@jfbj,sTemPersonId,',');
				set FailIndex = FailIndex+1;-- 晋级失败人数+1	
    END LOOP;
close personId_5;

-- 遍历所有在职停薪人员
set done = FALSE;
OPEN personId_6;
    loop1: LOOP
        FETCH personId_6 into sTemPersonId;

        IF done THEN
            LEAVE loop1;
        END IF;
				set @jbgz0 = concat(@jbgz0,sTemPersonId,',');
				set FailIndex = FailIndex+1;-- 晋级失败人数+1	
    END LOOP;
close personId_6;


		if stemSucIndex > 0 then 
    		call p_fund_updateFlag(orgId,@re);-- 变动后更新基金isUPdateFund=1
	  		set resultMsg = concat('机关正常晋升级别工资档次成功:[',stemSucIndex,']人');
			set @resultM = replace(@resultM,'resultM:','');
			if stemFailIndex > 0 then 
				set resultMsg= concat(resultMsg,'（起薪时间不在',qxYearMonth,'的共[',stemFailIndex,']人，可能需要做一次性补扣发）;');
			end if;
		end if;
		if FailIndex > 0 then 
			set resultMsg = replace(resultMsg,'resultMsg','');
			set @failMsg = concat(@qksjbz,';',@khsjbm,';',@khfcz,';',@qxsjbd,';',@syq,';',@jfshf,';',@jfbj,';',@zztx,';',@bdcz,';',@jbgz0,';');
			insert into temp_multi values(orgId,chanType,sysdate(),@failMsg);
			if stemSucIndex = 0 THEN
				-- set resultMsg= CONCAT(resultMsg,'成功:[0]人，','失败[',FailIndex,']人，是否下载失败记录?',@qksjbz,';',@khsjbm,';',@khfcz,';',@qxsjbd,';',@syq,';',@jfshf,';',@jfbj,';',@zztx,';',@bdcz,';',qxYearMonth,';',chanType,';','2');
				set resultMsg= CONCAT(resultMsg,'成功:[0]人，','失败[',FailIndex,']人，是否下载失败记录?',qxYearMonth,';',chanType,';','2');
			ELSE
				set resultMsg= CONCAT(resultMsg,'失败[',FailIndex,']人，是否下载失败记录?',qxYearMonth,';',chanType,';','2');	
				-- set resultMsg= CONCAT(resultMsg,'失败[',FailIndex,']人，是否下载失败记录?',@qksjbz,';',@khsjbm,';',@khfcz,';',@qxsjbd,';',@syq,';',@jfshf,';',@jfbj,';',@zztx,';',@bdcz,';',qxYearMonth,';',chanType,';','2');
			end if;
			set resultMsg = replace(resultMsg,'resultMsg','');
		end if;
		if 	FailIndex = 0 and stemSucIndex= 0 then	
				set resultMsg = replace(resultMsg,'resultMsg','该变动原因无晋升人员');
		end if;
  	leave label_pro;
			
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`upJgFjDc`(IN createrId int(11),IN unitId int(11),IN orgId varchar(200),IN chanType varchar(200),IN qxsj varchar(10) ,
	IN bdsj varchar(20),IN qknx varchar(4),in yjwh varchar(100),INOUT resultMsg varchar(10000) CHARSET utf8)
label_pro:BEGIN	
	-- orgId 单位id
	-- chanType 批量变动变动类型id  sys_s_data data_value = 12 机关正常晋升级别工资档次
	-- bdsj 变动时间 20160701
	-- qxsj 起薪时间 20160101
	-- yjwh 依据文号
	-- DECLARE orgId varchar(100);-- 单位id
	DECLARE changeType varchar(100);-- -- 变动类型sys_s_data id
	DECLARE changeId int(11);-- -- changeId 变动记录id 主要是t126的变动记录id,此id来查询所有关联的工资t125,津贴t117 变动记录
	DECLARE personId varchar(100);-- 人员id
	DECLARE personNo varchar(100);-- 人员编号
	DECLARE salaryId varchar(100);-- 工资信息的Id
	DECLARE salaryRecordId varchar(100);-- 工资信息的recordId
	DECLARE changeTypeCode varchar(100);-- 变动类型code

	DECLARE rysf varchar(10);-- 人员身份 管理人员 工人 专业技术人员	
	DECLARE rygzzd varchar(20);-- 人员工资制度- 207-法官职级工资制 208-检察官职级工资制
	DECLARE zxgzbz varchar(20);-- 执行工资标准- 公务员
	DECLARE gzdyzz varchar(20);-- 工资对应职级

	DECLARE zwgz double DEFAULT 0;-- 职务工资

	DECLARE gzzd varchar(50);-- 工资制度 - 207-法官职级工资制 208-检察官职级工资制	
	
	DECLARE jb varchar(20);-- 级别
	DECLARE jbsj varchar(20);-- 级别-起考时间
	DECLARE dc varchar(20);-- 档次	
	DECLARE dcsj varchar(20);-- 档次-起考时间	
	DECLARE dcgz varchar(20);-- 档次-薪级工资
	DECLARE newDc varchar(20);-- 新档次	
	DECLARE newDcsj varchar(20);-- 新起考时间
	DECLARE newJe double DEFAULT 0;-- 新金额
	DECLARE newDcId varchar(20);-- 新档次Id
	
	DECLARE oldQysj varchar(50);-- 标准启用时间
	DECLARE oldBzlb varchar(50);-- 标准类别
	DECLARE oldBzmc varchar(50);-- 标准名称
	DECLARE oldJbmc varchar(50);-- 级别名称-档次
	DECLARE oldCjbmc varchar(50);-- 次级别名称-级别
	DECLARE oldJe double DEFAULT 0;-- 金额
	DECLARE oldZxgzbz varchar(50);-- 执行工资标准 工资标准类别 

	DECLARE subJe double DEFAULT 0;-- 档差(薪级差)金额
	DECLARE jhtg double DEFAULT 0;-- 教师护士提高10%
	DECLARE tjtg double DEFAULT 0;-- 特殊教育揭提高15%

	DECLARE qxYearMonth varchar(100);-- 起薪时间-截取 年月 2016-01
	
	DECLARE sTemPersonId varchar(100);-- 人员id-变量
	DECLARE sTempNum int(11);-- 参数
	DECLARE sTempParam int(11);-- 变动时间-(减去)起薪时间的月份

	DECLARE chanSign varchar(100);-- 变动标志

	DECLARE qxMonth varchar(10);-- 系统设置批量变动 统一起薪月份 :01表示 当年1月  11表示当年11月

	DECLARE stemSucIndex int(11) default 0;-- 批量晋升工资成功条数
	DECLARE stemFailIndex int(11) default 0;-- 批量晋升工资失败条数(需要手工补扣发人数)
	DECLARE personNum int(11);	-- 所有机关公务员在职公务员数量-排开试用期人员 
	DECLARE	FailIndex int(11) default 0; -- 晋级失败人数
	DECLARE zxgsje double DEFAULT 0;-- t117 执行公式*t117执行金额
	DECLARE c_id int(11);-- 创建人id
	DECLARE u_id int(11);-- 功能id
	DECLARE temp varchar(100); -- 最近一次变动记录的起薪时间
    DECLARE done INT DEFAULT FALSE;
	
	-- -- 所有机关公务员在职公务员-排开试用期人员
	DECLARE personId_ CURSOR FOR
   SELECT t126.id from t126 ,t125,sys_s_data d 
		where t125.c06 = concat(t126.id ,'') and t125.c36 =concat(d.id,'')   
		and t126.c01 = concat(orgId,'') and d.data_value in(207,208) -- t125.c36 人员工资制度为  207-法官职级工资制 208-检察官职级工资制
		and EXISTS (select 1 from t127 where t127.id = t126.c17 and t127.c05 not like '%试用期%') -- t126.c39 执行工资标准 关联 单位工资制度与人员属性信息对应关系t136.c04 执行工资标准
	   and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
		and (ifnull(t126.c43,'') !=10487 and ifnull(t125.c25,'')!=0)   -- 排除已经停薪的人员  10487是否状态-是   级别工资是0 的不参与晋升
	and ifnull(t125.c39,'') !=10487 -- 排除计发生活费的人员
	and ifnull(t125.c40,'') !=10487 -- 排除计发病假工资的人员
	;

	-- 所有在职试用期公务员 
	DECLARE personId_2 CURSOR FOR
   SELECT t126.id from t126 ,t125,sys_s_data d 
		where t125.c06 = concat(t126.id ,'') and t125.c36 =concat(d.id,'')   
		and t126.c01 = concat(orgId,'') and d.data_value in(207,208) -- t125.c36 人员工资制度为  207-法官职级工资制 208-检察官职级工资制
		and EXISTS (select 1 from t127 where t127.id = t126.c17 and t127.c05 like '%试用期%') -- t126.c39 执行工资标准 关联 单位工资制度与人员属性信息对应关系t136.c04 执行工资标准
	 and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
	and ifnull(t126.c43,'') !=10487 -- 排除已经停薪的人员  10487是否状态-是
	and ifnull(t125.c39,'') !=10487 -- 排除计发生活费的人员
	and ifnull(t125.c40,'') !=10487 -- 排除计发病假工资的人员
	;
	-- 所有在职计发生活费人员
	DECLARE personId_3 CURSOR FOR
   SELECT t126.id from t126 ,t125,sys_s_data d 
		where t125.c06 = concat(t126.id ,'') and t125.c36 =concat(d.id,'')   
		and t126.c01 = concat(orgId,'') and d.data_value in(207,208) -- t125.c36 人员工资制度为  207-法官职级工资制 208-检察官职级工资制
		and EXISTS (select 1 from t127 where t127.id = t126.c17 and t127.c05 not like '%试用期%') -- t126.c39 执行工资标准 关联 单位工资制度与人员属性信息对应关系t136.c04 执行工资标准
	 and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
	and ifnull(t126.c43,'') !=10487 -- 排除已经停薪的人员  10487是否状态-是
	and ifnull(t125.c39,'') =10487 -- 计发生活费的人员
	;

	-- -- 所有在职停薪人员
	DECLARE personId_4 CURSOR FOR
   SELECT t126.id from t126 ,t125,sys_s_data d 
		where t125.c06 = concat(t126.id ,'') and t125.c36 =concat(d.id,'')   
		and t126.c01 = concat(orgId,'') and d.data_value in(207,208) -- t125.c36 人员工资制度为  207-法官职级工资制 208-检察官职级工资制
	and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
	and ifnull(t126.c43,'') =10487  -- 排除已经停薪的人员  10487是否状态-是    工资合计为0 及视为停发工资
	and ifnull(t125.c39,'') !=10487 -- 排除计发生活费的人员
	and ifnull(t126.c40,'') !=10831 -- 排除减少人员
	;
	-- 所有在职计发病假工资人员
	DECLARE personId_5 CURSOR FOR
   SELECT t126.id from t126 ,t125,sys_s_data d 
		where t125.c06 = concat(t126.id ,'') and t125.c36 =concat(d.id,'')   
		and t126.c01 = concat(orgId,'') and d.data_value in(207,208) -- t125.c36 人员工资制度为  207-法官职级工资制 208-检察官职级工资制
		and EXISTS (select 1 from t127 where t127.id = t126.c17 and t127.c05 not like '%试用期%') -- t126.c39 执行工资标准 关联 单位工资制度与人员属性信息对应关系t136.c04 执行工资标准
	 and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
	and ifnull(t126.c43,'') !=10487 -- 排除已经停薪的人员  10487是否状态-是
	and ifnull(t125.c40,'') =10487 -- 计发病假工资人员
	;

	
		-- -- 所有级别工资为0人员
	DECLARE personId_6 CURSOR FOR
   SELECT t126.id from t126 ,t125,sys_s_data d 
		where t125.c06 = concat(t126.id ,'') and d.id = t125.c36 
		and t126.c01 = concat(orgId,'') and d.data_value in( 201,206) -- t125.c36 人员工资制度为 201 -公务员职级工资 206-警察职级工资制度
		and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
	and  ifnull(t125.c32,0) = 0  --    工资合计为0 及视为停发工资
	and ifnull(t126.c43,'') !=10487   -- 排除已经停薪的人员  10487是否状态-是    
	and ifnull(t125.c39,'') !=10487 -- 排除计发生活费的人员
	and ifnull(t126.c40,'') !=10831 -- 排除减少人员
	;
	
	
	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
	select DATE_FORMAT(concat(qxsj,'0101'),'%Y%m'),qxsj into qxYearMonth,newDcsj;-- 起薪年月 201607,新的 档次起考时间 为 选择的起考时间
	
	select content into qxMonth from sys_s_config where enname = 'qxMonth' ;
	
	set c_id = createrId;
	set u_id = unitId;
	if length(qxsj)=4 then
		select DATE_FORMAT(concat(qxsj,'-',qxMonth,'-01'),'%Y-%m') into qxYearMonth;-- 起薪年月 2016-01
	else
		select DATE_FORMAT(qxsj,'%Y-%m') into qxYearMonth;-- 起薪年月 2016-01
 	end if;
	
	set @resultM = 'resultM:';
	set @khsjbm = 'khsjbm:';-- 考核没考2年称职的
	set @qksjbz = 'qksjbz:';-- 人员上一次变动起考时间与起薪年月-年相差不足2年
	set @khfcz = 'khfcz:';-- 考核不是称职的 用来包装考核1年，但没有达到1年称职
	set @qxsjbd = 'qxsjbd:';-- 人员起薪时间 小于等于最近一次变动记录的起薪时间
	set @syq = 'syq:';-- 试用期人员
	set @jfshf = 'jfshf:';-- 在职计发生活费人员
	set @jfbj = 'jfbj:';-- 在职计发病假工资人员
	set @zztx = 'zztx:';-- 所有在职停薪人员
	set @jbgz0 = 'jbgz0:';-- 所有级别工资为0人员
	set @bdcz = 'bdcz:';-- 当前变动类型当年已经存在
	set resultMsg = 'resultMsg';
	-- 打开游标
  OPEN personId_;  
  -- 开始循环
  read_loop: LOOP
    -- 提取游标里的数据，这里只有一个，多个的话也一样；
    FETCH personId_ INTO sTemPersonId;
    -- 声明结束的时候
    IF done THEN
      LEAVE read_loop;
    END IF;
	set @doneF = done;
    select count(1) into sTempNum from data_record_t126 t126 ,data_record_t125 t125 
    where   t125.c06 = concat(t126.dataId ,'') and t126.changeSign = t125.changeSign 
    and t126.dataId = sTemPersonId and t126.changeType = chanType and t126.allAuditFlag = '2' 
    and t125.c02 >= qxYearMonth;
    if sTempNum = 0 then -- 起薪时间之后已经存在通过的此变动记录
	/*
		-- 人员在当前单位第一次起薪时间
		select t125.c02 into @firstQxsj from data_record_t126 t126,data_record_t125 t125 
			where  t126.changesign = t125.changesign and  t126.dataId = stemPersonId and t125.c06 = concat(t126.dataId ,'')
			and t126.c01 = concat(orgId,'') and t126.changetype in(10750,10832) order by t126.id desc  limit 0,1;

		
		-- 重新确定工资
		select count(1) into @cxqdNum from data_record_t126 t126 ,data_record_t125 t125
    	where  t126.changesign = t125.changesign and  t126.dataId = stemPersonId and t125.c06 = concat(t126.dataId ,'')
    	 and t126.changeType in(select id from sys_s_data d where d.typename = 'bdlx' and data_value = '05')
    	 and t126.c01 = concat(orgId,'') 
    	 order by t125.id desc 
    	 limit 0,1;-- 重新确定工资
		if @cxqdNum > 0 then 
	    	select t125.c02 into @firstQxsj from data_record_t126 t126 ,data_record_t125 t125
	    	where  t126.changesign = t125.changesign and  t126.dataId = stemPersonId and t125.c06 = concat(t126.dataId ,'')
	    	 and t126.changeType in(select id from sys_s_data d where d.typename = 'bdlx' and data_value = '05')
	    	 and t126.c01 = concat(orgId,'') 
	    	 order by t125.id desc 
	    	 limit 0,1;-- 重新确定工资
		end if;*/
		-- 人员在本单位最后一次起薪（录入或调入）时间、重新确定工资起薪时间、工资制度变化起薪时间 取最大的一个起薪时间
		call p_person_getQxsj(sTemPersonId,@firstQxsj);-- 根据人员当前单位及身份等获取最早起薪时间
		
		select PERIOD_DIFF(replace(@firstQxsj,'-',''),replace(qxYearMonth,'-','')) into @stemNum; -- 判断 起薪时间201601与当前人员在该单位首次起薪时间201602 
	-- 	set resultMsg = concat('qxYearMonth:',qxYearMonth,',@firstQxsj:',@firstQxsj,',@stemNum:',@stemNum);leave label_pro;
	
		if @stemNum > 0 then -- 设置人员起薪时间  如果在单位首次起薪为201602,则设置为2016-02 如果一直在 则为为 2016-01 
			set @qxYearMonth = @firstQxsj;
		else 
			set @qxYearMonth = qxYearMonth;
		end if;
		
   	 -- 循环查询人员工资信息
		-- t125 人员工资信息表 c07-工资级别-关联工资标准表t127.c05次级别名称,c08-级别起考时间,c09-工资档次-关联工资标准表-c04级别名称,c10-档次起考时间,c25-职务工资,
		-- c26-级别工资,c28-教师护士提高10%,c29-特殊教育提高15%,c36-人员工资制度-字符型
		-- t126 人员基本信息表 c28-人员身份-关联 单位工资制度与人员属性信息对应关系.人员身份 t126.c39-执行工资标准-关联 单位工资制度与人员属性信息对应关系.执行工资标准
		-- t126.c17 工资对应职级 工资标准表.次级别名称  t125.c27-津补贴小计
		select t125.id,t125.c07,t125.c08,t125.c09,t125.c10,ifnull(t125.c25,0),
		round(t125.c26,2),round(t125.c28,2),round(t125.c29,2),t125.c36,t126.c28,t126.c39 ,
		t126.c17,round(t125.c27,2)
		into salaryId,jb,jbsj,dc,dcsj,zwgz,
		dcgz,jhtg,tjtg,rygzzd,rysf,zxgzbz,
		gzdyzz,zxgsje
		from t126,t125 where t125.c06 = concat(t126.id ,'')
		and t126.id = sTemPersonId ; -- t125 人员工资表 c06-人员编号 关联型
		
		set dcsj = SUBSTR(dcsj FROM 1 FOR 4);-- 2016-07-01 to 2016

		-- t124 人员年度考核情况表 c03人员编号  关联型 c01-考核年度 c05-考核结果 码表, 1-优秀 2-称职 3-基本称职 4-不称职 5-不参与考核
			 -- 起考年度-2012与起薪时间-2017-01-01之间 考核年度[2012,2013,2014,2015,2016]机关连续2年以上考核 称职以上 升一档 
		select count(1) into sTempNum from t124 where c03 = concat(sTemPersonId,'') and c01 >= dcsj and c01 < qxsj
			and EXISTS (select 1 from sys_s_data d where d.id = t124.c05 and d.data_value < '3');
		select c04 into @personName from t126 where id = stemPersonId; -- 人员姓名

		if sTempNum >= 2 then -- 满足起考年度开始连续2年称职以上 升-档
			 -- 对起薪时间与最近一次未通过审核的变动记录的起薪时间进行比较,如果起薪时间在这变动记录之前,不能晋升
			 select UNIX_TIMESTAMP() into sTempParam;
			 set chanSign = concat('batch',sTempParam,chanType,'t126',sTemPersonId);-- 批量晋升 
			 -- set chanSign = concat('\'',chanSign,'\'');
			 set temp = '';
			 if(EXISTS(select 1 from data_record_t125 a -- 人员在目前单位的变动记录ID并且ID大于人员在当前单位最新的一次录入或者接收人员变动
					where  a.dataId = salaryId and a.dataclassCode = 't125'  and a.allAuditFlag<>2 and a.perAuditFlag<>2 and a.id >= (select id from data_record_t125 where changeSign =
 (select changeSign from data_record_t126 where dataId = sTemPersonId AND c01 = (select c01 from t126 where id = sTemPersonId) and  (c40 = '10750' or c40 = '10832') order by id desc LIMIT 1))
					order by a.updateDate desc LIMIT 0,1)) THEN  -- 判断是否存在结果 存在则赋值
						select a.c02 into temp from data_record_t125 a  
						where  a.dataId = salaryId and a.dataclassCode = 't125'  and a.allAuditFlag<>2 and a.perAuditFlag<>2
						order by a.updateDate desc LIMIT 0,1;
			 end if;
			 IF  @qxYearMonth < temp THEN -- 人员起薪时间 小于等于最近一次变动记录的起薪时间
						SET @qxsjbd = CONCAT(@qxsjbd,stemPersonId,'-',@qxYearMonth,','); 
						set FailIndex = FailIndex+1;-- 晋级失败人数+1	
					else
						/** select t125.c02 into @firstQxsj from data_data_record t126,data_data_record t125 
				where t126.dataclassCode = 't126' and t125.dataclassCode = 't125' 
				and t126.dataId = stemPersonId and t125.c06 = t126.dataId limit 0,1;
				*/				
		
				-- set @stemQxsj = @qxYearMonth;
			-- set resultMsg = concat('firstQxsj > stemQxsj:',firstQxsj > stemQxsj);leave label_pro;
				if  @qxYearMonth !=  qxYearMonth then -- 起薪时间 与 系统设置的起薪时间不一致
				
					set @resultM = concat(@resultM,'[',@personName,':变动起薪时间',@qxYearMonth,']');
					set stemFailIndex = stemFailIndex + 1;-- 需要手工补扣发的人数+1
					-- set resultMsg = stemFailIndex;leave label_pro;
				end if;
				
					
			-- t127 工资标准表  c01-启用时间 c02-标准类别 c03-标准名称 c04-次级别名称(工资档次等) c05-次级别名称(工资级别等) c06-金额 c08-执行工资标准 c09-工资标准备注
			select c01,c03,c05,c05,c06,c08 into oldQysj,oldBzmc,jb,oldCjbmc,oldJe,oldZxgzbz
			 from t127 where id = gzdyzz;

			select c01 into oldQysj from t127 where c08 = oldZxgzbz ORDER BY c01 desc limit 0,1; -- 赋值最新的工资标准启用时间
			if zwgz != oldJe then -- 法检的工资只有 职务等级工资 与查询工资标准的金额不一致 则查询符合条件的工资标准id数据
					set oldJe = zwgz;
			end if;
			select c04 ,c04 into dc,oldJbmc from t127 where id = dc;
			-- 获取法官/检察官 的标准名称 
			select c03 into oldBzmc from t127 where c04 = oldJbmc and c05 = oldCjbmc and c08 = oldZxgzbz limit 0,1;
			-- select id into jb from t127 where c01 = oldQysj and c02 = oldBzlb and c03 = oldBzmc and c04 = oldCjbmc;
			-- select id into dc from t127 where c01 = oldQysj and c02 = oldBzlb and c03 = oldBzmc and c04 = oldJbmc;
			-- select c04 into zxgzbz from t136 where id = zxgzbz; -- 单位工资制度与人员属性信息对应关系t136.c04 执行工资标准
			-- select c02 into rysf from t136 where id = rysf; -- 单位工资制度与人员属性信息对应关系t136.c02 人员身份
			-- 2017-01-06
			-- 人员身份-t126.c28改成码表  不用重新查询更新
			-- 执行工资标准-t126.c39改成 工资标准类别  码表 也不用重新查询更新
			select SUBSTR(dc FROM 1 FOR POSITION('档' IN dc)-1) into dc;
			set newDc = dc+1;
			set newDc = CONCAT(newDc,'档');
			select count(1) into sTempParam from t127 a where a.c04 = newDc and c05 = oldCjbmc and c03 = oldBzmc and c08 = oldZxgzbz and c01 = oldQysj;-- 查询新的法检职务等级工资是否存在
			if sTempParam = 0 THEN 
				set dc = dc -1 ;-- 此薪级上一个档次 
				if dc <= 0 THEN
					set dc = dc + 1;
				end if;
				select count(1) into @sTempCountParam from t127 a where a.c05=oldCjbmc and c03 = oldBzmc and c08 = oldZxgzbz and c04 = CONCAT(dc,'档') and c01 = oldQysj;-- 上一个薪级的金额
				if @sTempCountParam > 0 then 
					select c06 into sTempParam from t127 a where a.c05=oldCjbmc and c03 = oldBzmc and c08 = oldZxgzbz and c04 = CONCAT(dc,'档') and c01 = oldQysj;-- 上一个薪级的金额
					set subJe = oldJe - sTempParam + 0;
					set newJe = oldJe + subJe + 0; -- 原来薪级的工资+档差工资
					insert into t127(dataclassCode,c01,c03,c04,c05,c06,c08,createrId,createDate,updaterId,updateDate)
					values ('t127',oldQysj,oldBzmc,newDc,oldCjbmc,newJe,oldZxgzbz,1,SYSDATE(),1,SYSDATE());
				end if;
			end if;			
			select id,c06 into newDcId,newJe from t127 a where a.c04 = newDc  and c03 = oldBzmc and c08 = oldZxgzbz and c05= jb and c01 = oldQysj;-- 查询新的档次工资
			select count(1) into sTempNum from data_record_t126 where  dataId = sTemPersonId and changeType = chanType and ifnull(allAuditFlag,'') != '2';
			if sTempNum = 0 then 
				select DATE_FORMAT(SYSDATE(),'%Y') into @NowY;
				set @sqlstr = concat('select count(1) into @sTempNum from data_record_t126 ',
					'where  dataId = ',sTemPersonId,
					' and changeType = ',chanType,' and  exists(select 1 from data_record_t125 where data_record_t126.changesign = data_record_t125.changesign ',
					' and data_record_t125.c02 like \'',SUBSTR(qxsj from 1 for 4),'%\')');
					-- 当年只能做一次机关正常晋升法检档次
				PREPARE stmt FROM @sqlstr;
				EXECUTE stmt;
				set sTempNum = @sTempNum;
			end if;
			if sTempNum > 0 then 
				--  当前变动时间所有年份已经存在此变动记录类型
				SET @bdcz = CONCAT(@bdcz,stemPersonId,',');
				-- set @bdcz = replace(@bdcz,'bdcz:',''); -- 用来包装没有起考时间开始考核2年以上
				set FailIndex = FailIndex+1;
			end if;
			if sTempNum = 0 then 
				--  如果不存在此变动记录,存在先不管
				set stemSucIndex = stemSucIndex + 1; -- 晋升成功人数+1
				update t126 set c41=DATE_FORMAT(SYSDATE(),'%Y-%m-%d'),c40=chanType where id = sTemPersonId;-- 更新人员基本信息表-变动类型,变动时间
				if jhtg > 0 THEN -- 教师护士提高10%
					set jhtg = round(CAST((zwgz + newJe)*0.1 AS DECIMAL));
				end if;
				if tjtg > 0 then -- 特殊教育揭提高15%
					set tjtg = round(CAST((zwgz + newJe + ifnull(jhtg,0))*0.15 AS DECIMAL));
				end if;
				
				-- 调用upPercentJbt，更新t117津补贴金额，返回zxgzje,修改t125.c27 津补贴小计
				CALL upPercentJbt(sTemPersonId,zxgsje,0,newJe,resultMsg);
				select sum(ifnull(c07+0,0)) into zxgsje from t117 where c03 = concat(sTemPersonId,'');
				-- CALL upPercentJbt(sTemPersonId,zxgsje,zwgz,newJe,resultMsg);
				update t125 set c27= zxgsje where id = salaryId;
				select newDcId as dcid;
				-- set gzhj = zwgz + newJe + jhtg + tjtg, ; 工资合计=职务工资+新的级别/档次工资+提高+保留
				-- 更新人员工资表t125 薪级-c09 档次起考年度-c10 薪级工资-c26 工资合计c32: 原来的职务工资+新的薪级工资+教师护士提高+特殊教育提高+c30保留特岗工资+c31基础绩效+c27津补贴合计+c44中小学老师保留10%+c45保留护士提高10%
				-- 法官,检察官  只有职务工资 职务工资由 工资对应职级+档次共同决定
				update t125 set c02=@qxYearMonth,c09 = newDcId,c10=qknx ,c25 = newJe,
				c32 =round((newJe + ifnull(jhtg,0) + ifnull(tjtg,0) + ifnull(c27,0)+ifnull(c30,0)+ifnull(c31,0)+ifnull(c44,0)+ifnull(c45,0)+0) ,2)
				,c34 ='',c04= yjwh ,c48=''
				-- 工资变动 备注 依据文号 工资报审附件
				where id = salaryId ;
				-- select UNIX_TIMESTAMP() into sTempParam;
				-- set chanSign = concat(sTempParam,chanType,'t126',sTemPersonId); -- 设置人员基本信息,工资信息,津补贴信息 共同的changeSign
				
				-- 人员基本信息-变动记录
				INSERT data_record_t126 (dataId,dataclassCode,createrId,createDate,updaterId,updateDate,unitId,
					operateTime,operateId,operateType,changeSign,changeType,c01,c02,c03,c04,c28)-- c01,c02,c03,c04,c28必填 
				select 
				id,'t126',c_id,SYSDATE(),c_id,SYSDATE(),u_id,SYSDATE(),c_id,1,chanSign,chanType,orgId,c02,c03,c04,c28
				from t126 where id = sTemPersonId;
				-- values (sTemPersonId,'t126',createrId,SYSDATE(),createrId,SYSDATE(),unitId,SYSDATE(),createrId,1,chanSign,chanType,orgId);
				update data_record_t126 a , t126 b set a.c01 = b.c01 ,a.c02 = b.c02,a.c03=b.c03,a.c04=b.c04,a.c05=b.c05,a.c06=b.c06,a.c07=b.c07,a.c08=b.c08,a.c09=b.c09,
					a.c10=b.c10,a.c11=b.c11,a.c12=b.c12,a.c13=b.c13,a.c14=b.c14,a.c15=b.c15,a.c16=b.c16,a.c17=b.c17,a.c18=b.c18,a.c19=b.c19,a.c20=b.c20,a.c21=b.c21,a.c22=b.c22,
					a.c23=b.c23,a.c24=b.c24,a.c25=b.c25,a.c26=b.c26,a.c27=b.c27,a.c28=b.c28,a.c29=b.c29,a.c30=b.c30,a.c31=b.c31,a.c32=b.c32,a.c33=b.c33,a.c34=b.c34,a.c35=b.c35,
					a.c36=b.c36,a.c37=b.c37,a.c38=b.c38,a.c39=b.c39,a.c40=b.c40,a.c41=b.c41,a.c42=b.c42,a.c43=b.c43,a.c44=b.c44,a.c45=b.c45,a.c46=b.c46,a.c47=b.c47,a.c48=b.c48,
					a.c49=b.c49,a.c50=b.c50
				where a.dataId = b.id and a.dataId = sTemPersonId and  a.changeSign = chanSign ;
	
				-- 人员工资信息-变动记录
				INSERT data_record_t125 (dataId,dataclassCode,createrId,createDate,updaterId,updateDate,unitId,
	 				operateTime,operateId,operateType,changeSign,changeType)
				values (salaryId,'t125',createrId,SYSDATE(),createrId,SYSDATE(),unitId,SYSDATE(),createrId,1,chanSign,chanType);-- 插入 人员工资信息 变动记录
				update data_record_t125 a , t125 b set a.c01 = b.c01 ,a.c02 = b.c02,a.c03=b.c03,a.c04=b.c04,a.c05=b.c05,a.c06=b.c06,a.c07=b.c07,a.c08=b.c08,a.c09=b.c09,
					a.c10=b.c10,a.c11=b.c11,a.c12=b.c12,a.c13=b.c13,a.c14=b.c14,a.c15=b.c15,a.c16=b.c16,a.c17=b.c17,a.c18=b.c18,a.c19=b.c19,a.c20=b.c20,a.c21=b.c21,a.c22=b.c22,
					a.c23=b.c23,a.c24=b.c24,a.c25=b.c25,a.c26=b.c26,a.c27=b.c27,a.c28=b.c28,a.c29=b.c29,a.c30=b.c30,a.c31=b.c31,a.c32=b.c32,a.c33=b.c33,a.c34=b.c34,a.c35=b.c35,
					a.c36=b.c36,a.c37=b.c37,a.c38=b.c38,a.c39=b.c39,a.c40=b.c40,a.c41=b.c41,a.c42=b.c42,a.c43=b.c43,a.c44=b.c44,a.c45=b.c45,a.c46=b.c46,a.c47=b.c47,a.c48=b.c48,
					a.c49=b.c49,a.c50=b.c50
				where a.dataId = b.id and a.dataId = salaryId and  a.changeSign = chanSign ;						
			
				-- --  人员津补贴-变动记录
				call upRyjbtBd(sTemPersonId,createrId,unitId,chanSign,chanType,resultMsg);
				
				-- 计算补扣发
				select id into changeId from data_record_t126 where  changeSign = chanSign;
				-- call fillCount(orgId,changeId,chanType ,chanSign,resultMsg);
			 end if;
				
			
			
	
			end if;
		end if;
	end if;	
	
	select count(1) into sTempNum from t124 where c03 = concat(sTemPersonId,'') and c01 >= dcsj and c01 < qxsj
		and EXISTS (select 1 from sys_s_data d where d.id = t124.c05); 
	if sTempNum >= 2 then  -- 起考时间开始考核2年以上
		select count(1) into sTempNum from t124 where c03 = concat(sTemPersonId,'') and c01 >= dcsj and c01 < qxsj
			and EXISTS (select 1 from sys_s_data d where d.id = t124.c05 and d.data_value < '3');
		if sTempNum < 2 then  -- 未达到2年以上称职
			SET @khfcz = CONCAT(@khfcz,stemPersonId,','); 
			set FailIndex = FailIndex+1;-- 晋级失败人数+1	
		end if;
	ELSE 
		select DATE_FORMAT(SYSDATE(),'%Y') into @NowY;
		set @sqlstr = concat('select count(1) into @sTempNum from data_record_t126 ',
			'where dataId = ',sTemPersonId,
			' and changeType = ',chanType,' and  exists(select 1 from data_record_t125 where data_record_t126.changesign = data_record_t125.changesign ',
			' and data_record_t125.c02 like \'',SUBSTR(qxsj from 1 for 4),'%\')');
			-- 当年只能做一次事业正常晋升薪级
		PREPARE stmt FROM @sqlstr;
		EXECUTE stmt;
		set sTempNum = @sTempNum;
		if sTempNum > 0 then 
			--  当前变动时间所有年份已经存在此变动记录类型
			SET @bdcz = CONCAT(@bdcz,stemPersonId,',');
			set FailIndex = FailIndex+1;
		else
			set @sNum = qknx-dcsj;
			if @sNum >= 2 then 
				SET @khsjbm = CONCAT(@khsjbm,stemPersonId,',');
				set FailIndex = FailIndex+1;
			else
				SET @qksjbz = CONCAT(@qksjbz,stemPersonId,',');
				set FailIndex = FailIndex+1;
			end if;
		end if;
	end if;

	set done = @doneF;
  END LOOP;
  -- 关闭游标
    CLOSE personId_;	

-- 遍历试用期人员
set done = FALSE;
OPEN personId_2;
    loop1: LOOP
        FETCH personId_2 into sTemPersonId;

        IF done THEN
            LEAVE loop1;
        END IF;
				set @syq = concat(@syq,sTemPersonId,',');
				set FailIndex = FailIndex+1;-- 晋级失败人数+1	
    END LOOP;
close personId_2;


-- 遍历在职计发生活费人员
set done = FALSE;
OPEN personId_3;
    loop1: LOOP
        FETCH personId_3 into sTemPersonId;

        IF done THEN
            LEAVE loop1;
        END IF;
				set @jfshf = concat(@jfshf,sTemPersonId,',');
				set FailIndex = FailIndex+1;-- 晋级失败人数+1	
    END LOOP;
close personId_3;


-- 遍历所有在职停薪人员
set done = FALSE;
OPEN personId_4;
    loop1: LOOP
        FETCH personId_4 into sTemPersonId;

        IF done THEN
            LEAVE loop1;
        END IF;
			set @zztx = concat(@zztx,sTemPersonId,',');
			set FailIndex = FailIndex+1;-- 晋级失败人数+1	
    END LOOP;
close personId_4;

-- 遍历所有在职计发病假工资人员
set done = FALSE;
OPEN personId_5;
    loop1: LOOP
        FETCH personId_5 into sTemPersonId;

        IF done THEN
            LEAVE loop1;
       END IF;
      		set @jfbj = concat(@jfbj,sTemPersonId,',');
			set FailIndex = FailIndex+1;-- 晋级失败人数+1	
    END LOOP;
close personId_5;
	
	
-- 遍历所有在职停薪人员
set done = FALSE;
OPEN personId_6;
    loop1: LOOP
        FETCH personId_6 into sTemPersonId;

        IF done THEN
            LEAVE loop1;
        END IF;
				set @jbgz0 = concat(@jbgz0,sTemPersonId,',');
				set FailIndex = FailIndex+1;-- 晋级失败人数+1	
    END LOOP;
close personId_6;

	
	
		if stemSucIndex > 0 then 
    		call p_fund_updateFlag(orgId,@re);-- 变动后更新基金isUPdateFund=1
	  	set resultMsg = concat('机关正常晋升法官检察官档次成功:[',stemSucIndex,']人');
			set @resultM = replace(@resultM,'resultM:','');
			if stemFailIndex > 0 then 
				set resultMsg= concat(resultMsg,'（起薪时间不在',qxYearMonth,'的共[',stemFailIndex,']人，可能需要做一次性补扣发）;');
			end if;
		end if;

		if FailIndex > 0 then
			set resultMsg = replace(resultMsg,'resultMsg','');
			set @failMsg = concat(@qksjbz,';',@khsjbm,';',@khfcz,';',@qxsjbd,';',@syq,';',@jfshf,';',@jfbj,';',@zztx,';',@bdcz,';',@jbgz0,';');
			insert into temp_multi values(orgId,chanType,sysdate(),@failMsg); 
			if stemSucIndex = 0 THEN
				-- set resultMsg= CONCAT(resultMsg,'成功:[0]人，','失败[',FailIndex,']人，是否下载失败记录?',@qksjbz,';',@khsjbm,';',@khfcz,';',@qxsjbd,';',@syq,';',@jfshf,';',@jfbj,';',@zztx,';',@bdcz,';',qxYearMonth,';',chanType,';','2');
				set resultMsg= CONCAT(resultMsg,'成功:[0]人，','失败[',FailIndex,']人，是否下载失败记录?',qxYearMonth,';',chanType,';','2');
			ELSE	
				-- set resultMsg= CONCAT(resultMsg,'失败[',,']人，是否下载失败记录?',@qksjbz,';',@khsjbm,';',@khfcz,';',@qxsjbd,';',@syq,';',@jfshf,';',@jfbj,';',@zztx,';',@bdcz,';',qxYearMonth,';',chanType,';','2');
				set resultMsg= CONCAT(resultMsg,'失败[',FailIndex,']人，是否下载失败记录?',qxYearMonth,';',chanType,';','2');	
			end if;
			set resultMsg = replace(resultMsg,'resultMsg','');
		end if;

		if 	FailIndex = 0 and stemSucIndex= 0 then	
			set resultMsg = replace(resultMsg,'resultMsg','该变动原因无晋升人员');
		end if;
  	leave label_pro;
			
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`upJgGw`(IN createrId int(11),IN unitId int(11),IN orgId varchar(200),IN chanType varchar(200),
IN qxsj varchar(10) ,IN bdsj varchar(20),IN qknx varchar(4),in yjwh varchar(100),INOUT resultMsg varchar(1000) CHARSET utf8)
label_pro:BEGIN	
	-- orgId 单位id
	-- chanType 批量变动变动类型id  sys_s_data data_value = 13 机关工人正常晋升岗位工资
	-- bdsj 变动时间 20160701
	-- qxsj 起薪时间 20160101
	-- DECLARE orgId varchar(100);-- 单位id
	DECLARE changeType varchar(100);-- -- 变动类型sys_s_data id
	DECLARE changeId int(11);-- -- changeId 变动记录id 主要是t126的变动记录id,此id来查询所有关联的工资t125,津贴t117 变动记录
	DECLARE personId varchar(100);-- 人员id
	DECLARE personNo varchar(100);-- 人员编号
	DECLARE salaryId varchar(100);-- 工资信息的Id
	DECLARE salaryRecordId varchar(100);-- 工资信息的recordId
	DECLARE changeTypeCode varchar(100);-- 变动类型code

	DECLARE rygzzd varchar(50);-- 人员工资制度 - 机关技工岗位技术等级工资制-202 机关普工岗位工资制-203
	DECLARE rysf varchar(50);-- 机关技术工人 机关普通工
	DECLARE zxgzbz varchar(20);-- 执行工资标准- 机关工人

	DECLARE zwgz double DEFAULT 0;-- 职务工资

	DECLARE jb varchar(20);-- 级别
	DECLARE jbsj varchar(20);-- 级别-起考时间
	DECLARE dc varchar(20);-- 档次	
	DECLARE dcsj varchar(20);-- 档次-起考时间	
	DECLARE dcgz varchar(20);-- 档次-薪级工资
	DECLARE newDc varchar(20);-- 新档次	
	DECLARE newDcsj varchar(20);-- 新起考时间
	DECLARE newJe double DEFAULT 0;-- 新金额
	DECLARE newDcId varchar(20);-- 新档次Id
	
	DECLARE oldQysj varchar(20);-- 标准启用时间
	 DECLARE oldBzlb varchar(20);-- 标准类别
	DECLARE oldBzmc varchar(20);-- 标准名称
	DECLARE oldJbmc varchar(20);-- 级别名称-档次
	DECLARE oldCjbmc varchar(20);-- 次级别名称-级别
	DECLARE oldJe double DEFAULT 0;-- 金额
	DECLARE oldZxgzbz varchar(50);-- 执行工资标准

	DECLARE subJe double DEFAULT 0;-- 档差(薪级差)金额
	DECLARE jhtg double DEFAULT 0;-- 教师护士提高10%
	DECLARE tjtg double DEFAULT 0;-- 特殊教育揭提高15%

	DECLARE qxYearMonth varchar(100);-- 起薪时间-截取 年月 2016-01
	
	DECLARE sTemPersonId varchar(100);-- 人员id-变量
	DECLARE sTempNum int(11);-- 参数
	DECLARE sTempYearMonth varchar(6);-- 
	DECLARE sTempParam int(11);-- 变动时间-(减去)起薪时间的月份

	DECLARE chanSign varchar(100);-- 变动标志

	DECLARE qxMonth varchar(10);-- 系统设置批量变动 统一起薪月份 :01表示 当年1月  11表示当年11月

	DECLARE stemSucIndex int(11) default 0;-- 批量晋升工资成功条数
	DECLARE stemFailIndex int(11) default 0;-- 批量晋升工资失败条数(需要手工补扣发人数)
	DECLARE personNum int(11);	-- 所有机关公务员在职公务员数量-排开试用期人员 
	DECLARE	FailIndex int(11) default 0; -- 晋级失败人数
	DECLARE zxgsje double DEFAULT 0;-- t117 执行公式*t117执行金额
	DECLARE c_id int(11);-- 创建人id
	DECLARE u_id int(11);-- 功能id

	DECLARE temp varchar(100); -- 最近一次变动记录的起薪时间
    DECLARE done INT DEFAULT FALSE;
	
	-- -- 所有在职机关工人
	-- DECLARE personId_ CURSOR FOR
  --  SELECT id from t126 ,sys_s_data d where d.id = t126.c36 and t126.c01 = orgId and  d.data_value in (202,203) -- t126.c36 人员工资制度为 202 -机关技工岗位等级工资制 203-机关普工岗位工资制
	 -- and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1');-- t126.c03 人员状态-码表 1-在职
		-- --  所有在职机关工人-排开试用期人员
	DECLARE personId_ CURSOR FOR
   SELECT t126.id from t126 ,t125,sys_s_data d 
		where t125.c06 = concat(t126.id ,'') and t125.c36 =concat(d.id,'')    
		and t126.c01 = concat(orgId,'') and  d.data_value in (202,203) -- t125.c36 人员工资制度为 202 -机关技工岗位等级工资制 203-机关普工岗位工资制
		and EXISTS (select 1 from t127 where t127.id = t126.c17 and t127.c05 not like '%期%') -- t126.c39 执行工资标准 关联 单位工资制度与人员属性信息对应关系t136.c04 执行工资标准
	  and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
		and (ifnull(t126.c43,'') !=10487 and ifnull(t125.c26,'')!=0)   -- 排除已经停薪的人员  10487是否状态-是   级别工资是0 的不参与晋升
	and ifnull(t125.c39,'') !=10487 -- 排除计发生活费/处分减资的人员
	and ifnull(t125.c40,'') !=10487 -- 排除计发病假工资的人员
	;

	-- 所有在职试用期机关工人
	DECLARE personId_2 CURSOR FOR
   SELECT t126.id from t126 ,t125,sys_s_data d 
		where t125.c06 = concat(t126.id ,'') and t125.c36 =concat(d.id,'')   
		and t126.c01 = concat(orgId,'') and d.data_value in(202,203) -- t125.c36 人员工资制度为 202 -机关技工岗位等级工资制 203-机关普工岗位工资制
		and EXISTS (select 1 from t127 where t127.id = t126.c17 and t127.c05 like '%期%') -- t126.c39 执行工资标准 关联 单位工资制度与人员属性信息对应关系t136.c04 执行工资标准
	  and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
	and ifnull(t126.c43,'') !=10487 -- 排除已经停薪的人员  10487是否状态-是
	and ifnull(t125.c39,'') !=10487 -- 排除计发生活费/处分减资的人员
	and ifnull(t125.c40,'') !=10487 -- 排除计发病假工资的人员
	;
	-- 所有在职计发生活费/处分减资人员
	DECLARE personId_3 CURSOR FOR
   SELECT t126.id from t126 ,t125,sys_s_data d 
		where t125.c06 = concat(t126.id ,'') and t125.c36 =concat(d.id,'')   
		and t126.c01 = concat(orgId,'') and d.data_value in(202,203) -- t125.c36 人员工资制度为 202 -机关技工岗位等级工资制 203-机关普工岗位工资制
		and EXISTS (select 1 from t127 where t127.id = t126.c17 and t127.c05 not like '%期%') -- t126.c39 执行工资标准 关联 单位工资制度与人员属性信息对应关系t136.c04 执行工资标准
	  and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
	and ifnull(t126.c43,'') !=10487 -- 排除已经停薪的人员  10487是否状态-是
	and ifnull(t125.c39,'') =10487 -- 计发生活费/处分减资的人员
	;

	-- -- 所有在职停薪人员
	DECLARE personId_4 CURSOR FOR
   SELECT t126.id from t126 ,t125,sys_s_data d 
		where t125.c06 = concat(t126.id ,'') and t125.c36 =concat(d.id,'')   
		and t126.c01 = concat(orgId,'') and d.data_value in(202,203) -- t125.c36 人员工资制度为 202 -机关技工岗位等级工资制 203-机关普工岗位工资制
	and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
	and ifnull(t126.c43,'') =10487   -- 排除已经停薪的人员  10487是否状态-是    
	and ifnull(t125.c39,'') !=10487 -- 排除计发生活费的人员
	and ifnull(t126.c40,'') !=10831 -- 排除减少人员
	;
		-- 所有在职计发病假工资人员
	DECLARE personId_5 CURSOR FOR
   SELECT t126.id from t126 ,t125,sys_s_data d 
		where t125.c06 = concat(t126.id ,'') and t125.c36 =concat(d.id,'')   
		and t126.c01 = concat(orgId,'') and d.data_value in(202,203) -- t125.c36 人员工资制度为 202 -机关技工岗位等级工资制 203-机关普工岗位工资制
		and EXISTS (select 1 from t127 where t127.id = t126.c17 and t127.c05 not like '%期%') -- t126.c39 执行工资标准 关联 单位工资制度与人员属性信息对应关系t136.c04 执行工资标准
	  and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
	and ifnull(t126.c43,'') !=10487 -- 排除已经停薪的人员  10487是否状态-是
	and ifnull(t125.c40,'') =10487 -- 计发病假工资人员
	;
	
		
		-- -- 所有级别工资为0人员
	DECLARE personId_6 CURSOR FOR
   SELECT t126.id from t126 ,t125,sys_s_data d 
		where t125.c06 = concat(t126.id ,'') and d.id = t125.c36 
		and t126.c01 = concat(orgId,'') and d.data_value in( 201,206) -- t125.c36 人员工资制度为 201 -公务员职级工资 206-警察职级工资制度
		and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
	and  ifnull(t125.c32,0) = 0  --    工资合计为0 及视为停发工资
	and ifnull(t126.c43,'') !=10487   -- 排除已经停薪的人员  10487是否状态-是    
	and ifnull(t125.c39,'') !=10487 -- 排除计发生活费的人员
	and ifnull(t126.c40,'') !=10831 -- 排除减少人员
	;
	
	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
	select DATE_FORMAT(concat(qxsj,'0101'),'%Y%m'),qxsj into qxYearMonth,newDcsj;-- 起薪年月 201607,新的 档次起考时间 为 选择的起考时间
	
	select content into qxMonth from sys_s_config where enname = 'qxMonth' ;
	
	set c_id = createrId;
	set u_id = unitId;
	if length(qxsj)=4 then
		select DATE_FORMAT(concat(qxsj,'-',qxMonth,'-01'),'%Y-%m') into qxYearMonth;-- 起薪年月 2016-01
	else
		select DATE_FORMAT(qxsj,'%Y-%m') into qxYearMonth;-- 起薪年月 2016-01
 	end if;
	set @resultM = 'resultM:';
	set @khsjbm = 'khsjbm:';-- 考核没考2年称职的
	set @qksjbz = 'qksjbz:';-- 人员上一次变动起考时间与起薪年月-年相差不足2年
	set @khfcz = 'khfcz:';-- 考核不是称职的 用来包装考核X年，但没有达到X年称职
	set @qxsjbd = 'qxsjbd:';-- 人员起薪时间 小于等于最近一次变动记录的起薪时间
	set @syq = 'syq:';-- 试用期人员
	set @jfshf = 'jfshf:';-- 在职计发生活费人员
	set @jfbj = 'jfbj:';-- 在职计发病假工资人员
	set @zztx = 'zztx:';-- 所有在职停薪人员
	set @jbgz0 = 'jbgz0:';-- 所有级别工资为0人员
	set @bdcz = 'bdcz:';-- 当前变动类型当年已经存在
	set resultMsg = 'resultMsg';
	-- 打开游标
  OPEN personId_;  
  -- 开始循环
  read_loop: LOOP
    -- 提取游标里的数据，这里只有一个，多个的话也一样；
    FETCH personId_ INTO sTemPersonId;
    -- 声明结束的时候
    IF done THEN
      LEAVE read_loop;
    END IF;
	set @doneF = done;
    select count(1) into sTempNum from data_record_t126 t126 ,data_record_t125 t125 
    where t125.c06 = concat(t126.dataid ,'') and t126.changeSign = t125.changeSign 
    and t126.id = sTemPersonId and t126.changeType = concat(chanType,'') and t126.allAuditFlag = '2' 
    and replace(t125.c02,'-','') >= qxYearMonth;
    if sTempNum > 0 then 
		--  当前变动时间所有年份已经存在此变动记录类型
		SET @bdcz = CONCAT(@bdcz,stemPersonId,',');
		-- set @bdcz = replace(@bdcz,'bdcz:',''); -- 用来包装没有起考时间开始考核2年以上
		set FailIndex = FailIndex+1;
	end if;
    if sTempNum = 0 then -- 起薪时间之后已经存在通过的此变动记录
		/*-- 人员在当前单位第一次起薪时间
		select t125.c02 into @firstQxsj from data_record_t126 t126,data_record_t125 t125 
			where  t126.changesign = t125.changesign and  t126.dataId = stemPersonId and t125.c06 = concat(t126.dataid ,'')
			and t126.c01 = concat(orgId,'') and t126.changetype in(10750,10832) order by t126.id desc  limit 0,1;

		
		-- 重新确定工资
		select count(1) into @cxqdNum from data_record_t126 t126 ,data_record_t125 t125
    	where  t126.changesign = t125.changesign and  t126.dataId = stemPersonId and t125.c06 = concat(t126.dataid ,'')
    	 and t126.changeType in(select id from sys_s_data d where d.typename = 'bdlx' and data_value = '05')
    	 and t126.c01 = concat(orgId,'') 
    	 order by t125.id desc 
    	 limit 0,1;-- 重新确定工资
		if @cxqdNum > 0 then 
	    	select t125.c02 into @firstQxsj from data_record_t126 t126 ,data_record_t125 t125
	    	where  t126.changesign = t125.changesign and  t126.dataId = stemPersonId and t125.c06 = concat(t126.dataid ,'')
	    	 and t126.changeType in(select id from sys_s_data d where d.typename = 'bdlx' and data_value = '05')
	    	 and t126.c01 = concat(orgId,'') 
	    	 order by t125.id desc 
	    	 limit 0,1;-- 重新确定工资
		end if;*/
		-- 人员在本单位最后一次起薪（录入或调入）时间、重新确定工资起薪时间、工资制度变化起薪时间 取最大的一个起薪时间
		call p_person_getQxsj(sTemPersonId,@firstQxsj);-- 根据人员当前单位及身份等获取最早起薪时间
		
		select PERIOD_DIFF(replace(@firstQxsj,'-',''),replace(qxYearMonth,'-','')) into @stemNum; -- 判断 起薪时间201601与当前人员在该单位首次起薪时间201602 
	-- 	set resultMsg = concat('qxYearMonth:',qxYearMonth,',@firstQxsj:',@firstQxsj,',@stemNum:',@stemNum);leave label_pro;
	
		if @stemNum > 0 then -- 设置人员起薪时间  如果在单位首次起薪为201602,则设置为2016-02 如果一直在 则为为 2016-01 
			set @qxYearMonth = @firstQxsj;
		else 
			set @qxYearMonth = qxYearMonth;
		end if;
		
		
		
    	-- 循环查询人员工资信息
		-- t125 人员工资信息表 c07-工资级别-关联工资标准表t127.c05次级别名称,c08-级别起考时间,c09-工资档次-关联工资标准表-c04级别名称,c10-档次起考时间,c25-职务工资,c26-级别工资,c28-教师护士提高10%,c29-特殊教育提高15%,c36-人员工资制度-字符型
		-- t126 人员基本信息表 c28-人员身份-关联 单位工资制度与人员属性信息对应关系.人员身份 t126.c39-执行工资标准-关联 单位工资制度与人员属性信息对应关系.执行工资标准 津补贴小计
		select t125.id,replace(t125.c07,' ',''),t125.c08,t125.c09,t125.c10,round(t125.c25,2),round(t125.c26,2),round(t125.c28,2),round(t125.c29,2),t125.c36,t126.c28,t126.c39,round(t125.c27,2)
		into salaryId,jb,jbsj,dc,dcsj,zwgz,dcgz,jhtg,tjtg,rygzzd,rysf,zxgzbz,zxgsje
		from t126,t125 where t125.c06 = concat(t126.id ,'') and t126.id = sTemPersonId ; -- t125 人员工资表 c06-人员编号 关联型

		set dcsj = SUBSTR(dcsj FROM 1 FOR 4);-- 2016-07-01 to 2016
		
		-- t124 人员年度考核情况表 c03人员编号  关联型 c01-考核年度 c05-考核结果 码表, 1-优秀 2-称职 3-基本称职 4-不称职 5-不参与考核
			 -- 起考年度-2012与起薪时间-2017-01-01之间 考核年度[2012,2013,2014,2015,2016]机关连续2年以上考核 称职以上 升一档 
		select count(1) into sTempNum from t124 where c03 = concat(sTemPersonId,'') and c01 >= dcsj and c01 < qxsj
			and EXISTS (select 1 from sys_s_data d where d.id = t124.c05 and d.data_value < '3');
		select c04 into @personName from t126 where id = stemPersonId; -- 人员姓名
		

		if sTempNum >= 2 then -- 满足起考年度开始连续2年称职以上 升级


			-- 对起薪时间与最近一次未通过审核的变动记录的起薪时间进行比较,如果起薪时间在这变动记录之前,不能晋升
			 select UNIX_TIMESTAMP() into sTempParam;
			 set chanSign = concat(sTempParam,chanType,'t126',sTemPersonId);
			 -- set chanSign = concat('\'',chanSign,'\'');
			 set temp = '';
			 if(	EXISTS(select 1 from data_record_t125 a  -- 人员在目前单位的变动记录ID并且ID大于人员在当前单位最新的一次录入或者接收人员变动
					where  a.dataId = salaryId   and a.allAuditFlag<>2 and a.perAuditFlag<>2 and a.id >= (select id from data_record_t125 where changeSign =
 (select changeSign from data_record_t126 where dataId = sTemPersonId AND c01 = (select c01 from t126 where id = sTemPersonId) and  (c40 = '10750' or c40 = '10832') order by id desc LIMIT 1))
					order by a.updateDate desc LIMIT 0,1)) THEN  -- 判断是否存在结果 存在则赋值
						select a.c02 into temp from data_record_t125 a  
						where  a.dataId = salaryId   and a.allAuditFlag<>2 and a.perAuditFlag<>2
						order by a.updateDate desc LIMIT 0,1;
			 end if;
			 
			
			IF  @qxYearMonth < temp THEN -- 人员起薪时间 小于等于最近一次变动记录的起薪时间
					SET @qxsjbd = CONCAT(@qxsjbd,stemPersonId,'-',@qxYearMonth,','); 
					set FailIndex = FailIndex+1;-- 晋级失败人数+1	
			else
					/** select t125.c02 into @firstQxsj from data_data_record t126,data_data_record t125 
				where t126.dataclassCode = 't126' and t125.dataclassCode = 't125' 
				and t126.dataId = stemPersonId and t125.c06 = t126.dataId limit 0,1;
				*/
				
				
				-- set @stemQxsj = @qxYearMonth;
			-- set resultMsg = concat('firstQxsj > stemQxsj:',firstQxsj > stemQxsj);leave label_pro;
				if  @qxYearMonth !=  qxYearMonth then -- 起薪时间 与 系统设置的起薪时间不一致
				
					set @resultM = concat(@resultM,'[',@personName,':变动起薪时间',@qxYearMonth,']');
					set stemFailIndex = stemFailIndex + 1;-- 需要手工补扣发的人数+1
					-- set resultMsg = stemFailIndex;leave label_pro;
				end if;
				
				
			-- t127 工资标准表  c01-启用时间 c02-标准类别 c03-标准名称 c04-次级别名称(工资档次等) c05-次级别名称(工资级别等) c06-金额 c08-执行工资标准 c09-工资标准备注
			if jb is not null and jb!= '' then 
				select c01,c03,c04,c05,c06,c08 into oldQysj,oldBzmc,jb,oldCjbmc,oldJe,oldZxgzbz from t127 where id = jb;
			ELSE	
				select c05 into oldCjbmc from t127 where id = (select c17 from t126 where id = stemPersonId);
				-- select c01,c03,c04,c06,c08 into oldQysj,oldBzmc,jb,oldJe,oldZxgzbz from t127 where id = dc;
				select c01,c02,c03,c04,c04,c05,c06,c08 
				into oldQysj,oldBzlb,oldBzmc,dc,oldJbmc,oldCjbmc,oldJe,oldZxgzbz 
				from t127 where  id = (select id from t127 where c04 = (select c04 from t127 where id = dc )
					and c05 =oldCjbmc  and c08 = zxgzbz order by c01 desc limit 1);
				--  机关工人 c03-岗位工资 c04-XX级 c05-工资对应职级(技师/高级工/中级工/普通工等) c06-金额  c08-执行工资标准/工资标准类别
			end if ;
			-- 根据执行工资标准/工资标准类别 判断此类人员的最新工资标准时间
			select c01 into oldQysj from t127 where c08 = oldZxgzbz ORDER BY c01 desc limit 0,1 ;
			if dcgz != oldJe then -- 如果工人的 岗位工资 与查询工资标准的金额不一致 则查询符合条件的工资标准id数据
				set oldJe = dcgz;
			end if;
			-- select c04 ,c04 into dc,oldJbmc from t127 where id = dc;
			-- 2017-1-6 执行工资标准-t126.c39改成 工资标准类别  码表
			-- select c04 into zxgzbz from t136 where id = zxgzbz; -- 单位工资制度与人员属性信息对应关系t136.c04 执行工资标准
			-- 人员身份-t126.c28改成码表  不用重新查询更新
			-- select c02 into rysf from t136 where id = rysf; -- 单位工资制度与人员属性信息对应关系t136.c02 人员身份
			if LOCATE('档',dc)>0 then 
				select SUBSTR(dc FROM 1 FOR POSITION('档' IN dc)-1) into dc;-- 23档->23
			end if;
			set newDc = dc+1;-- 24
			set newDc = CONCAT(newDc,'档');-- 24级
			select count(1) into sTempParam from t127 a where a.c05=oldCjbmc and a.c04 = newDc  and c03 = oldBzmc and c08 = oldZxgzbz;-- 查询新的岗位工资是否存在
			
			if sTempParam = 0 THEN 
				set dc = dc -1 ;-- 此薪级上一个薪级
				if dc <= 0 THEN
					set dc = 1;
				end if;
				select count(1) into @sTempCountParam from t127 a where a.c05=oldCjbmc and c03 = oldBzmc and c08 = oldZxgzbz and c04 = CONCAT(dc,'档') and c01 = oldQysj;-- 上一个薪级的金额
				if @sTempCountParam > 0 then 
					select c06 into sTempParam from t127 a where a.c05=oldCjbmc and c03 = oldBzmc and c08 = oldZxgzbz and c04 = CONCAT(dc,'档') and c01 = oldQysj;-- 上一个薪级的金额
					set subJe = oldJe - sTempParam + 0;
					set newJe = oldJe + subJe + 0; -- 原来薪级的工资+档差工资
					insert into t127(dataclassCode,c01,c03,c04,c05,c06,c08,createrId,createDate,updaterId,updateDate)
					values ('t127',oldQysj,oldBzmc,newDc,oldCjbmc,newJe,oldZxgzbz,1,SYSDATE(),1,SYSDATE());
				end if;
			end if;			
			select id,c06 into newDcId,newJe from t127 a where a.c05=oldCjbmc and a.c04 = newDc  and c03 = oldBzmc and c08 = oldZxgzbz and c01 = oldQysj;-- 查询新的岗位工资
			select count(1) into sTempNum from data_record_t126 where  dataId = sTemPersonId and changeType = chanType and ifnull(allAuditFlag,'') != '2';
			if sTempNum = 0 then 
				select DATE_FORMAT(SYSDATE(),'%Y') into @NowY;
				set @sqlstr = concat('select count(1) into @sTempNum from data_record_t126 ',
					'where  dataId = ',sTemPersonId,
					' and changeType = ',chanType,' and  exists(select 1 from data_record_t125 where data_record_t126.changesign = data_record_t125.changesign ',
					' and data_record_t125.c02 like \'',SUBSTR(qxsj from 1 for 4),'%\')');
					-- 当年只能做一次机关工人正常晋升岗位变动
				PREPARE stmt FROM @sqlstr;
				EXECUTE stmt;
				set sTempNum = @sTempNum;
			end if;
			if sTempNum > 0 then 
				--  当前变动时间所有年份已经存在此变动记录类型
				SET @bdcz = CONCAT(@bdcz,stemPersonId,',');
				-- set @bdcz = replace(@bdcz,'bdcz:',''); -- 用来包装没有起考时间开始考核2年以上
				set FailIndex = FailIndex+1;
			end if;
			if sTempNum = 0 then 
			
				--  如果当年不存在此变动记录,存在先不管

				set stemSucIndex = stemSucIndex + 1; -- 晋升成功人数+1
				update t126 set c41=DATE_FORMAT(SYSDATE(),'%Y-%m-%d'),c40=chanType  where id = sTemPersonId;-- 更新人员基本信息表-变动类型,变动时间
				if jhtg > 0 THEN -- 教师护士提高10%
					set jhtg = round(CAST((zwgz + newJe)*0.1 AS DECIMAL));
				end if;
				if tjtg > 0 then -- 特殊教育揭提高15%
					set tjtg = round(CAST((zwgz + newJe)*0.15  AS DECIMAL));
				end if;
				
				-- 调用upPercentJbt，更新t117津补贴金额，返回zxgzje，修改t125.c27津补贴小计
				CALL upPercentJbt(sTemPersonId,zxgsje,zwgz,newJe,resultMsg);
				select sum(ifnull(c07+0,0)) into zxgsje from t117 where c03 = concat(sTemPersonId,'');
				update t125 set c27= zxgsje where id = salaryId;
				
				-- set gzhj = zwgz + newJe + jhtg + tjtg, ; 工资合计=职务工资+新的级别/档次工资+提高+保留
				-- 更新人员工资表t125 薪级-c09 岗位起考年度-c10,薪级工资-c26 工资合计c32: 原来的职务工资+新的薪级工资+教师护士提高+特殊教育提高+c30保留特岗工资+c31基础绩效+c27津补贴合计+c44中小学老师保留10%+c45保留护士提高10%
				update t125 set c02=@qxYearMonth,c09 = newDcId ,c10=qknx,c26 = newJe
				,c32 = round((zwgz + newJe + ifnull(jhtg,0) + ifnull(tjtg,0) + ifnull(c30,0) + ifnull(c31,0)+ifnull(c27,0)+ifnull(c44,0)+ifnull(c45,0) +0) ,2)
				,c34 ='',c04=yjwh,c48=''
				-- 工资变动 备注 依据文号 工资报审附件 
				where id = salaryId ;
				-- select UNIX_TIMESTAMP() into sTempParam;
				-- set chanSign = concat(sTempParam,chanType,'t126',sTemPersonId); -- 设置人员基本信息,工资信息,津补贴信息 共同的changeSign
				
				-- 人员基本信息-变动记录
				INSERT data_record_t126 (dataId,dataclassCode,createrId,createDate,updaterId,updateDate,unitId,
					operateTime,operateId,operateType,changeSign,changeType,c01,c02,c03,c04,c28)-- c01,c02,c03,c04,c28必填 
				select 
				id,'t126',c_id,SYSDATE(),c_id,SYSDATE(),u_id,SYSDATE(),c_id,1,chanSign,chanType,orgId,c02,c03,c04,c28
				from t126 where id = sTemPersonId;
				-- values (sTemPersonId,'t126',createrId,SYSDATE(),createrId,SYSDATE(),unitId,SYSDATE(),createrId,1,chanSign,chanType,orgId);
				update data_record_t126 a , t126 b set a.c01 = b.c01 ,a.c02 = b.c02,a.c03=b.c03,a.c04=b.c04,a.c05=b.c05,a.c06=b.c06,a.c07=b.c07,a.c08=b.c08,a.c09=b.c09,
					a.c10=b.c10,a.c11=b.c11,a.c12=b.c12,a.c13=b.c13,a.c14=b.c14,a.c15=b.c15,a.c16=b.c16,a.c17=b.c17,a.c18=b.c18,a.c19=b.c19,a.c20=b.c20,a.c21=b.c21,a.c22=b.c22,
					a.c23=b.c23,a.c24=b.c24,a.c25=b.c25,a.c26=b.c26,a.c27=b.c27,a.c28=b.c28,a.c29=b.c29,a.c30=b.c30,a.c31=b.c31,a.c32=b.c32,a.c33=b.c33,a.c34=b.c34,a.c35=b.c35,
					a.c36=b.c36,a.c37=b.c37,a.c38=b.c38,a.c39=b.c39,a.c40=b.c40,a.c41=b.c41,a.c42=b.c42,a.c43=b.c43,a.c44=b.c44,a.c45=b.c45,a.c46=b.c46,a.c47=b.c47,a.c48=b.c48,
					a.c49=b.c49,a.c50=b.c50
				where a.dataId = b.id and a.dataId = sTemPersonId and  a.changeSign = chanSign ;
	
				-- 人员工资信息-变动记录
				INSERT data_record_t125 (dataId,dataclassCode,createrId,createDate,updaterId,updateDate,unitId,
	 				operateTime,operateId,operateType,changeSign,changeType)
				values (salaryId,'t125',createrId,SYSDATE(),createrId,SYSDATE(),unitId,SYSDATE(),createrId,1,chanSign,chanType);-- 插入 人员工资信息 变动记录
				update data_record_t125 a , t125 b set a.c01 = b.c01 ,a.c02 = b.c02,a.c03=b.c03,a.c04=b.c04,a.c05=b.c05,a.c06=b.c06,a.c07=b.c07,a.c08=b.c08,a.c09=b.c09,
					a.c10=b.c10,a.c11=b.c11,a.c12=b.c12,a.c13=b.c13,a.c14=b.c14,a.c15=b.c15,a.c16=b.c16,a.c17=b.c17,a.c18=b.c18,a.c19=b.c19,a.c20=b.c20,a.c21=b.c21,a.c22=b.c22,
					a.c23=b.c23,a.c24=b.c24,a.c25=b.c25,a.c26=b.c26,a.c27=b.c27,a.c28=b.c28,a.c29=b.c29,a.c30=b.c30,a.c31=b.c31,a.c32=b.c32,a.c33=b.c33,a.c34=b.c34,a.c35=b.c35,
					a.c36=b.c36,a.c37=b.c37,a.c38=b.c38,a.c39=b.c39,a.c40=b.c40,a.c41=b.c41,a.c42=b.c42,a.c43=b.c43,a.c44=b.c44,a.c45=b.c45,a.c46=b.c46,a.c47=b.c47,a.c48=b.c48,
					a.c49=b.c49,a.c50=b.c50
				where a.dataId = b.id and a.dataId = salaryId and  a.changeSign = chanSign ;						
			
				-- --  人员津补贴-变动记录
				call upRyjbtBd(sTemPersonId,createrId,unitId,chanSign,chanType,resultMsg);		
				
				-- 计算补扣发
				select id into changeId from data_record_t126 where  changeSign = chanSign;
				-- call fillCount(orgId,changeId,chanType ,chanSign,resultMsg);
	
			end if;	
			end if;
				
		end if;
		select count(1) into sTempNum from t124 where c03 = concat(sTemPersonId,'') and c01 >= dcsj and c01 < qxsj
		and EXISTS (select 1 from sys_s_data d where d.id = t124.c05); 
		if sTempNum >= 2 then  -- 起考时间开始考核2年以上
			select count(1) into sTempNum from t124 where c03 = concat(sTemPersonId,'') and c01 >= dcsj and c01 < qxsj
			and EXISTS (select 1 from sys_s_data d where d.id = t124.c05 and d.data_value < '3');
			if sTempNum < 2 then  -- 未达到2年以上称职
				SET @khfcz = CONCAT(@khfcz,stemPersonId,','); 
				set FailIndex = FailIndex+1;-- 晋级失败人数+1	
			end if;
		ELSE 
			select DATE_FORMAT(SYSDATE(),'%Y') into @NowY;
			set @sqlstr = concat('select count(1) into @sTempNum from data_record_t126 ',
				'where  dataId = ',sTemPersonId,
				' and changeType = ',chanType,' and  exists(select 1 from data_record_t125 where data_record_t126.changesign = data_record_t125.changesign ',
				' and data_record_t125.c02 like \'',SUBSTR(qxsj from 1 for 4),'%\')');
				-- 当年只能做一次事业正常晋升薪级
			PREPARE stmt FROM @sqlstr;
			EXECUTE stmt;
			set sTempNum = @sTempNum;
			if sTempNum > 0 then 
				--  当前变动时间所有年份已经存在此变动记录类型
				SET @bdcz = CONCAT(@bdcz,stemPersonId,',');
				set FailIndex = FailIndex+1;
			else
				set @sNum = qknx-dcsj;
				if @sNum >= 2 then 
					SET @khsjbm = CONCAT(@khsjbm,stemPersonId,',');
					set FailIndex = FailIndex+1;
				else
					SET @qksjbz = CONCAT(@qksjbz,stemPersonId,',');
					set FailIndex = FailIndex+1;
				end if;
			end if;
		end if;
	end if;

	set done = @doneF;
  END LOOP;
  -- 关闭游标
CLOSE personId_;	

-- 遍历试用期人员
set done = FALSE;
OPEN personId_2;
    loop1: LOOP
        FETCH personId_2 into sTemPersonId;

        IF done THEN
            LEAVE loop1;
        END IF;
			set @syq = concat(@syq,sTemPersonId,',');
			set FailIndex = FailIndex+1;-- 晋级失败人数+1	
    END LOOP;
close personId_2;


-- 遍历在职计发生活费人员
set done = FALSE;
OPEN personId_3;
    loop1: LOOP
        FETCH personId_3 into sTemPersonId;

        IF done THEN
            LEAVE loop1;
        END IF;
				set @jfshf = concat(@jfshf,sTemPersonId,',');
				set FailIndex = FailIndex+1;-- 晋级失败人数+1	
    END LOOP;
close personId_3;


-- 遍历所有在职停薪人员
set done = FALSE;
OPEN personId_4;
    loop1: LOOP
        FETCH personId_4 into sTemPersonId;

        IF done THEN
            LEAVE loop1;
        END IF;
				set @zztx = concat(@zztx,sTemPersonId,',');
				set FailIndex = FailIndex+1;-- 晋级失败人数+1	
    END LOOP;
close personId_4;
-- 遍历所有在职计发病假工资人员
set done = FALSE;
OPEN personId_5;
    loop1: LOOP
        FETCH personId_5 into sTemPersonId;

       IF done THEN
           LEAVE loop1;
       END IF;
 		set @jfbj = concat(@jfbj,sTemPersonId,',');
				set FailIndex = FailIndex+1;-- 晋级失败人数+1	
    END LOOP;
close personId_5;

-- 遍历所有在职停薪人员
set done = FALSE;
OPEN personId_6;
    loop1: LOOP
        FETCH personId_6 into sTemPersonId;

        IF done THEN
            LEAVE loop1;
        END IF;
				set @jbgz0 = concat(@jbgz0,sTemPersonId,',');
				set FailIndex = FailIndex+1;-- 晋级失败人数+1	
    END LOOP;
close personId_6;


    if stemSucIndex > 0 then 
    	call p_fund_updateFlag(orgId,@re);-- 变动后更新基金isUPdateFund=1
	  	set resultMsg = concat('机关工人正常晋升岗位工资成功:[',stemSucIndex,']人');
			set @resultM = replace(@resultM,'resultM:','');
			if stemFailIndex > 0 then 
				set resultMsg= concat(resultMsg,'（起薪时间不在',qxYearMonth,'的共[',stemFailIndex,']人，可能需要做一次性补扣发）;');
			end if;
	  END if;

	if FailIndex > 0 then 
		set resultMsg = replace(resultMsg,'resultMsg','');
		set @failMsg = concat(@qksjbz,';',@khsjbm,';',@khfcz,';',@qxsjbd,';',@syq,';',@jfshf,';',@jfbj,';',@zztx,';',@bdcz,';',@jbgz0,';');
		insert into temp_multi values(orgId,chanType,sysdate(),@failMsg);
		if stemSucIndex = 0 THEN
			-- set resultMsg= CONCAT(resultMsg,'成功:[0]人，','失败[',FailIndex,']人，是否下载失败记录?',@qksjbz,';',@khsjbm,';',@khfcz,';',@qxsjbd,';',@syq,';',@jfshf,';',@jfbj,';',@zztx,';',@bdcz,';',qxYearMonth,';',chanType,';','2');
			set resultMsg= CONCAT(resultMsg,'成功:[0]人，','失败[',FailIndex,']人，是否下载失败记录?',qxYearMonth,';',chanType,';','2');
		ELSE
			set resultMsg= CONCAT(resultMsg,'失败[',FailIndex,']人，是否下载失败记录?',qxYearMonth,';',chanType,';','2');	
			-- set resultMsg= CONCAT(resultMsg,'失败[',FailIndex,']人，是否下载失败记录?',@qksjbz,';',@khsjbm,';',@khfcz,';',@qxsjbd,';',@syq,';',@jfshf,';',@jfbj,';',@zztx,';',@bdcz,';',qxYearMonth,';',chanType,';','2');
		end if;
	end if;
	if 	FailIndex = 0 and stemSucIndex= 0 then	
			set resultMsg = replace(resultMsg,'resultMsg','该变动原因无晋升人员');
	end if;
  	leave label_pro;
			
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`upJgJb`(IN createrId int(11),IN unitId int(11),IN orgId varchar(200),
IN chanType varchar(200),IN qxsj varchar(20) ,IN bdsj varchar(20),IN qknx varchar(4),in yjwh varchar(100),
INOUT resultMsg varchar(10000) CHARSET utf8)
label_pro:BEGIN	
	-- orgId 单位id
	-- chanType 批量变动变动类型id  sys_s_data data_value = 11 机关正常晋升级别工资
	-- bdsj 变动时间 20160701
	-- qxsj 起薪时间 20160101
	-- DECLARE orgId varchar(100);-- 单位id

	DECLARE changeType varchar(100);-- -- 变动类型sys_s_data id
	DECLARE changeId int(11);-- -- changeId 变动记录id 主要是t126的变动记录id,此id来查询所有关联的工资t125,津贴t117 变动记录
	DECLARE personId varchar(100);-- 人员id
	
	DECLARE salaryId varchar(100);-- 工资信息的Id
	DECLARE salaryRecordId varchar(100);-- 工资信息的recordId
	DECLARE changeTypeCode varchar(100);-- 变动类型code

	DECLARE rysf varchar(10);-- 人员身份 管理人员 工人 专业技术人员	
	DECLARE rygzzd varchar(20);-- 人员工资制度- - 公务员职级工资制码表-201 警察职级工资制度-206	
	DECLARE zxgzbz varchar(20);-- 执行工资标准- 公务员
	
	DECLARE zwgz double DEFAULT 0;-- 职务工资
	DECLARE jb varchar(10);-- 级别
 	DECLARE zggzjb int(20);-- 最高工资级别
	DECLARE jbsj varchar(10);-- 级别-起考时间
	DECLARE dc varchar(10);-- 档次
	DECLARE jbgz varchar(10);-- 级别工资-档次-薪级工资
	DECLARE dcsj varchar(10);-- 档次-薪级	
	DECLARE newJb varchar(20);-- 新级别	
	DECLARE newJbsj varchar(20);-- 新级别时间
	DECLARE newDc varchar(20);-- 新档次	
	DECLARE newDcsj varchar(20);-- 新起考时间
	DECLARE newJe double DEFAULT 0;-- 新金额
	DECLARE newDcId varchar(10);-- 新档次Id

	DECLARE subJe double DEFAULT 0;-- 档差(薪级差)金额
	DECLARE jhtg double DEFAULT 0;-- 教师护士提高10%
	DECLARE tjtg double DEFAULT 0;-- 特殊教育揭提高15%
	DECLARE oldQysj varchar(20);-- 标准启用时间
	DECLARE oldBzlb varchar(20);-- 标准类别
	DECLARE oldBzmc varchar(20);-- 标准名称
	DECLARE oldJbmc varchar(20);-- 级别名称-档次/薪级
	DECLARE oldCjbmc varchar(20);-- 次级别名称-级别
	DECLARE oldJe double DEFAULT 0;-- 金额
	DECLARE oldZxgzbz varchar(50);-- 执行工资标准
	
	DECLARE qxYearMonth varchar(100);-- 起薪时间-截取 年月 2016-01
	
	DECLARE sTemPersonId varchar(100);-- 人员id-变量
	DECLARE sTempNum int(11);-- 参数
	DECLARE sTempYearMonth varchar(6);-- 
	DECLARE sTempParam int(11);-- 变动时间-(减去)起薪时间的月份

	DECLARE chanSign varchar(100);-- 变动标志
	
	DECLARE qxMonth varchar(10);-- 系统设置批量变动 统一起薪月份 :01表示 当年1月  11表示当年11月

	DECLARE stemSucIndex int(11) default 0;-- 批量晋升工资成功条数
	DECLARE stemFailIndex int(11) default 0;-- 批量晋升工资失败条数(需要手工补扣发人数)
	
	DECLARE zxgs	varchar(100);-- t117执行公式
	DECLARE zxje	double DEFAULT 0;-- t117执行金额
	DECLARE zxgsje double DEFAULT 0;-- t117 执行公式*t117执行金额
	DECLARE dwdm int(11);-- 单位代码
	DECLARE personNo varchar(100);-- 人员编号
	DECLARE personNum int(11);	-- 所有机关公务员在职公务员数量-排开试用期人员 
	DECLARE	FailIndex int(11) default 0; -- 晋级失败人数
	DECLARE temp varchar(100); -- 最近一次变动记录的起薪时间
	DECLARE c_id int(11);-- 创建人id
	DECLARE u_id int(11);-- 功能id
	
	DECLARE mydone INT DEFAULT 0;
    DECLARE done INT DEFAULT FALSE;
	-- -- 所有机关公务员在职公务员-排开试用期人员
	DECLARE personId_ CURSOR FOR
   SELECT t126.id from t126 ,t125,sys_s_data d 
		where t126.c01 = concat(orgId,'')  -- 单位代码
		and t125.c06 = concat(t126.id,'')-- 人员编号
		and d.id = t125.c36  and d.data_value in( 201,206 )-- t125.c36 人员工资制度为 201 -公务员职级工资 206-警察职级工资制度 包含身份:公务员 人民警察 司法辅助 行政人员 
		and EXISTS (select 1 from t127 where t127.id = t126.c17 and t127.c05 not like '%试用期%') -- t126.c39 执行工资标准 关联 单位工资制度与人员属性信息对应关系t136.c04 执行工资标准
	  and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
	and (ifnull(t126.c43,'') !=10487 and ifnull(t125.c26,'')!=0)  -- 排除已经停薪的人员  10487是否状态-是   级别工资是0 的不参与晋升
	and ifnull(t125.c39,'') !=10487 -- 排除计发生活费的人员
	and ifnull(t125.c40,'') !=10487 -- 排除计发病假工资的人员
	;
	
	-- 所有在职试用期公务员 
	DECLARE personId_2 CURSOR FOR
   SELECT t126.id from t126 ,t125,sys_s_data d 
		where t125.c06 = concat(t126.id,'') and d.id = t125.c36 
		and t126.c01 = concat(orgId,'') and d.data_value in( 201,206) -- t125.c36 人员工资制度为 201 -公务员职级工资 206-警察职级工资制度 
		and EXISTS (select 1 from t127 where t127.id = t126.c17 and t127.c05 like '%期%') -- t126.c39 执行工资标准 关联 单位工资制度与人员属性信息对应关系t136.c04 执行工资标准
	  and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
	and ifnull(t126.c43,'') !=10487 -- 排除已经停薪的人员  10487是否状态-是
	and ifnull(t125.c39,'') !=10487 -- 排除计发生活费的人员
	and ifnull(t125.c40,'') !=10487 -- 排除计发病假工资的人员
	;
	-- 所有在职计发生活费人员
	DECLARE personId_3 CURSOR FOR
   SELECT t126.id from t126 ,t125,sys_s_data d 
		where t125.c06 = concat(t126.id,'') and d.id = t125.c36 
		and t126.c01 = concat(orgId,'') and d.data_value in( 201,206) -- t125.c36 人员工资制度为 201 -公务员职级工资 206-警察职级工资制度 
		and EXISTS (select 1 from t127 where t127.id = t126.c17 and t127.c05 not like '%期%') -- t126.c39 执行工资标准 关联 单位工资制度与人员属性信息对应关系t136.c04 执行工资标准
	  and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
	and ifnull(t126.c43,'') !=10487 -- 排除已经停薪的人员  10487是否状态-是
	and t125.c39 =10487 -- 计发生活费的人员
	;

	-- -- 所有在职停薪人员
	DECLARE personId_4 CURSOR FOR
   SELECT t126.id from t126 ,t125,sys_s_data d 
		where t125.c06 = concat(t126.id,'') and d.id = t125.c36 
		and t126.c01 = concat(orgId,'') and d.data_value in( 201,206) -- t125.c36 人员工资制度为 201 -公务员职级工资 206-警察职级工资制度 
	and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
	and ifnull(t126.c43,'') =10487   -- 排除已经停薪的人员  10487是否状态-是    
	and ifnull(t125.c39,'') !=10487 -- 排除计发生活费的人员
	and ifnull(t126.c40,'') !=10831 -- 排除减少人员
	;

		-- 所有在职计发病假工资人员
	DECLARE personId_5 CURSOR FOR
   SELECT t126.id from t126 ,t125,sys_s_data d 
		where t125.c06 = concat(t126.id,'') and d.id = t125.c36 
		and t126.c01 = concat(orgId,'') and d.data_value in( 201,206) -- t125.c36 人员工资制度为 201 -公务员职级工资 206-警察职级工资制度 
		and EXISTS (select 1 from t127 where t127.id = t126.c17 and t127.c05 not like '%期%') -- t126.c39 执行工资标准 关联 单位工资制度与人员属性信息对应关系t136.c04 执行工资标准
	  and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
	and ifnull(t126.c43,'') !=10487 -- 排除已经停薪的人员  10487是否状态-是
	and t125.c40 =10487 -- 计发生活费的人员
	;
	
		
		-- -- 所有级别工资为0人员
	DECLARE personId_6 CURSOR FOR
   SELECT t126.id from t126 ,t125,sys_s_data d 
		where t125.c06 = concat(t126.id ,'') and d.id = t125.c36 
		and t126.c01 = concat(orgId,'') and d.data_value in( 201,206) -- t125.c36 人员工资制度为 201 -公务员职级工资 206-警察职级工资制度 
		and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
	and  ifnull(t125.c32,0) = 0  --    工资合计为0 及视为停发工资
	and ifnull(t126.c43,'') !=10487   -- 排除已经停薪的人员  10487是否状态-是    
	and ifnull(t125.c39,'') !=10487 -- 排除计发生活费的人员
	and ifnull(t126.c40,'') !=10831 -- 排除减少人员
	;
	
	
 	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
 
	-- select DATE_FORMAT(qxsj,'%Y%m') into qxYearMonth;-- 起薪年月 201601

	select content into qxMonth from sys_s_config where enname = 'qxMonth' ;

	set c_id = createrId;
	set u_id = unitId;
	if length(qxsj)=4 then
		select DATE_FORMAT(concat(qxsj,'-',qxMonth,'-01'),'%Y-%m') into qxYearMonth;-- 起薪年月 2016-01
	else
		select DATE_FORMAT(qxsj,'%Y-%m') into qxYearMonth;-- 起薪年月 2016-01
 	end if;
	
	set @resultM = 'resultM:';
	set @khsjbm = 'khsjbm:';-- 考核没考5年称职的
	set @qksjbz = 'qksjbz:';-- 人员上一次变动起考时间与起薪年月-年相差不足5年
	set @khfcz = 'khfcz:';-- 考核不是称职的 用来包装考核5年，但没有达到5年称职
	set @qxsjbd = 'qxsjbd:';-- 人员起薪时间 小于等于最近一次变动记录的起薪时间
	set @syq = 'syq:';-- 试用期人员
	set @jfshf = 'jfshf:';-- 在职计发生活费人员
	set @jfbj = 'jfbj:';-- 在职计发病假工资人员
	set @zztx = 'zztx:';-- 所有在职停薪人员
	set @bdcz = 'bdcz:';-- 当前变动类型当年已经存在
	set @jbgz0 = 'jbgz0:';-- 所有级别工资为0人员
	set @zddc = 'zddc:' ;-- 达到最低档次了  那么就不晋级了  提示用户自己做个别变动
	set resultMsg = 'resultMsg';
	-- 打开游标
  OPEN personId_;  
  -- 开始循环
  read_loop: LOOP
    -- 提取游标里的数据，这里只有一个，多个的话也一样；
    FETCH personId_ INTO sTemPersonId;
    -- 声明结束的时候
    IF done THEN
      LEAVE read_loop;
    END IF;
	set @doneF = done;-- 用于存储当前游标实际结束标志,在中间查询过程中可能会对done进行变更(原因尚不知),所以存放临时变量
    	
    select count(1) into sTempNum from data_record_t126 t126 ,data_record_t125 t125 
    where   t125.c06=concat(t126.dataId,'') and t126.changeSign = t125.changeSign 
    and t126.dataId = sTemPersonId and t126.changeType = chanType 
		and t126.allAuditFlag = '2'
		and t125.c02 >= qxYearMonth ;
    if sTempNum = 0 then -- 起薪时间之后已经存在通过的此变动记录
/*
    	-- 人员在当前单位第一次起薪时间
		select t125.c02 into @firstQxsj from data_record_t126 t126,data_record_t125 t125 
			where  t126.changesign = t125.changesign and  t126.dataId = stemPersonId and t125.c06 = concat(t126.dataId ,'') 
			and t126.c01 = concat(orgId,'') and t126.changetype in(10750,10832) order by t126.id desc  limit 0,1;

		
		-- 重新确定工资
		select count(1) into @cxqdNum from data_record_t126 t126 ,data_record_t125 t125
    	where  t126.changesign = t125.changesign and   t126.dataId = stemPersonId and t125.c06 = concat(t126.dataId ,'') 
    	 and t126.changeType in(select id from sys_s_data d where d.typename = 'bdlx' and data_value = '05')
    	 and t126.c01 = concat(orgId,'') 
    	 order by t125.id desc 
    	 limit 0,1;-- 重新确定工资
		if @cxqdNum > 0 then 
	    	select t125.c02 into @firstQxsj from data_record_t126 t126 ,data_record_t125 t125
	    	where  t126.changesign = t125.changesign and  t126.dataId = stemPersonId and t125.c06 = concat(t126.dataId ,'') 
	    	 and t126.changeType in(select id from sys_s_data d where d.typename = 'bdlx' and data_value = '05')
	    	 and t126.c01 = concat(orgId,'') 
	    	 order by t125.id desc 
	    	 limit 0,1;-- 重新确定工资
		end if;*/
		-- 人员在本单位最后一次起薪（录入或调入）时间、重新确定工资起薪时间、工资制度变化起薪时间 取最大的一个起薪时间
		call p_person_getQxsj(sTemPersonId,@firstQxsj);-- 根据人员当前单位及身份等获取最早起薪时间
		
		select PERIOD_DIFF(replace(@firstQxsj,'-',''),replace(qxYearMonth,'-','')) into @stemNum; -- 判断 起薪时间201601与当前人员在该单位首次起薪时间201602 
	-- 	set resultMsg = concat('qxYearMonth:',qxYearMonth,',@firstQxsj:',@firstQxsj,',@stemNum:',@stemNum);leave label_pro;
		if @stemNum > 0 then -- 设置人员起薪时间  如果在单位首次起薪为201602,则设置为2016-02 如果一直在 则为为 2016-01 
			set @qxYearMonth = @firstQxsj;
		else 
			set @qxYearMonth = qxYearMonth;
		end if;
		
    	-- 循环查询人员工资信息
		-- t125 人员工资信息表 c07-工资级别-关联工资标准表t127.c05次级别名称,c08-级别起考时间,c09-工资档次-关联工资标准表-c04级别名称,c10-档次起考时间,c25-职务工资,c26-级别工资,c28-教师护士提高10%,c29-特殊教育提高15%,c36-人员工资制度-字符型
		-- t126 人员基本信息表 c28-人员身份-关联 单位工资制度与人员属性信息对应关系.人员身份 t126.c39-执行工资标准-关联 单位工资制度与人员属性信息对应关系.执行工资标准 t125.c27-津补贴小计
		select t125.id,t125.c07,t125.c08,t125.c09,t125.c10,round(t125.c25,2),round(t125.c26,2),round(t125.c28,2),round(t125.c29,2),t125.c36,t126.c28,t126.c39,t126.c01,t126.c02,round(t125.c27,2)
		into salaryId,jb,jbsj,dc,dcsj,zwgz,jbgz,jhtg,tjtg,rygzzd,rysf,zxgzbz,dwdm,personNo,zxgsje
		from t126,t125 where t125.c06 = concat(t126.id ,'')  and t126.id = sTemPersonId ; -- t125 人员工资表 c06-人员编号 关联型
		
			
		-- 查询有该单位下该人员有多少津补贴项dwd 单位代码 ,personNo 人员编号
		-- 人员的执行公式,执行金额，如果执行公式以%结尾，津补贴小计要加上执行公式*执行金额 zxgsje
		-- select COUNT(1) into @jbt  from t117  t  WHERE t.c02 = dwdm  and t.c03 = personNo ;
		-- if @jbt > 0  then
		-- zxgsje = CALL upPercentJbt(sTemPersonId);
		-- END IF;


		set dcsj = SUBSTR(dcsj FROM 1 FOR 4);-- 2016-07-01 to 2016
		
		--  t124 人员年度考核情况表 c03人员编号  关联型 c01-考核年度 c05-考核结果 码表, 1-优秀 2-称职 3-基本称职 4-不称职 5-不参与考核
		-- 起考年度-2012与起薪时间-2017-01-01之间 考核年度[2012,2013,2014,2015,2016]机关连续5年以上考核 称职以上 升一级(可能退一档)事业是每年都会晋升薪级
		select count(1) into sTempNum from t124 where c03 = concat(sTemPersonId,'') and c01 >= jbsj and c01 < qxsj
			and EXISTS (select 1 from sys_s_data d where d.id = t124.c05 and d.data_value < '3');
		
		select c04 into @personName from t126 where id = stemPersonId; -- 人员姓名
			
		if sTempNum >= 5 then -- 满足起考年度开始连续5年称职以上 升级
			
			-- 对起薪时间与最近一次未通过审核的变动记录的起薪时间进行比较,如果起薪时间在这变动记录之前,不能晋升
			 select UNIX_TIMESTAMP() into sTempParam;
			 set chanSign = concat('batch',sTempParam,chanType,'t126',sTemPersonId);
			--  set chanSign = concat('\'',chanSign,'\'');
			
			set temp = '';
			if(	EXISTS(select 1 from data_record_t125 a  -- 人员在目前单位的变动记录ID并且ID大于人员在当前单位最新的一次录入或者接收人员变动
					where  a.dataId = salaryId and  a.allAuditFlag<>2 and a.perAuditFlag<>2 and a.id >= (select id from data_record_t125 where changeSign =
 (select changeSign from data_record_t126 where dataId = sTemPersonId AND c01 = (select c01 from t126 where id = sTemPersonId) and  (c40 = '10750' or c40 = '10832') order by id desc LIMIT 1))
					order by a.updateDate desc LIMIT 0,1)) THEN  -- 判断是否存在结果 存在则赋值
						select a.c02 into temp from data_record_t125 a  
						where  a.dataId = salaryId and  a.allAuditFlag<>2 and a.perAuditFlag<>2
						order by a.updateDate desc LIMIT 0,1;
			end if;
			
	
			IF  @qxYearMonth < temp THEN -- 人员起薪时间 小于等于最近一次变动记录的起薪时间
					SET @qxsjbd = CONCAT(@qxsjbd,stemPersonId,'-',@qxYearMonth,','); 
					set FailIndex = FailIndex+1;-- 晋级失败人数+1	
			else 
				/**select t125.c02 into @firstQxsj from data_data_record t126,data_data_record t125 
				where t126.dataclassCode = 't126' and t125.dataclassCode = 't125' 
				and t126.dataId = stemPersonId and t125.c06 = t126.dataId limit 0,1;
				*/
				-- set resultMsg = concat('@personName:',@personName,',@qxYearMonth:',@qxYearMonth,',qxYearMonth:',qxYearMonth);leave label_pro;
				
				-- set @stemQxsj = @qxYearMonth;
			-- set resultMsg = concat('firstQxsj > stemQxsj:',firstQxsj > stemQxsj);leave label_pro;
			-- set resultMsg = concat('qxYearMonth:',qxYearMonth,',@qxYearMonth:',@qxYearMonth,',@firstQxsj:',@firstQxsj);leave label_pro;
				-- set resultMsg = concat('@qxYearMonth !=  qxYearMonth:',@qxYearMonth !=  qxYearMonth);leave label_pro;
				if  @qxYearMonth !=  qxYearMonth then -- 起薪时间 与 系统设置的起薪时间不一致
				
					set @resultM = concat(@resultM,'[',@personName,':变动起薪时间',@qxYearMonth,']');
					set stemFailIndex = stemFailIndex + 1;-- 需要手工补扣发的人数+1
					-- set resultMsg = stemFailIndex;leave label_pro;
				end if;
				-- t127 工资标准表  c01-启用时间 c02-标准类别 c03-标准名称 c04-次级别名称(工资档次等) c05-次级别名称(工资级别等) c06-金额 c08-执行工资标准 c09-工资标准备注
				select c01,c02,c03,c05,c05,c06,c08 into oldQysj,oldBzlb,oldBzmc,jb,oldCjbmc,oldJe,oldZxgzbz 
				from t127 where id = jb;
				select c01 into oldQysj from t127 where c08 = oldZxgzbz ORDER BY c01 desc limit 0,1; -- 赋值最新的工资标准时间
				if jbgz != oldJe then -- 如果公务员系列的 级别工资 与查询工资标准的金额不一致 则查询符合条件的工资标准id数据
					set oldJe = jbgz;
				end if;
				select c04 ,c04 into dc,oldJbmc from t127 where id = dc;
				-- select id into jb from t127 where c01 = oldQysj and c02 = oldBzlb and c03 = oldBzmc and c04 = oldCjbmc;
				-- select id into dc from t127 where c01 = oldQysj and c02 = oldBzlb and c03 = oldBzmc and c04 = oldJbmc;
				-- select c04 into zxgzbz from t136 where id = zxgzbz; -- 单位工资制度与人员属性信息对应关系t136.c04 执行工资标准
				-- select c02 into rysf from t136 where id = rysf; -- 单位工资制度与人员属性信息对应关系t136.c02 人员身份
				-- 人员身份-t126.c28改成码表  不用重新查询更新
				-- select c02 into rysf from t136 where id = rysf; -- 单位工资制度与人员属性信息对应关系t136.c02 人员身份
				select SUBSTR(jb FROM 1 FOR POSITION('级' IN jb)-1),SUBSTR(dc FROM 1 FOR POSITION('档' IN dc)-1) into jb,dc;
	
				
		-- 获取最高工资级别
				select t165.c04 into zggzjb from t126 , t127 , t165 
					where t127.id = t126.c17 and t127.c05 = t165.c01 and t127.c08 = t126.c39 and t165.c05=t127.c08
					and t126.id = sTemPersonId and t126.c39 = zxgzbz;
			-- set resultMsg = concat('zggzjb:',zggzjb);leave label_pro;
				if jb <= zggzjb then
					set newJb = jb;
					set newJb = CONCAT(newJb,'级');
					set newDc = dc + 1 ;-- 此档次上一个档次
					set newJbsj = qknx;
					set newDcsj = jbsj; -- 如果退档 则不使用新的起考年度
				else
					set newJb = jb-1;-- 级别是越小工资越高
					set newJb = CONCAT(newJb,'级');
					set newDc = dc -1 ;-- 此档次上一个档次
					set newDcsj = dcsj; -- 如果退档 则不使用新的起考年度
					set newJbsj = qknx; -- 如果退档 则不使用新的起考年度
				end if;
				
				set @t125gdjb = 0;
				set @beforegddc = 1;
				if newDc <= 0 THEN
					set @beforegddc = newDc;
					set newDc = dc;
					set newDcsj = qknx; -- 如果没有退档 则使用新的起考年度
					select ifnull(c11,0)  into  @t125gdjb from t125 where c06 = stemPersonId; -- 高定级别
				end if;
				if cast(@t125gdjb as SIGNED INTEGER) > 0 and  @beforegddc <= 0 then  -- 高定级别后档次小于1档了
						
						SET @zddc = CONCAT(@zddc,stemPersonId,','); 
						set FailIndex = FailIndex+1;-- 晋级失败人数+1	
				ELSE 

						set newDc = CONCAT(newDc,'档');-- 晋级退档 都 是级别-1 档次-1 数据库是肯定有的不需要再是否存在 
						select count(1) into sTempParam from t127 a where a.c05 = newJb  and c04 = newDc  and c03 = oldBzmc 
						and c08 = oldZxgzbz and c01 = oldQysj;-- 查询新的级别新的档次工资是否存在
						if sTempParam = 0 THEN 
							set @preDc = dc -1 ;-- 此档次上一个档次 
							if @preDc <= 0 THEN
								set @preDc = @preDc + 1;
							end if;
							select count(1) into @sTempCountParam from t127 a where a.c05=newJb 
							and c03 = oldBzmc and c08 = oldZxgzbz and c04 = CONCAT(@preDc,'档') and c01 = oldQysj;-- 上一个档次的金额
							if @sTempCountParam > 0 then 
								select c06 into sTempParam from t127 a where a.c05 = newJb  
								and c03 = oldBzmc and c08 = oldZxgzbz and c04 = CONCAT(@preDc,'档') 
								and c01 = oldQysj;-- 上一个档次的金额
								set subJe = oldJe - sTempParam + 0;
								set newJe = oldJe + subJe + 0; -- 原来薪级/档次的工资+档差工资
								insert into t127(dataclassCode,c01,c03,c04,c05,c06,c08,c_id,createDate,c_id,updateDate)
								values ('t127',oldQysj,oldBzmc,newDc,newJb,newJe,oldZxgzbz,1,SYSDATE(),1,SYSDATE());
							end if;
						end if;	
						
						select id,c06 into newDcId,newJe from t127 a where a.c05 = newJb  and c04 = newDc  and c03 = oldBzmc 
						and c08 = oldZxgzbz and c01 = oldQysj;-- 查询新的级别新的档次工资是否存在
						select count(1) into sTempNum from data_record_t126 where  dataId = sTemPersonId and changeType = chanType and ifnull(allAuditFlag,'') != '2';
						if sTempNum = 0 then 
							select DATE_FORMAT(SYSDATE(),'%Y') into @NowY;
							set @sqlstr = concat('select count(1) into @sTempNum from data_record_t126 ',
								'where  dataId = ',sTemPersonId,
								' and changeType = ',chanType,' and  exists(select 1 from data_record_t125 where data_record_t126.changesign = data_record_t125.changesign ',
								' and data_record_t125.c02 like \'',SUBSTR(qxsj from 1 for 4),'%\')');
								-- 当年只能做一次机关正常晋升级别
							PREPARE stmt FROM @sqlstr;
							EXECUTE stmt;
							set sTempNum = @sTempNum;
						end if;
						if sTempNum > 0 then 
							--  当前变动时间所有年份已经存在此变动记录类型
							SET @bdcz = CONCAT(@bdcz,stemPersonId,',');
							-- set @bdcz = replace(@bdcz,'bdcz:',''); -- 用来包装没有起考时间开始考核2年以上
							set FailIndex = FailIndex+1;
						end if;

						if sTempNum = 0 then 
							--  如果不存在此变动记录,存在先不管
							set stemSucIndex = stemSucIndex + 1; -- 晋升成功人数+1
							update t126 set c41=DATE_FORMAT(SYSDATE(),'%Y-%m-%d'),c40=chanType where id = sTemPersonId;-- 更新人员基本信息表-变动类型,变动时间
							if jhtg > 0 THEN -- 教师护士提高10%
								set jhtg = round(CAST((zwgz + newJe)*0.1 AS DECIMAL));
							end if;
							if tjtg > 0 then -- 特殊教育揭提高15%
								set tjtg = round(CAST((zwgz + newJe)*0.15 AS DECIMAL));
							end if;
							
							-- 调用upPercentJbt，更新t117津补贴金额，返回zxgzje,修改t125.c27 津补贴小计
							CALL upPercentJbt(sTemPersonId,zxgsje,zwgz,newJe,resultMsg);
							select sum(ifnull(c07+0,0)) into zxgsje from t117 where c03 = concat(sTemPersonId,'');
							update t125 set c27= zxgsje where id = salaryId;
							
							-- set gzhj = zwgz + newJe + jhtg + tjtg, ; 工资合计=职务工资+新的级别/档次工资+提高+保留
							-- 更新人员工资表t125 级别-c07,级别起考时间-c08 薪级-c09,档次起考时间-c10 薪级工资-c26 工资合计c32: 原来的职务工资+新的薪级工资+教师护士提高+特殊教育提高+c30保留特岗工资+c31基础绩效+c27津补贴合计+c44中小学老师保留10%+c45保留护士提高10%
							-- update t125 set c07=newDcId,c08=qknx,c09 = newDcId,c10=newDcsj,c26 = newJe,c32 = zwgz + newJe + jhtg + tjtg + c30 + c31+c27+c44+c45 +0 where id = salaryId ;
							update t125 set c02= @qxYearMonth,c07=newDcId,c08=newJbsj,c09 = newDcId,c10=newDcsj,c26 = newJe, 
							c32 = round(zwgz + newJe + ifnull(jhtg,0) + ifnull(tjtg,0) + ifnull(c30,0) + ifnull(c31,0)+ifnull(c27,0)+ifnull(c44,0)+ifnull(c45,0) +0,2) 
							,c34 ='',c04=yjwh,c48=''
						-- 工资变动 备注 依据文号 工资报审附件 
							where id = salaryId ;
							--  select UNIX_TIMESTAMP() into sTempParam;
							-- set chanSign = concat(sTempParam,chanType,'t126',sTemPersonId); -- 设置人员基本信息,工资信息,津补贴信息 共同的changeSign
							-- 人员基本信息-变动记录
							-- 先插入一条操作记录 基本信息的
							INSERT data_record_t126 (dataId,dataclassCode,createrId,createDate,updaterId,updateDate,unitId,
								operateTime,operateId,operateType,changeSign,changeType,c01,c02,c03,c04,c28)-- c01,c02,c03,c04,c28必填 
							select 
							id,'t126',c_id,SYSDATE(),c_id,SYSDATE(),u_id,SYSDATE(),c_id,1,chanSign,chanType,orgId,c02,c03,c04,c28
							from t126 where id = sTemPersonId;
							-- values (sTemPersonId,'t126',createrId,SYSDATE(),createrId,SYSDATE(),unitId,SYSDATE(),createrId,1,chanSign,chanType,orgId);
							
							update data_record_t126 a , t126 b set a.c01 = b.c01 ,a.c02 = b.c02,a.c03=b.c03,a.c04=b.c04,a.c05=b.c05,a.c06=b.c06,a.c07=b.c07,a.c08=b.c08,a.c09=b.c09,
								a.c10=b.c10,a.c11=b.c11,a.c12=b.c12,a.c13=b.c13,a.c14=b.c14,a.c15=b.c15,a.c16=b.c16,a.c17=b.c17,a.c18=b.c18,a.c19=b.c19,a.c20=b.c20,a.c21=b.c21,a.c22=b.c22,
								a.c23=b.c23,a.c24=b.c24,a.c25=b.c25,a.c26=b.c26,a.c27=b.c27,a.c28=b.c28,a.c29=b.c29,a.c30=b.c30,a.c31=b.c31,a.c32=b.c32,a.c33=b.c33,a.c34=b.c34,a.c35=b.c35,
								a.c36=b.c36,a.c37=b.c37,a.c38=b.c38,a.c39=b.c39,a.c40=b.c40,a.c41=b.c41,a.c42=b.c42,a.c43=b.c43,a.c44=b.c44,a.c45=b.c45,a.c46=b.c46,a.c47=b.c47,a.c48=b.c48,
								a.c49=b.c49,a.c50=b.c50
							where a.dataId = b.id and a.dataId = sTemPersonId and  a.changeSign = chanSign ;
				
							-- 人员工资信息-变动记录
							INSERT data_record_t125 (dataId,dataclassCode,createrId,createDate,updaterId,updateDate,unitId,
								operateTime,operateId,operateType,changeSign,changeType)
							values (salaryId,'t125',createrId,SYSDATE(),createrId,SYSDATE(),unitId,SYSDATE(),createrId,1,chanSign,chanType);-- 插入 人员工资信息 变动记录
							update data_record_t125 a , t125 b set a.c01 = b.c01 ,a.c02 = b.c02,a.c03=b.c03,a.c04=b.c04,a.c05=b.c05,a.c06=b.c06,a.c07=b.c07,a.c08=b.c08,a.c09=b.c09,
								a.c10=b.c10,a.c11=b.c11,a.c12=b.c12,a.c13=b.c13,a.c14=b.c14,a.c15=b.c15,a.c16=b.c16,a.c17=b.c17,a.c18=b.c18,a.c19=b.c19,a.c20=b.c20,a.c21=b.c21,a.c22=b.c22,
								a.c23=b.c23,a.c24=b.c24,a.c25=b.c25,a.c26=b.c26,a.c27=b.c27,a.c28=b.c28,a.c29=b.c29,a.c30=b.c30,a.c31=b.c31,a.c32=b.c32,a.c33=b.c33,a.c34=b.c34,a.c35=b.c35,
								a.c36=b.c36,a.c37=b.c37,a.c38=b.c38,a.c39=b.c39,a.c40=b.c40,a.c41=b.c41,a.c42=b.c42,a.c43=b.c43,a.c44=b.c44,a.c45=b.c45,a.c46=b.c46,a.c47=b.c47,a.c48=b.c48,
								a.c49=b.c49,a.c50=b.c50
							where a.dataId = b.id and a.dataId = salaryId  and a.changeSign = chanSign ;						
						
								-- --  人员津补贴-变动记录
								call upRyjbtBd(sTemPersonId,createrId,unitId,chanSign,chanType,resultMsg);
							
								-- 计算补扣发
								select id into changeId from data_record_t126 where  changeSign = chanSign;
								-- call fillCount(orgId,changeId,chanType ,chanSign,resultMsg);

							end if;	
					end if; -- 高定级别
			end if;
			
			 -- leave label_pro;
			end IF;
			
   end if;
			
	select count(1) into sTempNum from t124 where c03 = concat(sTemPersonId,'') and c01 >= jbsj and c01 < qxsj
	and EXISTS (select 1 from sys_s_data d where d.id = t124.c05); 
	if sTempNum >= 5 then  -- 起考时间开始考核5年以上
		select count(1) into sTempNum from t124 where c03 = concat(sTemPersonId,'') and c01 >= jbsj and c01 < qxsj
		and EXISTS (select 1 from sys_s_data d where d.id = t124.c05 and d.data_value < '3');
		if sTempNum < 5 then  -- 未达到5年以上称职
			SET @khfcz = CONCAT(@khfcz,stemPersonId,','); 
			set FailIndex = FailIndex+1;-- 晋级失败人数+1	
		end if;
	ELSE 
		
		select DATE_FORMAT(SYSDATE(),'%Y') into @NowY;
		set @sqlstr = concat('select count(1) into @sTempNum from data_record_t126 ',
			'where  dataId = ',sTemPersonId,
			' and changeType = ',chanType,' and  exists(select 1 from data_record_t125 where data_record_t126.changesign = data_record_t125.changesign ',
			' and data_record_t125.c02 like \'',SUBSTR(qxsj from 1 for 4),'%\')');
			-- 当年只能做一次事业正常晋升薪级
		PREPARE stmt FROM @sqlstr;
		EXECUTE stmt;
		set sTempNum = @sTempNum;
		if sTempNum > 0 then 
			--  当前变动时间所有年份已经存在此变动记录类型
			SET @bdcz = CONCAT(@bdcz,stemPersonId,',');
			set FailIndex = FailIndex+1;
		else
			set @sNum = qknx-jbsj;
			-- set resultMsg = concat('qknx:',qknx,',dcsj:',dcsj,',sNum:',@sNum);leave label_pro;
			if @sNum >= 5 then 
				SET @khsjbm = CONCAT(@khsjbm,stemPersonId,',');
				set FailIndex = FailIndex+1;
			else
				SET @qksjbz = CONCAT(@qksjbz,stemPersonId,',');
				set FailIndex = FailIndex+1;
			end if;
		end if;
	end if;


	set done = @doneF;

  END LOOP;
  -- 关闭游标
  CLOSE personId_;

-- 遍历试用期人员
set done = FALSE;
OPEN personId_2;
    loop1: LOOP
        FETCH personId_2 into sTemPersonId;

        IF done THEN
            LEAVE loop1;
        END IF;
			set @syq = concat(@syq,sTemPersonId,',');
			set FailIndex = FailIndex+1;-- 晋级失败人数+1	
    END LOOP;
close personId_2;


-- 遍历在职计发生活费人员
set done = FALSE;
OPEN personId_3;
    loop1: LOOP
        FETCH personId_3 into sTemPersonId;

        IF done THEN
            LEAVE loop1;
        END IF;
				set @jfshf = concat(@jfshf,sTemPersonId,',');
				set FailIndex = FailIndex+1;-- 晋级失败人数+1	
    END LOOP;
close personId_3;


-- 遍历所有在职停薪人员
set done = FALSE;
OPEN personId_4;
    loop1: LOOP
        FETCH personId_4 into sTemPersonId;

        IF done THEN
            LEAVE loop1;
        END IF;
				set @zztx = concat(@zztx,sTemPersonId,',');
				set FailIndex = FailIndex+1;-- 晋级失败人数+1	
    END LOOP;
close personId_4;


-- 遍历所有在职计发病假工资人员
 set done = FALSE;
 OPEN personId_5;
    loop1: LOOP
       FETCH personId_5 into sTemPersonId;

       IF done THEN
           LEAVE loop1;
        END IF;
			set @jfbj = concat(@jfbj,sTemPersonId,',');
			set FailIndex = FailIndex+1;-- 晋级失败人数+1	
   END LOOP;
close personId_5;


-- 遍历所有在职停薪人员
set done = FALSE;
OPEN personId_6;
    loop1: LOOP
        FETCH personId_6 into sTemPersonId;

        IF done THEN
            LEAVE loop1;
        END IF;
				set @jbgz0 = concat(@jbgz0,sTemPersonId,',');
				set FailIndex = FailIndex+1;-- 晋级失败人数+1	
    END LOOP;
close personId_6;


		if stemSucIndex > 0 then 
    		call p_fund_updateFlag(orgId,@re);-- 变动后更新基金isUPdateFund=1
			set resultMsg = concat('机关正常晋升级别工资成功:[',stemSucIndex,']人');
			set @resultM = replace(@resultM,'resultM:','');
			if stemFailIndex > 0 then 
				set resultMsg= concat(resultMsg,'（起薪时间不在',qxYearMonth,'的共[',stemFailIndex,']人，可能需要做一次性补扣发）;');
			end if ;
		 end if;
		if FailIndex > 0 then 
			set resultMsg = replace(resultMsg,'resultMsg','');
			set @failMsg = concat(@qksjbz,';',@khsjbm,';',@khfcz,';',@qxsjbd,';',@syq,';',@jfshf,';',@jfbj,';',@zztx,';',@bdcz,';',@zddc,';',@jbgz0,';');
			insert into temp_multi values(orgId,chanType,sysdate(),@failMsg);
			if stemSucIndex = 0 THEN
				-- set resultMsg= CONCAT(resultMsg,'成功:[0]人，','失败[',FailIndex,']人，是否下载失败记录?',@qksjbz,';',@khsjbm,';',@khfcz,';',@qxsjbd,';',@syq,';',@jfshf,';',@jfbj,';',@zztx,';',@bdcz,';',qxYearMonth,';',chanType,';','5');
				set resultMsg= CONCAT(resultMsg,'成功:[0]人，','失败[',FailIndex,']人，是否下载失败记录?',qxYearMonth,';',chanType,';','5');
			ELSE
				set resultMsg= CONCAT(resultMsg,'失败[',FailIndex,']人，是否下载失败记录?',qxYearMonth,';',chanType,';','5');	
				-- set resultMsg= CONCAT(resultMsg,'失败[',FailIndex,']人，是否下载失败记录?',@qksjbz,';',@khsjbm,';',@khfcz,';',@qxsjbd,';',@syq,';',@jfshf,';',@jfbj,';',@zztx,';',@bdcz,';',qxYearMonth,';',chanType,';','5');
			end if;
			set resultMsg = replace(resultMsg,'resultMsg','');
		end if;

		 if 	FailIndex = 0 || stemSucIndex= 0 then
				set resultMsg = replace(resultMsg,'resultMsg','该变动原因无晋升人员');
		 end if; 

		
  	leave label_pro;
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`upPercentJbt`(in personId varchar(100),
	INOUT jbtxj double,
-- 津补贴 小计
	in zwgz varchar(10),
-- 职务工资
	in jbgz int(11),
-- 级别工资
	inout resultMsg varchar(1000))
label_pro:BEGIN
	DECLARE jbtId int(11);
	DECLARE zxgs varchar(100);-- t117执行公式
	DECLARE zxje varchar(20);-- t117执行金额
	declare stemIndex int(11);

  DECLARE done INT DEFAULT FALSE;
	DECLARE zxgsje double DEFAULT 0;
	-- t117 执行公式*t117执行金额
	DECLARE jbtId_ CURSOR FOR select distinct t117.id  from t117 join t115 on t117.c04 = t115.c03 
	where t117.c03 = concat(personId,'') and ifnull(t117.c07+0,'')>0  
	and exists(select 1 from sys_s_data d where t115.c06 = concat(d.id,'') -- 是否为公式 是
	and d.data_value = '1' and t115.c07+0>0)
	;
	set stemIndex = 0;
	-- 打开游标
	OPEN jbtId_;
	-- 开始循环
	read_loop1:LOOP
	-- 提取游标里的数据
	FETCH jbtId_ INTO jbtId;
	-- 声明结束的时候
	IF done THEN
		LEAVE read_loop1;
	END IF;
		select -- replace(c11,'%','') ,
		t115.c07, t117.c07 into zxgs,zxje from t117 join t115 on t117.c04 = t115.c03
		-- t115.c07-单位津补贴表 默认金额/执行公式比例  t117.c07-人员津补贴表-执行金额
		 where t117.id = jbtId limit 1;
		if zxgs and zxje>0 then
			update t117 set c11=concat(zxgs,'%'),
			c07 = floor((ifnull(zwgz,0) +ifnull(jbgz,0))*zxgs*0.01+0.5)  where id = jbtId ; 
			-- 按比例计算取整 
			set stemIndex = stemIndex + 1;
		end if;
	END LOOP;
	CLOSE jbtId_;
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`upRyjbtBd`(in personId int(11),IN createrId int(11),IN unitId int(11),IN chanSign varchar(200),IN chanType varchar(200),INOUT resultMsg varchar(100) CHARSET utf8)
label_pro:BEGIN	
	-- personId 人员id
	-- chanType 批量变动变动类型id  sys_s_data data_value = 14 事业人员正常晋升薪级工资
	-- chanSign 变动标志
	-- createrId 操作人
	-- unitId 应用功能id
	-- --  人员津补贴-变动记录


	DECLARE sTemId int(11);-- 人员id-变量
	DECLARE sTempNum int(11);-- 参数
	DECLARE sTempParam int(11);--

    DECLARE done INT DEFAULT FALSE;
    
	DECLARE jbtId_ CURSOR FOR
		SELECT id from t117 where c03 = concat(personId,'') ; -- t117-基层单位职员津补贴表 c03-人员编号
DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
 
	-- 打开游标
  OPEN jbtId_;  
  -- 开始循环
  read_loop: LOOP
    -- 提取游标里的数据，这里只有一个，多个的话也一样；
    FETCH jbtId_ INTO sTemId;
    -- 声明结束的时候
    IF done THEN
      LEAVE read_loop;
    END IF;

			-- 人员津补贴-变动记录
			INSERT data_record_t117 (dataId,dataclassCode,createrId,createDate,updaterId,updateDate,unitId,
 				operateTime,operateId,operateType,changeSign,changeType)
			values (sTemId,'t117',createrId,SYSDATE(),createrId,SYSDATE(),unitId,SYSDATE(),createrId,1,chanSign,chanType);-- 先插入一条操作记录 基本信息的
			update data_record_t117 a , t117 b set a.c01 = b.c01 ,a.c02 = b.c02,a.c03=b.c03,a.c04=b.c04,a.c05=b.c05,a.c06=b.c06,a.c07=b.c07,a.c08=b.c08,a.c09=b.c09,
				a.c10=b.c10,a.c11=b.c11,a.c12=b.c12,a.c13=b.c13,a.c14=b.c14,a.c15=b.c15,a.c16=b.c16,a.c17=b.c17,a.c18=b.c18,a.c19=b.c19,a.c20=b.c20,a.c21=b.c21,a.c22=b.c22,
				a.c23=b.c23,a.c24=b.c24,a.c25=b.c25,b.c26=b.c26,a.c27=b.c27,a.c28=b.c28,a.c29=b.c29,a.c30=b.c30,a.c31=b.c31,a.c32=b.c32,a.c33=b.c33,a.c34=b.c34,a.c35=b.c35,
				a.c36=b.c36,a.c37=b.c37,a.c38=b.c38,a.c39=b.c39,a.c40=b.c40,a.c41=b.c41,a.c42=b.c42,a.c43=b.c43,a.c44=b.c44,a.c45=b.c45,a.c46=b.c46,a.c47=b.c47,a.c48=b.c48,
				a.c49=b.c49,a.c50=b.c50
			where a.dataId = b.id and a.dataId = sTemId and  a.changeSign = chanSign ;	
						
  END LOOP;
  -- 关闭游标
  CLOSE jbtId_;			
			
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`upSyXj`(IN createrId int(11),IN unitId int(11),IN orgId varchar(200),IN chanType varchar(200),
IN qxsj varchar(10) ,IN bdsj varchar(20),IN qknx varchar(4),in yjwh varchar(100),INOUT resultMsg varchar(20000) CHARSET utf8)
label_pro:BEGIN	
	-- orgId 单位id
	-- chanType 批量变动变动类型id  sys_s_data data_value = 14 事业人员正常晋升薪级工资
	-- bdsj 变动时间 20160701
	-- qxsj 起薪时间 20160101
	-- DECLARE orgId varchar(100);-- 单位id
	DECLARE changeId int(11);-- -- changeId 变动记录id 主要是t126的变动记录id,此id来查询所有关联的工资t125,津贴t117 变动记录
	DECLARE personId varchar(100);-- 人员id
	DECLARE personNo varchar(100);-- 人员编号
	DECLARE salaryId varchar(100);-- 工资信息的Id
	DECLARE salaryRecordId varchar(100);-- 工资信息的recordId
	DECLARE changeTypeCode varchar(100);-- 变动类型code

	DECLARE rysf varchar(10);-- 人员身份 管理人员 工人 专业技术人员	
	DECLARE rygzzd varchar(20);-- 人员工资制度- 事业岗位绩效工资制
	DECLARE zxgzbz varchar(20);-- 执行工资标准- 事业单位管理人员工资标准,工人工资标准,专业技术人员工资标准
	
	DECLARE zwgz double DEFAULT 0;-- 职务工资


	DECLARE jb varchar(10);-- 级别
	DECLARE jbsj varchar(10);-- 级别-起考时间
	DECLARE dc varchar(10);-- 档次-薪级	
	DECLARE dcgz varchar(10);-- 级别工资-档次-薪级工资
	DECLARE dcsj varchar(50);-- 档次-薪级	
	DECLARE newDc varchar(50);-- 新薪级	
	DECLARE newDcsj varchar(10);-- 新起考时间
	DECLARE newJe double DEFAULT 0;-- 新金额
	DECLARE newDcId varchar(10);-- 新薪级Id
	
	DECLARE oldQysj varchar(50);-- 标准启用时间
	DECLARE oldBzlb varchar(50);-- 标准类别
	DECLARE oldBzmc varchar(50);-- 标准名称
	DECLARE oldJbmc varchar(50);-- 级别名称-档次/薪级
	DECLARE oldCjbmc varchar(50);-- 次级别名称-级别
	DECLARE oldJe double DEFAULT 0;-- 金额
	DECLARE oldZxgzbz varchar(50);-- 执行工资标准

	DECLARE subJe double DEFAULT 0;-- 档差(薪级差)金额
	DECLARE jhtg double DEFAULT 0;-- 教师护士提高10%
	DECLARE tjtg double DEFAULT 0;-- 特殊教育揭提高15%

	DECLARE qxYearMonth varchar(100);-- 起薪时间-截取 年月 2016-01
	
	DECLARE sTemPersonId int(11);-- 人员id-变量
	DECLARE sTempNum int(11);-- 参数
	DECLARE sTempParam int(11);--

	DECLARE chanSign varchar(100);-- 变动标志	

	DECLARE qxMonth varchar(10);-- 系统设置批量变动 统一起薪月份 :01表示 当年1月  11表示当年11月

	DECLARE stemSucIndex int(11) default 0;-- 批量晋升工资成功条数
	DECLARE stemFailIndex int(11) default 0;-- 批量晋升工资失败条数(需要手工补扣发人数)
	DECLARE personNum int(11);	-- 所有机关公务员在职公务员数量-排开试用期人员 
	DECLARE	FailIndex int(11) default 0; -- 晋级失败人数
	DECLARE zxgsje double DEFAULT 0;-- t117 执行公式*t117执行金额
	DECLARE c_id int(11);-- 创建人id
	DECLARE u_id int(11);-- 功能id
	DECLARE temp varchar(100); -- 最近一次变动记录的起薪时间
	DECLARE done INT DEFAULT FALSE;
	-- -- 所有事业在职人员
	-- DECLARE personId_ CURSOR FOR
  --  SELECT id from t126 ,sys_s_data d where d.id = t126.c36 and t126.c01 = orgId and d.data_value = 204 -- t126.c36 人员工资制度为 204 -事业岗位绩效工资制
	--  and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1');-- t126.c03 人员状态-码表 1-在职	
	
	-- --  所有事业在职人员-排开试用期人员
	DECLARE personId_ CURSOR FOR
   SELECT t126.id from t126 ,t125,sys_s_data d -- t125.c06 关联 人员基本信息表 t126 
		where t125.c06 = concat(t126.id ,'') and t125.c36 =concat(d.id,'')  
		and t126.c01 = concat(orgId,'') and d.data_value = '204' -- t125.c36 人员工资制度为 204 -事业岗位绩效工资制
		and EXISTS (select 1 from t127 where t127.id = t126.c17 and t127.c05 not like '%期%') -- t126.c39 执行工资标准 关联 单位工资制度与人员属性信息对应关系t136.c04 执行工资标准
	   and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
		and (ifnull(t126.c43,'') !=10487 and ifnull(t125.c26,'')!=0)   -- 排除已经停薪的人员  10487是否状态-是   级别工资是0 的不参与晋升
	and ifnull(t125.c39,'') !=10487 -- 排除计发生活费的人员
	and ifnull(t125.c40,'') !=10487 -- 排除计发病假工资的人员
	;
	
	-- 所有在职试用期公务员 
	DECLARE personId_2 CURSOR FOR
   SELECT t126.id from t126 ,t125,sys_s_data d 
		where t125.c06 = concat(t126.id ,'') and t125.c36 =concat(d.id,'')  
		and t126.c01 = concat(orgId,'') and d.data_value = '204' -- t125.c36 人员工资制度为 204 -事业岗位绩效工资制
		and EXISTS (select 1 from t127 where t127.id = t126.c17 and t127.c05 like '%期%') -- t126.c39 执行工资标准 关联 单位工资制度与人员属性信息对应关系t136.c04 执行工资标准
	  and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
	and ifnull(t126.c43,'') !=10487 -- 排除已经停薪的人员  10487是否状态-是
	and ifnull(t125.c39,'') !=10487 -- 排除计发生活费的人员
	and ifnull(t125.c40,'') !=10487 -- 排除计发病假工资的人员
	;
	-- 所有在职计发生活费人员
	DECLARE personId_3 CURSOR FOR
   SELECT t126.id from t126 ,t125,sys_s_data d 
		where t125.c06 = concat(t126.id ,'') and t125.c36 =concat(d.id,'')  
		and t126.c01 = concat(orgId,'') and d.data_value = '204' -- t125.c36 人员工资制度为 204 -事业岗位绩效工资制
		and EXISTS (select 1 from t127 where t127.id = t126.c17 and t127.c05 not like '%期%') -- t126.c39 执行工资标准 关联 单位工资制度与人员属性信息对应关系t136.c04 执行工资标准
	  and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
	and ifnull(t126.c43,'') !=10487 -- 排除已经停薪的人员  10487是否状态-是
	and ifnull(t125.c39,'') =10487 -- 计发生活费的人员
	and ifnull(t125.c40,'') !=10487 -- 排除计发病假工资的人员
	;

	-- -- 所有在职停薪人员
	DECLARE personId_4 CURSOR FOR
   SELECT t126.id from t126 ,t125,sys_s_data d 
		where t125.c06 = concat(t126.id ,'') and t125.c36 =concat(d.id,'')  
		and t126.c01 = concat(orgId,'') and d.data_value = '204' -- t125.c36 人员工资制度为 204 -事业岗位绩效工资制
		and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
	and ifnull(t126.c43,'') =10487 -- 排除已经停薪的人员  10487是否状态-是    工资合计为0 及视为停发工资
	and ifnull(t125.c39,'') !=10487 -- 排除计发生活费的人员
	and ifnull(t126.c40,'') !=10831 -- 排除减少人员
	;

		-- 所有在职计发病假工资人员
	DECLARE personId_5 CURSOR FOR
   SELECT t126.id from t126 ,t125,sys_s_data d 
		where t125.c06 = concat(t126.id ,'') and t125.c36 =concat(d.id,'')  
		and t126.c01 = concat(orgId,'') and d.data_value = '204' -- t125.c36 人员工资制度为 204 -事业岗位绩效工资制
		and EXISTS (select 1 from t127 where t127.id = t126.c17 and t127.c05 not like '%期%') -- t126.c39 执行工资标准 关联 单位工资制度与人员属性信息对应关系t136.c04 执行工资标准
	  and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
	and ifnull(t126.c43,'') !=10487 -- 排除已经停薪的人员  10487是否状态-是
	and ifnull(t125.c40,'') =10487 -- 排除计发病假工资的人员
	;
		
		-- -- 所有级别工资为0人员
	DECLARE personId_6 CURSOR FOR
   SELECT t126.id from t126 ,t125,sys_s_data d 
		where t125.c06 = concat(t126.id ,'') and d.id = t125.c36 
		and t126.c01 = concat(orgId,'') and d.data_value in( 201,206) -- t125.c36 人员工资制度为 201 -公务员职级工资 206-警察职级工资制度
		and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
	and  ifnull(t125.c32,0) = 0  --    工资合计为0 及视为停发工资
	and ifnull(t126.c43,'') !=10487   -- 排除已经停薪的人员  10487是否状态-是    
	and ifnull(t125.c39,'') !=10487 -- 排除计发生活费的人员
	and ifnull(t126.c40,'') !=10831 -- 排除减少人员
	;
	
	
	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
	select DATE_FORMAT(concat(qxsj,'0101'),'%Y%m'),qxsj into qxYearMonth,newDcsj;-- 起薪年月 201607,新的 薪级起考时间 为 选择的起考时间
	
	
	select content into qxMonth from sys_s_config where enname = 'qxMonth' ;
	
	set c_id = createrId;
	set u_id = unitId;
	if length(qxsj)=4 then
		select DATE_FORMAT(concat(qxsj,'-',qxMonth,'-01'),'%Y-%m') into qxYearMonth;-- 起薪年月 2016-01
	else
		select DATE_FORMAT(qxsj,'%Y-%m') into qxYearMonth;-- 起薪年月 2016-01
 	end if;
	set @resultM = 'resultM:';
	set resultMsg = 'resultMsg';
	
	set @resultM = 'resultM:';
	set @khsjbm = 'khsjbm:';-- 考核没考1年称职的
	set @qksjbz = 'qksjbz:';-- 人员上一次变动起考时间与起薪年月-年相差不足1年
	set @khfcz = 'khfcz:';-- 考核不是称职的 用来包装考核X年，但没有达到X年称职
	set @qxsjbd = 'qxsjbd:';-- 人员起薪时间 小于等于最近一次变动记录的起薪时间
	set @syq = 'syq:';-- 试用期人员
	set @jfshf = 'jfshf:';-- 在职计发生活费人员
	set @jfbj = 'jfbj:';-- 在职计发病假工资人员
	set @zztx = 'zztx:';-- 所有在职停薪人员
	set @jbgz0 = 'jbgz0:';-- 所有级别工资为0人员
	set @bdcz = 'bdcz:';-- 当前变动类型当年已经存在
	set resultMsg = 'resultMsg';
	
	-- 打开游标
  OPEN personId_;  
  -- 开始循环
  read_loop: LOOP
    -- 提取游标里的数据，这里只有一个，多个的话也一样；
    FETCH personId_ INTO sTemPersonId;
		
    -- 声明结束的时候
    IF done THEN
      LEAVE read_loop;
    END IF;
	set @doneF = done;
	
    select count(1) into sTempNum from data_record_t126 t126 ,data_record_t125 t125 
    where   t125.c06 = concat(t126.dataId ,'') and t126.changeSign = t125.changeSign 
    and t126.dataId = sTemPersonId and t126.changeType = chanType 
		and t126.allAuditFlag = '2'
    and replace(t125.c02,'-','') >= qxYearMonth;
		
   if sTempNum = 0 then -- 起薪时间之后已经存在通过的此变动记录
	
		select c04 into @personName from t126 where id = stemPersonId; -- 人员姓名
/*
		-- 人员在当前单位第一次起薪时间
		select t125.c02 into @firstQxsj from data_record_t126 t126,data_record_t125 t125 
			where  t126.changesign = t125.changesign and  t126.dataId = stemPersonId and  t125.c06 = concat(t126.dataId ,'')
			and t126.c01 = orgId and t126.changetype in(10750,10832) order by t126.id desc  limit 0,1;

		
		-- 重新确定工资
		select count(1) into @cxqdNum from data_record_t126 t126 ,data_record_t125 t125
    	where  t126.changesign = t125.changesign and  t126.dataId = stemPersonId and  t125.c06 = concat(t126.dataId ,'')
    	 and t126.changeType in(select id from sys_s_data d where d.typename = 'bdlx' and data_value = '05')
    	 and t126.c01 = orgId 
    	 order by t125.id desc 
    	 limit 0,1;-- 重新确定工资
		if @cxqdNum > 0 then 
	    	select t125.c02 into @firstQxsj from data_record_t126 t126 ,data_record_t125 t125
	    	where  t126.changesign = t125.changesign and  t126.dataId = stemPersonId and t125.c06 = concat(t126.dataId ,'')
	    	 and t126.changeType in(select id from sys_s_data d where d.typename = 'bdlx' and data_value = '05')
	    	 and t126.c01 = orgId 
	    	 order by t125.id desc 
	    	 limit 0,1;-- 重新确定工资
		end if;*/
		-- 人员在本单位最后一次起薪（录入或调入）时间、重新确定工资起薪时间、工资制度变化起薪时间 取最大的一个起薪时间
		call p_person_getQxsj(sTemPersonId,@firstQxsj);-- 根据人员当前单位及身份等获取最早起薪时间
		
		select PERIOD_DIFF(replace(@firstQxsj,'-',''),replace(qxYearMonth,'-','')) into @stemNum; -- 判断 起薪时间201601与当前人员在该单位首次起薪时间201602 
	-- 	set resultMsg = concat('qxYearMonth:',qxYearMonth,',@firstQxsj:',@firstQxsj,',@stemNum:',@stemNum);leave label_pro;
		
		if @stemNum > 0 then -- 设置人员起薪时间  如果在单位首次起薪为201602,则设置为2016-02 如果一直在 则为为 2016-01 
			set @qxYearMonth = @firstQxsj;
		else 
			set @qxYearMonth = qxYearMonth;
		end if;
    	-- 循环查询人员工资信息
		-- t125 人员工资信息表 c07-工资级别-关联工资标准表t127.c05次级别名称,c08-级别起考时间,c09-工资档次-关联工资标准表-c04级别名称,c10-档次起考时间,c25-职务工资,c26-级别工资,
		-- c28-教师护士提高10%,c29-特殊教育提高15%,c36-人员工资制度-字符型
		-- t126 人员基本信息表 c28-人员身份-关联 单位工资制度与人员属性信息对应关系.人员身份 t126.c39-执行工资标准-关联 单位工资制度与人员属性信息对应关系.执行工资标准	 t125.c27-津补贴小计
		select t125.id,t125.c07,t125.c08,t125.c09,t125.c10,round(t125.c25,2),round(t125.c26,2),round(ifnull(t125.c28,0),2),round(t125.c29,2),t125.c36,t126.c28,t126.c39,round(t125.c27,2)
		 into salaryId,jb,jbsj,dc,dcsj,zwgz,dcgz,jhtg,tjtg,rygzzd,rysf,zxgzbz,zxgsje
		from t126,t125 where  t125.c06 = concat(t126.id,'') and t126.id = sTemPersonId ; -- t125 人员工资表 c06-人员编号 关联型

		set dcsj = SUBSTR(dcsj FROM 1 FOR 4);-- 2016-07-01 to 2016
		
		-- t124 人员年度考核情况表 c03人员编号  关联型 c01-考核年度 c05-考核结果 码表, 1-优秀 2-称职 3-基本称职 4-不称职 5-不参与考核
			 -- 起考年度-2012与起薪时间-2017-01-01之间 考核年度[2012,2013,2014,2015,2016]事业连续1年以上考核 称职以上 升一档 

		select count(1) into sTempNum from t124 where c03 = concat(sTemPersonId,'') and c01 >= dcsj and c01 < qxsj
			and EXISTS (select 1 from sys_s_data d where d.id = t124.c05 and d.data_value < '3');
		if sTempNum >= 1 then -- 满足起考年度开始连续1年称职以上 升级
				
				-- 对起薪时间与最近一次未通过审核的变动记录的起薪时间进行比较,如果起薪时间在这变动记录之前,不能晋升
			 select UNIX_TIMESTAMP() into sTempParam;
			 set chanSign = concat('batch',sTempParam,chanType,'t126',sTemPersonId);
			 -- set chanSign = concat('\'',chanSign,'\'');
			set temp = '';
			if(	EXISTS(select 1 from data_record_t125 a -- 人员在目前单位的变动记录ID并且ID大于人员在当前单位最新的一次录入或者接收人员变动
					where  a.dataId = salaryId   and a.allAuditFlag<>2 and a.perAuditFlag<>2 and a.id >= (select id from data_record_t125 where changeSign =
 (select changeSign from data_record_t126 where dataId = sTemPersonId AND c01 = (select c01 from t126 where id = sTemPersonId) and  (c40 = '10750' or c40 = '10832') order by id desc LIMIT 1))
					order by a.updateDate desc LIMIT 0,1)) THEN  -- 判断是否存在结果 存在则赋值
						select a.c02 into temp from data_record_t125 a  
						where  a.dataId = salaryId   and a.allAuditFlag<>2 and a.perAuditFlag<>2
						order by a.updateDate desc LIMIT 0,1;
			end if;
			IF  @qxYearMonth < temp THEN -- 人员起薪时间 小于等于最近一次变动记录的起薪时间
					SET @qxsjbd = CONCAT(@qxsjbd,stemPersonId,'-',@qxYearMonth,','); 
					set FailIndex = FailIndex+1;-- 晋级失败人数+1	
			else 
				/**select t125.c02 into @firstQxsj from data_data_record t126,data_data_record t125 
				where t126.dataclassCode = 't126' and t125.dataclassCode = 't125' 
				and t126.dataId = stemPersonId and t125.c06 = t126.dataId limit 0,1;
				*/
				
				
				-- set @stemQxsj = @qxYearMonth;
			-- set resultMsg = concat('firstQxsj > stemQxsj:',firstQxsj > stemQxsj);leave label_pro;
				if  @qxYearMonth !=  qxYearMonth then -- 起薪时间 与 系统设置的起薪时间不一致
				
					set @resultM = concat(@resultM,'[',@personName,':变动起薪时间',@qxYearMonth,']');
					set stemFailIndex = stemFailIndex + 1;-- 需要手工补扣发的人数+1
					-- set resultMsg = stemFailIndex;leave label_pro;
				end if;
				
			-- t127 工资标准表  c01-启用时间 c02-标准类别 c03-标准名称 c04-次级别名称(工资档次等) c05-次级别名称(工资级别等) c06-金额 c08-执行工资标准 c09-工资标准备注
			select c01,c02,c03,c04,c04,c05,c06,c08 
			into oldQysj,oldBzlb,oldBzmc,dc,oldJbmc,oldCjbmc,oldJe,oldZxgzbz 
			from t127 where  id = (select id from t127 where c04 = (select c04 from t127 where id = dc ) and c08 = zxgzbz order by c01 desc limit 1);
			select c01 into oldQysj from t127 where c08 = oldZxgzbz ORDER BY c01 desc limit 0,1; -- 赋值最新的工资标准时间
			
			-- select c04 into zxgzbz from t136 where id = zxgzbz; -- 单位工资制度与人员属性信息对应关系t136.c04 执行工资标准
			-- select c02 into rysf from t136 where id = rysf; -- 单位工资制度与人员属性信息对应关系t136.c02 人员身份
			-- 2017-1-6 执行工资标准-t126.c39改成 工资标准类别  码表
			-- 人员身份-t126.c28改成码表  不用重新查询更新
			select SUBSTR(dc FROM 1 FOR POSITION('级' IN dc)-1) into dc;
			set newDc = dc+1;
			set newDc = CONCAT(newDc,'级');
			select count(1) into sTempParam from t127 a where a.c04 = newDc 
			and c01 = oldQysj and c03 = oldBzmc and c08 = oldZxgzbz;-- 查询新的薪级工资是否存在
			if sTempParam = 0 THEN 
				set dc = dc -1 ;-- 此薪级上一个薪级
				if dc <= 0 THEN
					set dc = dc + 1;
				end if;
				select count(1) into @sTempCountParam from t127 a where  c04 = CONCAT(dc,'级') and c01 = oldQysj and c03 = oldBzmc and c08 = oldZxgzbz ;-- 上一个薪级的金额
				if @sTempCountParam > 0 then 
					select c06 into sTempParam from t127 a where  c04 = CONCAT(dc,'级') and c01 = oldQysj and c03 = oldBzmc and c08 = oldZxgzbz  order by c01 desc limit 0,1;-- 上一个薪级的金额
					set subJe = oldJe - sTempParam + 0;
					set newJe = oldJe + subJe + 0; -- 原来薪级的工资+档差工资
					insert into t127(dataclassCode,c01,c03,c04,c06,c08,createrId,createDate,updaterId,updateDate)
					values ('t127',oldQysj,oldBzmc,newDc,newJe,oldZxgzbz,1,SYSDATE(),1,SYSDATE());
				end if;
			end if;			

			select id,c06 into newDcId,newJe from t127 a where a.c04 = newDc and c01 = oldQysj and c03 = oldBzmc and c08 = oldZxgzbz order by c01 desc limit 0,1;-- 查询新的薪级工资
			select count(1) into sTempNum from data_record_t126 where  dataId = sTemPersonId and changeType = chanType and ifnull(allAuditFlag,'') != '2';
			if sTempNum = 0 then 
				select DATE_FORMAT(SYSDATE(),'%Y') into @NowY;
				set @sqlstr = concat('select count(1) into @sTempNum from data_record_t126 ',
					'where  dataId = ',sTemPersonId,
					' and changeType = ',chanType,' and  exists(select 1 from data_record_t125 where data_record_t126.changesign = data_record_t125.changesign ',
					' and data_record_t125.c02 like \'',SUBSTR(qxsj from 1 for 4),'%\')');
					-- 当年只能做一次事业正常晋升薪级
				PREPARE stmt FROM @sqlstr;
				EXECUTE stmt;
				set sTempNum = @sTempNum;
			end if;
			if sTempNum > 0 then 
				--  当前变动时间所有年份已经存在此变动记录类型
				SET @bdcz = CONCAT(@bdcz,stemPersonId,',');
				-- set @bdcz = replace(@bdcz,'bdcz:',''); -- 用来包装没有起考时间开始考核2年以上
				set FailIndex = FailIndex+1;
			end if;
			if sTempNum = 0 then 
				--  如果不存在此变动记录,存在先不管

				-- set resultMsg = concat('newDc:',newDc,'oldQysj:',oldQysj);leave label_pro;
				set stemSucIndex = stemSucIndex + 1; -- 晋升成功人数+1
				update t126 set c41=DATE_FORMAT(SYSDATE(),'%Y-%m-%d'),c40=chanType  where id = sTemPersonId;-- 更新人员基本信息表-变动类型,变动时间
				if ''!=jhtg and jhtg > 0 THEN -- 教师护士提高10%
					set jhtg = round(CAST((zwgz + newJe)*0.1 AS DECIMAL));
				else
					set jhtg = 0;
				end if;
				if tjtg > 0 then -- 特殊教育揭提高15%
					set tjtg = round(CAST((zwgz + newJe + jhtg)*0.15 AS DECIMAL));
				end if;
				
				-- 调用upPercentJbt，更新t117津补贴金额，返回zxgzje,修改t125.c27 津补贴小计
				CALL upPercentJbt(sTemPersonId,zxgsje,zwgz,newJe,resultMsg);
				select cast(sum(ifnull(c07+0,0))  as decimal(20,2)) into zxgsje from t117 where c03 = concat(sTemPersonId,'');
				update t125 set c27= cast(zxgsje  as decimal(20,2)) where id = salaryId;
					
				-- set gzhj = zwgz + newJe + jhtg + tjtg, ; 工资合计=职务工资+新的级别/档次工资+提高+保留
				-- 更新人员工资表t125 薪级-c09 薪级起考年度-c10 薪级工资-c26 
				-- c28-教师护士提高10% c29-特殊教育提高15%
				-- 工资合计c32: 原来的职务工资+新的薪级工资+教师护士提高+特殊教育提高+c30保留特岗工资+c31基础绩效+c27津补贴合计+c44中小学老师保留10%+c45保留护士提高10%
				
				update t125 set  c02=@qxYearMonth,c09 = newDcId ,c10=qknx,c26 = newJe,
				c28 = ifnull(jhtg,0),c29=ifnull(tjtg,0),
				c32 = round((zwgz + newJe + ifnull(jhtg,0) + ifnull(tjtg,0) + ifnull(c30,0) + ifnull(c31,0)+ifnull(c27,0)+ifnull(c44,0)+ifnull(c45,0) +0),2)  
				,c34 ='',c04=yjwh,c48=''
				-- 工资变动 备注 依据文号 工资报审附件
				where id = salaryId ;
		
				-- 人员基本信息-变动记录
				INSERT data_record_t126 (dataId,dataclassCode,createrId,createDate,updaterId,updateDate,unitId,
					operateTime,operateId,operateType,changeSign,changeType,c01,c02,c03,c04,c28)-- c01,c02,c03,c04,c28必填 
				select 
				id,'t126',c_id,SYSDATE(),c_id,SYSDATE(),u_id,SYSDATE(),c_id,1,chanSign,chanType,orgId,c02,c03,c04,c28
				from t126 where id = sTemPersonId;
				-- values (sTemPersonId,'t126',createrId,SYSDATE(),createrId,SYSDATE(),unitId,SYSDATE(),createrId,1,chanSign,chanType,orgId);
				update data_record_t126 a , t126 b set a.c01 = b.c01 ,a.c02 = b.c02,a.c03=b.c03,a.c04=b.c04,a.c05=b.c05,a.c06=b.c06,a.c07=b.c07,a.c08=b.c08,a.c09=b.c09,
					a.c10=b.c10,a.c11=b.c11,a.c12=b.c12,a.c13=b.c13,a.c14=b.c14,a.c15=b.c15,a.c16=b.c16,a.c17=b.c17,a.c18=b.c18,a.c19=b.c19,a.c20=b.c20,a.c21=b.c21,a.c22=b.c22,
					a.c23=b.c23,a.c24=b.c24,a.c25=b.c25,a.c26=b.c26,a.c27=b.c27,a.c28=b.c28,a.c29=b.c29,a.c30=b.c30,a.c31=b.c31,a.c32=b.c32,a.c33=b.c33,a.c34=b.c34,a.c35=b.c35,
					a.c36=b.c36,a.c37=b.c37,a.c38=b.c38,a.c39=b.c39,a.c40=b.c40,a.c41=b.c41,a.c42=b.c42,a.c43=b.c43,a.c44=b.c44,a.c45=b.c45,a.c46=b.c46,a.c47=b.c47,a.c48=b.c48,
					a.c49=b.c49,a.c50=b.c50
				where a.dataId = b.id and a.dataId = sTemPersonId  and a.changeSign = chanSign ;
	
	
				-- 人员工资信息-变动记录
				INSERT data_record_t125 (dataId,dataclassCode,createrId,createDate,updaterId,updateDate,unitId,
	 				operateTime,operateId,operateType,changeSign,changeType)
				values (salaryId,'t125',createrId,SYSDATE(),createrId,SYSDATE(),unitId,SYSDATE(),createrId,1,chanSign,chanType);-- 插入 人员工资信息 变动记录
				update data_record_t125 a , t125 b set a.c01 = b.c01 ,a.c02 = b.c02,a.c03=b.c03,a.c04=b.c04,a.c05=b.c05,a.c06=b.c06,a.c07=b.c07,a.c08=b.c08,a.c09=b.c09,
					a.c10=b.c10,a.c11=b.c11,a.c12=b.c12,a.c13=b.c13,a.c14=b.c14,a.c15=b.c15,a.c16=b.c16,a.c17=b.c17,a.c18=b.c18,a.c19=b.c19,a.c20=b.c20,a.c21=b.c21,a.c22=b.c22,
					a.c23=b.c23,a.c24=b.c24,a.c25=b.c25,a.c26=b.c26,a.c27=b.c27,a.c28=b.c28,a.c29=b.c29,a.c30=b.c30,a.c31=b.c31,a.c32=b.c32,a.c33=b.c33,a.c34=b.c34,a.c35=b.c35,
					a.c36=b.c36,a.c37=b.c37,a.c38=b.c38,a.c39=b.c39,a.c40=b.c40,a.c41=b.c41,a.c42=b.c42,a.c43=b.c43,a.c44=b.c44,a.c45=b.c45,a.c46=b.c46,a.c47=b.c47,a.c48=b.c48,
					a.c49=b.c49,a.c50=b.c50
				where a.dataId = b.id and a.dataId = salaryId  and a.changeSign = chanSign ;						
			
				-- --  人员津补贴-变动记录
				call upRyjbtBd(sTemPersonId,createrId,unitId,chanSign,chanType,resultMsg);
			
				-- 计算补扣发
				select id into changeId from data_record_t126 where  changeSign = chanSign;
				-- call fillCount(orgId,changeId,chanType ,chanSign,resultMsg);
			end if;
		end if;	
   end if;
	end if;

		
	select count(1) into sTempNum from t124 where c03 = concat(sTemPersonId,'') and c01 >= dcsj and c01 < qxsj
	and EXISTS (select 1 from sys_s_data d where d.id = t124.c05); 

	if sTempNum >= 1 then  -- 起考时间开始考核1年以上
		select count(1) into sTempNum from t124 where c03 = concat(sTemPersonId,'') and c01 >= dcsj and c01 < qxsj
		and EXISTS (select 1 from sys_s_data d where d.id = t124.c05 and d.data_value < '3');
		if sTempNum < 1 then  -- 未达到1年以上称职
			SET @khfcz = CONCAT(@khfcz,stemPersonId,','); 
			set FailIndex = FailIndex+1;-- 晋级失败人数+1	
		end if;
	ELSE 
		select DATE_FORMAT(SYSDATE(),'%Y') into @NowY;
		set @sqlstr = concat('select count(1) into @sTempNum from data_record_t126 ',
			'where  dataId = ',sTemPersonId,
			' and changeType = ',chanType,' and  exists(select 1 from data_record_t125 where data_record_t126.changesign = data_record_t125.changesign ',
			' and data_record_t125.c02 like \'',SUBSTR(qxsj from 1 for 4),'%\')');
			-- 当年只能做一次事业正常晋升薪级
		PREPARE stmt FROM @sqlstr;
		EXECUTE stmt;
		set sTempNum = @sTempNum;
		if sTempNum > 0 then 
			--  当前变动时间所有年份已经存在此变动记录类型
			SET @bdcz = CONCAT(@bdcz,stemPersonId,',');
			set FailIndex = FailIndex+1;
		else
			set @sNum = qknx-dcsj;
			if @sNum >= 1 then 
				SET @khsjbm = CONCAT(@khsjbm,stemPersonId,',');
				set FailIndex = FailIndex+1;
			else
				SET @qksjbz = CONCAT(@qksjbz,stemPersonId,',');
				set FailIndex = FailIndex+1;
			end if;
		end if;
	end if;
	
	set done = @doneF;
  END LOOP;
  -- 关闭游标
    CLOSE personId_;		

-- 遍历试用期人员
set done = FALSE;
OPEN personId_2;
    loop1: LOOP
        FETCH personId_2 into sTemPersonId;
        IF done THEN
            LEAVE loop1;
        END IF;
			set @syq = concat(@syq,sTemPersonId,',');
			set FailIndex = FailIndex+1;-- 晋级失败人数+1	
    END LOOP;
close personId_2;


-- 遍历在职计发生活费人员
set done = FALSE;
OPEN personId_3;
    loop1: LOOP
        FETCH personId_3 into sTemPersonId;

        IF done THEN
            LEAVE loop1;
        END IF;
				set @jfshf = concat(@jfshf,sTemPersonId,',');
				set FailIndex = FailIndex+1;-- 晋级失败人数+1	
    END LOOP;
close personId_3;


-- 遍历所有在职停薪人员
set done = FALSE;
OPEN personId_4;
    loop1: LOOP
        FETCH personId_4 into sTemPersonId;

        IF done THEN
            LEAVE loop1;
        END IF;
				set @zztx = concat(@zztx,sTemPersonId,',');
				set FailIndex = FailIndex+1;-- 晋级失败人数+1	
    END LOOP;
close personId_4;
		-- 遍历所有在职计发病假工资人员
set done = FALSE;
OPEN personId_5;
    loop1: LOOP
      FETCH personId_5 into sTemPersonId;
       IF done THEN
           LEAVE loop1;
      END IF;
			set @jfbj = concat(@jfbj,sTemPersonId,',');
				set FailIndex = FailIndex+1;-- 晋级失败人数+1	
   END LOOP;
close personId_5;

-- 遍历所有在职停薪人员
set done = FALSE;
OPEN personId_6;
    loop1: LOOP
        FETCH personId_6 into sTemPersonId;

        IF done THEN
            LEAVE loop1;
        END IF;
				set @jbgz0 = concat(@jbgz0,sTemPersonId,',');
				set FailIndex = FailIndex+1;-- 晋级失败人数+1	
    END LOOP;
close personId_6;


	if stemSucIndex > 0 then 
    	call p_fund_updateFlag(orgId,@re);-- 变动后更新基金isUPdateFund=1
  		set resultMsg = concat('事业正常晋升薪级成功:[',stemSucIndex,']人');
		set @resultM = replace(@resultM,'resultM:','');
		if stemFailIndex > 0 then 
			set resultMsg= concat(resultMsg,'（起薪时间不在',qxYearMonth,'的共[',stemFailIndex,']人，可能需要做一次性补扣发）;');
		end if;
	end if;

	if FailIndex > 0 then 
		-- set @khsjbm = replace(@khsjbm,'khsjbm:','');-- 考核没考1年称职的
		-- set @khfcz = replace(@khfcz,'khfcz:','');-- 考核不是称职的 用来包装考核1年，但没有达到1年称职
		-- set @qxsjbd = replace(@qxsjbd,'qxsjbd:','');-- 人员起薪时间 小于等于最近一次变动记录的起薪时间
		-- set @syq = replace(@syq,'syq:','');-- 试用期人员
		-- set @jfshf = replace(@jfshf,'jfshf:','');-- 在职计发生活费人员
		-- set @zztx = replace(@zztx,'zztx:','');-- 所有在职停薪人员
		-- set @bdcz = replace(@bdcz,'bdcz:','');-- 当前变动类型当年已经存在
		set resultMsg = replace(resultMsg,'resultMsg','');
		set @failMsg = concat(@qksjbz,';',@khsjbm,';',@khfcz,';',@qxsjbd,';',@syq,';',@jfshf,';',@jfbj,';',@zztx,';',@bdcz,';',@jbgz0,';');
		insert into temp_multi values(orgId,chanType,sysdate(),@failMsg);
		if stemSucIndex = 0 THEN
			-- set resultMsg= CONCAT(resultMsg,'成功:[0]人，','失败[',FailIndex,']人，是否下载失败记录?',@qksjbz,';',@khsjbm,';',@khfcz,';',@qxsjbd,';',@syq,';',@jfshf,';',@jfbj,';',@zztx,';',@bdcz,';',qxYearMonth,';',chanType,';','1');
			set resultMsg= CONCAT(resultMsg,'成功:[0]人，','失败[',FailIndex,']人，是否下载失败记录?',qxYearMonth,';',chanType,';','1');
		ELSE	
			set resultMsg= CONCAT(resultMsg,'失败[',FailIndex,']人，是否下载失败记录?',qxYearMonth,';',chanType,';','1');	
			-- set resultMsg= CONCAT(resultMsg,'失败[',FailIndex,']人，是否下载失败记录?',@qksjbz,';',@khsjbm,';',@khfcz,';',@qxsjbd,';',@syq,';',@jfshf,';',@jfbj,';',@zztx,';',@bdcz,';',qxYearMonth,';',chanType,';','1');
		end if;
		set resultMsg = replace(resultMsg,'resultMsg','');
	end if;

	if 	FailIndex = 0 and stemSucIndex= 0 then	
		set resultMsg = replace(resultMsg,'resultMsg','该变动原因无晋升人员');
	end if;
  	leave label_pro;
			
END;

CREATE DEFINER = `root`@`%` PROCEDURE `smso-migration-v2`.`upYdyDc`(IN createrId int(11),IN unitId int(11),IN orgId varchar(200),
IN chanType varchar(200),IN qxsj varchar(10) ,IN bdsj varchar(20),IN qknx varchar(4),in yjwh varchar(100),
INOUT resultMsg varchar(10000) CHARSET utf8)
label_pro:BEGIN	
	-- 运动员批量晋升时，晋升的是基础津贴档次，一年晋升一次，如果到了最高的档次，计算档差后加一档即可
	-- orgId 单位id
	-- chanType 批量变动变动类型id  sys_s_data data_value = 14 事业人员正常晋升薪级工资
	-- bdsj 变动时间 20160701
	-- qxsj 起薪时间 20160101
	-- DECLARE orgId varchar(100);-- 单位id
	DECLARE changeId int(11);-- -- changeId 变动记录id 主要是t126的变动记录id,此id来查询所有关联的工资t125,津贴t117 变动记录
	DECLARE personId varchar(100);-- 人员id
	DECLARE personNo varchar(100);-- 人员编号
	DECLARE salaryId varchar(100);-- 工资信息的Id
	DECLARE salaryRecordId varchar(100);-- 工资信息的recordId
	DECLARE changeTypeCode varchar(100);-- 变动类型code

	DECLARE rysf varchar(10);-- 人员身份 管理人员 工人 专业技术人员	
	DECLARE rygzzd varchar(20);-- 人员工资制度- 事业岗位绩效工资制
	DECLARE zxgzbz varchar(20);-- 执行工资标准- 事业单位管理人员工资标准,工人工资标准,专业技术人员工资标准
	
	DECLARE zwgz double DEFAULT 0;-- 职务工资

	DECLARE sjJcjtDc varchar(10);-- 实际基础津贴档次
	DECLARE gzJcjtDc varchar(10);-- 工资对应基础津贴档次

	DECLARE jb varchar(10);-- 级别
	DECLARE jbsj varchar(10);-- 级别-起考时间
	DECLARE dc varchar(10);-- 档次-薪级	
	DECLARE dcgz varchar(10);-- 级别工资-档次-薪级工资
	DECLARE dcsj varchar(50);-- 档次-薪级	
	DECLARE newDc varchar(50);-- 新薪级	
	DECLARE newDcsj varchar(10);-- 新起考时间
	DECLARE newJe double DEFAULT 0;-- 新金额
	DECLARE newDcId varchar(10);-- 新薪级Id
	
	DECLARE oldQysj varchar(50);-- 标准启用时间
	DECLARE oldBzlb varchar(50);-- 标准类别
	DECLARE oldBzmc varchar(50);-- 标准名称
	DECLARE oldJbmc varchar(50);-- 级别名称-档次/薪级
	DECLARE oldCjbmc varchar(50);-- 次级别名称-级别
	DECLARE oldJe double DEFAULT 0;-- 金额
	DECLARE oldZxgzbz varchar(50);-- 执行工资标准

	DECLARE subJe double DEFAULT 0;-- 档差(薪级差)金额
	DECLARE jhtg double DEFAULT 0;-- 教师护士提高10%
	DECLARE tjtg double DEFAULT 0;-- 特殊教育揭提高15%

	DECLARE qxYearMonth varchar(100);-- 起薪时间-截取 年月 2016-01
	
	DECLARE sTemPersonId int(11);-- 人员id-变量
	DECLARE sTempNum int(11);-- 参数
	DECLARE sTempParam int(11);--

	DECLARE chanSign varchar(100);-- 变动标志	

	DECLARE qxMonth varchar(10);-- 系统设置批量变动 统一起薪月份 :01表示 当年1月  11表示当年11月

	DECLARE stemSucIndex int(11) default 0;-- 批量晋升工资成功条数
	DECLARE stemFailIndex int(11) default 0;-- 批量晋升工资失败条数(需要手工补扣发人数)

	DECLARE zxgsje double DEFAULT 0;-- t117 执行公式*t117执行金额
	DECLARE personNum int(11);	-- 所有机关公务员在职公务员数量-排开试用期人员 
	DECLARE	FailIndex int(11) default 0; -- 晋级失败人数
	DECLARE c_id int(11);-- 创建人id
	DECLARE u_id int(11);-- 功能id
	DECLARE temp varchar(100); -- 最近一次变动记录的起薪时间
	DECLARE done INT DEFAULT FALSE;
	-- -- 所有事业在职人员
	-- DECLARE personId_ CURSOR FOR
  --  SELECT id from t126 ,sys_s_data d where d.id = t126.c36 and t126.c01 = orgId and d.data_value = 204 -- t126.c36 人员工资制度为 204 -事业岗位绩效工资制
	--  and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1');-- t126.c03 人员状态-码表 1-在职	
	
	-- --  所有事业在职人员-排开试用期人员
	DECLARE personId_ CURSOR FOR
   SELECT t126.id from t126 ,t125,sys_s_data d -- t125.c06 关联 人员基本信息表 t126 
		where t125.c06 = concat(t126.id ,'') and t125.c36 =concat(d.id,'')  
		and t126.c01 = concat(orgId,'') and d.data_value = '205' -- t125.c36 人员工资制度为 205 -体育津贴奖金制
	and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
		and (ifnull(t126.c43,'') !=10487 and ifnull(t125.c25,'')!=0)  -- 排除已经停薪的人员  10487是否状态-是   运动员基础津贴是0 的不参与晋升
	and ifnull(t125.c39,'') !=10487 -- 排除计发生活费的人员
	and ifnull(t125.c40,'') !=10487 -- 排除计发病假工资的人员
	;
	
	-- 所有在职计发生活费人员
	DECLARE personId_3 CURSOR FOR
   SELECT t126.id from t126 ,t125,sys_s_data d 
		where t125.c06 = concat(t126.id ,'') and t125.c36 =concat(d.id,'')  
		and t126.c01 = concat(orgId,'') and d.data_value = '205' -- t125.c36 人员工资制度为 205 -体育津贴奖金制
	  and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
	and ifnull(t126.c43,'') !=10487 -- 排除已经停薪的人员  10487是否状态-是
	and ifnull(t125.c39,'') =10487 -- 计发生活费的人员
	and ifnull(t125.c40,'') !=10487 -- 排除计发病假工资的人员
	;

	-- -- 所有在职停薪人员
	DECLARE personId_4 CURSOR FOR
   SELECT t126.id from t126 ,t125,sys_s_data d 
		where t125.c06 = concat(t126.id ,'') and t125.c36 =concat(d.id,'')   
		and t126.c01 = concat(orgId,'') and d.data_value = '205' -- t125.c36 人员工资制度为 205 -体育津贴奖金制
	   and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
	and ifnull(t126.c43,'') =10487  -- 排除已经停薪的人员  10487是否状态-是    
	and ifnull(t125.c39,'') !=10487 -- 排除计发生活费的人员
	and ifnull(t126.c40,'') !=10831 -- 排除减少人员
	;

		-- 所有在职计发病假工资人员
	DECLARE personId_5 CURSOR FOR
   SELECT t126.id from t126 ,t125,sys_s_data d 
		where t125.c06 = concat(t126.id ,'') and t125.c36 =concat(d.id,'')  
		and t126.c01 = concat(orgId,'') and d.data_value = '205' -- t125.c36 人员工资制度为 205 -体育津贴奖金制
	  and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
	and ifnull(t126.c43,'') !=10487 -- 排除已经停薪的人员  10487是否状态-是
	and ifnull(t125.c40,'') =10487 -- 排除计发病假工资的人员
	;
	
		
		-- -- 所有工资合计为0人员
	DECLARE personId_6 CURSOR FOR
   SELECT t126.id from t126 ,t125,sys_s_data d 
		where t125.c06 = concat(t126.id ,'') and d.id = t125.c36 
		and t126.c01 = concat(orgId,'') and d.data_value in( 201,206) -- t125.c36 人员工资制度为 201 -公务员职级工资 206-警察职级工资制度
		and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
	and  ifnull(t125.c32,0) = 0  --    工资合计为0 及视为停发工资
	and ifnull(t126.c43,'') !=10487   -- 排除已经停薪的人员  10487是否状态-是    
	and ifnull(t125.c39,'') !=10487 -- 排除计发生活费的人员
	and ifnull(t126.c40,'') !=10831 -- 排除减少人员
	;
	
	
	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
	select DATE_FORMAT(concat(qxsj,'0101'),'%Y%m'),qxsj into qxYearMonth,newDcsj;-- 起薪年月 201607,新的 薪级起考时间 为 选择的起考时间
	
	
	select content into qxMonth from sys_s_config where enname = 'qxMonth' ;
	
	set c_id = createrId;
	set u_id = unitId;
	if length(qxsj)=4 then
		select DATE_FORMAT(concat(qxsj,'-',qxMonth,'-01'),'%Y-%m') into qxYearMonth;-- 起薪年月 2016-01
	else
		select DATE_FORMAT(qxsj,'%Y-%m') into qxYearMonth;-- 起薪年月 2016-01
 	end if;
	set @resultM = 'resultM:';
	set @khsjbm = 'khsjbm:';-- 考核没考1年称职的
	set @khfcz = 'khfcz:';-- 考核不是称职的 用来包装考核1年，但没有达到1年称职
	set @qxsjbd = 'qxsjbd:';-- 人员起薪时间 小于等于最近一次变动记录的起薪时间
	set @syq = 'syq:';-- 试用期人员
	set @jfshf = 'jfshf:';-- 在职计发生活费人员
	set @jfbj = 'jfbj:';-- 在职计发病假工资人员
	set @zztx = 'zztx:';-- 所有在职停薪人员
	set @jbgz0 = 'jbgz0:';-- 所有级别工资为0人员
	set @bdcz = 'bdcz:';-- 当前变动类型当年已经存在
	set resultMsg = 'resultMsg';
	-- 打开游标
  OPEN personId_;  
  -- 开始循环
  read_loop: LOOP
    -- 提取游标里的数据，这里只有一个，多个的话也一样；
    FETCH personId_ INTO sTemPersonId;
    -- 声明结束的时候
    IF done THEN
      LEAVE read_loop;
    END IF;
	set @doneF = done;
	set @success = 1;-- 添加当前人员默认成功情况 1-可以晋升 0-不可以晋升
    select count(1) into sTempNum from data_record_t126 t126 ,data_record_t125 t125 
    where  t125.c06 = concat(t126.dataId ,'') and t126.changeSign = t125.changeSign    
    and t126.dataId = sTemPersonId -- and t126.changeType = chanType 
    and t126.changeType in('11317','11528') 
    -- 11317-事业运动员正常晋升基础津贴  11528-事业运动员批量正常晋升基础津贴
		and t126.allAuditFlag = '2'
    and replace(t125.c02,'-','') >= qxYearMonth;
    if sTempNum > 0 then -- 如果当前存在此变动
    	set @success = 0;
    end if;
    if sTempNum = 0 then -- 起薪时间之后已经存在通过的此变动记录类型
	
		-- 人员在当前单位第一次起薪时间
		/*select t125.c02 into @firstQxsj from data_record_t126 t126,data_record_t125 t125 
			where  t126.changesign = t125.changesign and  t126.dataId = stemPersonId and t125.c06 = t126.dataId 
			and t126.c01 = orgId and t126.changetype in(10750,10832) order by t126.id desc  limit 0,1;

		
		-- 重新确定工资
		select count(1) into @cxqdNum from data_record_t126 t126 ,data_record_t125 t125
    	where  t126.changesign = t125.changesign and  t126.dataId = stemPersonId and t125.c06 = t126.dataId 
    	 and t126.changeType in(select id from sys_s_data d where d.typename = 'bdlx' and data_value = '05')
    	 and t126.c01 = orgId 
    	 order by t125.id desc 
    	 limit 0,1;-- 重新确定工资
		if @cxqdNum > 0 then 
	    	select t125.c02 into @firstQxsj from data_record_t126 t126 ,data_record_t125 t125
	    	where  t126.changesign = t125.changesign and  t126.dataId = stemPersonId and t125.c06 = t126.dataId 
	    	 and t126.changeType in(select id from sys_s_data d where d.typename = 'bdlx' and data_value = '05')
	    	 and t126.c01 = orgId 
	    	 order by t125.id desc 
	    	 limit 0,1;-- 重新确定工资
		end if;*/
		-- 人员在本单位最后一次起薪（录入或调入）时间、重新确定工资起薪时间、工资制度变化起薪时间 取最大的一个起薪时间
		call p_person_getQxsj(sTemPersonId,@firstQxsj);-- 根据人员当前单位及身份等获取最早起薪时间
		
		select PERIOD_DIFF(replace(@firstQxsj,'-',''),replace(qxYearMonth,'-','')) into @stemNum; -- 判断 起薪时间201601与当前人员在该单位首次起薪时间201602 
	-- 	set resultMsg = concat('qxYearMonth:',qxYearMonth,',@firstQxsj:',@firstQxsj,',@stemNum:',@stemNum);leave label_pro;
	
		if @stemNum > 0 then -- 设置人员起薪时间  如果在单位首次起薪为201602,则设置为2016-02 如果一直在 则为为 2016-01 
			set @qxYearMonth = @firstQxsj;
		else 
			set @qxYearMonth = qxYearMonth;
		end if;
		
    	-- 循环查询人员工资信息
		-- t125 人员工资信息表 c07-工资级别-关联工资标准表t127.c05次级别名称,c08-级别起考时间,c09-工资档次-关联工资标准表-c04级别名称,c10-档次起考时间,c25-职务工资,c26-级别工资,
		-- c28-教师护士提高10%,c29-特殊教育提高15%,c36-人员工资制度-字符型
		-- t126 人员基本信息表 c28-人员身份-关联 单位工资制度与人员属性信息对应关系.人员身份 t126.c39-执行工资标准-关联 单位工资制度与人员属性信息对应关系.执行工资标准
		-- t126 c36 实际职级（实际基础津贴档次） c17工资对应职级（工资对应基础津贴档次） t125.c27-津补贴小计
		select t125.id,t125.c07,t125.c08,t125.c09,t125.c10,round(t125.c25,2),round(t125.c26,2),
		round(ifnull(t125.c28,0),2),round(t125.c29,2),
		t125.c36,
		t126.c28,t126.c39 ,
		t126.c36,t126.c17,round(t125.c27,2)
		into salaryId,jb,jbsj,dc,dcsj,zwgz,dcgz,
		jhtg,tjtg,rygzzd,
		rysf,zxgzbz,
		sjJcjtDc,gzJcjtDc,zxgsje
		from t126,t125 where t126.id = sTemPersonId and t125.c06 = concat(t126.id ,'')   ; -- t125 人员工资表 c06-人员编号 关联型
		
		-- t124 人员年度考核情况表 c03人员编号  关联型 c01-考核年度 c05-考核结果 码表, 1-优秀 2-称职 3-基本称职 4-不称职 5-不参与考核
			 -- 起考年度-2012与起薪时间-2017-01-01之间 考核年度[2012,2013,2014,2015,2016]事业连续1年以上考核 称职以上 升一档 
		set @preMonth = qxsj-1;
		select count(1) into sTempNum from t124 where c03 = concat(sTemPersonId,'') and c01 = @preMonth 
			and EXISTS (select 1 from sys_s_data d where d.id = t124.c05 and d.data_value < '3');
		select c04 into @personName from t126 where id = stemPersonId; -- 人员姓名

		if sTempNum >= 1 then -- 满足起薪时间前一年考核称职以上 升级

			-- 对起薪时间与最近一次未通过审核的变动记录的起薪时间进行比较,如果起薪时间在这变动记录之前,不能晋升
			 select UNIX_TIMESTAMP() into sTempParam;
			 set chanSign = concat('batch',sTempParam,chanType,'t126',sTemPersonId);
			 -- set chanSign = concat('\'',chanSign,'\'');
			 set temp = '';
			 if(EXISTS(select 1 from data_record_t125 a -- 人员在目前单位的变动记录ID并且ID大于人员在当前单位最新的一次录入或者接收人员变动
					where  a.dataId = salaryId   and a.allAuditFlag<>2 and a.perAuditFlag<>2 and a.id >= (select id from data_record_t125 where changeSign =
 (select changeSign from data_record_t126 where dataId = sTemPersonId AND c01 = (select c01 from t126 where id = sTemPersonId) and  (c40 = '10750' or c40 = '10832') order by id desc LIMIT 1))
					order by a.updateDate desc LIMIT 0,1)) THEN  -- 判断是否存在结果 存在则赋值
						select a.c02 into temp from data_record_t125 a  
						where  a.dataId = salaryId  and a.allAuditFlag<>2 and a.perAuditFlag<>2
						order by a.updateDate desc LIMIT 0,1;
			end if;
			
			IF  @qxYearMonth < temp THEN -- 人员起薪时间 小于等于最近一次变动记录的起薪时间
					SET @qxsjbd = CONCAT(@qxsjbd,stemPersonId,'-',@qxYearMonth,','); 
					set FailIndex = FailIndex+1;-- 晋级失败人数+1	
			else
					if  @qxYearMonth !=  qxYearMonth then -- 起薪时间 与 系统设置的起薪时间不一致
					set @resultM = concat(@resultM,'[',@personName,':变动起薪时间',@qxYearMonth,']');
					set stemFailIndex = stemFailIndex + 1;-- 需要手工补扣发的人数+1
				end if;
				
			-- t127 工资标准表  c01-启用时间 c02-标准类别 c03-标准名称 c04-次级别名称(工资档次等) c05-次级别名称(工资级别等) c06-金额 c08-执行工资标准 c09-工资标准备注
			select count(1) into @oldDcCount from t127 where id = gzJcjtDc;-- 工资对应基础层次档次
			if @oldDcCount = 0 then 
			-- 如果原来的工资对应基础层次档次查询出来数据为空
				ITERATE read_loop;-- continue;
			end if;
			-- 运动员 时 c05-基础层次
			select c01,c03,c05,c05,c06,c08 
				into 
			oldQysj,oldBzmc,dc,oldCjbmc,oldJe,oldZxgzbz
			 from t127 where id = (select id from t127 where c05 = (select c05 from t127 where id = gzJcjtDc ) and c08 = zxgzbz order by c01 desc limit 1); -- 工资对应基础层次档次
			SELECT c01 into oldQysj from t127 where c08 = oldZxgzbz ORDER BY c01 desc limit 0,1; -- 赋值最新的工资标准启用时间
			-- select c04 into zxgzbz from t136 where id = zxgzbz; -- 单位工资制度与人员属性信息对应关系t136.c04 执行工资标准
			-- select c02 into rysf from t136 where id = rysf; -- 单位工资制度与人员属性信息对应关系t136.c02 人员身份
			-- 2017-1-6 执行工资标准-t126.c39改成 工资标准类别  码表
			-- 人员身份-t126.c28改成码表  不用重新查询更新
			select SUBSTR(dc FROM 1 FOR POSITION('档' IN dc)-1) into dc;
			set newDc = dc+1;
			set newDc = CONCAT(newDc,'档');
			-- set resultMsg = concat('gzJcjtDc:',gzJcjtDc,',newDc:',newDc);leave label_pro;
			select count(1) into sTempParam from t127 a where c01 = oldQysj
			 and c03 = oldBzmc and c08 = oldZxgzbz and c05= newDc;-- 查询新的基础层次档次工资是否存在
			if sTempParam = 0 THEN 
				set dc = dc -1 ;-- 此档次上一个档次
				if dc <= 0 THEN
					set dc = dc + 1;
				end if;
				select c06 into sTempParam from t127 a where c01 = oldQysj 
				and c03 = oldBzmc and c08 = oldZxgzbz
				 and c05 = CONCAT(dc,'档');-- 上一个档次的金额
				set subJe = oldJe - sTempParam + 0;
				set newJe = oldJe + subJe + 0; -- 原来档次的工资+档差工资
				if newDc is not null and newDc != '' then 
					insert into t127(dataclassCode,c01,c03,c04,c05,c06,c08,createrId,createDate,updaterId,updateDate)
					values ('t127',oldQysj,oldBzmc,'',newDc,newJe,oldZxgzbz,1,SYSDATE(),1,SYSDATE());
					-- 向t127插入时，运动员c04为''
				end if;
			end if;			
			select count(1) into @newDcSysCount from sys_s_data where typename = 'sjzj' and name = newDc;
			if @newDcSysCount > 0 then
				select id into sjJcjtDc from sys_s_data where typename = 'sjzj' and name = newDc limit 0,1;
			else 
				-- 获取XX档最大data_value
				select data_value+1 into @newDataVal from sys_s_data where typename = 'sjzj' and name like '%档' order by data_value desc limit 0,1 ;
				insert into sys_s_data (typename,name,data_value)values('sjzj',newDc,@newDataVal);
				select id into sjJcjtDc from sys_s_data where typename = 'sjzj' and name = newDc limit 0,1;
			end if;
			select id,c06 into newDcId,newJe from t127 a where c01 = oldQysj
			 and c03 = oldBzmc and c08 = oldZxgzbz and c05= newDc;-- 查询新的档次工资
			select count(1) into sTempNum from data_record_t126 
				where dataId = sTemPersonId -- and changeType = chanType 
				 and changeType in('11317','11528') 
				 -- 11317-事业运动员正常晋升基础津贴  11528-事业运动员批量正常晋升基础津贴
				and ifnull(allAuditFlag,'') != '2';
			if sTempNum = 0 then 
				select DATE_FORMAT(SYSDATE(),'%Y') into @NowY;
				set @sqlstr = concat('select count(1) into @sTempNum from data_record_t126 ',
					'where  dataId = ',sTemPersonId,
					   -- 1' and changeType = ',chanType,
					-- 2' and changeType in(\'11317\',\'11528\')',
				   	   -- 11317-事业运动员正常晋升基础津贴  11528-事业运动员批量正常晋升基础津贴
					-- 2' and c41 like \'',@NowY,'%\'');
					' and changeType in(\'11317\',\'11528\') and  exists(select 1 from data_record_t125 where data_record_t126.changesign = data_record_t125.changesign ',
					' and data_record_t125.c02 like \'',SUBSTR(qxsj from 1 for 4),'%\')');
					-- 当年只能做一次事业正常晋升薪级
				PREPARE stmt FROM @sqlstr;
				EXECUTE stmt;
				set sTempNum = @sTempNum;
			end if;
			if sTempNum > 0 then 
				--  当前变动时间所有年份已经存在此变动记录类型
				SET @bdcz = CONCAT(@bdcz,stemPersonId,',');
				-- set @bdcz = replace(@bdcz,'bdcz:',''); -- 用来包装没有起考时间开始考核2年以上
				set FailIndex = FailIndex+1;
			end if;
			if sTempNum = 0 then 
				--  如果不存在此变动记录,存在先不管

				set stemSucIndex = stemSucIndex + 1; -- 晋升成功人数+1
				if ''!=jhtg and jhtg > 0 THEN -- 教师护士提高10%
					set jhtg = round(CAST((zwgz + newJe)*0.1 AS DECIMAL));
				end if;
				if tjtg > 0 then -- 特殊教育揭提高15%
					set tjtg = round(CAST((zwgz + newJe + ifnull(jhtg,0))*0.15 AS DECIMAL));
				end if;
				
				-- 调用upPercentJbt，更新t117津补贴金额，返回zxgzje,修改t125.c27 津补贴小计
				CALL upPercentJbt(sTemPersonId,zxgsje,newJe,dcgz,resultMsg);
				select sum(ifnull(c07+0,0)) into zxgsje from t117 where c03 = concat(sTemPersonId,'');
				update t125 set c27= zxgsje where id = salaryId;
					
				-- set gzhj = zwgz + newJe + jhtg + tjtg, ; 工资合计=职务工资+新的级别/档次工资+提高+保留
				-- 更新人员工资表t125 薪级-c09 薪级起考年度-c10 薪级工资-c26 
				-- c28-教师护士提高10% c29-特殊教育提高15%
				-- 工资合计c32: 原来的职务工资+新的薪级工资+教师护士提高+特殊教育提高+c30保留特岗工资+c31基础绩效+c27津补贴合计+c44中小学老师保留10%+c45保留护士提高10%+c47平时训练奖
				
				update t126 set c41=DATE_FORMAT(SYSDATE(),'%Y-%m-%d'),c40=chanType,
				c36 = sjJcjtDc,c17=newDcId 
				-- 运动员 实际基础津贴档次  工资对应基础津贴档次
				  where id = sTemPersonId;-- 更新人员基本信息表-变动类型,变动时间
				
				update t125 set  c02=@qxYearMonth,c25 = newJe,
				-- 运动员 基础津贴 对应 t125.c25
				c28 = ifnull(jhtg,0),c29=ifnull(tjtg,0),
				c32 = round((newJe + dcgz + ifnull(jhtg,0) + ifnull(tjtg,0) + ifnull(c30,0) + ifnull(c31,0)+ifnull(c27,0)+ifnull(c44,0)+ifnull(c45,0)+ifnull(c47,0) +0) ,2)
				,c34 ='',c04=yjwh,c48=''
				-- 工资变动 备注 依据文号 工资报审附件
				 where id = salaryId ;
				-- select UNIX_TIMESTAMP() into sTempParam;
				-- set chanSign = concat(sTempParam,chanType,'t126',sTemPersonId); -- 设置人员基本信息,工资信息,津补贴信息 共同的changeSign
				
				-- 人员基本信息-变动记录
				INSERT data_record_t126 (dataId,dataclassCode,createrId,createDate,updaterId,updateDate,unitId,
					operateTime,operateId,operateType,changeSign,changeType,c01,c02,c03,c04,c28)-- c01,c02,c03,c04,c28必填 
				select 
				id,'t126',c_id,SYSDATE(),c_id,SYSDATE(),u_id,SYSDATE(),c_id,1,chanSign,chanType,orgId,c02,c03,c04,c28
				from t126 where id = sTemPersonId;
				-- values (sTemPersonId,'t126',createrId,SYSDATE(),createrId,SYSDATE(),unitId,SYSDATE(),createrId,1,chanSign,chanType,orgId);
				update data_record_t126 a , t126 b set a.c01 = b.c01 ,a.c02 = b.c02,a.c03=b.c03,a.c04=b.c04,a.c05=b.c05,a.c06=b.c06,a.c07=b.c07,a.c08=b.c08,a.c09=b.c09,
					a.c10=b.c10,a.c11=b.c11,a.c12=b.c12,a.c13=b.c13,a.c14=b.c14,a.c15=b.c15,a.c16=b.c16,a.c17=b.c17,a.c18=b.c18,a.c19=b.c19,a.c20=b.c20,a.c21=b.c21,a.c22=b.c22,
					a.c23=b.c23,a.c24=b.c24,a.c25=b.c25,a.c26=b.c26,a.c27=b.c27,a.c28=b.c28,a.c29=b.c29,a.c30=b.c30,a.c31=b.c31,a.c32=b.c32,a.c33=b.c33,a.c34=b.c34,a.c35=b.c35,
					a.c36=b.c36,a.c37=b.c37,a.c38=b.c38,a.c39=b.c39,a.c40=b.c40,a.c41=b.c41,a.c42=b.c42,a.c43=b.c43,a.c44=b.c44,a.c45=b.c45,a.c46=b.c46,a.c47=b.c47,a.c48=b.c48,
					a.c49=b.c49,a.c50=b.c50
				where a.dataId = b.id and a.dataId = sTemPersonId  and a.changeSign = chanSign ;
	
				-- 人员工资信息-变动记录
				INSERT data_record_t125 (dataId,dataclassCode,createrId,createDate,updaterId,updateDate,unitId,
	 				operateTime,operateId,operateType,changeSign,changeType)
				values (salaryId,'t125',createrId,SYSDATE(),createrId,SYSDATE(),unitId,SYSDATE(),createrId,1,chanSign,chanType);-- 插入 人员工资信息 变动记录
				update data_record_t125 a , t125 b set a.c01 = b.c01 ,a.c02 = b.c02,a.c03=b.c03,a.c04=b.c04,a.c05=b.c05,a.c06=b.c06,a.c07=b.c07,a.c08=b.c08,a.c09=b.c09,
					a.c10=b.c10,a.c11=b.c11,a.c12=b.c12,a.c13=b.c13,a.c14=b.c14,a.c15=b.c15,a.c16=b.c16,a.c17=b.c17,a.c18=b.c18,a.c19=b.c19,a.c20=b.c20,a.c21=b.c21,a.c22=b.c22,
					a.c23=b.c23,a.c24=b.c24,a.c25=b.c25,a.c26=b.c26,a.c27=b.c27,a.c28=b.c28,a.c29=b.c29,a.c30=b.c30,a.c31=b.c31,a.c32=b.c32,a.c33=b.c33,a.c34=b.c34,a.c35=b.c35,
					a.c36=b.c36,a.c37=b.c37,a.c38=b.c38,a.c39=b.c39,a.c40=b.c40,a.c41=b.c41,a.c42=b.c42,a.c43=b.c43,a.c44=b.c44,a.c45=b.c45,a.c46=b.c46,a.c47=b.c47,a.c48=b.c48,
					a.c49=b.c49,a.c50=b.c50
				where a.dataId = b.id and a.dataId = salaryId  and a.changeSign = chanSign ;						
			
				-- --  人员津补贴-变动记录
				call upRyjbtBd(sTemPersonId,createrId,unitId,chanSign,chanType,resultMsg);
			
				-- 计算补扣发
				select id into changeId from data_record_t126 where  changeSign = chanSign;
				-- call fillCount(orgId,changeId,chanType ,chanSign,resultMsg);
				end if;
					
			end if;
				
		end if;
	end if;
	
	if @success = 0 then -- 当年只能做一次事业正常晋升薪级
		select DATE_FORMAT(SYSDATE(),'%Y') into @NowY;
		set @sqlstr = concat('select count(1) into @sTempNum from data_record_t126 ',
			'where  dataId = ',sTemPersonId,
			-- 1、' and changeType = ',chanType,
			-- 2、' and changeType in(\'11317\',\'11528\')',
		   -- 11317-事业运动员正常晋升基础津贴  11528-事业运动员批量正常晋升基础津贴
			-- 2、' and c41 like \'',@NowY,'%\'');
			' and changeType in(\'11317\',\'11528\') and  exists(select 1 from data_record_t125 where data_record_t126.changesign = data_record_t125.changesign ',
			' and data_record_t125.c02 like \'',SUBSTR(qxsj from 1 for 4),'%\')');
			-- 当年只能做一次事业正常晋升薪级
		PREPARE stmt FROM @sqlstr;
		EXECUTE stmt;
		set sTempNum = @sTempNum;
		if sTempNum > 0 then 
			--  当前变动时间所有年份已经存在此变动记录类型
			SET @bdcz = CONCAT(@bdcz,stemPersonId,',');
			set FailIndex = FailIndex+1;
		end if;
	else
		select count(1) into sTempNum from t124 where c03 = concat(sTemPersonId,'') and c01 = @preMonth 
				and EXISTS (select 1 from sys_s_data d where d.id = t124.c05 );
		if sTempNum >= 1 then  -- 起考时间开始考核2年以上
			select count(1) into sTempNum from t124 where c03 = concat(sTemPersonId,'') and c01 = @preMonth 
			and EXISTS (select 1 from sys_s_data d where d.id = t124.c05 and d.data_value < '3');
			if sTempNum < 1 then  -- 未达到1年以上称职
				SET @khfcz = CONCAT(@khfcz,stemPersonId,','); 
				-- set @khfcz = replace(@khfcz,'khfcz:','');-- 用来包装考核2年，但没有达到2年称职
				set FailIndex = FailIndex+1;-- 晋级失败人数+1	
			end if;
		else
			SET @khsjbm = CONCAT(@khsjbm,stemPersonId,',');
			set FailIndex = FailIndex+1;
		end if;
	end if;
	/** 
	select count(1) into sTempNum from t124 where c03 = concat(sTemPersonId,'') and c01 = @preMonth 
			and EXISTS (select 1 from sys_s_data d where d.id = t124.c05 );
	if sTempNum >= 1 then  -- 起考时间开始考核2年以上
		select count(1) into sTempNum from t124 where c03 = concat(sTemPersonId,'') and c01 = @preMonth 
		and EXISTS (select 1 from sys_s_data d where d.id = t124.c05 and d.data_value < '3');
		if sTempNum < 1 then  -- 未达到2年以上称职
			SET @khfcz = CONCAT(@khfcz,stemPersonId,','); 
			-- set @khfcz = replace(@khfcz,'khfcz:','');-- 用来包装考核2年，但没有达到2年称职
			set FailIndex = FailIndex+1;-- 晋级失败人数+1	
		end if;
	ELSE 
		select DATE_FORMAT(SYSDATE(),'%Y') into @NowY;
		set @sqlstr = concat('select count(1) into @sTempNum from data_record_t126 ',
			'where  dataId = ',sTemPersonId,
			' and changeType = ',chanType,' and c41 like \'',@NowY,'%\'');
			-- 当年只能做一次事业正常晋升薪级
		PREPARE stmt FROM @sqlstr;
		EXECUTE stmt;
		set sTempNum = @sTempNum;
		if sTempNum > 0 then 
			--  当前变动时间所有年份已经存在此变动记录类型
			SET @bdcz = CONCAT(@bdcz,stemPersonId,',');
			set FailIndex = FailIndex+1;
		else
			SET @khsjbm = CONCAT(@khsjbm,stemPersonId,',');
			set FailIndex = FailIndex+1;
		end if;
	end if;
	*/
	set done = @doneF;

  END LOOP;
  -- 关闭游标
    CLOSE personId_;	


   SELECT count(1) into @jfshfNum from t126 ,t125,sys_s_data d 
		where t125.c06 =concat(t126.id ,'') and d.id = t125.c36 
		and t126.c01 = concat(orgId,'') and d.data_value = 205 -- t125.c36 人员工资制度为 205 -体育津贴奖金制
	  and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
	and ifnull(t126.c43,'') !=10487 -- 排除已经停薪的人员  10487是否状态-是
	and ifnull(t125.c39,'') =10487 -- 计发生活费的人员
	;
	if @jfshfNum > 0 then 
		-- 遍历在职计发生活费人员
		set done = FALSE;
		OPEN personId_3;
		    loop1: LOOP
		        FETCH personId_3 into sTemPersonId;
		        IF done THEN
		            LEAVE loop1;
		        END IF;
					set @jfshf = concat(@jfshf,sTemPersonId,',');
					set FailIndex = FailIndex+1;-- 晋级失败人数+1	
		    END LOOP;
		close personId_3;
	end if;


   SELECT count(1) into @zztxNum from t126 ,t125,sys_s_data d 
		where t125.c06 =concat(t126.id ,'') and d.id = t125.c36 
		and t126.c01 = concat(orgId,'') and d.data_value = 205 -- t125.c36 人员工资制度为 205 -体育津贴奖金制
	   and EXISTS (select 1 from sys_s_data d where d.id = t126.c03 and d.data_value = '1')-- t126.c03 人员状态-码表 1-在职
	and ifnull(t126.c43,'') =10487 -- 已经停薪的人员  10487是否状态-是
	and ifnull(t125.c39,'') !=10487 -- 排除计发生活费的人员
	;
	if @zztxNum > 0 then 
		-- 遍历所有在职停薪人员
		set done = FALSE;
		OPEN personId_4;
		    loop1: LOOP
		        FETCH personId_4 into sTemPersonId;
		        IF done THEN
		            LEAVE loop1;
		        END IF;
					set @zztx = concat(@zztx,sTemPersonId,',');
					set FailIndex = FailIndex+1;-- 晋级失败人数+1	
		    END LOOP;
		close personId_4;
	end if;
	-- 遍历所有在职计发病假工资人员
 set done = FALSE;
 OPEN personId_5;
     loop1: LOOP
        FETCH personId_5 into sTemPersonId;

        IF done THEN
            LEAVE loop1;
        END IF;
				set @jfbj = concat(@jfbj,sTemPersonId,',');
				set FailIndex = FailIndex+1;-- 晋级失败人数+1	
    END LOOP;
close personId_5;


-- 遍历所有在职停薪人员
set done = FALSE;
OPEN personId_6;
    loop1: LOOP
        FETCH personId_6 into sTemPersonId;

        IF done THEN
            LEAVE loop1;
        END IF;
				set @jbgz0 = concat(@jbgz0,sTemPersonId,',');
				set FailIndex = FailIndex+1;-- 晋级失败人数+1	
    END LOOP;
close personId_6;



	if stemSucIndex > 0 then 
    	call p_fund_updateFlag(orgId,@re);-- 变动后更新基金isUPdateFund=1
		set resultMsg = concat('事业运动员正常晋升基础津贴成功:[',stemSucIndex,']人');
		set @resultM = replace(@resultM,'resultM:','');
		if stemFailIndex > 0 then 
			set resultMsg= concat(resultMsg,'（起薪时间不在',qxYearMonth,'的共[',stemFailIndex,']人，可能需要做一次性补扣发）;');
		end if;
	end if;
	if FailIndex > 0 then 
		-- set @khsjbm = replace(@khsjbm,'khsjbm:','');-- 考核没考1年称职的
		-- set @khfcz = replace(@khfcz,'khfcz:','');-- 考核不是称职的 用来包装考核1年，但没有达到1年称职
		-- set @qxsjbd = replace(@qxsjbd,'qxsjbd:','');-- 人员起薪时间 小于等于最近一次变动记录的起薪时间
		-- set @syq = replace(@syq,'syq:','');-- 试用期人员
		-- set @jfshf = replace(@jfshf,'jfshf:','');-- 在职计发生活费人员
		-- set @zztx = replace(@zztx,'zztx:','');-- 所有在职停薪人员
		-- set @bdcz = replace(@bdcz,'bdcz:','');-- 当前变动类型当年已经存在
		set resultMsg = replace(resultMsg,'resultMsg','');
		set @failMsg = concat(@khsjbm,';',@khfcz,';',@qxsjbd,';',@syq,';',@jfshf,';',@jfbj,';',@zztx,';',@bdcz,';',@jbgz0,';');
		insert into temp_multi values(orgId,chanType,sysdate(),@failMsg);
		if stemSucIndex = 0 THEN
			-- set resultMsg= CONCAT(resultMsg,'成功:[0]人，','失败[',FailIndex,']人，是否下载失败记录?',@khsjbm,';',@khfcz,';',@qxsjbd,';',@syq,';',@jfshf,';',@jfbj,';',@zztx,';',@bdcz,';',qxYearMonth,';',chanType,';','1');
			set resultMsg= CONCAT(resultMsg,'成功:[0]人，','失败[',FailIndex,']人，是否下载失败记录?',qxYearMonth,';',chanType,';','1');
		ELSE	
			set resultMsg= CONCAT(resultMsg,'失败[',FailIndex,']人，是否下载失败记录?',qxYearMonth,';',chanType,';','1');	
			-- set resultMsg= CONCAT(resultMsg,'失败[',FailIndex,']人，是否下载失败记录?',@khsjbm,';',@khfcz,';',@qxsjbd,';',@syq,';',@jfshf,';',@jfbj,';',@zztx,';',@bdcz,';',qxYearMonth,';',chanType,';','1');
		end if;
		set resultMsg = replace(resultMsg,'resultMsg','');
	end if;

	if 	FailIndex = 0 and stemSucIndex= 0 then	
		set resultMsg = replace(resultMsg,'resultMsg','该变动原因无晋升人员');
	end if;

  	leave label_pro;
END;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t109history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c01` AS `C01`,`a`.`c02` AS `C02`,`a`.`c03` AS `C03`,`a`.`c04` AS `C04`,`a`.`c05` AS `C05`,`a`.`c06` AS `C06` from `data_data_history` `a` where (`a`.`dataclassCode` = 't109');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t111history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c01` AS `C01`,`a`.`c02` AS `C02`,`a`.`c03` AS `C03`,`a`.`c04` AS `C04`,`a`.`c24` AS `C24`,`a`.`c05` AS `C05`,`a`.`c06` AS `C06`,`a`.`c07` AS `C07`,`a`.`c08` AS `C08`,`a`.`c09` AS `C09`,`a`.`c10` AS `C10`,ifnull((select `b`.`c02` from `t111` `b` where (`b`.`id` = `a`.`c11`)),`a`.`c11`) AS `c11`,`a`.`c12` AS `C12`,`a`.`c13` AS `C13`,`a`.`c14` AS `C14`,`a`.`c15` AS `C15`,`a`.`c16` AS `C16`,`a`.`c17` AS `C17`,`a`.`c18` AS `C18`,`a`.`c19` AS `C19`,`a`.`c20` AS `C20`,`a`.`c21` AS `C21`,`a`.`c22` AS `C22`,`a`.`c23` AS `C23`,`a`.`c25` AS `C25`,`a`.`c26` AS `C26`,`a`.`c27` AS `C27` from `data_data_history` `a` where (`a`.`dataclassCode` = 't111');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t112history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,ifnull((select `b`.`c01` from `t111` `b` where (`b`.`id` = `a`.`c01`)),`a`.`c01`) AS `c01`,`a`.`c15` AS `C15`,`a`.`c14` AS `C14`,`a`.`c02` AS `C02`,`a`.`c03` AS `C03`,`a`.`c04` AS `C04`,`a`.`c05` AS `C05`,`a`.`c06` AS `C06`,`a`.`c16` AS `C16`,`a`.`c17` AS `C17`,`a`.`c07` AS `C07`,`a`.`c08` AS `C08`,`a`.`c09` AS `C09`,`a`.`c10` AS `C10`,`a`.`c11` AS `C11`,`a`.`c12` AS `C12`,`a`.`c13` AS `C13`,`a`.`c18` AS `C18`,`a`.`c19` AS `C19`,`a`.`c20` AS `C20`,`a`.`c21` AS `C21`,`a`.`c22` AS `C22`,`a`.`c23` AS `C23`,`a`.`c24` AS `C24`,`a`.`c25` AS `C25` from `data_data_history` `a` where (`a`.`dataclassCode` = 't112');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t114history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c01` AS `C01`,`a`.`c02` AS `C02`,`a`.`c03` AS `C03`,`a`.`c04` AS `C04`,`a`.`c05` AS `C05`,`a`.`c06` AS `C06`,`a`.`c07` AS `C07`,`a`.`c08` AS `C08`,`a`.`c09` AS `C09`,`a`.`c10` AS `C10`,`a`.`c11` AS `C11`,`a`.`c12` AS `C12`,`a`.`c13` AS `C13`,`a`.`c14` AS `C14`,`a`.`c15` AS `C15`,`a`.`c16` AS `C16`,ifnull((select `b`.`c02` from `t113` `b` where (`b`.`id` = `a`.`c17`)),`a`.`c17`) AS `c17`,`a`.`c18` AS `C18`,`a`.`c19` AS `C19`,`a`.`c20` AS `C20`,`a`.`c21` AS `C21`,`a`.`c22` AS `C22`,`a`.`c23` AS `C23`,`a`.`c24` AS `C24`,`a`.`c25` AS `C25`,`a`.`c26` AS `C26`,`a`.`c27` AS `C27`,`a`.`c28` AS `C28`,`a`.`c29` AS `C29`,`a`.`c30` AS `C30`,`a`.`c31` AS `C31`,`a`.`c32` AS `C32`,`a`.`c33` AS `C33`,`a`.`c34` AS `C34`,`a`.`c35` AS `C35`,`a`.`c36` AS `C36`,`a`.`c37` AS `C37`,`a`.`c38` AS `C38`,`a`.`c39` AS `C39`,`a`.`c40` AS `C40`,`a`.`c41` AS `C41`,`a`.`c42` AS `C42`,`a`.`c43` AS `C43`,`a`.`c44` AS `C44`,`a`.`c45` AS `C45`,`a`.`c46` AS `C46`,`a`.`c47` AS `C47`,`a`.`c48` AS `C48`,`a`.`c49` AS `C49`,`a`.`c50` AS `C50` from `data_data_history` `a` where (`a`.`dataclassCode` = 't114');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t115history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,ifnull((select `b`.`c01` from `t111` `b` where (`b`.`id` = `a`.`c02`)),`a`.`c02`) AS `c02`,ifnull((select `b`.`c02` from `t116` `b` where (`b`.`id` = `a`.`c03`)),`a`.`c03`) AS `c03`,ifnull((select `b`.`c03` from `t116` `b` where (`b`.`id` = `a`.`c04`)),`a`.`c04`) AS `c04`,`a`.`c05` AS `C05`,`a`.`c06` AS `C06`,`a`.`c07` AS `C07`,`a`.`c01` AS `C01`,`a`.`c08` AS `C08`,`a`.`c09` AS `C09`,`a`.`c10` AS `C10`,`a`.`c11` AS `C11`,`a`.`c12` AS `C12` from `data_data_history` `a` where (`a`.`dataclassCode` = 't115');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t116history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c02` AS `C02`,`a`.`c03` AS `C03`,`a`.`c04` AS `C04`,`a`.`c01` AS `C01`,`a`.`c05` AS `C05`,`a`.`c06` AS `C06`,`a`.`c07` AS `C07`,`a`.`c08` AS `C08`,`a`.`c09` AS `C09`,`a`.`c10` AS `C10`,`a`.`c11` AS `C11`,`a`.`c12` AS `C12` from `data_data_history` `a` where (`a`.`dataclassCode` = 't116');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t117history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c01` AS `C01`,ifnull((select `b`.`c01` from `t111` `b` where (`b`.`id` = `a`.`c02`)),`a`.`c02`) AS `c02`,ifnull((select `b`.`c02` from `t126` `b` where (`b`.`id` = `a`.`c03`)),`a`.`c03`) AS `c03`,ifnull((select `b`.`c02` from `t116` `b` where (`b`.`id` = `a`.`c04`)),`a`.`c04`) AS `c04`,ifnull((select `b`.`c03` from `t116` `b` where (`b`.`id` = `a`.`c05`)),`a`.`c05`) AS `c05`,`a`.`c06` AS `C06`,`a`.`c07` AS `C07`,`a`.`c08` AS `C08`,`a`.`c09` AS `C09`,`a`.`c10` AS `C10`,`a`.`c11` AS `C11`,`a`.`c12` AS `C12` from `data_data_history` `a` where (`a`.`dataclassCode` = 't117');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t118history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,ifnull((select `b`.`c01` from `t111` `b` where (`b`.`id` = `a`.`c01`)),`a`.`c01`) AS `c01`,`a`.`c02` AS `C02`,`a`.`c03` AS `C03`,`a`.`c04` AS `C04`,`a`.`c05` AS `C05`,`a`.`c06` AS `C06`,`a`.`c07` AS `C07`,`a`.`c08` AS `C08`,`a`.`c09` AS `C09`,`a`.`c10` AS `C10`,`a`.`c11` AS `C11`,`a`.`c12` AS `C12`,`a`.`c13` AS `C13`,`a`.`c14` AS `C14`,`a`.`c15` AS `C15`,`a`.`c16` AS `C16` from `data_data_history` `a` where (`a`.`dataclassCode` = 't118');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`localhost` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t119history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c20` AS `C20`,`a`.`c10` AS `C10`,ifnull((select `b`.`c01` from `t111` `b` where (`b`.`id` = `a`.`c04`)),`a`.`c04`) AS `c04`,ifnull((select `b`.`c02` from `t111` `b` where (`b`.`id` = `a`.`c18`)),`a`.`c18`) AS `c18`,ifnull((select `b`.`c02` from `t126` `b` where (`b`.`id` = `a`.`c01`)),`a`.`c01`) AS `c01`,ifnull((select `b`.`c04` from `t126` `b` where (`b`.`id` = `a`.`c19`)),`a`.`c19`) AS `c19`,`a`.`c02` AS `C02`,`a`.`c03` AS `C03`,`a`.`c05` AS `C05`,`a`.`c06` AS `C06`,`a`.`c07` AS `C07`,`a`.`c11` AS `C11`,`a`.`c12` AS `C12`,`a`.`c13` AS `C13`,`a`.`c14` AS `C14`,`a`.`c15` AS `C15`,`a`.`c16` AS `C16`,`a`.`c17` AS `C17`,`a`.`c08` AS `C08`,`a`.`c09` AS `C09`,`a`.`c21` AS `C21`,`a`.`c22` AS `C22`,`a`.`c23` AS `C23`,`a`.`c24` AS `C24`,`a`.`c25` AS `C25`,`a`.`c26` AS `C26`,`a`.`c27` AS `C27` from `data_data_history` `a` where (`a`.`dataclassCode` = 't119');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t120history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c01` AS `C01`,`a`.`c02` AS `C02`,`a`.`c03` AS `C03`,`a`.`c04` AS `C04` from `data_data_history` `a` where (`a`.`dataclassCode` = 't120');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t121history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,ifnull((select `b`.`c01` from `t111` `b` where (`b`.`id` = `a`.`c03`)),`a`.`c03`) AS `c03`,ifnull((select `b`.`c02` from `t126` `b` where (`b`.`id` = `a`.`c02`)),`a`.`c02`) AS `c02`,ifnull((select `b`.`c04` from `t126` `b` where (`b`.`id` = `a`.`c01`)),`a`.`c01`) AS `c01`,`a`.`c04` AS `C04`,`a`.`c05` AS `C05`,`a`.`c06` AS `C06`,`a`.`c07` AS `C07`,`a`.`c08` AS `C08` from `data_data_history` `a` where (`a`.`dataclassCode` = 't121');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t122history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,ifnull((select `b`.`c01` from `t111` `b` where (`b`.`id` = `a`.`c01`)),`a`.`c01`) AS `c01`,ifnull((select `b`.`c02` from `t126` `b` where (`b`.`id` = `a`.`c02`)),`a`.`c02`) AS `c02`,ifnull((select `b`.`c04` from `t126` `b` where (`b`.`id` = `a`.`c03`)),`a`.`c03`) AS `c03`,`a`.`c04` AS `C04`,`a`.`c05` AS `C05`,`a`.`c06` AS `C06`,`a`.`c07` AS `C07`,`a`.`c08` AS `C08` from `data_data_history` `a` where (`a`.`dataclassCode` = 't122');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t123history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c06` AS `C06`,`a`.`c01` AS `C01`,`a`.`c05` AS `C05`,`a`.`c02` AS `C02`,`a`.`c09` AS `C09`,ifnull((select `b`.`c02` from `t116` `b` where (`b`.`id` = `a`.`c03`)),`a`.`c03`) AS `c03`,ifnull((select `b`.`c03` from `t116` `b` where (`b`.`id` = `a`.`c04`)),`a`.`c04`) AS `c04`,ifnull((select `b`.`c05` from `t127` `b` where (`b`.`id` = `a`.`c07`)),`a`.`c07`) AS `c07`,`a`.`c08` AS `C08`,`a`.`c10` AS `C10`,`a`.`c11` AS `C11` from `data_data_history` `a` where (`a`.`dataclassCode` = 't123');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t124history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c01` AS `C01`,ifnull((select `b`.`c01` from `t111` `b` where (`b`.`id` = `a`.`c02`)),`a`.`c02`) AS `c02`,ifnull((select `b`.`c02` from `t126` `b` where (`b`.`id` = `a`.`c03`)),`a`.`c03`) AS `c03`,ifnull((select `b`.`c04` from `t126` `b` where (`b`.`id` = `a`.`c04`)),`a`.`c04`) AS `c04`,`a`.`c05` AS `C05` from `data_data_history` `a` where (`a`.`dataclassCode` = 't124');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t125history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c02` AS `C02`,ifnull((select `b`.`c01` from `t111` `b` where (`b`.`id` = `a`.`c05`)),`a`.`c05`) AS `c05`,ifnull((select `b`.`c02` from `t126` `b` where (`b`.`id` = `a`.`c06`)),`a`.`c06`) AS `c06`,ifnull((select `b`.`c04` from `t126` `b` where (`b`.`id` = `a`.`c33`)),`a`.`c33`) AS `c33`,`a`.`c24` AS `C24`,`a`.`c36` AS `C36`,ifnull((select `b`.`c05` from `t127` `b` where (`b`.`id` = `a`.`c07`)),`a`.`c07`) AS `c07`,`a`.`c08` AS `C08`,ifnull((select `b`.`c04` from `t127` `b` where (`b`.`id` = `a`.`c09`)),`a`.`c09`) AS `c09`,`a`.`c10` AS `C10`,`a`.`c42` AS `C42`,`a`.`c01` AS `C01`,`a`.`c03` AS `C03`,`a`.`c23` AS `C23`,`a`.`c35` AS `C35`,`a`.`c11` AS `C11`,`a`.`c12` AS `C12`,`a`.`c13` AS `C13`,`a`.`c14` AS `C14`,`a`.`c15` AS `C15`,`a`.`c16` AS `C16`,`a`.`c17` AS `C17`,`a`.`c18` AS `C18`,`a`.`c19` AS `C19`,`a`.`c20` AS `C20`,`a`.`c21` AS `C21`,`a`.`c22` AS `C22`,`a`.`c25` AS `C25`,`a`.`c26` AS `C26`,`a`.`c28` AS `C28`,`a`.`c29` AS `C29`,`a`.`c44` AS `C44`,`a`.`c45` AS `C45`,`a`.`c30` AS `C30`,`a`.`c47` AS `C47`,`a`.`c31` AS `C31`,`a`.`c27` AS `C27`,`a`.`c32` AS `C32`,`a`.`c34` AS `C34`,`a`.`c04` AS `C04`,`a`.`c48` AS `C48`,`a`.`c37` AS `C37`,`a`.`c39` AS `C39`,`a`.`c38` AS `C38`,`a`.`c40` AS `C40`,`a`.`c41` AS `C41`,`a`.`c43` AS `C43`,ifnull((select `b`.`c05` from `t127` `b` where (`b`.`id` = `a`.`c46`)),`a`.`c46`) AS `c46`,`a`.`c49` AS `C49`,`a`.`c50` AS `C50` from `data_data_history` `a` where (`a`.`dataclassCode` = 't125');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t126history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,ifnull((select `b`.`c01` from `t111` `b` where (`b`.`id` = `a`.`c01`)),`a`.`c01`) AS `c01`,`a`.`c03` AS `C03`,`a`.`c02` AS `C02`,`a`.`c04` AS `C04`,`a`.`c28` AS `C28`,`a`.`c05` AS `C05`,`a`.`c06` AS `C06`,`a`.`c07` AS `C07`,`a`.`c08` AS `C08`,`a`.`c09` AS `C09`,`a`.`c10` AS `C10`,`a`.`c11` AS `C11`,`a`.`c12` AS `C12`,`a`.`c13` AS `C13`,ifnull((select `b`.`c03` from `t113` `b` where (`b`.`id` = `a`.`c15`)),`a`.`c15`) AS `c15`,`a`.`c14` AS `C14`,`a`.`c16` AS `C16`,`a`.`c39` AS `C39`,`a`.`c36` AS `C36`,ifnull((select `b`.`c05` from `t127` `b` where (`b`.`id` = `a`.`c17`)),`a`.`c17`) AS `c17`,`a`.`c18` AS `C18`,ifnull((select `b`.`c04` from `t127` `b` where (`b`.`id` = `a`.`c27`)),`a`.`c27`) AS `c27`,`a`.`c19` AS `C19`,`a`.`c20` AS `C20`,`a`.`c24` AS `C24`,`a`.`c25` AS `C25`,`a`.`c22` AS `C22`,`a`.`c23` AS `C23`,`a`.`c21` AS `C21`,`a`.`c26` AS `C26`,`a`.`c29` AS `C29`,`a`.`c30` AS `C30`,`a`.`c31` AS `C31`,`a`.`c32` AS `C32`,`a`.`c33` AS `C33`,`a`.`c34` AS `C34`,`a`.`c35` AS `C35`,`a`.`c37` AS `C37`,ifnull((select `b`.`c02` from `t111` `b` where (`b`.`id` = `a`.`c38`)),`a`.`c38`) AS `c38`,`a`.`c40` AS `C40`,`a`.`c41` AS `C41`,`a`.`c42` AS `C42`,`a`.`c43` AS `C43`,`a`.`c44` AS `C44`,`a`.`c45` AS `C45`,`a`.`c46` AS `C46`,`a`.`c47` AS `C47`,`a`.`c48` AS `C48`,`a`.`c49` AS `C49`,`a`.`c50` AS `C50` from `data_data_history` `a` where (`a`.`dataclassCode` = 't126');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t127history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c01` AS `C01`,`a`.`c02` AS `C02`,`a`.`c03` AS `C03`,`a`.`c04` AS `C04`,`a`.`c05` AS `C05`,`a`.`c06` AS `C06`,`a`.`c07` AS `C07`,`a`.`c08` AS `C08`,`a`.`c09` AS `C09` from `data_data_history` `a` where (`a`.`dataclassCode` = 't127');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t128history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c01` AS `C01`,`a`.`c02` AS `C02` from `data_data_history` `a` where (`a`.`dataclassCode` = 't128');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t129history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c01` AS `C01`,`a`.`c02` AS `C02`,`a`.`c03` AS `C03` from `data_data_history` `a` where (`a`.`dataclassCode` = 't129');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t130history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c01` AS `C01`,`a`.`c02` AS `C02`,ifnull((select `b`.`c01` from `t111` `b` where (`b`.`id` = `a`.`c03`)),`a`.`c03`) AS `c03`,`a`.`c04` AS `C04`,`a`.`c05` AS `C05`,`a`.`c06` AS `C06` from `data_data_history` `a` where (`a`.`dataclassCode` = 't130');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t131history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,ifnull((select `b`.`c02` from `t126` `b` where (`b`.`id` = `a`.`c01`)),`a`.`c01`) AS `c01`,ifnull((select `b`.`c04` from `t126` `b` where (`b`.`id` = `a`.`c02`)),`a`.`c02`) AS `c02`,`a`.`c03` AS `C03`,`a`.`c04` AS `C04`,`a`.`c05` AS `C05`,`a`.`c06` AS `C06`,`a`.`c07` AS `C07`,`a`.`c08` AS `C08`,`a`.`c09` AS `C09`,`a`.`c10` AS `C10`,`a`.`c11` AS `C11`,`a`.`c12` AS `C12`,`a`.`c13` AS `C13`,`a`.`c14` AS `C14`,`a`.`c15` AS `C15`,`a`.`c16` AS `C16`,`a`.`c17` AS `C17`,`a`.`c18` AS `C18`,ifnull((select `b`.`c01` from `t111` `b` where (`b`.`id` = `a`.`c19`)),`a`.`c19`) AS `c19`,`a`.`c20` AS `C20`,`a`.`c21` AS `C21`,`a`.`c22` AS `C22`,`a`.`c23` AS `C23`,`a`.`c24` AS `C24`,`a`.`c25` AS `C25`,`a`.`c26` AS `C26`,`a`.`c27` AS `C27`,`a`.`c28` AS `C28`,`a`.`c29` AS `C29`,`a`.`c30` AS `C30`,`a`.`c31` AS `C31`,`a`.`c32` AS `C32`,ifnull((select `b`.`c05` from `t127` `b` where (`b`.`id` = `a`.`c33`)),`a`.`c33`) AS `c33`,ifnull((select `b`.`c04` from `t127` `b` where (`b`.`id` = `a`.`c34`)),`a`.`c34`) AS `c34`,`a`.`c35` AS `C35`,`a`.`c36` AS `C36`,`a`.`c37` AS `C37`,`a`.`c38` AS `C38`,`a`.`c39` AS `C39`,`a`.`c40` AS `C40`,`a`.`c41` AS `C41`,`a`.`c42` AS `C42`,`a`.`c43` AS `C43`,`a`.`c44` AS `C44`,`a`.`c45` AS `C45` from `data_data_history` `a` where (`a`.`dataclassCode` = 't131');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t132history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c01` AS `C01`,`a`.`c02` AS `C02`,`a`.`c03` AS `C03`,`a`.`c04` AS `C04`,`a`.`c05` AS `C05`,`a`.`c06` AS `C06`,`a`.`c07` AS `C07`,`a`.`c08` AS `C08`,`a`.`c09` AS `C09`,ifnull((select `b`.`c01` from `t111` `b` where (`b`.`id` = `a`.`c10`)),`a`.`c10`) AS `c10`,`a`.`c11` AS `C11`,`a`.`c12` AS `C12` from `data_data_history` `a` where (`a`.`dataclassCode` = 't132');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t133history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,ifnull((select `b`.`c01` from `t111` `b` where (`b`.`id` = `a`.`c01`)),`a`.`c01`) AS `c01`,ifnull((select `b`.`c02` from `t111` `b` where (`b`.`id` = `a`.`c02`)),`a`.`c02`) AS `c02`,`a`.`c03` AS `C03`,`a`.`c04` AS `C04`,`a`.`c05` AS `C05`,`a`.`c06` AS `C06`,`a`.`c07` AS `C07`,`a`.`c08` AS `C08` from `data_data_history` `a` where (`a`.`dataclassCode` = 't133');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t134history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId` from `data_data_history` `a` where (`a`.`dataclassCode` = 't134');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t135history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c09` AS `C09`,`a`.`c01` AS `C01`,`a`.`c02` AS `C02`,`a`.`c03` AS `C03`,`a`.`c04` AS `C04`,ifnull((select `b`.`c05` from `t127` `b` where (`b`.`id` = `a`.`c05`)),`a`.`c05`) AS `c05`,ifnull((select `b`.`c04` from `t127` `b` where (`b`.`id` = `a`.`c06`)),`a`.`c06`) AS `c06`,ifnull((select `b`.`c05` from `t127` `b` where (`b`.`id` = `a`.`c07`)),`a`.`c07`) AS `c07`,ifnull((select `b`.`c04` from `t127` `b` where (`b`.`id` = `a`.`c08`)),`a`.`c08`) AS `c08` from `data_data_history` `a` where (`a`.`dataclassCode` = 't135');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t136history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c01` AS `C01`,`a`.`c02` AS `C02`,`a`.`c03` AS `C03`,`a`.`c04` AS `C04`,`a`.`c05` AS `C05`,`a`.`c06` AS `C06`,`a`.`c07` AS `C07`,`a`.`c08` AS `C08` from `data_data_history` `a` where (`a`.`dataclassCode` = 't136');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t137history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c01` AS `C01`,`a`.`c02` AS `C02`,`a`.`c03` AS `C03` from `data_data_history` `a` where (`a`.`dataclassCode` = 't137');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t138history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c02` AS `C02`,`a`.`c03` AS `C03`,`a`.`c04` AS `C04`,`a`.`c01` AS `C01`,`a`.`c05` AS `C05`,`a`.`c06` AS `C06`,ifnull((select `b`.`c01` from `t111` `b` where (`b`.`id` = `a`.`c07`)),`a`.`c07`) AS `c07` from `data_data_history` `a` where (`a`.`dataclassCode` = 't138');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t139history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,ifnull((select `b`.`c01` from `t111` `b` where (`b`.`id` = `a`.`c01`)),`a`.`c01`) AS `c01`,`a`.`c02` AS `C02`,ifnull((select `b`.`c02` from `t130` `b` where (`b`.`id` = `a`.`c03`)),`a`.`c03`) AS `c03`,`a`.`c04` AS `C04` from `data_data_history` `a` where (`a`.`dataclassCode` = 't139');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t140history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c01` AS `C01`,`a`.`c02` AS `C02`,`a`.`c03` AS `C03`,`a`.`c04` AS `C04` from `data_data_history` `a` where (`a`.`dataclassCode` = 't140');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t141history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c01` AS `C01`,`a`.`c02` AS `C02` from `data_data_history` `a` where (`a`.`dataclassCode` = 't141');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t142history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c01` AS `C01` from `data_data_history` `a` where (`a`.`dataclassCode` = 't142');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t143history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c01` AS `C01` from `data_data_history` `a` where (`a`.`dataclassCode` = 't143');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t144history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId` from `data_data_history` `a` where (`a`.`dataclassCode` = 't144');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t145history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId` from `data_data_history` `a` where (`a`.`dataclassCode` = 't145');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t146history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c01` AS `C01`,`a`.`c02` AS `C02`,`a`.`c03` AS `C03`,`a`.`c04` AS `C04`,`a`.`c05` AS `C05`,`a`.`c06` AS `C06`,`a`.`c07` AS `C07` from `data_data_history` `a` where (`a`.`dataclassCode` = 't146');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t147history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c01` AS `C01`,`a`.`c02` AS `C02`,`a`.`c03` AS `C03`,`a`.`c04` AS `C04`,`a`.`c05` AS `C05`,`a`.`c06` AS `C06`,`a`.`c07` AS `C07` from `data_data_history` `a` where (`a`.`dataclassCode` = 't147');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t148history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId` from `data_data_history` `a` where (`a`.`dataclassCode` = 't148');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t149history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c01` AS `C01`,`a`.`c02` AS `C02`,`a`.`c03` AS `C03`,`a`.`c04` AS `C04`,`a`.`c05` AS `C05`,`a`.`c06` AS `C06`,`a`.`c07` AS `C07` from `data_data_history` `a` where (`a`.`dataclassCode` = 't149');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t150history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,ifnull((select `b`.`c10` from `t119` `b` where (`b`.`id` = `a`.`c01`)),`a`.`c01`) AS `c01`,ifnull((select `b`.`c02` from `t116` `b` where (`b`.`id` = `a`.`c02`)),`a`.`c02`) AS `c02`,ifnull((select `b`.`c03` from `t116` `b` where (`b`.`id` = `a`.`c03`)),`a`.`c03`) AS `c03`,`a`.`c04` AS `C04`,ifnull((select `b`.`c02` from `t126` `b` where (`b`.`id` = `a`.`c05`)),`a`.`c05`) AS `c05` from `data_data_history` `a` where (`a`.`dataclassCode` = 't150');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t151history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c06` AS `C06`,ifnull((select `b`.`c01` from `t111` `b` where (`b`.`id` = `a`.`c01`)),`a`.`c01`) AS `c01`,ifnull((select `b`.`c02` from `t111` `b` where (`b`.`id` = `a`.`c05`)),`a`.`c05`) AS `c05`,`a`.`c02` AS `C02`,`a`.`c04` AS `C04`,`a`.`c03` AS `C03`,`a`.`c07` AS `C07` from `data_data_history` `a` where (`a`.`dataclassCode` = 't151');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t152history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,ifnull((select `b`.`c01` from `t111` `b` where (`b`.`id` = `a`.`c01`)),`a`.`c01`) AS `c01`,ifnull((select `b`.`c02` from `t111` `b` where (`b`.`id` = `a`.`c02`)),`a`.`c02`) AS `c02`,ifnull((select `b`.`c02` from `t126` `b` where (`b`.`id` = `a`.`c03`)),`a`.`c03`) AS `c03`,ifnull((select `b`.`c04` from `t126` `b` where (`b`.`id` = `a`.`c04`)),`a`.`c04`) AS `c04`,`a`.`c11` AS `C11`,`a`.`c05` AS `C05`,`a`.`c06` AS `C06`,`a`.`c07` AS `C07`,`a`.`c08` AS `C08`,`a`.`c09` AS `C09`,`a`.`c10` AS `C10`,`a`.`c12` AS `C12`,`a`.`c13` AS `C13`,`a`.`c14` AS `C14`,`a`.`c15` AS `C15`,`a`.`c16` AS `C16`,`a`.`c17` AS `C17`,`a`.`c18` AS `C18`,`a`.`c19` AS `C19`,`a`.`c20` AS `C20`,`a`.`c21` AS `C21`,`a`.`c22` AS `C22`,`a`.`c23` AS `C23`,`a`.`c24` AS `C24`,`a`.`c25` AS `C25`,`a`.`c26` AS `C26`,`a`.`c27` AS `C27`,`a`.`c28` AS `C28` from `data_data_history` `a` where (`a`.`dataclassCode` = 't152');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t153history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,ifnull((select `b`.`c01` from `t111` `b` where (`b`.`id` = `a`.`c01`)),`a`.`c01`) AS `c01`,ifnull((select `b`.`c02` from `t111` `b` where (`b`.`id` = `a`.`c02`)),`a`.`c02`) AS `c02`,ifnull((select `b`.`c02` from `t126` `b` where (`b`.`id` = `a`.`c03`)),`a`.`c03`) AS `c03`,ifnull((select `b`.`c04` from `t126` `b` where (`b`.`id` = `a`.`c04`)),`a`.`c04`) AS `c04`,`a`.`c05` AS `C05`,`a`.`c06` AS `C06`,`a`.`c07` AS `C07`,`a`.`c08` AS `C08`,`a`.`c09` AS `C09`,`a`.`c10` AS `C10`,`a`.`c11` AS `C11`,`a`.`c12` AS `C12`,`a`.`c13` AS `C13`,`a`.`c14` AS `C14`,`a`.`c15` AS `C15`,`a`.`c16` AS `C16`,`a`.`c17` AS `C17`,`a`.`c18` AS `C18`,`a`.`c19` AS `C19`,`a`.`c20` AS `C20`,`a`.`c21` AS `C21`,`a`.`c22` AS `C22`,`a`.`c23` AS `C23`,`a`.`c24` AS `C24`,`a`.`c25` AS `C25`,`a`.`c26` AS `C26`,`a`.`c27` AS `C27`,`a`.`c28` AS `C28`,`a`.`c29` AS `C29`,`a`.`c30` AS `C30`,`a`.`c31` AS `C31` from `data_data_history` `a` where (`a`.`dataclassCode` = 't153');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t154history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,ifnull((select `b`.`c01` from `t111` `b` where (`b`.`id` = `a`.`c01`)),`a`.`c01`) AS `c01`,ifnull((select `b`.`c02` from `t126` `b` where (`b`.`id` = `a`.`c02`)),`a`.`c02`) AS `c02`,`a`.`c03` AS `C03`,`a`.`c04` AS `C04`,`a`.`c05` AS `C05`,`a`.`c06` AS `C06`,`a`.`c07` AS `C07`,`a`.`c08` AS `C08`,ifnull((select `b`.`c06` from `t151` `b` where (`b`.`id` = `a`.`c09`)),`a`.`c09`) AS `c09`,ifnull((select `b`.`c02` from `t111` `b` where (`b`.`id` = `a`.`c10`)),`a`.`c10`) AS `c10`,ifnull((select `b`.`c04` from `t126` `b` where (`b`.`id` = `a`.`c11`)),`a`.`c11`) AS `c11` from `data_data_history` `a` where (`a`.`dataclassCode` = 't154');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t155history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c01` AS `C01`,`a`.`c03` AS `C03`,`a`.`c02` AS `C02`,`a`.`c04` AS `C04` from `data_data_history` `a` where (`a`.`dataclassCode` = 't155');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t156history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,ifnull((select `b`.`c01` from `t111` `b` where (`b`.`id` = `a`.`c01`)),`a`.`c01`) AS `c01`,ifnull((select `b`.`c02` from `t111` `b` where (`b`.`id` = `a`.`c02`)),`a`.`c02`) AS `c02` from `data_data_history` `a` where (`a`.`dataclassCode` = 't156');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t157history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c01` AS `C01`,`a`.`c02` AS `C02` from `data_data_history` `a` where (`a`.`dataclassCode` = 't157');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t158history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c01` AS `C01`,`a`.`c02` AS `C02`,`a`.`c03` AS `C03`,`a`.`c04` AS `C04` from `data_data_history` `a` where (`a`.`dataclassCode` = 't158');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t159history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,ifnull((select `b`.`c02` from `t126` `b` where (`b`.`id` = `a`.`c01`)),`a`.`c01`) AS `c01`,ifnull((select `b`.`c04` from `t126` `b` where (`b`.`id` = `a`.`c02`)),`a`.`c02`) AS `c02`,`a`.`c03` AS `C03`,`a`.`c04` AS `C04`,`a`.`c05` AS `C05`,`a`.`c06` AS `C06`,`a`.`c07` AS `C07`,`a`.`c08` AS `C08`,`a`.`c09` AS `C09`,`a`.`c10` AS `C10`,`a`.`c11` AS `C11`,`a`.`c12` AS `C12`,`a`.`c13` AS `C13`,`a`.`c14` AS `C14`,`a`.`c15` AS `C15`,`a`.`c16` AS `C16`,`a`.`c17` AS `C17`,`a`.`c18` AS `C18`,`a`.`c19` AS `C19` from `data_data_history` `a` where (`a`.`dataclassCode` = 't159');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t160history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c01` AS `C01`,`a`.`c02` AS `C02` from `data_data_history` `a` where (`a`.`dataclassCode` = 't160');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t161history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c01` AS `C01`,ifnull((select `b`.`c01` from `t111` `b` where (`b`.`id` = `a`.`c02`)),`a`.`c02`) AS `c02`,ifnull((select `b`.`c02` from `t111` `b` where (`b`.`id` = `a`.`c03`)),`a`.`c03`) AS `c03`,`a`.`c04` AS `C04`,`a`.`c05` AS `C05`,ifnull((select `b`.`c02` from `t116` `b` where (`b`.`id` = `a`.`c06`)),`a`.`c06`) AS `c06`,ifnull((select `b`.`c03` from `t116` `b` where (`b`.`id` = `a`.`c07`)),`a`.`c07`) AS `c07` from `data_data_history` `a` where (`a`.`dataclassCode` = 't161');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t162history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c01` AS `C01`,`a`.`c02` AS `C02`,`a`.`c03` AS `C03`,`a`.`c04` AS `C04`,`a`.`c05` AS `C05`,`a`.`c06` AS `C06`,`a`.`c07` AS `C07`,`a`.`c08` AS `C08` from `data_data_history` `a` where (`a`.`dataclassCode` = 't162');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t163history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c01` AS `C01`,`a`.`c02` AS `C02`,`a`.`c03` AS `C03`,`a`.`c04` AS `C04`,`a`.`c05` AS `C05` from `data_data_history` `a` where (`a`.`dataclassCode` = 't163');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t164history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,ifnull((select `b`.`c01` from `t111` `b` where (`b`.`id` = `a`.`c01`)),`a`.`c01`) AS `c01`,ifnull((select `b`.`c02` from `t111` `b` where (`b`.`id` = `a`.`c02`)),`a`.`c02`) AS `c02`,ifnull((select `b`.`c02` from `t126` `b` where (`b`.`id` = `a`.`c03`)),`a`.`c03`) AS `c03`,ifnull((select `b`.`c04` from `t126` `b` where (`b`.`id` = `a`.`c04`)),`a`.`c04`) AS `c04`,`a`.`c05` AS `C05`,`a`.`c06` AS `C06`,`a`.`c07` AS `C07`,`a`.`c08` AS `C08`,`a`.`c09` AS `C09`,`a`.`c10` AS `C10`,`a`.`c11` AS `C11`,`a`.`c12` AS `C12`,`a`.`c13` AS `C13`,`a`.`c14` AS `C14`,`a`.`c15` AS `C15`,`a`.`c16` AS `C16`,`a`.`c17` AS `C17`,`a`.`c18` AS `C18`,`a`.`c19` AS `C19`,`a`.`c20` AS `C20`,`a`.`c21` AS `C21`,`a`.`c22` AS `C22`,`a`.`c23` AS `C23`,`a`.`c24` AS `C24`,`a`.`c25` AS `C25` from `data_data_history` `a` where (`a`.`dataclassCode` = 't164');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t165history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c01` AS `C01`,`a`.`c02` AS `C02`,`a`.`c03` AS `C03`,`a`.`c04` AS `C04`,`a`.`c05` AS `C05` from `data_data_history` `a` where (`a`.`dataclassCode` = 't165');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`192.168.2.109` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t166history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c02` AS `C02`,`a`.`c01` AS `C01`,`a`.`c03` AS `C03`,`a`.`c04` AS `C04`,`a`.`c05` AS `C05`,`a`.`c06` AS `C06` from `data_data_history` `a` where (`a`.`dataclassCode` = 't166');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`localhost` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t167history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,ifnull((select `b`.`c02` from `t126` `b` where (`b`.`id` = `a`.`c01`)),`a`.`c01`) AS `c01`,ifnull((select `b`.`c04` from `t126` `b` where (`b`.`id` = `a`.`c02`)),`a`.`c02`) AS `c02`,`a`.`c03` AS `C03`,`a`.`c04` AS `C04`,`a`.`c05` AS `C05`,`a`.`c06` AS `C06`,`a`.`c07` AS `C07`,ifnull((select `b`.`c14` from `t126` `b` where (`b`.`id` = `a`.`c08`)),`a`.`c08`) AS `c08` from `data_data_history` `a` where (`a`.`dataclassCode` = 't167');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t168history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,ifnull((select `b`.`c01` from `t111` `b` where (`b`.`id` = `a`.`c01`)),`a`.`c01`) AS `c01`,`a`.`c02` AS `C02` from `data_data_history` `a` where (`a`.`dataclassCode` = 't168');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t169history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,ifnull((select `b`.`c01` from `t111` `b` where (`b`.`id` = `a`.`c01`)),`a`.`c01`) AS `c01`,`a`.`c02` AS `C02`,`a`.`c03` AS `C03` from `data_data_history` `a` where (`a`.`dataclassCode` = 't169');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t170history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c02` AS `C02`,`a`.`c03` AS `C03`,`a`.`c01` AS `C01`,`a`.`c10` AS `C10`,`a`.`c04` AS `C04`,`a`.`c05` AS `C05`,`a`.`c06` AS `C06`,`a`.`c07` AS `C07`,`a`.`c08` AS `C08`,`a`.`c09` AS `C09`,`a`.`c11` AS `C11`,`a`.`c12` AS `C12` from `data_data_history` `a` where (`a`.`dataclassCode` = 't170');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t171history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,ifnull((select `b`.`c02` from `t116` `b` where (`b`.`id` = `a`.`c01`)),`a`.`c01`) AS `c01`,`a`.`c02` AS `C02`,`a`.`c03` AS `C03`,`a`.`c04` AS `C04` from `data_data_history` `a` where (`a`.`dataclassCode` = 't171');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t172history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c01` AS `C01`,`a`.`c02` AS `C02`,`a`.`c03` AS `C03` from `data_data_history` `a` where (`a`.`dataclassCode` = 't172');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t173history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,ifnull((select `b`.`c02` from `t126` `b` where (`b`.`id` = `a`.`c01`)),`a`.`c01`) AS `c01`,ifnull((select `b`.`c04` from `t126` `b` where (`b`.`id` = `a`.`c02`)),`a`.`c02`) AS `c02`,`a`.`c03` AS `C03`,`a`.`c04` AS `C04`,`a`.`c05` AS `C05`,`a`.`c06` AS `C06`,`a`.`c07` AS `C07`,`a`.`c08` AS `C08`,`a`.`c09` AS `C09`,`a`.`c10` AS `C10`,`a`.`c11` AS `C11`,`a`.`c12` AS `C12` from `data_data_history` `a` where (`a`.`dataclassCode` = 't173');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t177history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,ifnull((select `b`.`c02` from `t126` `b` where (`b`.`id` = `a`.`c01`)),`a`.`c01`) AS `c01`,ifnull((select `b`.`c04` from `t126` `b` where (`b`.`id` = `a`.`c02`)),`a`.`c02`) AS `c02`,`a`.`c03` AS `C03`,`a`.`c04` AS `C04`,`a`.`c05` AS `C05`,`a`.`c06` AS `C06`,`a`.`c07` AS `C07`,`a`.`c08` AS `C08` from `data_data_history` `a` where (`a`.`dataclassCode` = 't177');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t178history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c04` AS `C04`,`a`.`c01` AS `C01`,`a`.`c02` AS `C02`,`a`.`c03` AS `C03` from `data_data_history` `a` where (`a`.`dataclassCode` = 't178');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t179history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,ifnull((select `b`.`c04` from `t126` `b` where (`b`.`id` = `a`.`c01`)),`a`.`c01`) AS `c01`,`a`.`c02` AS `C02`,`a`.`c03` AS `C03`,`a`.`c04` AS `C04`,`a`.`c05` AS `C05`,`a`.`c06` AS `C06`,`a`.`c07` AS `C07`,`a`.`c08` AS `C08`,`a`.`c09` AS `C09`,`a`.`c10` AS `C10`,`a`.`c11` AS `C11`,`a`.`c12` AS `C12` from `data_data_history` `a` where (`a`.`dataclassCode` = 't179');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t180history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId` from `data_data_history` `a` where (`a`.`dataclassCode` = 't180');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`localhost` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t181history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c01` AS `C01`,`a`.`c02` AS `C02`,ifnull((select `b`.`c02` from `t111` `b` where (`b`.`id` = `a`.`c03`)),`a`.`c03`) AS `c03`,`a`.`c04` AS `C04`,`a`.`c05` AS `C05`,`a`.`c06` AS `C06`,`a`.`c07` AS `C07`,`a`.`c08` AS `C08` from `data_data_history` `a` where (`a`.`dataclassCode` = 't181');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t187history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c01` AS `C01`,`a`.`c02` AS `C02`,`a`.`c03` AS `C03` from `data_data_history` `a` where (`a`.`dataclassCode` = 't187');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t188history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c01` AS `C01`,`a`.`c02` AS `C02`,`a`.`c03` AS `C03`,`a`.`c04` AS `C04` from `data_data_history` `a` where (`a`.`dataclassCode` = 't188');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`localhost` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`t189history` AS select `a`.`id` AS `id`,`a`.`dataId` AS `dataId`,`a`.`operateType` AS `operateType`,`a`.`operateId` AS `operateId`,`a`.`operateTime` AS `operateTime`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c01` AS `C01`,`a`.`c02` AS `C02` from `data_data_history` `a` where (`a`.`dataclassCode` = 't189');

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_data_relation` AS select `a`.`datasetCode` AS `datasetCode`,`a`.`datasetName` AS `datasetName`,`b`.`dataclassCode` AS `dataclassCode`,`b`.`dataclassName` AS `dataclassName`,`c`.`dataitemCode` AS `dataitemCode`,`c`.`dataitemName` AS `dataitemName`,concat(`b`.`dataclassCode`,'.',`c`.`dataitemCode`) AS `classAndItem` from ((`data_set` `a` join `data_class` `b` on((`a`.`datasetCode` = `b`.`datasetCode`))) join `data_item` `c` on((`b`.`dataclassCode` = `c`.`dataclassCode`))) order by concat(`b`.`dataclassCode`,'.',`c`.`dataitemCode`);

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t109` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c01` AS `C01`,`a`.`c02` AS `C02`,`a`.`c03` AS `C03`,`a`.`c04` AS `C04`,`a`.`c05` AS `C05`,`a`.`c06` AS `C06` from `t109` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t111` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c01` AS `C01`,`a`.`c02` AS `C02`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'locale') and (`d`.`id` = `a`.`c03`))),'') AS `c03`,`a`.`c04` AS `C04`,`a`.`c24` AS `C24`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'nature') and (`d`.`id` = `a`.`c05`))),'') AS `c05`,`a`.`c06` AS `C06`,`a`.`c07` AS `C07`,`a`.`c08` AS `C08`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'subjection') and (`d`.`id` = `a`.`c09`))),'') AS `c09`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'grade') and (`d`.`id` = `a`.`c10`))),'') AS `c10`,ifnull((select `b`.`c02` from `t111` `b` where (`b`.`id` = `a`.`c11`)),`a`.`c11`) AS `c11`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'finSupport') and (`d`.`id` = `a`.`c12`))),'') AS `c12`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'wageScheme') and (`d`.`id` = `a`.`c13`))),'') AS `c13`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'finPay') and (`d`.`id` = `a`.`c14`))),'') AS `c14`,`a`.`c15` AS `C15`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'pubInsType') and (`d`.`id` = `a`.`c16`))),'') AS `c16`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'pubInsFundSrc') and (`d`.`id` = `a`.`c17`))),'') AS `c17`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'pubInsIndustry') and (`d`.`id` = `a`.`c18`))),'') AS `c18`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'is') and (`d`.`id` = `a`.`c19`))),'') AS `c19`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'dwjblb') and (`d`.`id` = `a`.`c20`))),'') AS `c20`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'ghblb') and (`d`.`id` = `a`.`c21`))),'') AS `c21`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'is') and (`d`.`id` = `a`.`c22`))),'') AS `c22`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'ghblb') and (`d`.`id` = `a`.`c23`))),'') AS `c23`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'qtbz') and (`d`.`id` = `a`.`c25`))),'') AS `c25`,`a`.`c26` AS `C26`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'locale') and (`d`.`id` = `a`.`c27`))),'') AS `c27` from `t111` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t112` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,ifnull((select `b`.`c01` from `t111` `b` where (`b`.`id` = `a`.`c01`)),`a`.`c01`) AS `c01`,`a`.`c15` AS `C15`,`a`.`c14` AS `C14`,`a`.`c02` AS `C02`,`a`.`c03` AS `C03`,`a`.`c04` AS `C04`,`a`.`c05` AS `C05`,`a`.`c06` AS `C06`,`a`.`c16` AS `C16`,`a`.`c17` AS `C17`,`a`.`c07` AS `C07`,`a`.`c08` AS `C08`,`a`.`c09` AS `C09`,`a`.`c10` AS `C10`,`a`.`c11` AS `C11`,`a`.`c12` AS `C12`,`a`.`c13` AS `C13`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'bzshzt') and (`d`.`id` = `a`.`c18`))),'') AS `c18`,`a`.`c19` AS `C19`,`a`.`c20` AS `C20`,`a`.`c21` AS `C21`,`a`.`c22` AS `C22`,`a`.`c23` AS `C23`,`a`.`c24` AS `C24`,`a`.`c25` AS `C25` from `t112` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t113` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId` from `t113` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t114` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c01` AS `C01`,`a`.`c02` AS `C02`,`a`.`c03` AS `C03`,`a`.`c04` AS `C04`,`a`.`c05` AS `C05`,`a`.`c06` AS `C06`,`a`.`c07` AS `C07`,`a`.`c08` AS `C08`,`a`.`c09` AS `C09`,`a`.`c10` AS `C10`,`a`.`c11` AS `C11`,`a`.`c12` AS `C12`,`a`.`c13` AS `C13`,`a`.`c14` AS `C14`,`a`.`c15` AS `C15`,`a`.`c16` AS `C16`,ifnull((select `b`.`c02` from `t113` `b` where (`b`.`id` = `a`.`c17`)),`a`.`c17`) AS `c17`,`a`.`c18` AS `C18`,`a`.`c19` AS `C19`,`a`.`c20` AS `C20`,`a`.`c21` AS `C21`,`a`.`c22` AS `C22`,`a`.`c23` AS `C23`,`a`.`c24` AS `C24`,`a`.`c25` AS `C25`,`a`.`c26` AS `C26`,`a`.`c27` AS `C27`,`a`.`c28` AS `C28`,`a`.`c29` AS `C29`,`a`.`c30` AS `C30`,`a`.`c31` AS `C31`,`a`.`c32` AS `C32`,`a`.`c33` AS `C33`,`a`.`c34` AS `C34`,`a`.`c35` AS `C35`,`a`.`c36` AS `C36`,`a`.`c37` AS `C37`,`a`.`c38` AS `C38`,`a`.`c39` AS `C39`,`a`.`c40` AS `C40`,`a`.`c41` AS `C41`,`a`.`c42` AS `C42`,`a`.`c43` AS `C43`,`a`.`c44` AS `C44`,`a`.`c45` AS `C45`,`a`.`c46` AS `C46`,`a`.`c47` AS `C47`,`a`.`c48` AS `C48`,`a`.`c49` AS `C49`,`a`.`c50` AS `C50` from `t114` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t115` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,ifnull((select `b`.`c01` from `t111` `b` where (`b`.`id` = `a`.`c02`)),`a`.`c02`) AS `c02`,ifnull((select `b`.`c02` from `t116` `b` where (`b`.`id` = `a`.`c03`)),`a`.`c03`) AS `c03`,ifnull((select `b`.`c03` from `t116` `b` where (`b`.`id` = `a`.`c04`)),`a`.`c04`) AS `c04`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'supplyMonType') and (`d`.`id` = `a`.`c05`))),'') AS `c05`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'is') and (`d`.`id` = `a`.`c06`))),'') AS `c06`,`a`.`c07` AS `C07`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'is') and (`d`.`id` = `a`.`c01`))),'') AS `c01`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'wageScheme') and (`d`.`id` = `a`.`c08`))),'') AS `c08`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'is') and (`d`.`id` = `a`.`c09`))),'') AS `c09`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'wageScheme') and (`d`.`id` = `a`.`c10`))),'') AS `c10`,`a`.`c11` AS `C11`,`a`.`c12` AS `C12` from `t115` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t116` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c02` AS `C02`,`a`.`c03` AS `C03`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'supplyMonType') and (`d`.`id` = `a`.`c04`))),'') AS `c04`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'is') and (`d`.`id` = `a`.`c01`))),'') AS `c01`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'wageScheme') and (`d`.`id` = `a`.`c05`))),'') AS `c05`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'is') and (`d`.`id` = `a`.`c06`))),'') AS `c06`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'wageScheme') and (`d`.`id` = `a`.`c07`))),'') AS `c07`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'is') and (`d`.`id` = `a`.`c08`))),'') AS `c08`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'is') and (`d`.`id` = `a`.`c09`))),'') AS `c09`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'is') and (`d`.`id` = `a`.`c10`))),'') AS `c10`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'is') and (`d`.`id` = `a`.`c11`))),'') AS `c11`,`a`.`c12` AS `C12` from `t116` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t117` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c01` AS `C01`,ifnull((select `b`.`c01` from `t111` `b` where (`b`.`id` = `a`.`c02`)),`a`.`c02`) AS `c02`,ifnull((select `b`.`c02` from `t126` `b` where (`b`.`id` = `a`.`c03`)),`a`.`c03`) AS `c03`,ifnull((select `b`.`c02` from `t116` `b` where (`b`.`id` = `a`.`c04`)),`a`.`c04`) AS `c04`,ifnull((select `b`.`c03` from `t116` `b` where (`b`.`id` = `a`.`c05`)),`a`.`c05`) AS `c05`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'supplyMonType') and (`d`.`id` = `a`.`c06`))),'') AS `c06`,`a`.`c07` AS `C07`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'jfshfbl') and (`d`.`id` = `a`.`c08`))),'') AS `c08`,`a`.`c09` AS `C09`,`a`.`c10` AS `C10`,`a`.`c11` AS `C11`,`a`.`c12` AS `C12` from `t117` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t118` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,ifnull((select `b`.`c01` from `t111` `b` where (`b`.`id` = `a`.`c01`)),`a`.`c01`) AS `c01`,`a`.`c02` AS `C02`,`a`.`c03` AS `C03`,`a`.`c04` AS `C04`,`a`.`c05` AS `C05`,`a`.`c06` AS `C06`,`a`.`c07` AS `C07`,`a`.`c08` AS `C08`,`a`.`c09` AS `C09`,`a`.`c10` AS `C10`,`a`.`c11` AS `C11`,`a`.`c12` AS `C12`,`a`.`c13` AS `C13`,`a`.`c14` AS `C14`,`a`.`c15` AS `C15`,`a`.`c16` AS `C16` from `t118` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`localhost` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t119` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c20` AS `C20`,`a`.`c10` AS `C10`,ifnull((select `b`.`c01` from `t111` `b` where (`b`.`id` = `a`.`c04`)),`a`.`c04`) AS `c04`,ifnull((select `b`.`c02` from `t111` `b` where (`b`.`id` = `a`.`c18`)),`a`.`c18`) AS `c18`,ifnull((select `b`.`c02` from `t126` `b` where (`b`.`id` = `a`.`c01`)),`a`.`c01`) AS `c01`,ifnull((select `b`.`c04` from `t126` `b` where (`b`.`id` = `a`.`c19`)),`a`.`c19`) AS `c19`,`a`.`c02` AS `C02`,`a`.`c03` AS `C03`,`a`.`c05` AS `C05`,`a`.`c06` AS `C06`,`a`.`c07` AS `C07`,`a`.`c11` AS `C11`,`a`.`c12` AS `C12`,`a`.`c13` AS `C13`,`a`.`c14` AS `C14`,`a`.`c15` AS `C15`,`a`.`c16` AS `C16`,`a`.`c17` AS `C17`,`a`.`c08` AS `C08`,`a`.`c09` AS `C09`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'ybshzt') and (`d`.`id` = `a`.`c21`))),'') AS `c21`,`a`.`c22` AS `C22`,`a`.`c23` AS `C23`,`a`.`c24` AS `C24`,`a`.`c25` AS `C25`,`a`.`c26` AS `C26`,`a`.`c27` AS `C27` from `t119` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t120` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'rysf') and (`d`.`id` = `a`.`c01`))),'') AS `c01`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'ryxj') and (`d`.`id` = `a`.`c02`))),'') AS `c02`,`a`.`c03` AS `C03`,`a`.`c04` AS `C04` from `t120` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t121` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,ifnull((select `b`.`c01` from `t111` `b` where (`b`.`id` = `a`.`c03`)),`a`.`c03`) AS `c03`,ifnull((select `b`.`c02` from `t126` `b` where (`b`.`id` = `a`.`c02`)),`a`.`c02`) AS `c02`,ifnull((select `b`.`c04` from `t126` `b` where (`b`.`id` = `a`.`c01`)),`a`.`c01`) AS `c01`,`a`.`c04` AS `C04`,`a`.`c05` AS `C05`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'ryzj') and (`d`.`id` = `a`.`c06`))),'') AS `c06`,`a`.`c07` AS `C07`,`a`.`c08` AS `C08` from `t121` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t122` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId` from `t122` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t123` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c06` AS `C06`,`a`.`c01` AS `C01`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'locale') and (`d`.`id` = `a`.`c05`))),'') AS `c05`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'wageScheme') and (`d`.`id` = `a`.`c02`))),'') AS `c02`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'dwjblb') and (`d`.`id` = `a`.`c09`))),'') AS `c09`,ifnull((select `b`.`c02` from `t116` `b` where (`b`.`id` = `a`.`c03`)),`a`.`c03`) AS `c03`,ifnull((select `b`.`c03` from `t116` `b` where (`b`.`id` = `a`.`c04`)),`a`.`c04`) AS `c04`,ifnull((select `b`.`c05` from `t127` `b` where (`b`.`id` = `a`.`c07`)),`a`.`c07`) AS `c07`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'ryxj') and (`d`.`id` = `a`.`c08`))),'') AS `c08`,`a`.`c10` AS `C10`,`a`.`c11` AS `C11` from `t123` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t124` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c01` AS `C01`,ifnull((select `b`.`c01` from `t111` `b` where (`b`.`id` = `a`.`c02`)),`a`.`c02`) AS `c02`,ifnull((select `b`.`c02` from `t126` `b` where (`b`.`id` = `a`.`c03`)),`a`.`c03`) AS `c03`,ifnull((select `b`.`c04` from `t126` `b` where (`b`.`id` = `a`.`c04`)),`a`.`c04`) AS `c04`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'assResult') and (`d`.`id` = `a`.`c05`))),'') AS `c05` from `t124` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t125` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c02` AS `C02`,ifnull((select `b`.`c01` from `t111` `b` where (`b`.`id` = `a`.`c05`)),`a`.`c05`) AS `c05`,ifnull((select `b`.`c02` from `t126` `b` where (`b`.`id` = `a`.`c06`)),`a`.`c06`) AS `c06`,ifnull((select `b`.`c04` from `t126` `b` where (`b`.`id` = `a`.`c33`)),`a`.`c33`) AS `c33`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'ryxj') and (`d`.`id` = `a`.`c24`))),'') AS `c24`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'wageSystem') and (`d`.`id` = `a`.`c36`))),'') AS `c36`,ifnull((select `b`.`c05` from `t127` `b` where (`b`.`id` = `a`.`c07`)),`a`.`c07`) AS `c07`,`a`.`c08` AS `C08`,ifnull((select `b`.`c04` from `t127` `b` where (`b`.`id` = `a`.`c09`)),`a`.`c09`) AS `c09`,`a`.`c10` AS `C10`,`a`.`c42` AS `C42`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'is') and (`d`.`id` = `a`.`c01`))),'') AS `c01`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'is') and (`d`.`id` = `a`.`c03`))),'') AS `c03`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'is') and (`d`.`id` = `a`.`c23`))),'') AS `c23`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'is') and (`d`.`id` = `a`.`c35`))),'') AS `c35`,`a`.`c11` AS `C11`,`a`.`c12` AS `C12`,`a`.`c13` AS `C13`,`a`.`c14` AS `C14`,`a`.`c15` AS `C15`,`a`.`c16` AS `C16`,`a`.`c17` AS `C17`,`a`.`c18` AS `C18`,`a`.`c19` AS `C19`,`a`.`c20` AS `C20`,`a`.`c21` AS `C21`,`a`.`c22` AS `C22`,`a`.`c25` AS `C25`,`a`.`c26` AS `C26`,`a`.`c28` AS `C28`,`a`.`c29` AS `C29`,`a`.`c44` AS `C44`,`a`.`c45` AS `C45`,`a`.`c30` AS `C30`,`a`.`c47` AS `C47`,`a`.`c31` AS `C31`,`a`.`c27` AS `C27`,`a`.`c32` AS `C32`,`a`.`c34` AS `C34`,`a`.`c04` AS `C04`,`a`.`c48` AS `C48`,`a`.`c37` AS `C37`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'is') and (`d`.`id` = `a`.`c39`))),'') AS `c39`,`a`.`c38` AS `C38`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'is') and (`d`.`id` = `a`.`c40`))),'') AS `c40`,`a`.`c41` AS `C41`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'isLeader') and (`d`.`id` = `a`.`c43`))),'') AS `c43`,ifnull((select `b`.`c05` from `t127` `b` where (`b`.`id` = `a`.`c46`)),`a`.`c46`) AS `c46`,`a`.`c49` AS `C49`,`a`.`c50` AS `C50` from `t125` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t126` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,ifnull((select `b`.`c01` from `t111` `b` where (`b`.`id` = `a`.`c01`)),`a`.`c01`) AS `c01`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'staffStatus') and (`d`.`id` = `a`.`c03`))),'') AS `c03`,`a`.`c02` AS `C02`,`a`.`c04` AS `C04`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'rysf') and (`d`.`id` = `a`.`c28`))),'') AS `c28`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'sex') and (`d`.`id` = `a`.`c05`))),'') AS `c05`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'nation') and (`d`.`id` = `a`.`c06`))),'') AS `c06`,`a`.`c07` AS `C07`,`a`.`c08` AS `C08`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'eduLevel') and (`d`.`id` = `a`.`c09`))),'') AS `c09`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'degree') and (`d`.`id` = `a`.`c10`))),'') AS `c10`,`a`.`c11` AS `C11`,`a`.`c12` AS `C12`,`a`.`c13` AS `C13`,ifnull((select `b`.`c03` from `t113` `b` where (`b`.`id` = `a`.`c15`)),`a`.`c15`) AS `c15`,`a`.`c14` AS `C14`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'staffFrom') and (`d`.`id` = `a`.`c16`))),'') AS `c16`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'gzbzlb') and (`d`.`id` = `a`.`c39`))),'') AS `c39`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'sjzj') and (`d`.`id` = `a`.`c36`))),'') AS `c36`,ifnull((select `b`.`c05` from `t127` `b` where (`b`.`id` = `a`.`c17`)),`a`.`c17`) AS `c17`,`a`.`c18` AS `C18`,ifnull((select `b`.`c04` from `t127` `b` where (`b`.`id` = `a`.`c27`)),`a`.`c27`) AS `c27`,`a`.`c19` AS `C19`,`a`.`c20` AS `C20`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'is') and (`d`.`id` = `a`.`c24`))),'') AS `c24`,`a`.`c25` AS `C25`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'is') and (`d`.`id` = `a`.`c22`))),'') AS `c22`,`a`.`c23` AS `C23`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'rybz') and (`d`.`id` = `a`.`c21`))),'') AS `c21`,`a`.`c26` AS `C26`,`a`.`c29` AS `C29`,`a`.`c30` AS `C30`,`a`.`c31` AS `C31`,`a`.`c32` AS `C32`,`a`.`c33` AS `C33`,`a`.`c34` AS `C34`,`a`.`c35` AS `C35`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'zzmm') and (`d`.`id` = `a`.`c37`))),'') AS `c37`,ifnull((select `b`.`c02` from `t111` `b` where (`b`.`id` = `a`.`c38`)),`a`.`c38`) AS `c38`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'bdlx') and (`d`.`id` = `a`.`c40`))),'') AS `c40`,`a`.`c41` AS `C41`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'is') and (`d`.`id` = `a`.`c42`))),'') AS `c42`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'is') and (`d`.`id` = `a`.`c43`))),'') AS `c43`,`a`.`c44` AS `C44`,`a`.`c45` AS `C45`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'ryqx') and (`d`.`id` = `a`.`c46`))),'') AS `c46`,`a`.`c47` AS `C47`,`a`.`c48` AS `C48`,`a`.`c49` AS `C49`,`a`.`c50` AS `C50` from `t126` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t127` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c01` AS `C01`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'rysf') and (`d`.`id` = `a`.`c02`))),'') AS `c02`,`a`.`c03` AS `C03`,`a`.`c04` AS `C04`,`a`.`c05` AS `C05`,`a`.`c06` AS `C06`,`a`.`c07` AS `C07`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'gzbzlb') and (`d`.`id` = `a`.`c08`))),'') AS `c08`,`a`.`c09` AS `C09` from `t127` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t128` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId` from `t128` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t129` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c01` AS `C01`,`a`.`c02` AS `C02`,`a`.`c03` AS `C03` from `t129` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t130` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c01` AS `C01`,`a`.`c02` AS `C02`,ifnull((select `b`.`c01` from `t111` `b` where (`b`.`id` = `a`.`c03`)),`a`.`c03`) AS `c03`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'sex') and (`d`.`id` = `a`.`c04`))),'') AS `c04`,`a`.`c05` AS `C05`,`a`.`c06` AS `C06` from `t130` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t131` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,ifnull((select `b`.`c02` from `t126` `b` where (`b`.`id` = `a`.`c01`)),`a`.`c01`) AS `c01`,ifnull((select `b`.`c04` from `t126` `b` where (`b`.`id` = `a`.`c02`)),`a`.`c02`) AS `c02`,`a`.`c03` AS `C03`,`a`.`c04` AS `C04`,`a`.`c05` AS `C05`,`a`.`c06` AS `C06`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'is') and (`d`.`id` = `a`.`c07`))),'') AS `c07`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'is') and (`d`.`id` = `a`.`c08`))),'') AS `c08`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'assResult') and (`d`.`id` = `a`.`c09`))),'') AS `c09`,`a`.`c10` AS `C10`,`a`.`c11` AS `C11`,`a`.`c12` AS `C12`,`a`.`c13` AS `C13`,`a`.`c14` AS `C14`,`a`.`c15` AS `C15`,`a`.`c16` AS `C16`,`a`.`c17` AS `C17`,`a`.`c18` AS `C18`,ifnull((select `b`.`c01` from `t111` `b` where (`b`.`id` = `a`.`c19`)),`a`.`c19`) AS `c19`,`a`.`c20` AS `C20`,`a`.`c21` AS `C21`,`a`.`c22` AS `C22`,`a`.`c23` AS `C23`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'is') and (`d`.`id` = `a`.`c24`))),'') AS `c24`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'is') and (`d`.`id` = `a`.`c25`))),'') AS `c25`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'is') and (`d`.`id` = `a`.`c26`))),'') AS `c26`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'rysf') and (`d`.`id` = `a`.`c27`))),'') AS `c27`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'eduLevel') and (`d`.`id` = `a`.`c28`))),'') AS `c28`,`a`.`c29` AS `C29`,`a`.`c30` AS `C30`,`a`.`c31` AS `C31`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'eduLevel') and (`d`.`id` = `a`.`c32`))),'') AS `c32`,ifnull((select `b`.`c05` from `t127` `b` where (`b`.`id` = `a`.`c33`)),`a`.`c33`) AS `c33`,ifnull((select `b`.`c04` from `t127` `b` where (`b`.`id` = `a`.`c34`)),`a`.`c34`) AS `c34`,`a`.`c35` AS `C35`,`a`.`c36` AS `C36`,`a`.`c37` AS `C37`,`a`.`c38` AS `C38`,`a`.`c39` AS `C39`,`a`.`c40` AS `C40`,`a`.`c41` AS `C41`,`a`.`c42` AS `C42`,`a`.`c43` AS `C43`,`a`.`c44` AS `C44`,`a`.`c45` AS `C45` from `t131` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t132` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId` from `t132` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t133` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId` from `t133` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t134` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId` from `t134` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t135` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c09` AS `C09`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'wageSystem') and (`d`.`id` = `a`.`c01`))),'') AS `c01`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'gzbzlb') and (`d`.`id` = `a`.`c02`))),'') AS `c02`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'eduLevel') and (`d`.`id` = `a`.`c03`))),'') AS `c03`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'sjzj') and (`d`.`id` = `a`.`c04`))),'') AS `c04`,ifnull((select `b`.`c05` from `t127` `b` where (`b`.`id` = `a`.`c05`)),`a`.`c05`) AS `c05`,ifnull((select `b`.`c04` from `t127` `b` where (`b`.`id` = `a`.`c06`)),`a`.`c06`) AS `c06`,ifnull((select `b`.`c05` from `t127` `b` where (`b`.`id` = `a`.`c07`)),`a`.`c07`) AS `c07`,ifnull((select `b`.`c04` from `t127` `b` where (`b`.`id` = `a`.`c08`)),`a`.`c08`) AS `c08` from `t135` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t136` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'wageScheme') and (`d`.`id` = `a`.`c01`))),'') AS `c01`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'rysf') and (`d`.`id` = `a`.`c02`))),'') AS `c02`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'staffStatus') and (`d`.`id` = `a`.`c03`))),'') AS `c03`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'gzbzlb') and (`d`.`id` = `a`.`c04`))),'') AS `c04`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'wageSystem') and (`d`.`id` = `a`.`c05`))),'') AS `c05`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'personSort ') and (`d`.`id` = `a`.`c06`))),'') AS `c06`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'txrylb') and (`d`.`id` = `a`.`c07`))),'') AS `c07`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'rysf') and (`d`.`id` = `a`.`c08`))),'') AS `c08` from `t136` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t137` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c01` AS `C01`,`a`.`c02` AS `C02`,`a`.`c03` AS `C03` from `t137` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t138` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c02` AS `C02`,`a`.`c03` AS `C03`,`a`.`c04` AS `C04`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'plgzbdyy') and (`d`.`id` = `a`.`c01`))),'') AS `c01`,`a`.`c05` AS `C05`,`a`.`c06` AS `C06`,ifnull((select `b`.`c01` from `t111` `b` where (`b`.`id` = `a`.`c07`)),`a`.`c07`) AS `c07` from `t138` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t139` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,ifnull((select `b`.`c01` from `t111` `b` where (`b`.`id` = `a`.`c01`)),`a`.`c01`) AS `c01`,`a`.`c02` AS `C02`,ifnull((select `b`.`c02` from `t130` `b` where (`b`.`id` = `a`.`c03`)),`a`.`c03`) AS `c03`,`a`.`c04` AS `C04` from `t139` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t140` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId` from `t140` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t141` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'bdlx') and (`d`.`id` = `a`.`c01`))),'') AS `c01`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'is') and (`d`.`id` = `a`.`c02`))),'') AS `c02` from `t141` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t142` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c01` AS `C01` from `t142` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t143` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c01` AS `C01` from `t143` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t144` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId` from `t144` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t145` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId` from `t145` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t146` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c01` AS `C01`,`a`.`c02` AS `C02`,`a`.`c03` AS `C03`,`a`.`c04` AS `C04`,`a`.`c05` AS `C05`,`a`.`c06` AS `C06`,`a`.`c07` AS `C07` from `t146` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t147` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId` from `t147` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t149` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c01` AS `C01`,`a`.`c02` AS `C02`,`a`.`c03` AS `C03`,`a`.`c04` AS `C04`,`a`.`c05` AS `C05`,`a`.`c06` AS `C06`,`a`.`c07` AS `C07` from `t149` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t150` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,ifnull((select `b`.`c10` from `t119` `b` where (`b`.`id` = `a`.`c01`)),`a`.`c01`) AS `c01`,ifnull((select `b`.`c02` from `t116` `b` where (`b`.`id` = `a`.`c02`)),`a`.`c02`) AS `c02`,ifnull((select `b`.`c03` from `t116` `b` where (`b`.`id` = `a`.`c03`)),`a`.`c03`) AS `c03`,`a`.`c04` AS `C04`,ifnull((select `b`.`c02` from `t126` `b` where (`b`.`id` = `a`.`c05`)),`a`.`c05`) AS `c05` from `t150` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t151` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c06` AS `C06`,ifnull((select `b`.`c01` from `t111` `b` where (`b`.`id` = `a`.`c01`)),`a`.`c01`) AS `c01`,ifnull((select `b`.`c02` from `t111` `b` where (`b`.`id` = `a`.`c05`)),`a`.`c05`) AS `c05`,`a`.`c02` AS `C02`,`a`.`c04` AS `C04`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'ybshzt') and (`d`.`id` = `a`.`c03`))),'') AS `c03`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'is') and (`d`.`id` = `a`.`c07`))),'') AS `c07` from `t151` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t152` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,ifnull((select `b`.`c01` from `t111` `b` where (`b`.`id` = `a`.`c01`)),`a`.`c01`) AS `c01`,ifnull((select `b`.`c02` from `t111` `b` where (`b`.`id` = `a`.`c02`)),`a`.`c02`) AS `c02`,ifnull((select `b`.`c02` from `t126` `b` where (`b`.`id` = `a`.`c03`)),`a`.`c03`) AS `c03`,ifnull((select `b`.`c04` from `t126` `b` where (`b`.`id` = `a`.`c04`)),`a`.`c04`) AS `c04`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'jclb') and (`d`.`id` = `a`.`c11`))),'') AS `c11`,`a`.`c05` AS `C05`,`a`.`c06` AS `C06`,`a`.`c07` AS `C07`,`a`.`c08` AS `C08`,`a`.`c09` AS `C09`,`a`.`c10` AS `C10`,`a`.`c12` AS `C12`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'ybshzt') and (`d`.`id` = `a`.`c13`))),'') AS `c13`,`a`.`c14` AS `C14`,`a`.`c15` AS `C15`,`a`.`c16` AS `C16`,`a`.`c17` AS `C17`,`a`.`c18` AS `C18`,`a`.`c19` AS `C19`,`a`.`c20` AS `C20`,`a`.`c21` AS `C21`,`a`.`c22` AS `C22`,`a`.`c23` AS `C23`,`a`.`c24` AS `C24`,`a`.`c25` AS `C25`,`a`.`c26` AS `C26`,`a`.`c27` AS `C27`,`a`.`c28` AS `C28` from `t152` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t153` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,ifnull((select `b`.`c01` from `t111` `b` where (`b`.`id` = `a`.`c01`)),`a`.`c01`) AS `c01`,ifnull((select `b`.`c02` from `t111` `b` where (`b`.`id` = `a`.`c02`)),`a`.`c02`) AS `c02`,ifnull((select `b`.`c02` from `t126` `b` where (`b`.`id` = `a`.`c03`)),`a`.`c03`) AS `c03`,ifnull((select `b`.`c04` from `t126` `b` where (`b`.`id` = `a`.`c04`)),`a`.`c04`) AS `c04`,`a`.`c05` AS `C05`,`a`.`c06` AS `C06`,`a`.`c07` AS `C07`,`a`.`c08` AS `C08`,`a`.`c09` AS `C09`,`a`.`c10` AS `C10`,`a`.`c11` AS `C11`,`a`.`c12` AS `C12`,`a`.`c13` AS `C13`,`a`.`c14` AS `C14`,`a`.`c15` AS `C15`,`a`.`c16` AS `C16`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'ybshzt') and (`d`.`id` = `a`.`c17`))),'') AS `c17`,`a`.`c18` AS `C18`,`a`.`c19` AS `C19`,`a`.`c20` AS `C20`,`a`.`c21` AS `C21`,`a`.`c22` AS `C22`,`a`.`c23` AS `C23`,`a`.`c24` AS `C24`,`a`.`c25` AS `C25`,`a`.`c26` AS `C26`,`a`.`c27` AS `C27`,`a`.`c28` AS `C28`,`a`.`c29` AS `C29`,`a`.`c30` AS `C30`,`a`.`c31` AS `C31` from `t153` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t154` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,ifnull((select `b`.`c01` from `t111` `b` where (`b`.`id` = `a`.`c01`)),`a`.`c01`) AS `c01`,ifnull((select `b`.`c02` from `t126` `b` where (`b`.`id` = `a`.`c02`)),`a`.`c02`) AS `c02`,`a`.`c03` AS `C03`,`a`.`c04` AS `C04`,`a`.`c05` AS `C05`,`a`.`c06` AS `C06`,`a`.`c07` AS `C07`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'wageSystem') and (`d`.`id` = `a`.`c08`))),'') AS `c08`,ifnull((select `b`.`c06` from `t151` `b` where (`b`.`id` = `a`.`c09`)),`a`.`c09`) AS `c09`,ifnull((select `b`.`c02` from `t111` `b` where (`b`.`id` = `a`.`c10`)),`a`.`c10`) AS `c10`,ifnull((select `b`.`c04` from `t126` `b` where (`b`.`id` = `a`.`c11`)),`a`.`c11`) AS `c11` from `t154` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t155` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'is') and (`d`.`id` = `a`.`c01`))),'') AS `c01`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'is') and (`d`.`id` = `a`.`c03`))),'') AS `c03`,`a`.`c02` AS `C02`,`a`.`c04` AS `C04` from `t155` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t156` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,ifnull((select `b`.`c01` from `t111` `b` where (`b`.`id` = `a`.`c01`)),`a`.`c01`) AS `c01`,ifnull((select `b`.`c02` from `t111` `b` where (`b`.`id` = `a`.`c02`)),`a`.`c02`) AS `c02` from `t156` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t157` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId` from `t157` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t158` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'finPay') and (`d`.`id` = `a`.`c01`))),'') AS `c01`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'finSupport') and (`d`.`id` = `a`.`c02`))),'') AS `c02`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'is') and (`d`.`id` = `a`.`c03`))),'') AS `c03`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'is') and (`d`.`id` = `a`.`c04`))),'') AS `c04` from `t158` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t159` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,ifnull((select `b`.`c02` from `t126` `b` where (`b`.`id` = `a`.`c01`)),`a`.`c01`) AS `c01`,ifnull((select `b`.`c04` from `t126` `b` where (`b`.`id` = `a`.`c02`)),`a`.`c02`) AS `c02`,`a`.`c03` AS `C03`,`a`.`c04` AS `C04`,`a`.`c05` AS `C05`,`a`.`c06` AS `C06`,`a`.`c07` AS `C07`,`a`.`c08` AS `C08`,`a`.`c09` AS `C09`,`a`.`c10` AS `C10`,`a`.`c11` AS `C11`,`a`.`c12` AS `C12`,`a`.`c13` AS `C13`,`a`.`c14` AS `C14`,`a`.`c15` AS `C15`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'jfbjgzbl') and (`d`.`id` = `a`.`c16`))),'') AS `c16`,`a`.`c17` AS `C17`,`a`.`c18` AS `C18`,`a`.`c19` AS `C19` from `t159` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t160` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c01` AS `C01`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'is') and (`d`.`id` = `a`.`c02`))),'') AS `c02` from `t160` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t161` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'gzbzgxfl') and (`d`.`id` = `a`.`c01`))),'') AS `c01`,ifnull((select `b`.`c01` from `t111` `b` where (`b`.`id` = `a`.`c02`)),`a`.`c02`) AS `c02`,ifnull((select `b`.`c02` from `t111` `b` where (`b`.`id` = `a`.`c03`)),`a`.`c03`) AS `c03`,`a`.`c04` AS `C04`,`a`.`c05` AS `C05`,ifnull((select `b`.`c02` from `t116` `b` where (`b`.`id` = `a`.`c06`)),`a`.`c06`) AS `c06`,ifnull((select `b`.`c03` from `t116` `b` where (`b`.`id` = `a`.`c07`)),`a`.`c07`) AS `c07` from `t161` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t162` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c01` AS `C01`,`a`.`c02` AS `C02`,`a`.`c03` AS `C03`,`a`.`c04` AS `C04`,`a`.`c05` AS `C05`,`a`.`c06` AS `C06`,`a`.`c07` AS `C07`,`a`.`c08` AS `C08` from `t162` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t163` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c01` AS `C01`,`a`.`c02` AS `C02`,`a`.`c03` AS `C03`,`a`.`c04` AS `C04`,`a`.`c05` AS `C05` from `t163` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t164` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,ifnull((select `b`.`c01` from `t111` `b` where (`b`.`id` = `a`.`c01`)),`a`.`c01`) AS `c01`,ifnull((select `b`.`c02` from `t111` `b` where (`b`.`id` = `a`.`c02`)),`a`.`c02`) AS `c02`,ifnull((select `b`.`c02` from `t126` `b` where (`b`.`id` = `a`.`c03`)),`a`.`c03`) AS `c03`,ifnull((select `b`.`c04` from `t126` `b` where (`b`.`id` = `a`.`c04`)),`a`.`c04`) AS `c04`,`a`.`c05` AS `C05`,`a`.`c06` AS `C06`,`a`.`c07` AS `C07`,`a`.`c08` AS `C08`,`a`.`c09` AS `C09`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'ybshzt') and (`d`.`id` = `a`.`c10`))),'') AS `c10`,`a`.`c11` AS `C11`,`a`.`c12` AS `C12`,`a`.`c13` AS `C13`,`a`.`c14` AS `C14`,`a`.`c15` AS `C15`,`a`.`c16` AS `C16`,`a`.`c17` AS `C17`,`a`.`c18` AS `C18`,`a`.`c19` AS `C19`,`a`.`c20` AS `C20`,`a`.`c21` AS `C21`,`a`.`c22` AS `C22`,`a`.`c23` AS `C23`,`a`.`c24` AS `C24`,`a`.`c25` AS `C25` from `t164` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t165` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c01` AS `C01`,`a`.`c02` AS `C02`,`a`.`c03` AS `C03`,`a`.`c04` AS `C04`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'gzbzlb') and (`d`.`id` = `a`.`c05`))),'') AS `c05` from `t165` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`192.168.2.109` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t166` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c02` AS `C02`,`a`.`c01` AS `C01`,`a`.`c03` AS `C03`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'is') and (`d`.`id` = `a`.`c04`))),'') AS `c04`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'tzlx') and (`d`.`id` = `a`.`c05`))),'') AS `c05`,`a`.`c06` AS `C06` from `t166` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`localhost` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t167` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,ifnull((select `b`.`c02` from `t126` `b` where (`b`.`id` = `a`.`c01`)),`a`.`c01`) AS `c01`,ifnull((select `b`.`c04` from `t126` `b` where (`b`.`id` = `a`.`c02`)),`a`.`c02`) AS `c02`,`a`.`c03` AS `C03`,`a`.`c04` AS `C04`,`a`.`c05` AS `C05`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'jfshfbl') and (`d`.`id` = `a`.`c06`))),'') AS `c06`,`a`.`c07` AS `C07`,ifnull((select `b`.`c14` from `t126` `b` where (`b`.`id` = `a`.`c08`)),`a`.`c08`) AS `c08` from `t167` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t168` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId` from `t168` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t169` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,ifnull((select `b`.`c01` from `t111` `b` where (`b`.`id` = `a`.`c01`)),`a`.`c01`) AS `c01`,`a`.`c02` AS `C02`,`a`.`c03` AS `C03` from `t169` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t170` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c02` AS `C02`,`a`.`c03` AS `C03`,`a`.`c01` AS `C01`,`a`.`c10` AS `C10`,`a`.`c04` AS `C04`,`a`.`c05` AS `C05`,`a`.`c06` AS `C06`,`a`.`c07` AS `C07`,`a`.`c08` AS `C08`,`a`.`c09` AS `C09`,`a`.`c11` AS `C11`,`a`.`c12` AS `C12` from `t170` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t171` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,ifnull((select `b`.`c02` from `t116` `b` where (`b`.`id` = `a`.`c01`)),`a`.`c01`) AS `c01`,`a`.`c02` AS `C02`,`a`.`c03` AS `C03`,`a`.`c04` AS `C04` from `t171` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t172` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c01` AS `C01`,`a`.`c02` AS `C02`,`a`.`c03` AS `C03` from `t172` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t173` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,ifnull((select `b`.`c02` from `t126` `b` where (`b`.`id` = `a`.`c01`)),`a`.`c01`) AS `c01`,ifnull((select `b`.`c04` from `t126` `b` where (`b`.`id` = `a`.`c02`)),`a`.`c02`) AS `c02`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'bdlx') and (`d`.`id` = `a`.`c03`))),'') AS `c03`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'sjzj') and (`d`.`id` = `a`.`c04`))),'') AS `c04`,`a`.`c05` AS `C05`,`a`.`c06` AS `C06`,`a`.`c07` AS `C07`,`a`.`c08` AS `C08`,`a`.`c09` AS `C09`,`a`.`c10` AS `C10`,`a`.`c11` AS `C11`,`a`.`c12` AS `C12` from `t173` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t177` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,ifnull((select `b`.`c02` from `t126` `b` where (`b`.`id` = `a`.`c01`)),`a`.`c01`) AS `c01`,ifnull((select `b`.`c04` from `t126` `b` where (`b`.`id` = `a`.`c02`)),`a`.`c02`) AS `c02`,`a`.`c03` AS `C03`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'jiangchengleibie') and (`d`.`id` = `a`.`c04`))),'') AS `c04`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'jcyy') and (`d`.`id` = `a`.`c05`))),'') AS `c05`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'gyjcdw') and (`d`.`id` = `a`.`c06`))),'') AS `c06`,`a`.`c07` AS `C07`,`a`.`c08` AS `C08` from `t177` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t178` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'gzbzlb') and (`d`.`id` = `a`.`c04`))),'') AS `c04`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'gzbzlb') and (`d`.`id` = `a`.`c01`))),'') AS `c01`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'grade') and (`d`.`id` = `a`.`c02`))),'') AS `c02`,ifnull((select `d`.`name` from `sys_s_data` `d` where ((`d`.`typename` = 'sjzj') and (`d`.`id` = `a`.`c03`))),'') AS `c03` from `t178` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t179` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,ifnull((select `b`.`c04` from `t126` `b` where (`b`.`id` = `a`.`c01`)),`a`.`c01`) AS `c01`,`a`.`c02` AS `C02`,`a`.`c03` AS `C03`,`a`.`c04` AS `C04`,`a`.`c05` AS `C05`,`a`.`c06` AS `C06`,`a`.`c07` AS `C07`,`a`.`c08` AS `C08`,`a`.`c09` AS `C09`,`a`.`c10` AS `C10`,`a`.`c11` AS `C11`,`a`.`c12` AS `C12` from `t179` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t180` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId` from `t180` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`localhost` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t181` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c01` AS `C01`,`a`.`c02` AS `C02`,ifnull((select `b`.`c02` from `t111` `b` where (`b`.`id` = `a`.`c03`)),`a`.`c03`) AS `c03`,`a`.`c04` AS `C04`,`a`.`c05` AS `C05`,`a`.`c06` AS `C06`,`a`.`c07` AS `C07`,`a`.`c08` AS `C08` from `t181` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t187` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c01` AS `C01`,`a`.`c02` AS `C02`,`a`.`c03` AS `C03` from `t187` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`%` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t188` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId`,`a`.`c01` AS `C01`,`a`.`c02` AS `C02`,`a`.`c03` AS `C03`,`a`.`c04` AS `C04` from `t188` `a`;

CREATE ALGORITHM = UNDEFINED DEFINER = `root`@`localhost` SQL SECURITY DEFINER VIEW `smso-migration-v2`.`v_t189` AS select `a`.`id` AS `id`,`a`.`dataclassCode` AS `dataclasscode`,`a`.`createrId` AS `createrId`,`a`.`createDate` AS `createDate`,`a`.`updaterId` AS `updaterId`,`a`.`updateDate` AS `updateDate`,`a`.`unitId` AS `unitId` from `t189` `a`;

SET FOREIGN_KEY_CHECKS=1;